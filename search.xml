<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>交通灯系统</title>
    <url>/2021/01/12/AT89S51%E4%BA%A4%E9%80%9A%E7%81%AF%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<ul>
<li><p><strong>浙江工业大学信息工程学院单片机实验</strong></p>
</li>
<li><p>题：定义一个秒表计数器如R2</p>
</li>
</ul>
<ol>
<li>在R2的值为1~30秒，输出P1口和P3.0、P3.1实现南北绿灯、东西红灯、人行道东西红灯、南北绿灯，并将R2的值除10，商放在动态LED0，余数放在动态LED1点亮；</li>
<li>在R2的值为31~35秒，输出P1口和P3.0、P3.1实现南北黄灯、东西红灯、人行道东西红灯、南北红灯，并将R2的值减去30后除10，商放在动态LED0，余数放在动态LED1点亮；</li>
<li>在R2的值为36~65秒，输出P1口和P3.0、P3.1实现南北红灯、东西绿灯、人行道东西绿灯、南北红灯，并将R2的值减去35后除10，商放在动态LED0，余数放在动态LED1点亮；</li>
<li>在R2的值为66~70秒，输出P1口和P3.0、P3.1实现南北红灯、东西黄灯、人行道东西红灯、南北红灯，并将R2的值减去65后除10，商放在动态LED0，余数放在动态LED1点亮；</li>
<li>当R2的值等于71秒时，R2置1，重新开始</li>
</ol>
<span id="more"></span>
<blockquote>
<p>交通灯模块、动态数码管模块，利用定时器、十进制数拆分<br>用 8 根的排线连接单片机 P0 的 JP10 到动态数码管的 J12，用 8 根的排线连接单片机 P1 的 JP8 到 交通灯模块的 JP1<br>单片机的 P22、P23、P24 分别接到 74HC138 模块的A、B、C。JP165 跳线帽一定要拔掉，插在其中一根针上，以免丢掉。<br>南北绿灯30s，红灯30s；黄灯均为5s；东西绿灯25s，红灯35s，<br>人行道不显示倒计时，车道显示倒计时</p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">    ORG     0000H</span><br><span class="line">RESET:</span><br><span class="line">    AJMP    MAIN</span><br><span class="line">    ORG     000BH           //定时器中断0入口</span><br><span class="line">    AJMP    INTI0</span><br><span class="line">    ORG     0100H</span><br><span class="line"></span><br><span class="line">MAIN:</span><br><span class="line">    MOV     SP,#60H         //计时工作方式1</span><br><span class="line">    MOV     TMOD,#01H</span><br><span class="line">    MOV     DPTR,#TABLE</span><br><span class="line">                            //12MHz，机器周期1μs，需要10000个计数，初值=65536-10000=55536=D8F0H</span><br><span class="line">    MOV     TH0,#0D8H</span><br><span class="line">    MOV     TL0,#0F0H</span><br><span class="line">    SETB    ET0             //开放T0中断和总中断</span><br><span class="line">    SETB    EA</span><br><span class="line">    SETB    TR0             //启动T0</span><br><span class="line">    MOV     R0,#01          //计数器初值为01</span><br><span class="line">    MOV     30H,#00H        //定时器超时一百次，达到64h即一秒</span><br><span class="line">    MOV     31H,#30         //南北方向红黄绿时间，30，5，30</span><br><span class="line">    MOV     32H,#35         //东西方向红黄绿时间，35，5，25</span><br><span class="line">    MOV     P1,#11001101B   //110东西红'011南北绿'01人行南北绿</span><br><span class="line">    CLR     P3.0            //10人行东西红</span><br><span class="line">    SETB    P3.1</span><br><span class="line">    LCALL   CALCU</span><br><span class="line">    LJMP    DISPLAY</span><br><span class="line"></span><br><span class="line">CALCU:</span><br><span class="line">/***********南北方向倒计时计算********************/</span><br><span class="line">    MOV     R1,#10          //除数为10</span><br><span class="line">    MOV     A,31H           //倒计时数字放到A</span><br><span class="line">    MOV     B,R1            //除数10放到B</span><br><span class="line">    DIV     AB              //A为商，B为余数</span><br><span class="line">    MOV     R4,A            //R4存放商</span><br><span class="line">    MOV     R5,B            //R5存放余数</span><br><span class="line">/***********东西方向倒计时计算********************/</span><br><span class="line">    MOV     R1,#10          //除数为10</span><br><span class="line">    MOV     A,32H           //倒计时数字放到A</span><br><span class="line">    MOV     B,R1            //除数10放到B</span><br><span class="line">    DIV     AB              //A为商，B为余数</span><br><span class="line">    MOV     R6,A            //R6存放商</span><br><span class="line">    MOV     R7,B            //R7存放余数</span><br><span class="line">    RET</span><br><span class="line"></span><br><span class="line">DISPLAY:</span><br><span class="line">/***********南北方向倒计时显示********************/</span><br><span class="line">    CLR     P2.2</span><br><span class="line">    CLR     P2.3</span><br><span class="line">    CLR     P2.4</span><br><span class="line">    MOV     A,R4            //LED0输出商</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    LCALL   D04MS</span><br><span class="line">    </span><br><span class="line">    SETB    P2.2</span><br><span class="line">    MOV     A,R5            //LED1输出余数</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P0,A</span><br><span class="line">/***********东西方向倒计时显示********************/</span><br><span class="line">    CLR     P2.2</span><br><span class="line">    CLR     P2.3</span><br><span class="line">    SETB    P2.4</span><br><span class="line">    LCALL   D04MS </span><br><span class="line">    MOV     A,R6            //LED4输出商</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    LCALL   D04MS</span><br><span class="line">    </span><br><span class="line">    SETB    P2.2</span><br><span class="line">    MOV     A,R7            //LED5输出余数</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P0,A</span><br><span class="line">/*********************************************/</span><br><span class="line">    JNB     TF0,DISPLAY     //wait for TF0</span><br><span class="line"></span><br><span class="line">INTI0:</span><br><span class="line">    PUSH    PSW             //保护状态字寄存器</span><br><span class="line">    PUSH    ACC</span><br><span class="line">    CLR     EA              //关闭总中断</span><br><span class="line">    MOV     TH0,#0D8H       //定时10ms</span><br><span class="line">    MOV     TL0,#0F0H</span><br><span class="line">    INC     30H</span><br><span class="line">    MOV     A,30H</span><br><span class="line">    CJNE    A,#100,OUT</span><br><span class="line">    MOV     30H,#00H        //定时器超时一百次，达到64h即一秒</span><br><span class="line">    INC     R0              //计数器+1</span><br><span class="line">    DEC     31H</span><br><span class="line">    DEC     32H</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***********四种状态互相转变********************/</span><br><span class="line">JMP5SN:</span><br><span class="line">    CJNE    R0,#31,JMP30EW</span><br><span class="line">    MOV     P1,#11010110B   //110东西红'101南北黄'10人行南北红</span><br><span class="line">    CLR     P3.0            //10人行东西红</span><br><span class="line">    SETB    P3.1</span><br><span class="line">    MOV     31H,#5</span><br><span class="line">    LCALL   CALCU</span><br><span class="line">    SJMP    OUT</span><br><span class="line">JMP30EW:</span><br><span class="line">    CJNE    R0,#36,JMP5EW</span><br><span class="line">    MOV     P1,#01111010B   //011东西绿'110南北红'10人行南北红</span><br><span class="line">    SETB    P3.0            //01人行东西绿</span><br><span class="line">    CLR     P3.1</span><br><span class="line">    MOV     31H,#30</span><br><span class="line">    MOV     32H,#25</span><br><span class="line">    LCALL   CALCU</span><br><span class="line">    SJMP    OUT</span><br><span class="line">JMP5EW:</span><br><span class="line">    CJNE    R0,#66,JMP30SN</span><br><span class="line">    MOV     P1,#10111010B   //101东西黄'110南北红'10人行南北红</span><br><span class="line">    SETB    P3.0            //01人行东西绿</span><br><span class="line">    CLR     P3.1</span><br><span class="line">    MOV     32H,#5</span><br><span class="line">    LCALL   CALCU</span><br><span class="line">    SJMP    OUT</span><br><span class="line">JMP30SN:</span><br><span class="line">    CJNE    R0,#71,OUT</span><br><span class="line">    MOV     R0,#1</span><br><span class="line">    MOV     P1,#11001101B   //110东西红'011南北绿'01人行南北绿</span><br><span class="line">    CLR     P3.0            //10人行东西红</span><br><span class="line">    SETB    P3.1</span><br><span class="line">    MOV     31H,#30</span><br><span class="line">    MOV     32H,#35</span><br><span class="line">    LCALL   CALCU</span><br><span class="line">    SJMP    OUT</span><br><span class="line"></span><br><span class="line">OUT:</span><br><span class="line">    SETB    EA              //开总中断</span><br><span class="line">    POP     ACC</span><br><span class="line">    POP     PSW             //保护状态字寄存器</span><br><span class="line">    RETI</span><br><span class="line"></span><br><span class="line">D04MS:                      //延时0.4ms</span><br><span class="line">    MOV     R3,#2</span><br><span class="line">D1: MOV     R2,#10</span><br><span class="line">D2: DJNZ    R2,D2</span><br><span class="line">    DJNZ    R3,D1</span><br><span class="line">    RET</span><br><span class="line"></span><br><span class="line">TABLE:</span><br><span class="line">    DB  3FH,06H,5BH,4FH,66H,6DH,7DH,07H //共阴极0~9</span><br><span class="line">    DB  7FH,6FH</span><br><span class="line">    DB  00H</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>ASM</tag>
      </tags>
  </entry>
  <entry>
    <title>Dual_computer_communication</title>
    <url>/2020/12/29/AT89S51%E5%8F%8C%E6%9C%BA%E9%80%9A%E4%BF%A1/</url>
    <content><![CDATA[<ul>
<li><p><strong>浙江工业大学信息工程学院单片机实验</strong></p>
</li>
<li><p>要求：甲机将内部RAM 30h~4Fh的内容发送给乙机</p>
</li>
</ul>
<span id="more"></span>
<blockquote>
<p>通讯双方均采用4800bps波特率进行传送(系统时钟频率为11.0592MHz)，甲机发送数据，乙机接收数据。双机开始通讯时，甲机发送一个呼叫信号“06H”，询问乙机是否可以接收数据；乙机收到呼叫信号后，若同意接收数据则发回“00H”作为应答，否则发“15H”表示暂不能接收数据，甲机只有收到乙机的应答信号“00H”后才可把存放在内部数据存储器的字节内容发送给乙机，否则继续向乙机呼叫，直到乙机同意接收。呼叫成功后甲机依次发送长度字节（1字节）、数据字节（n字节）和校验和字节（1字节），其中校验和为长度字节和数据字节的“累加和”。乙机在成功收到甲机的数据之后，发送“0FH”作为成功应答，否则发送“F0H”作为失败应答。</p>
</blockquote>
<hr>
<h2 id="发送机"><a href="#发送机" class="headerlink" title="发送机"></a>发送机</h2><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">        ORG     0000H</span><br><span class="line">        LJMP    START</span><br><span class="line">        ORG     1000H</span><br><span class="line">            </span><br><span class="line">START:</span><br><span class="line">        MOV     SP,#60H</span><br><span class="line">        MOV     TMOD,#20H       //定时器0，定时器工作模式2工作</span><br><span class="line">        MOV     TH1,#0FAH       //模式2自动重装载的初值</span><br><span class="line">        MOV     TH1,#0FAH</span><br><span class="line">        SETB    TR1             //开始计时</span><br><span class="line">        MOV     SCON,#50H       //方式1工作,允许接收--&gt;4.8kbit/s</span><br><span class="line">        MOV     PCON,#00H       //SMOD=0</span><br><span class="line">        MOV     R0,30H          //存放发送的数据块首地址</span><br><span class="line">        MOV     R7,#20H         //存放发送的数据块长度</span><br><span class="line">        MOV     R6,#00H         //校验和，长度字节与数字字节的累加和</span><br><span class="line">        </span><br><span class="line">TX_ACK:</span><br><span class="line">        MOV     A,#06H          //发送06H询问是否可以接收数据</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        </span><br><span class="line">WAIT1:</span><br><span class="line">        JNB     TI,WAIT1        //等待发送完一个字节</span><br><span class="line">        CLR     TI              //清除发送完毕TI标志位</span><br><span class="line"></span><br><span class="line">RX_YES:</span><br><span class="line">        JNB     RI,RX_YES       //等待乙机回答是否可以接收</span><br><span class="line">        CLR     RI              //清除接收完毕RI标志位</span><br><span class="line">        </span><br><span class="line">NEXT1:</span><br><span class="line">        MOV     A,SBUF          //接收到乙机发送过来的ACK</span><br><span class="line">        CJNE    A,#00H,TX_ACK   //若为00H则表示可以接收数据，往下启动发送，否则再次询问</span><br><span class="line">        </span><br><span class="line">TX_LENGTH:</span><br><span class="line">        MOV     A,R7            //先发送字节长度数R7</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        </span><br><span class="line">WAIT2:</span><br><span class="line">        JNB     TI,WAIT2        //等待数据发送完毕</span><br><span class="line">        CLR     TI              //清除发送完毕TI标志位</span><br><span class="line">        MOV     R6,A            //增加校验和</span><br><span class="line"></span><br><span class="line">TX_NEWS:                        //查询发送数据</span><br><span class="line">        MOV     A,@R0</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        </span><br><span class="line">TX_NEWS_WAIT:</span><br><span class="line">        JNB     TI,TX_NEWS_WAIT</span><br><span class="line">        CLR     TI              //清除发送完毕TI标志位</span><br><span class="line">        MOV     A,R6</span><br><span class="line">        ADD     A,@R0</span><br><span class="line">        MOV     R6,A</span><br><span class="line">        INC     @R0</span><br><span class="line">        DJNZ    R7,TX_NEWS      //如果没发送完32个数据，继续发送</span><br><span class="line">        </span><br><span class="line">TX_CHECK:</span><br><span class="line">        MOV     A,R6</span><br><span class="line">        ADD     A,@R0</span><br><span class="line">        MOV     R6,A</span><br><span class="line">        MOV     A,R6            //发送校验位</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        </span><br><span class="line">WAIT3:                          //等待发送完校验位</span><br><span class="line">        JNB     TI,WAIT3</span><br><span class="line">        CLR     TI</span><br><span class="line">        </span><br><span class="line">WAIT4:                          //等待接收完校验位</span><br><span class="line">        JNB     RI,WAIT4</span><br><span class="line">        CLR     RI</span><br><span class="line">        </span><br><span class="line">IF_0FH:</span><br><span class="line">        MOV     A,SBUF          //将接收到校验是否正确的恢复存到累加器</span><br><span class="line">        CJNE    A,#0FH,START</span><br><span class="line"></span><br><span class="line">HERE:</span><br><span class="line">        SJMP    HERE</span><br><span class="line"></span><br><span class="line">        END</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="接收机"><a href="#接收机" class="headerlink" title="接收机"></a>接收机</h2><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">        ORG     0000H</span><br><span class="line">        LJMP    START</span><br><span class="line">        ORG     0023H</span><br><span class="line">        LJMP    IF_06H</span><br><span class="line">        ORG     1000H</span><br><span class="line">            </span><br><span class="line">START:</span><br><span class="line">        MOV     SP,#60H</span><br><span class="line">        MOV     TMOD,#20H       //定时器0，定时器工作模式2工作</span><br><span class="line">        MOV     TH1,#0FAH       //模式2自动重装载的初值</span><br><span class="line">        MOV     TH1,#0FAH</span><br><span class="line">        SETB    TR1             //开始计时</span><br><span class="line">        MOV     SCON,#50H       //方式1,允许接收--&gt;4.8kbit/s</span><br><span class="line">        MOV     PCON,#00H       //SMOD=0</span><br><span class="line">        MOV     IE,#90H</span><br><span class="line">        MOV     R0,30H          //存放发送的数据块首地址</span><br><span class="line">        MOV     R7,#00H         //存放发送的数据块长度</span><br><span class="line">        MOV     R6,#00H         //校验和，长度字节与数字字节的累加和</span><br><span class="line">        </span><br><span class="line">HERE:</span><br><span class="line">        SJMP    HERE</span><br><span class="line">        </span><br><span class="line">IF_06H:</span><br><span class="line">        PUSH    ACC</span><br><span class="line">        PUSH    PSW</span><br><span class="line">        CLR     RI              //清除接收完毕RI标志位</span><br><span class="line">        MOV     A,SBUF          //核对握手信号是不是06H</span><br><span class="line">        CJNE    A,#06H,TX_15H   //如果是06H则发送00H应答，否则发送15H拒绝</span><br><span class="line"></span><br><span class="line">TX_00H:</span><br><span class="line">        MOV     A,#00H</span><br><span class="line">        MOV     SBUF,A          //发送出00H表示可以接收数据</span><br><span class="line">        LJMP    HERE_RE</span><br><span class="line">        </span><br><span class="line">TX_15H:</span><br><span class="line">        MOV     A,#15H          //发送15H表示不可以接收</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        LJMP    RETURN</span><br><span class="line">            </span><br><span class="line">HERE_RE:</span><br><span class="line">        JNB     TI,HERE_RE      //等待发送完毕，发送完毕准备接收</span><br><span class="line">        CLR     TI</span><br><span class="line">        </span><br><span class="line">HAVE1:</span><br><span class="line">        JNB     RI,HAVE1        //等待接收数据长度</span><br><span class="line">        CLR     RI</span><br><span class="line">        MOV     A,SBUF</span><br><span class="line">        MOV     R7,A            //R7存数据长度</span><br><span class="line">        MOV     R6,A            //R6存校验和</span><br><span class="line"></span><br><span class="line">HAVE2:</span><br><span class="line">        JNB     RI,HAVE2        //等待接收正式数据</span><br><span class="line">        CLR     RI</span><br><span class="line">        MOV     A,SBUF</span><br><span class="line">        MOV     @R0,A</span><br><span class="line">        MOV     A,R6</span><br><span class="line">        ADD     A,@R0</span><br><span class="line">        MOV     R6,A</span><br><span class="line">        INC     @R0</span><br><span class="line">        DJNZ    R7,HAVE2        //如果没接收完完20个数据，继续接收</span><br><span class="line">        </span><br><span class="line">RX_CHECK:                       //接收校验和</span><br><span class="line">        JNB     RI,RX_CHECK</span><br><span class="line">        CLR     RI</span><br><span class="line">        MOV     A,SBUF</span><br><span class="line">        MOV     39H,A</span><br><span class="line">        CJNE    A,39H,TX_ERR    //如果校验正确，则继续向下ok，错误则发送#F0H</span><br><span class="line">        </span><br><span class="line">TX_OK:                          //校验正确，发送0FH</span><br><span class="line">        MOV     A,#0FH</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        LJMP    HERE_END</span><br><span class="line">            </span><br><span class="line">TX_ERR:                         //校验错误，发送F0H</span><br><span class="line">        MOV     A,#0F0H</span><br><span class="line">        MOV     SBUF,A</span><br><span class="line">        </span><br><span class="line">HERE_END:                       //等待发送完毕</span><br><span class="line">        JNB TI,HERE_END</span><br><span class="line">        CLR TI</span><br><span class="line"></span><br><span class="line">RETURN:</span><br><span class="line">        POP     PSW</span><br><span class="line">        POP     ACC</span><br><span class="line">        RETI</span><br><span class="line"></span><br><span class="line">        END</span><br><span class="line">            </span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>ASM</tag>
      </tags>
  </entry>
  <entry>
    <title>定时器解决方案备忘录</title>
    <url>/2020/12/22/AT89S51%E5%AE%9A%E6%97%B6%E5%99%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%A4%87%E5%BF%98%E5%BD%95/</url>
    <content><![CDATA[<ul>
<li><strong>浙江工业大学信息工程学院单片机实验</strong></li>
</ul>
<span id="more"></span>
<blockquote>
<p>P2.0接LED模块J12的A</p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">    ORG     0000H</span><br><span class="line">RESET:</span><br><span class="line">    LJMP    MAIN</span><br><span class="line">    ORG     000BH           //定时器中断0入口</span><br><span class="line">    LJMP    T0_INT</span><br><span class="line">    ORG     0100H</span><br><span class="line"></span><br><span class="line">MAIN:</span><br><span class="line">    MOV     SP,#60H</span><br><span class="line">    MOV     TMOD,#01H       //计时工作方式1</span><br><span class="line">    MOV     30H,#00H        //定时器超时一百次，达到64h即一秒</span><br><span class="line">                            //12MHz，机器周期1μs，需要10000个计数，初值=65536-10000=55536=D8F0H</span><br><span class="line">    MOV     TH0,#0D8H</span><br><span class="line">    MOV     TL0,#0F0H</span><br><span class="line">    SETB    P2.0</span><br><span class="line">    SETB    ET0             //开放T0中断和总中断</span><br><span class="line">    SETB    EA</span><br><span class="line">    SETB    TR0             //启动T0</span><br><span class="line">    JNB     TF0,$           //wait for TF0</span><br><span class="line"></span><br><span class="line">T0_INT:</span><br><span class="line">    PUSH    PSW             //保护状态字寄存器</span><br><span class="line">    PUSH    ACC</span><br><span class="line">    CLR     EA              //关闭总中断</span><br><span class="line">    MOV     TH0,#0D8H</span><br><span class="line">    MOV     TL0,#0F0H</span><br><span class="line">    INC     30H</span><br><span class="line">    MOV     A,30H</span><br><span class="line">    CJNE    A,#100,CONTINUE_T0</span><br><span class="line">    MOV     30H,#00H        //定时器超时一百次，达到64h即一秒</span><br><span class="line">    CPL     P2.0</span><br><span class="line"></span><br><span class="line">CONTINUE_T0:</span><br><span class="line">    SETB    EA              //开总中断</span><br><span class="line">    POP     ACC</span><br><span class="line">    POP     PSW             //保护状态字寄存器</span><br><span class="line">    RETI</span><br><span class="line"></span><br><span class="line">    END</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><blockquote>
<p>定时器0还是定时器1<br>晶振频率是6Mhz还是12Mhz（这里使用的是12MHz，则12个晶振周期—&gt;机器周期1μs）<br>方式1：最多2^16=65536*1μs=65.5ms<br>方式2：最多2^8=256μs但自动重装载</p>
</blockquote>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Keil/Keil_INT0.png" alt="定时器调试"></p>
<ul>
<li>设置一百次10ms定时器溢出后断点调试，发现右下角时间刚好为1s</li>
<li>（不精准，由于时钟实际11.0592）</li>
</ul>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>ASM</tag>
      </tags>
  </entry>
  <entry>
    <title>PSW设置改进中断</title>
    <url>/2020/12/15/AT89S51%E7%9A%84PSW%E8%AE%BE%E7%BD%AE%E6%94%B9%E8%BF%9B%E4%B8%AD%E6%96%AD/</url>
    <content><![CDATA[<ul>
<li><strong>浙江工业大学信息工程学院单片机实验</strong></li>
</ul>
<blockquote>
<p>中断优先级实验，主程序相邻2个LED灯循环点亮（03H—C0H）1S，外部中断0后静态数码管间隔1S轮流点亮0-F后返回，外部中断1后1个LED灯循环点亮（01H-80H）后返回，外部中断0优先级高于外部中断1，实现中断嵌套</p>
</blockquote>
<span id="more"></span>
<hr>
<blockquote>
<p>P1接LED的ABCDEF，P3.2接K1，P3.3接K4，P0接静态数码管ABCDEF</p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">    ORG     0000H</span><br><span class="line">    AJMP    START</span><br><span class="line"></span><br><span class="line">    ORG     0003H</span><br><span class="line">    AJMP    INTT0</span><br><span class="line">    </span><br><span class="line">    ORG     0013H</span><br><span class="line">    AJMP    INTT1</span><br><span class="line">    </span><br><span class="line">    ORG     0100H</span><br><span class="line">START:</span><br><span class="line">    MOV     SP,#60H</span><br><span class="line">    MOV     PSW,#00H</span><br><span class="line">    SETB    EX0</span><br><span class="line">    SETB    IT0</span><br><span class="line">    SETB    EX1</span><br><span class="line">    SETB    IT1</span><br><span class="line">    SETB    EA</span><br><span class="line">    MOV     IP,#01H</span><br><span class="line">    MOV     P3,#0FFH</span><br><span class="line">MAIN:</span><br><span class="line">    MOV     DPTR,#TABLE</span><br><span class="line">    MOV     R0,#03H</span><br><span class="line">    MOV     R2,#08H</span><br><span class="line">    ACALL   LOOP</span><br><span class="line">    LJMP    MAIN</span><br><span class="line"></span><br><span class="line">LOOP:</span><br><span class="line">    MOV     A,R0</span><br><span class="line">    MOV     P1,A</span><br><span class="line">    RL      A</span><br><span class="line">    MOV     R0,A</span><br><span class="line">    LCALL   D1S</span><br><span class="line">    DJNZ    R2,LOOP</span><br><span class="line">    RET</span><br><span class="line"></span><br><span class="line">INTT0:</span><br><span class="line">    PUSH    PSW</span><br><span class="line">    PUSH    ACC</span><br><span class="line">    MOV     PSW,#08H</span><br><span class="line">    MOV     A,P3</span><br><span class="line">    CPL     A</span><br><span class="line">    JZ      RETURN</span><br><span class="line">    LCALL   D10ms           //去抖动</span><br><span class="line">    MOV     A,P3</span><br><span class="line">    CPL     A</span><br><span class="line">    JZ      RETURN</span><br><span class="line">    JB      ACC.2,Pkey0</span><br><span class="line">    LJMP    RETURN</span><br><span class="line"></span><br><span class="line">INTT1:</span><br><span class="line">    PUSH    PSW</span><br><span class="line">    PUSH    ACC</span><br><span class="line">    MOV     PSW,#10H</span><br><span class="line">    MOV     A,P3</span><br><span class="line">    CPL     A</span><br><span class="line">    JZ      RETURN</span><br><span class="line">    LCALL   D10ms           //去抖动</span><br><span class="line">    MOV     A,P3</span><br><span class="line">    CPL     A</span><br><span class="line">    JZ      RETURN</span><br><span class="line">    JB      ACC.3,Pkey2</span><br><span class="line">    LJMP    RETURN</span><br><span class="line">Pkey0:</span><br><span class="line">    MOV     A,#00H</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    CJNE    A,#0FFH,Pkey1</span><br><span class="line">    LJMP    RETURN</span><br><span class="line">Pkey1:</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    LCALL   D1S</span><br><span class="line">    INC     DPTR</span><br><span class="line">    LJMP    Pkey0</span><br><span class="line">Pkey2:</span><br><span class="line">    MOV     R1,#01H</span><br><span class="line">    MOV     R3,#08H</span><br><span class="line">    ACALL   Pkey3</span><br><span class="line">    LJMP    RETURN</span><br><span class="line">Pkey3:</span><br><span class="line">    MOV     A,R1</span><br><span class="line">    MOV     P1,A</span><br><span class="line">    RL      A</span><br><span class="line">    MOV     R1,A</span><br><span class="line">    LCALL   D1S</span><br><span class="line">    DJNZ    R3,Pkey3</span><br><span class="line">    RET</span><br><span class="line">RETURN:</span><br><span class="line">    POP     ACC</span><br><span class="line">    POP     PSW</span><br><span class="line">    RETI</span><br><span class="line"></span><br><span class="line">TABLE:</span><br><span class="line">    DB  0C0H,0F9H,0A4H,0B0H,99H,92H,82H,0F8H</span><br><span class="line">    DB  80H,90H,88H,83H,0C6H,0A1H,86H,8EH</span><br><span class="line">    DB  0FFH</span><br><span class="line"></span><br><span class="line">D10ms:</span><br><span class="line">    MOV     R7,#25</span><br><span class="line">D4:</span><br><span class="line">    MOV     R6,#200</span><br><span class="line">    DJNZ    R6,$</span><br><span class="line">    DJNZ    R7,D4</span><br><span class="line">    RET</span><br><span class="line"></span><br><span class="line">D1S:</span><br><span class="line">    MOV     R5,#20</span><br><span class="line">D5: MOV     R6,#100</span><br><span class="line">D6: MOV     R7,#248</span><br><span class="line">D7: DJNZ     R7,D7</span><br><span class="line">    DJNZ    R6,D6</span><br><span class="line">    DJNZ    R5,D5</span><br><span class="line">    RET</span><br><span class="line">    </span><br><span class="line">    END</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>ASM</tag>
        <tag>Terminate</tag>
      </tags>
  </entry>
  <entry>
    <title>模拟采集AD转化</title>
    <url>/2021/01/05/AT89S51%E6%A8%A1%E6%8B%9F%E9%87%87%E9%9B%86AD%E8%BD%AC%E5%8C%96/</url>
    <content><![CDATA[<ul>
<li><strong>浙江工业大学信息工程学院单片机实验</strong></li>
</ul>
<blockquote>
<p>包含进制转化和动态显示<br>AD转换器XPT2046是12位的串行口（SPI）输出的可编程控制AD芯片，转换时间约10uS,控制字分别为94H可调电位器、0A4H光敏电阻、0D4H热敏电阻<br>采用LED（4位）动态显示，千位、百位、十位和个位<br>000H-FFFH的温度数据需要转换成十进制数的仟佰拾个位</p>
</blockquote>
<span id="more"></span>
<hr>
<blockquote>
<p>连接单片机的 JP10 到动态数码管的 J12<br>分别连接单片机的 P20、P21、P22 到 74HC138 模块的 A、B、C。<br>分别连接单片机的 P34、P35、P36、P37 到AD/DA模块的 DI、CS、CLK、DO。<br>将NE555 模块的跳线帽 J11 跳开，跳线帽安装在其中一根上，以免丢掉。</p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">    ORG     0000H</span><br><span class="line">    LJMP    MAIN</span><br><span class="line"></span><br><span class="line">    ORG     0200H</span><br><span class="line">MAIN:</span><br><span class="line">    MOV     SP,#60H</span><br><span class="line">    ACALL   AD_CHANGE</span><br><span class="line">    </span><br><span class="line">    MOV     DPTR,#D_table   //动态显示四位</span><br><span class="line">    </span><br><span class="line">    MOV     A,#00H          //38译码器动态显示四位</span><br><span class="line">    MOV     A,R0            //放个位</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P2,#03</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    ACALL   Delay</span><br><span class="line"></span><br><span class="line">    MOV     A,#00H</span><br><span class="line">    MOV     A,R1            //放十位</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P2,#02</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    ACALL   Delay</span><br><span class="line"></span><br><span class="line">    MOV     A,#00H</span><br><span class="line">    MOV     A,R2            //放百位</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P2,#01</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    ACALL   Delay</span><br><span class="line"></span><br><span class="line">    MOV     A,#00H</span><br><span class="line">    MOV     A,R3            //放千位</span><br><span class="line">    MOVC    A,@A+DPTR</span><br><span class="line">    MOV     P2,#00</span><br><span class="line">    MOV     P0,A</span><br><span class="line">    ACALL   Delay</span><br><span class="line">    </span><br><span class="line">    MOV     P0,#00H</span><br><span class="line">    LJMP    MAIN</span><br><span class="line"></span><br><span class="line">AD_CHANGE:                  //获取AD转换结果，共12位，串行读入单片机内，用SPI总线</span><br><span class="line">    INC     R7</span><br><span class="line">DELL: </span><br><span class="line">    DJNZ    R6,DELL</span><br><span class="line">    CJNE    R7,#0FFH,RETURN</span><br><span class="line">    MOV     R7,#00H</span><br><span class="line">    MOV     R6,#0FFH</span><br><span class="line">    </span><br><span class="line">    MOV     R0,#0d4H        //R0控制字  0X94或0XB4电位，0XD4热敏，0XA4光敏</span><br><span class="line">    CLR     P3.5            //片选CS为低电平，选中XPT2046</span><br><span class="line">    CLR     P3.6            //时钟脚I/O CLOCK位低电平</span><br><span class="line">    MOV     R2,#08H         //设置循环读入的次数为8</span><br><span class="line">    MOV     A,R0            //下一次转换的命令从R0送入A</span><br><span class="line">LOOP0:</span><br><span class="line">    RLC     A</span><br><span class="line">    MOV     P3.4,C</span><br><span class="line">    CLR     P3.6</span><br><span class="line">    NOP</span><br><span class="line">    SETB    P3.6</span><br><span class="line">    NOP</span><br><span class="line">    DJNZ    R2,LOOP0</span><br><span class="line">    MOV     A,#00H</span><br><span class="line">    MOV     R2,#04H</span><br><span class="line">    NOP</span><br><span class="line">    NOP</span><br><span class="line">    NOP</span><br><span class="line">    NOP</span><br><span class="line">LOOP1:</span><br><span class="line">    MOV     C,P3.7          //读入上一次的转换结果中的1位</span><br><span class="line">    RRC     A               //带进位位的循环右移</span><br><span class="line">    </span><br><span class="line">    SETB    P3.6            //一个CLK时钟</span><br><span class="line">    NOP</span><br><span class="line">    CLR     P3.6</span><br><span class="line">    NOP</span><br><span class="line">    </span><br><span class="line">    DJNZ    R2,LOOP1        //是否完成8次转换结果读入和命令输出？未完成则继续</span><br><span class="line">    RRC     A</span><br><span class="line">    RRC     A</span><br><span class="line">    RRC     A</span><br><span class="line">    RRC     A</span><br><span class="line">    MOV     R1,A            //R1存高4位数据</span><br><span class="line">    MOV     A,#00H          //A清“0”</span><br><span class="line">    MOV     R2,#08H         //设置R2循环次数为8，为移入8位数据准备</span><br><span class="line">LOOP2:</span><br><span class="line">    MOV     C,P3.7          //读入上一次的转换结果中的1位</span><br><span class="line">    RRC     A               //带进位位的循环右移</span><br><span class="line"></span><br><span class="line">    CLR     P3.6            //一个CLK时钟</span><br><span class="line">    NOP</span><br><span class="line">    SETB    P3.6</span><br><span class="line">    NOP</span><br><span class="line">    </span><br><span class="line">    DJNZ    R2,LOOP2        //是否完成8次转换结果读入和命令输出？未完成则继续</span><br><span class="line">    </span><br><span class="line">    SWAP    A</span><br><span class="line">    MOV     R0,A            //R0存低8位</span><br><span class="line">    SETB    P3.6</span><br><span class="line">    LJMP    DATA_HEX_DEC</span><br><span class="line">RETURN:</span><br><span class="line">    RET</span><br><span class="line">    </span><br><span class="line">DATA_HEX_DEC:               //将获取的12位2进制数转换为十进制存在R3 R2 R1 R0；千位 百位 十位 个位里 #R0--&gt;TL0 #R1--&gt;TH0</span><br><span class="line">    MOV     A,R1</span><br><span class="line">    ANL     A,#0FH</span><br><span class="line">    MOV     R1,A</span><br><span class="line">    CLR     A</span><br><span class="line">    </span><br><span class="line">    MOV     R2,A            //先清零</span><br><span class="line">    MOV     R3,A</span><br><span class="line">    MOV     R4,A</span><br><span class="line">    MOV     R5,#16          //共转换十六位数 </span><br><span class="line">LOOP:</span><br><span class="line">    CLR     C</span><br><span class="line">    MOV     A,R0            //从待转换数的高端移出一位到Cy</span><br><span class="line">    RLC     A</span><br><span class="line">    MOV     R0,A</span><br><span class="line">    </span><br><span class="line">    MOV     A,R1</span><br><span class="line">    RLC     A</span><br><span class="line">    MOV     R1,A</span><br><span class="line">    </span><br><span class="line">    MOV     A,R4            //送到BCD码的低端</span><br><span class="line">    ADDC    A,R4            //带进位的自身相加，相当于左移一位</span><br><span class="line">    DA      A               //十进制调整，变成BCD码</span><br><span class="line">    MOV     R4,A</span><br><span class="line">    </span><br><span class="line">    MOV     A,R3</span><br><span class="line">    ADDC    A,R3</span><br><span class="line">    DA      A</span><br><span class="line">    MOV     R3,A</span><br><span class="line">    </span><br><span class="line">    MOV     A,R2</span><br><span class="line">    ADDC    A,R2</span><br><span class="line">    MOV     R2,A</span><br><span class="line">    </span><br><span class="line">    DJNZ    R5,LOOP</span><br><span class="line">//已经把TH1 TL1中的数字，转换成BCD码，送到了R2 R3 R4</span><br><span class="line">//*************************************************//</span><br><span class="line">//分别存入 R3 R2 R1 R0；千位 百位 十位 个位</span><br><span class="line">    MOV     A,R4</span><br><span class="line">    MOV     B,#16</span><br><span class="line">    DIV     AB</span><br><span class="line">    MOV     R1,A</span><br><span class="line">    MOV     R0,B</span><br><span class="line"></span><br><span class="line">    MOV     A,R2</span><br><span class="line">    MOV     R4,A</span><br><span class="line"></span><br><span class="line">    MOV     A,R3</span><br><span class="line">    MOV     B,#16</span><br><span class="line">    DIV     AB</span><br><span class="line">    MOV     R3,A</span><br><span class="line">    MOV     R2,B</span><br><span class="line">    RET </span><br><span class="line">    </span><br><span class="line">Delay:                      //定时0.4ms</span><br><span class="line">        MOV     30H,#10</span><br><span class="line">DEL0:   MOV     31H,#1</span><br><span class="line">DEL1:   MOV     32H,#20</span><br><span class="line">DEL2:   DJNZ    32H,DEL2</span><br><span class="line">        DJNZ    31H,DEL1</span><br><span class="line">        DJNZ    30H,DEL0</span><br><span class="line">      </span><br><span class="line">    RET  </span><br><span class="line">    </span><br><span class="line">D_table:</span><br><span class="line">    DB 3FH,06H,5BH,4FH,66H,6DH,7DH,07H,7FH,6FH  //共阴极0~9</span><br><span class="line"></span><br><span class="line">    END</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>ASM</tag>
        <tag>ADC</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse初探</title>
    <url>/2024/06/29/ClickHouse%E5%88%9D%E6%8E%A2/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 最近的项目用到了<code>ClickHouse</code>，全称<code>Click Stream, Data Warehouse</code>，是用于联机分析的列式数据库，由Russian的Yandex开发逐渐演进而来，在这里记录一些初次使用ClickHouse时摸索的一些特性和坑。</p>
<p><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<span id="more"></span>
<h2 id="1-优缺点"><a href="#1-优缺点" class="headerlink" title="1. 优缺点"></a>1. 优缺点</h2><h3 id="1-1-Benefits"><a href="#1-1-Benefits" class="headerlink" title="1.1 Benefits"></a>1.1 Benefits</h3><ul>
<li>ROLAP实时分析、实时查询、列式存储、完善的SQL支持、高可用，适合大数据量的数据分析，支持PB级别的数据量</li>
</ul>
<h3 id="1-2-Drawbacks"><a href="#1-2-Drawbacks" class="headerlink" title="1.2 Drawbacks"></a>1.2 Drawbacks</h3><ul>
<li>不支持事务</li>
<li>join的语法不够完善</li>
<li>采用并行处理，不支持高并发</li>
<li>稀疏索引导致查询性能不稳定，删改数据性能较差</li>
</ul>
<h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2. 应用场景"></a>2. 应用场景</h2><ul>
<li>主要用于数据分析领域，适合OLAP场景，不适合OLTP场景</li>
</ul>
<h2 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h2><blockquote>
<p>在Ubuntu的环境下用apt安装</p>
</blockquote>
<ul>
<li><p>Use repository from Yandex</p>
<ul>
<li><p>Add key</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">OutputExecuting: /tmp/apt-key-gpghome.JkkcKnBAFY/gpg.1.sh --keyserver keyserver.ubuntu.com --recv E0C56BD4</span><br><span class="line"></span><br><span class="line">gpg: key C8F1E19FE0C56BD4: public key "ClickHouse Repository Key &lt;milovidov@yandex-team.ru&gt;" imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Add repository and update</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">echo "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/" | sudo tee /etc/apt/sources.list.d/clickhouse.list</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Install ClickHouse<br>  You need to enter the password for the <code>default</code> user when installiation in 75% progress.</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install clickhouse-server clickhouse-client</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Start ClickHouse</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo service clickhouse-server start</span><br><span class="line">sudo service clickhouse-server status</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="4-防火墙设置和远程连接"><a href="#4-防火墙设置和远程连接" class="headerlink" title="4. 防火墙设置和远程连接"></a>4. 防火墙设置和远程连接</h2><blockquote>
<p>如果仅在同一服务器访问ClickHouse，则无需设置防火墙<br>如果需要远程访问，则需要配置用户权限</p>
</blockquote>
<ul>
<li><p>修改ClickHouse配置文件，监听所有IP地址</p>
<ul>
<li><p>取消注释，大约在配置文件的一百五十多行</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo vim /etc/clickhouse-server/config.xml</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>::<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>重启ClickHouse</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl restart clickhouse-server.service</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>远程访问</p>
</li>
</ul>
<blockquote>
<p>无法使用<code>default</code>用户远程访问，需要增加<code>default</code>的管理权限后创建新用户</p>
</blockquote>
<ul>
<li><p>修改<code>default</code>用户权限，取消<code>access_management&gt;1&lt;/access_management&gt;</code>的注释</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">sudo vim /etc/clickhouse-server/users.xml</span><br></pre></td></tr></tbody></table></figure>
  <figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- User can create other users and grant rights to them. --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;access_management&gt;1&lt;/access_management&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl restart clickhouse-server.service</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>创建只读权限和新用户</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">clickhouse-client --password</span><br></pre></td></tr></tbody></table></figure>
  <figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ROLE role_read;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> db.<span class="operator">*</span> <span class="keyword">TO</span> role_read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> user_read IDENTIFIED <span class="keyword">WITH</span> sha256_password  <span class="keyword">BY</span> <span class="string">'password'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> role_read <span class="keyword">TO</span> user_read;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>访问</p>
  <figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">clickhouse-client -m -u user_read --password 'your_password'</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>DBeaver连接</p>
<ul>
<li>Driver: ClickHouse</li>
<li>URL: jdbc:clickhouse://your_ip:8123</li>
<li>User: user_read</li>
<li>Password: your_password</li>
</ul>
</li>
<li><p>SpringBoot连接</p>
<ul>
<li><p>Dependency</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ru.yandex.clickhouse<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>clickhouse-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">"logBase"</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">"dev"</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-circular-references:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">clickhouse:</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">${log-base.datasource.driver-class-name}</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:clickhouse://${log-base.datasource.host}:${log-base.datasource.port}/${log-base.datasource.database}</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">${log-base.datasource.username}</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">${log-base.datasource.password}</span></span><br><span class="line">    <span class="attr">testWhileIdle:</span> <span class="string">${log-base.datasource.test-while-idle}</span></span><br><span class="line">    <span class="attr">validationQuery:</span> <span class="string">${log-base.datasource.validation-query}</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ClickHouseProperties</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "spring.datasource.clickhouse")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClickHouseProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String validationQuery;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String testWhileIdle;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>CLickHouseConfiguration.java</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClickHouseConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClickHouseProperties clickHouseProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClickHouseConfiguration</span><span class="params">(ClickHouseProperties clickHouseProperties)</span> {</span><br><span class="line">        <span class="built_in">this</span>.clickHouseProperties = clickHouseProperties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "clickhouseDataSource")</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> {</span><br><span class="line">        log.info(<span class="string">"Init clickhouse datasource"</span>);</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        dataSource.setUrl(clickHouseProperties.getUrl());</span><br><span class="line">        dataSource.setDriverClassName(clickHouseProperties.getDriverClassName());</span><br><span class="line">        dataSource.setUsername(clickHouseProperties.getUsername());</span><br><span class="line">        dataSource.setPassword(clickHouseProperties.getPassword());</span><br><span class="line">        dataSource.setTestWhileIdle(Boolean.parseBoolean(clickHouseProperties.getTestWhileIdle()));</span><br><span class="line">        dataSource.setValidationQuery(clickHouseProperties.getValidationQuery());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
        <tag>Database</tag>
      </tags>
  </entry>
  <entry>
    <title>Band-limited noiseless channel</title>
    <url>/2021/05/25/Band-limited%20noiseless%20channel/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h3 id="Consider-a-band-limited-noiseless-channel-The-channel-response-in-frequency-domain-is-H-f-1-f-≤3Hz-otherwise-H-f-0"><a href="#Consider-a-band-limited-noiseless-channel-The-channel-response-in-frequency-domain-is-H-f-1-f-≤3Hz-otherwise-H-f-0" class="headerlink" title="Consider a band-limited noiseless channel. The channel response in frequency domain is H(f)=1, |f|≤3Hz, otherwise, H(f)=0"></a>Consider a band-limited noiseless channel. The channel response in frequency domain is H(f)=1, |f|≤3Hz, otherwise, H(f)=0</h3><p><span class="github-emoji"><span>☔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f566.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<span id="more"></span>
<hr>
<h3 id="memo-Code"><a href="#memo-Code" class="headerlink" title=":memo: Code"></a><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Code</h3><ul>
<li><em>main.m</em></li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Simulate the band-limited channel.</span></span><br><span class="line"></span><br><span class="line">clear;</span><br><span class="line">clc;</span><br><span class="line"></span><br><span class="line">Ts = <span class="number">1</span>;                 <span class="comment">% Symbol interval.</span></span><br><span class="line">Tb = Ts/<span class="number">3</span>;              <span class="comment">% Bit interval.</span></span><br><span class="line">fs = <span class="number">1000</span>;              <span class="comment">% Sampling rate.</span></span><br><span class="line">dt = <span class="number">1</span>/fs;              <span class="comment">% Sampling interval.</span></span><br><span class="line">N = <span class="number">10</span>;                 <span class="comment">% Number of symbols.</span></span><br><span class="line">t = -N/<span class="number">2</span> : dt : N/<span class="number">2</span>;    <span class="comment">% Sequence transmission time. </span></span><br><span class="line">m = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>];  <span class="comment">% Equally spaced.</span></span><br><span class="line">Am = <span class="number">-3.5</span>+m;            <span class="comment">% The amplitude of the m-th waveform.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% Task(1) Randomly generate a sequence of ten 8-PAM signals.</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="built_in">length</span>(t)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">fix</span>((<span class="built_in">i</span><span class="number">-1</span>)/fs)==((<span class="built_in">i</span><span class="number">-1</span>)/fs))</span><br><span class="line">        temp=randi(<span class="number">7</span>);</span><br><span class="line">        Sm(<span class="built_in">i</span>)=Am(temp);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Sm(<span class="built_in">i</span>)=Sm(<span class="built_in">i</span><span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">[f,Sf] = T2F(t,Sm);      <span class="comment">% TF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,Sm);</span><br><span class="line">xlabel(<span class="string">'t'</span>);ylabel(<span class="string">'Amplitude '</span>); </span><br><span class="line">title(<span class="string">'8-PAM waveform'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">plot</span>(f,<span class="built_in">abs</span>(Sf));</span><br><span class="line">xlabel(<span class="string">'f/Ts'</span> );ylabel(<span class="string">''</span>);</span><br><span class="line">title(<span class="string">'8-PAM spectrum'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Task(2) Consider a band-limited noiseless channel.</span></span><br><span class="line"><span class="comment">% Generate a band-limited noiseless channel H(f)=1, |f|≤3Hz.</span></span><br><span class="line"><span class="keyword">for</span> k = <span class="number">1</span> : <span class="built_in">length</span>(f)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(f(k))&gt;<span class="number">3</span></span><br><span class="line">        Hf1(k)=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Hf1(k)=Ts;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">for</span> k = <span class="number">1</span> : <span class="built_in">length</span>(f)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(f(k))&gt;<span class="number">300</span></span><br><span class="line">        Hf2(k)=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Hf2(k)=Ts;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% Plot the band-limited noiseless channel.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">plot</span>(f,Hf1,f,Hf2);</span><br><span class="line">grid on;</span><br><span class="line">xlabel (<span class="string">'f/Ts'</span>); ylabel(<span class="string">'Noiseless channel spectrum'</span>);</span><br><span class="line">axis([ - <span class="number">400</span> <span class="number">400</span> <span class="number">0</span>  <span class="number">1.2</span>]);</span><br><span class="line"><span class="built_in">legend</span>(<span class="string">'cut-off f=3'</span>,<span class="string">'cut-off f=300'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">% Passing through this channel.</span></span><br><span class="line">value_t=t(<span class="number">1</span>);</span><br><span class="line">Xf1 = Sf.*Hf1;</span><br><span class="line">Xf1 = Xf1.*<span class="built_in">exp</span>(<span class="number">1</span><span class="built_in">i</span>*<span class="number">2</span>*<span class="built_in">pi</span>*f*value_t);</span><br><span class="line">[t,Xt1] = F2T(f,Xf1);      <span class="comment">% FT</span></span><br><span class="line"></span><br><span class="line">Xf2 = Sf.*Hf2;</span><br><span class="line">Xf2 = Xf2.*<span class="built_in">exp</span>(<span class="number">1</span><span class="built_in">i</span>*<span class="number">2</span>*<span class="built_in">pi</span>*f*value_t);</span><br><span class="line">[t,Xt2] = F2T(f,Xf2);      <span class="comment">% FT</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">4</span>)</span><br><span class="line">subplot(<span class="number">121</span>)</span><br><span class="line"><span class="built_in">plot</span>(f,<span class="built_in">abs</span>(Xf1));</span><br><span class="line">xlabel(<span class="string">'f/Ts'</span>);ylabel(<span class="string">''</span>); </span><br><span class="line">axis([ <span class="number">-5</span> <span class="number">5</span> <span class="number">0</span> <span class="number">6</span>]);</span><br><span class="line">title(<span class="string">'8-PAM waveform passomg noiseless channel spectrum'</span>);</span><br><span class="line"><span class="built_in">legend</span>(<span class="string">'cut-off f=3'</span>);</span><br><span class="line">subplot(<span class="number">122</span>)</span><br><span class="line"><span class="built_in">plot</span>(f,<span class="built_in">abs</span>(Xf2));</span><br><span class="line">xlabel(<span class="string">'f/Ts'</span>);ylabel(<span class="string">''</span>); </span><br><span class="line">axis([ <span class="number">-50</span> <span class="number">50</span> <span class="number">0</span> <span class="number">6</span>]);</span><br><span class="line">title(<span class="string">'8-PAM waveform passomg noiseless channel spectrum'</span>);</span><br><span class="line"><span class="built_in">legend</span>(<span class="string">'cut-off f=300'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">5</span>)</span><br><span class="line">subplot(<span class="number">121</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,<span class="built_in">real</span>(Xt1));</span><br><span class="line">axis([ <span class="number">0</span> N <span class="number">-4</span> <span class="number">4</span>]);</span><br><span class="line">xlabel(<span class="string">'t'</span>);ylabel(<span class="string">'Amplitude'</span>); </span><br><span class="line">title(<span class="string">'8-PAM waveform passing noiseless channel waveform'</span>);</span><br><span class="line"><span class="built_in">legend</span>(<span class="string">'cut-off f=3'</span>);</span><br><span class="line"></span><br><span class="line">subplot(<span class="number">122</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,<span class="built_in">real</span>(Xt2));</span><br><span class="line">axis([ <span class="number">0</span> N <span class="number">-4</span> <span class="number">4</span>]);</span><br><span class="line">xlabel(<span class="string">'t'</span>);ylabel(<span class="string">'Amplitude'</span>); </span><br><span class="line">title(<span class="string">'8-PAM waveform passing noiseless channel waveform'</span>);</span><br><span class="line"><span class="built_in">legend</span>(<span class="string">'cut-off f=300'</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><em>T2F.m</em></li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[f,sf]</span>=<span class="title">T2F</span><span class="params">(t,st)</span></span></span><br><span class="line"><span class="comment">%input is time and the signal vectors</span></span><br><span class="line"><span class="comment">%output is freguency and signal spectrum</span></span><br><span class="line"></span><br><span class="line">dt=t(<span class="number">2</span>)-t(<span class="number">1</span>);</span><br><span class="line">T=t(<span class="keyword">end</span>)-t(<span class="number">1</span>)+dt;</span><br><span class="line">df=<span class="number">1</span>/T; <span class="comment">%smapling rate</span></span><br><span class="line">N=<span class="built_in">length</span>(st);</span><br><span class="line"></span><br><span class="line">f=-N/<span class="number">2</span>*df:df:(N/<span class="number">2</span><span class="number">-1</span>)*df; <span class="comment">%频域抽样点</span></span><br><span class="line">sf=fft(st);</span><br><span class="line">sf=T/N*fftshift(sf).*<span class="built_in">exp</span>(-<span class="built_in">j</span>*<span class="number">2</span>*<span class="built_in">pi</span>*f*t(<span class="number">1</span>));   <span class="comment">%补偿时间移位</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><em>F2T.m</em></li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Inverse Fourier Transform</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[t,st]</span> = <span class="title">F2T</span><span class="params">(f,sf)</span></span></span><br><span class="line"><span class="comment">% output is time ande signal sequence</span></span><br><span class="line"><span class="comment">% input is frequency and signal spectrum</span></span><br><span class="line"></span><br><span class="line">df = f(<span class="number">2</span>) - f(<span class="number">1</span>);</span><br><span class="line">Fmx = f(<span class="keyword">end</span>) - f(<span class="number">1</span>) + df;</span><br><span class="line">dt = <span class="number">1</span>/Fmx;                 <span class="comment">% sampling rate</span></span><br><span class="line">N = <span class="built_in">length</span>(sf);</span><br><span class="line">T = N*dt;</span><br><span class="line"></span><br><span class="line">t = <span class="number">0</span>:dt:T-dt;              <span class="comment">% time sequence</span></span><br><span class="line">sff = ifftshift(sf);</span><br><span class="line">st = Fmx*ifft(sff);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="chart-Fig"><a href="#chart-Fig" class="headerlink" title=":chart: Fig"></a><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Fig</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Band_limited_channel/8-PAM_waveform.png" alt="Fig.1  8-PAM waveform."></p>
<p></p><center><font size="2">Fig.1  8-PAM waveform.</font></center><br><br><br><br><p></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Band_limited_channel/8-PAM_spectrum.png" alt="Fig.2  8-PAM spectrum."></p>
<p></p><center><font size="2">Fig.2  8-PAM spectrum.</font></center><br><br><br><br><p></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Band_limited_channel/Noiseless_channel_spectrum.png" alt="Fig.3  Noiseless channel spectrum."></p>
<p></p><center><font size="2">Fig.3  Noiseless channel spectrum.</font></center><br><br><br><br><p></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Band_limited_channel/8-PAM_waveform_passing_noiseless_channel_spectrum.png" alt="Fig.4  8-PAM waveform passing noiseless channel spectrum."></p>
<p></p><center><font size="2">Fig.4  8-PAM waveform passing noiseless channel spectrum.</font></center><br><br><br><br><p></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Band_limited_channel/8-PAM_waveform_passing_noiseless_channel_waveform.png" alt="Fig.5  8-PAM waveform passing noiseless channel waveform."></p>
<p></p><center><font size="2">Fig.5  8-PAM waveform passing noiseless channel waveform.</font></center><br><br><br><br><p></p>
<h3 id="grey-question-Discussion"><a href="#grey-question-Discussion" class="headerlink" title=":grey_question: Discussion"></a><span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Discussion</h3><ol>
<li>The response of the noise-free band-limited channel is lower than the rectangular window of H(f)=1 at the cut-off frequency. After the 8-PAM signal passes through the band-limited channel, the high-frequency information is filtered out, and the restored information waveform becomes smooth; if continue to increase the cut-off frequency, the restored signal waveform will contain more original information, and the same bit error rate will decrease accordingly.</li>
<li>The result of time domain convolution is the same as the result of inverse Fourier transform after frequency multiplication.</li>
<li>Under a band-limited noiseless channel, the larger the passband, the smoother the signal.<!-- markdownlint-disable-file MD025 MD033 -->
</li>
</ol>
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>Matlab</tag>
      </tags>
  </entry>
  <entry>
    <title>F-OFDM vs OFDM</title>
    <url>/2021/06/15/F-OFDM%20vs%20OFDM/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h3 id="Divide-the-OFDM-cattier-bandwidth-into-multiple-sub-bands-with-different-parameters-and-filter-the-sub-bands-and-try-to-leave-as-few-isolation-bands-as-possible-between-the-sub-bands"><a href="#Divide-the-OFDM-cattier-bandwidth-into-multiple-sub-bands-with-different-parameters-and-filter-the-sub-bands-and-try-to-leave-as-few-isolation-bands-as-possible-between-the-sub-bands" class="headerlink" title="Divide the OFDM cattier bandwidth into multiple sub bands with different parameters, and filter the sub bands, and try to leave as few isolation bands as possible between the sub bands"></a>Divide the OFDM cattier bandwidth into multiple sub bands with different parameters, and filter the sub bands, and try to leave as few isolation bands as possible between the sub bands</h3><p><span class="github-emoji"><span>🌞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f552.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<span id="more"></span>
<hr>
<h2 id="books-Abstract"><a href="#books-Abstract" class="headerlink" title=":books: Abstract"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Abstract</h2><ul>
<li><em>With the launch of the 3GPP 5G standard, the 5G sky has gradually disappeared, and the bright stars of the candidate technology have dazzled us, and the 5G serialized new air interface technology proposed by Huawei is undoubtedly the brightest star among them. F-OFDM can realize the slicing of the physical layer of the air interface and is backward compatible with the LTE 4G system, and can meet the needs of future 5G development.</em></li>
</ul>
<h2 id="blue-book-OFDM-vs-F-OFDM"><a href="#blue-book-OFDM-vs-F-OFDM" class="headerlink" title=":blue_book: OFDM vs F-OFDM"></a><span class="github-emoji"><span>📘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> OFDM vs F-OFDM</h2><ul>
<li><em>OFDM modulates high-rate data to mutually orthogonal sub-carriers through serial/parallel conversion, and introduces cyclic prefixes, which better solves the headache of inter-symbol interference. But the main problem of OFDM is not flexible enough.</em></li>
<li><em>For example, the Internet of vehicles service with millisecond delay requires extremely short time-domain symbol and TTI; in the multi-connection scenario of the Internet of things, the amount of data transmitted by a single sensor is extremely low, but the requirements for the number of overall connections of the system are very high. It is necessary to configure a relatively narrow subcarrier spacing in the frequency domain. These flexible requirements cannot be met by OFDM technology.</em></li>
<li><em>We can understand the time-frequency resources of the system as a carriage. If the OFDM scheme is adopted for decoration, the train can only provide fixed-size hard seats (sub-carrier spacing). Everyone, regardless of fat or thin, rich or not, can only sitting on a hard seat of the same size, this situation is obviously not humane enough. For 5G, we hope that the seats and spaces can be flexibly customized according to the height, short, fat and thin of passengers. Hard seats, soft seats, sleepers, boxes…you can adjust them whatever you wang. This the adaptive harmony train, and F-OFDM technology is based on this idea.</em></li>
<li><em>F-OFDM can provide different sub-carrier spacing and numerology to meet the time-frequency resource requirements of different services. F-OFDM greatly reduces out-of-band leakage by optimizing the filter design, and the guard band overhead between different sub bands can be reduced to about 1%, which not only greatly improves the efficiency of spectrum utilization, but also, it’s possible to provides opportunities for future use of fragmented spectrum.</em></li>
<li><em>In general, on the basis of inheriting all the advantages of OFDM (high spectrum utilization, adaptive MIMO, etc.), F-OFDM overcomes some inherent shortcomings of OFDM, and further improves flexibility and spectrum utilization efficiency basic technology to realize 5G air interface slicing.</em></li>
</ul>
<h2 id="green-book-Benefits-or-advantages-of-F-OFDM"><a href="#green-book-Benefits-or-advantages-of-F-OFDM" class="headerlink" title=":green_book: Benefits or advantages of F-OFDM"></a><span class="github-emoji"><span>📗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Benefits or advantages of F-OFDM</h2><ol>
<li>Efficient utilization of spectrum.</li>
<li>It suppresses out of band emission and hence guard band consumption can be reduced to minimum level.</li>
<li>Optimized numerology can be applied to suit the needs of certain type of services within each sub bands.</li>
<li>Possibility to incorporate other waveforms such as GFDM, FBMC, UFMC etc.</li>
<li>Backward and forward compatibility.</li>
<li>Using sub band-based filtering, global synchronization requirement is being relaxed. Hence inter-sub-band asynchronous transmission can be supported.</li>
</ol>
<h2 id="orange-book-Drawbacks-or-disadvantages-of-F-FDOM"><a href="#orange-book-Drawbacks-or-disadvantages-of-F-FDOM" class="headerlink" title=":orange_book: Drawbacks or disadvantages of F-FDOM"></a><span class="github-emoji"><span>📙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Drawbacks or disadvantages of F-FDOM</h2><ol>
<li>The F-OFDM requires additional pair of transmit and receiver filters in transmitter and receiver chain respectively compare to conventional OFDM.</li>
<li>Like OFDM, CP can also be used in filter-based waveforms such as UFMC, F-OFDM to protect signal from SIS.</li>
<li>Since full-band filtering cannot remove any SIS, it exists in F-OFDM similar to standard OFDM.</li>
</ol>
<h2 id="open-book-Understanding-of-this-example"><a href="#open-book-Understanding-of-this-example" class="headerlink" title=":open_book: Understanding of this example"></a><span class="github-emoji"><span>📖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Understanding of this example</h2><ul>
<li><em>This example compares Filtered-OFDM modulation with generic Cyclic Prefix OFDM (CP-OFDM) modulation. For F-OFDM, a well-designed filter is applied to the time domain OFDM symbol to improve the out-of-band radiation of the sub-band signal, while maintaining the complex-domain orthogonality of OFDM symbols. This example also models Filtered-OFDM modulation with configurable parameters. It highlights the filter design technique and the basic transmit/receive processing.</em></li>
<li><em>A filter with a rectangular frequency response, i.e. a sinc impulse response, meets these criteria. To make this causal, the low-pass filter is realized using a window, which, effectively truncates the impulse response and offers smooth transitions to zero on both ends.</em></li>
<li><em>In F-OFDM, the sub-band CP-OFDM signal is passed through the designed filter. As the filter’s passband corresponds to the signal’s bandwidth, only the few subcarriers close to the edge are affected. A key consideration is that the filter length can be allowed to exceed the cyclic prefix length for F-OFDM. The inter-symbol interference incurred is minimized due to the filter design using windowing (with soft truncation).</em></li>
<li><em>Transmit-end processing operations are shown in the following F-OFDM transmitter diagram.</em></li>
<li><em>The example next highlights the basic receive processing for F-OFDM for a single OFDM symbol. The received signal is passed through a matched filter, followed by the normal CP-OFDM receiver. It accounts for both the filtering ramp-up and latency prior to the FFT operation.</em></li>
<li><em>No fading channel is considered in this example but noise is added to the received signal to achieve the desired SNR.</em></li>
</ul>
<h2 id="closed-book-Conclusion"><a href="#closed-book-Conclusion" class="headerlink" title=":closed_book: Conclusion"></a><span class="github-emoji"><span>📕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Conclusion</h2><ul>
<li><em>Comparing the plots of the spectral densities for CP-OFDM and F-OFDM schemes, F-OFDM has lower sidelobes. This allows a higher utilization of the allocated spectrum, leading to increased spectral efficiency.</em></li>
<li><em>When we design F-OFDM filter, appropriate filtering for F-OFDM satisfies the following criteria:</em></li>
</ul>
<blockquote>
<ol>
<li>Should have a flat passband over the subcarriers in the sub-band.</li>
<li>Should have a sharp transition band to minimize guard-bands.</li>
<li>Should have sufficient stop-band attenuation.</li>
</ol>
</blockquote>
<ul>
<li><em>Universal Filtered Multi-Carrier (UFMC) modulation scheme is another approach to sub-band filtered OFDM. For more information, see the UFMC vs. OFDM Modulation example. This F-OFDM example uses a single sub-band while the UFMC example uses multiple sub-bands.</em></li>
<li><em>F-OFDM and UFMC both use time-domain filtering with subtle differences in the way the filter is designed and applied. For UFMC, the length of filter is constrained to be equal to the cyclic-prefix length, while for F-OFDM, it can exceed the CP length.</em></li>
<li><em>For F-OFDM, the filter design leads to a slight loss in orthogonality (strictly speaking) which affects only the edge subcarriers.</em></li>
</ul>
<h2 id="memo-Code"><a href="#memo-Code" class="headerlink" title=":memo: Code"></a><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Code</h2><figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% F-OFDM vs. OFDM Modulation</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"></span><br><span class="line">s = rng(<span class="number">211</span>);       <span class="comment">% Set RNG state for repeatability</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">%% System Parameters</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"><span class="comment">% Define system parameters for the example. These parameters can be</span></span><br><span class="line"><span class="comment">% modified to explore their impact on the system.</span></span><br><span class="line"> </span><br><span class="line">numFFT = <span class="number">1024</span>;           <span class="comment">% Number of FFT points</span></span><br><span class="line">numRBs = <span class="number">50</span>;             <span class="comment">% Number of resource blocks</span></span><br><span class="line">rbSize = <span class="number">12</span>;             <span class="comment">% Number of subcarriers per resource block</span></span><br><span class="line">cpLen = <span class="number">72</span>;              <span class="comment">% Cyclic prefix length in samples</span></span><br><span class="line"> </span><br><span class="line">bitsPerSubCarrier = <span class="number">8</span>;   <span class="comment">% 2: QPSK, 4: 16QAM, 6: 64QAM, 8: 256QAM</span></span><br><span class="line">snrdB = <span class="number">18</span>;              <span class="comment">% SNR in dB</span></span><br><span class="line"> </span><br><span class="line">toneOffset = <span class="number">2.5</span>;        <span class="comment">% Tone offset or excess bandwidth (in subcarriers)</span></span><br><span class="line">L = <span class="number">513</span>;                 <span class="comment">% Filter length (=filterOrder+1), odd</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Filtered-OFDM Filter Design</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"></span><br><span class="line">numDataCarriers = numRBs*rbSize;    <span class="comment">% number of data subcarriers in subband</span></span><br><span class="line">halfFilt = <span class="built_in">floor</span>(L/<span class="number">2</span>);</span><br><span class="line">n = -halfFilt:halfFilt;  </span><br><span class="line"> </span><br><span class="line"><span class="comment">% Sinc function prototype filter</span></span><br><span class="line">pb = sinc((numDataCarriers+<span class="number">2</span>*toneOffset).*n./numFFT);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Sinc truncation window</span></span><br><span class="line">w = (<span class="number">0.5</span>*(<span class="number">1</span>+<span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>.*n/(L<span class="number">-1</span>)))).^<span class="number">0.6</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Normalized lowpass filter coefficients</span></span><br><span class="line">fnum = (pb.*w)/sum(pb.*w);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Filter impulse response</span></span><br><span class="line">h = fvtool(fnum, <span class="string">'Analysis'</span>, <span class="string">'impulse'</span>, ...</span><br><span class="line">    <span class="string">'NormalizedFrequency'</span>, <span class="string">'off'</span>, <span class="string">'Fs'</span>, <span class="number">15.36e6</span>);</span><br><span class="line">h.CurrentAxes.XLabel.String = <span class="string">'Time (\mus)'</span>;</span><br><span class="line">h.FigureToolbar = <span class="string">'off'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Use dsp filter objects for filtering</span></span><br><span class="line">filtTx = dsp.FIRFilter(<span class="string">'Structure'</span>, <span class="string">'Direct form symmetric'</span>, ...</span><br><span class="line">    <span class="string">'Numerator'</span>, fnum);</span><br><span class="line">filtRx = clone(filtTx); <span class="comment">% Matched filter for the Rx</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% QAM Symbol mapper</span></span><br><span class="line">qamMapper = comm.RectangularQAMModulator( ...</span><br><span class="line">    <span class="string">'ModulationOrder'</span>, <span class="number">2</span>^bitsPerSubCarrier, <span class="string">'BitInput'</span>, <span class="built_in">true</span>, ...</span><br><span class="line">    <span class="string">'NormalizationMethod'</span>, <span class="string">'Average power'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% F-OFDM Transmit Processing</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% Set up a figure for spectrum plot</span></span><br><span class="line">hFig = <span class="built_in">figure</span>(<span class="string">'Position'</span>, figposition([<span class="number">46</span> <span class="number">50</span> <span class="number">30</span> <span class="number">30</span>]));</span><br><span class="line">axis([<span class="number">-0.5</span> <span class="number">0.5</span> <span class="number">-200</span> <span class="number">-20</span>]);</span><br><span class="line"><span class="built_in">hold</span> on; </span><br><span class="line">grid on</span><br><span class="line">xlabel(<span class="string">'Normalized frequency'</span>);</span><br><span class="line">ylabel(<span class="string">'PSD (dBW/Hz)'</span>)</span><br><span class="line">title([<span class="string">'F-OFDM, '</span> num2str(numRBs) <span class="string">' Resource blocks, '</span>  ...</span><br><span class="line">    num2str(rbSize) <span class="string">' Subcarriers each'</span>])</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Generate data symbols</span></span><br><span class="line">bitsIn = randi([<span class="number">0</span> <span class="number">1</span>], bitsPerSubCarrier*numDataCarriers, <span class="number">1</span>);</span><br><span class="line">symbolsIn = qamMapper(bitsIn);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Pack data into an OFDM symbol </span></span><br><span class="line">offset = (numFFT-numDataCarriers)/<span class="number">2</span>; <span class="comment">% for band center</span></span><br><span class="line">symbolsInOFDM = [<span class="built_in">zeros</span>(offset,<span class="number">1</span>); symbolsIn; ...</span><br><span class="line">                 <span class="built_in">zeros</span>(numFFT-offset-numDataCarriers,<span class="number">1</span>)];</span><br><span class="line">ifftOut = ifft(ifftshift(symbolsInOFDM));</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Prepend cyclic prefix</span></span><br><span class="line">txSigOFDM = [ifftOut(<span class="keyword">end</span>-cpLen+<span class="number">1</span>:<span class="keyword">end</span>); ifftOut]; </span><br><span class="line"> </span><br><span class="line"><span class="comment">% Filter, with zero-padding to flush tail. Get the transmit signal</span></span><br><span class="line">txSigFOFDM = filtTx([txSigOFDM; <span class="built_in">zeros</span>(L<span class="number">-1</span>,<span class="number">1</span>)]);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Plot power spectral density (PSD) </span></span><br><span class="line">[psd,f] = periodogram(txSigFOFDM, rectwin(<span class="built_in">length</span>(txSigFOFDM)), ...</span><br><span class="line">                      numFFT*<span class="number">2</span>, <span class="number">1</span>, <span class="string">'centered'</span>); </span><br><span class="line"><span class="built_in">plot</span>(f,<span class="number">10</span>*<span class="built_in">log10</span>(psd)); </span><br><span class="line"> </span><br><span class="line"><span class="comment">% Compute peak-to-average-power ratio (PAPR)</span></span><br><span class="line">PAPR = comm.CCDF(<span class="string">'PAPROutputPort'</span>, <span class="built_in">true</span>, <span class="string">'PowerUnits'</span>, <span class="string">'dBW'</span>);</span><br><span class="line">[~,~,paprFOFDM] = PAPR(txSigFOFDM);</span><br><span class="line"><span class="built_in">disp</span>([<span class="string">'Peak-to-Average-Power-Ratio for F-OFDM = '</span> num2str(paprFOFDM) <span class="string">' dB'</span>]);</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% OFDM Modulation with Corresponding Parameters</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% Plot power spectral density (PSD) for OFDM signal</span></span><br><span class="line">[psd,f] = periodogram(txSigOFDM, rectwin(<span class="built_in">length</span>(txSigOFDM)), numFFT*<span class="number">2</span>, ...</span><br><span class="line">                      <span class="number">1</span>, <span class="string">'centered'</span>); </span><br><span class="line">hFig1 = <span class="built_in">figure</span>(<span class="string">'Position'</span>, figposition([<span class="number">46</span> <span class="number">15</span> <span class="number">30</span> <span class="number">30</span>])); </span><br><span class="line"><span class="built_in">plot</span>(f,<span class="number">10</span>*<span class="built_in">log10</span>(psd)); </span><br><span class="line">grid on</span><br><span class="line">axis([<span class="number">-0.5</span> <span class="number">0.5</span> <span class="number">-100</span> <span class="number">-20</span>]);</span><br><span class="line">xlabel(<span class="string">'Normalized frequency'</span>); </span><br><span class="line">ylabel(<span class="string">'PSD (dBW/Hz)'</span>)</span><br><span class="line">title([<span class="string">'OFDM, '</span> num2str(numRBs*rbSize) <span class="string">' Subcarriers'</span>])</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Compute peak-to-average-power ratio (PAPR)</span></span><br><span class="line">PAPR2 = comm.CCDF(<span class="string">'PAPROutputPort'</span>, <span class="built_in">true</span>, <span class="string">'PowerUnits'</span>, <span class="string">'dBW'</span>);</span><br><span class="line">[~,~,paprOFDM] = PAPR2(txSigOFDM);</span><br><span class="line"><span class="built_in">disp</span>([<span class="string">'Peak-to-Average-Power-Ratio for OFDM = '</span> num2str(paprOFDM) <span class="string">' dB'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">%% F-OFDM Receiver with No Channel</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% Add WGN</span></span><br><span class="line">rxSig = awgn(txSigFOFDM, snrdB, <span class="string">'measured'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"><span class="comment">% Receive processing operations are shown in the following F-OFDM receiver</span></span><br><span class="line"><span class="comment">% diagram.</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Receive matched filter</span></span><br><span class="line">rxSigFilt = filtRx(rxSig);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Account for filter delay </span></span><br><span class="line">rxSigFiltSync = rxSigFilt(L:<span class="keyword">end</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Remove cyclic prefix</span></span><br><span class="line">rxSymbol = rxSigFiltSync(cpLen+<span class="number">1</span>:<span class="keyword">end</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Perform FFT </span></span><br><span class="line">RxSymbols = fftshift(fft(rxSymbol));</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Select data subcarriers</span></span><br><span class="line">dataRxSymbols = RxSymbols(offset+(<span class="number">1</span>:numDataCarriers));</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Plot received symbols constellation</span></span><br><span class="line"><span class="keyword">switch</span> bitsPerSubCarrier</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>  <span class="comment">% QPSK</span></span><br><span class="line">        refConst = qammod((<span class="number">0</span>:<span class="number">3</span>).', <span class="number">4</span>, <span class="string">'UnitAveragePower'</span>, <span class="built_in">true</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>  <span class="comment">% 16QAM</span></span><br><span class="line">        refConst = qammod((<span class="number">0</span>:<span class="number">15</span>).', <span class="number">16</span>,<span class="string">'UnitAveragePower'</span>, <span class="built_in">true</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>  <span class="comment">% 64QAM</span></span><br><span class="line">        refConst = qammod((<span class="number">0</span>:<span class="number">63</span>).', <span class="number">64</span>,<span class="string">'UnitAveragePower'</span>, <span class="built_in">true</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>  <span class="comment">% 256QAM</span></span><br><span class="line">        refConst = qammod((<span class="number">0</span>:<span class="number">255</span>).', <span class="number">256</span>,<span class="string">'UnitAveragePower'</span>, <span class="built_in">true</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">constDiagRx = comm.ConstellationDiagram( ...</span><br><span class="line">    <span class="string">'ShowReferenceConstellation'</span>, <span class="built_in">true</span>, ...</span><br><span class="line">    <span class="string">'ReferenceConstellation'</span>, refConst, ...</span><br><span class="line">    <span class="string">'Position'</span>, figposition([<span class="number">20</span> <span class="number">15</span> <span class="number">25</span> <span class="number">30</span>]), ...</span><br><span class="line">    <span class="string">'MeasurementInterval'</span>, <span class="built_in">length</span>(dataRxSymbols), ...</span><br><span class="line">    <span class="string">'Title'</span>, <span class="string">'F-OFDM Demodulated Symbols'</span>, ...</span><br><span class="line">    <span class="string">'Name'</span>, <span class="string">'F-OFDM Reception'</span>, ...</span><br><span class="line">    <span class="string">'XLimits'</span>, [<span class="number">-1.5</span> <span class="number">1.5</span>], <span class="string">'YLimits'</span>, [<span class="number">-1.5</span> <span class="number">1.5</span>]);</span><br><span class="line">constDiagRx(dataRxSymbols);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Channel equalization is not necessary here as no channel is modeled</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Demapping and BER computation</span></span><br><span class="line">qamDemod = comm.RectangularQAMDemodulator(<span class="string">'ModulationOrder'</span>, ...</span><br><span class="line">    <span class="number">2</span>^bitsPerSubCarrier, <span class="string">'BitOutput'</span>, <span class="built_in">true</span>, ...</span><br><span class="line">    <span class="string">'NormalizationMethod'</span>, <span class="string">'Average power'</span>);</span><br><span class="line">BER = comm.ErrorRate;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Perform hard decision and measure errors</span></span><br><span class="line">rxBits = qamDemod(dataRxSymbols);</span><br><span class="line">ber = BER(bitsIn, rxBits);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">disp</span>([<span class="string">'F-OFDM Reception, BER = '</span> num2str(ber(<span class="number">1</span>)) <span class="string">' at SNR = '</span> ...</span><br><span class="line">    num2str(snrdB) <span class="string">' dB'</span>]);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Restore RNG state</span></span><br><span class="line">rng(s);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="chart-4ASK-Fig"><a href="#chart-4ASK-Fig" class="headerlink" title=":chart: 4ASK Fig"></a><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4ASK Fig</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/F-OFDM/Impluse_Response.bmp" alt="Fig.1  Impulse Response."></p>
<center><font size="2">Fig.1  Impulse Response.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/F-OFDM/F-OFDM_normalized_frequency.png" alt="Fig.2  F-OFDM normalized frequency."></p>
<center><font size="2">Fig.2  F-OFDM normalized frequency.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/F-OFDM/OFDM_normalized_frequency.png" alt="Fig.2  OFDM normalized frequency."></p>
<center><font size="2">Fig.3  OFDM normalized frequency.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/F-OFDM/F-OFDM_Reception.png" alt="Fig.4  F-OFDM Reception."></p>
<center><font size="2">Fig.4  F-OFDM Reception.</font></center>

<h3 id="bell-Reference"><a href="#bell-Reference" class="headerlink" title=":bell: Reference"></a><span class="github-emoji"><span>🔔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f514.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Reference</h3><blockquote>
<ol>
<li>Abdoli J., Jia M. and Ma J., “Filtered OFDM: A New Waveform for Future Wireless Systems,” 2015 IEEE® 16th International Workshop on Signal Processing Advances in Wireless Communications (SPAWC), Stockholm, 2015, pp. 66-70.</li>
<li>R1-162152. “OFDM based flexible waveform for 5G.” 3GPP TSG RAN WG1 meeting 84bis. Huawei; HiSilicon. April 2016.</li>
<li>R1-165425. “F-OFDM scheme and filter design.” 3GPP TSG RAN WG1 meeting 85. Huawei; HiSilicon. May 2016.</li>
</ol>
</blockquote>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>Matlab</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker To Kubernetes after V1.24</title>
    <url>/2024/05/10/Docker%20To%20Kubernetes/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 多机搭建Docker和Kebernetes集群环境，以及部署应用程序。</p>
<ul>
<li>Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、扩缩和管理。仅仅用Docker是不够的，增加Docker-Compose可以实现多容器的编排，但是Kubernetes可以实现多机的容器编排，实现更高级的容器编排功能。<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
</ul>
<span id="more"></span>
<h2 id="1-before"><a href="#1-before" class="headerlink" title="1. before"></a>1. before</h2><ol>
<li>在此之前，Master主机上已用<code>Docker 24.0.2</code>，但是发现Kubernetes团队在2020年12约初的<code>Kubernetes 1.20</code>的<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md">CHANGELOG</a>中指出”Docker as an underlying runtime is being deprecated. Docker-produced images will continue to work in your cluster with all runtimes, as they always have.”，逐渐开始放弃对Docker的支持。<span style="color:grey">所以在此之后的版本中，Kubernetes不再支持Docker作为底层运行时，可能是因为Docker长期以来不支持CRI(Container Runtime Interface)，以至于需要长期维护Dockershim组件来进行适配；当然也可能是由于某些团队之间的利益冲突。</span></li>
<li>早期k8s通过硬编码的方式支持Docker，后来通过CRI来支持多种容器，但是Docker并没有支持CRI，导致k8s需要维护dockershim。2022年05月的<code>Kubernetes 1.24</code>正式将dockershim移除，不再支持Docker作为底层运行时，所以需要优先选择containerd或者CRI-O作为底层运行时。</li>
<li>当然仍然可以继续使用Docker，目前存在支持CRI的shim cri-dockerd，但是这个项目并不由Kubernetes官方维护。</li>
<li><code>Docker Dasmon</code>是Docker的守护进程，用于管理Docker容器；<code>dockerd</code>是Docker的服务端，用于接收Docker客户端的请求，Docker客户端是Docker的命令行工具，用于与Docker服务端进行交互；<code>containerd</code>是Docker的容器运行时，用于管理容器的生命周期,<code>containerd-shim</code>是代理，用于与<code>OCI runtime(runc)</code>进行交互，<code>runc</code>是容器执行器，用于创建和运行容器。</li>
<li>为了避免不必要的警告和报错（<em>这是件会让人烦心的事情</em>），所以把移除dockershim前的最后一个大版本1.23.0作为本文使用环境，当然也是用了cri-dockerd作为底层运行时，使用后续版本的k8s也是可行的。</li>
</ol>
<h2 id="2-Versions"><a href="#2-Versions" class="headerlink" title="2. Versions"></a>2. Versions</h2><ul>
<li>System: Linux<ul>
<li>Operating System: Ubuntu 18.04.6 LTS</li>
<li>Kernel: Linux 5.4.0-84-generic</li>
<li>Architecture: x86-64</li>
</ul>
</li>
<li>Docker: 24.0.2</li>
<li>containerd: 1.6.21</li>
<li><em>Docker-Compose: 2.2.2</em></li>
<li>cri-dockerd: 0.3.14</li>
<li>kubeadm: 1.28.10</li>
<li>kubelet: 1.28.10</li>
<li>kubectl: 1.28.10</li>
<li><em>Kubespary: maybe later</em></li>
<li>Kubernetes: 1.28.10</li>
</ul>
<h2 id="3-Install"><a href="#3-Install" class="headerlink" title="3. Install"></a>3. Install</h2><h3 id="3-1-Docker"><a href="#3-1-Docker" class="headerlink" title="3.1 Docker"></a>3.1 Docker</h3><ul>
<li><p>Remove old versions</p>
  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc  </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Install</p>
  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --version 24.0.2</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check</p>
  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">docker --version</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Maybe the following error occurs: <code>permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/version": dial unix /var/run/docker.sock: connect: permission denied</code></li>
<li><p>To avoid this error, add the current user to the docker group (or use the root user):</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo gpasswd -a <span class="variable">$USER</span> docker</span><br><span class="line">newgrp docker</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="3-2-kubeadm、kubelet、kubectl"><a href="#3-2-kubeadm、kubelet、kubectl" class="headerlink" title="3.2 kubeadm、kubelet、kubectl"></a>3.2 kubeadm、kubelet、kubectl</h3><blockquote>
<p><code>kubeadm</code>用于创建k8s集群的工具，可以快速创建一个k8s集群，但是不适用于生产环境，可考虑使用<code>kubespray</code>或<code>kops</code>，更多的安全性、高可用性和监控以及日志，或者直接使用云服务商提供的k8s集群。<br><code>kubelet</code>在集群的每一个节点用来启动Pod和容器的组件，kubelet会根据PodSpec中的描述创建和管理容器。<br><code>kubectl</code>用于与k8s集群进行交互，可以通过kubectl来部署应用、查看集群资源、查看日志等。</p>
</blockquote>
<ul>
<li><p>Update</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y apt-transport-https ca-certificates curl gpg</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Add public key</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Aliyun</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Add repository</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /'</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># Aliyun</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/ /'</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Install and lock version</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubeadm version</span><br><span class="line">kubelet --version</span><br><span class="line">kubectl version --client</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Maybe the following error occurs, then you need to use proxy or VPN to access the Internet or other images such as Aliyun, Tencent Cloud, etc.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">E: Unable to locate package kubelet</span><br><span class="line">E: Unable to locate package kubeadm</span><br><span class="line">E: Unable to locate package kubect</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="3-3-CRI-O-or-containerd-or-cri-dockerd"><a href="#3-3-CRI-O-or-containerd-or-cri-dockerd" class="headerlink" title="3.3 CRI-O or containerd or cri-dockerd"></a>3.3 CRI-O or containerd or cri-dockerd</h3><blockquote>
<p>三选一即可，如果用的是Docker且k8s在1.24之前的版本，可以选择用dockershim替代cri-dockerd。</p>
</blockquote>
<ul>
<li><p>cri-dockerd</p>
<ul>
<li>Download the latest release from the <a href="https://github.com/Mirantis/cri-dockerd/releases">GitHub release page</a></li>
<li><p>Install</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install -y ./cri-dockerd_0.3.14.3-0.ubuntu-focal_amd64.deb </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check version and status</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">cri-dockerd --version</span><br><span class="line">systemctl status cri-docker</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Config containerd, and comment out the ‘disabled_plugins = [“cri”]’ line in the <code>/etc/containerd/config.toml</code> file.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi /etc/containerd/config.toml</span><br><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Config the cri-dockerd service<br>Also you can download the service file from the <a href="https://github.com/Mirantis/cri-dockerd/blob/master/packaging/systemd/cri-docker.service">GitHub release page</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo wget -O /etc/systemd/system/cri-docker.service https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.service</span><br><span class="line">sudo wget -O /etc/systemd/system/cri-docker.socket https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/cri-docker.socket</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Change the <code>ExecStart</code> in the <code>/etc/systemd/system/cri-docker.service</code> file， add <code>pause</code> image from Aliyun mirror.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Restart the cri-dockerd service</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload      <span class="comment"># 重新加载systemd管理的服务单元文件的命令</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> cri-docker</span><br><span class="line">sudo systemctl start cri-docker</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="3-4-Important-settings"><a href="#3-4-Important-settings" class="headerlink" title="3.4 Important settings"></a>3.4 Important settings</h3><ul>
<li><p>Change cgroup driver to systemd<br><code>kubeadm</code>把<code>kubelet</code>视为一个系统服务来管理，所以用`kubeadm启动时，推荐使用systemd作为cgroup驱动程序。</p>
<ul>
<li><p>cgroup for Docker</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"registry-mirrors"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"https://********.mirror.aliyuncs.com"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"exec-opts"</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">"native.cgroupdriver=systemd"</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>You can see your Aliyun mirror address in the <a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">Aliyun</a> after logging in.</p>
</blockquote>
</li>
<li><p>Restart Docker</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check cgroup driver in Docker</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">docker info | grep -i cgroup</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>cgroup for kubelet<br>在版本 1.22 及更高版本中，如果用户没有在KubeletConfiguration中设置cgroupDriver字段，kubeadm会将它设置为默认值systemd。</p>
</li>
</ul>
</li>
<li><p>Date and time synchronization, use <code>Chrony</code></p>
<ul>
<li><p>Install</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install chrony</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Start synchronization and check status</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl start chrony</span><br><span class="line">systemctl status chrony</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Set hostname</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo --static hostnamectl set-hostname master <span class="comment"># in master node</span></span><br><span class="line">sudo --static hostnamectl set-hostname node1  <span class="comment"># in node1</span></span><br><span class="line">sudo --static hostnamectl set-hostname node2  <span class="comment"># in node2</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Set host in master node and check ping</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.254.129 master</span></span><br><span class="line"><span class="string">192.168.254.130 node1</span></span><br><span class="line"><span class="string">192.168.254.131 node2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Disable selinux, edit <code>/etc/selinux/config</code> and set <code>SELINUX=disabled</code> and reboot the system.<br><span style="color:grey">允许容器访问宿主机的文件系统：Setting SELinux in permissive mode by runningsetenforce 0andsed …effectively disables it. This is required to allow containers to access the host filesystem, which is needed by pod networks for example. You have to do this until SELinux support is improved in the kubelet.</span></p>
<ul>
<li><p>In Ubuntu, there is no selinux, so the following error may occur:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span>: /etc/selinx/config: No such file or directory</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>disable unix firewall<br><span style="color:grey">避免重复的防火墙规则：Theiptablestooling can act as a compatibility layer, behaving like iptables but actually configuring nftables. This nftables backend is not compatible with the current kubeadm packages: it causes duplicated firewall rules and breakskube-proxy.</span></p>
<ul>
<li><p>关闭防火墙，默认应该是关的，<code>Status: inactive</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo ufw <span class="built_in">disable</span></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>也可以直接关闭防火墙服务，默认是开的，但防火墙未启动所以无效</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Disable swap<br><span style="color:grey">开启Swap将导致和k8s的初衷有所违背，产生性能下降，详见<a href="https://github.com/kubernetes/kubernetes/issues/53533">Issue</a></span><br>Reference: <a href="https://askubuntu.com/questions/214805/how-do-i-disable-swap">How do i disable swap</a>, reboot the system after disabling swap.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Temporary</span></span><br><span class="line">sudo swapoff -a</span><br><span class="line"><span class="comment"># Permanent</span></span><br><span class="line">sudo sed -i <span class="string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab</span><br><span class="line"><span class="comment"># Check</span></span><br><span class="line">sudo swapon --show</span><br><span class="line">free -h</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="3-5-Other-settings"><a href="#3-5-Other-settings" class="headerlink" title="3.5 Other settings"></a>3.5 Other settings</h3><ul>
<li><p>Check MAC and product_uuid, make sure they are unique, otherwise the cluster will not work properly.</p>
<ul>
<li>MAC</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install net-tools</span><br><span class="line">ifconfig</span><br><span class="line">ifconfig <span class="string">"your eth name"</span> | grep -i ether  </span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>product_uuid</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="built_in">cat</span> /sys/class/dmi/id/product_uuid</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="4-组件的版本偏差策略"><a href="#4-组件的版本偏差策略" class="headerlink" title="4. 组件的版本偏差策略"></a>4. 组件的版本偏差策略</h2><blockquote>
<p>若集群的<code>kube-apiserver</code>有多个版本，规则都将对每个版本取并集。</p>
</blockquote>
<h3 id="kubelet版本"><a href="#kubelet版本" class="headerlink" title="kubelet版本"></a>kubelet版本</h3><ul>
<li><code>kubelet</code>版本不能比<code>kube-apiserver</code>版本新。</li>
<li><code>kubelet</code>可以比<code>kube-apiserver</code>低三个次要版本（如果<code>kubelet</code> &lt; 1.25，则只能比<code>kube-apiserver</code>低两个次要版本）。</li>
<li>例如<ul>
<li><code>kube-apiserver</code>处于1.30版本</li>
<li><code>kubelet</code>支持1.30、1.29、1.28和1.27版本</li>
</ul>
</li>
</ul>
<h3 id="kube-proxy版本"><a href="#kube-proxy版本" class="headerlink" title="kube-proxy版本"></a>kube-proxy版本</h3><ul>
<li>其他同<code>kubelet</code>一样，<code>kube-proxy</code>的版本不能比<code>kube-apiserver</code>版本新，小于等于三个次要版本。</li>
<li><code>kube-proxy</code>可以与<code>kubelet</code>有新或旧三个次要版本，<code>1.25</code>之前则是两个次要版本。</li>
</ul>
<h3 id="kube-controller-manager、kube-scheduler、cloud-controller-manager版本"><a href="#kube-controller-manager、kube-scheduler、cloud-controller-manager版本" class="headerlink" title="kube-controller-manager、kube-scheduler、cloud-controller-manager版本"></a>kube-controller-manager、kube-scheduler、cloud-controller-manager版本</h3><ul>
<li>不能比<code>kube-apiserver</code>版本新，最多比<code>kube-apiserver</code>低一个次要版本。</li>
<li>允许实时升级</li>
</ul>
<h3 id="kubectl版本"><a href="#kubectl版本" class="headerlink" title="kubectl版本"></a>kubectl版本</h3><ul>
<li>与<code>kube-apiserver</code>版本相同或者低、高于<code>kube-apiserver</code>一个次要版本。</li>
</ul>
<h2 id="5-Start-k8s-cluster"><a href="#5-Start-k8s-cluster" class="headerlink" title="5. Start k8s cluster"></a>5. Start k8s cluster</h2><ul>
<li><p>Initialize the master node</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.254.129 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.28.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --ignore-preflight-errors=all</span><br><span class="line"></span><br><span class="line"><span class="comment"># This command will occur the following error (cri-dockerd and containerd are compatible):</span></span><br><span class="line"></span><br><span class="line">Found multiple CRI endpoints on the host. Please define <span class="built_in">which</span> one <span class="keyword">do</span> you wish to use by setting the <span class="string">'criSocket'</span> field <span class="keyword">in</span> the kubeadm configuration file: unix:///var/run/containerd/containerd.sock, unix:///var/run/cri-dockerd.sock</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.254.129 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.28.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --ignore-preflight-errors=all \</span><br><span class="line">  --cri-socket=unix:///var/run/cri-dockerd.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># Reply success</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.254.129:6443 --token kgsf73.msjq37v3zwqkaycg \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:feb06b7d17a02964c162b3f5dda5e5182f8e407383ebf1d974b26416937d65ec</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Copy the configuration file to the user directory</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check the status of the master node and the pods, <em>we haven’t installed the network plugin yet, so the master is in the <code>NotReady</code> state.</em></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME     STATUS     ROLES           AGE    VERSION</span><br><span class="line">master   NotReady   control-plane   8m9s   v1.28.10</span><br><span class="line"></span><br><span class="line">kubectl get pod -A</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-66f779496c-6b4rw         0/1     Pending   0          6m13s</span><br><span class="line">kube-system   coredns-66f779496c-xszmj         0/1     Pending   0          6m13s</span><br><span class="line">kube-system   etcd-master                      1/1     Running   0          6m27s</span><br><span class="line">kube-system   kube-apiserver-master            1/1     Running   0          6m26s</span><br><span class="line">kube-system   kube-controller-manager-master   1/1     Running   0          6m29s</span><br><span class="line">kube-system   kube-proxy-r87hl                 1/1     Running   0          6m13s</span><br><span class="line">kube-system   kube-scheduler-master            1/1     Running   0          6m28s</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Join the worker node<br>创建的指令和token在<code>kubeadm init</code>输出的最后一行，也需要<code>--cri-socket /var/run/cri-dockerd.sock</code>，因为我们的节点都配置了<code>cri-dockerd</code>以及<code>containerd</code>，存在冲突，需要指定使用runc。token的有效期为24小时，过期后需要<code>kubeadm token create --print-join-command</code>重新生成。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># The command is generated by the master node, the last line of the output of the `kubeadm init` command.</span></span><br><span class="line"><span class="comment"># Also need --cri-socket /var/run/cri-dockerd.sock'</span></span><br><span class="line">sudo kubeadm <span class="built_in">join</span> 192.168.254.129:6443 --cri-socket unix:///var/run/cri-dockerd.sock --token kgsf73.msjq37v3zwqkaycg \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:feb06b7d17a02964c162b3f5dda5e5182f8e407383ebf1d974b26416937d65ec</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Check in the master node</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl get nodes -A</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                             READY   STATUS              RESTARTS   AGE</span><br><span class="line">kube-system   coredns-66f779496c-6b4rw         0/1     Pending             0          23m</span><br><span class="line">kube-system   coredns-66f779496c-xszmj         0/1     Pending             0          23m</span><br><span class="line">kube-system   etcd-master                      1/1     Running             0          24m</span><br><span class="line">kube-system   kube-apiserver-master            1/1     Running             0          24m</span><br><span class="line">kube-system   kube-controller-manager-master   1/1     Running             0          24m</span><br><span class="line">kube-system   kube-proxy-5jgmq                 0/1     ContainerCreating   0          106s</span><br><span class="line">kube-system   kube-proxy-p9tq5                 0/1     ContainerCreating   0          6m8s</span><br><span class="line">kube-system   kube-proxy-r87hl                 1/1     Running             0          23m</span><br><span class="line">kube-system   kube-scheduler-master            1/1     Running             0          24m</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Copy the configuration file to the user directory, 否则将导致<code>kubectl get nodes</code>时出现<code>The connection to the server localhost:8080 was refused - did you specify the right host or port?</code>，以及该节点将始终处于<code>NotReady</code>状态，该节点的kube-proxy处于<code>ContainerCreating</code>状态。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/kubelet.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Remove the node from the cluster</p>
<ul>
<li><p><strong>In master node</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Check the node 和 pods, 先检查一下</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods -A -o wide</span><br><span class="line"><span class="comment"># 阻止调度新的pod在该节点上，但此时pod可以在node上继续运行</span></span><br><span class="line">kubectl cordon node1</span><br><span class="line"><span class="comment"># 驱逐node1上的所有pod</span></span><br><span class="line">kubectl drain node1 --ignore-daemonsets --delete-local-data</span><br><span class="line"><span class="comment"># 删除node1</span></span><br><span class="line">kubectl delete node node1</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>In worker node</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Leave the cluster</span></span><br><span class="line">sudo kubeadm reset --cri-socket /var/run/cri-dockerd.sock</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 删除残留的文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/kubernetes/</span><br><span class="line">sudo <span class="built_in">rm</span> -rf <span class="variable">$HOME</span>/.kube</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除iptables或者ipvs的配置</span></span><br><span class="line">sudo iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">sudo ipvsadm --clear</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Add CNI plugin<br>到现在为止不同的宿主机之间的pod无法跨主机通信，需要安装网络插件，这里选择<code>Calico</code>，也可以选择<code>Flannel</code>、<code>Cilium</code>、<code>Weave Net</code>等。</p>
<ul>
<li><p>Download the <code>Calico</code> plugin</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://docs.projectcalico.org/manifests/calico.yaml</span></span><br><span class="line">curl -O https://docs.tigera.io/archive/v3.25/manifests/calico.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Modify the <code>calico.yaml</code> file, change the <code>CALICO_IPV4POOL_CIDR</code> to <code>pod-network-cidr's</code> value, and apply the <code>Calico</code> plugin.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line">    value: <span class="string">"10.244.0.0/16"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>But there is still some bugs those are fixed in <a href="#jump">Debug Section</a>.</p>
</li>
</ul>
</li>
<li><p>Complete the master ande node1, node2 <em>(need to wait for a while)</em></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">boom@master:~$ kubectl get pods -A -o wide</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE     IP                NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   calico-kube-controllers-6d668dcdd6-gbrfq   1/1     Running   0             57m     10.244.104.3      node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-f8jwx                          1/1     Running   0             5m21s   192.168.254.130   node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-gvs6h                          1/1     Running   0             57m     192.168.254.131   node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-qk946                          1/1     Running   1 (45m ago)   57m     192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-66f779496c-6b4rw                   1/1     Running   2 (45m ago)   7h53m   10.244.219.66     master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-66f779496c-xszmj                   1/1     Running   2 (45m ago)   7h53m   10.244.219.65     master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-master                                1/1     Running   2 (45m ago)   7h54m   192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-master                      1/1     Running   2 (45m ago)   7h54m   192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-master             1/1     Running   2 (45m ago)   7h54m   192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-ff75p                           1/1     Running   0             86m     192.168.254.131   node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-r87hl                           1/1     Running   2 (45m ago)   7h53m   192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-zgnjd                           1/1     Running   0             5m21s   192.168.254.130   node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-master                      1/1     Running   2 (45m ago)   7h54m   192.168.254.129   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">boom@master:~$ kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES           AGE     VERSION    INTERNAL-IP       EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span><br><span class="line">master   Ready    control-plane   7h58m   v1.28.10   192.168.254.129   &lt;none&gt;        Ubuntu 18.04.6 LTS   5.4.0-150-generic   docker://24.0.2</span><br><span class="line">node1    Ready    &lt;none&gt;          10m     v1.28.10   192.168.254.130   &lt;none&gt;        Ubuntu 18.04.6 LTS   5.4.0-150-generic   docker://24.0.2</span><br><span class="line">node2    Ready    &lt;none&gt;          90m     v1.28.10   192.168.254.131   &lt;none&gt;        Ubuntu 18.04.6 LTS   5.4.0-150-generic   docker://24.0.2</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Dashboard</p>
<ul>
<li><p>Download the <code>Dashboard</code> plugin</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -O https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Modify the <code>recommended.yaml</code> file, add the <code>type: NodePort</code> to the <code>Service</code> section, then apply the <code>Dashboard</code> plugin.</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl apply -f recommended.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Check the <code>Dashboard</code> plugin, but the <code>Pod</code> is in the <code>Pending</code> state.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl get pod -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS    RESTARTS      AGE     IP                NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-5657497c4c-rvfnh   1/1     Running   0             3m51s   10.244.166.130    node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-78f87ddfc-52msp         1/1     Running   0             3m51s   10.244.166.129    node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Get the port of the <code>Dashboard</code> plugin, get <code>32000</code> <strong>(will change every time you apply the <code>Dashboard</code> plugin, so you need to check it every time).</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl get svc -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.105.243.112   &lt;none&gt;        8000/TCP        2m42s</span><br><span class="line">kubernetes-dashboard        NodePort    10.99.228.207    &lt;none&gt;        443:32000/TCP   2m43s</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Access the <code>Dashboard</code> plugin, use the <code>master</code> node’s IP and the <code>NodePort</code> port.</p>
</li>
</ul>
<p><img src="https://www.lingzhicheng.cn/usr/file/picture/k8s/k8sDashboardLogin.jpg" alt="DashboardLogin"></p>
<ul>
<li><p>Create a <code>Dashboard</code> user, and get the token. (Or you can use the <code>kubeconfig</code> file)</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Create a service account</span></span><br><span class="line">kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span><br><span class="line"><span class="comment"># Create a cluster role binding</span></span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span><br><span class="line"><span class="comment"># Get the token</span></span><br><span class="line">kubectl create token dashboard-admin -n kubernetes-dashboard</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><img src="https://www.lingzhicheng.cn/usr/file/picture/k8s/k8sWorkloads.jpg" alt="DashboardWorkloads"></p>
</li>
</ul>
<h2 id="6-Debug"><a href="#6-Debug" class="headerlink" title="6.  Debug"></a>6.  <span id="jump">Debug</span></h2><ul>
<li><p>The pod <code>kube-proxy</code> is in <code>ContainerCreating</code> status for a long time。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl  describe pod kube-proxy-4pkw4 -n kube-system</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">Type     Reason                  Age                   From               Message</span><br><span class="line">----     ------                  ----                  ----               -------</span><br><span class="line">Normal   Scheduled               12m                   default-scheduler  Successfully assigned kube-system/kube-proxy-4pkw4 to node2</span><br><span class="line">Warning  FailedCreatePodSandBox  4m52s (x2 over 6m1s)  kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed pulling image <span class="string">"registry.k8s.io/pause:3.9"</span>: Error response from daemon: Head <span class="string">"https://europe-west2-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.9"</span>: dial tcp 108.177.125.82:443: connect: connection refused</span><br><span class="line">Warning  FailedCreatePodSandBox  44s (x8 over 10m)     kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed pulling image <span class="string">"registry.k8s.io/pause:3.9"</span>: Error response from daemon: Head <span class="string">"https://us-west2-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.9"</span>: dial tcp 108.177.97.82:443: connect: connection refused</span><br><span class="line">Warning  FailedCreatePodSandBox  10s (x11 over 11m)    kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed pulling image <span class="string">"registry.k8s.io/pause:3.9"</span>: Error response from daemon: Head <span class="string">"https://asia-east1-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.9"</span>: dial tcp 74.125.23.82:443: connect: connection refused</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>查一下应该是<code>pause</code>的镜像拉取失败。但是已经在上文，<code>/etc/systemd/system/cri-docker.service</code>中的<code>ExecStart</code>中添加了<code>pause</code>的镜像，有可能是没有重启<code>cri-dockerd</code>服务，导致镜像没有生效；或者是没有重新加载systemd管理的服务单元文件。<em>修复后加载成功了</em></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart cri-docker</span><br><span class="line"></span><br><span class="line">kubectl  describe pod kube-proxy-4pkw4 -n kube-system</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">Type    Reason     Age    From               Message</span><br><span class="line">----    ------     ----   ----               -------</span><br><span class="line">Normal  Scheduled  5m24s  default-scheduler  Successfully assigned kube-system/kube-proxy-ff75p to node2</span><br><span class="line">Normal  Pulling    5m22s  kubelet            Pulling image <span class="string">"registry.aliyuncs.com/google_containers/kube-proxy:v1.28.0"</span></span><br><span class="line">Normal  Pulled     5m16s  kubelet            Successfully pulled image <span class="string">"registry.aliyuncs.com/google_containers/kube-proxy:v1.28.0"</span> <span class="keyword">in</span> 6.031s (6.032s including waiting)</span><br><span class="line">Normal  Created    5m16s  kubelet            Created container kube-proxy</span><br><span class="line">Normal  Started    5m16s  kubelet            Started container kube-proxy</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>The pod <code>calico-node-fcdmn</code> is in <code>Init:ImagePullBackOff</code> status for a long time, 查一下应该是<code>calico</code>的镜像拉取失败</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl  describe pod calico-node-fcdmn -n kube-system</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">Type     Reason     Age                  From               Message</span><br><span class="line">----     ------     ----                 ----               -------</span><br><span class="line">Normal   Scheduled  57m                  default-scheduler  Successfully assigned kube-system/calico-node-fcdmn to node1</span><br><span class="line">Normal   Pulling    50m (x4 over 56m)    kubelet            Pulling image <span class="string">"docker.io/calico/cni:v3.25.0"</span></span><br><span class="line">Warning  Failed     49m (x4 over 55m)    kubelet            Error: ErrImagePull</span><br><span class="line">Warning  Failed     48m (x7 over 55m)    kubelet            Error: ImagePullBackOff</span><br><span class="line">Warning  Failed     21m (x9 over 55m)    kubelet            Failed to pull image <span class="string">"docker.io/calico/cni:v3.25.0"</span>: rpc error: code = Canceled desc = context canceled</span><br><span class="line">Normal   BackOff    11m (x127 over 55m)  kubelet            Back-off pulling image <span class="string">"docker.io/calico/cni:v3.25.0"</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>查一下还是镜像源的问题，虽然给docker配置了阿里云的镜像源，但是<code>calico</code>的镜像还是从<code>docker.io</code>拉取，所以怀疑是Calico清单文件出了问题，看一下果然是，网上一堆居然都不解决这个问题能成功加载的，看出来好多都是东拼西凑的Tutorial。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> calico.yaml |grep <span class="string">'image:'</span></span><br><span class="line"></span><br><span class="line">image: docker.io/calico/cni:v3.25.0</span><br><span class="line">image: docker.io/calico/cni:v3.25.0</span><br><span class="line">image: docker.io/calico/node:v3.25.0</span><br><span class="line">image: docker.io/calico/node:v3.25.0</span><br><span class="line">image: docker.io/calico/kube-controllers:v3.25.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换掉所有'docker.io'的前缀为空</span></span><br><span class="line">sed -i <span class="string">'s#docker.io/##g'</span> calico.yaml</span><br><span class="line"><span class="comment"># 重新检查</span></span><br><span class="line"><span class="built_in">cat</span> calico.yaml |grep <span class="string">'image:'</span></span><br><span class="line">image: calico/cni:v3.25.0</span><br><span class="line">image: calico/cni:v3.25.0</span><br><span class="line">image: calico/node:v3.25.0</span><br><span class="line">image: calico/node:v3.25.0</span><br><span class="line">image: calico/kube-controllers:v3.25.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启calico</span></span><br><span class="line">kubectl delete -f calico.yaml</span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="7-Add-service"><a href="#7-Add-service" class="headerlink" title="7. Add service"></a>7. Add service</h2><ul>
<li><p>Nginx <em>(for example, nginx-deployment.yaml)</em></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment-1</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-1</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-1</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span>  </span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span>  </span><br><span class="line">        <span class="attr">ports:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment-2</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-2</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-2</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span>  </span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span>  </span><br><span class="line">        <span class="attr">ports:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>  </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Apply the <code>Nginx</code> service</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">kubectl apply -f nginx-deployment.yaml</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="8-Stop-and-restart-the-cluster"><a href="#8-Stop-and-restart-the-cluster" class="headerlink" title="8. Stop and restart the cluster"></a>8. Stop and restart the cluster</h2><ul>
<li><p>Stop the cluster</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">systemctl stop kubelet </span><br><span class="line">systemctl stop etcd </span><br><span class="line">systemctl stop docker</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Restart the cluster</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status docker etcd kubelet</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<!-- markdownlint-disable-file MD025 MD028 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>ElasticSearch query performance optimization</title>
    <url>/2024/08/13/ElasticSearch%20query%20performance%20optimization/</url>
    <content><![CDATA[<blockquote>
<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><strong>Elasticsearch</strong>使原生的<strong>Lucene</strong>查询更加简单，同时提供了更多的功能，且可以通过<strong>RESTful API</strong>访问。<strong>Elasticsearch</strong>是一个分布式的搜索引擎，提供了一个分布式多用户能力的全文搜索引擎，基于<strong>RESTful</strong>的<strong>web</strong>接口。此外也可以扩展到几乎无限数量的服务器，以及能力去处理<strong>PB</strong>级别的数据。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-核心概念"><a href="#books-核心概念" class="headerlink" title=":books: 核心概念"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 核心概念</h2><h3 id="lock-基本概念"><a href="#lock-基本概念" class="headerlink" title=":lock: 基本概念"></a><span class="github-emoji"><span>🔒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f512.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 基本概念</h3><blockquote>
<p>为了方便理解Elasticsearch的一些基本概念，将其中的一些概念和关系型数据库做类比。<strong>但是请注意，这样类比并不是非常合适，甚至可能存在一些偏差，仅适用为初期提供更好的理解。</strong></p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Elasticsearch</th>
<th style="text-align:center">Mysql</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">索引库<code>Index</code></td>
<td style="text-align:center">数据库<code>Database</code></td>
</tr>
<tr>
<td style="text-align:center">文档类型<code>Type</code>（ES6.0开始逐渐弃用）</td>
<td style="text-align:center">数据表<code>Table</code></td>
</tr>
<tr>
<td style="text-align:center">文档<code>Document</code></td>
<td style="text-align:center">行数据<code>Row</code></td>
</tr>
<tr>
<td style="text-align:center">字段<code>Field</code></td>
<td style="text-align:center">具体到某一列<code>Column</code></td>
</tr>
<tr>
<td style="text-align:center">文档ID</td>
<td style="text-align:center">主键ID</td>
</tr>
<tr>
<td style="text-align:center">查询<code>Query DSL</code></td>
<td style="text-align:center">查询<code>SQL</code></td>
</tr>
<tr>
<td style="text-align:center"><code>Get http://...</code></td>
<td style="text-align:center"><code>SELECT * FROM...</code></td>
</tr>
<tr>
<td style="text-align:center"><code>PUT http://...</code></td>
<td style="text-align:center"><code>UPDATE TABLE SET...</code></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><code>Index</code>是文档的集合，相当于关系型数据库中的数据库，一个<code>Index</code>可以包含多个<code>Type</code>，但是在ES6.0版本中逐渐弃用<code>Type</code>，一个<code>Index</code>只能包含一个<code>Type</code><ul>
<li>索引名称必须是小写的，不能包含逗号、空格等特殊字符</li>
<li>索引有<code>mapping</code>和<code>setting</code>两个配置，<code>mapping</code>定义了文档的字段类型，<code>setting</code>定义了索引的配置例如分片、副本和自定义的<code>analyzer</code></li>
</ul>
</li>
<li><code>Document</code>是可搜索数据的最小单元，相当于关系型数据库中的一条记录，在ES中会被序列化成Json格式存储</li>
<li>存储的Json对象由各个字段组成，相当于关系型数据库中的列，同时每个字段也有其自己的类型（字符串、布尔、时间范围等）</li>
<li>创建文档时若不指定字段的类型，ES将自动匹配映射，但是在生产环境中最好自定义映射</li>
<li>每个文档都有一个ID相当于Mysql的主键，可以自定也可以自动生成</li>
<li>节点<code>Node</code>是一个单独的Elasticsearch实例，它属于一个集群<code>Cluster</code>，集群是由一个或多个节点组成的，本质上一个节点可简单看作是一个进程，在集群中建议在单机只部署一个高性能节点，单机多节点反而导致性能下降；同样也具有一般分布式架构的选举、<code>coor</code>等</li>
<li>分片<code>Shard</code>是ES中最小的工作单元，每个分片都是一个<code>Lucene</code>实例，分片是ES实现分布式和水平扩展的基础，分片的数量在索引创建时就已经确定，分片的数量只能增加不能减少，一般不建议后期再次修改</li>
<li>副本<code>Replica</code>是分片的副本，副本的作用是提高数据的可用性，副本的数量可以动态调整，副本的数量越多，读性能越好，但是写性能会下降，副本的数量不能超过节点的数量，默认副本系数为1，也就是给每个主分片创建一个copy</li>
<li><strong>关于<code>Type</code></strong>，多<code>Type</code>里的字段需要保持一致，也就是不同实体之间出现了很多冗余，导致分布稀疏，干扰了<code>Lucene</code>压缩文档的能力，影响存储性能；相对于<code>Mysql</code>中每个<code>Table</code>下的<code>Scheme</code>是没有限制要保持一致的，这也是区别之一<ul>
<li><code>6.x</code>之前可以有多个<code>Type</code></li>
<li><code>6.x</code>之后只能有一个自定义名字的文档类型</li>
<li><code>7.x</code>之后只能有一个且名字是<code>_doc</code></li>
<li>未来可能取消文档类型的概念，部分API将改动</li>
</ul>
</li>
</ul>
<h2 id="pencil2-查询性能优化"><a href="#pencil2-查询性能优化" class="headerlink" title=":pencil2: 查询性能优化"></a><span class="github-emoji"><span>✏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 查询性能优化</h2><h3 id="Filesystem-Cache-文件系统缓存"><a href="#Filesystem-Cache-文件系统缓存" class="headerlink" title="Filesystem Cache 文件系统缓存"></a>Filesystem Cache 文件系统缓存</h3><blockquote>
<p>数据写入流程：客户端选择一个Node发送请求，路由到主分片，主分片将数据先写入到<code>buffer</code>里，同时将数据写到<code>translog</code>日志（同步写入到副本分片），可选写到<code>translog</code>的同时同步写入磁盘或者等待后异步刷到磁盘；若<code>buffer</code>满了或是手动触发刷新<code>refresh</code>，就会刷新到<code>Filesystem Cache</code>，此时生成一个新的<code>segment</code>就可以被搜索到，一定时间或<code>translog</code>超出大小后触发<code>flush</code>将<code>Filesystem Cache</code>数据同步到磁盘然后清空<code>translog</code>。<strong>简而言之，写数据都写到磁盘里了，搜索从磁盘里搜索才是查询性能的瓶颈所在</strong></p>
</blockquote>
<ul>
<li>尽可能给<code>filesystem cache</code>分配更多内存，最佳情况是大于ES所需要搜索的数据大小，可以保证容纳所有索引数据，搜索全部走内存的话性能非常高</li>
<li>硬件配置的提升的有限度的，可以考虑减少存储的索引规模，只存储需要搜索的索引，将<code>id</code>、<code>name</code>、<code>age</code>等字段存入ES，将其他数据存在<code>HBase</code>等适合存放大规模在线数据的数据库，从ES中查询到关键字段再去Hbase中查完整的数据</li>
</ul>
<h3 id="数据冷热分离"><a href="#数据冷热分离" class="headerlink" title="数据冷热分离"></a>数据冷热分离</h3><blockquote>
<p>无法完全保证<code>Filesystem Cache</code>大于数据量时，考虑分离热点数据和冷数据</p>
</blockquote>
<ul>
<li>间隔一段时间自动搜索热点数据，保证热点数据始终在<code>Filesystem Cache</code>里，其实就是做一个预热的子系统</li>
<li>拆分冷热数据构建不同的索引，防止热数据被冷数据冲刷掉，其实就是做类似于Mysql的分库，以牺牲冷数据的查询性能来提升热数据的查询性能</li>
</ul>
<h3 id="分页查询优化"><a href="#分页查询优化" class="headerlink" title="分页查询优化"></a>分页查询优化</h3><ul>
<li>尽量避免复杂的操作，例如<code>join</code>查询</li>
<li>和Mysql类似，分页查询越后面越慢，深度分页性能很差，也就是需要先做一个过滤，那么过滤用什么方式？<ul>
<li>使用<code>scroll api</code>进行深度分页，但是作者不再推荐使用这个，<code>scroll</code>将一次性给出所有数据的快照谢谢，然后通过<code>scroll_id</code>移动查询，后续的查询基本都将是毫秒级，但不能实现跳转，同时数据实时性存在缺陷</li>
<li>使用<code>search_after</code>利用前一页的检索结果来帮助检索下一页，同样这也无法实现随意跳转，官方推荐使用 <code>_uid</code>作为全局唯一值，其实使用业务层的<code>id</code>也可以，在模型设计时需要考虑预留一个用于sort的字段</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Fake news detection(Literature review)</title>
    <url>/2022/07/06/Fake%20news%20detection(Literature%20review)/</url>
    <content><![CDATA[<p><strong>摘要</strong>：随着移动互联网的快速发展，人们的社交方式发生持续变革，微博和Twitter等逐渐成为人们获取信息和发表意见的便捷在线平台。然而，便捷在线平台同样导致了虚假消息的大量产生和传播，将会给舆论和社会稳定带来不利影响。本文调研了虚假消息检测领域的研究现状，主要介绍了基于有大量数据标注的监督学习方法，强调了基于传播模式的研究前景。之后简单介绍了一些评估方法和常用的虚假消息检测领域的数据集。最后进行总结，为基于传播差异的虚假消息检测方法设计与实现做好基础。</p>
<p><strong>关键词</strong>：信息传播、深度学习、虚假消息、传播差异</p>
<span id="more"></span>
<style>
.center {
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>

<h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1  引言"></a>1  引言</h2><p>  近年来，得益于移动互联网的发展，微博和Twitter等主流社交媒体已经成为人们获取信息和发布信息的重要平台<sup><a href="http://cjc.ict.ac.cn/online/onlinepaper/xbl-2016327154823.pdf">1</a></sup>，信息的自由获取和传播达到了空前的便利，给虚假消息创造了有利的生存环境。虚假消息有几个相近的定义，如谣言、虚假新闻等，都是通过对图像、文本、音频视频进行处理以歪曲或捏造事实，企图误导或引诱大众从而达到经济或政治目的。<br>  虚假消息主要在互联网发布和广泛传播。用户对消息和文章的评论、点赞与转发构成了最基本的在线社交活动<sup><a href="http://edit.jeit.ac.cn/EN/article/downloadArticleFile.do?attachType=PDF&amp;id=18265">2</a></sup>，在线社交网络中的用户通过评论、点赞等基本操作将消息传播出去，人的情绪、观点和行为容易受到他人的影响，虚假消息利用这一特点吸引注意力，通过用户间的社交活动进行有效传播<sup><a href="http://www.bulletin.cas.cn/zgkxyyk/ch/reader/view_abstract.aspx?file_no=20150208&amp;flag=1">3</a></sup>。传统纸媒发版的内容需要经编辑严格审核，可信度得到大众的认可，然而用户在线上平台发布的文本、图片和视频很少经过内容真实性验证，经评论与转发使得虚假消息得到进一步传播。传统的解决方案是通过人工识别的方式对发布在社交网络的消息进行甄别，但存在效率低下和具有时滞性等问题<sup><a href="http://www.joca.cn/CN/abstract/abstract23957.shtml">4</a></sup>，难以在第一时间对海量数据进行甄别，无法在传播初期阻断虚假消息的散布。随着在线社交的普及，这种现象变得更为普遍，依靠传统的人工识别已不再适用，因此迫切需要一种高效的方法自动识别、检测出虚假消息进而阻断影响范围的持续扩大。<br>  已有的检测方法主要通过提取消息内容、用户可信度和传播模式等关键特征进行训练得到真假消息二分类器以实现虚假消息的自动检测，也有研究采用多特征融合的方式进行检测以提高性能。其中常用的分类器包括：支持向量机（Support Vector Machine，SVM）<sup><a href="https://link.springer.com/article/10.1007/BF00994018">5</a></sup>、随机森林（Random Forest，RF）<sup><a href="http://library.ioz.ac.cn/bitstream/000000/10883/1/%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97%E6%A8%A1%E5%9E%8B%E5%9C%A8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.pdf">6</a></sup>和决策树（Decision Tree，DT）<sup><a href="http://www.cqvip.com/">7</a></sup>等。然而这些依赖于特征工程的方法非常耗时费力，并且需要制作特定的数据，缺乏高层的特征表征，因此往往针对性较强，缺乏泛化性能。另外也有一系列研究基于深度学习技术对真实消息与虚假消息在传播模式上的结构特征进行挖掘，利用图卷积网络提取消息传播过程中的拓扑结构特征，对局部的结构信息进行融合以得到更丰富的特征表示。<br>  本文主要开展虚假消息检测基于有完全数据标注的监督学习领域研究，针对基于消息内容和消息传播结构等检测方法进行综述，从研究现状、应用、优缺点等方面进行分析，为进一步研究基于传播差异的虚假消息检测方法设计与实现打下基础。</p>
<h2 id="2-虚假消息检测研究现状"><a href="#2-虚假消息检测研究现状" class="headerlink" title="2  虚假消息检测研究现状"></a>2  虚假消息检测研究现状</h2><p>  虚假消息具有传播快、影响广、危害大的特点，微博和Twitter上每天以数亿计增长的消息中有大量是虚假的，而虚假消息的泛滥对群众的影响非常大，造成的舆论影响会影响社会治安并使网络暴力更为频繁<sup>[8],<a href="http://www.cqvip.com/qk/94832x/201802/674500313.html">9</a></sup>。国内外均展开了一系列针对虚假消息自动检测的研究，以下主要从基于消息内容的方法、基于社交背景的方法和基于传播结构的方法进行综述。其中，消息内容的方法可以分为文本和图像单模态及多模态融合的方法，社交背景的方法可以分为融合用户背景的方法和融合外部知识的方法，传播结构的方法可以分为基于图结构和基于树结构以及基于时间序列的方法。</p>
<h3 id="2-1-基于消息内容的方法"><a href="#2-1-基于消息内容的方法" class="headerlink" title="2.1  基于消息内容的方法"></a>2.1  基于消息内容的方法</h3><p>  首先，由于文本是消息内容最基本的组成部分，早期的虚假消息检测研究采用最直接的方法，从消息内容本身入手，对消息的文本内容特征进行提取和建模以鉴定消息内容的真假。Ma等人<sup><a href="https://ink.library.smu.edu.sg/sis_research/4630/">10</a></sup>通过建立基于循环神经网络（Rurrent Neural Network，RNN）及其变体即长短期记忆（Long Short Term Memory，LSTM）和门控循环单元（Gated Recurrent Unit，GRU）共三种不同结构模型如图1所示，利用深度学习的方式提取消息的文本特征并使用多个隐藏层，相比于依赖特征工程的方法有了更强的泛化能力。然而经过训练的RNN模型在两个连续的文本输入间产生的循环转移矩阵是固定不变的，在动态和复杂的场景下并不适用，Feng等人<sup><a href="https://www.ijcai.org/proceedings/2017/0545.pdf">11</a></sup>利用卷积神经网络（Convolutional Neural Network, CNN）的卷积结构和池化操作灵活提取分散在文本序列中的关键特征。</p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/fakenews/图片1.jpg" alt="图1 采用三种不同结构RNN模型的检测框架"></p>
<center><font size="2">图1 采用三种不同结构RNN模型的检测框架</font></center>

<p>  其次，消息内容除了文本，还包括图片等视觉信息。正如我们平时所见到的，大部分虚假消息会附有经过伪造处理的图片。CNN通常只能提取图片的像素级特征，然而现有的造假技术已经可以更改图像的语义信息，从而无法进行图像真假的判断。经过修图处理的图像经过频域分析后可以发现与原始图像有显著差别<sup><a href="https://ieeexplore.ieee.org/abstract/document/8970940/">12</a></sup>，具有误导性的图像通常比真实的图像具有更重的压缩伪影。</p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/fakenews/图片2.png" alt="图2 多模态虚假消息检测方法总体框架"></p>
<center><font size="2">图2 多模态虚假消息检测方法总体框架</font></center>

<p>  另一方面，依靠单一的文本或图像进行检测并不完善，因为大量的消息以文和、图片混合的形式存在，将文本特征和视觉特征混合建模的方法能够进一步提高分类器的性能。基于将文本信息和视觉信息拼接的方法，Singhal等人<sup><a href="https://ieeexplore.ieee.org/abstract/document/8919302/">13</a>,<a href="https://ojs.aaai.org/index.php/AAAI/article/view/7230">14</a></sup>提出分别利用预训练的模型对文本信息和视觉信息进行特征提取，然后拼接融合得到消息的向量表示。显式提取消息图片中的视觉实体和嵌入文字<sup><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ202107011.htm">15</a></sup>，可以得到不同语义层次的视觉特征，能够有效增强多模态融合的虚假消息检测性能。刘金硕等人<sup><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ202011007.htm">16</a></sup>设计了如图2所示的多模态虚假消息检测方法，在简单融合文本和图像特征的基础上还提取了图像内嵌的文本特征，进行串接后输入全连接层进行多模态的检测。图像和文本的匹配程度能够反映消息是否经过篡改，可以将文本信息和视觉信息同通过全连接层映射到同一向量空间<sup><a href="https://www.sciencedirect.com/science/article/pii/S0306457321001060">17</a></sup>，使用余弦相似度算法度量文本和图像之间的相似性。</p>
<h3 id="2-2-基于社交背景的方法"><a href="#2-2-基于社交背景的方法" class="headerlink" title="2.2  基于社交背景的方法"></a>2.2  基于社交背景的方法</h3><p>  虚假消息的作者仿照真实消息进行编写，基于消息内容的检测方法会受到制约，分析用户的可信度、发文历史、偏好等用户资料信息可以作为虚假消息检测的辅助评价指标，可信度高的用户更有可能发表真实的消息<sup><a href="https://dl.acm.org/doi/abs/10.1145/3404835.3462990">18</a></sup>。此外，丰富的外部知识和客观事实可以帮助模型更准确地识别虚假消息。</p>
<h4 id="2-2-1-融合用户背景"><a href="#2-2-1-融合用户背景" class="headerlink" title="2.2.1  融合用户背景"></a>2.2.1  融合用户背景</h4><p>  社会学研究表明可信度高的用户发出的消息更可能是真实的<sup><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ201909015.htm">19</a></sup>，基于用户可信度的研究对用户的基本资料、历史发文等信息进行建模作为辅助评价标准。发布虚假消息的可疑用户具有未实名认证，创建时间短，用户介绍缺失等显著特征<sup><a href="https://aclanthology.org/2020.acl-main.48.pdf">20</a></sup>。当一条假消息证实了用户现有的观念和偏好时，用户更有可能传播这条假消息<sup><a href="https://dl.acm.org/doi/abs/10.1145/3404835.3463001">21</a></sup>，在基于消息内容的基础上，添加用户的偏好表示，同时根据消息的传播情况共同进行虚假消息检测能够有效提高虚假消息检测性能。</p>
<h4 id="2-2-2-融合外部知识"><a href="#2-2-2-融合外部知识" class="headerlink" title="2.2.2  融合外部知识"></a>2.2.2  融合外部知识</h4><p>  客观事实作为虚假消息检测的重要线索在基于消息内容的检测方法中经常被被忽略，而大量外部知识包含丰富的语义信息，将注意力和图神经网络运用到虚假消息检测领域以融合外部知识可以有效提高模型学习消息内容的能力。人脑中已存在的知识含有大量语义信息，能帮助人们在查看消息时更好的理解消息内容，融合外部知识输入模型同样也能更好的理解消息内容从而提高虚假消息检测模型的性能。Li<sup><a href="https://aclanthology.org/2021.findings-acl.63.pdf">22</a></sup>等人将虚假消息检测任务分成取证和检测两部分，利用维基百科的固有知识预训练模型作为事实证据，融合消息内容和事实依据进行取证，找出对应的事实依据，然后利用事实依据对消息内容的真实性进行判断。</p>
<h3 id="2-3-基于消息传播结构的方法"><a href="#2-3-基于消息传播结构的方法" class="headerlink" title="2.3  基于消息传播结构的方法"></a>2.3  基于消息传播结构的方法</h3><p>  消息传播主要通过用户的转发来实现，用户对收到的消息进行层级转发构成了消息传播的复杂结构，根据消息在层级转发过程中的相互关系来判断消息的真实性。基于消息内容的检测方法忽略了消息在层级传播过程中的树形结构这一重要特征。然而树结构无法表示相同层级转发的消息之间的联系，图结构使用顶点和边的表示更好的建模了消息在广度和深度上的传播，图结构比树结构拥有更复杂的拓扑结构。下面介绍分别从基于树结构和图结构的虚假消息检测方法。</p>
<h4 id="2-3-1-树结构"><a href="#2-3-1-树结构" class="headerlink" title="2.3.1  树结构"></a>2.3.1  树结构</h4><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/fakenews/图片3.png" alt="图3 自底向上和自顶向下两种树形结构模型"></p>
<center><font size="2">图3 自底向上和自顶向下两种树形结构模型</font></center>

<p>  基于递归神经网络（Recursive Neural networks，RvNN），Ma等人<sup><a href="https://aclanthology.org/P18-1184/">23</a></sup>使用如图2所示的自顶向下和自底向上两种变体对消息的树形传播模式进行建模，将源消息作为根节点，对父节点消息的包含支持或反对倾向的转发与评论作为子节点。对真实消息的反对评论会引起其他人的反对，而对虚假消息的反对评论则会引起其他人的支持。从这两种不同变体的不同角度表示消息传播的树形结构，自顶向下的模型在池化层中可以有效地选择嵌入叶子节点的重要特征，信息损失更小，从而拥有更好的性能。<br>  将一棵树的所有节点消息全连接过度简化了用户之间的交互从而带来一定的误差，部分节点之间并没有直接的上下文关联，应当根据语境来增强表征能力<sup><a href="https://aclanthology.org/2020.coling-main.476/">24</a></sup>。在虚假消息的传播结构中，回复消息能够进一步增强被回复消息的立场，通过对比相关消息可以检测出一些不准确信息。选择性地关注相应消息增强指示性特征的表征学习，从而达到深入挖掘用户的观点的效果。</p>
<h4 id="2-3-2-图结构"><a href="#2-3-2-图结构" class="headerlink" title="2.3.2  图结构"></a>2.3.2  图结构</h4><p>  消息的传播通常是从某一用户发文作为起点，在点对点的传播中较为简单，但在现实情况下存在消息经过层层转发，部分还会修改语义信息，树的结构无法完全表示彼此之间的联系，图结构能更好的反映消息在传播过程中彼此的联系。<br>  传播和散布是虚假消息的两个关键特征，原有的例如RvNN只考虑了消息传播速度而忽视了消息的散布结构，具有一定的局限性<sup><a href="https://ojs.aaai.org/index.php/AAAI/article/view/5393">25</a></sup>。双向图卷积神经网络（Bi-Directional Graph Convolutional Networks，Bi-GCN）能够从自顶向下和自底向上两个方向发掘虚假消息的传播和散布特征，即从虚假消息传播树中的父节点到子节点学习消息的传播模式，从子节点反向到父节点学习消息的弥散模式。基于图卷积神经网络（Graph Convolutional Networks，GCN）提取子节点特征，子节点与父节点之间的融合与对比也能够增强语义信息<sup><a href="https://dl.acm.org/doi/abs/10.1145/3404835.3463001">21</a></sup>。将原始消息融合进传播过程中的其他消息，对自顶向下图和自底向上图进行池化得到两个图的信息。<br>  微博、推文和新闻文章在社交上下文中存在多种节点类型和关系类型，例如用户发发布微博，用户之间相互点赞关注等，使用同质图神经网络忽视了一部分关键的用户关系，不同文章领域、转发关系等也形成异质的信息网络。Shu等人<sup><a href="https://dl.acm.org/doi/abs/10.1145/3289600.3290994">26</a></sup>将发布、传播和关注等社交关系构建成异质信息网络，使用矩阵分解的方式获得各个消息节点的嵌入表示，进行虚假消息检测。</p>
<h2 id="3-常用数据集"><a href="#3-常用数据集" class="headerlink" title="3  常用数据集"></a>3  常用数据集</h2><p>  虚假消息检测领域关注消息本身，用户画像、关注列表等社交上下文内容以及消息在传播过程中的结构即关联信息，采用收集自不同领域不同平台具有显著差异性的数据集能够更好地构建模型。常用的数据集信息如表1所示，搜集整理自Twitter和微博平台<sup><a href="http://www.cqvip.com/qk/94832x/201802/674500313.html">9</a>,<a href="https://aclanthology.org/P17-1066/?ref=https://githubhelp.com">27</a></sup>。除此之外，FakeNewsNet提供了Buzzfeed和PolitFact的两个数据集<sup><a href="https://www.liebertpub.com/doi/abs/10.1089/big.2020.0062">28</a>，包含了消息的来源以及标题等内容属性和关注列表、粉丝列表等社会背景属性。</sup></p>
<center><font size="2">表1  常用数据集信息统计</font></center>

<div class="table-container">
<table>
<thead>
<tr>
<th>数据统计</th>
<th>Weibo</th>
<th>Twitter15</th>
<th>Twitter16</th>
</tr>
</thead>
<tbody>
<tr>
<td>原始推文数量</td>
<td>4664</td>
<td>1,490</td>
<td>818</td>
</tr>
<tr>
<td>用户数量</td>
<td>2,746,818</td>
<td>276,663</td>
<td>173,487</td>
</tr>
<tr>
<td>转发数量</td>
<td>3,805,656</td>
<td>331,612</td>
<td>204,820</td>
</tr>
<tr>
<td>真实消息数量</td>
<td>2351</td>
<td>372</td>
<td>207</td>
</tr>
<tr>
<td>虚假消息数量</td>
<td>2313</td>
<td>370</td>
<td>205</td>
</tr>
<tr>
<td>单篇推文平均传播时长</td>
<td>2,460小时</td>
<td>1,337小时</td>
<td>848小时</td>
</tr>
<tr>
<td>单篇推文平均转发次数</td>
<td>816</td>
<td>223</td>
<td>251</td>
</tr>
<tr>
<td>单篇推文最多转发次数</td>
<td>59,318</td>
<td>1,768</td>
<td>2,765</td>
</tr>
<tr>
<td>单篇推文最少转发次数</td>
<td>10</td>
<td>55</td>
<td>81</td>
</tr>
</tbody>
</table>
</div>
<h2 id="4-评价指标"><a href="#4-评价指标" class="headerlink" title="4  评价指标"></a>4  评价指标</h2><p>  虚假消息检测作为二分类任务，虚假消息检测通常使用多个指标同时进行评价，常用的评价指标有准确率（Accuracy）、精准率（Precision）、召回率（Recall）和F1-score等。Accuracy较为直观，被广泛应用在各种分类任务中，对应到在虚假消息检测领域即正确识别出虚假消息或真实消息的总比例。但由于Accuracy的本身缺陷，例如正负类数量差距过大将导致准确度的判断不能正确反映事实。Precision反映了是否有大量假消息被判断成真消息，体现了模型对负样本的区分能力；Recall反映了是否有真消息被误判为假消息，体现模型对正样本的识别能力。Accuracy表示预测为正的结果占总样本的比例。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5  总结"></a>5  总结</h2><p>  本文主要对基于大量有标注数据的虚假消息检测进行了回顾，对现有的工作进行客观分析，从消息内容和传播差异等角度建模进行虚假消息检测具有各自的优点和局限性。用户在社交网络上发布消息具有数据量大、结构关系复杂等特点，如何从传播速度、传播结构等方面多层次剖析消息传播特征，进一步促进虚假消息的自动化检测识别发展是今后的一个研究热点。</p>
<h2 id="bell-参考文献"><a href="#bell-参考文献" class="headerlink" title=":bell: 参考文献"></a><span class="github-emoji"><span>🔔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f514.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 参考文献</h2><p><a href="http://cjc.ict.ac.cn/online/onlinepaper/xbl-2016327154823.pdf">1</a>    谢柏林, 蒋盛益, 周咏梅, 等. 基于把关人行为的微博虚假信息及早检测方法[J]. 计算机学报, 2016, 39(04): 730-744.<br><a href="http://edit.jeit.ac.cn/EN/article/downloadArticleFile.do?attachType=PDF&amp;id=18265">2</a>    胡长军, 许文文, 胡颖, 等. 在线社交网络信息传播研究综述[J]. 电子与信息学报, 2017, 39(04): 794-804.<br><a href="http://www.bulletin.cas.cn/zgkxyyk/ch/reader/view_abstract.aspx?file_no=20150208&amp;flag=1">3</a>    杨善林, 王佳佳, 代宝, 等. 在线社交网络用户行为研究现状与展望[J]. 中国科学院院刊, 2015, 30(02): 200-215.<br><a href="http://www.joca.cn/CN/abstract/abstract23957.shtml">4</a>    何韩森, 孙国梓. 基于特征聚合的假新闻内容检测模型[J]. 计算机应用, 2020, 40(08): 2189-2193.<br><a href="https://link.springer.com/article/10.1007/BF00994018">5</a>    Cortes C, Vapnik V. Support-vector networks [J]. Machine learning, 1995, 20(3): 273-297.<br><a href="http://library.ioz.ac.cn/bitstream/000000/10883/1/%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97%E6%A8%A1%E5%9E%8B%E5%9C%A8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.pdf">6</a>    李欣海. 随机森林模型在分类与回归分析种的应用[J]. 应用昆虫学报, 2013, 50(04): 1190-1197.<br><a href="http://www.cqvip.com/">7</a>    杨学斌, 张俊. 决策树算法及其核心技术[J]. 计算机技术与发展, 2007, 17(01): 43-46．<br>[8]    白月明. 新媒体时代虚假新闻的成因及规避探析[J]. 新闻研究导刊, 2021, 12(16): 157-159.<br><a href="http://www.cqvip.com/qk/94832x/201802/674500313.html">9</a>    段大高, 盖新新, 韩忠明, 等. 基于梯度提升决策树的微博虚假消息检测[J]. 计算机应用, 2018, 38(02): 410-414+420.<br><a href="https://ink.library.smu.edu.sg/sis_research/4630/">10</a>    Ma J, Gao W, Mitra P, et al. Detecting rumors from microblogs with recurrent neural networks [A]. Proceedings of the Twenty-Fifth International Joint Conference on Artificial Intelligence [C]. Palo Alto: AAAI Press, 2016, 3818-3824.<br><a href="https://www.ijcai.org/proceedings/2017/0545.pdf">11</a>    Yu F, Liu Q, Wu S, et al. A convolutional approach for misinformation identification [A]. Proceedings of the Twenty-Sixth International Joint Conference on Artificial Intelligence [C]. Palo Alto: AAAI Press, 2017, 3901-3907.<br><a href="https://ieeexplore.ieee.org/abstract/document/8970940/">12</a>    Qi P, Cao J, Yang T, et al. Exploiting multi-domain visual information for fake news detection [A]. 2019 IEEE International Conference on Data Mining(ICDM 2019) [C]. Piscataway: IEEE, 2019, 518-527.<br><a href="https://ieeexplore.ieee.org/abstract/document/8919302/">13</a>    Singhal S, Shah R R, Chakraborty T, et al. SpotFake: A multi-modal framework for fake news detection shivangi [A]. 2019 IEEE Fifth International Conference on Multimedia Big Data (BigMM) [C]. Piscataway: IEEE, 2019, 39-47.<br><a href="https://ojs.aaai.org/index.php/AAAI/article/view/7230">14</a>    Singhal S, Kabra A, Sharma M, et al. SpotFake+: A multimodal framework for fake news detection via transfer learning [A]. Proceedings of the AAAI Conference on Artificial Intelligence [C]. Palo Alto: AAAI Press, 2020, 13915-13916.<br><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ202107011.htm">15</a>    亓鹏, 曹娟, 盛强. 语义增强的多模态虚假新闻检测[J]. 计算机研究与发展, 2021, 58(07): 1456-1465.<br><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ202011007.htm">16</a>    刘金硕, 冯阔, Pan J, 等. MSRD: 多模态网络谣言检测方法[J]. 计算机研究与发展, 2020, 57(11): 2328-2336.<br><a href="https://www.sciencedirect.com/science/article/pii/S0306457321001060">17</a>    Xue J, Wang Y, Tian Y, et al. Detecting fake news by exploring the consistency of multimodal data [J]. Information Processing and Management, 2021, 58(5): 102610.<br><a href="https://dl.acm.org/doi/abs/10.1145/3404835.3462990">18</a>    Dou Y, Shu K, Xia C, et al. User preference-aware fake news detection [A]. Proceedings of the 44th International ACM SIGIR Conference on Research and Development in Information Retrieval [C]. New York: Association for Computing Machinery, 2021, 2051-2055.<br><a href="https://www.cnki.com.cn/Article/CJFDTotal-JFYZ201909015.htm">19</a>    刘波, 李洋, 孟青, 等. 社交媒体内容可信性分析与评价[J]. 计算机研究与发展, 2019, 56(09): 1939-1952.<br><a href="https://aclanthology.org/2020.acl-main.48.pdf">20</a>    Lu Y-J, Li C-T. GCAN: Graph-aware co-attention networks for explainable fake news detection on social media [A]. Proceedings of the 58th Annual Meeting of the Association for Computational Linguistics [C]. Stroudsburg: Association for Computational Linguistics, 2020, 505–514.<br><a href="https://dl.acm.org/doi/abs/10.1145/3404835.3463001">21</a>    He Z, Li C, Zhou F, et al. Rumor detection on social media with event augmentations [A]. Proceedings of the 44th International ACM SIGIR Conference on Research and Development in Information Retrieval [C]. New York: Association for Computing Machinery, 2021, 2020-2024.<br><a href="https://aclanthology.org/2021.findings-acl.63.pdf">22</a>    Li J, Ni S, Kao H-Y. Meet the truth: Leverage objective facts and subjective views for interpretable rumor detection [A]. Findings of the Association for Computational Linguistics [C]. Stroudsburg: Association for Computational Linguistics, 2021, 705–715.<br><a href="https://aclanthology.org/P18-1184/">23</a>    Ma J, Gao W, Wong K-F. Rumor detection on twitter with tree-structured recursive neural networks [A]. Proceedings of the 56th Annual Meeting of the Association for Computational Linguistics [C]. Stroudsburg: Association for Computational Linguistics, 2018, 1980–1989.<br><a href="https://aclanthology.org/2020.coling-main.476/">24</a>    Ma J, Gao W. Debunking Rumors on Twitter with Tree Transformer [A]. Proceedings of the 28th International Conference on Computational Linguistics [C]. Barcelona: International Committee on Computational Linguistics, 2020, 5455–5466.<br><a href="https://ojs.aaai.org/index.php/AAAI/article/view/5393">25</a>    Bian T, Xiao X, Xu T, et al. Rumor detection on social media with bi-directional graph convolutional networks [A]. Proceedings of the 34th AAAI Conference on Artificial Intelligence [C]. Palo Alto: AAAI Press, 2020, 549-556.<br><a href="https://dl.acm.org/doi/abs/10.1145/3289600.3290994">26</a>    Shu K, Wang S, Liu H. Beyond news contents: The role of social context for fake news detection [A]. Proceedings of the Twelfth ACM International Conference on Web Search and Data Mining [C]. Stroudsburg: Association for Computing Machinery, 2019, 312-320.<br><a href="https://aclanthology.org/P17-1066/?ref=https://githubhelp.com">27</a>    Ma J, Gao W, Wong K-F. Detect rumors in microblog posts using propagation structure via kernel learning [A]. Proceedings of the 55th Annual Meeting of the Association for Computational Linguistics [C]. Stroudsburg: Association for Computational Linguistics, 2017, 708-717.<br><a href="https://www.liebertpub.com/doi/abs/10.1089/big.2020.0062">28</a>    Shu K, Mahudeswaran D, Wang S, et al. Fakenewsnet: A data repository with news content, social context, and spatiotemporal information for studying fake news on social media [J]. Big data, 2020, 8(3): 171-188.</p>
<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<blockquote>
<p>最后修改于 2022/07/12<br>本文是本科毕业论文的综述，受字数、中外文献比例等限制，和最初的写的有较大差异，和最终实验及论文内容也有较大差异，有空就改改，没空就作罢，论文未投搞状态暂不放出。</p>
</blockquote>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Literature review</category>
      </categories>
      <tags>
        <tag>Fake news</tag>
        <tag>NLP</tag>
      </tags>
  </entry>
  <entry>
    <title>Git常用操作</title>
    <url>/2021/03/25/Git%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>🐳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>总结Git日常基本操作，不定时添加一些遇到的问题，以及从小白入门连接本地git和github等<br><span class="github-emoji"><span>🔔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f514.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>默认已有Github或Gitee等账号,已下载安装git</p>
<ul>
<li><p><a href="#LocalGit">本地<span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Git配置</a></p>
<blockquote>
<p><a href="#UserInfo"><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>配置用户信息</a></p>
<p><a href="#SSH"><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>生成SSH Key</a></p>
</blockquote>
</li>
<li><p><a href="#UploadRepo">Upload repositories from <span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>to<span class="github-emoji"><span>☁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></a></p>
</li>
<li><p><a href="#CloneRepo">Clone repositories from <span class="github-emoji"><span>☁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>to<span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></a></p>
</li>
<li><p><a href="#GitBasic"><span class="github-emoji"><span>📘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Git基本指令汇总</a></p>
</li>
</ul>
<span id="more"></span>
<hr>
<h2 id="LocalGit">一、本地Git配置</h2>

<h3 id="UserInfo">1.1配置用户信息</h3>

<ul>
<li>Git bash here<br>  <code>$ git config --global user.name "boom1999"</code><br>  <code>$ git config --global user.email "lingzhicheng@zjut.edu.cn"</code><br>  <code>$ git config --list</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/UserInfo.png" alt="UserInfo"></p>
<h3 id="SSH">1.2生成SSH Key</h3>

<ul>
<li>Git bash here<br>  <code>$ ssh-keygen -t rsa -C "lingzhicheng@zjut.edu.cn"</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/SSHKey.png" alt="SSHKey"></p>
<ul>
<li>添加SSH Key<blockquote>
<p>将提示位置(/c/Users/xxx/.ssh/id_rsa)的公钥（id_rsa.pub）内容复制粘贴至github &gt; setting &gt; SSH and GPG keys&gt; key<br>注意不要弄混公钥和私钥<br>若只在某一个Repo中使用，可在此Repo中setting &gt; Deploy Keys中添加公钥</p>
</blockquote>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/DeployKeys.png" alt="DeployKeys"></p>
<h2 id="UploadRepo">二、从本地上传Repositories</h2>

<h3 id="memo-本地创建Repo"><a href="#memo-本地创建Repo" class="headerlink" title=":memo:本地创建Repo"></a><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>本地创建Repo</h3><ul>
<li>新建目录/选择目录</li>
<li>Git bash here 进入命令行操作<blockquote>
<p>新建文件<br>  <code>$ mkdir 文件名</code><br>进入文件夹<br>  <code>$ cd 文件名</code></p>
</blockquote>
</li>
<li>初始化git仓库<br>  <code>$ git init</code></li>
<li>查看文件内容检查是否配置成功<br>  <code>$ ls -la</code></li>
</ul>
<blockquote>
<p>至此git仓库初始化结束，默认叫master分支</p>
</blockquote>
<ul>
<li>新建测试（dev）分支<br>  <code>$ git checkout -b dev</code></li>
<li>检查git状态<br>  <code>$ git status</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitInit.png" alt="GitInit"></p>
<ul>
<li>使用编辑器在文件夹中编辑内容，测试和执行</li>
<li>提交文件至缓存区(用<code>git add .</code>提交目录下所有文件)<br>  <code>$ git add index.md</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitAdd.png" alt="GitAdd"></p>
<ul>
<li>撤销缓存内容<br>  <code>$ git rm --cached index.md</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitRm.png" alt="GitRm"></p>
<ul>
<li>发布版本<br>  <code>$ git commit -m 'This is a commit.'</code></li>
<li>查看版本日志（—graph）<br>  <code>$ git log</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitCommit.png" alt="GitCommit"></p>
<ul>
<li>将测试分支合并到主分支<blockquote>
<p>切换回主分支<br>  <code>$ git checkout master</code><br>执行合并操作<br>  <code>$ git merge dev</code><br>删除dev分支<br>  <code>$ git branch -d dev</code></p>
</blockquote>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitMerge.png" alt="GitMerge"></p>
<h3 id="computer-Repo上传"><a href="#computer-Repo上传" class="headerlink" title=":computer:Repo上传"></a><span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Repo上传</h3><ul>
<li>在Github上新建项目，复制生成项目对应的SSH地址</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitDemo.png" alt="GitDemo"></p>
<p><code>$ git remote add origin git@github.com:boom1999/gitdemo.git</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitDemoUpload.png" alt="GitDemoUpload"></p>
<ul>
<li>第一次推送本地分支(+u将本地和远程分支关联)<br>  <code>$ git push -u origin master</code></li>
<li>以后推送本地分支<br>  <code>$ git push origin master</code></li>
<li>推送其他分支（如dev）<br>  <code>$ git push origin dev</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Git/GitRemote.png" alt="GitRemote"></p>
<blockquote>
<p>若有提示👇，请参照上文配置SSH Keys</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ERROR: Permission to boom1999/gitdemo.git denied to deploy key</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></tbody></table></figure>
<h2 id="CloneRepo">三、从远程clone Repositories到本地</h2>

<ul>
<li>这是第二种方式，即现在GitHub上创建项目，或从已有的项目clone到另一台机器。</li>
<li>在Github上新建项目，复制生成项目对应的SSH地址<br><code>$ git clone git@github.com:boom1999/gitdemo.git</code><br><code>$ cd gitdemo</code><br><code>$ ls -la</code></li>
</ul>
<h2 id="GitBasic">四、Git基本指令汇总</h2>

<ul>
<li>配置全局个人信息</li>
</ul>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">git config --global user.name "your user name"    </span><br><span class="line">git config --global user.email "your email address"</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><span class="github-emoji"><span>🎯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3af.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>More</li>
</ul>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">git config --list       //显示所有配置列表</span><br><span class="line">ls                      //显示目录下可见文件 </span><br><span class="line">ls -la                  //显示当前目录所有文件包括隐藏文件</span><br><span class="line">ls | grep *.js          //通过管道筛选所有js文件</span><br><span class="line">git init                //初始化git仓库 </span><br><span class="line">git add                 //添加该文件到暂存区 </span><br><span class="line">git status              //查看当前状态</span><br><span class="line">git rm --cached         //从暂存区移除到工作区 </span><br><span class="line">git add .               //添加所有的文件到暂存区 </span><br><span class="line">git commit . -m ""      //将缓存区的内容提交到历史区("-m"表示不跳到另一个页面)  </span><br><span class="line">git commit .            //添加所有文件到历史区 </span><br><span class="line">git checkout            //将工作区的修改撤销；取回暂存区的文件 </span><br><span class="line">git status -s           //查看哪些文件被更改过 </span><br><span class="line">git log                 //查看提交历史 </span><br><span class="line">git diff                //查看工作区和暂存区文件的区别 </span><br><span class="line">git diff --cached       //查看暂存区和历史区的区别 </span><br><span class="line">git diff HEAD           //查看工作区与上一个版本的不同（更改文件后不提交到历史区可用该命令查看）  </span><br><span class="line">git log --oneline       //提交显示到一行 </span><br><span class="line">git log --graph         //图形化显示提交的 </span><br><span class="line">git reset --hard HEAD^  //所有文件回到上一个版本 </span><br><span class="line">git reflog              //查看所有的提交 </span><br><span class="line">git reset --hard xxxxxx //回到指定版本(前5/6位版本号即可) </span><br><span class="line">git log --oneline --grep="project"      </span><br><span class="line">                        //查找文件中带有project的文件并显示到一行 </span><br><span class="line">git reset --mixed HEAD^ //暂存区和历史区回到上一个版本，工作区不变 </span><br></pre></td></tr></tbody></table></figure>
<!-- markdownlint-disable-file MD025 MD028 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>Learning GFS - Google File System</title>
    <url>/2024/05/05/Google%20File%20System/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 博客系统的Graphviz支持</p>
<ul>
<li>GFS是Google在2003年前后创建的可扩展分布式文件系统 ，用来满足 Google 不断扩展的数据处理需求。GFS 为大型网络和连接的节点提供容错、可靠性、可扩展性、可用性和性能。<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
</ul>
<span id="more"></span>
<p><img src="https://www.lingzhicheng.cn/usr/file/picture/MIT/GFS01.jpg" alt="GFS structure"></p>
<ol>
<li><code>Client</code>将file name和byte offset转换为chunk index，向<code>Master</code>发送包含file name和chunk index的请求，<code>Master</code>返回相应的chunk handle和chunk locations。（<code>Client</code>使用file name和chunk index作为key缓存这些信息）</li>
<li><code>Client</code>向其中一个replica（最近的一个）发送请求，请求内容有chunk handle和byte range（在<code>Client</code>的缓存过期之前，不用再和<code>Master</code>进行交互）</li>
<li>特别的，<code>Client</code>通常会在同一个请求中请求多个块数据</li>
</ol>
<h2 id="In-paper"><a href="#In-paper" class="headerlink" title="In paper"></a>In paper</h2><h3 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h3><ul>
<li><p>Original Paper Links: <a href="https://pdos.csail.mit.edu/6.824/papers/gfs.pdf">The Google File System</a></p>
</li>
<li><p>The file and chunk namespaces</p>
</li>
<li>The mapping from files to chunks</li>
<li>The locations of each chunk’s replicas<br>都存在主内存里（可以快速实现周期性扫描，以实现GC、故障备份迁移、负载均衡等功能）；<br>命名空间和映射也存储在<code>Master</code>的本地磁盘和remote备份的操作日志中，以实现持久化；<br><code>Master</code>不会持久化locations，而是在启动的时候询问每个chunkserver，然后保持最新状态（比持久化在<code>Master</code>中要方便，因为大量chunkserver的join、leave、crush等问题将影响chunkserver和<code>Master</code>状态的同步）（或者说chunkserver对他自己磁盘上的存储内容拥有决定权，而不应该在<code>Master</code>上维护）。</li>
</ul>
<h3 id="Big-storage-Why-hard"><a href="#Big-storage-Why-hard" class="headerlink" title="Big storage (Why hard?)"></a>Big storage (Why hard?)</h3><ol>
<li>最初的述求：Performance性能</li>
<li>Sharding分片：将数据分割放到大量的服务器上，这样就可以并行的从多台服务器读取数据</li>
<li>发生故障需要容错，fault tolerance自动化修复</li>
<li>复制副本replication</li>
<li>副本的一致性问题inconsistency，额外的操作，导致性能降低</li>
</ol>
<h3 id="Bad-design-for-strong-consistency"><a href="#Bad-design-for-strong-consistency" class="headerlink" title="Bad design for strong consistency"></a>Bad design for strong consistency</h3><p>两个replication之间的write可能不同<br><img src="https://www.lingzhicheng.cn/usr/file/picture/MIT/GFS02.png" alt="Bad design"></p>
<p>3.4 GFS goal</p>
<ul>
<li>Big, Fast<ul>
<li>大容量和快速</li>
</ul>
</li>
<li>Global<ul>
<li>可以通过申请权限来查看已有的数据</li>
</ul>
</li>
<li>Sharding<ul>
<li>分片存储</li>
</ul>
</li>
<li>Automatic recovery<ul>
<li>故障的自动回复</li>
</ul>
</li>
<li>Single data center<ul>
<li>并不是一个目标，是设计成了单个数据中心</li>
</ul>
</li>
<li>Internal use<ul>
<li>google内部使用，并未完全开放（部分服务对外）</li>
</ul>
</li>
<li>Big sequential access<ul>
<li>针对的是大型文件的存储，所以是顺序的，并不像小型的随机访问存储</li>
</ul>
</li>
</ul>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a><code>Master</code> Node</h3><ul>
<li><code>Master</code> server存储文件和chunk server的信息，chunk server真正存储数据</li>
<li>存储两个表单（内存里）：<ul>
<li>第一个是文件名到Chunk ID或者Chunk Handle数组的对应。NV（non-volatile, 非易失），这个标记表示对应的数据会写入到磁盘上。</li>
<li>第二个表单记录了Chunk ID到Chunk数据的对应关系。这里的数据又包括了：<ul>
<li>每个Chunk存储在哪些服务器上，所以这部分是Chunk服务器的列表（V）</li>
<li>每个Chunk当前的版本号，所以<code>Master</code>节点必须记住每个Chunk对应的版本号。（NV）</li>
<li>所有对于Chunk的写操作都必须在主Chunk（Primary Chunk）上顺序处理，主Chunk是Chunk的多个副本之一。所以，<code>Master</code>节点必须记住哪个Chunk服务器持有主Chunk。（V）</li>
<li>并且，主Chunk只能在特定的租约时间内担任主Chunk，所以，<code>Master</code>节点要记住主Chunk的租约过期时间。（V）</li>
</ul>
</li>
</ul>
</li>
<li>在磁盘上存Log、Check Point；写同时写内存和磁盘，读只从内存里</li>
<li>为什么用Log而不是database？<ul>
<li>在磁盘中维护log而不是数据库的原因是：数据库本质上来说是某种B树（b-tree）或者hash table，相比之下，追加log会非常的高效，因为你可以将最近的多个log记录一次性的写入磁盘。因为这些数据都是向同一个地址追加，这样只需要等待磁盘的磁碟旋转一次。而对于B树来说，每一份数据都需要在磁盘中随机找个位置写入。所以使用Log可以使得磁盘写入更快一些。</li>
</ul>
</li>
<li>当<code>Master</code>节点故障重启，并重建它的状态，你不会想要从log的最开始重建状态，因为log的最开始可能是几年之前，所以<code>Master</code>节点会在磁盘中创建一些checkpoint点，这可能要花费几秒甚至一分钟。这样<code>Master</code>节点重启时，会从log中的最近一个checkpoint开始恢复，再逐条执行从Checkpoint开始的log，最后恢复自己的状态。</li>
</ul>
<h3 id="Read-File"><a href="#Read-File" class="headerlink" title="Read File"></a>Read File</h3><ol>
<li><code>Client</code>将offset（相较于文件头部的偏移位置，读取部分文件）和file name发给<code>Master</code></li>
<li><code>Master</code>从file表单中查找文件名，得到chunk ID的数组，再除以64MB得到对应的chunk ID，再从Chunk表单中找服务器列表，响应给<code>Client</code></li>
<li><code>Client</code>从这些Chunk（Google的数据中心中，IP地址是连续的，所以可以从IP地址的差异判断网络位置的远近）服务器中挑选一个最近的来读取数据，并将读请求发送到那个服务器。因为客户端每次可能只读取1MB或者64KB数据，所以<code>Client</code>可能会连续多次读取同一个Chunk的不同位置。所以<code>Client</code>会缓存Chunk和服务器的对应关系，这样，当再次读取相同Chunk数据时，就不用一次次的去向<code>Master</code>请求相同的信息。</li>
<li><code>Client</code>与选出的服务器通信，将Chunk Handle和偏移量发送给那个服务器。Chunk服务器会在本地的硬盘上，将每个Chunk存储成独立的Linux文件，并通过普通的Linux文件系统管理。并且可以推测，Chunk文件会按照Handle（也就是ID）命名。所以，Chunk服务器需要做的就是根据文件名找到对应的Chunk文件，之后从文件中读取对应的数据段，并将数据返回给客户端。</li>
</ol>
<h3 id="Write-File"><a href="#Write-File" class="headerlink" title="Write File"></a>Write File</h3><p>Read是从随机的最新副本读取，而Write是必须写到Primary chunk，但是有可能主副本不存在，这时<code>Master</code>会找出所有存有Chunk最新副本的Chunk服务器，挑出一个作为Primary，其他的作为Secondary，然后增加版本号，同时也写入磁盘。（最新版本号是NV的，所以服务器宕机后可以从磁盘中恢复过来）。然后<code>Master</code>会将这些信息给对应的服务器，包括新的版本号，服务器也会把版本号存在磁盘里。</p>
<ul>
<li>为什么不用最大的版本号当作最新的？<ul>
<li>当<code>Master</code>重启时，无论如何都需要与所有的Chunk服务器进行通信，因为<code>Master</code>需要确定哪个Chunk服务器存了哪个Chunk。你可能会想到，<code>Master</code>可以将所有Chunk服务器上的Chunk版本号汇总，找出里面的最大值作为最新的版本号。如果所有持有Chunk的服务器都响应了，那么这种方法是没有问题的。但是存在一种风险，当<code>Master</code>节点重启时，可能部分Chunk服务器离线或者失联或者自己也在重启，从而不能响应<code>Master</code>节点的请求。所以，<code>Master</code>节点可能只能获取到持有旧副本的Chunk服务器的响应，而持有最新副本的Chunk服务器还没有完成重启，或者还是离线状态（这个时候<code>Master</code>能找到的Chunk最大版本明显不对）。</li>
</ul>
</li>
<li>如果找不到最新版本号的chunk会怎么样？<br><code>Master</code>节点会定期与Chunk服务器交互来查询它们持有什么样版本的Chunk。有两种可能：要么<code>Master</code>会等待，并不响应客户端的请求；要么会返回给客户端说，我现在还不知道Chunk在哪，过会再重试吧。比如说机房电源故障了，所有的服务器都崩溃了，我们正在缓慢的重启。<code>Master</code>节点和一些Chunk服务器可能可以先启动起来，一些Chunk服务器可能要5分钟以后才能重启，这种场景下，我们需要等待，甚至可能是永远等待，因为你不会想使用Chunk的旧数据。所以，总的来说，在重启时，因为<code>Master</code>从磁盘存储的数据知道Chunk对应的最新版本，<code>Master</code>节点会整合具有最新版本Chunk的服务器。每个Chunk服务器会记住本地存储Chunk对应的版本号，当Chunk服务器向<code>Master</code>汇报时，就可以说，我有这个Chunk的这个版本。而<code>Master</code>节点就可以忽略哪些版本号与已知版本不匹配的Chunk服务器。</li>
<li>如果chunk的版本号大于<code>Master</code>的版本号怎么办？<ul>
<li><code>Master</code>在向磁盘写入版本号前崩溃了，但分配了新的Primary，会用这个更高的版本号作为最新版本号。可能是因为发送消息后崩溃了，所以最好让pri和sec返回确认消息之后再写入磁盘。</li>
</ul>
</li>
<li>Primary如果同时收到大量<code>Client</code>的并发请求，会排序请求。确定Primary和Secondary chunk后，<code>Client</code>将数据发送给这些服务器，收到后写入临时位置，所有服务器都返回确认后，<code>Client</code>再向Primary发送确认追加请求，然后分发请求。</li>
<li>对于Secondary chunk来说，不一定会执行成功，可能因为磁盘不足或者故障或者丢包；只有所有chunk都写入成功才会返回yes给<code>Client</code>；否则将返回no然后重新发起整个流程。</li>
<li>什么时候版本号会改变？<ul>
<li>只在<code>Master</code>认为Chunk没有Primary时才会增加。</li>
</ul>
</li>
<li><code>Master</code>发现Primary挂了怎么办？<ul>
<li><code>Master</code>会定期Ping Primary，没有响应认为将要重新指定一个Primary（但这不一定对，可能只是因为没有Ping通而不是挂了），这将导致Primary还可以和<code>Client</code>通信，此时指定新的Primary将同时存在两个，导致脑裂（split-brain）</li>
<li>解决方案是使用租约，租约到期后更新Primary，若Ping不通，将不会重新指定Primary，而是等待上一个租约到期</li>
</ul>
</li>
</ul>
<h3 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h3><ol>
<li>第一个<code>Client</code>对三个副本追加数据A</li>
<li>第二个<code>Client</code>追加数据B，P和S1成功了，S2失败</li>
<li>第三个<code>Client</code>追加数据C</li>
<li>第二个<code>Client</code>重试追加B，成功了</li>
<li>第四个<code>Client</code>追加D，但是S1失败了，并且<code>Client</code>再重试成功前发送故障，导致S1中将不存在D<br><img src="https://www.lingzhicheng.cn/usr/file/picture/MIT/GFS03.png" alt="GFS Consistency"></li>
</ol>
<ul>
<li>在这里的GFS是弱一致性的，副本是不一致的，没有做到精确同步；并且根据偏移量然后执行追加数据的请求，这样就可以实现并行（当然也可以撤销所有部分成功的操作，这导致更复杂且更慢，需要平衡性能）</li>
<li>缺陷：<ul>
<li>用内存来维护Chunk表单，随着应用越来越多，尽管可以增加内存，但迟早消耗完</li>
<li>单<code>Master</code>节点可能来不及处理非常高的并发请求，并且其还要承担一些写入磁盘的任务</li>
<li><code>Master</code>节点的故障处理是人工干预的，需要自修复才比较好</li>
</ul>
</li>
</ul>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Distributed Systems</tag>
        <tag>GFS</tag>
      </tags>
  </entry>
  <entry>
    <title>博客增加Graphviz支持</title>
    <url>/2024/04/20/Graphviz%20on%20Hexo/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 博客系统的Graphviz支持</p>
<ul>
<li><a href="https://graphviz.org">Graphviz（Graph Visualization Software）</a>是一个开源的图形可视化软件，用DOT描述语言来定义图形，让用户专注于内容而忽略布局的设计</li>
<li>在先前的博客中，图片可以用对象存储在云端，而简单的结构图也如此未必太过复杂，因此想到用Graphviz来绘制简单的图结构。在本地的Vscode或者Typora中已经内嵌了Graphviz的渲染，标记代码块为<code>graphviz</code>即可，但在博客中没有，两端存在差异化，这篇用于解决这个问题。<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
</ul>
<span id="more"></span>
<h2 id="添加支持"><a href="#添加支持" class="headerlink" title="添加支持"></a>添加支持</h2><h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><ul>
<li>Win/Mac/Linux<ul>
<li><a href="https://graphviz.org/download/">Graphviz Download</a>，主流系统内的使用也比较简单，可以直接安装，不再赘述</li>
</ul>
</li>
<li><p>Blog System</p>
<ul>
<li><p>安装插件<code>hexo-graphviz</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">yarn add hexo-graphviz   <span class="comment"># 通过yarn安装</span></span><br><span class="line">npm install hexo-graphviz --save <span class="comment"># 通过npm安装</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>模板增加相应的js代码，目录为<code>{blogRoot}/themes/{themeName}/layout/_partial/after-fotter.ejs</code></p>
<figure class="highlight js"><table><tbody><tr><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> (theme.<span class="property">graphviz</span>.<span class="property">enable</span>) { %&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'https://cdnjs.cloudflare.com/ajax/libs/viz.js/1.7.1/viz.js'</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">replaceAll</span> = <span class="keyword">function</span>(<span class="params">search, replacement</span>) {</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">var</span> target = <span class="variable language_">this</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> target.<span class="title function_">split</span>(search).<span class="title function_">join</span>(replacement);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        };</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">let</span> vizObjects = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.graphviz'</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> vizObjects) {</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">let</span> svg = <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">try</span> {</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                svg = <span class="title class_">Viz</span>(item.<span class="property">textContent</span>.<span class="title function_">replaceAll</span>(<span class="string">'–'</span>, <span class="string">'--'</span>), <span class="string">'svg'</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            } <span class="keyword">catch</span>(e) {</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                svg = <span class="string">`&lt;pre class="error"&gt;<span class="subst">${e}</span>&lt;/pre&gt;`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            }</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        item.<span class="property">outerHTML</span> = svg</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        }</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;% } %&gt;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>添加启动选项（Theme配置下的<code>_config.yml</code>）</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># hexo-graphviz</span></span><br><span class="line"><span class="attr">graphviz:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>注意：可能在安装过程中npm自动升级了，导致之前配置的Nunjucks模板标签又和Markdown的部分标签冲突了，需要重新解决，详细见之前写的<a href="https://www.lingzhicheng.cn/2021/08/26/NunjucksErrors/">Nunjucks Errors</a>的解决方案3。</p>
</li>
</ul>
</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ul>
<li><p>详细的可以查看<a href="https://graphviz.org">Graphviz的文档</a></p>
</li>
<li><p>简单的有向图</p>
  <div><div class="graphviz">    digraph G {
      A -&gt; B;
      B -&gt; C;
      C -&gt; D;
      D -&gt; A;
  }</div></div>
</li>
<li><p>带节点标签和边标签的有向图</p>
  <div><div class="graphviz">    digraph G {
      A [label="Start"];
      B [label="Middle"];
      C [label="End"];

      A -&gt; B [label="Step 1"];
      B -&gt; C [label="Step 2"];
  }</div></div>
</li>
<li><p>带颜色和形状的无向图</p>
  <div><div class="graphviz">    graph G {
      A [shape=circle, color=red, fillcolor=lightblue, style=filled];
      B [shape=square, color=blue];
      C [shape=diamond, color=green];

      A -- B;
      B -- C;
      C -- A;
      A -- D -- E;
  }</div></div>
</li>
<li><p>二叉树</p>
  <div><div class="graphviz">    digraph G {
      bgcolor="beige"
      node [shape="record", height=.1]
      node0[label="<f0> | <f1> A | <f2>"]
      node1[label="<f0> | <f1> B | <f2>"]
      node2[label="<f0> | <f1> C | <f2>"]
      node0:f0 -&gt; node1:f1
      node0:f2 -&gt; node2:f1
  }</f2></f1></f0></f2></f1></f0></f2></f1></f0></div></div>
</li>
<li><p>大括号子图</p>
  <div><div class="graphviz">    graph G {
      "数据结构三要素" -- {"数据的逻辑结构", "数据的存储结构", "数据的运算"}
  }</div></div>
</li>
<li><p>总示例</p>
  <div><div class="graphviz">    digraph G {
      label=&lt;<b>Graphviz基本组成结构</b>&gt;;
      labelloc=top;   // 标题位置
      bgcolor=transparent; // 背景透明

      node[shape=box];  // 结点形状为方形
      //edge[style=bold];

      // 独立出现的为结点或属性声明, 中括号前为结点名称
      graphviz[label="Graphviz"];

      subgraph{
          layout[label="Layouts"];
          script[label="Script Files"];
          api[label="APIs"];
          rank=same;
      }

      graphviz -&gt; layout;
      graphviz -&gt; script;
      graphviz -&gt; api;

      // 设置子图
      api -&gt; 
      subgraph{
          layout_etc[label="......"];
      }

      script -&gt;
      subgraph{
          element[label="Elements"];
          attribute[label="Attributes"];
          rank=same;
      }

      layout -&gt;
      subgraph{
          layout_dot[label="dot"];
          layout_neato[label="neato"];
      }

      element -&gt;
      subgraph{
          ele_graph[label="Graph"];
          ele_node[label="Node"];
          ele_edge[label="Edge"];
      }
  }</div></div>

</li>
</ul>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Graphviz</tag>
      </tags>
  </entry>
  <entry>
    <title>HDB3 Decode And Endecode System</title>
    <url>/2021/09/30/HDB3%E7%BC%96%E8%A7%A3%E7%A0%81%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>HDB3编解码系统，由Verilog HDL实现QuartusⅡ和Modelsim联合进行功能仿真，在FPGA芯片实测。</li>
<li>整体功能模块时序逻辑都比较简单，没有进行时序仿真，直接上FPGA实测，基本没有大问题。</li>
<li>FPGA主芯片采用ALTREA EP2C8T144C8N，故需要使用QuartusⅡ13.0及以下版本，否则无法使用芯片库，可用采用多版本共存方式，Altera允许多个版本同时使用，并且有清除的版本区分。</li>
<li>数模转换 D/A ：实现数字模拟转换功能，将数字信号采集变成模拟信号输出，使用National Semiconductor DAC 0832</li>
<li>模数转换 A/D ：实现模拟数字转换功能，将模拟信号采集后变成数字信号输出，使用Maxim Integrated ADC MAX7820</li>
<li>整体包括分频器设计、M 序列设计、映射表设计、编码电路设计、D/A 转换设计、A/D 采样设计、 位同步设计、解码电路设计、编解码系统总体电路设计。<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f564.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<h2 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h2><ul>
<li>HDB3码为三阶高密度双极性码，是AMI码的一种改进型，保持了AMI的优点而克服了其的缺点，使连“0”个数不超过三个；</li>
<li>编码规则如下：<ul>
<li>i.先检查消息码的连“0”个数。当连“0”数目小于等于3时，则于AMI码的编码规则一样。</li>
<li>ii.当连“0”数目超过3个时，则将每4个连“0”化作一小节，用“000V”替代。（V取值+1或-1）应与其前一个相邻的非“0”脉冲的极性相同（因为这破坏了极性交替的规则，所以V称为破坏脉冲）。</li>
<li>iii.相邻的V码极性必须交替。当V码取值能满足之前的条件时但不能满足此要求时，则将“0000”用“B00V”替代。B的取值与后面的V脉冲一致，用于解决此问题。因此，B称为调节脉冲。</li>
<li>iv.V码后面的传号码极性也要交替。</li>
</ul>
</li>
<li>编码比较复杂，但解码却比较简单，从编码规则上看，每一个破坏脉冲V总是与前一非“0”脉冲同极性（包括B在内），也就是说从收到的符号序列中可以容易地找到破坏点V，于是也判定V符号以及前面的三个符号必是连“0”符号，从而恢复4个连“0”码，再将所有-1变成+1后便得到原始消息码。</li>
<li>m序列是最长线性反馈移位寄存器序列的简称。它是由线性反馈的移存器产生的周期最长的序列。在这种反馈移存器中避免出现全“0”状态，否则移存器的状态将不会改变，n级移存器共有 种可能的状态，除去全“0”状态外，还有 状态可用。产生m序列的充要条件就是移位寄存器的特征多项式为本原多项式，可根据n阶的m序列本原多项式的反复移位来产生我们需要的m序列。</li>
</ul>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><ul>
<li>由原始的的32.768MHz时钟，经过第一次256分频用于后续的码元定时恢复，继续经过16分频产生8KHz的码元时钟，由M序列产生模块生成随机的M序列来模拟传输过程中的随机信号，根据AMI码和HDB3的编码规则对M序列进行调整，产生单极性的HDB3码，但由于存在0、+1、-1三种情况，至少需要两位数据才能存储，所以进行一次双极性变换，对应转化成八位数据，至此完成编码过程。</li>
</ul>
<h2 id="Frame-Diagram"><a href="#Frame-Diagram" class="headerlink" title="Frame Diagram"></a>Frame Diagram</h2><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/1.FrameDiagram.png" alt="Fig.1 Frame Diagram"></p>
<center><font size="2">Fig.1 Frame Diagram</font></center>

<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><h3 id="分频设计"><a href="#分频设计" class="headerlink" title="分频设计"></a>分频设计</h3><ul>
<li>even256_div模块<ul>
<li>模块even256_div的作用是将最开始的32.768MHz系统时钟进行偶数256分频，产生新的时钟信号，供给后续16分频模块使用，同时用于解码部分的码元定时恢复模块判决时钟使用。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> even256_div(clk,rst,clk_out);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> clk,rst;</span><br><span class="line"><span class="keyword">output</span> clk_out;</span><br><span class="line"><span class="keyword">reg</span> clk_out;</span><br><span class="line"><span class="keyword">reg</span>[<span class="number">7</span>:<span class="number">0</span>] count;</span><br><span class="line"><span class="comment">// 偶数分频</span></span><br><span class="line"><span class="keyword">parameter</span> N=<span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst)</span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位初始化</span></span><br><span class="line">        count&lt;=<span class="number">1'b0</span>;</span><br><span class="line">        clk_out&lt;=<span class="number">1'b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(N%<span class="number">2</span>==<span class="number">0</span>)<span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(count&lt;N/<span class="number">2</span>-<span class="number">1</span>) count &lt;=count+<span class="number">1'b1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 计数到一半，时钟翻转实现分频</span></span><br><span class="line">            count&lt;=<span class="number">1'b0</span>;</span><br><span class="line">            clk_out&lt;=~clk_out;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>even16_div模块<ul>
<li>模块even16_div的作用是将256分频输出的时钟再次进行偶数分频，得到的时钟就是用于m序列产生的码元时钟。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> even16_div(clk,rst,clk_out);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">input</span> clk,rst;</span><br><span class="line"><span class="keyword">output</span> clk_out;</span><br><span class="line"><span class="keyword">reg</span> clk_out;</span><br><span class="line"><span class="keyword">reg</span>[<span class="number">3</span>:<span class="number">0</span>] count;</span><br><span class="line"><span class="comment">// 偶数分频</span></span><br><span class="line"><span class="keyword">parameter</span> N=<span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst)</span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位初始化</span></span><br><span class="line">        count&lt;=<span class="number">1'b0</span>;</span><br><span class="line">        clk_out&lt;=<span class="number">1'b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(N%<span class="number">2</span>==<span class="number">0</span>)<span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(count&lt;N/<span class="number">2</span>-<span class="number">1</span>) count &lt;=count+<span class="number">1'b1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 计数到一半，时钟翻转实现分频</span></span><br><span class="line">            count&lt;=<span class="number">1'b0</span>;</span><br><span class="line">            clk_out&lt;=~clk_out;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="M序列设计"><a href="#M序列设计" class="headerlink" title="M序列设计"></a>M序列设计</h3><ul>
<li>m_sequence模块<ul>
<li>模块m_sequence的作用是根据7阶m序列的本原多项式，循环位移，使用16分频的码元时钟产生伪随机序列模拟基带传输信号。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> m_sequence(clk,rst,ena,data_out,load);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> clk;                        <span class="comment">//时钟信号</span></span><br><span class="line"><span class="keyword">input</span> rst;                        <span class="comment">//复位信号，低电平有效</span></span><br><span class="line"><span class="keyword">input</span> ena;                        <span class="comment">//控制信号，高电平时序列发生器开始工作</span></span><br><span class="line"><span class="keyword">output</span> data_out;</span><br><span class="line"><span class="keyword">output</span> load;                      <span class="comment">//控制信号，为高电平时表示伪随机序列开始</span></span><br><span class="line"><span class="keyword">reg</span> data_out,load;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">6</span>:<span class="number">0</span>]temp;                    <span class="comment">//7级移位寄存器产生周期为127的m序列</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">            data_out &lt;= <span class="number">0</span>;</span><br><span class="line">            load &lt;= <span class="number">1'b0</span>;            <span class="comment">//控制信号设为无效</span></span><br><span class="line">            temp &lt;= <span class="number">7'b1111_111</span>;     <span class="comment">//移位寄存器初始状态设为全1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span>                       <span class="comment">//开始产生序列信号</span></span><br><span class="line">        <span class="keyword">if</span>(ena) <span class="keyword">begin</span>                <span class="comment">//判断序列发生器的控制信号是否有效</span></span><br><span class="line">                <span class="comment">//若控制信号有效</span></span><br><span class="line">                load &lt;= <span class="number">1'b1</span>;        <span class="comment">//将控制伪随机序列产生的信号设为有效        </span></span><br><span class="line">                temp &lt;= {temp[<span class="number">5</span>:<span class="number">0</span>],temp[<span class="number">2</span>]^temp[<span class="number">6</span>]};        <span class="comment">//对应f(x)=x^7+x^3+1</span></span><br><span class="line">                <span class="comment">//当控制伪随机数列产生的信号使能时将移位寄存器的最高位做为m序列进行输出</span></span><br><span class="line">            <span class="keyword">if</span>(load)    data_out &lt;= temp[<span class="number">6</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> load &lt;= <span class="number">1'b0</span>;    <span class="comment">//若控制信号无效，则不开始产生伪随机序列</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="编码电路设计"><a href="#编码电路设计" class="headerlink" title="编码电路设计"></a>编码电路设计</h3><ul>
<li>模块add_v的作用是找到m序列中4个连续的0，并将第四个连0变成v。<ul>
<li>输入信号为“0”码和“1”码，输出信号用两位二进制数“00”“01”，“11”分别表示信号为“0”、“1”、“V”；</li>
<li>设置了一个寄存器用于存储当前码元位置处连“0”个的个数；</li>
<li>对输入信号进行判断，若输入高电平，则计数器复位，输出为“01”；若输入低电平，则将计数器加一，并判断此时计数器的值是否为“4”，若计数器的值为“4”，则表示出现四个连“0”，将该“0”信号变为“V”且计数器复位，输出为“11”，否则，输出为“00”。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> add_v(rst,data_in,data_out,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> data_in,rst,clk;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">1</span>:<span class="number">0</span>]data_out;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>]data_out;            <span class="comment">//用00、01、11分别表示输入信号为“0、1、V”</span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>]counter;               <span class="comment">//设置连0计数器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        counter &lt;= <span class="number">0</span>;</span><br><span class="line">        data_out &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">1'b1</span>) <span class="keyword">begin</span>  <span class="comment">//判断输入信号是否为1</span></span><br><span class="line">        counter &lt;= <span class="number">0</span>;                <span class="comment">//若为1则计数器复位，输出“01”</span></span><br><span class="line">        data_out &lt;= <span class="number">2'b01</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">1'b0</span>) <span class="keyword">begin</span>                        <span class="comment">//若输入信号为0，计数器+1</span></span><br><span class="line">        counter &lt;= counter + <span class="number">1</span>; </span><br><span class="line">        <span class="keyword">if</span>(counter == <span class="number">2'b11</span>) <span class="keyword">begin</span>    <span class="comment">//判断连0个数是否达到4个，因为非阻塞赋值，此时计数器值应为3时，表示出现4个连0</span></span><br><span class="line">            data_out &lt;= <span class="number">2'b11</span>;        <span class="comment">//将0的输出变为V</span></span><br><span class="line">            counter &lt;= <span class="number">0</span>;            <span class="comment">//计数器复位</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> data_out &lt;= <span class="number">2'b00</span>;       <span class="comment">//若连0数不为4，输出“00”</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>模块add_b的作用是为了保证在添加“V”码后的序列中，相邻的“V”码极性必须交替，当“V”码取值不能满足此要求时，则将“000V”用“B00V”替代。<ul>
<li>输入信号为add_v模块的输出，输出信号用两位二进制数“00”、“01”、“10”、“11”分别表示信号为“0”、“1”、“B”、“V”；</li>
<li>设置两个寄存器分别用于存储“1”码和“V”码的个数；</li>
<li>设置四位移位寄存器方便实现用“B00V”替代“000V”的功能；</li>
<li>对输入信号进行判断，若输入为“00”，将“1”码计数器加上“V”码计数器的值，并复位“V”码计数器；若输入为“01”，先将“1”码计数器加一，然后加上“V”码计数器的值，最后复位“V”码计数器；若输入为“11”，则“V”码计数器加一；</li>
<li>用“1”码计数器和“V”码计数器的值判断最终的输出信号，若输入不为“11”，则输出不变；若输入为“11”，判断此时“1”码计数器的值，当此前“1”码的个数为奇数时，输出不变，当此前“1”码的个数为偶数时，输出“10”。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> add_b(rst,data_in,data_out,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> clk,rst;</span><br><span class="line"><span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>]data_in;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">1</span>:<span class="number">0</span>]data_out;        <span class="comment">//用00、01、10、11分别表示输入信号为“0、1、B、V”</span></span><br><span class="line"><span class="keyword">reg</span> counter1;                    <span class="comment">//设置“01”的计数器</span></span><br><span class="line"><span class="keyword">reg</span> counterv;                    <span class="comment">//设置“11”的计数器</span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>]buffer[<span class="number">3</span>:<span class="number">0</span>];        <span class="comment">//取代节选择</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst) <span class="keyword">begin</span></span><br><span class="line"><span class="comment">//设置四位移位寄存器方便插“B”的实现</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        buffer[<span class="number">3</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">        buffer[<span class="number">2</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">        buffer[<span class="number">1</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">        buffer[<span class="number">0</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        buffer[<span class="number">3</span>]&lt;=buffer[<span class="number">2</span>];</span><br><span class="line">        buffer[<span class="number">2</span>]&lt;=buffer[<span class="number">1</span>];</span><br><span class="line">        buffer[<span class="number">1</span>]&lt;=buffer[<span class="number">0</span>];</span><br><span class="line">        buffer[<span class="number">0</span>]&lt;=data_in;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst) <span class="keyword">begin</span></span><br><span class="line"><span class="comment">//对输入进行判断</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        counter1 = <span class="number">0</span>;</span><br><span class="line">        counterv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">2'b11</span>) <span class="comment">//如果输入为“11”，则counterv加1</span></span><br><span class="line">        counterv &lt;= counterv + <span class="number">1'b1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">2'b01</span>) <span class="keyword">begin</span> <span class="comment">//如果输入为“01”，则counter1加1</span></span><br><span class="line">        counter1 &lt;= counter1 + <span class="number">1'b1</span> + counterv;</span><br><span class="line">        counterv &lt;= <span class="number">1'b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        counter1 &lt;= counter1 + counterv;</span><br><span class="line">        counterv &lt;= <span class="number">1'b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//若输入为“11”,如果此前1的个数为奇数，则输出不变，若为偶数，则输出“10”</span></span><br><span class="line"><span class="comment">//若输入不为“11”,则输出不变</span></span><br><span class="line"><span class="keyword">assign</span> data_out = (counter1%<span class="number">2</span> == <span class="number">0</span>) &amp;&amp; (counterv == <span class="number">1</span>)? <span class="number">2'b10</span> : buffer[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>模块polar的作用是单极性信号变为双极性信号。<ul>
<li>输入信号为add_b模块的输出，输出信号用“00”表示“0”码，用“10”表示“+1、+B、+V”码，用“01”表示“-1、-B、-V”；</li>
<li>设置极性判断标志位，当其为“1”时，表示“+1”和“-V”，当其为“0”时，表示“-1”和“+V”；</li>
<li>对输入信号进行判断，若输入为“11”（V码），利用极性判断标志位判断该码正负；若输入为“01”（1码）或者“10”（B码），利用极性判断标志位判断该码正负，同时将极性判断标志位翻转；若输入为“00”（0码），则输出为“00”。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> polar(rst,data_in,data_outP,data_outN,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>]data_in;</span><br><span class="line"><span class="keyword">input</span> rst,clk;</span><br><span class="line"><span class="keyword">output</span> data_outP,data_outN;    <span class="comment">//用P与N表示正负</span></span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] polar_out;                 <span class="comment">//“00”表示0，“10”表示+1，“01”表示-1</span></span><br><span class="line"><span class="keyword">reg</span> data_outN,data_outP;</span><br><span class="line"><span class="keyword">reg</span> even;                             <span class="comment">//设置极性判断标志,1表示+1和-V，0表示—1和+V</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) even &lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">2'b11</span>) <span class="keyword">begin</span>    <span class="comment">//若输入为“11（V）”</span></span><br><span class="line">        <span class="keyword">if</span>(even ==     <span class="number">1</span>)                          <span class="comment">//判断极性标志，若even为1</span></span><br><span class="line">            polar_out &lt;= <span class="number">2'b01</span>;             <span class="comment">//输出为“01（-1）”</span></span><br><span class="line">        <span class="keyword">else</span>                                     <span class="comment">//若even为0</span></span><br><span class="line">            polar_out &lt;= <span class="number">2'b10</span>;             <span class="comment">//输出为“10（+1）”</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">//若输入为“01（1）”或者“10（B）”</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">2'b01</span> || data_in == <span class="number">2'b10</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(even == <span class="number">1</span>) <span class="keyword">begin</span>              <span class="comment">//判断极性标志，若even为1</span></span><br><span class="line">            even &lt;= <span class="number">0</span>;                     <span class="comment">//将even翻转</span></span><br><span class="line">            polar_out &lt;= <span class="number">2'b10</span>;         <span class="comment">//输出为“10（+1）”</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span>                          <span class="comment">//若even为0</span></span><br><span class="line">            even &lt;= <span class="number">1</span>;                      <span class="comment">//将even翻转</span></span><br><span class="line">            polar_out &lt;= <span class="number">2'b01</span>;         <span class="comment">//输出为“01（-1）”</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_in == <span class="number">2'b00</span>)        <span class="comment">//若输入为“00（0）”</span></span><br><span class="line">        polar_out &lt;= <span class="number">2'b00</span>;            <span class="comment">//输出为“00（0）”</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(polar_out <span class="keyword">or</span> rst) <span class="keyword">begin</span>    </span><br><span class="line"><span class="comment">//将输出寄存器的两位数分别赋值给输出端口data_outP和data_outN</span></span><br><span class="line">    <span class="keyword">if</span>(!rst) <span class="keyword">begin</span></span><br><span class="line">        data_outP &lt;= <span class="number">0</span>;</span><br><span class="line">        data_outN &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(polar_out == <span class="number">2'b01</span>) <span class="keyword">begin</span></span><br><span class="line">        data_outP &lt;= <span class="number">0</span>;                <span class="comment">//PN=01表示-1</span></span><br><span class="line">        data_outN &lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(polar_out == <span class="number">2'b10</span>) <span class="keyword">begin</span></span><br><span class="line">        data_outP &lt;= <span class="number">1</span>;                <span class="comment">//PN=10表示+1</span></span><br><span class="line">        data_outN &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        data_outP &lt;= <span class="number">0</span>;                <span class="comment">//PN=00表示0</span></span><br><span class="line">        data_outN &lt;= <span class="number">0</span>;            </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>模块change的作用是将双极性信号变更为8位二进制数。<ul>
<li>输入信号为polar模块的输出，输出信号则为8位二进制数；</li>
<li>对输入信号进行判断，若输入信号为“00”，则输出信号为“10000000”；若输入信号为“10”，则输出信号为“11111111”，若输入信号为“01”，则输出信号为“00000000”。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> change(rst,data_inP,data_inN,data_out,clk);</span><br><span class="line"></span><br><span class="line"><span class="comment">//二输入八输出模块，将PN信号转换为八位输出信号作为DAC的输入</span></span><br><span class="line"><span class="keyword">input</span> rst,clk,data_inP,data_inN;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">7</span>:<span class="number">0</span>]data_out;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>]data_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst)    <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst)</span><br><span class="line">        data_out &lt;= <span class="number">8'b10000000</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_inP == <span class="number">1</span> &amp;&amp; data_inN == <span class="number">0</span>) <span class="keyword">begin</span>        <span class="comment">//PN=10对应输出HFF</span></span><br><span class="line">        data_out &lt;= <span class="number">8'b11111111</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_inP == <span class="number">0</span> &amp;&amp; data_inN ==<span class="number">1</span>) <span class="keyword">begin</span>        <span class="comment">//PN=01对应输出H00</span></span><br><span class="line">        data_out &lt;= <span class="number">8'b00000000</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(data_inP == <span class="number">0</span> &amp;&amp; data_inN ==<span class="number">0</span>) <span class="keyword">begin</span>        <span class="comment">//PN=00对应输出H80</span></span><br><span class="line">        data_out &lt;= <span class="number">8'b10000000</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="D-A转换设计"><a href="#D-A转换设计" class="headerlink" title="D/A转换设计"></a>D/A转换设计</h3><ul>
<li>模拟数据传输过程在实验箱上用一条信号连接线来表示，用DA转换器将双极性的数字信号转换成模拟信号，经过信号连接线至AD转换器，转换成双极性的0和1输出到解码模块。由于使用Quartus Ⅱ时没有AD和DA转换器，所以直接连接了双极性输出和输入断，跳过了模拟传输过程，但实际上的AD转换器输出并不是完美的双极性数据，需要根据实验箱的调整而对代码进行多次调试。</li>
</ul>
<h3 id="A-D采样设计"><a href="#A-D采样设计" class="headerlink" title="A/D采样设计"></a>A/D采样设计</h3><ul>
<li>由AD转换器输出的八位数据，由于模拟传输过程和转化过程存在时延差，需要设计一个码元定时恢复模块，用最初256分频产生的时钟信号不断检测二维数据，根据实际的数据特征来产生与16分频信号相同的8KHz信号，并且判断码元的起始时刻，此处码元定时恢复模块输出的码元时钟将用于整个解码模块。解码模块根据HDB3码的特征，找到相应的+1码和-1码，并且判断V码和B码并清零，实现解码。</li>
</ul>
<h3 id="位同步设计"><a href="#位同步设计" class="headerlink" title="位同步设计"></a>位同步设计</h3><ul>
<li>模块recover的作用是将八位二进制信号变更为一位的单极性信号，即码元定时恢复。<ul>
<li>对输入信号进行判断，八位输出信号有三种情况，8’h00、8’h80、8’hFF，分别代表-1，0和+1这三种情况，仿真时可以用三种情况的数字特征来进行边缘检测和时钟定时恢复；</li>
<li>在实际调试过程中，AD转换输出的三种信号并不是确定的值，会存在毛刺现象，所以需要根据实际情况调整，我们采集到的数据是大于8’h58为+1，8’h30~8’h3f为0，小于8’h0f为-1，故根据三个区间，用256分频的时钟去采样，初始置flag为0，如果检测到区间发生跃变，则置1，同时进行定时恢复，连续八个时钟翻转一次，得到码元定时恢复的时钟提供后续模块使用。</li>
</ul>
</li>
</ul>
<h3 id="解码电路设计"><a href="#解码电路设计" class="headerlink" title="解码电路设计"></a>解码电路设计</h3><ul>
<li>模块trans8to1的作用是将八位二进制数据转换为P和N双极性信号。<ul>
<li>输入信号为AD转换的8位输出，输出信号则为P和N各一位的二进制数代表双极性；</li>
<li>对输入信号进行判断，若输入信号为“3’h00”，则输出信号为“P=0,N=1”；若输入信号为“3’h80”，则输出信号为“P=0,N=0”，若输入信号为“3’hFF”，则输出信号为“P=1,N=0”；</li>
<li>但实际情况是，真实的AD转换输出不会是刚好的3’h00、3’h80和3’hFF，经过实际检测，输出的范围分别是3’h00~8’h0f、8’h30~8’h3f、大于8’h58，和理想的情况相差较大，如果实际操作时用理想的三种情况检测，将不能恢复出双极性信号。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> trans8to1(rst_n, indata_8, outdata_P, outdata_N,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> rst_n,clk;</span><br><span class="line"><span class="keyword">input</span> [<span class="number">7</span>:<span class="number">0</span>] indata_8;</span><br><span class="line"><span class="keyword">output</span> outdata_P, outdata_N;</span><br><span class="line"><span class="keyword">reg</span> outdata_P, outdata_N;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位初始化</span></span><br><span class="line">        outdata_P &lt;= <span class="number">0</span>;</span><br><span class="line">        outdata_N &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 三个区间分别对应三种双极性P和N的值来表示+1、0和-1</span></span><br><span class="line">    <span class="keyword">if</span>(indata_8 &gt;= <span class="number">8'h58</span>) <span class="keyword">begin</span></span><br><span class="line">            outdata_P&lt;=<span class="number">1</span>;</span><br><span class="line">            outdata_N&lt;=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata_8 &lt;= <span class="number">8'h3f</span> &amp;&amp; indata_8 &gt;= <span class="number">8'h30</span>) <span class="keyword">begin</span></span><br><span class="line">            outdata_P&lt;=<span class="number">0</span>;</span><br><span class="line">            outdata_N&lt;=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata_8 &lt;= <span class="number">8'h0f</span>) <span class="keyword">begin</span></span><br><span class="line">            outdata_P&lt;=<span class="number">0</span>;</span><br><span class="line">            outdata_N&lt;=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>模块findv的作用是根据P和N两位数据进行逻辑判定，找到V码，输出只包含0和1的序列。<ul>
<li>设置两个flag来表示+1和-1的个数状态，根据HDB3码中的连续同号的1来找到V码；</li>
<li>如果PN是10，则flag2置0，flag1自加1，如果flag1自加+后为2则表示有两个连续的+1；</li>
<li>如果PN是01，则flag1置0，flag2自加1，如果flag2自加+后为2则表示有两个连续的-1；</li>
<li>无论是找到连续的+1还是-1都全部置11表示连续的1，正常不连续的+1和-1用01表示，其他状况都清00表示0基本还原原始序列。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> findv(rst_n, indata_P, indata_N, outdata,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> rst_n,clk;</span><br><span class="line"><span class="keyword">input</span> indata_P, indata_N;</span><br><span class="line"><span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] outdata;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>]flag1;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>]flag2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    flag1=<span class="number">2'b00</span>;</span><br><span class="line">    flag2=<span class="number">2'b00</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位初始化</span></span><br><span class="line">        flag1=<span class="number">2'b00</span>;</span><br><span class="line">        flag2=<span class="number">2'b00</span>;</span><br><span class="line">        outdata &lt;= <span class="number">2'b00</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(indata_P==<span class="number">1'b1</span> &amp;&amp; indata_N==<span class="number">1'b0</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 如果PN是10，则flag2置0，flag1自加1，如果flag1自加+后为2则表示有两个连续的+1</span></span><br><span class="line">            flag2&lt;=<span class="number">2'b00</span>;</span><br><span class="line">            flag1=flag1+<span class="number">2'b01</span>;</span><br><span class="line">            <span class="keyword">if</span>(flag1==<span class="number">2'b10</span>) <span class="keyword">begin</span></span><br><span class="line">                outdata&lt;=<span class="number">2'b11</span>;</span><br><span class="line">                flag1&lt;=<span class="number">2'b00</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span> outdata&lt;=<span class="number">2'b01</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata_P==<span class="number">1'b0</span> &amp;&amp; indata_N==<span class="number">1'b1</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 如果PN是01，则flag1置0，flag2自加1，如果flag2自加+后为2则表示有两个连续的-1</span></span><br><span class="line">            flag1&lt;=<span class="number">2'b00</span>;</span><br><span class="line">            flag2=flag2+<span class="number">2'b01</span>;</span><br><span class="line">            <span class="keyword">if</span>(flag2==<span class="number">2'b10</span>) <span class="keyword">begin</span></span><br><span class="line">                outdata&lt;=<span class="number">2'b11</span>;</span><br><span class="line">                flag2&lt;=<span class="number">2'b00</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span> outdata&lt;=<span class="number">2'b01</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">// 其他情况为00则正常置00</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata_P==<span class="number">1'b0</span> &amp;&amp; indata_N==<span class="number">1'b0</span>) outdata&lt;=<span class="number">2'b00</span>;</span><br><span class="line">        <span class="comment">//else outdata&lt;=2'b01;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>模块delvb的作用是将序列进行最后的处理，根据HDB3的连0规则将多余的1清零，恢复出原始的m序列完成最终的解码。<ul>
<li>设置一个buffer来暂存前四位数据，HDB3的编解码规则是对连续的四个0进行处理，之前的模块已经找到了V码，这里需要对V码以及B码清零；</li>
<li>但实际上只要找到了V码，将V码本身和之前的三位一共四位全部清零，就可以不用考虑B码的影响；</li>
<li>检测indata的输入若为11则表示这是一个V码，则使用buffer将四位数据清零，输出接到buffer的前三位，用counterv的0和1状况来判定清零还是直接buffer输出，完成最终的解码。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> delvb(rst_n, indata, outdata,clk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> rst_n,clk;</span><br><span class="line"><span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>]indata;</span><br><span class="line"><span class="keyword">output</span> outdata;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">3</span>:<span class="number">0</span>]buffer;</span><br><span class="line"><span class="keyword">reg</span> bufferdata;</span><br><span class="line"><span class="keyword">reg</span> counterv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)</span><br><span class="line"><span class="keyword">begin</span><span class="comment">// 设置四位buffer暂存前四位数据</span></span><br><span class="line"><span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">    buffer[<span class="number">3</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">    buffer[<span class="number">2</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">    buffer[<span class="number">1</span>]&lt;=<span class="number">0</span>;</span><br><span class="line">    buffer[<span class="number">0</span>]&lt;=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">    buffer[<span class="number">3</span>]&lt;=buffer[<span class="number">2</span>];</span><br><span class="line">    buffer[<span class="number">2</span>]&lt;=buffer[<span class="number">1</span>];</span><br><span class="line">    buffer[<span class="number">1</span>]&lt;=buffer[<span class="number">0</span>];</span><br><span class="line">    buffer[<span class="number">0</span>]&lt;=bufferdata;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 复位初始化</span></span><br><span class="line">    <span class="keyword">if</span>(!rst_n) bufferdata &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(indata==<span class="number">2'b01</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 如果是正常的01，则数据还是1</span></span><br><span class="line">            counterv &lt;= <span class="number">0</span>;</span><br><span class="line">            bufferdata&lt;=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata==<span class="number">2'b00</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 如果是正常的00，则数据还是0</span></span><br><span class="line">            counterv &lt;= <span class="number">0</span>;</span><br><span class="line">            bufferdata&lt;=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(indata==<span class="number">2'b11</span>) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 如果是的11，则表示该位为V码，将counterv标记1</span></span><br><span class="line">            counterv &lt;= <span class="number">1</span>;</span><br><span class="line">            bufferdata&lt;=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> outdata = (counterv == <span class="number">1</span>)  ? <span class="number">0</span> : buffer[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="编解码系统总体电路设计"><a href="#编解码系统总体电路设计" class="headerlink" title="编解码系统总体电路设计"></a>编解码系统总体电路设计</h3><ul>
<li>顶层模块的作用是将所有的功能模块进行连接，并将部分功能模块的输出端口拉出，以方便最终的仿真及FPGA引脚的绑定。<ul>
<li>分频功能的连接：将系统时钟作为even256_div模块的输入，其输出为系统时钟的256分频时钟，将其作为even_div16模块的输入，其输出为256分频时钟的16分频时钟；</li>
<li>M序列生成功能的连接：用16分频时钟作为m_sequence模块的驱动时钟，输入使能信号，输出为m序列；</li>
<li>HDB3编码功能的连接：该功能下模块的驱动时钟都为16分频时钟，将m_sequence模块的输出作为add_v模块的输入，将add_v模块的输出作为add_b模块的输入，将add_b模块的输出作为polar模块的输入，将polar模块的输出作为change模块的输入，输出8位二进制数；</li>
<li>码元定时恢复功能的连接：用256分频时钟作为recover模块的驱动时钟，ad转换器的输出作为recover模块的输入，输出为码元定时恢复时钟；</li>
<li>HDB3译码功能的连接:该功能下模块的驱动时钟都为码元定时恢复时钟，ad转换器的输出作为trans8to1模块的输入，将trans8to1模块的输出作为findv模块的输入，将findv模块的输出作为delvb模块的输入，delvb模块的输出即为译码恢复的m序列。</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> HDB3(rst,</span><br><span class="line">                clk,clk_256,clk_16,clk_recover,clk_256_ad,clk_256_da,</span><br><span class="line">                ena,</span><br><span class="line">                data_out,data_out_ad,outm,outv,outb,outP,outN,data_out_check,</span><br><span class="line">                finallyout,outdata_P,outdata_N,outdata_v</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span>  rst,clk,ena;</span><br><span class="line"><span class="keyword">input</span> [<span class="number">7</span>:<span class="number">0</span>]data_out_ad;</span><br><span class="line"><span class="keyword">output</span> clk_256,clk_16,clk_recover,clk_256_ad,clk_256_da;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">7</span>:<span class="number">0</span>]data_out_check;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">7</span>:<span class="number">0</span>]data_out;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">1</span>:<span class="number">0</span>]outv;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">1</span>:<span class="number">0</span>]outb;</span><br><span class="line"><span class="keyword">output</span> outm,outP,outN;</span><br><span class="line"><span class="keyword">output</span> outdata_P,outdata_N;</span><br><span class="line"><span class="keyword">output</span> [<span class="number">1</span>:<span class="number">0</span>]outdata_v;</span><br><span class="line"><span class="keyword">output</span> finallyout;</span><br><span class="line"><span class="comment">//分频</span></span><br><span class="line">even256_div div256(clk,rst,clk_256);</span><br><span class="line">even16_div div16(clk_256,rst,clk_16);</span><br><span class="line"><span class="comment">//m序列</span></span><br><span class="line">m_sequence m(clk_16,rst,ena,outm,load);</span><br><span class="line"><span class="comment">//编码</span></span><br><span class="line">add_v u1(rst,outm,outv,clk_16);</span><br><span class="line">add_b u2(rst,outv,outb,clk_16);</span><br><span class="line">polar u3(rst,outb,outP,outN,clk_16);</span><br><span class="line">change u4(rst,outP,outN,data_out,clk_16);</span><br><span class="line"><span class="comment">//码元定时恢复</span></span><br><span class="line">recover u8(clk_256, rst, data_out_ad, clk_recover);</span><br><span class="line"><span class="comment">//译码</span></span><br><span class="line">trans8to1 u5(rst, data_out_ad, outdata_P, outdata_N,clk_recover);</span><br><span class="line">findv u6(rst, outdata_P, outdata_N, outdata_v,clk_recover);</span><br><span class="line">delvb u7(rst, outdata_v, finallyout,clk_recover);</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> clk_256_ad = clk_256;</span><br><span class="line"><span class="keyword">assign</span> clk_256_da = clk_256;</span><br><span class="line"><span class="keyword">assign</span> data_out_check = data_out_ad;</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="调试与验证"><a href="#调试与验证" class="headerlink" title="调试与验证"></a>调试与验证</h2><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/2.FPGA.png" alt="Fig.2 FPGA"></p>
<center><font size="2">Fig.2 FPGA</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/3.引脚分配.jpg" alt="Fig.3 引脚分配"></p>
<center><font size="2">Fig.3 引脚分配</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/4.jpg" alt="Fig.4 FPGA连接"></p>
<center><font size="2">Fig.4 FPGA连接</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/5.256分频和16分频.jpg" alt="Fig.5 256分频和16分频"></p>
<center><font size="2">Fig.5 256分频和16分频</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/6.16分频和m序列.jpg" alt="Fig.6 16分频和m序列"></p>
<center><font size="2">Fig.6 16分频和m序列</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/7.16分频和码元定时恢复时钟.jpg" alt="Fig.7 16分频和码元定时恢复时钟"></p>
<center><font size="2">Fig.7 16分频和码元定时恢复时钟</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/8.m序列和模拟传输信号.jpg" alt="Fig.8 m序列和模拟传输信号"></p>
<center><font size="2">Fig.8 m序列和模拟传输信号</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/9.恢复的m序列和码元定时恢复时钟.jpg" alt="Fig.9 恢复的m序列和码元定时恢复时钟"></p>
<center><font size="2">Fig.9 恢复的m序列和码元定时恢复时钟</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/10.m序列前后.jpg" alt="Fig.10 m序列前后"></p>
<center><font size="2">Fig.10 m序列前后</font></center>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>问题1：在FPGA仿真时，ad转换器输入的八位二进制数在一开始无法在示波器上检测到。</p>
</blockquote>
<ul>
<li>解决方法：一开始我们认为是因为ad转换器自身的问题，导致输出的8位二进制数只在较低位发生变化，但经过多次检测后，我们认为实际8位二进制数并没有输入进我们的顶层模块，于是我们通过对顶层模块代码进行检查，发现产生该问题的原因是输入8位二进制数的端口本应设置为输入端口吗，但我们设置为了输出端口，所以导致信号并没有传输进来，所以无法检测到。</li>
</ul>
<blockquote>
<p>问题2：码元定时恢复不理解是什么意思，导致并不能准确的恢复出时钟。</p>
</blockquote>
<ul>
<li>解决办法：请教老师后发现原来是用256分频所得的时钟来对八位信号进行采样，根据采集到的信号变化确定码元的起始位置，再根据数字特征定时翻转，起到恢复出16分频时钟的作用。</li>
</ul>
<blockquote>
<p>问题3：实际的AD转换器和理想状态不同，用理想的条件去检测无法正常将8位AD输出转成双极性数据。</p>
</blockquote>
<ul>
<li>解决办法：这个问题困扰的时间最久，由于AD转换输出的8位数字信号并不是非常完美的，存在跳变以及根据实验箱的实际情况并不会根据0~5V输出00~FF，于是将AD输出的八位信号分别绑定到FPGA的其他空余引脚，对每个引脚上的数据进行分析，判定-1，0和+1分别对应该位的0状态还是1状态，最终得到我们需要的三种状态区间，高四位可以比较准确的判定，而第四位的0和1状态反复跳变，最终确定的区间为：3’h00——8’h0f代表-1，8’h30——8’h3f代表0，大于8’h58代表+1</li>
</ul>
<h2 id="Download-Source-File"><a href="#Download-Source-File" class="headerlink" title="Download Source File"></a>Download Source File</h2><h3 id="Project-File"><a href="#Project-File" class="headerlink" title="Project File"></a><a href="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/HDB3_quartus+modelism.zip">Project File</a></h3><h3 id="Wave-File"><a href="#Wave-File" class="headerlink" title="Wave File"></a><a href="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/HDB3/HDB3wavefile.zip">Wave File</a></h3><!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>Quartus Ⅱ</tag>
        <tag>Modelsim</tag>
        <tag>Verilog HDL</tag>
      </tags>
  </entry>
  <entry>
    <title>渲染问题汇总</title>
    <url>/2022/12/03/Hexo%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/</url>
    <content><![CDATA[<ul>
<li>Hexo将Markdown文件渲染成静态页面，但是每次都会出现不少问题，本地的渲染引擎和hexo的有所区别，在这里总结一些问题<span id="more"></span>
</li>
</ul>
<h3 id="1-英文引号和中文引号问题"><a href="#1-英文引号和中文引号问题" class="headerlink" title="1.英文引号和中文引号问题"></a>1.英文引号和中文引号问题</h3><ul>
<li>比较莫名其妙，Hexo的默认渲染邀请自动将英文引号转化为中文引号，特别是在一些数学公式中，显示会出现问题</li>
<li><code>hexo-renderer-markdown</code>默认配置<code>quotes</code>配置为<code>quotes: '“”‘’'</code>，然后英文双引号就会被解析为英文双引号而非坑爹的中文双引号。但是讲道理更改配置<code>quotes: '""'''</code>可以取消这种奇怪的逻辑，但是无果。</li>
</ul>
<h4 id="在一个Issue中找到解决办法"><a href="#在一个Issue中找到解决办法" class="headerlink" title="在一个Issue中找到解决办法"></a>在一个Issue中找到解决办法</h4><h5 id="适用hexo-renderer-markdown-it和hexo-renderer-markdown-it-plus"><a href="#适用hexo-renderer-markdown-it和hexo-renderer-markdown-it-plus" class="headerlink" title="适用hexo-renderer-markdown-it和hexo-renderer-markdown-it-plus"></a><code>适用hexo-renderer-markdown-it</code>和<code>hexo-renderer-markdown-it-plus</code></h5><figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">markdown:</span></span><br><span class="line">  <span class="attr">render:</span></span><br><span class="line"><span class="bullet">-</span>    <span class="attr">typographer:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">+</span>    <span class="attr">typographer:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="适用默认的hexo-renderer-marked"><a href="#适用默认的hexo-renderer-marked" class="headerlink" title="适用默认的hexo-renderer-marked"></a>适用默认的<code>hexo-renderer-marked</code></h5><figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">marked:</span></span><br><span class="line"><span class="bullet">-</span>  <span class="attr">smartypants:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">+</span>  <span class="attr">smartypants:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-公式渲染问题"><a href="#2-公式渲染问题" class="headerlink" title="2.公式渲染问题"></a>2.公式渲染问题</h3><p>这次是一个算法的综述，里面有一些多行公式还有矩阵，之前埋下的坑打算这次一起解决了。</p>
<ul>
<li><code>hexo-renderer-markdown-it</code>没法渲染<code>Latex</code>的矩阵以及多行公式，在<code>Vscode</code>或者<code>Typora</code>中可以渲染出来，但是<code>hexo</code>不太行，所以换了<code>hexo-renderer-kramed</code>，版本是<code>^0.1.4</code></li>
<li>但是出现新的问题，<code>kramed</code>会把<code>*</code>和<code>_</code>渲染成斜体，所以反而出现了很多问题</li>
</ul>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li>首先是用<code>\ast</code>替代公式中可能出现的<code>*</code>这里主要是会出现<code>A*</code>算法</li>
<li>然后取消<code>_</code>的斜体转义，<code>/node_modules/kramed/lib/rules/inline.js</code>的第20行的<code>/^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</code>修改如下：<code>em: /^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</code>，即去除<code>_</code>的转义，以后斜体使用<code>*</code>即可，不使用<code>_</code>；第11行也做如下修改：<code>escape: /^\\([\\`*\[\]()#$+\-.!_&gt;])/,</code>改为<code>escape: /^\\([`*\[\]()#$+\-.!_&gt;])/,</code>，这里要注意，其实行内代码最好用四个引号````</li>
<li>还有一点要注意就是，改了源码之后要重启<code>hexo</code>服务，修改模块后不会自动刷新</li>
</ul>
<h3 id="3-待办事项渲染问题"><a href="#3-待办事项渲染问题" class="headerlink" title="3.待办事项渲染问题"></a>3.待办事项渲染问题</h3><ul>
<li><p>使用<code>kramed</code>渲染不了待办事项，但在<code>hexo-renderer-marked</code>的<code>PR</code>里找到了相关更新：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Support To-Do List</span></span><br><span class="line"><span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">listitem</span> = <span class="keyword">function</span>(<span class="params">text</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/^\s*\[[x ]\]\s*/</span>.<span class="title function_">test</span>(text)) {</span><br><span class="line">    text = text.<span class="title function_">replace</span>(<span class="regexp">/^\s*\[ \]\s*/</span>, <span class="string">'&lt;input type="checkbox"&gt;&lt;/input&gt; '</span>).<span class="title function_">replace</span>(<span class="regexp">/^\s*\[x\]\s*/</span>, <span class="string">'&lt;input type="checkbox" checked&gt;&lt;/input&gt; '</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;li style="list-style: none"&gt;'</span> + text + <span class="string">'&lt;/li&gt;\n'</span>;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;li&gt;'</span> + text + <span class="string">'&lt;/li&gt;\n'</span>;</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>把渲染函数加入到本地的<code>hexo</code>文件夹的<code>/node_modules/hexo-renderer-kramed/lib/renderer.js</code>，但注意和<code>-</code>标记要间隔至少两行，否则第一个待办会出错</p>
</li>
</ul>
<ul>
<li>[x] 待办事项1</li>
<li>[ ] 待办事项2</li>
<li>[x] 待办事项3</li>
<li>[ ] 待办事项4</li>
</ul>
<h3 id="4-表格渲染问题"><a href="#4-表格渲染问题" class="headerlink" title="4.表格渲染问题"></a>4.表格渲染问题</h3><ul>
<li>问题：换用<code>hexo-renderer-kramed</code>不就后发现之前用<code>marked</code>能成功渲染Tables的地方无法渲染</li>
<li>找了<code>n</code>小时后来发现只要<code>GFM</code>的Table语法，和前一行严格保持一行以上的间距，并且在Table块之前本行无空格，就能和原来的<code>marked</code>一样渲染出正常的表格</li>
<li>但是紧接着会多一个不算问题的问题，如果使用多个<code>-</code>标记的用于分层，并且在非第一层的层与层之间之间存在上述方法修改的Table，会导致Table后面跟着的下一个层级变丑，例如：</li>
</ul>
<ul>
<li><p>原来</p>
<ul>
<li>原来<ul>
<li>这一层的样式</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>变成了这样</li>
</ul>
</li>
</ul>
</li>
<li><p>其实合理怀疑是<code>Kramed</code>的空格渲染问题，有空排查一下</p>
</li>
</ul>
<blockquote>
<p>下面附上<code>GFM</code>的Table语法</p>
</blockquote>
<p>Tables aren’t part of the core Markdown spec, but they are part of GFM and Markdown Here supports them. They are an easy way of adding tables to your email — a task that would otherwise require copy-pasting from another application.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Colons can be used to align columns.</span><br><span class="line"></span><br><span class="line">| Tables        | Are           | Cool  |</span><br><span class="line">| ------------- |:-------------:| -----:|</span><br><span class="line">| col 3 is      | right-aligned | $1600 |</span><br><span class="line">| col 2 is      | centered      |   $12 |</span><br><span class="line">| zebra stripes | are neat      |    $1 |</span><br><span class="line"></span><br><span class="line">There must be at least 3 dashes separating each header cell.</span><br><span class="line">The outer pipes (|) are optional, and you don't need to make the </span><br><span class="line">raw Markdown line up prettily. You can also use inline Markdown.</span><br><span class="line"></span><br><span class="line">Markdown | Less | Pretty</span><br><span class="line">--- | --- | ---</span><br><span class="line">*Still* | `renders` | **nicely**</span><br><span class="line">1 | 2 | 3</span><br></pre></td></tr></tbody></table></figure>
<p>Colons can be used to align columns.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Tables</th>
<th style="text-align:center">Are</th>
<th style="text-align:right">Cool</th>
</tr>
</thead>
<tbody>
<tr>
<td>col 3 is</td>
<td style="text-align:center">right-aligned</td>
<td style="text-align:right">$1600</td>
</tr>
<tr>
<td>col 2 is</td>
<td style="text-align:center">centered</td>
<td style="text-align:right">$12</td>
</tr>
<tr>
<td>zebra stripes</td>
<td style="text-align:center">are neat</td>
<td style="text-align:right">$1</td>
</tr>
</tbody>
</table>
</div>
<p>There must be at least 3 dashes separating each header cell. The outer pipes (|) are optional, and you don’t need to make the raw Markdown line up prettily. You can also use inline Markdown.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Markdown</th>
<th>Less</th>
<th>Pretty</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Still</em></td>
<td><code>renders</code></td>
<td><strong>nicely</strong></td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Debug</tag>
      </tags>
  </entry>
  <entry>
    <title>ASK and PSK</title>
    <url>/2021/05/30/ASK%20and%20PSK/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h3 id="Most-communication-channels-have-communication-channels-so-the-only-way-to-transmit-signals-through-such-channels-is-to-move-the-fortunate-frequency-that-carries-the-message-to-the-frequency-band-of-the-channel"><a href="#Most-communication-channels-have-communication-channels-so-the-only-way-to-transmit-signals-through-such-channels-is-to-move-the-fortunate-frequency-that-carries-the-message-to-the-frequency-band-of-the-channel" class="headerlink" title="Most communication channels have communication channels, so the only way to transmit signals through such channels is to move the fortunate frequency that carries the message to the frequency band of the channel"></a>Most communication channels have communication channels, so the only way to transmit signals through such channels is to move the fortunate frequency that carries the message to the frequency band of the channel</h3><p><span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f563.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<span id="more"></span>
<hr>
<h2 id="notebook-4ASK"><a href="#notebook-4ASK" class="headerlink" title=":notebook: 4ASK"></a><span class="github-emoji"><span>📓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4ASK</h2><h3 id="u-m-t-A-m-g-T-t-cos-2-pi-f-c-t-m-1-2-3-…-M"><a href="#u-m-t-A-m-g-T-t-cos-2-pi-f-c-t-m-1-2-3-…-M" class="headerlink" title="$u{m}(t) = A{m}g{T}(t)cos(2\pi f{c}t),m=1,2,3,…,M$"></a>$u<em>{m}(t) = A</em>{m}g<em>{T}(t)cos(2\pi f</em>{c}t),m=1,2,3,…,M$</h3><h3 id="A-m-2m-1-M-d-m-1-2-3-…-M"><a href="#A-m-2m-1-M-d-m-1-2-3-…-M" class="headerlink" title="$A_{m}=(2m-1-M)d,m=1,2,3,…,M$"></a>$A_{m}=(2m-1-M)d,m=1,2,3,…,M$</h3><p>$ g_{T}(t)=<br>  \begin{cases}<br>  \sqrt\frac 2T, 0≤t≤T \\<br>  0, otherwise \\<br>  \end{cases} $</p>
<p><em>Where d=1, T=1, fc=5Hz, the mapping rule from the bit pair to m is: 00-&gt;1, 01-&gt;2,11-&gt;3,10-&gt;4.<br>(1) If the message bits are 11 00 10 00 01, plot the corresponding 4ASK signal in both time and frequency domain, sampling frequency fs=1000Hz.<br>(2) Give the average signal energy per bit, i.e., Eb, for 4ASK.<br>(3) Denote SNR as Eb/N0, plot the theoretical SER (symbol error rate) and simulated SER, for SNR=0:2:8 dB.</em></p>
<h3 id="memo-4ASK-Code"><a href="#memo-4ASK-Code" class="headerlink" title=":memo: 4ASK Code"></a><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4ASK Code</h3><ul>
<li>4ASK.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Consider the following 4ASK modulation, where T=1.</span></span><br><span class="line"> </span><br><span class="line">clear;</span><br><span class="line">clc;</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(1)</span></span><br><span class="line"><span class="comment">% Plot the corresponding 4ASK signal.</span></span><br><span class="line">T = <span class="number">1</span>;                  <span class="comment">% Symbol interval.</span></span><br><span class="line">d = <span class="number">1</span>;</span><br><span class="line">Tb = T/<span class="number">2</span>;               <span class="comment">% Bit interval.</span></span><br><span class="line">m = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];          <span class="comment">% Equally spaced.</span></span><br><span class="line">M = <span class="number">4</span>;                  <span class="comment">% 4ASK:M=4</span></span><br><span class="line">A_m = (<span class="number">2</span>*m<span class="number">-1</span>-M)*d;      <span class="comment">% The amplitude of the m-th waveform.</span></span><br><span class="line">fc = <span class="number">5</span>;                 <span class="comment">% Carrier frequency.</span></span><br><span class="line">fs = <span class="number">1000</span>;              <span class="comment">% Sampling frequency.</span></span><br><span class="line">gT=<span class="built_in">sqrt</span>(<span class="number">2</span>/T);           <span class="comment">% Transmission pulse.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Message bits.</span></span><br><span class="line">N = <span class="number">5</span>;</span><br><span class="line">Sig = [<span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];</span><br><span class="line"><span class="comment">% Mapping.</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="number">2</span>:<span class="built_in">length</span>(Sig)</span><br><span class="line">    <span class="keyword">if</span>(Sig(<span class="built_in">i</span>)==<span class="number">0</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">0</span>)</span><br><span class="line">        m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = A_m(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">elseif</span>(Sig(<span class="built_in">i</span>)==<span class="number">0</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">1</span>)</span><br><span class="line">        m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = A_m(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">elseif</span>(Sig(<span class="built_in">i</span>)==<span class="number">1</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">1</span>)</span><br><span class="line">        m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = A_m(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = A_m(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Sampling.</span></span><br><span class="line">[t,x] = Sampling(T,fs,m);</span><br><span class="line"><span class="comment">% Carrier wave.</span></span><br><span class="line">carrier = <span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*fc*t);</span><br><span class="line"><span class="comment">% ASK modulation.</span></span><br><span class="line">u_m=gT*x.*carrier;</span><br><span class="line"><span class="comment">% T2F.</span></span><br><span class="line">[sf,U_m]=T2F(t,u_m);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Plotting commands follow.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_m);</span><br><span class="line">title(<span class="string">'Time domain'</span>)</span><br><span class="line">xlabel(<span class="string">'t/s'</span>)</span><br><span class="line">ylabel(<span class="string">'u\_m(t)'</span>)</span><br><span class="line"><span class="built_in">figure</span>(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">plot</span>(sf,<span class="built_in">abs</span>(U_m));</span><br><span class="line">title(<span class="string">'Frequency domain'</span>)</span><br><span class="line">xlabel(<span class="string">'f/Hz'</span>)</span><br><span class="line">ylabel(<span class="string">'U\_m'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(2)</span></span><br><span class="line"><span class="comment">% Give the average energy per symbol and average energy per bit.</span></span><br><span class="line">Eav = sum(A_m.^<span class="number">2</span>)/<span class="number">4</span>     <span class="comment">% Average energy per symbol.</span></span><br><span class="line">Eb = Eav/<span class="number">2</span>              <span class="comment">% Average energy per bit.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(3)</span></span><br><span class="line"><span class="comment">% SER.</span></span><br><span class="line"> </span><br><span class="line">SNRindB=<span class="number">0</span>:<span class="number">2</span>:<span class="number">8</span>;          </span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="built_in">length</span>(SNRindB)</span><br><span class="line">  <span class="comment">% Simulated error rate .</span></span><br><span class="line">  smld_err_prb(<span class="built_in">i</span>)=smldpe(SNRindB(<span class="built_in">i</span>));     </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="built_in">length</span>(SNRindB)</span><br><span class="line">  <span class="comment">% Signal-to-noise ratio.</span></span><br><span class="line">  SNR_per_bit=<span class="built_in">exp</span>(SNRindB(<span class="built_in">i</span>)*<span class="built_in">log</span>(<span class="number">10</span>)/<span class="number">10</span>);  </span><br><span class="line">  <span class="comment">% Theoretical error rate.</span></span><br><span class="line">  theo_err_prb(<span class="built_in">i</span>)=(<span class="number">3</span>/<span class="number">2</span>)*Qfunct(<span class="built_in">sqrt</span>((<span class="number">4</span>/<span class="number">5</span>)*SNR_per_bit));  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">% Plotting commands follow.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">3</span>)</span><br><span class="line">semilogy(SNRindB,smld_err_prb,<span class="string">'*'</span>);</span><br><span class="line"><span class="built_in">hold</span></span><br><span class="line">semilogy(SNRindB,theo_err_prb);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Sampling.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[T,Samp_Sig]</span>=<span class="title">Sampling</span><span class="params">(t,Fs,sig)</span> </span></span><br><span class="line"><span class="comment">% Fucntion Name:Sampling </span></span><br><span class="line"><span class="comment">%Input: Tb,Fs:sig OutPut:Samp_Sig </span></span><br><span class="line"><span class="comment">%When you call the Function ,u input the tiem for a bit,the </span></span><br><span class="line"><span class="comment">%Sampling rate and the source signal,then output the Samplint Signal.</span></span><br><span class="line">Ts=<span class="number">1</span>/Fs;</span><br><span class="line">Sig=sig;</span><br><span class="line">len=<span class="built_in">length</span>(Sig);</span><br><span class="line">T=<span class="number">0</span>:Ts:len*t-Ts;</span><br><span class="line">Samp_Sig=T; </span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">0</span>:<span class="number">1</span>:len<span class="number">-1</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span>=<span class="number">1</span>:<span class="number">1</span>:t/Ts</span><br><span class="line">        Samp_Sig(<span class="built_in">i</span>*t/Ts+<span class="built_in">j</span>)=Sig(<span class="built_in">i</span>+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">end</span>    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>T2T.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[f,sf]</span>=<span class="title">T2F</span><span class="params">(t,st)</span></span></span><br><span class="line"><span class="comment">%input is time and the signal vectors</span></span><br><span class="line"><span class="comment">%output is freguency and signal spectrum</span></span><br><span class="line"> </span><br><span class="line">dt=t(<span class="number">2</span>)-t(<span class="number">1</span>);</span><br><span class="line">T=t(<span class="keyword">end</span>)-t(<span class="number">1</span>)+dt;</span><br><span class="line">df=<span class="number">1</span>/T;                     <span class="comment">%smapling rate</span></span><br><span class="line">N=<span class="built_in">length</span>(st);</span><br><span class="line"> </span><br><span class="line">f=-N/<span class="number">2</span>*df:df:(N/<span class="number">2</span><span class="number">-1</span>)*df;    <span class="comment">% Frequency sampling point.</span></span><br><span class="line">sf=fft(st);</span><br><span class="line"><span class="comment">% Compensation for time shift</span></span><br><span class="line">sf=T/N*fftshift(sf).*<span class="built_in">exp</span>(-<span class="built_in">j</span>*<span class="number">2</span>*<span class="built_in">pi</span>*f*t(<span class="number">1</span>));   </span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>smldpe.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[p]</span>=<span class="title">smldpe</span><span class="params">(snr_in_dB)</span></span></span><br><span class="line"><span class="comment">% [p]=smldPe(snr_in_dB)</span></span><br><span class="line"><span class="comment">%       SMLDPE  simulates the probability of error for the given</span></span><br><span class="line"><span class="comment">%           snr_in_dB, signal to noise ratio in dB.</span></span><br><span class="line">d=<span class="number">1</span>;</span><br><span class="line">SNR=<span class="built_in">exp</span>(snr_in_dB*<span class="built_in">log</span>(<span class="number">10</span>)/<span class="number">10</span>);      <span class="comment">% signal to noise ratio per bit</span></span><br><span class="line">sgma=<span class="built_in">sqrt</span>((<span class="number">5</span>*d^<span class="number">2</span>)/(<span class="number">4</span>*SNR));         <span class="comment">% sigma, standard deviation of noise</span></span><br><span class="line">N=<span class="number">10000</span>;                            <span class="comment">% number of symbols being simulated</span></span><br><span class="line"><span class="comment">% generation of the quarternary data source follows</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:N</span><br><span class="line">  temp=<span class="built_in">rand</span>;                        <span class="comment">% a uniform random variable over (0,1)</span></span><br><span class="line">  <span class="keyword">if</span> (temp&lt;<span class="number">0.25</span>)</span><br><span class="line">    dsource(<span class="built_in">i</span>)=<span class="number">1</span>;                   <span class="comment">% with probability 1/4, source output is "00"</span></span><br><span class="line">  <span class="keyword">elseif</span> (temp&lt;<span class="number">0.5</span>)</span><br><span class="line">    dsource(<span class="built_in">i</span>)=<span class="number">2</span>;                   <span class="comment">% with probability 1/4, source output is "01"</span></span><br><span class="line">  <span class="keyword">elseif</span> (temp&lt;<span class="number">0.75</span>)</span><br><span class="line">    dsource(<span class="built_in">i</span>)=<span class="number">3</span>;                   <span class="comment">% with probability 1/4, source output is "11"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    dsource(<span class="built_in">i</span>)=<span class="number">4</span>;                   <span class="comment">% with probability 1/4, source output is "10"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">% detection, and probability of error calculation</span></span><br><span class="line">numoferr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:N</span><br><span class="line">  <span class="comment">% The matched filter outputs</span></span><br><span class="line">  <span class="keyword">if</span> (dsource(<span class="built_in">i</span>)==<span class="number">1</span>)</span><br><span class="line">    r=<span class="number">-3</span>*d+gngauss(sgma);           <span class="comment">% if the source output is "00"</span></span><br><span class="line">  <span class="keyword">elseif</span> (dsource(<span class="built_in">i</span>)==<span class="number">2</span>)</span><br><span class="line">    r=-d+gngauss(sgma);             <span class="comment">% if the source output is "01"</span></span><br><span class="line">  <span class="keyword">elseif</span> (dsource(<span class="built_in">i</span>)==<span class="number">3</span>)  </span><br><span class="line">    r=d+gngauss(sgma);              <span class="comment">% if the source output is "11"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    r=<span class="number">3</span>*d+gngauss(sgma);            <span class="comment">% if the source output is "10"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">% detector follows</span></span><br><span class="line">  <span class="keyword">if</span> (r&lt;<span class="number">-2</span>*d)</span><br><span class="line">    decis=<span class="number">1</span>;                        <span class="comment">% decision is "00"</span></span><br><span class="line">  <span class="keyword">elseif</span> (r&lt;<span class="number">0</span>)</span><br><span class="line">    decis=<span class="number">2</span>;                        <span class="comment">% decision is "01"</span></span><br><span class="line">  <span class="keyword">elseif</span> (r&lt;<span class="number">2</span>*d)</span><br><span class="line">    decis=<span class="number">3</span>;                        <span class="comment">% decision is "11"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    decis=<span class="number">4</span>;                        <span class="comment">% decision is "10"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span> (decis~=dsource(<span class="built_in">i</span>))            <span class="comment">% if it is an error, increase the error counter</span></span><br><span class="line">    numoferr=numoferr+<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">p=numoferr/N;                       <span class="comment">% probability of error </span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>gngauss.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[gsrv1,gsrv2]</span>=<span class="title">gngauss</span><span class="params">(m,sgma)</span></span></span><br><span class="line"><span class="comment">% [gsrv1,gsrv2]=gngauss(m,sgma)</span></span><br><span class="line"><span class="comment">% [gsrv1,gsrv2]=gngauss(sgma)</span></span><br><span class="line"><span class="comment">% [gsrv1,gsrv2]=gngauss</span></span><br><span class="line"><span class="comment">%       GNGAUSS  generates two independent Gaussian random variables with mean</span></span><br><span class="line"><span class="comment">%           m and standard deviation sgma. If one of the input arguments is missing </span></span><br><span class="line"><span class="comment">%           it takes the mean as 0, and the standard deviation as the given parameter.</span></span><br><span class="line"><span class="comment">%           If neither mean nor the variance is given, it generates two standard</span></span><br><span class="line"><span class="comment">%           Gaussian random variables. </span></span><br><span class="line"><span class="keyword">if</span> nargin == <span class="number">0</span>,</span><br><span class="line">  m=<span class="number">0</span>; sgma=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">elseif</span> nargin == <span class="number">1</span>,</span><br><span class="line">  sgma=m; m=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">u=<span class="built_in">rand</span>;                             <span class="comment">% a uniform random variable in (0,1)       </span></span><br><span class="line">z=sgma*(<span class="built_in">sqrt</span>(<span class="number">2</span>*<span class="built_in">log</span>(<span class="number">1</span>/(<span class="number">1</span>-u))));      <span class="comment">% a Rayleigh distributed random variable</span></span><br><span class="line">u=<span class="built_in">rand</span>;                             <span class="comment">% another uniform random variable in (0,1)</span></span><br><span class="line">gsrv1=m+z*<span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*u);</span><br><span class="line">gsrv2=m+z*<span class="built_in">sin</span>(<span class="number">2</span>*<span class="built_in">pi</span>*u);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Qfunct.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[y]</span>=<span class="title">Qfunct</span><span class="params">(x)</span></span></span><br><span class="line"><span class="comment">% [y]=Qfunct(x)</span></span><br><span class="line"><span class="comment">%       QFUNCT  evaluates the Q-function. </span></span><br><span class="line"><span class="comment">%           y = 1/sqrt(2*pi) * integral from x to inf of exp(-t^2/2) dt.</span></span><br><span class="line"><span class="comment">%           y = (1/2) * erfc(x/sqrt(2)).</span></span><br><span class="line">y=(<span class="number">1</span>/<span class="number">2</span>)*<span class="built_in">erfc</span>(x/<span class="built_in">sqrt</span>(<span class="number">2</span>));</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="chart-4ASK-Fig"><a href="#chart-4ASK-Fig" class="headerlink" title=":chart: 4ASK Fig"></a><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4ASK Fig</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/ASK_PSK/Time_domain.png" alt="Message bits in Time domain(4ASK)."></p>
<center><font size="2">Fig.1 Message bits in Time domain(4ASK).</font></center>
<br><br><br>

![Fig.2 Message bits in Frequency domain.][2]
<center><font size="2">Fig.2 Message bits in Frequency domain.</font></center>
<br><br><br>

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/ASK_PSK/lab6_1_Eb.png"></div>
<center><font size="2">Fig.3 The average signal energy per bit.</font></center>
<br><br><br>

![Fig.4 The theoretical SER and simulated SER][4]
<center><font size="2">Fig.4 The theoretical SER and simulated SER</font></center>

<h3 id="grey-question-4ASK-Discussion"><a href="#grey-question-4ASK-Discussion" class="headerlink" title=":grey_question: 4ASK Discussion"></a><span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4ASK Discussion</h3><blockquote>
<p>Using carrier wave to transmit information is different from baseband transmission. Carrier-modulated digital transmission moves the frequency of the signal carrying the information to the frequency band of the signal.<br>The baseband signal waveform is multiplied by the sine carrier, and the frequency spectrum of the baseband signal is shifted by an amount of fc, and thus the signal is placed in the bandwidth of the channel.<br>First map the 10-bit learning sequence to a binary number according to the law, and then change the corresponding amplitude according to the 4ASK mapping relationship. After sampling the baseband signal with fs=1000Hz, it is multiplied by the 5Hz sine carrier, and it is found that only the amplitude has occurred in the time domain. Change, the frequency has shifted in the frequency spectrum.</p>
</blockquote>
<h2 id="blue-book-4PSK"><a href="#blue-book-4PSK" class="headerlink" title=":blue_book: 4PSK"></a><span class="github-emoji"><span>📘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4PSK</h2><h3 id="u-m-t-sqrt-frac-2E-s-Tcos-2-pi-f-c-t-frac-2-pi-m-4-frac-pi-4-m-1-2-3-…-M"><a href="#u-m-t-sqrt-frac-2E-s-Tcos-2-pi-f-c-t-frac-2-pi-m-4-frac-pi-4-m-1-2-3-…-M" class="headerlink" title="$u{m}(t) = \sqrt \frac {2E{s}}Tcos(2\pi f_{c}t+\frac{2\pi m}4+\frac \pi 4),m=1,2,3,…,M$"></a>$u<em>{m}(t) = \sqrt \frac {2E</em>{s}}Tcos(2\pi f_{c}t+\frac{2\pi m}4+\frac \pi 4),m=1,2,3,…,M$</h3><p>where the average signal energy Es=1, T=1, fc=5Hz, and the constellation diagram is:</p>
<h3 id="s-m-sqrt-E-s-cos-frac-2-pi-m-4-frac-pi-4-sqrt-E-s-sin-frac-2-pi-m-4-frac-pi-4"><a href="#s-m-sqrt-E-s-cos-frac-2-pi-m-4-frac-pi-4-sqrt-E-s-sin-frac-2-pi-m-4-frac-pi-4" class="headerlink" title="$s{m}=(\sqrt{E{s}}cos(\frac{2\pi m}4+\frac \pi 4),\sqrt{E_{s}}sin(\frac{2\pi m}4+\frac \pi 4))$"></a>$s<em>{m}=(\sqrt{E</em>{s}}cos(\frac{2\pi m}4+\frac \pi 4),\sqrt{E_{s}}sin(\frac{2\pi m}4+\frac \pi 4))$</h3><p><em>(1) If the message bits are 11 00 10 00 01, plot the corresponding 4PSK signal in both time and frequency domain, sampling frequency fs=1000Hz.<br>(2) Plot the constellation diagram of the 4PSK experiencing the AWGN channel with N0=0.5. (You can generate a large number of 4PSK signals and noise samples.)<br>(3) Give the BER and SER for N0=0.5, from theoretical calculation and numerical simulation, respectively.</em></p>
<h3 id="memo-4PSK-Code"><a href="#memo-4PSK-Code" class="headerlink" title=":memo: 4PSK Code"></a><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4PSK Code</h3><ul>
<li>4PSK.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Consider the following 4PSK modulation.</span></span><br><span class="line"> </span><br><span class="line">clear;</span><br><span class="line">clc;</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(1)</span></span><br><span class="line"><span class="comment">% Plot the corresponding 4PSK signal.</span></span><br><span class="line">T = <span class="number">1</span>;                  <span class="comment">% Symbol interval.</span></span><br><span class="line">Es = <span class="number">1</span>;                 <span class="comment">% Energy of every symbol.</span></span><br><span class="line">Tb = T/<span class="number">2</span>;               <span class="comment">% Bit interval.</span></span><br><span class="line">m = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];          <span class="comment">% Equally spaced.</span></span><br><span class="line">M = <span class="number">4</span>;                  <span class="comment">% 4PSK:M=4</span></span><br><span class="line">fc = <span class="number">5</span>;                 <span class="comment">% Carrier frequency.</span></span><br><span class="line">fs = <span class="number">1000</span>;              <span class="comment">% Sampling frequency.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Message bits.</span></span><br><span class="line">N = <span class="number">5</span>;</span><br><span class="line">Sig = [<span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];</span><br><span class="line"><span class="comment">% Mapping.</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="number">2</span>:<span class="built_in">length</span>(Sig)</span><br><span class="line">    <span class="keyword">if</span>(Sig(<span class="built_in">i</span>)==<span class="number">0</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">0</span>)</span><br><span class="line">        phase_m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = m(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">elseif</span>(Sig(<span class="built_in">i</span>)==<span class="number">0</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">1</span>)</span><br><span class="line">        phase_m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = m(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">elseif</span>(Sig(<span class="built_in">i</span>)==<span class="number">1</span>&amp;&amp;Sig(<span class="built_in">i</span>+<span class="number">1</span>)==<span class="number">1</span>)</span><br><span class="line">        phase_m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = m(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        phase_m(<span class="built_in">fix</span>(<span class="built_in">i</span>/<span class="number">2</span>)+<span class="number">1</span>) = m(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Sampling.</span></span><br><span class="line">[t,x] = Sampling(T,fs,phase_m);</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="number">1</span>:N*T*fs</span><br><span class="line">    u_m(<span class="built_in">i</span>) =<span class="built_in">sqrt</span>(<span class="number">2</span>*Es/T)*<span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*fc*<span class="built_in">i</span>/fs+<span class="number">2</span>*<span class="built_in">pi</span>*x(<span class="built_in">i</span>)/<span class="number">4</span>+<span class="built_in">pi</span>/<span class="number">4</span>); </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">% T2F.</span></span><br><span class="line">[sf,U_m]=T2F(t,u_m);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Plotting commands follow.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_m);</span><br><span class="line">title(<span class="string">'Time domain'</span>)</span><br><span class="line">xlabel(<span class="string">'t/s'</span>)</span><br><span class="line">ylabel(<span class="string">'u\_m(t)'</span>)</span><br><span class="line"><span class="built_in">figure</span>(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">plot</span>(sf,<span class="built_in">abs</span>(U_m));</span><br><span class="line">title(<span class="string">'Frequency domain'</span>)</span><br><span class="line">xlabel(<span class="string">'f/Hz'</span>)</span><br><span class="line">ylabel(<span class="string">'U\_m'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(2)</span></span><br><span class="line"><span class="comment">% Plot the constellation diagram.</span></span><br><span class="line">N0 = <span class="number">0.5</span>;</span><br><span class="line">nc=<span class="built_in">sqrt</span>(N0/<span class="number">2</span>)*<span class="built_in">randn</span>(<span class="number">5000</span>,<span class="number">1</span>);</span><br><span class="line">ns=<span class="built_in">sqrt</span>(N0/<span class="number">2</span>)*<span class="built_in">randn</span>(<span class="number">5000</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="number">1</span>:N*T*fs</span><br><span class="line">    Sm_x(<span class="built_in">i</span>) = <span class="built_in">sqrt</span>(Es)*<span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*x(<span class="built_in">i</span>)/<span class="number">4</span>+<span class="built_in">pi</span>/<span class="number">4</span>)+nc(<span class="built_in">i</span>);</span><br><span class="line">    Sm_y(<span class="built_in">i</span>) = <span class="built_in">sqrt</span>(Es)*<span class="built_in">sin</span>(<span class="number">2</span>*<span class="built_in">pi</span>*x(<span class="built_in">i</span>)/<span class="number">4</span>+<span class="built_in">pi</span>/<span class="number">4</span>)+ns(<span class="built_in">i</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Plotting commands follow.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="number">1</span>:<span class="number">5000</span></span><br><span class="line">    <span class="keyword">if</span>(x(<span class="built_in">i</span>)==<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">plot</span>(Sm_x(<span class="built_in">i</span>),Sm_y(<span class="built_in">i</span>),<span class="string">'r*'</span>)</span><br><span class="line">        <span class="built_in">hold</span> on;</span><br><span class="line">    <span class="keyword">elseif</span>(x(<span class="built_in">i</span>)==<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">plot</span>(Sm_x(<span class="built_in">i</span>),Sm_y(<span class="built_in">i</span>),<span class="string">'g+'</span>)</span><br><span class="line">        <span class="built_in">hold</span> on;</span><br><span class="line">    <span class="keyword">elseif</span>(x(<span class="built_in">i</span>)==<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">plot</span>(Sm_x(<span class="built_in">i</span>),Sm_y(<span class="built_in">i</span>),<span class="string">'b.'</span>)</span><br><span class="line">        <span class="built_in">hold</span> on;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">plot</span>(Sm_x(<span class="built_in">i</span>),Sm_y(<span class="built_in">i</span>),<span class="string">'c.'</span>)</span><br><span class="line">        <span class="built_in">hold</span> on;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    axis square</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">title(<span class="string">'The constellation diagram of the 4PSK'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(3)</span></span><br><span class="line"><span class="comment">% BER and SER.</span></span><br><span class="line"> </span><br><span class="line">N=<span class="number">100000</span>;</span><br><span class="line">Eb=Es/<span class="number">2</span>;</span><br><span class="line">SNR = Eb/N0;</span><br><span class="line">sgma=<span class="built_in">sqrt</span>(Es/SNR/<span class="number">4</span>);            <span class="comment">% noise variance</span></span><br><span class="line"><span class="comment">% The signal mapping.</span></span><br><span class="line">s00=[<span class="number">1</span> <span class="number">1</span>]\<span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line">s01=[<span class="number">-1</span> <span class="number">1</span>]\<span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line">s11=[<span class="number">-1</span> <span class="number">-1</span>]\<span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line">s10=[<span class="number">1</span> <span class="number">-1</span>]\<span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">% Generation of the data source.</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:N</span><br><span class="line">  temp=<span class="built_in">rand</span>;                <span class="comment">% a uniform random variable between 0 and 1</span></span><br><span class="line">  <span class="keyword">if</span> (temp&lt;<span class="number">0.25</span>)            <span class="comment">% With probability 1/4, source output is "00."</span></span><br><span class="line">    dsource1(<span class="built_in">i</span>)=<span class="number">0</span>;</span><br><span class="line">    dsource2(<span class="built_in">i</span>)=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">elseif</span> (temp&lt;<span class="number">0.5</span>)         <span class="comment">% With probability 1/4, source output is "01."</span></span><br><span class="line">    dsource1(<span class="built_in">i</span>)=<span class="number">0</span>;</span><br><span class="line">    dsource2(<span class="built_in">i</span>)=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">elseif</span> (temp&lt;<span class="number">0.75</span>)        <span class="comment">% With probability 1/4, source output is "11."</span></span><br><span class="line">    dsource1(<span class="built_in">i</span>)=<span class="number">1</span>;  </span><br><span class="line">    dsource2(<span class="built_in">i</span>)=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span>                      <span class="comment">% With probability 1/4, source output is "10."</span></span><br><span class="line">    dsource1(<span class="built_in">i</span>)=<span class="number">1</span>;</span><br><span class="line">    dsource2(<span class="built_in">i</span>)=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">% Detection and the probability of error calculation.</span></span><br><span class="line">numofsymbolerror=<span class="number">0</span>;</span><br><span class="line">numofbiterror=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:N</span><br><span class="line">  <span class="comment">% The received signal at the detector, for the ith symbol, is:</span></span><br><span class="line">  n(<span class="number">1</span>)=gngauss(sgma);         </span><br><span class="line">  n(<span class="number">2</span>)=gngauss(sgma);</span><br><span class="line">  <span class="keyword">if</span> ((dsource1(<span class="built_in">i</span>)==<span class="number">0</span>) &amp;&amp; (dsource2(<span class="built_in">i</span>)==<span class="number">0</span>))</span><br><span class="line">    r=s00+n;</span><br><span class="line">  <span class="keyword">elseif</span> ((dsource1(<span class="built_in">i</span>)==<span class="number">0</span>) &amp;&amp; (dsource2(<span class="built_in">i</span>)==<span class="number">1</span>))</span><br><span class="line">    r=s01+n;</span><br><span class="line">  <span class="keyword">elseif</span> ((dsource1(<span class="built_in">i</span>)==<span class="number">1</span>) &amp;&amp; (dsource2(<span class="built_in">i</span>)==<span class="number">1</span>))</span><br><span class="line">    r=s11+n;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    r=s10+n;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">% The correlation metrics are computed below.</span></span><br><span class="line">  c00=<span class="built_in">dot</span>(r,s00);</span><br><span class="line">  c01=<span class="built_in">dot</span>(r,s01);</span><br><span class="line">  c11=<span class="built_in">dot</span>(r,s11);</span><br><span class="line">  c10=<span class="built_in">dot</span>(r,s10);</span><br><span class="line">  <span class="comment">% The decision on the ith symbol is made next.</span></span><br><span class="line">  c_max=<span class="built_in">max</span>([c00 c01 c11 c10]);</span><br><span class="line">  <span class="keyword">if</span> (c00==c_max)</span><br><span class="line">    decis1=<span class="number">0</span>; decis2=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">elseif</span> (c01==c_max)</span><br><span class="line">    decis1=<span class="number">0</span>; decis2=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">elseif</span> (c11==c_max)</span><br><span class="line">    decis1=<span class="number">1</span>; decis2=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    decis1=<span class="number">1</span>; decis2=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">% Increment the error counter, if the decision is not correct.</span></span><br><span class="line">  symbolerror=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (decis1~=dsource1(<span class="built_in">i</span>))</span><br><span class="line">    numofbiterror=numofbiterror+<span class="number">1</span>;</span><br><span class="line">    symbolerror=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span> (decis2~=dsource2(<span class="built_in">i</span>))</span><br><span class="line">    numofbiterror=numofbiterror+<span class="number">1</span>;</span><br><span class="line">    symbolerror=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span> (symbolerror==<span class="number">1</span>)</span><br><span class="line">    numofsymbolerror = numofsymbolerror+<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">% Since there are totally N symbols.</span></span><br><span class="line">ps=numofsymbolerror/N</span><br><span class="line"><span class="comment">% Since 2N bits are transmitted.</span></span><br><span class="line">pb=numofbiterror/(<span class="number">2</span>*N)</span><br><span class="line"> </span><br><span class="line">theo_err_prb=Qfunct(<span class="built_in">sqrt</span>(<span class="number">2</span>*SNR))    <span class="comment">% Theoretical bit-error rate.</span></span><br><span class="line">theo_err_sym=theo_err_prb*<span class="number">2</span>         <span class="comment">% Theoretical symbol-error rate.</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="chart-4PSK-Fig"><a href="#chart-4PSK-Fig" class="headerlink" title=":chart: 4PSK Fig"></a><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4PSK Fig</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/ASK_PSK/4PSK_Time_domain.png" alt="Fig.5 Message bits in Time domain(4PSK)."></p>
<center><font size="2">Fig.5 Message bits in Time domain(4PSK).</font></center>
<br><br><br>

![Fig.6 Message bits in Frequency domain(4PSK).][6]
<center><font size="2">Fig.6 Message bits in Frequency domain(4PSK).</font></center>
<br><br><br>

![Fig.7 The constellation diagram of the 4PSK.][7]
<center><font size="2">Fig.7 The constellation diagram of the 4PSK.</font></center>
<br><br><br>

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/ASK_PSK/lab6_2_theoretical_calculation_and_numerical_simulation.png"></div>
<center><font size="2">Fig.8 BER and SER(theoretical calculation and numerical simulation).</font></center>

<h3 id="grey-question-4PSK-Discussion"><a href="#grey-question-4PSK-Discussion" class="headerlink" title=":grey_question: 4PSK Discussion"></a><span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4PSK Discussion</h3><blockquote>
<p>In carrier phase modulation, the signal to be transmitted through a communication channel is embedded in the phase of the carrier, and the information sequence is binary-coded and mapped to the corresponding phase. Each piece of data corresponds to a phase. The amplitude does not change, but it changes. Initial phase.<br>When the phase of the two bits of information undergoes a sudden change, the time-domain waveform will also undergo a sudden change. The reason is the discontinuity of the phase, which may cause bit errors during demodulation.<br>In the constellation diagram, we can see that the PSK signal will drift due to noise. If the noise is too large, a large number of signals will drift to other phase points, causing an increase in the bit error rate.</p>
</blockquote>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>Matlab</tag>
      </tags>
  </entry>
  <entry>
    <title>华为2024暑期实习笔试</title>
    <url>/2024/04/18/HUAWEI20240417/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>2024.04.17笔试</p>
<ol>
<li>打卡题，队列和字符串模拟/栈模拟</li>
<li>DFS/BFS</li>
<li>Dijkstra算法</li>
</ol>
<span id="more"></span>
<hr>
<h2 id="1-扑克牌消除"><a href="#1-扑克牌消除" class="headerlink" title="1. 扑克牌消除"></a>1. 扑克牌消除</h2><p>从一副扑克牌中随机抽取n张牌组成一个序列，规定连续3张相同牌号的卡牌可以消除，剩余卡牌按照当前顺序重新合并成新的序列后继续消除，重复以上步骤直到无法消除，最后请输出结束后剩余的卡牌序列。注:存在连续4张相同牌号的情况，消除后剩余一张。</p>
<h3 id="1-1-输入描述"><a href="#1-1-输入描述" class="headerlink" title="1.1 输入描述"></a>1.1 输入描述</h3><p>第一行一个正整数$n(1≤n≤52)$，表示卡牌的数量。<br>第二行一个字符串，以空格分隔代表卡牌号序列，卡牌号仅包含$2-10, A, J, Q, K$。</p>
<h3 id="1-2-输出描述"><a href="#1-2-输出描述" class="headerlink" title="1.2 输出描述"></a>1.2 输出描述</h3><p>一个字符串，打印最终结束后的卡牌号序列，卡牌号以空格分隔。如果最终没有卡牌剩余输出0。</p>
<h3 id="1-3-输入样例1"><a href="#1-3-输入样例1" class="headerlink" title="1.3 输入样例1"></a>1.3 输入样例1</h3><h4 id="1-3-1-输入1"><a href="#1-3-1-输入1" class="headerlink" title="1.3.1 输入1"></a>1.3.1 输入1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">10</span><br><span class="line">3 A 2 2 2 A A 7 7 7</span><br></pre></td></tr></tbody></table></figure>
<h4 id="1-3-2-输出1"><a href="#1-3-2-输出1" class="headerlink" title="1.3.2 输出1"></a>1.3.2 输出1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">3</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br>第一轮三个卡牌2连续消除，剩余卡牌号序列为：3 A A A 7 7 7<br>第二轮三个卡牌A连续消除，剩余卡牌号序列为：3 7 7 7<br>第三轮三个卡牌7连续消除，剩余卡牌号序列为：3<br>输出卡牌号序列:3</p>
</blockquote>
<h3 id="1-4-输入样例2"><a href="#1-4-输入样例2" class="headerlink" title="1.4 输入样例2"></a>1.4 输入样例2</h3><h4 id="1-4-1-输入2"><a href="#1-4-1-输入2" class="headerlink" title="1.4.1 输入2"></a>1.4.1 输入2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">8</span><br><span class="line">A 2 2 2 3 3 2 A</span><br></pre></td></tr></tbody></table></figure>
<h4 id="1-4-2-输出2"><a href="#1-4-2-输出2" class="headerlink" title="1.4.2 输出2"></a>1.4.2 输出2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">A 3 3 2 A</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br>第一轮三个卡牌2连续消除，剩余卡牌号序列为：A 3 3 2 A<br>输出卡牌号序列：A 3 3 2 A</p>
</blockquote>
<h3 id="1-5-输入样例3"><a href="#1-5-输入样例3" class="headerlink" title="1.5 输入样例3"></a>1.5 输入样例3</h3><h4 id="1-5-1-输入3"><a href="#1-5-1-输入3" class="headerlink" title="1.5.1 输入3"></a>1.5.1 输入3</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">6</span><br><span class="line">2 3 3 3 2 2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="1-5-2-输出3"><a href="#1-5-2-输出3" class="headerlink" title="1.5.2 输出3"></a>1.5.2 输出3</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">0</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br>第一轮三个卡牌3连续消除，剩余卡牌号序列为：2 2 2<br>第二轮三个卡牌2连续消除，无剩余卡牌<br>输出卡牌号序列：0</p>
</blockquote>
<h3 id="1-6-解题思路"><a href="#1-6-解题思路" class="headerlink" title="1.6 解题思路"></a>1.6 解题思路</h3><ul>
<li>如果长度小于2直接返回，不需要处理<code>in.nextLine().toCharArray()</code></li>
<li>把所有字符存到<code>String[]</code>数组</li>
<li>依次将<code>String[]</code>数组的每个值<code>s</code>放入队列<code>queue</code><ul>
<li>判断<code>queue.size()&gt;=2</code><ul>
<li>若是，则更新此时队列尾部最后两个值，<code>first</code>和<code>second</code>,然后队尾加入</li>
<li>若不是，则直接队尾加入<code>queue.offerLast(s);</code></li>
</ul>
</li>
<li>判断最后三个值是否相等（要用<code>.equals()</code>），如果相等则<code>queue.pollLast();</code>三次</li>
</ul>
</li>
<li>用<code>StringBuilder</code>依次拿到队列中所有字符<ul>
<li>如果队列为空，直接打印<code>0</code></li>
<li>注意空格的处理<code>if(i&lt;length-1) sb.append(' ');</code></li>
</ul>
</li>
<li>也可以用<code>char[]</code>，但要注意有一个卡牌<code>10</code>，字符只能存一位，所以要有个替代的过程</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> Integer.parseInt(in.nextLine().split(<span class="string">" "</span>)[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span>(n&lt;=<span class="number">2</span>){</span><br><span class="line">            System.out.println(in.nextLine().toString());</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        String[] strs = in.nextLine().split(<span class="string">" "</span>);</span><br><span class="line">        LinkedList&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> <span class="string">"1"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">second</span> <span class="operator">=</span> <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">for</span>(String s: strs){</span><br><span class="line">            <span class="keyword">if</span>(queue.size()&gt;=<span class="number">2</span>){</span><br><span class="line">                second = queue.pollLast();</span><br><span class="line">                first = queue.peekLast();</span><br><span class="line">                queue.offerLast(second);</span><br><span class="line">            }</span><br><span class="line">            queue.offerLast(s);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(s.equals(first) &amp;&amp; s.equals(second) &amp;&amp; queue.size()&gt;=<span class="number">3</span>){</span><br><span class="line">                queue.pollLast();</span><br><span class="line">                queue.pollLast();</span><br><span class="line">                queue.pollLast();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> queue.size();</span><br><span class="line">        <span class="keyword">if</span>(length==<span class="number">0</span>){</span><br><span class="line">            System.out.println(<span class="string">"0"</span>);</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++){</span><br><span class="line">            <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> queue.pollFirst();</span><br><span class="line">            sb.append(temp);</span><br><span class="line">            <span class="keyword">if</span>(i&lt;length-<span class="number">1</span>) sb.append(<span class="string">' '</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">        in.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-计算云服务DI值"><a href="#2-计算云服务DI值" class="headerlink" title="2. 计算云服务DI值"></a>2. 计算云服务DI值</h2><p>我们将云服务看做一棵树，每个云服务在发布前尚未解决的问题称为云服务的遗留问题（云服务的遗留问题包含以该云服务为根节点的树上所有节点的问题），DI值（遗留问题缺陷密度）可以作为评估云服务发布的指标，当云服务DI值小于等于阈值时才准许云服务发布，否则视为风险云服务，需要问题整改完成后重新进行发布评估。现有一批云服务树，已给出云服务树各节点的问题数量，请通过计算输出风险云服务的个数。<br>计算公式：$DI值≤5<em>严重问题数+2</em>一般问题数$，其中每个节点的不同级别问题数量需要将该节点及该节点为根节点的所有子节点的相应级别问题数量求和。</p>
<h3 id="2-1-输入描述"><a href="#2-1-输入描述" class="headerlink" title="2.1 输入描述"></a>2.1 输入描述</h3><p>第一行输入$M$和$N(M≤100000，N≤1000)$，使用空格分隔，$M$表示代表云服务阈值, $N$表示接下来有$N$行问题统计数据；接下来输入一个$N<em>4$的矩阵表，行内使用空格分隔，第一列$Ai$为服务节点，第二列$Bi$为$Ai$的父节点，如果$Ai$为云服务则无父节点，此时$Bi$用$</em>$号表示($Ai$和$Bi$取值为字符串，$1≤字符串长度≤5$，均由小写英文字母或$*$号组成)，第三列$Ci$为问题级别($Ci$取值为${0,1}$，0表示严重问题，1表示一般问题)，第四列$Di$为该节点该级别的问题数量($Di≤1000$).<br>说明：输入保证只出现树的关系，不会出现连通图的情况。</p>
<h3 id="2-2-输出描述"><a href="#2-2-输出描述" class="headerlink" title="2.2 输出描述"></a>2.2 输出描述</h3><p>风险云服务个数</p>
<h3 id="2-3-输入样例1"><a href="#2-3-输入样例1" class="headerlink" title="2.3 输入样例1"></a>2.3 输入样例1</h3><h4 id="2-3-1-输入1"><a href="#2-3-1-输入1" class="headerlink" title="2.3.1 输入1"></a>2.3.1 输入1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">40 12</span><br><span class="line">a * 0 2</span><br><span class="line">a * 1 2</span><br><span class="line">b a 0 3</span><br><span class="line">b a 1 5</span><br><span class="line">c a 1 3</span><br><span class="line">d a 0 1</span><br><span class="line">d a 1 3</span><br><span class="line">e b 0 2</span><br><span class="line">f * 0 8</span><br><span class="line">f * 1 10</span><br><span class="line">g f 1 2 </span><br><span class="line">h * 0 4</span><br></pre></td></tr></tbody></table></figure>
<h4 id="2-3-2-输出1"><a href="#2-3-2-输出1" class="headerlink" title="2.3.2 输出1"></a>2.3.2 输出1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">2</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br><code>a * 0 2</code>表示节点a有2个严重问题，$<em>$表示无父节点，即a为云服务。<br><code>b a 1 5</code>表示节点b有5个一般问题，b的父节点是$a$<br>可以看出，该样例有3个云服务a、f、h。<br>云服务a的子节点有b、c、d、e，严重问题个数为$2+3+0+1+2=8$，一般问题个数为$2+5+3+3+0=13$，$DI值=8</em>5+13<em>2=66&gt;阈值40$，故云服务a是风险云服务；<br>云服务f严重问题个数为$8+0=8$，一般问题个数为$10+2=12$，$D值=8</em>5+12<em>2=64&gt;阈值40$，故云服务f也是风险云服务;<br>云服务h严重问题个数为$4$,一般问题个数为$0$，$DI值=4</em>5+0*2=20&lt;=阈值40$，故云服务h不是风险云服务;<br>因此该样例有2个风险云服务。</p>
</blockquote>
<h3 id="2-4-输入样例2"><a href="#2-4-输入样例2" class="headerlink" title="2.4 输入样例2"></a>2.4 输入样例2</h3><h4 id="2-4-1-输入2"><a href="#2-4-1-输入2" class="headerlink" title="2.4.1 输入2"></a>2.4.1 输入2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">50 10</span><br><span class="line">b a 1 5</span><br><span class="line">a * 0 2</span><br><span class="line">b a 0 3</span><br><span class="line">c a 1 3</span><br><span class="line">d a 0 1</span><br><span class="line">a * 1 2</span><br><span class="line">d a 1 3</span><br><span class="line">e b 0 2</span><br><span class="line">f b 1 1</span><br><span class="line">g c 1 2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="2-4-2-输出2"><a href="#2-4-2-输出2" class="headerlink" title="2.4.2 输出2"></a>2.4.2 输出2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br><code>a * 0 2</code>表示节点a有2个严重问题，$<em>$表示无父节点，即a为云服务。<br><code>b a 1 5</code>表示节点b有5个一般问题，b的父节点是$a$<br>可以看出，该样例只有1个云服务a。<br>严重问题个数为$2+3+0+1+2+0+0=8$，一般问题个数为$2+5+3+3+0+1+2=16$，$DI值=8</em>5+16*2=72&gt;阈值50$，故云服务a是风险云服务；<br>因此该样例有1个风险云服务。</p>
</blockquote>
<h3 id="2-5-解题思路"><a href="#2-5-解题思路" class="headerlink" title="2.5 解题思路"></a>2.5 解题思路</h3><ul>
<li>看起来很复杂，但其实就是构建树，对每棵树上每个节点的一般问题和严重问题进行统计，然后加权计算风险值</li>
<li>用两个cnt的map存每个节点一般问题和严重问题数量</li>
<li>用一个parent的map存节点和父节点的关系<ul>
<li>向上迭代找到每个节点的根节点，将当前节点的两个cnt加到根节点上</li>
</ul>
</li>
<li>用一个set存根节点<ul>
<li>遍历根节点，从两个cnt中拿到值进行加权计算判断超出范围的根节点有多少</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> PastPapers.HUAWEI0417.Q2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        String[] mn = in.nextLine().split(<span class="string">" "</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> Integer.parseInt(mn[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> Integer.parseInt(mn[<span class="number">1</span>]);</span><br><span class="line">        Map&lt;String, String&gt; parent = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();   <span class="comment">// 记录节点的父节点</span></span><br><span class="line">        Map&lt;String, Integer&gt; cnt1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();    <span class="comment">// 记录节点的值为0的个数</span></span><br><span class="line">        Map&lt;String, Integer&gt; cnt2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();    <span class="comment">// 记录节点的值为1的个数</span></span><br><span class="line">        Set&lt;String&gt; st = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();               <span class="comment">// 记录根节点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// process input</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            String[] strs = in.nextLine().split(<span class="string">" "</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> strs[<span class="number">0</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">v</span> <span class="operator">=</span> strs[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> Integer.parseInt(strs[<span class="number">2</span>]);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> Integer.parseInt(strs[<span class="number">3</span>]);</span><br><span class="line">            <span class="comment">// 判断父节点还是子节点</span></span><br><span class="line">            <span class="keyword">if</span>(v.equals(<span class="string">"*"</span>)){</span><br><span class="line">                <span class="comment">// st存的是每一棵树的根节点</span></span><br><span class="line">                st.add(u);</span><br><span class="line">                <span class="keyword">if</span>(x == <span class="number">0</span>) cnt1.put(u, cnt1.getOrDefault(u, <span class="number">0</span>)+y);</span><br><span class="line">                <span class="keyword">else</span> cnt2.put(u, cnt2.getOrDefault(u, <span class="number">0</span>)+y);</span><br><span class="line">            } <span class="keyword">else</span>{</span><br><span class="line">                <span class="comment">//记录节点u的父节点是v</span></span><br><span class="line">                parent.put(u, v);</span><br><span class="line">                <span class="keyword">if</span>(x == <span class="number">0</span>) cnt1.put(u, cnt1.getOrDefault(u, <span class="number">0</span>)+y);</span><br><span class="line">                <span class="keyword">else</span> cnt2.put(u, cnt2.getOrDefault(u, <span class="number">0</span>)+y);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update 每个节点的0和1的个数到根节点上</span></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry: parent.entrySet()){</span><br><span class="line">            <span class="comment">// 遍历所有非根节点，也就是遍历parent,拿到entry</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="comment">// 向上找到根节点</span></span><br><span class="line">            <span class="keyword">while</span> (parent.containsKey(u)){</span><br><span class="line">                u = parent.get(u);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 更新根节点的cnt1和cnt2</span></span><br><span class="line">            cnt1.put(u, cnt1.getOrDefault(u, <span class="number">0</span>)+cnt1.getOrDefault(entry.getKey(), <span class="number">0</span>));</span><br><span class="line">            cnt2.put(u, cnt2.getOrDefault(u, <span class="number">0</span>)+cnt2.getOrDefault(entry.getKey(), <span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// iterate the root node</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(String s: st){</span><br><span class="line">            <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">5</span> * cnt1.getOrDefault(s, <span class="number">0</span>) + <span class="number">2</span> * cnt2.getOrDefault(s, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>(val &gt; m) ans++;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        System.out.println(ans);</span><br><span class="line">        in.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-云上故障逃生"><a href="#3-云上故障逃生" class="headerlink" title="3. 云上故障逃生"></a>3. 云上故障逃生</h2><p>在云上多个业务节点之间选择最快的逃生节点集，并考虑每个节点的剩余业务容量。有一个网络时延表，表示每个节点到其他节点的通信延迟;还有一个剩余业务容量表，表示每个节点的剩余业务容量。在一个节点故障时，需要选择一个或多个逃生节点，确保逃生路径的时延最小，并且逃生节点集各节点剩余容量的总和足够容纳故障节点的业务量，当故障节点与多个节点最短距离相同，优先选择编号较小的节点容灾，如果逃生节点集中多个节点最短距离相同时按编号从小到大的顺序排列。</p>
<h3 id="3-1-输入描述"><a href="#3-1-输入描述" class="headerlink" title="3.1 输入描述"></a>3.1 输入描述</h3><ul>
<li>第1行n表示云上业务节点数，$2&lt;=n&lt;=10000$，节点编号从0开始，依次递增；</li>
<li>第2到1+n行表示业务节点间的网络时延矩阵表$delayMatrix$，$delayMatrix[i][j]$表示节点$i$到节点$j$的通信时延;<ul>
<li>如果节点$i$和节点$j$之间没有直接相连的边，则$delayMatrix[i][j]$为$-1$，第个$i$节点和它自己也没有边，所以$delayMatrix[i][i]=-1$</li>
<li>节点间有边时延范围为$1&lt;=delayMatrix[i][j]&lt;=1000$，矩阵元素间使用空格分割</li>
<li>另，输入保证$delayMatrix[i][j] == delayMatrix[j][i]$</li>
</ul>
</li>
<li>第2+n行表示各业务节点的剩余容量表$remainingCapacity$，其中$remainingCapacity[i]$表示节点$i$的剩余业务容量，业务量的范围$1&lt;=remmainingCapacity[i]&lt;=100$，数组元素间使用空格分割;</li>
<li>第3+n行表示故障业务节点编号$faultyNode$，表示发生故障的节点，取值范围为$0&lt;=faultyNode&lt;=n-1$</li>
<li>第4+n行表示受损业务节点需要迁移的业务量，受损业务量的范围$(0- 1000]$。</li>
</ul>
<h3 id="3-2-输出描述"><a href="#3-2-输出描述" class="headerlink" title="3.2 输出描述"></a>3.2 输出描述</h3><p>返回符合条件的逃生路径节点编号列表(以单空格间隔)，当所有节点都不够故障节点业务容灾的时候输出所有容灾节点。</p>
<h3 id="3-3-输入样例1"><a href="#3-3-输入样例1" class="headerlink" title="3.3 输入样例1"></a>3.3 输入样例1</h3><h4 id="3-3-1-输入1"><a href="#3-3-1-输入1" class="headerlink" title="3.3.1 输入1"></a>3.3.1 输入1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4</span><br><span class="line">-1 5 -1 8</span><br><span class="line">5 -1 1 3</span><br><span class="line">-1 1 -1 4</span><br><span class="line">8 3 4 -1</span><br><span class="line">10 20 15 25</span><br><span class="line">2</span><br><span class="line">12</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-3-2-输出1"><a href="#3-3-2-输出1" class="headerlink" title="3.3.2 输出1"></a>3.3.2 输出1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-3-3-解释1"><a href="#3-3-3-解释1" class="headerlink" title="3.3.3 解释1"></a>3.3.3 解释1</h4><div><div class="graphviz">digraph G {
    rankdir=TB;
    ranksep=0.5;
    nodesep=1.5;
    {
        rank=same; 0; 1;
    }
    {
        rank=same; 2; 3;
    }

    0 [label="Node 0\n10", fillcolor=lightblue, style=filled];
    1 [label="Node 1\n20", fillcolor=lightblue, style=filled];
    2 [label="Node 2\n15", fillcolor=red, style=filled];
    3 [label="Node 3\n25", fillcolor=lightblue, style=filled];

    0 -&gt; 1 [label="5", dir="both"];
    1 -&gt; 2 [label="1", dir="both"];
    1 -&gt; 3 [label="3", dir="both"];
    0 -&gt; 3 [label="8", dir="both"];
    2 -&gt; 3 [label="4", dir="both"];
}</div></div>

<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Node</th>
<th style="text-align:center">0</th>
<th style="text-align:center">1</th>
<th style="text-align:center">2</th>
<th style="text-align:center">3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">minDist</td>
<td style="text-align:center">6</td>
<td style="text-align:center">1</td>
<td style="text-align:center">∞</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>说明：<br>在给定的测试用例中，假设节点$2$发生故障，需要迁移业务量为$12$<br>离故障节点$2$时延排序为$1,3,0$，故障节点要转移的业务量为$12$，而节点$1$的可容灾余量为$20$，足够容纳故障节点$2$的受灾业务，所以该测试用例的期望输出是<code>1</code>。</p>
</blockquote>
<h3 id="3-4-输入样例2"><a href="#3-4-输入样例2" class="headerlink" title="3.4 输入样例2"></a>3.4 输入样例2</h3><h4 id="3-4-1-输入2"><a href="#3-4-1-输入2" class="headerlink" title="3.4.1 输入2"></a>3.4.1 输入2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4</span><br><span class="line">-1 5 -1 8</span><br><span class="line">5 -1 1 3</span><br><span class="line">-1 1 -1 4</span><br><span class="line">8 3 4 -1</span><br><span class="line">10 20 15 25</span><br><span class="line">2</span><br><span class="line">50</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-4-2-输出2"><a href="#3-4-2-输出2" class="headerlink" title="3.4.2 输出2"></a>3.4.2 输出2</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">1 3 0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-4-3解释2"><a href="#3-4-3解释2" class="headerlink" title="3.4.3解释2"></a>3.4.3解释2</h4><div><div class="graphviz">digraph G {
    rankdir=TB;
    ranksep=0.5;
    nodesep=1.5;
    {
        rank=same; 0; 1;
    }
    {
        rank=same; 2; 3;
    }

    0 [label="Node 0\n10", fillcolor=lightblue, style=filled];
    1 [label="Node 1\n20", fillcolor=lightblue, style=filled];
    2 [label="Node 2\n30", fillcolor=red, style=filled];
    3 [label="Node 3\n25", fillcolor=lightblue, style=filled];

    0 -&gt; 1 [label="5", dir="both"];
    1 -&gt; 2 [label="1", dir="both"];
    1 -&gt; 3 [label="3", dir="both"];
    0 -&gt; 3 [label="8", dir="both"];
    2 -&gt; 3 [label="4", dir="both"];
}</div></div>

<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Node</th>
<th style="text-align:center">0</th>
<th style="text-align:center">1</th>
<th style="text-align:center">2</th>
<th style="text-align:center">3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">minDist</td>
<td style="text-align:center">6</td>
<td style="text-align:center">1</td>
<td style="text-align:center">∞</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>说明：<br>在给定的测试用例中，假设节点$2$发生故障，需要迁移业务量为$50$<br>离故障节点$2$时延排序为$1,3,0$，故障节点要转移的业务量为$12$，而节点$1$的可容灾余量为$20$，不够容纳故障节点$2$的受灾业务$30$，所以还需找离节点$2$次近的节点$3$，节点$3$的可容灾余量为$25$，节点$1$的可容灾余量$20$和节点$3$的可容灾余量$25$的总和为$45$小于故障量$50$，需要增加$0$节点来容灾，节点$0$的容灾余量为$10$，节点$1,3,0$总容灾余量为$55$，大于受灾节点的业务量$50$，所以该测试用例的期望输出是<code>1 3 0</code>。</p>
</blockquote>
<h3 id="3-5-解题思路"><a href="#3-5-解题思路" class="headerlink" title="3.5 解题思路"></a>3.5 解题思路</h3><ul>
<li>主要是用$Dijkstra$算法</li>
</ul>
<ol>
<li>通过<code>Scanner</code>从输入中读取数据。首先读取一个整数<code>n</code>，它表示图中的节点数量。初始化一个二维数组<code>g</code>和一个一维数组<code>cap</code>，<code>g</code>用于存储图的距离的邻接矩阵，<code>cap</code>用于存储每个节点的容量。</li>
<li>读取故障节点<code>nodeIndex</code>和受灾业务容量<code>faulty</code>。</li>
<li>$dijkstra$函数，传入图的邻接矩阵和故障节点的索引，得到从故障节点到其他所有节点的最短路径。结果是一个二维数组<code>res</code>，每个元素是一个包含两个元素的数组，第一个元素是距离，第二个元素是节点索引。</li>
<li>对$dijkstra$的结果进行自定义排序。首先按照距离排序，如果距离相同，则按照节点索引排序。</li>
<li>初始化一个<code>StringBuilder</code>用于存储结果，初始化一个变量<code>sum</code>用于存储累计的容量。</li>
<li>遍历排序后的结果，累加每个节点的容量到<code>sum</code>，并将节点索引添加到 <code>StringBuilder</code>。当<code>sum</code>大于等于<code>faulty</code>时，停止遍历。</li>
<li>删除<code>StringBuilder</code>最后一个字符（一个多余的空格），输出结果。</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> Integer.parseInt(in.nextLine().split(<span class="string">" "</span>)[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span>[][] g = <span class="keyword">new</span> <span class="title class_">int</span>[n][n];</span><br><span class="line">        <span class="type">int</span>[] cap = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            String[] tempDelay = in.nextLine().split(<span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++){</span><br><span class="line">                g[i][j] = Integer.parseInt(tempDelay[j]);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        String[] tempCap = in.nextLine().split(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            cap[i] = Integer.parseInt(tempCap[i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> <span class="variable">nodeIndex</span> <span class="operator">=</span> Integer.parseInt(in.nextLine().split(<span class="string">" "</span>)[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> <span class="variable">faulty</span> <span class="operator">=</span> Integer.parseInt(in.nextLine().split(<span class="string">" "</span>)[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span>[][] res = dijkstra(g, nodeIndex);</span><br><span class="line">        Arrays.sort(res, (a, b)-&gt;a[<span class="number">0</span>]==b[<span class="number">0</span>] ? a[<span class="number">1</span>]-b[<span class="number">1</span>] : a[<span class="number">0</span>]-b[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++){</span><br><span class="line">            sum += cap[res[i][<span class="number">1</span>]];</span><br><span class="line">            ans.append(res[i][<span class="number">1</span>]);</span><br><span class="line">            ans.append(<span class="string">' '</span>);</span><br><span class="line">            <span class="keyword">if</span>(sum&gt;=faulty) <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        ans.deleteCharAt(ans.length()-<span class="number">1</span>);</span><br><span class="line">        System.out.println(ans);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] dijkstra(<span class="type">int</span>[][] g, <span class="type">int</span> s){</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> g.length;</span><br><span class="line">        <span class="type">int</span>[] dist = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        Arrays.fill(dist, Integer.MAX_VALUE);</span><br><span class="line">        dist[s] = <span class="number">0</span>;</span><br><span class="line">        <span class="type">boolean</span>[] vis = <span class="keyword">new</span> <span class="title class_">boolean</span>[n];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++){</span><br><span class="line">                <span class="keyword">if</span>(!vis[j]&amp;&amp;(t==-<span class="number">1</span>||(dist[t]&gt;dist[j]))){</span><br><span class="line">                    t=j;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            vis[t] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; n; j++){</span><br><span class="line">                <span class="keyword">if</span>(g[t][j]&lt;<span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span>(dist[t]+g[t][j]&lt;dist[j]){</span><br><span class="line">                    dist[j] = dist[t]+g[t][j];</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span>[][] res = <span class="keyword">new</span> <span class="title class_">int</span>[n][<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            res[i][<span class="number">0</span>] = dist[i];</span><br><span class="line">            res[i][<span class="number">1</span>] = i;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>LinkedList</tag>
        <tag>UndirectedGraph</tag>
        <tag>BackTrack</tag>
      </tags>
  </entry>
  <entry>
    <title>Latex Grammar</title>
    <url>/2023/02/09/LatexGrammar/</url>
    <content><![CDATA[<p>$LaTeX$ (/ˈlɑːtɛx/ LAH-tekh or /ˈleɪtɛx/ LAY-tekh, often stylized as LATEX) is a <strong>software system</strong> for document preparation. When writing, the writer uses plain text as opposed to the formatted text found in WYSIWYG word processors like Microsoft Word, LibreOffice Writer and Apple Pages. The writer uses <strong>markup tagging conventions</strong> to define the general structure of a document to stylise text throughout a document (such as bold and italics), and to add citations and cross-references. A TeX distribution such as TeX Live or MiKTeX is used to produce an output file (such as PDF or DVI) suitable for printing or digital distribution.</p>
<span id="more"></span>
<hr>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><ul>
<li><p>$ LaTeX $ is widely used in <strong>academia</strong> for the communication and publication of scientific documents in many fields, including <strong>mathematics, computer science, engineering, physics, chemistry, economics, linguistics, quantitative psychology, philosophy, and political science</strong>. It also has a prominent role in the preparation and publication of books and articles that contain complex multilingual materials, such as Arabic and Greek. LaTeX uses the TeX typesetting program for formatting its output, and is itself written in the <strong>$TeX$ macro language</strong>.</p>
</li>
<li><p>$ LaTeX $ can be used as <strong>a standalone document preparation system</strong>, or as <strong>an intermediate format</strong>. In the latter role, for example, it is sometimes used as part of a pipeline for translating <code>DocBook</code> and <code>other XML-based formats</code> to <code>PDF</code>. The typesetting system offers programmable desktop publishing features and extensive facilities for automating most aspects of typesetting and desktop publishing, including <strong>numbering and cross-referencing of tables and figures, chapter and section headings, graphics, page layout, indexing and bibliographies</strong>.</p>
</li>
</ul>
<h2 id="Install-sweat-smile"><a href="#Install-sweat-smile" class="headerlink" title="Install :sweat_smile:"></a>Install <span class="github-emoji"><span>😅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h2><blockquote>
<p>Leave a hole here, and I will attach an installation tutorial when I have time later.<br>Okey, let’s go! I used to use <code>VsCode</code> + <code>TexLive</code>, which is more convenient, because <code>VsCode</code> has a built-in <code>LaTeX Workshop</code> extension, which can be used directly after installation.<br>For the convenience of reading, a seprarate article about installation and use is written, and the link is <a href="https://www.lingzhicheng.cn/2023/03/27/TexLive+VsCode/">here</a>.</p>
</blockquote>
<h2 id="Attention-exclamation"><a href="#Attention-exclamation" class="headerlink" title="Attention:exclamation:"></a>Attention<span class="github-emoji"><span>❗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h2><blockquote>
<p>Before starting, it is important to note that:</p>
<p>$ Markdown $ is rendered as <code>HTML</code> and its syntax conflicts with $ LaTeX $, which affects the effect of the article. E.g. braces should be avoided repeatedly, spaces should be added.</p>
</blockquote>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line">}} <span class="comment">% It's bad.</span></span><br><span class="line">} } <span class="comment">% It's good!</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Formula-Insertion"><a href="#Formula-Insertion" class="headerlink" title="Formula Insertion"></a>Formula Insertion</h2><ul>
<li><p>Formulas are divided into inline formulas and formula blocks, the former is embedded in a line, and the latter is a separate line.</p>
</li>
<li><p>Inline formulas<br>$ f(x) = a+b $</p>
</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span> f(x) = a+b <span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<p>​​​​​</p>
<ul>
<li>Formula blocks</li>
</ul>
<script type="math/tex; mode=display">
x+1 = 2*3</script><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$$</span><br><span class="line">x+1 = 2*3</span><br><span class="line">$$</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Numbering</li>
</ul>
<script type="math/tex; mode=display">
x+1 = 2*3 \tag{1.1}</script><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line">x+1 = 2*3 <span class="keyword">\tag</span>{1.1}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Basic-operations"><a href="#Basic-operations" class="headerlink" title="Basic operations"></a>Basic operations</h2><h3 id="Four-operations-and-brackets"><a href="#Four-operations-and-brackets" class="headerlink" title="Four operations and brackets"></a>Four operations and brackets</h3><blockquote>
<p>The basic four-rule arithmetic can be done directly with the keyboard’s +-*</p>
</blockquote>
<ul>
<li><code>\times</code> stands for $ \times $, <code>\div</code> stands for $ \div $, <code>\cdot</code> stands for $ \cdot $</li>
</ul>
<p>Example: <script type="math/tex">a + b - c*2 + d/e = 5 \times 3 + 8 \div 4 - f \cdot g</script><br>$ a + b - c*2 + d/e = 5 \times 3 + 8 \div 4 - f \cdot g $</p>
<ul>
<li>The curly braces need to be escaped with a slash.</li>
</ul>
<p>Example: <script type="math/tex">(1+2) \quad [1+2] \quad \{1+2\}</script><br>$ (1+2) \quad [1+2] \quad {1+2} $</p>
<ul>
<li>The <code>\left</code> and <code>\right</code> commands are used to generate auto-match height brackets or parenthetical characters.</li>
</ul>
<p>Example: <script type="math/tex">(\dfrac{1}{2})^2 \quad \left( \dfrac{1}{2} \right) ^2</script><br>$ (\dfrac{1}{2})^2 \quad \left( \dfrac{1}{2} \right) ^2 $</p>
<ul>
<li><code>&lt;&gt;</code>, <code>Abs</code> and <code>Norms()</code></li>
</ul>
<script type="math/tex; mode=display">\left\langle \dfrac ab \right\rangle \quad \left| \dfrac ab \right| \quad \left\| \dfrac ab \right\|</script><p>$ \left\langle \dfrac ab \right\rangle \quad \left| \dfrac ab \right| \quad \left| \dfrac ab \right| $</p>
<ul>
<li>Rounding function</li>
</ul>
<script type="math/tex; mode=display">\left\lfloor \dfrac ab \right\rfloor \quad \left\lceil \dfrac ab \right\rceil</script><p>$ \left\lfloor \dfrac ab \right\rfloor \quad \left\lceil \dfrac ab \right\rceil $</p>
<ul>
<li>Slashes with arrows</li>
</ul>
<p><code>\left/ \dfrac ab \right\backslash</code><br>$ \left/ \dfrac ab \right\backslash $</p>
<p><code>\left\uparrow \dfrac ab \right\downarrow \quad \left\Uparrow \dfrac ab \right\Downarrow \quad \left\updownarrow \dfrac ab \right\Updownarrow</code><br>$ \left\uparrow \dfrac ab \right\downarrow \quad \left\Uparrow \dfrac ab \right\Downarrow \quad \left\updownarrow \dfrac ab \right\Updownarrow $</p>
<ul>
<li>Mixed parentheses</li>
</ul>
<p><code>\left[ \dfrac{1}{2}, 1 \right) \quad \left\langle \psi \right|</code><br>$ \left[ \dfrac{1}{2}, 1 \right) \quad \left\langle \psi \right| $</p>
<ul>
<li>Single parentheses</li>
</ul>
<blockquote>
<p>Use <code>\left.</code> or <code>\right.</code> to omit.</p>
</blockquote>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\left</span><span class="keyword">\{</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{l}</span><br><span class="line">x+y=1<span class="keyword">\\</span></span><br><span class="line">x-y=2</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="keyword">\right</span>.</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span> </span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\left\{
\begin{array}{l}
x+y=1\\
x-y=2
\end{array}
\right.</script><script type="math/tex; mode=display">\left. \dfrac ab \right\}</script><p>$ \left. \dfrac ab \right} $</p>
<ul>
<li>The <strong>size</strong> of the brackets</li>
</ul>
<blockquote>
<p>Use <code>\big</code>, <code>\Big</code>, <code>\bigg</code>, <code>\Bigg</code> to control.</p>
</blockquote>
<script type="math/tex; mode=display">\left\{ \left[ \left( \left| \left\| a \right\| +1 \right| -2 \right) +3 \right] -4 \right\}*5</script><p>$ \left{ \left[ \left( \left| \left| a \right| +1 \right| -2 \right) +3 \right] -4 \right}*5 $<br>​</p>
<script type="math/tex; mode=display">\Bigg\{ \bigg[ \Big( \big| \left\| a \right\| +1 \big| -2 \Big) +3 \bigg] -4 \Bigg\}*5</script><p>$ \Bigg{ \bigg[ \Big( \big| \left| a \right| +1 \big| -2 \Big) +3 \bigg] -4 \Bigg}*5 $</p>
<h3 id="Superscript-and-subscript"><a href="#Superscript-and-subscript" class="headerlink" title="Superscript and subscript"></a>Superscript and subscript</h3><ul>
<li>Use <code>_</code> for subscript, <code>^</code> for superscript, and handle only one character, and multiple characters enclosed in <code>{}</code>. <code>'</code> indicates derivation, multiple can be used.</li>
</ul>
<p>Example: <code>x_1^{3,4} + x_{1,2}^{2} = y_0 + y'_{6} + y''</code><br>$ x<em>1^{3,4} + x</em>{1,2}^{2} = y<em>0 + y’</em>{6} + y’’ $</p>
<h3 id="Fractional-and-radical"><a href="#Fractional-and-radical" class="headerlink" title="Fractional and radical"></a>Fractional and radical</h3><ul>
<li>Use <code>frac{a}{b}</code> for fractions, <code>sqrt</code> for square roots, and <code>sqrt[n]</code> for nth roots.</li>
</ul>
<p>Example: <code>\frac{x}{2} + \sqrt x = \sqrt[3] {x^2+y^2}</code><br>$ \frac{x}{2} + \sqrt x = \sqrt[3] {x^2+y^2} $</p>
<h2 id="Symbols-functions-and-special-characters"><a href="#Symbols-functions-and-special-characters" class="headerlink" title="Symbols, functions and special characters"></a>Symbols, functions and special characters</h2><h3 id="Tones-and-markers"><a href="#Tones-and-markers" class="headerlink" title="Tones and markers"></a>Tones and markers</h3><ul>
<li><p>Tones<br><code>\dot{a}</code> $ \dot{a} $<br><code>\ddot{a}</code> $ \ddot{a} $<br><code>\acute{a}</code>  $ \acute{a} $<br><code>\grave{a}</code> $ \grave{a} $<br><code>\check{a}</code> $ \check{a} $<br><code>\breve{a}</code> $ \breve{a} $<br><code>\tilde{a}</code> $ \tilde{a} $<br><code>\widetilde{a}</code> $ \widetilde{a} $<br><code>\bar{a}</code> $ \bar{a} $<br><code>\mathring{a}</code> $ \mathring{a} $</p>
</li>
<li><p>Markers<br><code>\hat{a}</code> $ \hat{a} $<br><code>\widehat{a}</code> $ \widehat{a} $<br><code>\vec{a}</code> $ \vec{a} $</p>
</li>
</ul>
<h3 id="Basic-functions"><a href="#Basic-functions" class="headerlink" title="Basic functions"></a>Basic functions</h3><ul>
<li>Exponential function</li>
</ul>
<p>Example: <code>\exp_a b, \exp b, x^2</code><br>$ \exp_a b, \exp b, x^2 $</p>
<ul>
<li>Logarithm</li>
</ul>
<p>Example: <code>\log a, \lg b, \ln c, \log_{2} d</code><br>$ \log a, \lg b, \ln c, \log_{2} d $</p>
<ul>
<li>Trigonometric function</li>
</ul>
<p>Example: <code>\sin a, \cos b, \tan c, \cot d, \sec e, \csc f</code><br>$ \sin a, \cos b, \tan c, \cot d, \sec e, \csc f $</p>
<ul>
<li>Inverse trigonometric functions</li>
</ul>
<p>Example: <code>\arcsin a, \arccos b, \arctan c</code><br>​​$ \arcsin a, \arccos b, \arctan c $</p>
<blockquote>
<p><code>\arccot</code>, <code>\arcsec</code> and <code>\arccsc</code> in $Latex$ is not defined and can be replaced by <code>\text{arccot}x</code> or <code>\operatorname{function}</code> $—&gt;$ $\text{arccot}x$</p>
</blockquote>
<ul>
<li>Hyperbolic functions</li>
</ul>
<p>Example: <code>\sinh a, \cosh b, \tanh c, \coth d</code><br>$ \sinh a, \cosh b, \tanh c, \coth d $</p>
<ul>
<li>Absolute value</li>
</ul>
<p>Example: <code>\left\vert a \right\vert, |b|, | \dfrac cd |, \left| \dfrac cd \right|</code><br>$ \left\vert a \right\vert, |b|, | \dfrac cd |, \left| \dfrac cd \right| $</p>
<ul>
<li>Maximum and minimum</li>
</ul>
<p>Example:<code>\max(x,y), \min(x,y)</code>​​<br>$ \max(x,y), \min(x,y) $</p>
<ul>
<li>Others</li>
</ul>
<p>Example: <code>\operatorname{function}</code><br>$ \operatorname{sgn} x $</p>
<h3 id="Limits"><a href="#Limits" class="headerlink" title="Limits"></a>Limits</h3><p><code>\min x, \max y, \inf a, \sup b</code><br>$ \min x, \max y, \inf a, \sup b $</p>
<p><code>\lim x, \liminf y, \limsup z</code><br>$ \lim x, \liminf y, \limsup z $</p>
<p><code>\dim p, \deg q, \det m, \ker\phi</code><br>​$ \dim p, \deg q, \det m, \ker\phi $</p>
<h3 id="Projection"><a href="#Projection" class="headerlink" title="Projection"></a>Projection</h3><p><code>\Pr j, \hom l, \lVert z \rVert, \arg z</code><br>$ \Pr j, \hom l, \lVert z \rVert, \arg z $</p>
<h3 id="Differential-and-derivative"><a href="#Differential-and-derivative" class="headerlink" title="Differential and derivative"></a>Differential and derivative</h3><blockquote>
<p>Treatment of non-italic derivative $ \mathrm{d}x $ with <code>\mathrm{d}x</code></p>
</blockquote>
<p><code>dx, \mathrm{d}x, \partial t, \nabla\psi</code><br>​$ dx, \mathrm{d}x, \partial t, \nabla\psi $</p>
<p><code>\mathrm{d}y/\mathrm{d}x, \frac{\mathrm{d}y}{\mathrm{d}x}, \frac{\partial^2}{\partial x \partial y}z</code><br>$ \mathrm{d}y/\mathrm{d}x, \frac{\mathrm{d}y}{\mathrm{d}x}, \frac{\partial^2}{\partial x \partial y}z $</p>
<p><code>', \prime, \backprime, f^\prime, f', f'', f^{(3)}, \dot y, \ddot y</code><br>$ ‘, \prime, \backprime, f^\prime, f’, f’’, f^{(3)}, \dot y, \ddot y$</p>
<h3 id="Special-symbols"><a href="#Special-symbols" class="headerlink" title="Special symbols"></a>Special symbols</h3><p><code>\infty, \aleph, \complement, \backepsilon, \eth, \Finv, \hbar</code><br>$ \infty, \aleph, \complement, \backepsilon, \eth, \Finv, \hbar $</p>
<p><code>\imath, \jmath, \Bbbk, \ell, \mho, \wp, \Re, \circledS​</code><br>$ \imath, \jmath, \Bbbk, \ell, \mho, \wp, \Re, \circledS​ $</p>
<h3 id="Mod"><a href="#Mod" class="headerlink" title="Mod"></a>Mod</h3><p><code>\pmod{m}, a \bmod b</code><br>$ \pmod{m}, a \bmod b $</p>
<p><code>\gcd(m,n), \operatorname{lcm}(m,n)</code><br>$ \gcd(m,n), \operatorname{lcm}(m,n) $​</p>
<p><code>\mid, \nmid, \shortmid, \nshortmid</code><br>$ \mid, \nmid, \shortmid, \nshortmid $</p>
<h3 id="Sqrt"><a href="#Sqrt" class="headerlink" title="Sqrt"></a>Sqrt</h3><p><code>\surd, \sqrt{2}, \sqrt[n]{}, \sqrt[3]{x^2+y^2}</code><br>$ \surd, \sqrt{2}, \sqrt[n]{}, \sqrt[3]{x+y} $</p>
<h3 id="Operations"><a href="#Operations" class="headerlink" title="Operations"></a>Operations</h3><p><code>+, -, \pm, \mp, \dotplus</code><br>$ +, -, \pm, \mp, \dotplus$ </p>
<p><code>*, /, \times, \div, \divideontimes, \cdot, \ast, \backslash</code><br>$ *, /, \times, \div, \divideontimes, \cdot, \ast, \backslash $</p>
<p><code>\star, \circ, \bullet</code><br>$ \star, \circ, \bullet $</p>
<p><code>\boxplus, \boxminus, \boxtimes, \boxdot</code><br>$ \boxplus, \boxminus, \boxtimes, \boxdot $</p>
<p><code>\oplus, \ominus, \otimes, \oslash, \odot</code><br>$ \oplus, \ominus, \otimes, \oslash, \odot $</p>
<p><code>\circleddash, \circledcirc, \circledast</code><br>$ \circleddash, \circledcirc, \circledast $<br>​<br><code>\bigoplus, \bigotimes, \bigodot</code><br>$ \bigoplus, \bigotimes, \bigodot $</p>
<h3 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h3><p><code>\{, \}, \emptyset, \varnothing</code><br>​$ {, }, \empty, \varnothing $</p>
<p><code>\in, \notin, \not\in, \ni, \not\ni</code><br>​​$ \in, \notin, \not\in, \ni, \not\ni $</p>
<p><code>\cap, \Cap, \sqcap, \bigcap</code><br>​$ \cap, \Cap, \sqcap, \bigcap $</p>
<p><code>\cup, \Cup, \sqcup, \bigcup, \bigsqcup, \uplus, \biguplus</code><br>$ \cup, \Cup, \sqcup, \bigcup, \bigsqcup, \uplus, \biguplus $</p>
<p><code>\setminus, \smallsetminus</code><br>$ \setminus, \smallsetminus $</p>
<p><code>\subset, \Subset, \sqsubset</code><br>$ \subset, \Subset, \sqsubset $</p>
<p><code>\supset, \Supset, \sqsupset</code><br>$ \supset, \Supset, \sqsupset $</p>
<p><code>\subseteq, \nsubseteq, \subsetneq, \varsubsetneq, \sqsubseteq</code><br>$ \subseteq, \nsubseteq, \subsetneq, \varsubsetneq, \sqsubseteq $</p>
<p><code>\supseteq, \nsupseteq, \supsetneq, \varsupsetneq, \sqsupseteq</code><br>$ \supseteq, \nsupseteq, \supsetneq, \varsupsetneq, \sqsupseteq $</p>
<p><code>\subseteqq, \nsubseteqq, \subsetneqq, \varsubsetneqq</code><br>$ \subseteqq, \nsubseteqq, \subsetneqq, \varsubsetneqq $</p>
<h3 id="Relationship-symbol"><a href="#Relationship-symbol" class="headerlink" title="Relationship symbol"></a>Relationship symbol</h3><p><code>=, \ne, \neq, \equiv, \not\equiv</code><br>$ =, \ne, \neq, \equiv, \not\equiv $</p>
<p><code>\doteq, \doteqdot, :=, \overset{\underset{\mathrm{def} } {} } {=}</code><br>$ \doteq, \doteqdot, :=, \overset{\underset{\mathrm{def} } {} } {=} $</p>
<p><code>\sim, \nsim, \backsim, \thicksim, \simeq, \backsimeq, \eqsim, \cong, \ncong</code><br>$ \sim, \nsim, \backsim, \thicksim, \simeq, \backsimeq, \eqsim, \cong, \ncong $</p>
<p><code>\approx, \thickapprox, \approxeq, \asymp, \propto, \varpropto</code><br>$ \approx, \thickapprox, \approxeq, \asymp, \propto, \varpropto $</p>
<p><code>&lt;, \nless, \ll, \not\ll, \lll, \not\lll, \lessdot</code><br>$ &lt;, \nless, \ll, \not\ll, \lll, \not\lll, \lessdot $</p>
<p><code>&gt;, \ngtr, \gg, \not\gg, \ggg, \not\ggg, \gtrdot</code><br>$ &gt;, \ngtr, \gg, \not\gg, \ggg, \not\ggg, \gtrdot $</p>
<p><code>\le, \leq, \lneq, \leqq, \nleq, \nleqq, \lneqq, \lvertneqq</code><br>$ \le, \leq, \lneq, \leqq, \nleq, \nleqq, \lneqq, \lvertneqq $</p>
<p><code>\ge, \geq, \gneq, \geqq, \ngeq, \ngeqq, \gneqq, \gvertneqq</code><br>$ \ge, \geq, \gneq, \geqq, \ngeq, \ngeqq, \gneqq, \gvertneqq $</p>
<p><code>\lessgtr, \lesseqgtr, \lesseqqgtr, \gtrless, \gtreqless, \gtreqqless</code><br>$ \lessgtr, \lesseqgtr, \lesseqqgtr, \gtrless, \gtreqless, \gtreqqless $</p>
<p><code>\leqslant, \nleqslant, \eqslantless</code><br>$ \leqslant, \nleqslant, \eqslantless $</p>
<p><code>\geqslant, \ngeqslant, \eqslantgtr</code><br>$ \geqslant, \ngeqslant, \eqslantgtr $</p>
<p><code>\lesssim, \lnsim, \lessapprox, \lnapprox</code><br>$ \lesssim, \lnsim, \lessapprox, \lnapprox $</p>
<p><code>\gtrsim, \gnsim, \gtrapprox, \gnapprox</code><br>$ \gtrsim, \gnsim, \gtrapprox, \gnapprox $</p>
<p><code>\prec, \nprec, \preceq, \npreceq, \precneqq</code><br>​$ \prec, \nprec, \preceq, \npreceq, \precneqq $</p>
<p><code>\succ, \nsucc, \succeq, \nsucceq, \succneqq</code><br>$ \succ, \nsucc, \succeq, \nsucceq, \succneqq $</p>
<p><code>\preccurlyeq, \curlyeqprec</code><br>$ \preccurlyeq, \curlyeqprec $</p>
<p><code>\succcurlyeq, \curlyeqsucc</code><br>$ \succcurlyeq, \curlyeqsucc $</p>
<p><code>\precsim, \precnsim, \precapprox, \precnapprox</code><br>$ \precsim, \precnsim, \precapprox, \precnapprox $</p>
<p><code>\succsim, \succnsim, \succapprox, \succnapprox</code><br>$ \succsim, \succnsim, \succapprox, \succnapprox $</p>
<h3 id="Geometric-symbols"><a href="#Geometric-symbols" class="headerlink" title="Geometric symbols"></a>Geometric symbols</h3><p><code>\parallel, \nparallel, \shortparallel, \nshortparallel</code><br>$ \parallel, \nparallel, \shortparallel, \nshortparallel $</p>
<p><code>\perp, \angle, \sphericalangle, \measuredangle, 45^\circ</code><br>$ \perp, \angle, \sphericalangle, \measuredangle, 45^\circ$</p>
<p><code>\Box, \blacksquare, \diamond, \Diamond, \lozenge, \blacklozenge, \bigstar, \bigcirc</code><br>​$ \Box, \blacksquare, \diamond, \Diamond, \lozenge, \blacklozenge, \bigstar, \bigcirc $</p>
<p><code>\triangle, \triangledown ,\bigtriangleup, \bigtriangledown, \vartriangle</code><br>​$ \triangle, \triangledown ,\bigtriangleup, \bigtriangledown, \vartriangle $</p>
<p><code>\blacktriangle, \blacktriangledown, \blacktriangleleft, \blacktriangleright</code><br>$ \blacktriangle, \blacktriangledown, \blacktriangleleft, \blacktriangleright $</p>
<h3 id="Logical-symbols"><a href="#Logical-symbols" class="headerlink" title="Logical symbols"></a>Logical symbols</h3><p><code>\forall, \not\forall, \exists, \nexists</code><br>​$ \forall, \not\forall, \exists, \nexists $</p>
<p><code>\because, \therefore, \And</code><br>$ \because, \therefore, \And $</p>
<p><code>\lor, \vee, \curlyvee, \bigvee</code><br>$ \lor, \vee, \curlyvee, \bigvee $<br>​<br><code>\land, \wedge, \curlywedge, \bigwedge</code><br>$ \land, \wedge, \curlywedge, \bigwedge $</p>
<blockquote>
<p>Use <code>\lor, \land</code> instead of <code>\or, \and</code></p>
</blockquote>
<p><code>\bar{x}, \bar{abc}, \overline{x}, \overline{abc}</code><br>$ \bar{x}, \bar{abc}, \overline{x}, \overline{abc} $</p>
<p><code>\lnot, \neg, \not\operatorname{R}, \bot, \top</code><br>$ \lnot, \neg, \not\operatorname{R}, \bot, \top $</p>
<p><code>\vdash, \dashv, \vDash, \Vdash, \Vvdash, \models</code><br>​​$ \vdash, \dashv, \vDash, \Vdash, \Vvdash, \models $</p>
<p><code>\nvdash, \nVdash, \nvDash, \nVDash</code><br>$ \nvdash, \nVdash, \nvDash, \nVDash $</p>
<p><code>\ulcorner, \urcorner, \llcorner, \lrcorner</code><br>$ \ulcorner, \urcorner, \llcorner, \lrcorner $</p>
<h3 id="Arrowhead"><a href="#Arrowhead" class="headerlink" title="Arrowhead"></a>Arrowhead</h3><p><code>\to, \rightarrow, \nrightarrow, \longrightarrow</code><br>$ \to, \rightarrow, \nrightarrow, \longrightarrow $</p>
<p><code>\gets, \leftarrow, \nleftarrow, \longleftarrow</code><br>$ \gets, \leftarrow, \nleftarrow, \longleftarrow $</p>
<p><code>\leftrightarrow, \nleftrightarrow, \longleftrightarrow</code><br>$ \leftrightarrow, \nleftrightarrow, \longleftrightarrow $ </p>
<p><code>\uparrow, \downarrow, \updownarrow</code><br>$ \uparrow, \downarrow, \updownarrow $</p>
<p><code>\Rightarrow, \nRightarrow, \Longrightarrow, \implies</code><br>$ \Rightarrow, \nRightarrow, \Longrightarrow, \implies $</p>
<p><code>\Leftarrow, \nLeftarrow, \Longleftarrow</code><br>$ \Leftarrow, \nLeftarrow, \Longleftarrow $</p>
<p><code>\Leftrightarrow, \nLeftrightarrow, \Longleftrightarrow, \iff</code><br>$ \Leftrightarrow, \nLeftrightarrow, \Longleftrightarrow, \iff $</p>
<p><code>\Uparrow, \Downarrow, \Updownarrow</code><br>$ \Uparrow, \Downarrow, \Updownarrow $</p>
<p><code>\Rrightarrow, \Lleftarrow</code><br>$ \Rrightarrow, \Lleftarrow $</p>
<p><code>\nearrow, \swarrow, \nwarrow, \searrow</code><br>$ \nearrow, \swarrow, \nwarrow, \searrow $</p>
<p><code>\mapsto, \longmapsto</code><br>$ \mapsto, \longmapsto $</p>
<p><code>\rightharpoonup, \rightharpoondown, \leftharpoonup, \leftharpoondown, \upharpoonleft, \upharpoonright, \downharpoonleft, \downharpoonright, \rightleftharpoons, \leftrightharpoons</code><br>$ \rightharpoonup, \rightharpoondown, \leftharpoonup, \leftharpoondown, \upharpoonleft, \upharpoonright, \downharpoonleft, \downharpoonright, \rightleftharpoons, \leftrightharpoons $</p>
<p><code>\curvearrowleft, \circlearrowleft, \Lsh, \upuparrows, \rightrightarrows, \rightleftarrows, \rightarrowtail, \looparrowright</code><br>$ \curvearrowleft, \circlearrowleft, \Lsh, \upuparrows, \rightrightarrows, \rightleftarrows, \rightarrowtail, \looparrowright $</p>
<p><code>\curvearrowright, \circlearrowright, \Rsh, \downdownarrows, \leftleftarrows, \leftrightarrows, \leftarrowtail, \looparrowleft</code><br>$ \curvearrowright, \circlearrowright, \Rsh, \downdownarrows, \leftleftarrows, \leftrightarrows, \leftarrowtail, \looparrowleft $</p>
<p><code>\hookrightarrow, \hookleftarrow, \multimap, \leftrightsquigarrow, \rightsquigarrow, \twoheadrightarrow, \twoheadleftarrow</code><br>$ \hookrightarrow, \hookleftarrow, \multimap, \leftrightsquigarrow, \rightsquigarrow, \twoheadrightarrow, \twoheadleftarrow $</p>
<h3 id="Ellipsis"><a href="#Ellipsis" class="headerlink" title="Ellipsis"></a>Ellipsis</h3><p><code>\cdots, \ldots, \vdots, \ddots</code><br>$ \cdots, \ldots, \vdots, \ddots $</p>
<h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><p><code>\amalg, \%, \&amp;, \dagger, \ddagger</code><br>​​​$ \amalg, \%, \&amp;, \dagger, \ddagger $</p>
<p><code>\smile, \frown, \wr, \triangleleft, \triangleright</code><br>$ \smile, \frown, \wr, \triangleleft, \triangleright $</p>
<p><code>\diamondsuit, \heartsuit, \clubsuit, \spadesuit, \Game, \flat, \natural, \sharp</code><br>$ \diamondsuit, \heartsuit, \clubsuit, \spadesuit, \Game, \flat, \natural, \sharp $</p>
<p><code>\diagup, \diagdown, \centerdot, \ltimes, \rtimes, \leftthreetimes, \rightthreetimes</code><br>$ \diagup, \diagdown, \centerdot, \ltimes, \rtimes, \leftthreetimes, \rightthreetimes $</p>
<p><code>\eqcirc, \circeq, \triangleq, \bumpeq, \Bumpeq, \doteqdot, \risingdotseq, \fallingdotseq</code><br>$ \eqcirc, \circeq, \triangleq, \bumpeq, \Bumpeq, \doteqdot, \risingdotseq, \fallingdotseq $</p>
<p><code>\intercal, \barwedge, \veebar, \doublebarwedge, \between, \pitchfork</code><br>$ \intercal, \barwedge, \veebar, \doublebarwedge, \between, \pitchfork $</p>
<p><code>\vartriangleleft, \ntriangleleft, \vartriangleright, \ntriangleright</code><br>$ \vartriangleleft, \ntriangleleft, \vartriangleright, \ntriangleright $</p>
<p><code>\trianglelefteq, \ntrianglelefteq, \trianglerighteq, \ntrianglerighteq</code><br>$ \trianglelefteq, \ntrianglelefteq, \trianglerighteq, \ntrianglerighteq $</p>
<h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><p><code>\vec{a}, \boldsymbol{b}, \overleftarrow{ab}, \overrightarrow{cd}, \overleftrightarrow{ab}, \widehat{abc}</code></p>
<p>$ \vec{a}, \boldsymbol{b}, \overleftarrow{ab}, \overrightarrow{cd}, \overleftrightarrow{ab}, \widehat{abc} $<br>​​</p>
<h3 id="Up-and-down-lines"><a href="#Up-and-down-lines" class="headerlink" title="Up and down lines"></a>Up and down lines</h3><p><code>\overset{\frown} {AB}, \overline {abc}, \underline{def}</code><br>$ \overset{\frown} {AB}, \overline {abc}, \underline{def} $</p>
<p><code>\overbrace{1+2+\cdots+n} \quad \overbrace{1+2+\cdots+n}^{n}</code><br>$ \overbrace{1+2+\cdots+n} \quad \overbrace{1+2+\cdots+n}^{n} $</p>
<p><code>\begin{matrix} n \\ \overbrace{1+2+\cdots+n} \end{matrix}</code><br>$ \begin{matrix} n \ \overbrace{1+2+\cdots+n} \end{matrix} $</p>
<p><code>\underbrace{a+b+\cdots+z} \quad \underbrace{a+b+\cdots+z}_{26}</code><br>$ \underbrace{a+b+\cdots+z} \quad \underbrace{a+b+\cdots+z}_{26} $</p>
<p><code>\begin{matrix} \underbrace{a+b+\cdots+z} \\ 26 \end{matrix}</code><br>$ \begin{matrix} \underbrace{a+b+\cdots+z} \ 26 \end{matrix} $ </p>
<h3 id="Big-operations"><a href="#Big-operations" class="headerlink" title="Big operations"></a>Big operations</h3><blockquote>
<p>Inlines formulas and formula blocks are different.</p>
</blockquote>
<script type="math/tex; mode=display">\sum_{i=1}^{n} i^2</script><p>$ \sum_{i=1}^{n} i^2 $</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$$</span><br><span class="line">\sum_{i=1}^{n} i^2</span><br><span class="line">$$</span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\sum_{i=1}^{n} i^2</script><p>To display an inline formula as positive top and bottom, you can use the limits command to follow the operator:</p>
<script type="math/tex; mode=display">\sum\limits_{i=1}^{n} i^2</script><p>$ \sum\limits_{i=1}^{n} i^2 $</p>
<p>To display the formula block as top-right-right, you can use the first-order frameless matrix form or use the nolimits command:</p>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{matrix} <span class="keyword">\sum</span><span class="built_in">_</span>{i=1}<span class="built_in">^</span>{n} i<span class="built_in">^</span>2 <span class="keyword">\end</span>{matrix}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{matrix} \sum_{i=1}^{n} i^2 \end{matrix}</script><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\sum</span><span class="keyword">\nolimits</span><span class="built_in">_</span>{i=1}<span class="built_in">^</span>{n} i<span class="built_in">^</span>2</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\sum\nolimits_{i=1}^{n} i^2</script><ul>
<li>Accumulate and multiply</li>
</ul>
<p><code>\sum_{i=1}^{n} i^2 \quad \prod_{i=1}^{n} x_i</code></p>
<script type="math/tex; mode=display">
\sum_{i=1}^{n} i^2 \quad \prod_{i=1}^{n} x_i</script><ul>
<li>Limit</li>
</ul>
<p><code>\lim_{x \to \infty} (1+\frac{1}{x})^x = e</code></p>
<script type="math/tex; mode=display">
\lim_{x \to \infty} (1+\frac{1}{x})^x = e</script><ul>
<li>Ordinary integration</li>
</ul>
<p><code>\int_{a}^{b} e^x \, \mathrm{d}x</code></p>
<script type="math/tex; mode=display">
\int_{a}^{b} e^x \, \mathrm{d}x</script><ul>
<li>Multiple integration</li>
</ul>
<p><code>\iint_{D} f(x,y) \, \mathrm{d}\sigma \quad \iiint_{\Omega} f(x,y,z) \, \mathrm{d}V</code></p>
<script type="math/tex; mode=display">
\iint_{D} f(x,y) \, \mathrm{d}\sigma \quad \iiint_{\Omega} f(x,y,z) \, \mathrm{d}V</script><ul>
<li>Closure curve integral</li>
</ul>
<p><code>\oint_{L} f(x,y) \, \mathrm{d}s</code></p>
<script type="math/tex; mode=display">
\oint_{L} f(x,y) \, \mathrm{d}s</script><ul>
<li>Others</li>
</ul>
<p><code>\int, \iint, \iiint, \oint</code><br>$ \int, \iint, \iiint, \oint $</p>
<ul>
<li>Intersection, union and reunion</li>
</ul>
<p><code>\bigcap_{i=1}^{n} A_i \quad , \bigcup_{j=1}^{m} B_j , \coprod_{i \in I} A_i</code></p>
<script type="math/tex; mode=display">
\bigcap_{i=1}^{n} A_i \quad , \bigcup_{j=1}^{m} B_j , \coprod_{i \in I} A_i</script><h2 id="Fractional"><a href="#Fractional" class="headerlink" title="Fractional"></a>Fractional</h2><h3 id="Basic-operations-1"><a href="#Basic-operations-1" class="headerlink" title="Basic operations"></a>Basic operations</h3><blockquote>
<p>You can use <code>\over</code> and <code>{}</code></p>
</blockquote>
<p><code>x = { {-b \pm \sqrt{b^2-4ac} } \over {2a} }</code></p>
<script type="math/tex; mode=display">x = { {-b \pm \sqrt{b^2-4ac} } \over {2a} }</script><h3 id="Typesetting"><a href="#Typesetting" class="headerlink" title="Typesetting"></a>Typesetting</h3><blockquote>
<p>Normal fractions are automatically scaled down in in-line formulas and displayed as full size in formula blocks.</p>
</blockquote>
<script type="math/tex; mode=display">\frac{1}{2}=0.5</script><p>$ \frac{1}{2}=0.5 $</p>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\frac</span>{1}{2}=0.5</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\frac{1}{2}=0.5</script><p>​</p>
<ul>
<li><p>The <code>\tfrac</code> command is used to make fractions appear as inline formula styles.</p>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\tfrac</span>{1}{2}=0.5</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\tfrac{1}{2}=0.5</script></li>
<li><p>The <code>\dfrac</code> command is used to make fractions appear as formula block styles.</p>
</li>
</ul>
<script type="math/tex; mode=display">\dfrac{1}{2}=0.5</script><p>$ \dfrac{1}{2}=0.5 $</p>
<p>​</p>
<ul>
<li>Attention</li>
</ul>
<p>In scenarios such as exponential functions, limits, and integrals, try not to use the frac command, and use / express as horizontal fractions.</p>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line">e<span class="built_in">^</span>{<span class="keyword">\frac</span>{i<span class="keyword">\pi</span>}{2} } <span class="keyword">\quad</span> <span class="keyword">\int</span><span class="built_in">_</span>{-<span class="keyword">\frac</span>{<span class="keyword">\pi</span>}{2} }<span class="built_in">^</span>{<span class="keyword">\frac</span>{<span class="keyword">\pi</span>}{2} } <span class="keyword">\sin</span> x <span class="keyword">\,</span> <span class="keyword">\mathrm</span>{d}x</span><br><span class="line"><span class="comment">% Bad</span></span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
e^{\frac{i\pi}{2} } \quad \int_{-\frac{\pi}{2} }^{\frac{\pi}{2} } \sin x \, \mathrm{d}x
% Bad</script><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line">e<span class="built_in">^</span>{i<span class="keyword">\pi</span>/2} <span class="keyword">\quad</span> <span class="keyword">\int</span><span class="built_in">_</span>{-<span class="keyword">\pi</span>/2}<span class="built_in">^</span>{<span class="keyword">\pi</span>/2} <span class="keyword">\sin</span> x <span class="keyword">\,</span> <span class="keyword">\mathrm</span>{d}x</span><br><span class="line"><span class="comment">% Good</span></span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
e^{i\pi/2} \quad \int_{-\pi/2}^{\pi/2} \sin x \, \mathrm{d}x
% Good</script><h3 id="Continuous-fractions"><a href="#Continuous-fractions" class="headerlink" title="Continuous fractions"></a>Continuous fractions</h3><blockquote>
<p>Enter the conjunction with the <code>\cfrac</code> command, which automatically handles the height of the numerator and denominator.</p>
</blockquote>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\cfrac</span>{1}{2 + <span class="keyword">\cfrac</span>{1}{2 + <span class="keyword">\cfrac</span>{1}{2 + <span class="keyword">\cdots</span>} } }</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\cfrac{1}{2 + \cfrac{1}{2 + \cfrac{1}{2 + \cdots} } }</script><h3 id="Binomial-coefficients"><a href="#Binomial-coefficients" class="headerlink" title="Binomial coefficients"></a>Binomial coefficients</h3><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\mathrm</span>{C}<span class="built_in">_</span>n<span class="built_in">^</span>r = <span class="keyword">\binom</span>{n}{r}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\mathrm{C}_n^r = \binom{n}{r}</script><blockquote>
<p>Enter with the binom command, tbinom to display binomial coefficients as inline formula styles, and dbinom to display binomial coefficients as formula block styles</p>
</blockquote>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\tbinom</span>{n}{r} = <span class="keyword">\tbinom</span>{n}{n-r}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\tbinom{n}{r} = \tbinom{n}{n-r}</script><script type="math/tex; mode=display">\dbinom{n}{r} = \dfrac{n!}{k!\,(n-k)!}</script><p>$ \dbinom{n}{r} = \dfrac{n!}{k!\,(n-k)!} $<br>​</p>
<h2 id="Matrices-conditional-expressions-and-equations"><a href="#Matrices-conditional-expressions-and-equations" class="headerlink" title="Matrices, conditional expressions and equations"></a>Matrices, conditional expressions and equations</h2><ul>
<li>Grammar</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{type}</span><br><span class="line">content</span><br><span class="line"><span class="keyword">\end</span>{type}</span><br><span class="line">type: matrix、pmatrix、bmatrix、Bmatrix、vmatrix、Vmatrix;</span><br><span class="line">	coditional cases;</span><br><span class="line">	equations aligned、alignedat.</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>In content, the <code>&amp;</code> symbol indicates the aligned content of each line, and <code>\\</code> indicates a line break at the end.</p>
</blockquote>
<h3 id="Frameless-matrix"><a href="#Frameless-matrix" class="headerlink" title="Frameless matrix"></a>Frameless matrix</h3><ul>
<li>Separate matrix columns with <code>&amp;</code> and matrix rows with <code>\\</code></li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{matrix}</span><br><span class="line">a <span class="built_in">&amp;</span> b <span class="keyword">\\</span></span><br><span class="line">c <span class="built_in">&amp;</span> d</span><br><span class="line"><span class="keyword">\end</span>{matrix}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{matrix}
a & b \\
c & d
\end{matrix}</script><h3 id="Box-matrix"><a href="#Box-matrix" class="headerlink" title="Box matrix"></a>Box matrix</h3><ul>
<li><p><code>pmatrix</code> is parentheses, <code>bmatrix</code> is square brackets, <code>Bmatrix</code> is curly braces, <code>vmatrix</code> is vertical (determinant), and <code>Vmatrix</code> is double vertical bar.</p>
</li>
<li><p>Enter ellipses using <code>cdots</code>, <code>ddots</code> and <code>vdots</code>.</p>
</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{pmatrix}</span><br><span class="line">0 <span class="built_in">&amp;</span> <span class="keyword">\cdots</span> <span class="built_in">&amp;</span> 0 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\vdots</span> <span class="built_in">&amp;</span> <span class="keyword">\ddots</span> <span class="built_in">&amp;</span> <span class="keyword">\vdots</span> <span class="keyword">\\</span></span><br><span class="line">0 <span class="built_in">&amp;</span> <span class="keyword">\cdots</span> <span class="built_in">&amp;</span> 0 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\end</span>{pmatrix}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{pmatrix}
0 & \cdots & 0 \\
\vdots & \ddots & \vdots \\
0 & \cdots & 0 \\
\end{pmatrix}</script><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{bmatrix}</span><br><span class="line">a <span class="built_in">&amp;</span> b <span class="keyword">\\</span></span><br><span class="line">c <span class="built_in">&amp;</span> d</span><br><span class="line"><span class="keyword">\end</span>{bmatrix}</span><br><span class="line"><span class="keyword">\quad</span></span><br><span class="line"><span class="keyword">\begin</span>{Bmatrix}</span><br><span class="line">a <span class="built_in">&amp;</span> b <span class="keyword">\\</span></span><br><span class="line">c <span class="built_in">&amp;</span> d</span><br><span class="line"><span class="keyword">\end</span>{Bmatrix}</span><br><span class="line"><span class="keyword">\quad</span></span><br><span class="line"><span class="keyword">\begin</span>{vmatrix}</span><br><span class="line">a <span class="built_in">&amp;</span> b <span class="keyword">\\</span></span><br><span class="line">c <span class="built_in">&amp;</span> d</span><br><span class="line"><span class="keyword">\end</span>{vmatrix}</span><br><span class="line"><span class="keyword">\quad</span></span><br><span class="line"><span class="keyword">\begin</span>{Vmatrix}</span><br><span class="line">a <span class="built_in">&amp;</span> b <span class="keyword">\\</span></span><br><span class="line">c <span class="built_in">&amp;</span> d</span><br><span class="line"><span class="keyword">\end</span>{Vmatrix}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{bmatrix}
a & b \\
c & d
\end{bmatrix}
\quad
\begin{Bmatrix}
a & b \\
c & d
\end{Bmatrix}
\quad
\begin{vmatrix}
a & b \\
c & d
\end{vmatrix}
\quad
\begin{Vmatrix}
a & b \\
c & d
\end{Vmatrix}</script><h3 id="Matrix-segmentation"><a href="#Matrix-segmentation" class="headerlink" title="Matrix segmentation"></a>Matrix segmentation</h3><ul>
<li>Add <code>|</code> to the definition where it needs to be divided.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\left</span>[</span><br><span class="line"><span class="keyword">\begin</span>{array}{cc|c}</span><br><span class="line">1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">4 <span class="built_in">&amp;</span> 5 <span class="built_in">&amp;</span> 6</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="keyword">\right</span>]</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\left[
\begin{array}{cc|c}
1 & 2 & 3 \\
4 & 5 & 6
\end{array}
\right]</script><h3 id="Conditional-expressions"><a href="#Conditional-expressions" class="headerlink" title="Conditional expressions"></a>Conditional expressions</h3><ul>
<li>Use <code>&amp;</code> to separate formulas from conditions.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line">f(n)=</span><br><span class="line"><span class="keyword">\begin</span>{cases}</span><br><span class="line">n/2, <span class="built_in">&amp;</span> <span class="keyword">\text</span>{if } n <span class="keyword">\text</span>{ is even} <span class="keyword">\\</span></span><br><span class="line">3n+1, <span class="built_in">&amp;</span> <span class="keyword">\text</span>{if } n <span class="keyword">\text</span>{ is odd}</span><br><span class="line"><span class="keyword">\end</span>{cases}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
f(n)=
\begin{cases}
n/2, & \text{if } n \text{ is even} \\
3n+1, & \text{if } n \text{ is odd}
\end{cases}</script><blockquote>
<p>Use <code>\text</code> to distinguish between text and mathematical characters</p>
</blockquote>
<h3 id="Multi-line-equation"><a href="#Multi-line-equation" class="headerlink" title="Multi-line equation"></a>Multi-line equation</h3><ul>
<li>Use <code>\alignedat</code> to perform it<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{aligned}</span><br><span class="line">f(x) <span class="built_in">&amp;</span> = (m+n)<span class="built_in">^</span>2 <span class="keyword">\\</span></span><br><span class="line"><span class="built_in">&amp;</span> = m<span class="built_in">^</span>2+2mn+n<span class="built_in">^</span>2 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\end</span>{aligned}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{aligned}
f(x) & = (m+n)^2 \\
& = m^2+2mn+n^2 \\
\end{aligned}</script></li>
</ul>
<h3 id="Equations"><a href="#Equations" class="headerlink" title="Equations"></a>Equations</h3><ul>
<li><code>\case</code> is used to indicate left-alignment.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{cases}</span><br><span class="line">x+2y3z=0 <span class="keyword">\\</span></span><br><span class="line">4x-5y+6z=0 <span class="keyword">\\</span></span><br><span class="line">-7x+8y+9z=0 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\end</span>{cases}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{cases}
x+2y3z=0 \\
4x-5y+6z=0 \\
-7x+8y+9z=0 \\
\end{cases}</script><ul>
<li>Aligned  according to the equal sign is indicated by <code>\aligned</code>.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{cases}</span><br><span class="line">x+2y3z=0 <span class="keyword">\\</span></span><br><span class="line">4x-5y+6z=0 <span class="keyword">\\</span></span><br><span class="line">-7x+8y+9z=0 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\end</span>{cases}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\left\{ \begin{aligned}
x+2y3z=0 \\
4x-5y+6z=0 \\
-7x+8y+9z=0 \\
\end{aligned} \right.</script><h2 id="Arrays-and-tables"><a href="#Arrays-and-tables" class="headerlink" title="Arrays and tables"></a>Arrays and tables</h2><h3 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h3><ul>
<li>Arrays and tables begin with <code>begin{array}{definite}</code> and end with <code>end{array}</code>. Define the alignment of each column in the definition, and <code>l</code>, <code>c</code> and <code>r</code> can be used to represent left, center, and right, respectively. If you insert a horizontal dividing line, insert <code>\hline</code> between the line contents; If you insert a vertical dividing line, insert <code>|</code>. The table content is separated by <code>&amp;</code> columns and rows by <code>\\</code>.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{c|lcr}</span><br><span class="line">x <span class="built_in">&amp;</span> 1<span class="keyword">\text</span>{(left)} <span class="built_in">&amp;</span> 2<span class="keyword">\text</span>{(center)} <span class="built_in">&amp;</span> 3<span class="keyword">\text</span>{(right)} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line">f(x) <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="keyword">\\</span></span><br><span class="line">g(x) <span class="built_in">&amp;</span> 3 <span class="built_in">&amp;</span> 4 <span class="built_in">&amp;</span> 5 <span class="keyword">\\</span></span><br><span class="line">h(x) <span class="built_in">&amp;</span> 6+i <span class="built_in">&amp;</span> 7-i <span class="built_in">&amp;</span> 1+10i</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{array}{c|lcr}
x & 1\text{(left)} & 2\text{(center)} & 3\text{(right)} \\
\hline
f(x) & 0 & 1 & 2 \\
g(x) & 3 & 4 & 5 \\
h(x) & 6+i & 7-i & 1+10i
\end{array}</script><ul>
<li>You can use arrays and tables to implement similar functions as aligned.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{lcr}</span><br><span class="line">z <span class="built_in">&amp;</span> = <span class="built_in">&amp;</span> a <span class="keyword">\\</span></span><br><span class="line">f(x,y,z) <span class="built_in">&amp;</span> = <span class="built_in">&amp;</span> x+y+z</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{array}{lcr}
z & = & a \\
f(x,y,z) & = & x+y+z
\end{array}</script><h3 id="Nesting-of-arrays-and-tables"><a href="#Nesting-of-arrays-and-tables" class="headerlink" title="Nesting of arrays and tables"></a>Nesting of arrays and tables</h3><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="comment">% outer</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{c}</span><br><span class="line">	<span class="comment">% inner row 1</span></span><br><span class="line">	<span class="keyword">\begin</span>{array}{cc}</span><br><span class="line">		<span class="comment">% inner row 1 column 1</span></span><br><span class="line">		<span class="keyword">\begin</span>{array}{c|cccc}</span><br><span class="line">		<span class="keyword">\min</span> <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">		<span class="keyword">\hline</span></span><br><span class="line">		0 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 0 <span class="keyword">\\</span></span><br><span class="line">		1 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 1 <span class="keyword">\\</span></span><br><span class="line">		2 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 2 <span class="keyword">\\</span></span><br><span class="line">		3 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3</span><br><span class="line">		<span class="keyword">\end</span>{array}</span><br><span class="line">	<span class="built_in">&amp;</span></span><br><span class="line">		<span class="comment">% inner row 1 column 2</span></span><br><span class="line">		<span class="keyword">\begin</span>{array}{c|cccc}</span><br><span class="line">		<span class="keyword">\max</span> <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">		<span class="keyword">\hline</span></span><br><span class="line">		0 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">		1 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">		2 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">		3 <span class="built_in">&amp;</span> 3 <span class="built_in">&amp;</span> 3 <span class="built_in">&amp;</span> 3 <span class="built_in">&amp;</span> 3</span><br><span class="line">		<span class="keyword">\end</span>{array}</span><br><span class="line">	<span class="keyword">\end</span>{array}</span><br><span class="line"><span class="keyword">\\</span></span><br><span class="line">	<span class="comment">% inner row 2</span></span><br><span class="line">	<span class="keyword">\begin</span>{array}{c|cccc}</span><br><span class="line">	<span class="keyword">\Delta</span> <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">	<span class="keyword">\hline</span></span><br><span class="line">	0 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 3 <span class="keyword">\\</span></span><br><span class="line">	1 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 2 <span class="keyword">\\</span></span><br><span class="line">	2 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 0 <span class="built_in">&amp;</span> 1 <span class="keyword">\\</span></span><br><span class="line">	3 <span class="built_in">&amp;</span> 3 <span class="built_in">&amp;</span> 2 <span class="built_in">&amp;</span> 1 <span class="built_in">&amp;</span> 0</span><br><span class="line">	<span class="keyword">\end</span>{array}</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
% outer
\begin{array}{c}
    % inner row 1
    \begin{array}{cc}
        % inner row 1 column 1
        \begin{array}{c|cccc}
        \min & 0 & 1 & 2 & 3 \\
        \hline
        0 & 0 & 0 & 0 & 0 \\
        1 & 0 & 1 & 1 & 1 \\
        2 & 0 & 1 & 2 & 2 \\
        3 & 0 & 1 & 2 & 3
        \end{array}
    &
        % inner row 1 column 2
        \begin{array}{c|cccc}
        \max & 0 & 1 & 2 & 3 \\
        \hline
        0 & 0 & 1 & 2 & 3 \\
        1 & 1 & 1 & 2 & 3 \\
        2 & 2 & 2 & 2 & 3 \\
        3 & 3 & 3 & 3 & 3
        \end{array}
    \end{array}
\\
    % inner row 2
    \begin{array}{c|cccc}
    \Delta & 0 & 1 & 2 & 3 \\
    \hline
    0 & 0 & 1 & 2 & 3 \\
    1 & 1 & 0 & 1 & 2 \\
    2 & 2 & 1 & 0 & 1 \\
    3 & 3 & 2 & 1 & 0
    \end{array}
\end{array}</script><h2 id="Fonts"><a href="#Fonts" class="headerlink" title="Fonts"></a>Fonts</h2><ul>
<li>Use Large and Small to control font size</li>
</ul>
<script type="math/tex; mode=display">A, \large{A}, \small{A}</script><p>$ A, \large{A}, \small{A} $</p>
<h3 id="Greek-symbols"><a href="#Greek-symbols" class="headerlink" title="Greek symbols"></a>Greek symbols</h3><p><code>$\digamma, \varepsilon, \vartheta, \varkappa, \varpi, \varrho, \varsigma, \varphi $</code><br>$\digamma, \varepsilon, \vartheta, \varkappa, \varpi, \varrho, \varsigma, \varphi $</p>
<script type="math/tex; mode=display">
\begin{array}{c|l|c|l}
A \alpha & \verb|A \alpha| & N \nu & \verb|N \nu| \\
\hline
B \beta & \verb|B \beta| & \Xi \xi & \verb|\Xi \xi| \\
\hline
\Gamma \gamma & \verb|\Gamma \gamma| & O \omicron & \verb|O \omicron| \\
\hline
\Delta \delta & \verb|\Delta \delta| & \Pi \pi & \verb|\Pi \pi| \\
\hline
E \epsilon & \verb|E \epsilon| & P \rho & \verb|P \rho| \\
\hline
Z \zeta & \verb|Z \zeta| & \Sigma \sigma & \verb|\Sigma \sigma| \\
\hline
H \eta & \verb|H \eta| & T \tau & \verb|T \tau| \\
\hline
\Theta \theta & \verb|\Theta \theta| & \Upsilon \upsilon & \verb|\Upsilon \upsilon| \\
\hline
I \iota & \verb|I \iota| & \Phi \phi & \verb|\Phi \phi| \\
\hline
K \kappa & \verb|K \kappa| & X \chi & \verb|X \chi| \\
\hline
\Lambda \lambda & \verb|\Lambda \lambda| & \Psi \psi & \verb|\Psi \psi| \\
\hline
M \mu & \verb|M \mu| & \Omega \omega & \verb|\Omega \omega| \\
\end{array}</script><h3 id="Hebrew-symbols"><a href="#Hebrew-symbols" class="headerlink" title="Hebrew symbols"></a>Hebrew symbols</h3><script type="math/tex; mode=display">\aleph, \beth, \gimel, \daleth</script><p>$\aleph, \beth, \gimel, \daleth$</p>
<h3 id="Special-font-form"><a href="#Special-font-form" class="headerlink" title="Special font form"></a>Special font form</h3><h4 id="Bold"><a href="#Bold" class="headerlink" title="Bold"></a>Bold</h4><ul>
<li>Use <code>\mathbf{text}</code> or <code>{\bf text}</code>, <code>\mathbb{text}</code> or <code>\Bbb{text}</code>. However, it is not valid for special symbols.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{c|ccc}</span><br><span class="line"><span class="keyword">\text</span>{defalut} <span class="built_in">&amp;</span> SAMPLE <span class="built_in">&amp;</span> sample <span class="built_in">&amp;</span> 0123 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{mathbf} <span class="built_in">&amp;</span> <span class="keyword">\mathbf</span>{SAMPLE} <span class="built_in">&amp;</span> <span class="keyword">\mathbf</span>{sample} <span class="built_in">&amp;</span> <span class="keyword">\mathbf</span>{0123} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{bf} <span class="built_in">&amp;</span> {<span class="keyword">\bf</span> SAMPLE} <span class="built_in">&amp;</span> {<span class="keyword">\bf</span> sample} <span class="built_in">&amp;</span> {<span class="keyword">\bf</span> 0123} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{mathbb} <span class="built_in">&amp;</span> <span class="keyword">\mathbb</span>{SAMPLE} <span class="built_in">&amp;</span> <span class="keyword">\mathbb</span>{sample} <span class="built_in">&amp;</span> <span class="keyword">\mathbb</span>{0123} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{Bbb} <span class="built_in">&amp;</span> <span class="keyword">\Bbb</span>{SAMPLE} <span class="built_in">&amp;</span> <span class="keyword">\Bbb</span>{sample} <span class="built_in">&amp;</span> <span class="keyword">\Bbb</span>{0123}</span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span> </span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{array}{c|ccc}
\text{defalut} & SAMPLE & sample & 0123 \\
\hline
\text{mathbf} & \mathbf{SAMPLE} & \mathbf{sample} & \mathbf{0123} \\
\hline
\text{bf} & {\bf SAMPLE} & {\bf sample} & {\bf 0123} \\
\hline
\text{mathbb} & \mathbb{SAMPLE} & \mathbb{sample} & \mathbb{0123} \\
\hline
\text{Bbb} & \Bbb{SAMPLE} & \Bbb{sample} & \Bbb{0123}
\end{array}</script><h4 id="Bold-symbols"><a href="#Bold-symbols" class="headerlink" title="Bold symbols"></a>Bold symbols</h4><ul>
<li>Use <code>\boldsymbol{text}</code>, which is valid for special symbols.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{c|cccccc}</span><br><span class="line"><span class="keyword">\text</span>{defalut} <span class="built_in">&amp;</span> SAMPLE <span class="built_in">&amp;</span> sample <span class="built_in">&amp;</span> 0123 <span class="built_in">&amp;</span> <span class="keyword">\delta</span><span class="keyword">\theta</span><span class="keyword">\sigma</span><span class="keyword">\omega</span> <span class="built_in">&amp;</span> <span class="keyword">\Delta</span><span class="keyword">\Theta</span><span class="keyword">\Sigma</span><span class="keyword">\Omega</span> <span class="built_in">&amp;</span> <span class="keyword">\sin</span><span class="keyword">\in</span><span class="keyword">\to</span> <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{blodsymbol} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{SAMPLE} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{sample} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{0123} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{<span class="keyword">\delta</span><span class="keyword">\theta</span><span class="keyword">\sigma</span><span class="keyword">\omega</span>} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{<span class="keyword">\Delta</span><span class="keyword">\Theta</span><span class="keyword">\Sigma</span><span class="keyword">\Omega</span>} <span class="built_in">&amp;</span> <span class="keyword">\boldsymbol</span>{<span class="keyword">\sin</span><span class="keyword">\in</span><span class="keyword">\to</span>} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{array}{c|cccccc}
\text{defalut} & SAMPLE & sample & 0123 & \delta\theta\sigma\omega & \Delta\Theta\Sigma\Omega & \sin\in\to \\
\hline
\text{blodsymbol} & \boldsymbol{SAMPLE} & \boldsymbol{sample} & \boldsymbol{0123} & \boldsymbol{\delta\theta\sigma\omega} & \boldsymbol{\Delta\Theta\Sigma\Omega} & \boldsymbol{\sin\in\to} \\
\end{array}</script><h4 id="Italian-font"><a href="#Italian-font" class="headerlink" title="Italian font"></a>Italian font</h4><ul>
<li>Use <code>\mathit{text}</code> or <code>{\it text}</code></li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{c|ccccc}</span><br><span class="line"><span class="keyword">\text</span>{defalut} <span class="built_in">&amp;</span> SAMPLE <span class="built_in">&amp;</span> sample <span class="built_in">&amp;</span> 0123 <span class="built_in">&amp;</span> <span class="keyword">\delta</span><span class="keyword">\theta</span><span class="keyword">\sigma</span><span class="keyword">\omega</span> <span class="built_in">&amp;</span> <span class="keyword">\Delta</span><span class="keyword">\Theta</span><span class="keyword">\Sigma</span><span class="keyword">\Omega</span> <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{mathit} <span class="built_in">&amp;</span> <span class="keyword">\mathit</span>{SAMPLE} <span class="built_in">&amp;</span> <span class="keyword">\mathit</span>{sample} <span class="built_in">&amp;</span> <span class="keyword">\mathit</span>{0123} <span class="built_in">&amp;</span> <span class="keyword">\mathit</span>{<span class="keyword">\delta</span><span class="keyword">\theta</span><span class="keyword">\sigma</span><span class="keyword">\omega</span>} <span class="built_in">&amp;</span> <span class="keyword">\mathit</span>{<span class="keyword">\Delta</span><span class="keyword">\Theta</span><span class="keyword">\Sigma</span><span class="keyword">\Omega</span>} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\text</span>{it} <span class="built_in">&amp;</span> {<span class="keyword">\it</span> SAMPLE} <span class="built_in">&amp;</span> {<span class="keyword">\it</span> sample} <span class="built_in">&amp;</span> {<span class="keyword">\it</span> 0123} <span class="built_in">&amp;</span> {<span class="keyword">\it</span> <span class="keyword">\delta</span><span class="keyword">\theta</span><span class="keyword">\sigma</span><span class="keyword">\omega</span>} <span class="built_in">&amp;</span> {<span class="keyword">\it</span> <span class="keyword">\Delta</span><span class="keyword">\Theta</span><span class="keyword">\Sigma</span><span class="keyword">\Omega</span>} <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{array}{c|ccccc}
\text{defalut} & SAMPLE & sample & 0123 & \delta\theta\sigma\omega & \Delta\Theta\Sigma\Omega \\
\hline
\text{mathit} & \mathit{SAMPLE} & \mathit{sample} & \mathit{0123} & \mathit{\delta\theta\sigma\omega} & \mathit{\Delta\Theta\Sigma\Omega} \\
\hline
\text{it} & {\it SAMPLE} & {\it sample} & {\it 0123} & {\it \delta\theta\sigma\omega} & {\it \Delta\Theta\Sigma\Omega} \\
\hline
\end{array}</script><h4 id="Roman-font"><a href="#Roman-font" class="headerlink" title="Roman font"></a>Roman font</h4><ul>
<li>Use <code>\mathrm{text}</code> or <code>{\rm text}</code></li>
</ul>
<script type="math/tex; mode=display">
\begin{array}{c|ccccc}
\text{defalut} & SAMPLE & sample & 0123 & \delta\theta\sigma\omega & \Delta\Theta\Sigma\Omega \\
\hline
\text{mathrm} & \mathrm{SAMPLE} & \mathrm{sample} & \mathrm{0123} & \mathrm{\delta\theta\sigma\omega} & \mathrm{\Delta\Theta\Sigma\Omega} \\
\hline
\text{rm} & {\rm SAMPLE} & {\rm sample} & {\rm 0123} & {\rm \delta\theta\sigma\omega} & {\rm \Delta\Theta\Sigma\Omega} \\
\end{array}</script><blockquote>
<p>Tips: Lowercase Greek letters do not support Roman script; For Arabic numerals and uppercase Greek letters, the default font is <code>\rm</code>.</p>
</blockquote>
<h4 id="Others-1"><a href="#Others-1" class="headerlink" title="Others"></a>Others</h4><script type="math/tex; mode=display">
\begin{array}{c|ccccc}
\text{defalut} & SAMPLE & sample & 0123 & \delta\theta\sigma\omega & \Delta\Theta\Sigma\Omega \\
\hline
\text{mathsf} & \mathsf{SAMPLE} & \mathsf{sample} & \mathsf{0123} & \mathsf{\delta\theta\sigma\omega} & \mathsf{\Delta\Theta\Sigma\Omega} \\
\hline
\text{sf} & {\sf SAMPLE} & {\sf sample} & {\sf 0123} & {\sf \delta\theta\sigma\omega} & {\sf \Delta\Theta\Sigma\Omega} \\
\hline
\text{mathscr} & \mathscr{SAMPLE} & \mathscr{sample} & \mathscr{0123} & \mathscr{\delta\theta\sigma\omega} & \mathscr{\Delta\Theta\Sigma\Omega} \\
\hline
\text{mathcal} & \mathcal{SAMPLE} & \mathcal{sample} & \mathcal{0123} & \mathcal{\delta\theta\sigma\omega} & \mathcal{\Delta\Theta\Sigma\Omega} \\
\hline
\text{cal} & {\cal SAMPLE} & {\cal sample} & {\cal 0123} & {\cal \delta\theta\sigma\omega} & {\cal \Delta\Theta\Sigma\Omega} \\
\hline
\text{mathtt} & \mathtt{SAMPLE} & \mathtt{sample} & \mathtt{0123} & \mathtt{\delta\theta\sigma\omega} & \mathtt{\Delta\Theta\Sigma\Omega} \\
\hline
\text{tt} & {\tt SAMPLE} & {\tt sample} & {\tt 0123} & {\tt \delta\theta\sigma\omega} & {\tt \Delta\Theta\Sigma\Omega} \\
\hline
\text{mathfrak} & \mathfrak{SAMPLE} & \mathfrak{sample} & \mathfrak{0123} & \mathfrak{ \delta\theta\sigma\omega} & \mathfrak{\Delta\Theta\Sigma\Omega} \\
\hline
\text{frak} & {\frak SAMPLE} & {\frak sample} & {\frak 0123} & \frak{ \delta\theta\sigma\omega} & \frak{\Delta\Theta\Sigma\Omega} \\
\hline
\text{scriptstyle} & {\scriptstyle SAMPLE} & {\scriptstyle sample} & {\scriptstyle 0123} & \scriptstyle{ \delta\theta\sigma\omega} & \scriptstyle{\Delta\Theta\Sigma\Omega}  \\
\hline
\text{scriptstyle+text} & {\scriptstyle \text{SAMPLE} } & {\scriptstyle \text{sample} } & {\scriptstyle \text{0123} } \\
\end{array}</script><h4 id="Mix-fonts"><a href="#Mix-fonts" class="headerlink" title="Mix fonts"></a>Mix fonts</h4><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line">f(n)=</span><br><span class="line"><span class="keyword">\begin</span>{cases}</span><br><span class="line">n/2, <span class="built_in">&amp;</span> <span class="keyword">\text</span>{if <span class="built_in">$</span>n<span class="built_in">$</span> is even} <span class="keyword">\\</span></span><br><span class="line">3n+1, <span class="built_in">&amp;</span> <span class="keyword">\text</span>{if <span class="built_in">$</span>n<span class="built_in">$</span> is odd}</span><br><span class="line"><span class="keyword">\end</span>{cases}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
f(n)=
\begin{cases}
n/2, & \text{if $n$ is even} \\
3n+1, & \text{if $n$ is odd}
\end{cases}</script><ul>
<li>Attention block</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{matrix}</span><br><span class="line"><span class="keyword">\text</span>{if} n <span class="keyword">\text</span>{is even} <span class="keyword">\\</span> <span class="comment">% Bad</span></span><br><span class="line"><span class="keyword">\text</span>{if } n <span class="keyword">\text</span>{ is even} <span class="keyword">\\</span> <span class="comment">% Good</span></span><br><span class="line"><span class="keyword">\text</span>{if}~n~<span class="keyword">\text</span>{is even} <span class="keyword">\\</span> <span class="comment">% Good</span></span><br><span class="line"><span class="keyword">\text</span>{if}<span class="keyword">\ </span>n<span class="keyword">\ </span><span class="keyword">\text</span>{is even} <span class="keyword">\\</span> <span class="comment">% Good</span></span><br><span class="line"><span class="keyword">\end</span>{matrix}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure>
<script type="math/tex; mode=display">
\begin{matrix}
\text{if} n \text{is even} \\ % Bad
\text{if } n \text{ is even} \\ % Good
\text{if}~n~\text{is even} \\ % Good
\text{if}\ n\ \text{is even} \\ % Good
\end{matrix}</script><h2 id="Space"><a href="#Space" class="headerlink" title="Space"></a>Space</h2><blockquote>
<p>$Latex$ automatically ignores spaces, and the space control from wide to narrow is:</p>
</blockquote>
<ul>
<li>Double quad space: 2 characters wide</li>
</ul>
<script type="math/tex; mode=display">\alpha \qquad \beta</script><p>$ \alpha \qquad \beta $</p>
<ul>
<li>Quad space: 1 character wide</li>
</ul>
<script type="math/tex; mode=display">\alpha \quad \beta</script><p>$ \alpha \quad \beta $<br>​</p>
<ul>
<li>Space: 1/3 character wide</li>
</ul>
<script type="math/tex; mode=display">\alpha \ \beta ~ \gamma</script><p>$ \alpha \ \beta ~ \gamma $</p>
<ul>
<li>Medium space: 2/7 characters wide</li>
</ul>
<script type="math/tex; mode=display">\alpha \; \beta</script><p>$ \alpha \; \beta $<br>​</p>
<ul>
<li>Small space: 1/6 character width</li>
</ul>
<script type="math/tex; mode=display">\alpha \, \beta</script><p>$ \alpha \, \beta $<br>​</p>
<ul>
<li>No spaces: 0 characters wide</li>
</ul>
<script type="math/tex; mode=display">\alpha \beta</script><p>$ \alpha \beta $<br>​</p>
<ul>
<li>Snap: -1/6 character width</li>
</ul>
<script type="math/tex; mode=display">\alpha \! \beta</script><p>$ \alpha ! \beta $<br>​</p>
<h2 id="Color"><a href="#Color" class="headerlink" title="Color"></a>Color</h2><ul>
<li>Use <code>{\color{color}{text} }</code> to control color of text.</li>
</ul>
<script type="math/tex; mode=display">\color{red}{text} \quad \color{yellow}{text} \quad \color{blue}{text} \quad \color{green}{text} \quad \color{purple}{text}</script><p>$ \color{red}{text} \quad \color{yellow}{text} \quad \color{blue}{text} \quad \color{green}{text} \quad \color{purple}{text} $<br>​</p>
<ul>
<li>You can also use capital initials to represent complex colors.</li>
</ul>
<script type="math/tex; mode=display">\color{Red}{text} \quad \color{Orange}{text} \quad \color{RoyalBlue}{text} \quad \color{Violet}{text} \quad \color{LimeGreen}{text}</script><p>$ \color{Red}{text} \quad \color{Orange}{text} \quad \color{RoyalBlue}{text} \quad \color{Violet}{text} \quad \color{LimeGreen}{text} $</p>
<ul>
<li>Use <code>{\color{ #rgb}{text} }</code> to control more complex colors. However, this is not possible in some renderings, so it is not shown here.</li>
</ul>
<script type="math/tex; mode=display">\color{ #0FF}{text} \quad \color{ #00F}{text} \quad \color{ #F0F}{text} \quad \color{ #0F0}{text} \quad \color{ #6CF}{text}</script><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ul>
<li>Use the <code>\boxed</code> command or with the border of a 1*1 table</li>
</ul>
<script type="math/tex; mode=display">\boxed {E=mc^2}</script><p>$ \boxed {E=mc^2} $<br></p><figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{array}{|c|}</span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line">E=mc<span class="built_in">^</span>2 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\hline</span></span><br><span class="line"><span class="keyword">\end</span>{array}</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<script type="math/tex; mode=display">
\begin{array}{|c|}
\hline
E=mc^2 \\
\hline
\end{array}</script><ul>
<li>Some useful $ Latex $ websites.</li>
</ul>
<ol>
<li><a href="https://www.tablesgenerator.com">Tables Generator</a></li>
<li><a href="http://detexify.kirelabs.org/classify.html">Classify Symbols</a></li>
<li><a href="http://www.codecogs.com/latex/eqneditor.php">Equation Editor</a></li>
</ol>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Latex</tag>
      </tags>
  </entry>
  <entry>
    <title>Keepalived浅入浅出</title>
    <url>/2024/07/04/Keepalived%E6%B5%85%E5%85%A5%E6%B5%85%E5%87%BA/</url>
    <content><![CDATA[<blockquote>
<p>Record some about <code>Keepalived</code> installation and usage skills.</p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-前言"><a href="#books-1-前言" class="headerlink" title=":books: 1. 前言"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1. 前言</h2><h3 id="1-1-出现的背景"><a href="#1-1-出现的背景" class="headerlink" title="1.1. 出现的背景"></a>1.1. 出现的背景</h3><blockquote>
<p>起初用来监控虚拟服务器集群(Linux Virtual Server, LVS)中各服务节点的状态，剔除故障节点，重新加入恢复的节点；后又加入虚拟路由冗余协议(Vritrual Router Redundancy Protocol, VRRP)，解决静态路由出现单点故障。主要实现服务器状态检测和故障隔离，高可用集群。</p>
</blockquote>
<ul>
<li><code>Client</code>向<code>Server</code>发送请求，随着服务量的增加，单机<code>Server</code>无法支持</li>
<li>使用分布式架构，用<code>Nginx</code>反向代理和多<code>Server</code>实现分布式架构和负载均衡</li>
<li>流量全部打在<code>Nginx</code>上，出现宕机，导致无法访问<code>Server</code></li>
<li>使用<code>Keepalived</code>+多<code>Nginx</code>实现分布式的<code>Nginx</code>，主从架构实现高可用</li>
</ul>
<h3 id="1-2-和HeartBeat比较"><a href="#1-2-和HeartBeat比较" class="headerlink" title="1.2. 和HeartBeat比较"></a>1.2. 和HeartBeat比较</h3><ul>
<li><code>Keepalived</code>轻量级的高可用解决方案，通过VRRP实现，模拟路由器的多机，当主机的下一跳路由出现故障，由另一台主机替代工作，部署和使用相对简单，配置文件单一，无管理功能；<code>HeartBeat</code>基于主机或网络服务的高可用，拆分为多个子项目，安装配置以及使用相对复杂，具有管理功能，用户服务的多机。</li>
<li><code>HeartBeat</code>除了走网络通信还可以用串口通信，可靠性更高。</li>
<li>LVS高可用建议用<code>Keepalived</code>，业务高可用建议用<code>HeartBeat</code>。</li>
</ul>
<h2 id="2-VRRP"><a href="#2-VRRP" class="headerlink" title="2. VRRP"></a>2. VRRP</h2><blockquote>
<p>多主机之间通过静态路由完成通信，一旦路由器故障，可以通过VRRP协议进行切换，保证网络的连通性。VRRP由两台或多台物理路由器设备虚拟成一个虚拟路由器，通过虚拟IP对外提供服务。</p>
</blockquote>
<ul>
<li>虚拟路由器：对外服务，拥有虚拟IP+MAC地址</li>
<li>主路由器(master)：虚拟路由器内部通常只有一台物理路由器对外提供服务，由选举算法产生master</li>
<li>备份路由器(backup)：除主路由器外的所有路由器，不对外提供服务，只接受主路由的通知，master挂掉之后由选举算法产生新的master</li>
</ul>
<h3 id="2-1-VRRP工作模式"><a href="#2-1-VRRP工作模式" class="headerlink" title="2.1. VRRP工作模式"></a>2.1. VRRP工作模式</h3><ul>
<li>工作状态<ul>
<li><code>Initialize</code>状态</li>
<li><code>Master</code>状态</li>
<li><code>Backup</code>状态</li>
</ul>
</li>
<li>选举机制<ul>
<li>默认抢占模式，一旦有优先级高的路由器加入，立即成为Master。原来的Master重新恢复后，会重新接管服务，多了一次不必要的VirtualIP切换。</li>
<li>非抢占模式下，只要Master不挂掉，优先级高的路由器只能等待。原来的Master重新恢复后，状态会变为Backup，不会接管服务。</li>
</ul>
</li>
</ul>
<h3 id="2-2-抢占模式"><a href="#2-2-抢占模式" class="headerlink" title="2.2 抢占模式"></a>2.2 抢占模式</h3><ul>
<li><code>Example 1</code>，只要优先级更高，就会获取Master，与状态无关<ul>
<li><code>Server1</code>为<code>Master</code>，<code>Server2</code>为<code>Master</code>或<code>Backup</code>，且<code>Server1</code>优先级更高，启动后<code>Server1</code>成为<code>Master</code>，<code>Server2</code>降级成为<code>Backup</code>；若此时<code>Server1</code>宕机，将由<code>Server2</code>接管服务，后续当<code>Server1</code>恢复后又变为<code>Master</code>，<code>Server2</code>降级成为<code>Backup</code>，属于抢占式。</li>
<li><code>Server1</code>为<code>Master</code>，<code>Server2</code>为<code>Backup</code>，但<code>Server1</code>优先级低，启动后<code>Server2</code>成为<code>Master</code>，<code>Server1</code>降级成为<code>Backup</code>；若此时<code>Server2</code>宕机，将由<code>Server1</code>接管服务，后续当<code>Server2</code>回复后又变为<code>Master</code>，<code>Server1</code>降级成为<code>Backup</code>，属于抢占式。</li>
</ul>
</li>
<li><code>Example 2</code>，两个<code>Backup</code>节点，必须配置<code>nopreempt</code><ul>
<li><code>Server1</code>和<code>Server2</code>都为<code>Backup</code>，先启动的升级为<code>Master</code>，必须配置<code>nopreempt</code>，若<code>Server1</code>宕机，<code>Server2</code>会接管服务，<code>Server1</code>恢复后不会重新接管，<code>Server1</code>成为<code>Backup</code>，属于非抢占式。</li>
</ul>
</li>
</ul>
<h2 id="3-工作原理"><a href="#3-工作原理" class="headerlink" title="3. 工作原理"></a>3. 工作原理</h2><blockquote>
<p>工作在<code>TCP/IP</code>模型的第三、四和五层，即网络层、传输层和应用层。<br>网络层：通过<code>IMCP</code>协议向集群的每个节点发送数据包，检测节点的存活状态，若无响应则报告节点失效，从集群中剔除；<br>传输层:通过<code>TCP</code>协议的端口连接和扫描判断集群节点连接是否正常，若探测到没有响应数据判定为发生故障，从集群中剔除；<br>应用层：可以写脚本来检测服务是否正常以及剔除节点。</p>
</blockquote>
<ul>
<li>Scheduler I/O Multiplexer<ul>
<li>IO服用分发器，调度Keepalived所有的内部任务请求</li>
</ul>
</li>
<li>Memory Management<ul>
<li>内存管理机制，提供访问内从的通用方法</li>
</ul>
</li>
<li>Control Plane，Keepalived运行时会启动<code>core</code>、<code>check</code>和<code>vrrp</code>三个进程<ul>
<li>Core Components<ul>
<li>Watch Dog<ul>
<li>看门狗，针对被监视目标设置计数器和阈值，等待目标周期性重置计数器，若发生错误无法重置将被检测到。用来监控Checkers和VRRP进程</li>
</ul>
</li>
<li>Checkers<ul>
<li>实现对服务器的运行状态检测和故障隔离</li>
</ul>
</li>
<li>VRRP Stack<ul>
<li>实现失败切换功能，通过VRRP和LVS即可部署高性能的负载均衡集群</li>
</ul>
</li>
<li>IPVS Wrapper<ul>
<li>实现IPVS，将设置好的IPVS规则发送到内核空间并提交给IPVS模块，实现最终的负载均衡</li>
</ul>
</li>
<li>Netlink Reflector<ul>
<li>VIP的设置和切换</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="4-选举策略"><a href="#4-选举策略" class="headerlink" title="4. 选举策略"></a>4. 选举策略</h2><ul>
<li>控制节点角色由两个值决定，配置文件中的<code>priority</code>；vrrp_scritp模块中配置的<code>weigth</code>，可正可负。<ul>
<li>不设置<code>weight</code>时，集群中的优先级由<code>priority</code>决定，优先级高的节点成为<code>Master</code>，优先级低的节点成为<code>Backup</code>；但如果<code>Master</code>出现故障后<code>Backup</code>的<code>priority</code>小于<code>Master</code>的<code>priority</code>，导致主备切换失败。</li>
<li>设置<code>weight</code><ul>
<li>若<code>weight</code>为正<ul>
<li>主成功，<code>master priority + weight &gt; backup priority + weight</code>时，主依然为主</li>
<li>主失败，<code>master priority &lt; backup priority + weight</code>时，主从切换</li>
</ul>
</li>
<li>若<code>weight</code>为负<ul>
<li>主成功<code>master priority &gt; backup priority</code>时，主依然为主</li>
<li>主失败，<code>master priority - abs(weight) &lt; backup priority</code>时，主从切换</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="5-相关配置"><a href="#5-相关配置" class="headerlink" title="5. 相关配置"></a>5. 相关配置</h2><ul>
<li><p>备份配置</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>全局配置</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">  notification_email {</span><br><span class="line">    acassen@firewall.loc</span><br><span class="line">    failover@firewall.loc</span><br><span class="line">    sysadmin@firewall.loc</span><br><span class="line">  }</span><br><span class="line">  notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">  smtp_server 192.168.200.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">  vrrp_skip_check_adv_addr</span><br><span class="line">  vrrp_strict</span><br><span class="line">  vrrp_garp_interval 0</span><br><span class="line">  vrrp_gna_interval 0</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">global_defs #全局配置标识</span><br><span class="line">notification_email #用于设置报警的邮件地址，可以设置多个，每行一个。如果要开启邮件报警，需要开启本机的sendmail服务</span><br><span class="line">notification_email_from #邮件的发送地址</span><br><span class="line">smtp_server #设置邮件的smtp server地址</span><br><span class="line">smtp_connect_timeout #设置连接smtp server的超时时间</span><br><span class="line">router_id # 运行keepalived的一个标识，唯一</span><br><span class="line">vrrp_skip_check_adv_addr ##对所有通告报文都检查，会比较消耗性能，启用此配置后，如果收到的通告报文和上一个报文是同一个路由器，则跳过检查，默认值为全检查</span><br><span class="line">vrrp_strict ##严格遵守VRRP协议,启用此项后以下状况将无法启动服务:1.无VIP地址 2.配置了单播邻居 3.在VRRP版本2中有IPv6地址，开启动此项并且没有配置vrrp_iptables时会自动开启iptables防火墙规则，默认导致VIP无法访问,建议不加此项配置</span><br><span class="line">vrrp_iptables #此项和vrrp_strict同时开启时，则不会添加防火墙规则,如果无配置vrrp_strict项,则无需启用此项配置</span><br><span class="line">vrrp_garp_interval 0 #gratuitous ARP messages 报文发送延迟，0表示不延迟</span><br><span class="line">vrrp_gna_interval 0 ##unsolicited NA messages （不请自来）消息发送延迟</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>VRRP配置</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vrrp_script nginx_check {</span><br><span class="line">    script<span class="string">"/tools/nginx_check.sh"</span></span><br><span class="line">    interval 1</span><br><span class="line">}</span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="built_in">test</span></span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        192.168.149.100</span><br><span class="line">    }</span><br><span class="line">    track_script {</span><br><span class="line">        nginx_check</span><br><span class="line">    }</span><br><span class="line">    notify_master /tools/master.sh</span><br><span class="line">    notify_backup /tools/backup.sh</span><br><span class="line">    notify_fault /tools/fault.sh</span><br><span class="line">    notify_stop /tools/stop.sh</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">vrrp_instance VI_1 #VRRP实例开始的标识 VI_1为实例名称</span><br><span class="line">state #指定keepalived的角色，MASTER表示此主机是主服务器，BACKUP表示此主机是备服务器</span><br><span class="line">interface #指定检测网络的网卡接口</span><br><span class="line">virtual_router_id #虚拟路由标识，数字形式，同一个VRRP实例使用唯一的标识，即在同一个vrrp_instance下，master和backup必须一致</span><br><span class="line">priority #节点优先级，数字越大表示节点的优先级越高，在一个VRRP实例下，MASTER的优先级必须要比BACKUP高，不然就会切换角色</span><br><span class="line">advert_int #用于设定MASTER与BACKUP之间同步检查的时间间隔，单位为秒</span><br><span class="line">auth_type PASS #预共享密钥认证，同一个虚拟路由器的keepalived节点必须一样</span><br><span class="line">auth_pass #设置密钥</span><br><span class="line">virtual_ipaddress #设置虚拟IP地址，可以设置多种形式：10.0.0.100不指定网卡，默认为eth0,注意：不指定/prefix,默认为/32；10.0.0.101/24 dev eth1 指定VIP的网卡；10.0.0.102/24 dev eth2 label eth2:1  #指定VIP的网卡label</span><br><span class="line">nopreempt # 设置为非抢占模式，同一实例下主备设置必须一样</span><br><span class="line">preemtp_delay # 设置抢占模式的延时时间，单位为秒</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="6-集群资源监控"><a href="#6-集群资源监控" class="headerlink" title="6. 集群资源监控"></a>6. 集群资源监控</h2><blockquote>
<p>通过<code>track_script</code>和<code>vrrp_script</code>实现集群资源监控及改变优先级，实现主从切换</p>
</blockquote>
<ul>
<li><code>killall</code>探测服务运行状态</li>
</ul>
<blockquote>
<p>定义服务监控模块<code>nginx_check</code>，如果发现进程异常或关闭返回状态码<code>1</code></p>
</blockquote>
  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vrrp_script nginx_check {</span><br><span class="line">    script<span class="string">"killall -0 nginx"</span></span><br><span class="line">    interval 1</span><br><span class="line">}</span><br><span class="line">track_script {</span><br><span class="line">    nginx_check</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>检测端口状态</li>
</ul>
<blockquote>
<p><code>fail</code>表示检测到失败的最大次数，也就是说如果请求失败两次，就认为此节点资源发生故障，进行切换操作；<code>rise</code>表示请求一次成功，就认为此节点资源恢复正常</p>
</blockquote>
  <figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vrrp_script nginx_check {</span><br><span class="line">    script <span class="string">"&lt;/dev/tcp/127.0.0.1/80"</span></span><br><span class="line">    interval 1</span><br><span class="line">    fail 2</span><br><span class="line">    rise 1</span><br><span class="line">}</span><br><span class="line">track_script {</span><br><span class="line">    nginx_check</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Keepalived</tag>
        <tag>Load Balance</tag>
      </tags>
  </entry>
  <entry>
    <title>MapReduce in Distributed Systems</title>
    <url>/2024/03/14/MapReduce/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>MIT 6.824 Distributed Systems Lab-1-Golang<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f565.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<h1 id="MIT-6-824-Distributed-Systems"><a href="#MIT-6-824-Distributed-Systems" class="headerlink" title="MIT 6.824 Distributed Systems"></a>MIT 6.824 Distributed Systems</h1><h1 id="Lecture-01-Introduction"><a href="#Lecture-01-Introduction" class="headerlink" title="Lecture 01 - Introduction"></a>Lecture 01 - Introduction</h1><h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><ul>
<li><a href="https://pdos.csail.mit.edu/6.824/schedule.html">MIT 6.5840 Schedule: Spring 2024</a></li>
<li><a href="http://nil.csail.mit.edu/6.824/2020/schedule.html">MIT 6.824 Schedule: Spring 2020</a></li>
<li><a href="https://www.youtube.com/watch?v=cQP8WApzIQQ&amp;list=PLrw6a1wE39_tb2fErI4-WkMbsvGQk9_UB">Youtube 2020</a></li>
<li>BiliBili Translated:<ul>
<li><a href="https://www.bilibili.com/video/BV1x7411M7Sf/?spm_id_from=333.999.0.0&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc">https://www.bilibili.com/video/BV1x7411M7Sf/?spm_id_from=333.999.0.0&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc</a></li>
<li><a href="https://www.bilibili.com/video/BV1R7411t71W/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc">https://www.bilibili.com/video/BV1R7411t71W/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc</a></li>
</ul>
</li>
</ul>
<h2 id="MapReduce-基本工作方式"><a href="#MapReduce-基本工作方式" class="headerlink" title="MapReduce 基本工作方式"></a>MapReduce 基本工作方式</h2><p><img src="https://www.lingzhicheng.cn/usr/file/picture/MIT/MapReduce.PNG" alt="Read MapReduce(2024) png"></p>
<p><a href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">Read MapReduce(2024)</a></p>
<p><strong>Map：</strong> 接受一个键值对(key-value pair)，产生一组中间键值对。MapReduce 会将 Map 函数产生的中间键值对传递给一个 Reduce 函数。</p>
<p><strong>Reduce：</strong> 接受一个键以及相关的一组值，将这组值进行合并产生一组规模更小的值(通常只有一个或零个值)。</p>
<p>在实现的过程中，Reduce 函数使用 Iterator 读取中间结果，为了防止值过多，而无法全部放到内存中。</p>
<p><strong>Types:</strong></p>
<p><code>map    (k1,v1)       -&gt; list(k2,v2)</code></p>
<p><code>reduce (k2,list(v2)) -&gt; list(v2)</code></p>
<p>词频统计伪代码：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">map</span>(String key, String value):</span><br><span class="line">    <span class="comment">// key: document name</span></span><br><span class="line">    <span class="comment">// value: document contents</span></span><br><span class="line">    <span class="keyword">for</span> each word w in value:</span><br><span class="line">        <span class="built_in">EmitIntermediate</span>(w, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">reduce</span>(String key, Iterator values):</span><br><span class="line">    <span class="comment">// key: a word</span></span><br><span class="line">    <span class="comment">// values: a list of counts</span></span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> each v in values:</span><br><span class="line">        result += <span class="built_in">ParseInt</span>(v);</span><br><span class="line">    <span class="built_in">Emit</span>(<span class="built_in">AsString</span>(result));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><ol>
<li>用户程序将输入文件切分为 M 个 16～64MB 之间的 split，并在集群中创建程序副本。</li>
<li>程序副本分为 1 个 Master 和多个 Worker。Master 选取空闲的 Worker，并为其分配 Map 任务或 Reduce 任务。Master 存储任务的状态(空闲，工作中，完成)和 worker 机器(非空闲任务的机器)的标识。</li>
<li>Mapper 读取对应的 split 并<strong>调用用户定义的 map 函数</strong>解析为键值对，将输出的中间结果键值对存储到内存中。</li>
<li>Mapper 将缓存的键值对通过 Partition 函数(通常为 hash(key) mod R)划分为 R 个部分，并周期性地写入本地磁盘，同时将本地磁盘上中间结果的位置信息发送给 Master。</li>
<li>Master 将收到的中间结果的位置信息发送给 Reducer，Reducer 通过 RPC 读取存储在 Mapper 本地磁盘上的中间结果。在读取完毕后，<u>Reducer 会根据 key 对中间结果进行排序</u>。</li>
<li>对每一个 key 和其对应的一组值，<strong>调用用户定义的 Reduce 函数</strong>进行处理，输出结果存储在对应的 Reduce Partition 文件中。</li>
<li>当所有的 Map 任务和 Reduce 任务完成后，Master 通知用户程序。</li>
</ol>
<h3 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h3><ul>
<li>worker 失效</li>
</ul>
<p>Master 会<strong>周期性地 ping</strong> 每一个 Worker，如果某个 Worker 在一段时间内没有响应，Master 就会认为这个 Worker 已经不可用，对其上分配的任务<strong>重新分配</strong>给其他 Worker。</p>
<ul>
<li>master 失效</li>
</ul>
<p>Master 会周期性地将集群的当前状态作为 <strong>checkpoint</strong> 写入到磁盘中。Master 发生故障后，重新启动 Master 即可利用存储在磁盘中的最近的 checkpoint 进行<strong>恢复</strong>。</p>
<h3 id="数据存储机制"><a href="#数据存储机制" class="headerlink" title="数据存储机制"></a>数据存储机制</h3><p>由于网络带宽是一种相当匮乏的计算资源，MapReduce 将数据存储在本地磁盘，由 GFS 进行管理。GFS 把每一份文件划分为多个 64MB 的 block，通常情况下，每个 block 会在不同的机器上保存三份副本。Master 在调度 Map 任务时会考虑输入数据的位置信息，采取<strong>就近原则</strong>，即尽量将 Map 任务<strong>调度到包含相关输入数据副本的机器上执行</strong>。因而大部分输入数据可以从本地读取，消耗非常少的网络带宽。</p>
<h3 id="负载均衡机制"><a href="#负载均衡机制" class="headerlink" title="负载均衡机制"></a>负载均衡机制</h3><p>Master 将 Map 任务和 Reduce 任务划分为 M 和 R 个片段，<strong>M 和 R 的数量应远大于集群中 Worker 的数量</strong>。每个 Worker 执行大量不同的任务有助于提高集群的动态负载均衡能力，并且加快故障恢复的速度。</p>
<h3 id="备份任务机制"><a href="#备份任务机制" class="headerlink" title="备份任务机制"></a>备份任务机制</h3><p>如果集群中某个 Worker 花了很长时间才完成最后几个 Map 任务或 Reduce 任务，导致 MapReduce 总执行时间延长，这样的 Worker 被称为落后者(Straggler)。MapReduce 提供了备份任务机制来缓解这种情况。当 MapReduce 快要完成时，<strong>Master 为剩下的正在运行的任务启动备份任务，将其分配给其他的空闲 Worker 来执行</strong>，并在其中一个 Worker 完成后将该任务视作已完成。通过备份任务机制，大大减少了 MapReduce 的执行时间。</p>
<h2 id="Lab1-MapReduce"><a href="#Lab1-MapReduce" class="headerlink" title="Lab1: MapReduce"></a>Lab1: MapReduce</h2><p>Lab source: <a href="https://pdos.csail.mit.edu/6.824/labs/lab-mr.html">https://pdos.csail.mit.edu/6.824/labs/lab-mr.html</a></p>
<ul>
<li><p>System <code>(hostnamectl)</code></p>
<ul>
<li>Static hostname: ubuntu</li>
<li>Icon name: computer-vm</li>
<li>Chassis: vm</li>
<li>Virtualization: vmware</li>
<li>Operating System: Ubuntu 18.04.6 LTS</li>
<li>Kernel: Linux 5.4.0-144-generic</li>
<li>Architecture: x86-64</li>
</ul>
</li>
<li><p>Goland version <code>(go version)</code></p>
<ul>
<li>go version go1.19.5 linux/amd64</li>
</ul>
</li>
<li><p>GCC <code>(gcc -version)</code></p>
<ul>
<li>gcc (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0</li>
</ul>
</li>
</ul>
<h3 id="Remote-debug"><a href="#Remote-debug" class="headerlink" title="Remote debug"></a>Remote debug</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">go install github.com/go-delve/delve/cmd/dlv@latest</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Sequential-and-Settings"><a href="#Sequential-and-Settings" class="headerlink" title="Sequential and Settings"></a>Sequential and Settings</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/6.5840</span><br><span class="line">$ <span class="built_in">cd</span> src/main</span><br><span class="line">$ go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">$ <span class="built_in">rm</span> mr-out*</span><br><span class="line">$ go run mrsequential.go wc.so pg*.txt</span><br><span class="line">$ more mr-out-0</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<p>运行 <code>go build -buildmode=plugin ../mrapps/wc.go</code> 命令将生成一个插件文件，即构建 MR APP 的动态链接库。在这种情况下，生成的文件将具有 <code>.so</code> 扩展名，表示它是一个共享对象文件（shared object），用于动态加载到其他程序中。</p>
<p>通常情况下，生成的文件名将与源文件的包名相同，只是扩展名为 <code>.so</code>，例如 <code>wc.so</code>。当然，在 windows 下是不显示的，即使同步了双端代码，如果在 win 下生成将用 <code>.dll</code> 表示动态链接库。</p>
<p>文件 <code>wc.go</code> 以及 <code>mrapps</code> 目录下的其它几个文件，都定义了名为 <code>map, reduce</code> 的函数，这两个函数在 <code>mrsequential.go</code> 中加载并调用。给 <code>mrsequential</code> 绑定不同的 <code>*.so</code> 文件，也就会加载不同的 <code>map, reduce</code> 函数。如此实现某种程度上的<strong>动态绑定。</strong></p>
<h4 id="可能会报错"><a href="#可能会报错" class="headerlink" title="可能会报错"></a>可能会报错</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># runtime/cgo</span></span><br><span class="line">cgo: C compiler <span class="string">"gcc"</span> not found: <span class="built_in">exec</span>: <span class="string">"gcc"</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span></span><br></pre></td></tr></tbody></table></figure>
<p>It seems like the error message you’re encountering is related to the absence of the C compiler “gcc” in your system’s PATH variable.</p>
<p>To resolve this issue, you will need to ensure that the GNU Compiler Collection (GCC) is installed on your system and that its location is included in the PATH environment variable.</p>
<p>Here are the general steps to address this issue:</p>
<ol>
<li><strong>Install GCC:</strong><br>If you don’t have GCC installed, you can typically install it using your system’s package manager. For example, on a Debian-based system, you can use:</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update  </span><br><span class="line">sudo apt-get install build-essential</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li><strong>Add GCC to PATH:</strong><br>Once installed, you should ensure that the directory containing the GCC executable is included in your PATH environment variable. This can typically be achieved by adding a line to your shell configuration file (e.g., <strong>`**</strong>.bashrc<strong>**`</strong>, <strong>`**</strong>.zshrc<strong>**`</strong>, etc.):</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/path/to/gcc/directory</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li><strong>Verify Installation:</strong><br>After making these changes, open a new terminal or run <strong>source</strong>on the configuration file to apply the changes. You can then verify that GCC is accessible by running <strong>gcc —version</strong>.</li>
</ol>
<h4 id="配置优化"><a href="#配置优化" class="headerlink" title="配置优化"></a>配置优化</h4><ul>
<li>原始命令</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/6.5840</span><br><span class="line">$ <span class="built_in">cd</span> src/main</span><br><span class="line">$ go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">$ <span class="built_in">rm</span> mr-out*</span><br><span class="line">$ go run mrsequential.go wc.so pg*.txt</span><br><span class="line">$ more mr-out-0</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>.vscode/launch.json</code></li>
</ul>
<blockquote>
<p>注意：这里的”args”貌似不支持通配符 <code>*</code>，所以需要手动把所有文件全部加进去，<u>或许可能有其他办法。</u></p>
</blockquote>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">,</span> <span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    _<span class="comment">// Use IntelliSense to learn about possible attributes._</span></span><br><span class="line">    _<span class="comment">// Hover to view descriptions of existing attributes._</span></span><br><span class="line">    _<span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387_</span></span><br><span class="line">    <span class="attr">"version"</span><span class="punctuation">:</span> <span class="string">"0.2.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"configurations"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrcoordinator.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrcoordinator.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"cwd"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrworker.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrworker.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"cwd"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"preLaunchTask"</span><span class="punctuation">:</span> <span class="string">"build wc &amp;&amp; temp dir"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrsequential.go with wc.so"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrsequential.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"env"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">,</span> <span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"preLaunchTask"</span><span class="punctuation">:</span> <span class="string">"build wc"</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>.vscode/tasks.json</code></li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"version"</span><span class="punctuation">:</span> <span class="string">"2.0.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"tasks"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build wc"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"shell"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bash"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"${workspaceFolder}/src/main/build-wc.sh"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"problemMatcher"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"group"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"kind"</span><span class="punctuation">:</span> <span class="string">"build"</span><span class="punctuation">,</span>  </span><br><span class="line">              <span class="attr">"isDefault"</span><span class="punctuation">:</span> <span class="keyword">true</span>  </span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">"presentation"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"reveal"</span><span class="punctuation">:</span> <span class="string">"silent"</span>  </span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build temp dir"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"shell"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bash"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"${workspaceFolder}/src/main/build-temp-dir.sh"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"problemMatcher"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"group"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"kind"</span><span class="punctuation">:</span> <span class="string">"build"</span><span class="punctuation">,</span>  </span><br><span class="line">              <span class="attr">"isDefault"</span><span class="punctuation">:</span> <span class="keyword">true</span>  </span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"presentation"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"reveal"</span><span class="punctuation">:</span> <span class="string">"silent"</span>  </span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build wc &amp;&amp; temp dir"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"dependsOn"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"build wc"</span><span class="punctuation">,</span> <span class="string">"build temp dir"</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>6.8540/src/main/build-wc.sh</code></li>
</ul>
<blockquote>
<p>注意：如果出现 <code>cannot load plugin wc.so</code>，需要加上 <code>-gcflags="all=-N -l"</code>，以禁用优化和内联，但这不一定是必要的，如果直接在 Terminal 进行动态库的生成，则不需要。</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Building wc plugin..."</span></span><br><span class="line"><span class="built_in">cd</span> src/main</span><br><span class="line">go build -buildmode=plugin -gcflags=<span class="string">"all=-N -l"</span> ../mrapps/wc.go</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"wc plugin built"</span></span><br><span class="line"><span class="built_in">rm</span> -f mr-*</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deleted old mr-* files"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Our-tasks"><a href="#Our-tasks" class="headerlink" title="Our tasks"></a>Our tasks</h2><blockquote>
<p>Your job is to implement a distributed MapReduce, consisting of two programs, the coordinator and the worker. There will be just one coordinator process, and one or more worker processes executing in parallel. In a real system the workers would run on a bunch of different machines, but for this lab you’ll run them all on a single machine. The workers will talk to the coordinator via RPC. Each worker process will, in a loop, ask the coordinator for a task, read the task’s input from one or more files, execute the task, write the task’s output to one or more files, and again ask the coordinator for a new task. The coordinator should notice if a worker hasn’t completed its task in a reasonable amount of time (for this lab, use ten seconds), and give the same task to a different worker.</p>
</blockquote>
<ul>
<li>主体：完成一个分布式的 MapReduce，由一个 coordinator 进程（在之前的版本中用 master 称呼）和多个并行的 worker 进程组成。现实中真实的分布式系统通常运行在一堆不同的设备上，但在这里只用一台计算机，worker 通过 RPC 和 coordinator 通信。每一个 worker 进程将循环地向 coordinator 请求 task，从 task 的输入中读取一个或多个文件，执行程序然很将结果输出到一个或多个文件，然后再次请求新的 task。如果一个 worker 长时间没有完成 task（这里设置为 10s），coordinator 将通知另一个 worker 来执行这个 task。</li>
<li>注意：<code>main/mrcoordinator.go</code> 和 <code>main/mrworker.go</code> 是 test 的入口，不要求改。需要完成的在 <code>mr/coordinator.go</code>、<code>mr/worker.go</code> 和 <code>mr/rpc.go</code>。</li>
<li><p>大致的测试步骤：</p>
<ul>
<li><p>构建中间件用于 word-count，这里和上面类似，后续可以附带在启动 mrworker 的任务中。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">go build -buildmode=plugin ../mrapps/wc.go</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动mrcoordinator，输入是所有txt文件，每一个文件代表一个split，同样的这里也要注意通配符。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> mr-out*</span><br><span class="line">go run mrcoordinator.go pg-*.txt</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动多个mrworker</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">go run mrworker.go wc.so</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>按顺序排序后的词频统计应当和序列化单机的结果保持一致，用main/test-mr.sh进行测试，将测试输出是否保持正确，是否具有修复崩溃worker的能力</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> mr-out-* | <span class="built_in">sort</span> | more</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>结果将生成多个mr-out-X文件</p>
</li>
<li>可能会出现RPC的报错rpc.Register: method “Done” has 1 input parameters; needs exactly three，Done()没有通过RPC，先忽略</li>
</ul>
</li>
</ul>
<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><ul>
<li>map 阶段应当将中间态的 keys 划分到 <code>nReduce</code> 个桶进行 reduce 任务，这个数量就是 reduce 任务的数量，这个参数是从 <code>main/mrcoordinator.go</code> 传入到 <code>mr/coordinator.go</code> 的 <code>MakeCoordinator()</code> 函数的。为了减少任务的消耗，每一个 mapper 应当创建 <code>nReduce</code> 个中间文件。</li>
<li>worker 应当将第 X 个 reduce 任务的输出放到 <code>mr-out-X</code>。</li>
<li><code>mr-out-X</code> 的输出格式，每一行包括一个 Reduce 函数的输出，以键值对的形式表示，用 <code>"%v %v"</code> 进行格式化，参照 <code>main/mrsequential.go</code>。格式错误可能导致测试不通过。</li>
<li>worker 应当将 Map 的输出文件放在当前目录下，以便它作为 Reduce 任务的输入。</li>
<li>当 MapReduce 任务完全结束时，<code>mr/coordinator.go</code> 的 <code>Done()</code> 方法应当返回 <code>true</code>，此时 <code>main/mrcoordinator.go</code> 将退出。</li>
<li>worker 也应当退出。一个简单的实现方法可以是使用 <code>call()</code> 的返回值，如果 worker 联系不上 coordinator，则说明任务已经完成，coordinator 已经退出，此时 worker 也可以退出。</li>
</ul>
<h3 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h3><ul>
<li>相关 Golang 的知识 <a href="https://pdos.csail.mit.edu/6.824/labs/guidance.html">https://pdos.csail.mit.edu/6.824/labs/guidance.html</a></li>
<li>一个入手的方法就是，设计 <code>mr/worker.go</code> 的 <code>Worker()</code> 函数，通过 RPC 向 coordinator 请求一个任务，然后设计 coordinator 的响应（尚未进行 map 任务的文件名），再设计 worker 如何读取这些文件，调用 Map 函数（类似于 <code>mrsequential.go</code>）。</li>
<li>Map 和 Reduce 函数是通过 go 的 plugin 进行动态加载的，后缀是 <code>.so</code> 的文件。</li>
<li>如果修改了 <code>mr/</code> 目录下的任何东西，最好都重新加载一下 plugin，也就是上面提到的放到 tasks 里面作为启动前的任务。</li>
<li>当前的 lab 是基于一台机器进行文件操作的，如果是多台机器则需要全局的文件系统例如 GFS，在此并未考虑。</li>
<li>中间文件的命名，可以是 <code>mr-X-Y</code>，其中 X 是 Map 任务的编号，Y 是 reduce 任务的编号。</li>
<li><p>map 任务存储的中间态键值对格式应当可以直接被 reduce 任务读取，一个可行的办法是使用 go 的 <code>encoding/json</code> 包：</p>
  <figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// write</span></span><br><span class="line">enc := json.NewEncoder(file)</span><br><span class="line"><span class="keyword">for</span> _, kv := ... {</span><br><span class="line">err := enc.Encode(&amp;kv)</span><br><span class="line"></span><br><span class="line"><span class="comment">// read</span></span><br><span class="line">dec := json.NewDecoder(file)</span><br><span class="line"><span class="keyword">for</span> {</span><br><span class="line">    <span class="keyword">var</span> kv KeyValue</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    }</span><br><span class="line">    kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>map部分可以用<code>worker.go</code>里的<code>ihash(key)</code>函数通过给定的key来选择reduce任务。</p>
</li>
<li><p>可以参考部分<code>mrsequential.go</code>中的代码，是非常有用的。</p>
</li>
<li><p>coordinator是一个RPC服务，可能会有并发的问题，应当给一些数据加锁。</p>
</li>
<li><p>使用<code>go run-race</code>来引入go的竞态检测器，<code>test-mr.sh</code>开头有一段如何使用的说明，测试不会使用竞态检测器。不过，如果代码存在竞态，测试时会失败。</p>
</li>
<li><p>workers有时候需要等待，例如reduces需要再最后一个map完成再工作。一个解决方案是workers周期性地向coordinator请求work，使用<code>time.Sleep()</code>；另一个方法是再relevant RPC handler中使用<code>time.Sleep()</code>或者<code>sync.Cond</code>进行等待。每个RPC都有自己的线程，不会影响其他RPC。</p>
</li>
<li><p>coordinator无法区分宕机、卡住以及运行非常缓慢的workers。最好是让coordinator等待一定的时间（在这里是10s），超时则判定为死亡（当然有可能没有），然后把这个任务分发给其他worker。</p>
</li>
<li><p>如果要完成Section3.6中的Backup任务，将测试代码完成：worker没有崩溃的时候不会去完成其他任务，备份任务仅在10s后才进行。</p>
</li>
<li><p>可以使用<code>mrapps/crash.go</code>作为plugin进行崩溃恢复。</p>
</li>
<li><p>MapReduce论文中提到，为了确保发生崩溃的时候没有人注意到这部分文件，可以采用临时文件以及完全写入后再进行重命名的方法。可以用<code>ioutil.TempFile</code>或者<code>os.CreateTemp</code>进行临时文件的创建，用<code>os.Rename</code>进行重命名</p>
</li>
<li><p><code>test-mr.sh</code>在子目录 <code>mr-tmp</code>中运行其所有进程，因此如果出现问题可以看那里。 可以临时修改<code>test-mr.sh</code> 以在测试失败后退出，这样脚本就不会继续测试（并覆盖输出文件）。</p>
</li>
<li><p><code>test-mr-many.sh</code>是连续运行很多次<code>test-mr.sh</code>，以便找到概率性的错误。不能并行多个<code>test-mr.sh</code>实例，因为coordinator用了同一个socker会导致冲突。</p>
</li>
<li><p>GO RPC仅发送以大写字母开头的结构体字段，子结构必须由大写的字段名称。</p>
</li>
<li><p>调用RPC的<code>call()</code>方法时，返回结构应当包含所有默认值。RPC 调用应该如下所示：在调用之前不设置任何回复字段。 如果您传递具有非默认字段的回复结构，RPC 系统可能会默默地返回不正确的值。</p>
  <figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">reply := SomeType{}</span><br><span class="line">call(..., &amp;reply)</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="Challenges"><a href="#Challenges" class="headerlink" title="Challenges"></a>Challenges</h3><ul>
<li>Implement your own MapReduce application (see examples in mrapps/*), e.g., Distributed Grep (Section 2.3 of the MapReduce paper).实现论文中 2.3 节的 MapReduce 应用。</li>
<li>Get your MapReduce coordinator and workers to run on separate machines, as they would in practice. You will need to set up your RPCs to communicate over TCP/IP instead of Unix sockets (see the commented out line in Coordinator.server()), and read/write files using a shared file system. For example, you can ssh into multiple <a href="http://kb.mit.edu/confluence/display/istcontrib/Getting+Started+with+Athena">Athena cluster</a> machines at MIT, which use <a href="http://kb.mit.edu/confluence/display/istcontrib/AFS+at+MIT+-+An+Introduction">AFS</a> to share files; or you could rent a couple AWS instances and use <a href="https://aws.amazon.com/s3/">S3</a> for storage.把 coordinator 和 workers 部署在不同的服务器上，改用 TCP/IP 取代 sockets 通信，并且使用 SFS 共享文件系统。</li>
</ul>
<h3 id="正式开始-Coding"><a href="#正式开始-Coding" class="headerlink" title="正式开始 Coding"></a>正式开始 Coding</h3><h4 id="worker-请求任务，coordinator-分配任务，worker-收到后打印"><a href="#worker-请求任务，coordinator-分配任务，worker-收到后打印" class="headerlink" title="worker 请求任务，coordinator 分配任务，worker 收到后打印"></a>worker 请求任务，coordinator 分配任务，worker 收到后打印</h4><blockquote>
<p>暂时只关注 coordinator 和 worker 的交互逻辑</p>
</blockquote>
<ul>
<li><p><code>wc.go</code> 的逻辑</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 输入是文件名和内容，输出是结构体切片存放kva</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(filename <span class="type">string</span>, contents <span class="type">string</span>)</span></span> []mr.KeyValue {</span><br><span class="line">    <span class="comment">// function to detect word separators.</span></span><br><span class="line">    <span class="comment">// 匿名函数，接收一个rune，返回一个bool，用于判断是否是字母，不是字母则是true</span></span><br><span class="line">    ff := <span class="function"><span class="keyword">func</span><span class="params">(r <span class="type">rune</span>)</span></span> <span class="type">bool</span> { <span class="keyword">return</span> !unicode.IsLetter(r) }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// split contents into an array of words.</span></span><br><span class="line">    <span class="comment">// 根据不是字母的点对contents进行拆分，也就是空格和其他，将得到单词的slice</span></span><br><span class="line">    words := strings.FieldsFunc(contents, ff)</span><br><span class="line"></span><br><span class="line">    kva := []mr.KeyValue{}</span><br><span class="line">    <span class="comment">// 遍历words切片，单词是key，value是"1"；重复的key在这时不会合并</span></span><br><span class="line">    <span class="keyword">for</span> _, w := <span class="keyword">range</span> words {</span><br><span class="line">        kv := mr.KeyValue{w, <span class="string">"1"</span>}</span><br><span class="line">        kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> kva</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reduce</span><span class="params">(key <span class="type">string</span>, values []<span class="type">string</span>)</span></span> <span class="type">string</span> {</span><br><span class="line">    <span class="comment">// return the number of occurrences of this word.</span></span><br><span class="line">    <span class="comment">// values切片的长度就是个数相加，实现了map中同key相加的效果</span></span><br><span class="line">    <span class="keyword">return</span> strconv.Itoa(<span class="built_in">len</span>(values))</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>mrsequential.go</code>的逻辑</p>
<ul>
<li>判定输入的参数<code>os.Args</code></li>
<li>用<code>loadPlugin(os.Args[1])</code>读取<code>mapf</code>和<code>reducef</code>两个以动态链接加载的函数（用1是因为0是文件路径 <strong>/home/boom/go/src/6.5840/src/main/__debug_bin710355273</strong> <code>wc.so pg-being_ernest.txt pg-dorian_gray.txt pg-frankenstein.txt pg-grimm.txt pg-huckleberry_finn.txt pg-metamorphosis.txt pg-sherlock_holmes.txt pg-tom_sawyer.txt</code>，1才是<code>wc.so</code>）<ul>
<li><code>p, err := plugin.Open(filename)</code>加载插件</li>
<li><code>xf, err := p.Lookup("Map")和p.Lookup("Reduce")</code>检索符号（这里的符号是函数）</li>
<li><code>f :=  xf.(func())</code>调用函数</li>
</ul>
</li>
<li><p>在worker中KeyValue的结构体，用这个结构体定义未初始化的切片<code>type ByKey []mr.KeyValue</code>用于<code>intermediate := []mr.KeyValue{}</code>的排序</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// struct is in 6.5840/mr</span></span><br><span class="line"><span class="keyword">type</span> KeyValue <span class="keyword">struct</span> {</span><br><span class="line">    Key   <span class="type">string</span></span><br><span class="line">    Value <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="keyword">type</span> ByKey []mr.KeyValue</span><br><span class="line"></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Len() <span class="type">int</span>           { <span class="keyword">return</span> <span class="built_in">len</span>(a) }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Swap(i, j <span class="type">int</span>)      { a[i], a[j] = a[j], a[i] }</span><br><span class="line"><span class="comment">// 实现了sort接口的三个方法以完成排序，按照键的字母顺序排序a-z</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> { <span class="keyword">return</span> a[i].Key &lt; a[j].Key }</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>读取后续各个参数，open、read、close各个file，依次把filename和content进行map，再存入切片</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> _, filename := <span class="keyword">range</span> os.Args[<span class="number">2</span>:] {</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    file, err := os.Open(filename)</span><br><span class="line">    content, err := ioutil.ReadAll(file) <span class="comment">// 在go1.16之后用io.ReadAll()</span></span><br><span class="line">    file.Close()</span><br><span class="line">    kva := mapf(filename, <span class="type">string</span>(content)) <span class="comment">// 调用mapf获取当前文档的所有分词kv的切片</span></span><br><span class="line">    intermediate = <span class="built_in">append</span>(intermediate, kva...) <span class="comment">// 追加到中间态的切片中暂存</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>排序切片，创建文件</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">sort.Sort(ByKey(intermediate))</span><br><span class="line"></span><br><span class="line">oname := <span class="string">"mr-out-0"</span></span><br><span class="line">ofile, _ := os.Create(oname)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>reduce，然后关闭文件</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) {</span><br><span class="line">        j := i + <span class="number">1</span></span><br><span class="line">        <span class="comment">// 找到所有相同key的下标范围[i,j)</span></span><br><span class="line">        <span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key {</span><br><span class="line">            j++</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 暂存这些同key的所有value</span></span><br><span class="line">        values := []<span class="type">string</span>{}</span><br><span class="line">        <span class="keyword">for</span> k := i; k &lt; j; k++ {</span><br><span class="line">            values = <span class="built_in">append</span>(values, intermediate[k].Value)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 进行reduce</span></span><br><span class="line">        output := reducef(intermediate[i].Key, values)</span><br><span class="line">        <span class="comment">// 写入上面创建的ofile文件，注意要按照这个格式</span></span><br><span class="line">        <span class="comment">// this is the correct format for each line of Reduce output.</span></span><br><span class="line">        fmt.Fprintf(ofile, <span class="string">"%v %v\n"</span>, intermediate[i].Key, output)</span><br><span class="line">        <span class="comment">// 更新i，找下一组key</span></span><br><span class="line">        i = j</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ofile.Close()</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h4><ul>
<li><p>单个终端启动<code>main/mrcoordinator.go</code></p>
<ul>
<li><code>m := mr.MakeCoordinator(os.Args[1:], 10)</code>带Args读入，这里的Args是所有的txt文档；和<code>nReduce=10</code>（对于<code>map</code>任务的数量，<strong>文件个数</strong>就是<code>map</code>个数，<strong>文件序号</strong>就是<code>map</code>序号）<ul>
<li>由<code>mr.MakeCoordinator（）</code>初始化<code>Coordinator</code></li>
<li><code>c.server()</code>启动一个线程监听来自<code>mr/worker.go</code>的RPC请求</li>
<li><code>go c.loopRemoveTimeoutTasks()</code>启动另一个线程循环移除过期的任务</li>
</ul>
</li>
<li>周期性调用<code>Done()</code>询问是否结束，如果返回<code>false</code>则在延迟1s后结束进程</li>
<li>把所有<code>files</code>放入<code>c.unIssueMapTasks</code>队列</li>
</ul>
</li>
<li><p>多个终端启动<code>main/mrworker.go</code></p>
<ul>
<li>加载一个启动参数<code>wc.so</code>动态插件，<code>mapf, reducef := loadPlugin(os.Args[1])</code></li>
<li><code>mr.Worker(mapf, reducef)</code></li>
<li><p><code>Worker</code>结构：两个函数，任务属性、是否全部结束、Id</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> AWorker <span class="keyword">struct</span> {</span><br><span class="line">    mapf    <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue</span><br><span class="line">    reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// false for map, true for reduce</span></span><br><span class="line">    mapOrReduce <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// false for not done, true for done and must exit</span></span><br><span class="line">    allDone <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    workerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>判定<code>allDone</code>，进行<code>worker.process()</code></p>
</li>
<li>判定<code>mapOrReduce</code>，选择<code>map</code>任务或者<code>reduce</code>任务<ul>
<li>如果是<code>map</code>任务<ul>
<li>请求任务<code>reply := worker.askMapTask()</code></li>
<li>处理<code>reply</code>，如果为<code>nil</code>表示<code>map</code>任务已经处理完成，切换到<code>reduce</code>任务<code>worker.mapOrReduce = true</code>；如果不为<code>nil</code>，若<code>reply.FileId==-1</code>说明任务分配完了但是还没处理完，没有<code>map</code>任务可以给当前<code>worker</code>处理，什么都不做，随机等待一小段时间后再返回，重新<code>process</code>请求，否则就正常处理<code>worker.executeMap(reply)</code></li>
</ul>
</li>
<li>如果是<code>reduce</code>任务<ul>
<li>请求任务<code>reply := worker.askReduceTask()</code></li>
<li>处理<code>reply</code>，如果为<code>nil</code>则表示全部结束， <code>worker.allDone = true</code>后返回，worker进程会退出；如果不为<code>nil</code>，若<code>reply.RIndex==-1</code>说明reduce任务已分配完但没处理完，否则就正常处理<code>worker.executeReduce(reply)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="任务的请求和处理机制"><a href="#任务的请求和处理机制" class="headerlink" title="任务的请求和处理机制"></a>任务的请求和处理机制</h4><ul>
<li><code>reply := worker.askMapTask()</code></li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> askMapTask() *MapTaskReply {</span><br><span class="line">    <span class="comment">// declare an argument structure and reply structure.</span></span><br><span class="line">    args := MapTaskArgs{WorkerId: worker.workerId}</span><br><span class="line">    reply := MapTaskReply{}</span><br><span class="line"></span><br><span class="line">    worker.logPrintf(<span class="string">"Asking map task...\n"</span>)</span><br><span class="line">    ok := call(<span class="string">"Coordinator.GiveMapTask"</span>, &amp;args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok {</span><br><span class="line">        worker.logPrintf(<span class="string">"askMapTask failed\n"</span>)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    worker.workerId = reply.WorkerId</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> reply.FileId == <span class="number">-1</span> {</span><br><span class="line">        <span class="keyword">if</span> reply.AllDone {</span><br><span class="line">            worker.logPrintf(<span class="string">"All map tasks are done\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            worker.logPrintf(<span class="string">"No map task available\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> &amp;reply</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Got map task %v on file %v\n"</span>, reply.FileId, reply.FileName)</span><br><span class="line">    <span class="keyword">return</span> &amp;reply</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li>请求主体的结构：<code>worker *AWorker</code></li>
<li><p>请求参数<code>args</code>结构：</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskArgs <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// give -1 if no task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>返回参数<code>reply</code>结构：</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskReply <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// worker pass the file name to the os to read</span></span><br><span class="line">    FileName <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// marks a unique file id for map task, give -1 if no more file</span></span><br><span class="line">    FileId <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for reduce task</span></span><br><span class="line">    NReduce <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign the worker id to the task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign where this kind of tasks are all done</span></span><br><span class="line">    <span class="comment">// if not or FileId is -1, the worker should wait</span></span><br><span class="line">    AllDone <span class="type">bool</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>任务分发：<code>func (c *Coordinator) GiveMapTask(args *MapTaskArgs, reply *MapTaskReply) error{}</code></p>
<ul>
<li>分发任务WorkerId为当前Coordinator的<code>c.curWorkerId</code>，此后<code>curWorkerId++</code>，如果WorkerId存在则不改变。</li>
<li>通过<code>c.issuedMapMutex.Lock()</code>获取Map任务的互斥锁<code>issuedMapMutex  sync.Mutex</code></li>
<li>判定<code>Coordinator</code>的<code>c.mapDone</code>字段，map任务结束则直接释放锁、<code>reply.FileId == -1</code>，<code>reply.AllDone</code>设为true，然后返回nil</li>
<li>判定没有分配的map任务队列和处理中的map任务队列是否都为空，为空则和上一条一样，附加设置<code>c.mapDone</code>为<code>true</code>，以及按照<code>c.nReduce</code>放入reduce的未分配队列</li>
<li>从未分配map任务队列中<code>PopBack()</code>拿到fileId（按照文件数量排列<code>0-len(files)-1</code>)，以此也可以拿到文件名并写入reply，并且给<code>MapTaskState</code>设置开始时间，为后续超时做准备。</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskState <span class="keyword">struct</span> {</span><br><span class="line">    beginSecond <span class="type">int64</span></span><br><span class="line">    workerId    <span class="type">int</span></span><br><span class="line">    fileId      <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>拿出的fileId放入已分配正在处理的map任务队列MapSet（实际上是使用map结构，并且统计了count）</li>
<li>处理相应的返回值</li>
</ul>
</li>
</ul>
</li>
<li><p><code>worker.executeMap(reply)</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> executeMap(reply *MapTaskReply) {</span><br><span class="line">    <span class="comment">// execute map task</span></span><br><span class="line">    intermediate := makeIntermediateFromFile(reply.FileName, worker.mapf)</span><br><span class="line">    <span class="comment">// write intermediate to files</span></span><br><span class="line">    worker.writeToFiles(reply.FileId, reply.NReduce, intermediate)</span><br><span class="line">    worker.joinMapTask(reply.FileId)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li><code>intermediate := makeIntermediateFromFile(reply.FileName, worker.mapf)</code>主要用<code>mapf</code>打开文件然后文档，生成键值对，返回一个中间态的<code>[]KeyValue</code>切片</li>
<li><code>worker.writeToFiles(reply.FileId, reply.NReduce, intermediate)</code>写入到中间文件，求hash后取<code>mod nReduce</code>得到分给哪一个reduce任务，因为reduce任务数量是知道的</li>
<li>用<code>encoding/json</code>包存储中间态文件，可以直接被reduce任务读取</li>
<li>请求<code>call("Coordinator.JoinMapTask", &amp;args, &amp;reply)</code><ul>
<li>拿到已分配map任务队列的锁</li>
<li>检查是否因为超时而导致当前FileId的任务已经从已分配map任务队列中移除<ul>
<li>已经被移除，解锁、打印信息</li>
<li>未被移除，移除、解锁，打印信息</li>
<li>未被移除且超时，放入未分配队列</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>reply := worker.askReduceTask()</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> askReduceTask() *ReduceTaskReply {</span><br><span class="line">    <span class="comment">// declare an argument structure and reply structure.</span></span><br><span class="line">    args := ReduceTaskArgs{WorkerId: worker.workerId}</span><br><span class="line">    reply := ReduceTaskReply{}</span><br><span class="line"></span><br><span class="line">    ok := call(<span class="string">"Coordinator.GiveReduceTask"</span>, &amp;args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok {</span><br><span class="line">        worker.logPrintf(<span class="string">"askReduceTask failed\n"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    worker.workerId = reply.WorkerId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> reply.RIndex == <span class="number">-1</span> {</span><br><span class="line">        <span class="keyword">if</span> reply.AllDone {</span><br><span class="line">            worker.logPrintf(<span class="string">"All reduce tasks are done, need to terminate this worker\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            worker.logPrintf(<span class="string">"No reduce task available\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> &amp;reply</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Got reduce task %v\n"</span>, reply.RIndex)</span><br><span class="line">    <span class="keyword">return</span> &amp;reply</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li>请求主体的结构：<code>worker *AWorker</code></li>
<li><p>请求参数<code>args</code>结构：</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> ReduceTaskArgs <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// give -1 if no task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>返回参数<code>reply</code>结构：</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> ReduceTaskReply <span class="keyword">struct</span> {</span><br><span class="line">    RIndex    <span class="type">int</span></span><br><span class="line">    NReduce   <span class="type">int</span></span><br><span class="line">    FileCount <span class="type">int</span></span><br><span class="line">    WorkerId  <span class="type">int</span></span><br><span class="line">    AllDone   <span class="type">bool</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>任务分发<code>func (c *Coordinator) GiveReduceTask(args *ReduceTaskArgs, reply *ReduceTaskReply) error {}</code></p>
<ul>
<li>分发任务WorkerId为当前Coordinator的<code>c.curWorkerId</code>，此后<code>curWorkerId++</code>，如果WorkerId存在则不改变，这里用的是Map任务的同一套编号，也就是说不会出现map和reduce的WorkerId相同。</li>
<li>通过<code>c.issuedReduceMutex.Lock()</code>获取Reduce任务的互斥锁<code>issuedReducepMutex  sync.Mutex</code></li>
<li>判定<code>Coordinator</code>的<code>c.allDone</code>字段，Reduce任务结束则直接释放锁、<code>reply.AllDone</code>设为true，<code>reply.RIndex</code>设为-1，然后返回nil</li>
<li>判定没有分配的Reduce任务队列和处理中的Reduce任务队列是否都为空，为空则和上一条一样，附加设置<code>c.AllDone</code>为<code>true</code>，先比较请求Map，这里多设置一个参数<code>c.AllDone</code></li>
<li>从未分配Redduce任务队列中<code>PopBack()</code>拿到rIndex（按照NReduce数量排列<code>0-NReduce-1</code>)并写入reply，并且给<code>ReduceTaskState</code>设置开始时间，为后续超时做准备。</li>
</ul>
</li>
<li><p><code>worker.executeReduce(reply)</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> executeReduce(reply *ReduceTaskReply) {</span><br><span class="line">    outName := fmt.Sprintf(<span class="string">"mr-out-%v"</span>, reply.RIndex)</span><br><span class="line">    intermediate := <span class="built_in">make</span>([]KeyValue, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reply.FileCount; i++ {</span><br><span class="line">        intermediate = <span class="built_in">append</span>(intermediate, readIntermediateFiles(i, reply.RIndex)...)</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Total intermediate size: %v\n"</span>, <span class="built_in">len</span>(intermediate))</span><br><span class="line">    tempfile, err := os.CreateTemp(<span class="string">"."</span>, <span class="string">"mrtemp"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        worker.logPrintf(<span class="string">"cannot create tempfile for %v\n"</span>, outName)</span><br><span class="line">    }</span><br><span class="line">    reduceKVSlice(intermediate, worker.reducef, tempfile)</span><br><span class="line">    tempfile.Close()</span><br><span class="line">    err = os.Rename(tempfile.Name(), outName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        worker.logPrintf(<span class="string">"cannot rename tempfile for %v\n"</span>, outName)</span><br><span class="line">    }</span><br><span class="line">    worker.joinReduceTask(reply.RIndex)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li><code>outName := fmt.Sprintf("mr-out-%v", reply.RIndex)</code>，当前<code>Reduce</code>任务的输出</li>
<li><p>从当前RIndex所属的各个中间态文件读取，汇合到intermediate</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">intermediate := <span class="built_in">make</span>([]KeyValue, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reply.FileCount; i++ {</span><br><span class="line">    worker.logPrintf(<span class="string">"Reading intermediate files on cluster %v\n"</span>, i)</span><br><span class="line">    intermediate = <span class="built_in">append</span>(intermediate, readIntermediateFiles(i, reply.RIndex)...)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><ul>
<li>通过<code>reduceKVSlice</code>排序以及合并，然后重命名、输出</li>
<li>请求<code>call("Coordinator.JoinMapTask", &amp;args, &amp;reply)</code><ul>
<li>拿到已分配map任务队列的锁</li>
<li>检查是否因为超时而导致当前FileId的任务已经从已分配map任务队列中移除<ul>
<li>已经被移除，解锁、打印信息</li>
<li>未被移除，移除、解锁，打印信息</li>
<li>未被移除且超时，放入未分配队列</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="任务分配机制"><a href="#任务分配机制" class="headerlink" title="任务分配机制"></a>任务分配机制</h4><blockquote>
<p>使用<strong>任务队列</strong>，<code>coordinator</code> 维护了两组两个任务队列，未分配、已分配（正在运行），当 <code>worker</code> 请求到达时，给 <code>worker</code> 分配一个未分配的任务，并把这个任务标记为已分配</p>
</blockquote>
<p>未分配任务使用有锁的双向队列，已分配任务使用无锁的 Map，操作时加锁，有待优化</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">bash test-mr.sh &gt; test-mr.out</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">*** Starting wc test.</span><br><span class="line">--- wc test: PASS</span><br><span class="line">*** Starting indexer test.</span><br><span class="line">--- indexer test: PASS</span><br><span class="line">*** Starting map parallelism test.</span><br><span class="line">--- map parallelism test: PASS</span><br><span class="line">*** Starting reduce parallelism test.</span><br><span class="line">--- reduce parallelism test: PASS</span><br><span class="line">*** Starting job count test.</span><br><span class="line">--- job count test: PASS</span><br><span class="line">*** Starting early exit test.</span><br><span class="line">--- early exit test: PASS</span><br><span class="line">*** Starting crash test.</span><br><span class="line">--- crash test: PASS</span><br><span class="line">*** PASSED ALL TESTS</span><br></pre></td></tr></tbody></table></figure>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Distributed Systems</tag>
        <tag>LinkedList</tag>
      </tags>
  </entry>
  <entry>
    <title>Keil调试代码优化问题</title>
    <url>/2020/12/08/Keil5%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<ul>
<li>在使用Keil进行调试的过程中，有的时候你可能会发现有几行代码怎么也得不到执行，下断点也会变成灰色感叹号。甚至有时候在做条件判断的时候，明明两个不相等的值却被判定为相等。</li>
<li>这是因为Keil对我们的代码进行了<strong>优化</strong>处理，将优化等级降低即可解决问题。<img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Keil/Keil_optimism.png" alt="请输入图片描述"></li>
</ul>
]]></content>
      <categories>
        <category>AT89S51</category>
      </categories>
      <tags>
        <tag>Debug</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu lose internet</title>
    <url>/2024/05/02/Lose%20Internet%20Ubuntu/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Ubuntu网络配置丢失</p>
<ul>
<li>起因是这样，突然有一天远程开发连不上了，于是乎先开始排查是不是校园网的部分端口被Ban了，因为最近的$Bing.com$就一直访问不上，但是改变网络接入后仍然没用。</li>
<li>想到会不会是因为之前系统没有正常关机导致一些VMware网络配置错误，排查和重置了桥接、Nat模式，发现都没有问题</li>
<li>开始检查Ubuntu的的网络配置，发现在<code>Settings-NetWork</code>中，只有一个$VPN$配置，没有其他的网络配置，按理说应该有<code>Wired</code>，这就很奇怪了，因为之前是有配置的，而且也没有删除过对应的配置文件。</li>
</ul>
<p><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>:clock16:<span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<span id="more"></span>
<hr>
<h2 id="找到问题"><a href="#找到问题" class="headerlink" title="找到问题"></a>找到问题</h2><p>在 Ubuntu 中，NetworkManager 是一个用于管理网络连接的系统守护进程。通过修改 NetworkManager.conf 文件，你可以对 NetworkManager 的行为进行一些配置。</p>
<p>一般来说，通过修改 NetworkManager.conf，你可以实现以下功能：</p>
<ol>
<li>修改 DNS 配置：<ul>
<li>你可以在 NetworkManager.conf 中指定 DNS 服务器的地址，这样 NetworkManager 在配置网络连接时将使用你指定的 DNS 服务器。</li>
</ul>
</li>
<li>配置网络管理：<ul>
<li>通过修改 NetworkManager.conf，你可以对 NetworkManager 的行为进行一些配置，比如配置连接优先级、禁用特定的网络功能等。</li>
</ul>
</li>
<li>修改插件行为：<ul>
<li>NetworkManager 通过插件来管理不同类型的网络连接，你可以通过修改 NetworkManager.conf 来配置这些插件的行为。</li>
</ul>
</li>
</ol>
<ul>
<li>问题就处在这个<code>NetworkManager</code>中，配置文件<code>/etc/NetworkManager/NetworkManager.conf</code>中的<code>ifupdown</code>插件没有启用，导致<code>/etc/network/interfaces</code>中的配置无法生效。</li>
</ul>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><ol>
<li><p>检查<code>/etc/network/interfaces</code>文件</p>
<ul>
<li><code>sudo vim /etc/network/interfaces</code></li>
<li><p>确认是否有配置文件，如果没有，可以参考如下配置：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>auto lo</code>：这个指令告诉系统在启动时自动激活本地回环接口。本地回环接口是一个特殊的网络接口，用于系统内部的网络通信，允许计算机与自身进行通信。通过设置 <code>auto lo</code>，系统在启动时会自动激活本地回环接口，确保系统内部的网络通信正常工作。</p>
</li>
<li><code>iface lo inet loopback</code>：这行指令定义了本地回环接口的配置。<code>iface</code> 表示接口，<code>lo</code> 是本地回环接口的名称，<code>inet</code> 表示使用 IPv4 协议，<code>loopback</code> 表示这是一个本地回环接口。在这行指令中，<code>loopback</code> 参数表明这个接口是一个本地回环接口，它用于系统内部的循环通信，而不会连接到外部网络。</li>
<li>这两行指令的作用是确保系统在启动时激活本地回环接口，并为本地回环接口配置了正确的参数，以确保系统内部的网络通信正常工作。</li>
</ul>
</li>
<li><p>打开配置文件<code>/etc/NetworkManager/NetworkManager.conf</code>，修改<code>managed=True</code></p>
<ul>
<li><code>sudo vim /etc/NetworkManager/NetworkManager.conf</code></li>
<li><p>修改如下内容：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">[main]</span><br><span class="line">plugins=ifupdown,keyfile</span><br><span class="line"></span><br><span class="line">[ifupdown]</span><br><span class="line">managed=True</span><br><span class="line"></span><br><span class="line">[device]</span><br><span class="line">wifi.scan-rand-mac-address=no</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p><code>reboot</code> or <code>sudo service network-manager restart</code></p>
</li>
<li><p>有可能还是不行</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo service network-manager stop</span><br><span class="line">sudo <span class="built_in">rm</span> /var/lib/NetworkManager/NetworkManager.state </span><br><span class="line">sudo service network-manager start</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>原因</p>
<ul>
<li>宿主机网络设置变化：如果宿主机的网络适配器配置发生了变化，可能会影响到虚拟机的网络连接，导致 NetworkManager 在虚拟机中将 managed 设置为 false。</li>
<li>VMware 网络设置变化：VMware 的网络设置可能会影响到虚拟机的网络配置。例如，当虚拟机所连接的网络适配器发生变化时，可能会导致 NetworkManager.conf 中 managed 的状态发生变化。</li>
<li>更新或重装 VMware Tools：在虚拟机中更新或重装 VMware Tools 时，可能会重新配置网络适配器，这也可能导致 NetworkManager.conf 中 managed 的状态发生变化。（很有可能是这个原因，之前更新了VM tools）</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Debug</tag>
        <tag>Ubuntu</tag>
        <tag>VMware</tag>
      </tags>
  </entry>
  <entry>
    <title>PKIX path building failed</title>
    <url>/2024/07/11/PKIX%20path%20building%20failed/</url>
    <content><![CDATA[<blockquote>
<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>开发中遇到 <code>javax.net.ssl.SSLHandshakeException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</code>，猜测应该是SSL证书的问题，找了一些解决方式，在这里做总结。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-前言"><a href="#books-1-前言" class="headerlink" title=":books: 1. 前言"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1. 前言</h2><p>调用HTTPS接口时遇到的SSL证书相关问题，这里是<code>PKIX path building failed</code>。</p>
<h2 id="satellite-2-出现的背景"><a href="#satellite-2-出现的背景" class="headerlink" title=":satellite: 2. 出现的背景"></a><span class="github-emoji"><span>📡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 2. 出现的背景</h2><blockquote>
<p>捕获抛出的<code>IOException</code>，检查发现是<code>HttpURLConnection.getResponseCode();</code>出现了问题，当然在其他连接处也可能产生，具体表现为<code>sun.security.validator.ValidatorException: PKIX path building failed</code>，也就是说无法找到请求目标的有效认证路径导致的。</p>
</blockquote>
<ul>
<li>JDK缺少某个目标Server的安全证书</li>
</ul>
<h2 id="mag-right-3-解决方案"><a href="#mag-right-3-解决方案" class="headerlink" title=":mag_right: 3. 解决方案"></a><span class="github-emoji"><span>🔎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 3. 解决方案</h2><blockquote>
<p>JDK在<code>lib/security/</code>目录下存放着<code>cacerts</code>文件，这个文件是JDK的证书库，产生上述错误的原因就是未能找到目标服务器的SSL证书，需要做的就是找到证书或者禁用证书验证，下面提供几种解决方案。</p>
</blockquote>
<h3 id="3-1-将目标服务器的证书导入到Java的信任库"><a href="#3-1-将目标服务器的证书导入到Java的信任库" class="headerlink" title="3.1 将目标服务器的证书导入到Java的信任库"></a>3.1 将目标服务器的证书导入到Java的信任库</h3><ul>
<li><p>获取目标服务器的SSL证书，可以通过浏览器地址栏左侧的图标进行下载（crt或者pem文件）（<em>不会的话可以自行Google</em>），也可以通过命令行导出。</p>
<p>  <code>openssl s_client -connect &lt;your-server&gt;:443 -showcerts</code></p>
</li>
<li><p>导入证书到Java的信任库(记得先备份原始的信任库<code>cacerts</code>)</p>
<p>  <code>keytool -import -alias test_https_certificate -file D:\***.crt -keystore D:\java**\lib\security\cacerts</code></p>
<ul>
<li>密钥库口令默认为<code>changeit</code></li>
</ul>
</li>
<li><p>也可以把<code>-keystore</code>后的路径改为自己新建的信任库路径，然后在SpringBoot的启动类中修改<code>javax.net.ssl.trustStore</code>和<code>javax.net.ssl.trustStorePassword</code>的值。</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">System.setProperty(<span class="string">"javax.net.ssl.trustStore"</span>, <span class="string">"D:\\yourCacerts"</span>);</span><br><span class="line">System.setProperty(<span class="string">"javax.net.ssl.trustStorePassword"</span>, <span class="string">"changeit"</span>);</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="3-2-使用自定义的信任管理器"><a href="#3-2-使用自定义的信任管理器" class="headerlink" title="3.2 使用自定义的信任管理器"></a>3.2 使用自定义的信任管理器</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.net.ssl.*;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTrustManager</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        TrustManager[] trustAllCerts = <span class="keyword">new</span> <span class="title class_">TrustManager</span>[]{</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">X509TrustManager</span>() {</span><br><span class="line">                <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() { <span class="keyword">return</span> <span class="literal">null</span>; }</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] certs, String authType)</span> { }</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] certs, String authType)</span> { }</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sc</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">        sc.init(<span class="literal">null</span>, trustAllCerts, <span class="keyword">new</span> <span class="title class_">java</span>.security.SecureRandom());</span><br><span class="line">        HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Your code to open connection and interact with the server</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-3-禁用证书验证"><a href="#3-3-禁用证书验证" class="headerlink" title="3.3 禁用证书验证"></a>3.3 禁用证书验证</h3><ul>
<li><p>建议仅在测试环境下使用</p>
<p>  <code>HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -&gt; true);</code></p>
</li>
</ul>
<h2 id="4-常见问题"><a href="#4-常见问题" class="headerlink" title="4. 常见问题"></a>4. 常见问题</h2><ul>
<li>可以使用 <code>keytool -list -keystore D:\java**\lib\security\cacerts</code> 命令来查看已导入的证书</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>SSL</tag>
        <tag>HTTPS</tag>
      </tags>
  </entry>
  <entry>
    <title>Process or Thread</title>
    <url>/2021/01/20/Process%20or%20Thread/</url>
    <content><![CDATA[<h3 id="进程是资源分配的最小单位-线程是CPU调度的最小单位"><a href="#进程是资源分配的最小单位-线程是CPU调度的最小单位" class="headerlink" title="进程是资源分配的最小单位|线程是CPU调度的最小单位"></a>进程是资源分配的最小单位|线程是CPU调度的最小单位</h3><hr>
<blockquote>
<p>看了很多资料，解释都比较抽象<br>用一个简答的比喻在形容：进程=高铁，线程=车厢</p>
</blockquote>
<ul>
<li>线程在进程下行进（单纯的车厢无法行动）</li>
<li>一个进程可以包含多个线程（一辆高铁可以有多个车厢）</li>
<li>同意进程下不同线程间数据容易共享</li>
<li>不同进程间数据难以共享</li>
<li>进程间不会互相影响，一个线程挂掉将导致整个进程挂掉</li>
<li>进程占用更多资源</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
  </entry>
  <entry>
    <title>Modulate and demodulate</title>
    <url>/2021/04/21/Modulate%20and%20demodulate/</url>
    <content><![CDATA[<h1 id="pushpin-Modulation-and-demodulation-of-signal-based-on-matlab"><a href="#pushpin-Modulation-and-demodulation-of-signal-based-on-matlab" class="headerlink" title=":pushpin: Modulation and demodulation of signal based on matlab"></a><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Modulation and demodulation of signal based on matlab</h1><p><span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f560.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><br><span id="more"></span></p>
<hr>
<h2 id="Eg1"><a href="#Eg1" class="headerlink" title="Eg1"></a>Eg1</h2><p><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Code</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Generate random process.</span></span><br><span class="line"></span><br><span class="line">clear;</span><br><span class="line">clc;</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% ①Generate a random process y[n]=x1[n]+sin(x2[n]).</span></span><br><span class="line">N = <span class="number">1000</span>;                   <span class="comment">% The maximum value of n,sequence length</span></span><br><span class="line">M = <span class="number">50</span>;                     <span class="comment">% Select a sequence of length 101 = M*2+1 </span></span><br><span class="line">Y = <span class="built_in">zeros</span>(<span class="number">1</span>,N); </span><br><span class="line">Ryav = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="number">2</span>*M+<span class="number">1</span>);      <span class="comment">% 950:1050</span></span><br><span class="line">Syav = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="number">2</span>*M+<span class="number">1</span>);      <span class="comment">% 950:1050</span></span><br><span class="line">Myav = <span class="number">0</span>;</span><br><span class="line">Vyav = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Take the ensemble average over one hundred realizations.</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="number">2</span>*M</span><br><span class="line">    X1 = <span class="built_in">randn</span>(<span class="number">1</span>,N);     <span class="comment">% Use 'randn(x,y)' to generate x*y matrix </span></span><br><span class="line">    X2 = <span class="built_in">randn</span>(<span class="number">1</span>,N);</span><br><span class="line">    <span class="keyword">for</span> n = <span class="number">1</span>:N</span><br><span class="line">        Y(n) = X1(n)+<span class="built_in">sin</span>(X2(n));</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    Ry = xcorr(Y,<span class="string">'unbiased'</span>);       <span class="comment">% Autocorrelation of {Yn}</span></span><br><span class="line">    Ry = Ry(N-M:N+M);               <span class="comment">% Original Ry, m is -999 to 999(2*N-1)</span></span><br><span class="line">    Sy = fftshift(<span class="built_in">abs</span>(fft(Ry)));    <span class="comment">% Power spectrum of {Yn}</span></span><br><span class="line">    Ryav=Ryav+Ry;                   <span class="comment">% 100 times</span></span><br><span class="line">    Syav=Syav+Sy;</span><br><span class="line">    Myav_time=Myav+<span class="built_in">mean</span>(Y(<span class="number">1</span>));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Ryav=Ryav/<span class="number">100</span>;                      <span class="comment">% Time-average</span></span><br><span class="line">Syav=Syav/<span class="number">100</span>;</span><br><span class="line">Myav_time=Myav_time/(<span class="number">2</span>*M)</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Task(2)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% ① the mean and variance of y[n].</span></span><br><span class="line"><span class="comment">% Use 'mean(Y)' and 'var(Y)' to calculate the mean and variance of y[n].</span></span><br><span class="line">Myav = <span class="built_in">mean</span>(Y)</span><br><span class="line">Vyav = var(Y)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(3)</span></span><br><span class="line"><span class="comment">% ① the spectrum and auto-correlation of y[n].</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line">subplot(<span class="number">121</span>)</span><br><span class="line"><span class="built_in">plot</span>(-M:M,Ryav);</span><br><span class="line">title(<span class="string">'Auto-correction of y[n]'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">122</span>)</span><br><span class="line"><span class="built_in">plot</span>(<span class="number">-0.5</span>:<span class="number">0.01</span>:<span class="number">0.5</span>,Syav);</span><br><span class="line">title(<span class="string">'Spectrum of y[n]'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Fig</p>
<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/mean_and_var.png"></div>
<center><font size="2">Fig.1 Myav and Vyav of y[n].</font></center>

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_spectrum_and_auto-correlation_of_y[n].png"></div>
<center><font size="2">Fig.2 The spectrum and auto-correlation of y[n].</font></center>

<span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Discussion

&gt; - In this task, I use ‘randn(x,y)’ to generate ‘x*y’ matrix. In order to calculate the autocorrelation and power spectrum of y[n] in the time-average, I take the ensemble average over one hundred realizations, and then take their average. The length of x1[n],x2[n] and y[n] are all N in length.
&gt; - As we all know, the length of ‘xcorr(y)’ is ‘2*N-1’. For original Ry , m is -999 to 999, so I selected (950:1050) of the intervals. After a hundred stacking, use ‘Ryav=Ryav/100’ and ‘Syav=Syav/100’ to calculate the time-average. I  also use 'mean(Y)' and 'var(Y)' to calculate the mean and variance of y[n].
&gt; - To judge rodman progress is ergodic or stationary, I compare the time average and statistical average and find that the expectation of y[n] is a constant while its autocorrelation only depends on the time difference. Also, the expectation equals the time-average. So, we can say the random process will go through all the possible states. The conclusion is that the rodman progress y[n] is ergodic and stationary.

## Eg2 ##

<span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Code

<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% Amplitude modulation. Sampling rate Fs=1500Hz.</span></span><br><span class="line"> </span><br><span class="line">clear;</span><br><span class="line">clc;</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(1)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Initialization.</span></span><br><span class="line">t0 = <span class="number">1</span>;                 <span class="comment">% Signal duration</span></span><br><span class="line">Fs = <span class="number">1500</span>;              <span class="comment">% Sampling rate</span></span><br><span class="line">Ts = <span class="number">1</span>/Fs;              <span class="comment">% Sampling interval</span></span><br><span class="line">Fc = <span class="number">20</span>;                <span class="comment">% Carrier rate</span></span><br><span class="line">t = <span class="number">0</span>:Ts:t0;            <span class="comment">% Time vector</span></span><br><span class="line">N = <span class="built_in">length</span>(t);          <span class="comment">% Length of t</span></span><br><span class="line">N0 = <span class="number">0.0005</span>;            <span class="comment">% Power spectral density of noise</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Message signal and modulated signal(DSB_AM and USSB_AM).</span></span><br><span class="line">m = <span class="built_in">sin</span>(<span class="number">2</span>*<span class="built_in">pi</span>*t);        <span class="comment">% Message signal</span></span><br><span class="line">c = <span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*Fc*t);     <span class="comment">% Carrier signal</span></span><br><span class="line">Ac_DSB_AM = <span class="number">1</span>;</span><br><span class="line">Ac_USSB_AM = <span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% DBS_AM modulated signal.</span></span><br><span class="line">u_dsb = Ac_DSB_AM*m.*c;</span><br><span class="line"><span class="comment">% SSB_AM modulated signal.</span></span><br><span class="line">u_ussb = <span class="number">1</span>/<span class="number">2</span>*Ac_USSB_AM*<span class="built_in">real</span>(hilbert(m).*<span class="built_in">exp</span>(<span class="number">1</span><span class="built_in">i</span>*<span class="number">2</span>*<span class="built_in">pi</span>*Fc*t));</span><br><span class="line"><span class="comment">% "equal to " u_ussb = 1/2*Ac_USSB_AM*cos(2*pi*(Fc+1)*t).</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Time domain to frequency domain).</span></span><br><span class="line">[~,M] = T2F(t,m); </span><br><span class="line">[~,U_DSB] = T2F(t,u_dsb);</span><br><span class="line">[df1,U_USSB] = T2F(t,u_ussb);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% ① Calculate the power of the modulated signal and message signal.</span></span><br><span class="line">m_power = sum(<span class="built_in">abs</span>(m).^<span class="number">2</span>)/N</span><br><span class="line">dsb_power = sum(<span class="built_in">abs</span>(u_dsb).^<span class="number">2</span>)/N</span><br><span class="line">ussb_power = sum(<span class="built_in">abs</span>(u_ussb).^<span class="number">2</span>)/N</span><br><span class="line"> </span><br><span class="line"><span class="comment">% ② Plot the modulated signal and the spectrum.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_dsb)</span><br><span class="line">title(<span class="string">'DSB Signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_ussb)</span><br><span class="line">title(<span class="string">'USSB Signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,<span class="built_in">abs</span>(U_DSB))</span><br><span class="line">title(<span class="string">'Spectrum of the Modulated DSB Signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,<span class="built_in">abs</span>(U_USSB))</span><br><span class="line">title(<span class="string">'Spectrum of the Modulated USSB Signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(2)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Demodulate the above signals.</span></span><br><span class="line"><span class="comment">% Coherent carrier mixing.</span></span><br><span class="line">y_dsb = u_dsb.*c;</span><br><span class="line">y_ussb = u_ussb.*c;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Time domain to frequency domain).</span></span><br><span class="line">[~,Y_DSB]=T2F(t,y_dsb);</span><br><span class="line">[df1,Y_USSB]=T2F(t,y_ussb);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Initialization of lowpass filter.</span></span><br><span class="line">H_DSB = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="built_in">length</span>(df1));</span><br><span class="line">H_USSB = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="built_in">length</span>(df1));</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="built_in">length</span>(df1)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(df1(<span class="built_in">i</span>))&lt;<span class="number">2</span></span><br><span class="line">        H_DSB(<span class="built_in">i</span>)=<span class="number">2</span>*Ac_DSB_AM;</span><br><span class="line">        H_USSB(<span class="built_in">i</span>)=<span class="number">2</span>*Ac_USSB_AM;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Lowpass filter filtering(Spectrum of the filter output).</span></span><br><span class="line">DEM_DSB=H_DSB.*Y_DSB;</span><br><span class="line">DEM_USSB=H_USSB.*Y_USSB;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Frequency domain to time domain).</span></span><br><span class="line">[~,dem_w_dsb]=F2T(df1,DEM_DSB);</span><br><span class="line">[dt1,dem_w_ussb]=F2T(df1,DEM_USSB);</span><br><span class="line">dem_w_dsb=dem_w_dsb(<span class="number">1</span>:<span class="built_in">length</span>(t));</span><br><span class="line">dem_w_ussb=dem_w_ussb(<span class="number">1</span>:<span class="built_in">length</span>(t));</span><br><span class="line"> </span><br><span class="line"><span class="comment">% ① The pass band of the low-pass filter for DSB_AM and USSB_AM.</span></span><br><span class="line">passband_dsb = <span class="number">2</span>*<span class="number">1</span></span><br><span class="line">passband_ussb = <span class="number">2</span>*<span class="number">1</span></span><br><span class="line"><span class="comment">% ② Plot the demodulated signal and the spectrum.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">2</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_w_dsb))</span><br><span class="line">title(<span class="string">'Demodulated DSB signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_w_ussb))</span><br><span class="line">title(<span class="string">'Demodulated USSB signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,(<span class="built_in">abs</span>(DEM_DSB)))</span><br><span class="line">title(<span class="string">'Spectrum of the Demodulated DSB signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,(<span class="built_in">abs</span>(DEM_USSB)))</span><br><span class="line">title(<span class="string">'Spectrum of the Demodulated USSB signal'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(3)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Add the thermal noise.</span></span><br><span class="line">noise = <span class="built_in">randn</span>(<span class="number">1</span>,<span class="built_in">length</span>(t))*<span class="built_in">sqrt</span>(N0/<span class="number">2</span>*Fs);</span><br><span class="line">u_n_dsb = u_dsb + noise;</span><br><span class="line">u_n_ussb = u_ussb + noise;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Coherent carrier mixing.</span></span><br><span class="line">y_n_dsb = u_n_dsb.*c;</span><br><span class="line">y_n_ussb = u_n_ussb.*c;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Time domain to frequency domain).</span></span><br><span class="line">[~,Y_N_DSB]=T2F(t,y_n_dsb);</span><br><span class="line">[df1,Y_N_USSB]=T2F(t,y_n_ussb);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Lowpass filter filtering(Spectrum of the filter output).</span></span><br><span class="line"><span class="comment">% Filters have been initialized already.</span></span><br><span class="line">DEM_N_DSB=H_DSB.*Y_N_DSB;</span><br><span class="line">DEM_N_USSB=H_USSB.*Y_N_USSB;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Frequency domain to time domain).</span></span><br><span class="line">[~,dem_n_dsb]=F2T(df1,DEM_N_DSB);</span><br><span class="line">[dt1,dem_n_ussb]=F2T(df1,DEM_N_USSB);</span><br><span class="line"> </span><br><span class="line"><span class="comment">% ①Plot the modulated signal and demodulated signal(time domain).</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">3</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_n_dsb)</span><br><span class="line">title(<span class="string">'Modulated DSB signal with noise'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">plot</span>(t,u_n_ussb)</span><br><span class="line">title(<span class="string">'Modulated USSB signal with noise'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_n_dsb))</span><br><span class="line">title(<span class="string">'Demodulated DSB signal with noise'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_n_ussb))</span><br><span class="line">title(<span class="string">'Demodulated USSB signal with noise'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">%% Task(4)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% What is the disadvantage</span></span><br><span class="line"><span class="comment">% if we apply a low-pass filter with a band much wider than necessary?</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Initialization of lowpass filter much wider than necessary.</span></span><br><span class="line">H_W_DSB = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="built_in">length</span>(df1));</span><br><span class="line">H_W_USSB = <span class="built_in">zeros</span>(<span class="number">1</span>,<span class="built_in">length</span>(df1));</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:<span class="built_in">length</span>(df1)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(df1(<span class="built_in">i</span>))&lt;<span class="number">200</span>      <span class="comment">% 200 &gt;&gt; 2</span></span><br><span class="line">        H_W_DSB(<span class="built_in">i</span>)=<span class="number">2</span>*Ac_DSB_AM;</span><br><span class="line">        H_W_USSB(<span class="built_in">i</span>)=<span class="number">2</span>*Ac_USSB_AM;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">% Lowpass filter filtering(Spectrum of the filter output).</span></span><br><span class="line">DEM_W_DSB=H_W_DSB.*Y_DSB;</span><br><span class="line">DEM_W_USSB=H_W_USSB.*Y_USSB;</span><br><span class="line"> </span><br><span class="line"><span class="comment">% Fourier transform(Frequency domain to time domain).</span></span><br><span class="line">[~,dem_w_dsb]=F2T(df1,DEM_W_DSB);</span><br><span class="line">[dt1,dem_w_ussb]=F2T(df1,DEM_W_USSB);</span><br><span class="line">dem_w_dsb=dem_w_dsb(<span class="number">1</span>:<span class="built_in">length</span>(t));</span><br><span class="line">dem_w_ussb=dem_w_ussb(<span class="number">1</span>:<span class="built_in">length</span>(t));</span><br><span class="line"> </span><br><span class="line"><span class="comment">% The demodulated signal and the spectrum.</span></span><br><span class="line"><span class="built_in">figure</span>(<span class="number">4</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>) </span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_w_dsb))</span><br><span class="line">title(<span class="string">'Demodulated DSB signal with a much wider band'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">plot</span>(dt1,<span class="built_in">real</span>(dem_w_ussb))</span><br><span class="line">title(<span class="string">'Demodulated USSB signal with a much wider band'</span>)</span><br><span class="line">xlabel(<span class="string">'Time'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,(<span class="built_in">abs</span>(DEM_DSB)))</span><br><span class="line">title(<span class="string">'Spectrum of the Demodulated DSB signal with a much wider band'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br><span class="line">subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">plot</span>(df1,(<span class="built_in">abs</span>(DEM_USSB)))</span><br><span class="line">title(<span class="string">'Spectrum of the Demodulated USSB signal with a much wider band'</span>)</span><br><span class="line">xlabel(<span class="string">'Frequency'</span>)</span><br></pre></td></tr></tbody></table></figure>

<span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Fig

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_power_of_the_modulated_signal_and_message_signal.png"></div>
<center><font size="2">Fig.3 The power of the modulated signal and message signal.</font></center>

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_modulated_signal_and_the_spectrum.png"></div>
<center><font size="2">Fig.4 The modulated signal and the spectrum.</font></center>

<div align="center"><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_pass_band_of_the_low-pass_filter_for_DSB_AM_and_USSB_AM.png"></div>

<center><font size="2">Fig.5 The pass band of the low-pass filter for DSB_AM and USSB_AM.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_demodulated_signal_and_the_spectrum.png" alt="The demodulated signal and the spectrum."></p>
<center><font size="2">Fig.6 The demodulated signal and the spectrum.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/the_modulated_signal_and_demodulated_signal_with_noise.png" alt="The modulated signal and demodulated signal with noise."></p>
<center><font size="2">Fig.7 The modulated signal and demodulated signal with noise.</font></center>

<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/modulate/much_wider_band_the_demodulated_signal_and_the_spectrum.png" alt="The demodulated signal and the spectrum(much wider band)."></p>
<center><font size="2">Fig.8 The demodulated signal and the spectrum(much wider band).</font></center>

<p><span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Discussion</p>
<blockquote>
<p>In this task, signal duration is t0=1 , message signal m=sin(2<em>pi</em>t), carrier signal c=cos(2<em>pi</em>Fc*t), there are two modulation methods DBS_AM and SSB_AM. In the SSB_AM, we use the upper sideband modulation, USSB_AM.<br>The modulated signals:</p>
</blockquote>
<ul>
<li><p>DSB-AM signal :</p>
<p>  $s(t) = A<em>{c}m(t)cos(2\pi f</em>{c}t)$</p>
</li>
<li><p>USSB-AM signal:</p>
<p>  $u(t) = {A<em>{c}\over2}m(t)cos(2\pi f</em>{c}t)-{A<em>{c}\over2}{\hat{m}}(t)sin(2\pi f</em>{c}t)$</p>
</li>
</ul>
<blockquote>
<p>One thing to note is that the   of DSB-AM and USSB-AM are different. The former is 1 and the latter is $\sqrt{2}$. Use ‘sum(abs(m).^2)/N’ to calculate their power (see fig.3). The modulated signal and the spectrum (see fig.4)<br>Then demodulating the above signals, I use coherent carrier to demodulate them and then pass them through a low-pass filter with different gains.<br>The demodulated signals:</p>
</blockquote>
<ul>
<li><p>DSB-AM signal:</p>
<p>  $y(t) = A<em>{C}cos(2\pi f</em>{c}t)cos(2\pi f<em>{c}t) = {A</em>{c}\over2}m(t)+{A<em>{c}\over2}m(t)cos(4\pi f</em>{c}t)$</p>
</li>
<li><p>USSB-AM signal:</p>
<p>  $y(t) = {A<em>{c}\over2}m(t)cos^2(2\pi f</em>{c}t)-{A<em>{c}\over2}{\hat{m}}(t)sin(2\pi f</em>{c}t)cos(2\pi f<em>{c}t) = {A</em>{c}\over4}m(t)+{A<em>{c}\over4}cos(4\pi f</em>{c}t)-{A<em>{c}\over4}{\hat{m}}(t)sin(4\pi f</em>{c}t)$</p>
</li>
</ul>
<blockquote>
<ul>
<li>In order to recover the original signal m(t), one thing is to use a low-pass filter to filter out unwanted components, and the other thing is to choose right gain. To divide the Ac, for the DSB-AM, what needs to be kept is  , and then the gain is obviously  ; For the USSB-AM, what needs to be kept is  , and then the gain is obviously   . As the band of original signal m(t) is f=1, so I set the passband of the low-pass filter to 2Hz (see fig.5) . The cut-off frequency is 2HZ, which is twice the maximum frequency of the original signal, then the original signal is recovered well in both modulation methods (see fig.6).</li>
<li>In fact, for the noise, all of the frequency in array of ($f<em>{m}$,$f</em>{c}$) are ok, although the amplitude of the demodulated signal will change due to the constant gain after mixing noise, the original signal is restored almost without distortion (see fit.7).</li>
<li>If we apply a low-pass filter with a band much wider than necessary, when filtering, it will mix in the high frequency components with the frequency spectrum nearby. The high frequency component is just the continuation of the baseband component at high frequency, if it is not too wide, may we can barely recover the original signal. If the cut-off frequency is set too wide, it may cause signal aliasing and amplitude changes.</li>
</ul>
</blockquote>
<!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>Matlab</tag>
      </tags>
  </entry>
  <entry>
    <title>Lucene search engine</title>
    <url>/2024/08/10/Lucene%20search%20engine/</url>
    <content><![CDATA[<blockquote>
<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><strong>Elasticsearch</strong>是一个基于<strong>Lucene</strong>的搜索引擎，提供了一个分布式多用户能力的全文搜索引擎，基于<code>RESTful API</code>接口，解决了原生<code>Lucene</code>使用上的缺陷。为了更好的理解<code>Elasticsearch</code>，先对<code>Lucene</code>进行了解。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-全文检索"><a href="#books-全文检索" class="headerlink" title=":books: 全文检索"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 全文检索</h2><ul>
<li><p>结构化数据，具有固定格式或有限长度的数据，如数据库表中的字段和元数据。</p>
<ul>
<li>数据库用<code>SQL</code>语句搜索；元数据用类型、属性、标签等搜索。</li>
</ul>
</li>
<li><p>非结构化数据，不定长或无固定格式的数据，如邮件、Word 文档、PDF 文档等，又称<strong>全文数据</strong>。</p>
<ul>
<li><strong>顺序扫描法(Serial Scanning)</strong>，对每个文档从头到尾扫描，非结构化数据在数据量大时效率低下，不适合全文检索。</li>
<li><strong>全文检索(Full-text Search)</strong>，把非结构化数据转换为结构化数据，再用结构化数据的检索方法。首先将要查询的目标数据中的词提取出来，组成索引，通过查询索引达到搜索目标数据的目的。</li>
</ul>
</li>
</ul>
<p>StringField 和 TextField 是 Apache Lucene 中用于存储和索引文档字段的两种不同类型。  </p>
<ul>
<li>StringField：用于存储不需要进行全文搜索的字段。它不会被分词器处理，适用于精确匹配查询。例如，ID、日期、分类等字段。</li>
<li>TextField：用于存储需要进行全文搜索的字段。它会被分词器处理，适用于需要进行全文搜索的文本内容。例如，文章内容、描述等字段。<br>示例代码：</li>
</ul>
<h2 id="mag-right-Lucene基本原理"><a href="#mag-right-Lucene基本原理" class="headerlink" title=":mag_right:Lucene基本原理"></a><span class="github-emoji"><span>🔎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><code>Lucene</code>基本原理</h2><h3 id="倒排索引-Inverted-index"><a href="#倒排索引-Inverted-index" class="headerlink" title="倒排索引(Inverted index)"></a>倒排索引(Inverted index)</h3><blockquote>
<p>快速查询某个词在文档中的位置，将文档集合中的每个词都映射到出现在该次的文档列表，而不是将文档映射到词的列表</p>
</blockquote>
<ol>
<li>文档分词：将文档进行分词，得到词项列表，这里可以还有大小写转化、去停用词等操作。</li>
<li>构建索引表：将词项列表构建倒排索引表，记录每个词项出现在哪些文档中。遍历所有文档，对每个词将其映射到文档列表，可以用哈希表、树等数据结构。</li>
<li>优化索引：对索引表进行优化，如压缩、排序、合并等操作。</li>
<li>查询处理：用户输入一个检索词时，对查询进行分词，得到查询词项列表，然后在索引表中查找每个词项对应的文档列表，最后对文档列表进行筛选、排序、交集、并集等操作，得到最终的查询结果。</li>
</ol>
<h3 id="段落索引-Segment-index"><a href="#段落索引-Segment-index" class="headerlink" title="段落索引(Segment index)"></a>段落索引(Segment index)</h3><blockquote>
<p>为了提高搜索效率，将索引分为多个段落，每个段落都是一个独立的索引单元，每个段落都有自己的倒排索引表。</p>
</blockquote>
<ol>
<li>分割文本：分词器的组件将文本分割成若干个段落，可以按照具体的需求来定义分割规则，例如空格、标点符号等。</li>
<li>建立词汇表：Lucene对词汇表进行排序等以提高搜索效率。</li>
<li>构建倒排索引：对每个段落构建倒排索引表，记录每个词项出现在哪些文档中。倒排索引的数据结构包括索引词项(Term)、文档编号(Document ID)、位置(Position)等。</li>
<li>搜索：用户输入一个检索词时，Lucene在词汇表中查找，并获取到包含该单词的段落列表，然后根据这些段落列表计算相关度得分，并按照相关度排序返回搜索结果。</li>
</ol>
<h3 id="文本预处理"><a href="#文本预处理" class="headerlink" title="文本预处理"></a>文本预处理</h3><blockquote>
<p>在构建索引之前，需要对文本进行预处理，包括分词、大小写转化、去停用词等操作。</p>
</blockquote>
<ol>
<li>小写转换(Lowercasing)：将文本转换为小写，避免大小写不一致导致的搜索问题。</li>
<li>去除停用词(Stopwords)：去除常用词，如“的”、“是”、“在”、“and”、“the”等，避免这些词对搜索结果的影响。</li>
<li>词根提取(Stemming)：将词汇还原为词根，如“running”还原为“run”。</li>
<li>同义词扩展(Synonyms)：将同义词映射到同一个词项，如“car”和“automobile”映射到同一个词项。</li>
</ol>
<h2 id="bulb-搜索算法"><a href="#bulb-搜索算法" class="headerlink" title=":bulb:搜索算法"></a><span class="github-emoji"><span>💡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>搜索算法</h2><h3 id="BM25算法"><a href="#BM25算法" class="headerlink" title="BM25算法"></a>BM25算法</h3><blockquote>
<p>BM25算法是一种基于概率检索模型的搜索算法，它是一种基于词频和文档长度的搜索算法，适用于大型文本数据集的搜索，考虑了文档中各项词的权重、词频、文档长度等因素，根据<strong>文档和查询</strong>之间的关系来评估文档的相关性，并按照相关性进行排序。</p>
</blockquote>
<p>评分公式：<script type="math/tex">\text{score}(D, Q) = \sum_{i=1}^{n} \text{IDF}(q_i) \cdot \frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot (1 - b + b \cdot \frac{|D|}{\text{avgdl}})}</script></p>
<p>其中：$D$表示文档，$Q$表示查询，$n$表示查询中的词项数量，$q_i$表示查询中的第$i$个词项，$f(q_i, D)$表示词项$q_i$在文档$D$中的词频，$k_1$和$b$是调节参数，$avgdl$表示文档集合的平均长度。</p>
<h3 id="TF-IDF算法-Term-Frequency-Inverse-Document-Frequency"><a href="#TF-IDF算法-Term-Frequency-Inverse-Document-Frequency" class="headerlink" title="TF-IDF算法(Term Frequency-Inverse Document Frequency)"></a>TF-IDF算法(Term Frequency-Inverse Document Frequency)</h3><blockquote>
<p>TF-IDF算法是一种用于评估一个词对于一个文件集或一个语料库中某个文件的重要程度的统计方法，基本思想是如果某个词在一篇文章中出现的频率高，并且在其他文章中出现的频率低，则认为这个词具有很好的区分能力，是这篇文章的关键词。</p>
</blockquote>
<ul>
<li>TF(Term Frequency)：词频，表示某个词在文档中出现的频率，计算公式为<script type="math/tex">\text{TF}(t, d) = \frac{f(t, d)}{\sum_{t' \in d} f(t', d)}</script></li>
<li>IDF(Inverse Document Frequency)：逆文档频率，表示某个词在文档集合中的区分能力，计算公式为<script type="math/tex">\text{IDF}(t, D) = \log \frac{N}{\text{DF}(t, D)}</script></li>
<li>TF-IDF：综合考虑词频和逆文档频率，计算公式为<script type="math/tex">\text{TF-IDF}(t, d, D) = \text{TF}(t, d) \cdot \text{IDF}(t, D)</script></li>
</ul>
<h3 id="空间向量模型-Vector-Space-Model"><a href="#空间向量模型-Vector-Space-Model" class="headerlink" title="空间向量模型(Vector Space Model)"></a>空间向量模型(Vector Space Model)</h3><blockquote>
<p>空间向量模型是一种基于向量空间的搜索算法，将文档和查询表示为向量，通过计算向量之间的相似度来评估文档的相关性。</p>
</blockquote>
<h4 id="余弦相似度-Cosine-Similarity"><a href="#余弦相似度-Cosine-Similarity" class="headerlink" title="余弦相似度(Cosine Similarity)"></a>余弦相似度(Cosine Similarity)</h4><ul>
<li>基于向量的夹角来衡量文档和查询的相似度，计算文档向量和查询向量的内积除以两个向量的模长的乘积，计算公式为<script type="math/tex">\text{Cosine Similarity}(D, Q) = \frac{D \cdot Q}{\|D\| \cdot \|Q\|}</script>，其中$D$表示文档向量，$Q$表示查询向量，取值范围为$[-1, 1]$，值越大表示相似度越高。</li>
</ul>
<h4 id="Jaccard相似度-Jaccard-Similarity"><a href="#Jaccard相似度-Jaccard-Similarity" class="headerlink" title="Jaccard相似度(Jaccard Similarity)"></a>Jaccard相似度(Jaccard Similarity)</h4><ul>
<li>基于向量的交集和并集来衡量文档和查询的相似度，计算文档向量和查询向量的交集除以两个向量的并集，计算公式为<script type="math/tex">\text{Jaccard Similarity}(D, Q) = \frac{|D \cap Q|}{|D \cup Q|}</script>，取值范围为$[0, 1]$，值越大表示相似度越高。</li>
</ul>
<h2 id="computer-Coding"><a href="#computer-Coding" class="headerlink" title=":computer:Coding"></a><span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Coding</h2><h3 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h3><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- lucene核心包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${lunece.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lucene查询解析包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-queryparser<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${lunece.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lucene分词器包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-analyzers-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${lunece.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="从文件构建索引和检索"><a href="#从文件构建索引和检索" class="headerlink" title="从文件构建索引和检索"></a>从文件构建索引和检索</h3><h4 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h4><ul>
<li>在资源目录下创建一个<code>data</code>目录，用于存放文档数据，这里用了雅思的三段话作为示例数据$1.txt$，$2.txt$，$3.txt$。</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/JavaProjects/luceneDemo/src/main/resources/data</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Many procedures are available for obtaining data about a language. They range from a carefully planned, intensive field investigation in a foreign country to a casual introspection about one’s mother tongue carried out in an armchair at home."</span> &gt; ~/JavaProjects/luceneDemo/src/main/resources/data/1.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"In all cases, someone has to act as a source of language data – an informant. Informants are (ideally) native speakers of a language, who provide utterances for analysis and other kinds of information about the language (e.g. translations, comments about correctness, or judgements on usage). Often, when studying their mother tongue, linguists act as their own informants, judging the ambiguity, acceptability, or other properties of utterances against their own intuitions. The convenience of this approach makes it widely used, and it is considered the norm in the generative approach to linguistics. But a linguist’s personal judgements are often uncertain, or disagree with the judgements of other linguists, at which point recourse is needed to more objective methods of enquiry, using non-linguists as informants. The latter procedure is unavoidable when working on foreign languages, or child speech."</span> &gt; ~/JavaProjects/luceneDemo/src/main/resources/data/2.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Many factors must be considered when selecting informants – whether one is working with single speakers (a common situation when languages have not been described before), two people interacting, small groups or large-scale samples. Age, sex, social background and other aspects of identity are important, as these factors are known to influence the kind of language used. The topic of conversation and the characteristics of the social setting (e.g. the level of formality) are also highly relevant, as are the personal qualities of the informants (e.g. their fluency and consistency). For larger studies, scrupulous attention has been paid to the sampling theory employed, and in all cases, decisions have to be made about the best investigative techniques to use."</span> &gt; ~/JavaProjects/luceneDemo/src/main/resources/data/3.txt</span><br></pre></td></tr></tbody></table></figure>
<h4 id="构建索引"><a href="#构建索引" class="headerlink" title="构建索引"></a>构建索引</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Indexer</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IndexWriter writer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Indexer</span><span class="params">(String indexDir)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="type">Directory</span> <span class="variable">dir</span> <span class="operator">=</span> FSDirectory.open(Paths.get(indexDir));</span><br><span class="line">        <span class="comment">// StandardAnalyzer标准分词器，将忽略is，a，the等单词</span></span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>());</span><br><span class="line">        <span class="comment">// 实例化写索引对象</span></span><br><span class="line">        writer = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(dir, config);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭索引写入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        writer.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 索引dataDir目录下的所有文件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexALl</span><span class="params">(String dataDir)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        File[] files = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir).listFiles();</span><br><span class="line">        <span class="keyword">assert</span> files != <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (File file : files) {</span><br><span class="line">            indexFile(file);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> writer.numDocs();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 索引单个文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">indexFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"Indexing "</span> + file.getCanonicalPath());</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> getDocument(file);</span><br><span class="line">        <span class="comment">// 将文档写入索引</span></span><br><span class="line">        writer.addDocument(doc);</span><br><span class="line">        writer.commit();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取某个文件的文档</span></span><br><span class="line">    <span class="keyword">private</span> Document <span class="title function_">getDocument</span><span class="params">(File file)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"contents"</span>, <span class="keyword">new</span> <span class="title class_">FileReader</span>(file)));</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"fileName"</span>, file.getName(), TextField.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"fullPath"</span>, file.getCanonicalPath(), TextField.Store.YES));</span><br><span class="line">        <span class="keyword">return</span> doc;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">indexDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/Index"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/data"</span>;</span><br><span class="line">        <span class="type">Indexer</span> <span class="variable">indexer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">indexNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            indexer = <span class="keyword">new</span> <span class="title class_">Indexer</span>(indexDir);</span><br><span class="line">            indexNum = indexer.indexALl(dataDir);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">assert</span> indexer != <span class="literal">null</span>;</span><br><span class="line">                indexer.close();</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Index "</span> + indexNum + <span class="string">" files, cost "</span> + (endTime - startTime) + <span class="string">" ms"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.DirectoryReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.ScoreDoc;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Searcher</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">(String indexDir, String q)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 索引所在路径</span></span><br><span class="line">        <span class="type">Directory</span> <span class="variable">dir</span> <span class="operator">=</span> FSDirectory.open(Paths.get(indexDir));</span><br><span class="line">        <span class="type">IndexReader</span> <span class="variable">reader</span> <span class="operator">=</span> DirectoryReader.open(dir);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">searcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(reader);</span><br><span class="line">        <span class="comment">// 创建查询解析器</span></span><br><span class="line">        <span class="type">QueryParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">"contents"</span>, <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>());</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> parser.parse(q);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 查询并记录前十条数据</span></span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">hits</span> <span class="operator">=</span> searcher.search(query, <span class="number">10</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Found "</span> + hits.totalHits + <span class="string">" document(s) (in "</span> + (end - start) + <span class="string">" milliseconds) that matched query '"</span> + q + <span class="string">"':"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从结果中取数据</span></span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc scoreDoc : hits.scoreDocs) {</span><br><span class="line">            <span class="comment">// scoreDoc.doc即docID，根据这个docID来获取文档</span></span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> searcher.doc(scoreDoc.doc);</span><br><span class="line">            System.out.println(doc.get(<span class="string">"fullPath"</span>));</span><br><span class="line">        }</span><br><span class="line">        reader.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">indexDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/Index"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">q</span> <span class="operator">=</span> <span class="string">"speakers"</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            search(indexDir, q);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="增删改查测试"><a href="#增删改查测试" class="headerlink" title="增删改查测试"></a>增删改查测试</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexingTest</span> {</span><br><span class="line">    <span class="keyword">private</span> Directory dir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] ids = {<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>};</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] tools = {<span class="string">"Lucene"</span>, <span class="string">"ElasticSearch"</span>, <span class="string">"Solr"</span>};</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] positions = {<span class="string">"Java Engineer"</span>, <span class="string">"DevOps Engineer"</span>, <span class="string">"Data Engineer"</span>};</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] descs = {</span><br><span class="line">            <span class="string">"Lucene is a full-featured text search engine library written entirely in Java."</span>,</span><br><span class="line">            <span class="string">"ElasticSearch is a distributed, RESTful search and analytics engine capable of solving a growing number of use cases."</span>,</span><br><span class="line">            <span class="string">"Solr is the popular, blazing-fast, open source enterprise search platform built on Apache Lucene."</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIndexAdd</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ids.length; i++) {</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            doc.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">"id"</span>, ids[i], StringField.Store.YES));</span><br><span class="line">            doc.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">"tool"</span>, tools[i], StringField.Store.YES));</span><br><span class="line">            doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"position"</span>, positions[i], TextField.Store.YES));</span><br><span class="line">            <span class="comment">// TextField field = new TextField("position", poitions[i], StringField.Store.YES);</span></span><br><span class="line">            <span class="comment">// if("DevOps Engineer".equals(positions[i])){</span></span><br><span class="line">            <span class="comment">//     field.setBoost(1.5f);</span></span><br><span class="line">            <span class="comment">// }</span></span><br><span class="line">            <span class="comment">// doc.add(field);</span></span><br><span class="line">            doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"desc"</span>, descs[i], StringField.Store.YES));</span><br><span class="line">            writer.addDocument(doc);</span><br><span class="line">        }</span><br><span class="line">        writer.commit();</span><br><span class="line">        writer.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IndexWriter <span class="title function_">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">String</span> <span class="variable">indexDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/testIndex"</span>;</span><br><span class="line">        dir = FSDirectory.open(Paths.get(indexDir));</span><br><span class="line">        <span class="type">Analyzer</span> <span class="variable">analyzer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>();</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(dir, config);</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIndexWriterNum</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter();</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd: "</span> + writer.numDocs());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteBeforeMerge</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter();</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd before delete: "</span> + writer.numDocs());</span><br><span class="line">        writer.deleteDocuments(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"id"</span>, <span class="string">"1"</span>));</span><br><span class="line">        writer.commit();</span><br><span class="line">        System.out.println(<span class="string">"Max number of documents in this testIndexAdd after delete: "</span> + writer.maxDoc());</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd after delete: "</span> + writer.numDocs());</span><br><span class="line">        writer.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteAfterMerge</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter();</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd before delete: "</span> + writer.numDocs());</span><br><span class="line">        writer.deleteDocuments(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"id"</span>, <span class="string">"1"</span>));</span><br><span class="line">        writer.forceMergeDeletes();</span><br><span class="line">        writer.commit();</span><br><span class="line">        System.out.println(<span class="string">"Max number of documents in this testIndexAdd after delete: "</span> + writer.maxDoc());</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd after delete: "</span> + writer.numDocs());</span><br><span class="line">        writer.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// new a document</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">"id"</span>, <span class="string">"1"</span>, StringField.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">"tool"</span>, <span class="string">"Lucene"</span>, StringField.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"position"</span>, <span class="string">"Java Engineer"</span>, StringField.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"desc"</span>, <span class="string">"Lucene is a full-text search engine library"</span>, StringField.Store.YES));</span><br><span class="line">        writer.updateDocument(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"id"</span>, <span class="string">"1"</span>), doc);</span><br><span class="line"></span><br><span class="line">        writer.commit();</span><br><span class="line">        writer.close();</span><br><span class="line">        System.out.println(doc.getField(<span class="string">"desc"</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIndexReader</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">String</span> <span class="variable">indexDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/testIndex"</span>;</span><br><span class="line">        dir = FSDirectory.open(Paths.get(indexDir));</span><br><span class="line">        <span class="type">IndexReader</span> <span class="variable">reader</span> <span class="operator">=</span> DirectoryReader.open(dir);</span><br><span class="line">        System.out.println(<span class="string">"Total number of documents in this testIndexAdd: "</span> + reader.numDocs());</span><br><span class="line">        System.out.println(<span class="string">"Total number of deleted documents in this testIndexAdd: "</span> + reader.numDeletedDocs());</span><br><span class="line">        System.out.println(<span class="string">"Total number of max docs in this testIndexAdd: "</span> + reader.maxDoc());</span><br><span class="line">        reader.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIndexSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">String</span> <span class="variable">indexDir</span> <span class="operator">=</span> <span class="string">"~/JavaProjects/luceneDemo/src/main/resources/testIndex"</span>;</span><br><span class="line">        dir = FSDirectory.open(Paths.get(indexDir));</span><br><span class="line">        <span class="type">IndexReader</span> <span class="variable">reader</span> <span class="operator">=</span> DirectoryReader.open(dir);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">searcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(reader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Query</span></span><br><span class="line">        <span class="type">QueryParser</span> <span class="variable">parse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">"desc"</span>, <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>());</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> parse.parse(<span class="string">"search"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 权重搜索排序</span></span><br><span class="line">        <span class="comment">// 创建TermQuery</span></span><br><span class="line">        <span class="type">TermQuery</span> <span class="variable">termQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"DevOps"</span>.toLowerCase()));</span><br><span class="line">        <span class="comment">// 提升TermQuery的权重</span></span><br><span class="line">        <span class="type">BoostQuery</span> <span class="variable">boostQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoostQuery</span>(termQuery, <span class="number">1.5f</span>);</span><br><span class="line">        <span class="comment">// 创建BooleanQuery</span></span><br><span class="line">        BooleanQuery.<span class="type">Builder</span> <span class="variable">booleanQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder();</span><br><span class="line">        booleanQuery.add(query, BooleanClause.Occur.MUST);</span><br><span class="line">        booleanQuery.add(boostQuery, BooleanClause.Occur.SHOULD);</span><br><span class="line"></span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">hits</span> <span class="operator">=</span> searcher.search(booleanQuery.build(), <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Total number of hits: "</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc scoreDoc : hits.scoreDocs) {</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> searcher.doc(scoreDoc.doc);</span><br><span class="line">            System.out.println(doc.get(<span class="string">"id"</span>));</span><br><span class="line">            System.out.println(doc.get(<span class="string">"tool"</span>));</span><br><span class="line">            System.out.println(doc.get(<span class="string">"position"</span>));</span><br><span class="line">            System.out.println(doc.get(<span class="string">"desc"</span>));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        reader.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="mag-Attention"><a href="#mag-Attention" class="headerlink" title=":mag:Attention"></a><span class="github-emoji"><span>🔍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Attention</h4><ul>
<li><p><code>TextField</code>和<code>StringField</code>的区别</p>
<ul>
<li><code>StringField</code>：不会被分词器处理，适用于精确匹配查询，如ID、日期、分类等字段，<code>StringField.Store.YES</code>表示存储字段值。</li>
<li><p><code>TextField</code>：会被分词器处理，适用于需要进行全文搜索的文本内容，如文章内容、描述等字段，<code>TextField.Store.YES</code>表示存储字段值并进行分词处理。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 使用StringField存储ID字段</span></span><br><span class="line">doc.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">"id"</span>, <span class="string">"1"</span>, StringField.Store.YES));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用TextField存储描述字段</span></span><br><span class="line">doc.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">"desc"</span>, <span class="string">"Lucene is a full-featured text search engine library written entirely in Java."</span>, TextField.Store.YES));</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p><code>IndexWriter</code>的<code>commit</code>和<code>close</code>方法</p>
<ul>
<li><code>commit</code>：提交索引，将内存中的索引写入磁盘，保证索引的一致性。</li>
<li><code>close</code>：关闭索引写入器，释放资源。</li>
</ul>
</li>
<li><p><code>TermQuery</code>中的文本可以是大写也可以是小写，但必须与索引中的文本完全匹配。因为<code>TermQuery</code>不会对查询文本进行分析或分词处理，所以如果索引中的文本是小写，那么查询文本也必须是小写。如果使用了<code>StandardAnalyzer</code>或其他分词器在索引时将文本转换为小写，那么在查询时也需要将文本转换为小写以确保匹配。可以使用<code>LowerCaseFilter</code>或<code>LowerCaseTokenizer</code>来确保查询文本是小写的。</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 创建TermQuery并将文本转换为小写</span></span><br><span class="line"><span class="type">TermQuery</span> <span class="variable">termQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"DevOps"</span>.toLowerCase()));</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>TermQuery</code>不会进行分词处理，只会进行精确匹配查询，所以查询文本必须与索引中的文本完全匹配。如果需要查询包含多个词的字段，可以使用<code>PhraseQuery</code>或<code>BooleanQuery</code>。</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 使用PhraseQuery查询包含多个词的字段</span></span><br><span class="line"><span class="type">PhraseQuery</span> <span class="variable">phraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder()</span><br><span class="line">    .add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"DevOps"</span>))</span><br><span class="line">    .add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"Engineer"</span>))</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用BooleanQuery查询包含多个词的字段</span></span><br><span class="line"><span class="type">BooleanQuery</span> <span class="variable">booleanQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder()</span><br><span class="line">    .add(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"DevOps"</span>)), BooleanClause.Occur.MUST)</span><br><span class="line">    .add(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"Engineer"</span>)), BooleanClause.Occur.MUST)</span><br><span class="line">    .build();</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>$lunece.version&gt;7.0$已经不再支持<code>setBoost</code>方法</p>
<ul>
<li><a href="https://issues.apache.org/jira/browse/LUCENE-6819">LUCENE-6819</a>: Index-time boosts are not supported anymore. As a replacement, index-time scoring factors should be indexed into a doc value field and combined at query time using eg. FunctionScoreQuery</li>
</ul>
</li>
<li>同样不建议使用<code>Query.setBoost()</code>或者<code>Query.createWeight()</code><ul>
<li><a href="https://issues.apache.org/jira/browse/LUCENE-6590">LUCENE-6590</a>: Query.setBoost(), Query.getBoost() and Query.clone() are gone. In order to apply boosts, you now need to wrap queries in a BoostQuery.</li>
</ul>
</li>
<li><p>建议用<code>BoostQuery</code>封装来写权重查询，可以通过设置权重值来调整查询的相关性，值越大表示相关性越高。可以将<code>TermQuery</code>或<code>BooleanQuery</code>包装在<code>BoostQuery</code>中，然后将<code>BoostQuery</code>添加到<code>BooleanQuery</code>中。</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 创建TermQuery</span></span><br><span class="line"><span class="type">TermQuery</span> <span class="variable">termQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">"position"</span>, <span class="string">"DevOps"</span>.toLowerCase()));</span><br><span class="line"><span class="comment">// 提升TermQuery的权重</span></span><br><span class="line"><span class="type">BoostQuery</span> <span class="variable">boostQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoostQuery</span>(termQuery, <span class="number">1.5f</span>);</span><br><span class="line"><span class="comment">// 创建BooleanQuery</span></span><br><span class="line">BooleanQuery.<span class="type">Builder</span> <span class="variable">booleanQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder();</span><br><span class="line">booleanQuery.add(query, BooleanClause.Occur.MUST);</span><br><span class="line">booleanQuery.add(boostQuery, BooleanClause.Occur.SHOULD);</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Lucene</tag>
      </tags>
  </entry>
  <entry>
    <title>Matlab sort out</title>
    <url>/2021/06/19/Matlab%20sort%20out/</url>
    <content><![CDATA[<h3 id="Personal-matlab-sort-out-about-communication-simulations-finally"><a href="#Personal-matlab-sort-out-about-communication-simulations-finally" class="headerlink" title="Personal matlab sort out about communication simulations finally"></a>Personal matlab sort out about communication simulations finally</h3><span id="more"></span>
<h2 id="1-Basics"><a href="#1-Basics" class="headerlink" title="1.Basics"></a>1.Basics</h2><ul>
<li>Scalars</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">a = <span class="number">10</span></span><br><span class="line">a = <span class="number">10</span>+<span class="number">1</span><span class="built_in">i</span>       <span class="comment">% 推荐使用1i</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Vectors</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">a = [<span class="number">1</span> <span class="number">3</span> <span class="number">5</span>]     <span class="comment">% 1行3列</span></span><br><span class="line">a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]     <span class="comment">% 使用,与否效果相同</span></span><br><span class="line">a = <span class="number">1</span>:<span class="number">2</span>:<span class="number">7</span>       <span class="comment">% begin:step:end</span></span><br><span class="line">a = [<span class="number">1</span>;<span class="number">3</span>;<span class="number">5</span>]     <span class="comment">% 3行1列</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Matrices</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">A = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>;<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>] <span class="comment">% 三行三列矩阵</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Operations</li>
</ul>
<ol>
<li><p><code>*</code> 和<code>.*</code>的区别</p>
<blockquote>
<p>在进行数值运算和数值乘矩阵运算，两者无区别，<code>a*b=a.*b; a*B=a.*B; B*a=B.*a</code>（其中小写字母表示数值，大写字母表示矩阵，下同）。<br>在处理矩阵乘矩阵时，<code>*</code>表示普通的矩阵乘法，要求前面矩阵的列数等于后面矩阵的行数；<code>.*</code>表示两个矩阵对应元素相乘，要求两个矩阵行数列数都相等。</p>
</blockquote>
 <figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">&gt;&gt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]*[<span class="number">1</span>,<span class="number">2</span>;<span class="number">3</span>,<span class="number">4</span>;<span class="number">5</span>,<span class="number">6</span>]       <span class="comment">% 矩阵乘法</span></span><br><span class="line"><span class="built_in">ans</span> =</span><br><span class="line"><span class="number">22</span>    <span class="number">28</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].*[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]            <span class="comment">% 矩阵点乘</span></span><br><span class="line"><span class="built_in">ans</span> =</span><br><span class="line"><span class="number">4</span>    <span class="number">10</span>    <span class="number">18</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>/</code> 和<code>./</code>的区别</p>
<blockquote>
<p>数值运行时，这两种没有区别，<code>a/b=a./b</code><br>数值与矩阵运算，数值在前时只能用<code>./</code>;数值在后时<code>a/b=a./b</code><br>矩阵与矩阵，<code>A/B</code>可以看作是<code>A*inv(B)</code>;<code>A./B</code>表示A矩阵和B矩阵对应元素相除，需要矩阵维度保持一致。<br>另外有<code>\</code>和<code>.\</code>表示前除，类似小学时候详细区的分除和被除运算，一般习惯不使用这种。</p>
</blockquote>
 <figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">&gt;&gt; [<span class="number">4</span>,<span class="number">5</span>]/[<span class="number">1</span>,<span class="number">2</span>;<span class="number">3</span>,<span class="number">4</span>]                    <span class="comment">% 矩阵除法</span></span><br><span class="line"><span class="built_in">ans</span> =</span><br><span class="line"><span class="number">-0.5000</span>    <span class="number">1.5000</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]./[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]                   <span class="comment">% 矩阵点除</span></span><br><span class="line"><span class="built_in">ans</span> =</span><br><span class="line"><span class="number">4.0000</span>    <span class="number">2.5000</span>    <span class="number">2.0000</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>A(1,1)</code>、<code>A(:,1)</code>、<code>A(1,:)</code>、<code>A(:,:)</code></p>
</li>
<li><p><code>[1+2*1i,3+4*1i]'</code>和<code>[1+2*1i,3+4*1i].'</code>都表示矩阵的转置,实数情况下<code>A'</code>和<code>A.'</code>没有区别；复数情况下<code>A'</code>会产生<code>A</code>的转置共轭矩阵，<code>A.'</code>产生普通的转置矩阵。</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="number">1</span>+<span class="number">2</span>*<span class="number">1</span><span class="built_in">i</span>,<span class="number">3</span>+<span class="number">4</span>*<span class="number">1</span><span class="built_in">i</span>]'=[<span class="number">1</span><span class="number">-2</span>*<span class="number">1</span><span class="built_in">i</span>;<span class="number">3</span><span class="number">-4</span>*<span class="number">1</span><span class="built_in">i</span>]</span><br><span class="line">[<span class="number">1</span>+<span class="number">2</span>*<span class="number">1</span><span class="built_in">i</span>,<span class="number">3</span>+<span class="number">4</span>*<span class="number">1</span><span class="built_in">i</span>].'=[<span class="number">1</span>+<span class="number">2</span>*<span class="number">1</span><span class="built_in">i</span>;<span class="number">3</span>+<span class="number">4</span>*<span class="number">1</span><span class="built_in">i</span>]</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<ul>
<li><p>Special number</p>
<p>  <code>pi</code><br>  <code>Inf</code>、<code>inf</code>:infinity,i.e.,1/0<br>  <code>NaN</code>、<code>nan</code>:not a number,e.g.,0/0<br>  <code>eps</code>:accuracy of the matlab,eps= 2-52 ≈ 2.2204×10-16</p>
</li>
<li><p>General functions</p>
<ul>
<li>Trigonometric functions:<br><code>cos(x)</code>、<code>sin(x)</code>、<code>tan(x)</code></li>
<li>Complex:<br>z = a+bi = $re^{i\theta}$<br><code>real(z)</code>、<code>imag(z)</code>、<code>abs(z)</code>、<code>angle(z)</code>、<code>conj(z)</code></li>
<li>Exponential and logarithm functions</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>exp(x)</code></td>
<td style="text-align:center">$e^{x}$</td>
<td style="text-align:center"><code>log1p(x)</code></td>
<td style="text-align:center">ln(1+x)</td>
</tr>
<tr>
<td style="text-align:center"><code>pow2(x)</code></td>
<td style="text-align:center">$2^{x}$</td>
<td style="text-align:center"><code>log2(x)</code></td>
<td style="text-align:center">$log_{2}{x}$</td>
</tr>
<tr>
<td style="text-align:center"><code>log(x)</code></td>
<td style="text-align:center">lnx</td>
<td style="text-align:center"><code>log10(x)</code></td>
<td style="text-align:center">$log_{10}{x}$、$lg(x)$</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Array and matrix</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>ones</code></td>
<td style="text-align:center">All one</td>
<td style="text-align:center"><code>zeros</code></td>
<td style="text-align:center">All zeros</td>
</tr>
<tr>
<td style="text-align:center"><code>length</code></td>
<td style="text-align:center">length</td>
<td style="text-align:center"><code>size</code></td>
<td style="text-align:center">Dimension of array</td>
</tr>
<tr>
<td style="text-align:center"><code>sum</code></td>
<td style="text-align:center">sum</td>
<td style="text-align:center"><code>mean</code></td>
<td style="text-align:center">Mean of array</td>
</tr>
<tr>
<td style="text-align:center"><code>reshape</code></td>
<td style="text-align:center">Reshape the array</td>
<td style="text-align:center"><code>sort</code></td>
<td style="text-align:center">Sort the array</td>
</tr>
<tr>
<td style="text-align:center"><code>min</code></td>
<td style="text-align:center">minimum</td>
<td style="text-align:center"><code>max</code></td>
<td style="text-align:center">maximum</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Rounding functions<br><code>round</code>、<code>fix</code>、<code>floor</code>、<code>ceil</code></li>
<li>Figure plotting<br><code>plot()</code>、<code>subplot(n,m,i)</code>、<code>figure(i)</code>、<code>xlabel()</code>、<code>ylabel()</code><br><code>title()</code>、<code>legend()</code>、<code>hold on</code>、<code>grid on</code>、<code>semilogy()</code>…</li>
<li>Function format<br><code>function [outputs]=function_name(inputs)</code></li>
</ul>
<h2 id="2-Signals-and-linear-systems"><a href="#2-Signals-and-linear-systems" class="headerlink" title="2.Signals and linear systems"></a>2.Signals and linear systems</h2><ul>
<li><p>Basic sequence</p>
<ul>
<li>Impulse signal and sequence</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">t = <span class="number">-5</span>:<span class="number">0.01</span>:<span class="number">5</span>;</span><br><span class="line">y = (t==<span class="number">0</span>);</span><br><span class="line">subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line"><span class="built_in">plot</span>(t, y, <span class="string">'r’);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n = -5:5;</span></span><br><span class="line"><span class="string">x = (n==0);</span></span><br><span class="line"><span class="string">subplot(1,2,2);</span></span><br><span class="line"><span class="string">stem(n, x);</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Step signal and sequence</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">t =<span class="number">-5</span>:<span class="number">0.01</span>:<span class="number">5</span>;</span><br><span class="line">y=(t&gt;=<span class="number">0</span>);</span><br><span class="line">subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line"><span class="built_in">plot</span>(t, y, <span class="string">'r'</span>)</span><br><span class="line"></span><br><span class="line">n = <span class="number">-5</span>:<span class="number">5</span>;</span><br><span class="line">x = (n&gt;=<span class="number">0</span>);</span><br><span class="line">subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">stem(n, x);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Real exponential sequence<br>x(n)=$a^n$, $\forall n$,  $a\in R$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">n=[ns:nf];</span><br><span class="line">x=a.^n;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Exponential sequence<br>x(n)=$e^{(\delta +j\omega)n}$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">n=[ns:nf];</span><br><span class="line">x=<span class="built_in">exp</span>((delta+jw)*n);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Sinine, cosine sequence<br>$x(n)=cos(\omega n+\theta)$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">n=[ns:nf];</span><br><span class="line">x=<span class="built_in">cos</span>(w*n+sita);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Other signal generation functions</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
<th style="text-align:center">Name</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>sawtooth</code></td>
<td style="text-align:center">Sawtooth or triangle wave</td>
<td style="text-align:center"><code>pulstran</code></td>
<td style="text-align:center">Pulse train</td>
</tr>
<tr>
<td style="text-align:center"><code>square</code></td>
<td style="text-align:center">Square wave</td>
<td style="text-align:center"><code>rectpule</code></td>
<td style="text-align:center">A period square wave</td>
</tr>
<tr>
<td style="text-align:center"><code>sinc</code></td>
<td style="text-align:center">Sinc wave</td>
<td style="text-align:center"><code>tripuls</code></td>
<td style="text-align:center">A period triangle wave</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Signal Operations</p>
<ul>
<li>Moving<br>y(n)=x(n-m)</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y(n)=x(n-m)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Periodic extension<br>$y(n)=x((n))_{M}$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y(n)=x(<span class="built_in">mod</span>(n,M)+<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Flipping<br>y(n)=x(-n)</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y=<span class="built_in">fliplr</span>(x)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Correlation with two sequences<br>$y(m)=\sum^n x_1(n+m)x_2^*(n)$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y=xcorr(x1,x2)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Cumulative sum<br>$y(n)=\sum_{i=1}^n x(i)$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y=cumsum(x)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Convolution of two sequences<br>$y(n)=x_1(n)*x_2(n)=\sum^mx_1(m)x_x(n-m)$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y=conv(x1,x2)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Convolution of two <em>continuous-time</em> signals：<br>$f(t)=\int<em>{-\infty}^{+\infty}f_1(\tau)f_2(t-\tau)d\tau$<br>$f(t)=\sum</em>{k=-\infty}^{+\infty}f_1(k\Delta)f_2(t-k\Delta)\Delta$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">y=conv(x1,x2)*dt</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Fourier transform</p>
<ul>
<li>Continuous-time，continuous-frequency: FT</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">T2F</th>
<th style="text-align:center">F2T</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$X(f)=\int_{-\infty}^{+\infty}x(t) e^{-j2\pi ft}dt$</td>
<td style="text-align:center">$x(t)=\int_{-\infty}^{+\infty}X(f) e^{j2\pi ft}df$</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Discrete-time, discrete-frequency: DFT / FFT</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">T2F</th>
<th style="text-align:center">F2T</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$X(k)=\sum_{n=0}^{N-1}x(n) e^{-j\frac{2pi}{N}nk}$</td>
<td style="text-align:center">$x(t)=\frac{1}{N}\sum_{n=0}^{N-1}X(k) e^{j\frac{2pi}{N}nk}$</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Energy and Power</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">dt=t(<span class="number">2</span>)-t(<span class="number">1</span>);</span><br><span class="line">df=f(<span class="number">2</span>)-f(<span class="number">1</span>);</span><br><span class="line">N=<span class="built_in">length</span>(t);</span><br><span class="line">T=t(<span class="keyword">end</span>)-t(<span class="number">1</span>)+dt;   <span class="comment">% T=N*dt</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Energy</p>
<ul>
<li>T-domain<br>$x[n]=x(n\Delta t)$<br>$E=\int<em>{-\infty}^{+\infty} |x(t)|^2dt \approx\sum</em>{n=0}^M x[n]·x^*[n]·\Delta t$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">% E=sum(x.*conj(x))*dt;</span></span><br><span class="line">E=sum(<span class="built_in">abs</span>(x).^<span class="number">2</span>)*dt;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>F-domain<br>$X[k]=X(k\Delta f)$<br>$E=\int<em>{-\infty}^{+\infty} |X(f)|^2df \approx\sum</em>{k=0}^{k-1} X[k]·X^*[k]·\Delta f$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">% E=sum(x.*conj(x))*df;</span></span><br><span class="line">E=sum(<span class="built_in">abs</span>(x).^<span class="number">2</span>)*df;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Power</p>
<ul>
<li>T-domain<br>$P=\lim<em>{T\rightarrow\infty}\frac{1}{T}\int_0^T |x(t)|^2dt \approx\frac{1}{N}\sum</em>{n=0}^{N-1} |x[n]|^2$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">% P=sum(x.*conj(x))/N;</span></span><br><span class="line">P=sum(<span class="built_in">abs</span>(x).^<span class="number">2</span>)/N;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>F-domain<br><em>$X_Tf$ is the spectrum of x(t) within [0,T]</em><br>$P=\lim<em>{T\rightarrow\infty}\frac{1}{T}\int</em>{-\infty}^{+\infty} |X<em>T(f)|^2df \approx\frac{1}{N}\sum</em>{k=0}^{K-1} |X[k]|^2\Delta f$</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">% P=sum(x.*conj(x))*df/T;</span></span><br><span class="line">P=sum(<span class="built_in">abs</span>(x).^<span class="number">2</span>)*df/T;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Autocorrelation and Power spectral density(PSD)</p>
<ul>
<li><p>Autocorrelation<br>$x[n]=x(n\Delta t)$<br>$R(\tau)=\int<em>{-\infty}^{+\infty} x(t)x^* (t+\tau)dt \approx\sum</em>{n=0}^M x[n]·x^*[n+\tau]·\Delta t$<br>$R<em>T(\tau)=\lim</em>{T\rightarrow\infty}\frac{R(\tau)}{T}$</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">R(tau)=sum(x(t).*<span class="built_in">conj</span>(x(t+tau))*dt/(N*dt);</span><br><span class="line"></span><br><span class="line"><span class="comment">%% or</span></span><br><span class="line">R=xcorr(x);</span><br><span class="line">R=R*Ts/T;   <span class="comment">% R=R/N</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>PSD<br>$P<em>T(f)=\lim</em>{T\rightarrow\infty}\frac{|X_T(f)|^2}{T}$</p>
</li>
<li>Wiener-Khinchin theorem<br>$FT(R_T(\tau))=P_T(f)$</li>
</ul>
</li>
<li><p><span class="github-emoji"><span>🌀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f300.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Component</p>
<ul>
<li><p>hilbert change<br>通过希尔伯特变换，返回的实部是本身即同向分量(quadrature component)，虚部是延迟90°后的信号即正交分量(in-phase component)</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">x_a = hilbert(x);</span><br><span class="line">fc = <span class="number">50</span>;                        <span class="comment">% Carrier fc=50Hz</span></span><br><span class="line">x_l = x_a.*<span class="built_in">exp</span>(<span class="number">-1</span><span class="built_in">i</span>*<span class="number">2</span>*<span class="built_in">pi</span>*fc*t);  <span class="comment">% Lowpass equivalent</span></span><br><span class="line">x_i = <span class="built_in">real</span>(x_l);                <span class="comment">% In-phase component</span></span><br><span class="line">x_q = <span class="built_in">imag</span>(x_l);                <span class="comment">% Quadrature component</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="3-Randon-process-and-analog-modulation"><a href="#3-Randon-process-and-analog-modulation" class="headerlink" title="3.Randon process and analog modulation"></a>3.Randon process and analog modulation</h2><p>For a random process $x(t)$, for an arbitrary $t_1$，$x(t_1)$ is a random variable.</p>
<ul>
<li><p>Variables and Distributions</p>
<p>Function:$F_x(x)=Pr(X\leq x)$</p>
<ul>
<li>Probability density function:$p(x)=\frac{dF_x(x)}{dx}$</li>
<li>Expectation:$E[X]=\int_{-\infty}^{+\infty}xp(x)dx$</li>
<li>Moment:$E[X^n] =\int_{-\infty}^{+\infty} x^n p(x)dx$</li>
<li>Variance:$E[(X-m_x)^2] =E[X^2] -m_x^2$</li>
</ul>
</li>
<li><p>Ergodicity and Stationary</p>
<ul>
<li>Ergodicity<blockquote>
<p>1.The expectation of x(t) is a constant.<br><code>mean(x)=constant</code><br>2.Its autocorrelation only depends on the time difference.<br><code>Ry is autocorrelation of {Yn}.</code><br><code>After 100 times, Ry is has nothing to do with time.</code></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Stationary</p>
<blockquote>
<p>1.The expectation of x(t) equals the time-average. An arbitrary realization of the random process will go through all the possible states.<br>If one line has 1000 components, use <code>mean</code> to calculate expectation.<br>Use the first component of each line, the <code>mean</code> of one row is time-average.</p>
</blockquote>
</li>
<li><p><a href="https://www.lingzhicheng.cn/2021/04/21/Modulate%20and%20demodulate" target="_blank">e.g. Modulate and demodulate</a></p>
</li>
</ul>
<ul>
<li><p>Analog modulation</p>
<ul>
<li>Amplitude modulation(mainly)<br><code>m(t)</code>means the message signal.<ul>
<li>DSB-Am</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Time-domain</th>
<th style="text-align:center">Frequency-domain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$s(t)=A_{c}m(t)cos(2\pi{f_c}t)$</td>
<td style="text-align:center">$S(f)=\frac{A_c}{2}[M(f-{f_c})+M(f+{f_c})]$</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><ul>
<li><ul>
<li>Conventional AM</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Time-domain</th>
<th style="text-align:center">Frequency-domain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$s(t)=A_{c}(1+am(t))cos(2\pi{f_c}t)$</td>
<td style="text-align:center">$S(f)=\frac{A_c}{2}[\delta (f-{f_c})+aM(f-{f_c})+aM(f+{f_c})]$</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><ul>
<li><ul>
<li>SSB-AM(T-domain)<br>$s(t)=\frac{A<em>{c}}{2}m(t)cos(2\pi{f_c}t)\pm \frac{A</em>{c}}{2}m(t)sin(2\pi{f_c}t)$<br><strong>matlab code：$hilbert(m)=m(t)+j\hat{m}(t)$</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">U_SSB</th>
<th style="text-align:center">L_SSB</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$s(t)=\frac{A<em>{c}}{2}m(t)cos(2\pi{f_c}t)-\frac{A</em>{c}}{2}\hat{m}(t)sin(2\pi{f_c}t)$</td>
<td style="text-align:center">$s(t)=\frac{A<em>{c}}{2}m(t)cos(2\pi{f_c}t)+\frac{A</em>{c}}{2}\hat{m}(t)sin(2\pi{f_c}t)$</td>
</tr>
<tr>
<td style="text-align:center">$\frac{A_{c}}{2}Re[(m(t)+j\hat{m}(t))e^{j2\pi f_c t}]$</td>
<td style="text-align:center">$\frac{A_{c}}{2}Re[(m(t)+j\hat{m}(t))e^{-j2\pi f_c t}]$</td>
</tr>
</tbody>
</table>
</div>
<pre><code>- e.g.:ear:

<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line">Fs = <span class="number">1500</span>;              <span class="comment">% Sampling rate</span></span><br><span class="line">Ts = <span class="number">1</span>/Fs;              <span class="comment">% Sampling interval</span></span><br><span class="line">Fc = <span class="number">20</span>;                <span class="comment">% Carrier rate</span></span><br><span class="line">t = <span class="number">0</span>:Ts:<span class="number">1</span>;             <span class="comment">% Time vector</span></span><br><span class="line"></span><br><span class="line">m = <span class="built_in">sin</span>(<span class="number">2</span>*<span class="built_in">pi</span>*t);        <span class="comment">% Message signal</span></span><br><span class="line">c = <span class="built_in">cos</span>(<span class="number">2</span>*<span class="built_in">pi</span>*Fc*t);     <span class="comment">% Carrier signal</span></span><br><span class="line">Ac_DSB_AM = <span class="number">1</span>;</span><br><span class="line">Ac_USSB_AM = <span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">% DBS_AM modulated signal.</span></span><br><span class="line">u_dsb = Ac_DSB_AM*m.*c;</span><br><span class="line"><span class="comment">% SSB_AM modulated signal.</span></span><br><span class="line">u_ussb = <span class="number">1</span>/<span class="number">2</span>*Ac_USSB_AM*<span class="built_in">real</span>(hilbert(m).*<span class="built_in">exp</span>(<span class="number">1</span><span class="built_in">i</span>*<span class="number">2</span>*<span class="built_in">pi</span>*Fc*t));</span><br></pre></td></tr></tbody></table></figure>
</code></pre><h2 id="4-Baseband-signal-transmission"><a href="#4-Baseband-signal-transmission" class="headerlink" title="4.Baseband signal transmission"></a>4.Baseband signal transmission</h2><p>AWGN: add white gauss noise<br>Two optimum receivers for AWGN: signal correlator and matched filter.<br>For AWGN, the noise $N_i$ is Gaussian distributed with mean of zero and variance of $\frac{EN_0}{2}$.</p>
<ul>
<li><p>Binary modulations</p>
<ul>
<li>Received signal<ul>
<li>$r(t)=s_i(t)+n(t)，0\leq t \leq T_b，i=0,1$</li>
<li>Determine whether a 0 or 1 was transmitted.</li>
</ul>
</li>
<li>Signal correlator<ul>
<li>$r_0=\int_0^{T_b}r(t)s_0(t)dt=E+n_0$</li>
<li>$r_1=\int_0^{T_b}r(t)s_1(t)dt=n_1$</li>
</ul>
</li>
<li>Match filter<ul>
<li>Sample at $t=T_b$</li>
<li>$h<em>i(t)=s_i(T</em>{b}-t)，0\leq t \leq T_b，i=0,1$</li>
</ul>
</li>
<li>Detector<ul>
<li>The detector observe the correlator or matched filter output and decides on whether the transmitted signal waveform is either $s_0(t)$ or $s_1(t)$.</li>
<li>Comparing $r_0$ or $r_1$. If $r_0&gt;r_1$, it decides 0 is transmitted.</li>
<li>$P_e=Q(\frac{E}{\delta})=Q(\frac{E}{\sqrt{\frac{EN_0}{2}}})=Q(\sqrt{\frac{2E}{N_0}})$</li>
</ul>
</li>
</ul>
</li>
<li><p>Other binary modulations</p>
<ul>
<li>Antipodal signal<ul>
<li>$P<em>e(\alpha</em>{opt})=Q(\frac{\frac{E}{2}}{\delta})=Q(\frac{\frac{E}{2}}{\sqrt{\frac{EN_0}{2}}})=Q(\sqrt{\frac{E}{2N_0}})$</li>
</ul>
</li>
</ul>
</li>
<li><p>Monto Carlo simulation</p>
<ul>
<li>Source output <code>dsource=0</code>or<code>dsource=1</code></li>
<li>Detection<ul>
<li>Match filter output <code>r=E+gngauss(sgma)</code>or<code>r=-E+gngauss(sgma)</code></li>
<li>Detector <code>r&lt;0</code>?  <code>decis=0</code>or<code>decis=1</code></li>
<li>Error counter <code>decis!=dsource</code>?  <code>numoferr+=1</code></li>
</ul>
</li>
</ul>
</li>
<li><p>Constellation diagram</p>
<ul>
<li>$x_1=\sqrt{E}+n_1$</li>
<li>$n_1=\sqrt{\frac{N_0}{2}}*randn(100,1)$</li>
<li>$x_0=\sqrt{E}+n_0$</li>
<li>$n_0=\sqrt{\frac{N_0}{2}}*randn(100,1)$</li>
</ul>
</li>
</ul>
<h2 id="5-Pulse-Amplitude-Modulation-PAM"><a href="#5-Pulse-Amplitude-Modulation-PAM" class="headerlink" title="5.Pulse Amplitude Modulation(PAM)"></a>5.Pulse Amplitude Modulation(PAM)</h2><ul>
<li><p>Theoretical symbol error rate</p>
<ul>
<li>$P<em>M=\frac{2(M-1)}{M}Q(\sqrt{\frac{6(log</em>{2}M)E_{avb}}{(M^2{-}1)N_0}})$</li>
<li><code>SNR=exp(snr_in_dB*log(10)/10)</code>equals to<code>SNR=10^(snr_in_dB/10)</code></li>
</ul>
</li>
<li><p>Bit error rate and energy</p>
<ul>
<li><code>smld_err_pb=smld_err_p/M</code></li>
<li><p>Energy(M-PAM)(N symbols)<br>$E<em>{av}=\frac{1}{N}\sum</em>{k=1}^{N}\int<em>{0}^{T}s</em>{k}^{2}(t)dt$<br>$E=\frac{E_{av}}{M}$</p>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">%% 8PAM,M=3;there is 8 symbols.</span></span><br><span class="line">Eav = sum(Am.^<span class="number">2</span>)/<span class="number">8</span>      <span class="comment">% Average energy per symbol.</span></span><br><span class="line">E = Eav/<span class="number">3</span>               <span class="comment">% Average energy per bit.</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>Raised-cosine and ISI</p>
<ul>
<li>RC<ul>
<li>$x_{rc}(t)=\frac{sin(\pi t/T_s)}{\pi t/T_s}\frac{cos(\alpha \pi t/T_s))}{1-4\alpha ^2 t^2 /T_s^2}$</li>
</ul>
</li>
<li>ISI<ul>
<li>$x(nT)=<br>\begin{cases}<br>  1, &amp; n=0 \\<br>  0, &amp; others<br>\end{cases} $</li>
<li>F-domain：$\sum_{m=-\infty}^{+\infty}X(f+\frac{m}{T})=T$</li>
</ul>
</li>
<li>Under a band-limited noiseless channel, the larger the passband, the smoother the signal.<ul>
<li><a href="https://www.lingzhicheng.cn/2021/05/25/Band-limited%20noiseless%20channel/" target="_blank">e.g. Band-limited noiseless channel</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="6-speech-balloon-Digital-transmission-via-carrier-modulation"><a href="#6-speech-balloon-Digital-transmission-via-carrier-modulation" class="headerlink" title="6.:speech_balloon:Digital transmission via carrier modulation"></a>6.<span class="github-emoji"><span>💬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ac.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>Digital transmission via carrier modulation</h2><ul>
<li><p>Carrier amplitude modulation（ASK）</p>
<ul>
<li>In baseband digital PAM, the signal waveforms are：$s<em>m(t)=A</em>{m}g_{T}(t)$</li>
<li>$A_{m}=(2m-1-M)d, m=1,2,…,M$</li>
<li>Multiplied by a sinusoidal carrier：$u<em>m(t)=A</em>{m}g<em>{T}(t)cos(2\pi f</em>{c}t)$</li>
<li>When the pulse shape is rectangular:$x(nT)=<br>\begin{cases}<br>  \sqrt \frac{2}{T}, &amp; 0\leq t\leq T \\<br>  0, &amp; otherwise<br>\end{cases} $</li>
<li>Usually called amplitude shift keying, which is not bandlimited.</li>
</ul>
</li>
<li><p>Carrier phase modulation(PSK)</p>
<ul>
<li>The information is impressed on the phase of the carrier.</li>
<li>The range of the phase：$0\leq \theta \leq 2\pi$</li>
<li>$\theta _{m}=\frac{2\pi m}{M}, m=0,1,…,M-1$</li>
<li>Modulated signal waveform：$u<em>m(t)=Ag</em>{T}(t)cos(2\pi f_{c}t+\frac{2\pi m}{M}), m=0,1,…,M-1$</li>
<li>Usually called phase shift keying.</li>
<li><a href="https://www.lingzhicheng.cn/2021/05/30/ASK%20and%20PSK/" target="_blank">e.g. ASK and PSK</a></li>
</ul>
</li>
<li><p>Quadrature amplitude modulation(QAM)</p>
<ul>
<li>Two quadrature carriers,$sin(2\pi f<em>{c}t)$and$cos(2\pi f</em>{c}t)$</li>
<li>Each is modulated by independent information bits.</li>
<li>$u<em>m(t)=A</em>{mc}g<em>{T}(t)cos(2\pi f</em>{c}t)+A<em>{ms}g</em>{T}(t)sin(2\pi f_{c}t), m=0,1,…,M$</li>
<li>Carried bits per symbol：$log_{2}M$</li>
<li>Can be viewed as a form of combined amplitude and digital-phase modulation.</li>
<li>Rewrite：$u<em>{mn}(t)=A</em>{m}g<em>{T}(t)cos(2\pi f</em>{c}t+\theta _{n}),m=1,2,…,M_1,n=1,2,…,M_2$</li>
<li>This time, carried bits per symbol：$log<em>{2}M</em>{1}+log<em>{2}M</em>{2}$</li>
</ul>
</li>
<li><p>Carrier frequency modulation(FSK)</p>
<ul>
<li>For channel lack of phase stability, digital transmission by frequency modulation can be applied.</li>
<li>M-ary FSK can be used to transmit a block of $k=log_{2}M$ bits per symbol.</li>
<li>$u<em>m(t)=\sqrt{\frac{2E_s}{T}}cos(2\pi f</em>{c}t+2\pi m\Delta ft), m=0,1,…,M-1,0\leq t\leq T$</li>
<li>To guarantee orthogonality, ∆𝒇 is a multiple of 1/2T.</li>
</ul>
</li>
<li><p>Sampling</p>
<ul>
<li>sampling.m</li>
</ul>
<figure class="highlight matlab"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[T,Samp_Sig]</span>=<span class="title">Sampling</span><span class="params">(t,Fs,sig)</span> </span></span><br><span class="line"><span class="comment">%Fucntion Name:Sampling </span></span><br><span class="line"><span class="comment">%Input: T,Fs:sig OutPut:Samp_Sig </span></span><br><span class="line"><span class="comment">%When you call the Function ,u input the time for a symbol,the </span></span><br><span class="line"><span class="comment">%Sampling rate and the source signal,then output the Samplint Signal.</span></span><br><span class="line">Ts=<span class="number">1</span>/Fs;</span><br><span class="line">Sig=sig;</span><br><span class="line">len=<span class="built_in">length</span>(Sig);</span><br><span class="line">T=<span class="number">0</span>:Ts:len*t-Ts;</span><br><span class="line">Samp_Sig=T; </span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">0</span>:<span class="number">1</span>:len<span class="number">-1</span></span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">j</span>=<span class="number">1</span>:<span class="number">1</span>:t/Ts</span><br><span class="line">      Samp_Sig(<span class="built_in">i</span>*t/Ts+<span class="built_in">j</span>)=Sig(<span class="built_in">i</span>+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">end</span>    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="open-file-folder-Source-file-zip"><a href="#open-file-folder-Source-file-zip" class="headerlink" title=":open_file_folder:Source file.zip"></a><span class="github-emoji"><span>📂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><a href="https://www.lingzhicheng.cn/usr/file/Matlab_sort_out_code.zip">Source file.zip</a></h2><!-- markdownlint-disable-file MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Matlab</tag>
      </tags>
  </entry>
  <entry>
    <title>Nunjucks Errors</title>
    <url>/2021/08/26/NunjucksErrors/</url>
    <content><![CDATA[<ul>
<li><span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f565.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
<li>Nunjucks模板标签导致MD文件解析报错的问题:</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">FATAL {</span><br><span class="line">  err: Error [Nunjucks Error]: _posts/mathBasic.md [Line 13, Column 14] expected variable end</span><br><span class="line">      =====               Context Dump               =====</span><br><span class="line">      === (line number probably different from <span class="built_in">source</span>) ===</span><br><span class="line">    8 | &lt;p&gt;<span class="variable">$f</span>’({ {x}&lt;em&gt;{0} })=\underset{\Delta x\to 0}{\mathop{\lim } },\frac{f({ {x}&lt;/em&gt;{0} }+\Delta x)-f({ {x}_{0} })}{\Delta x}$    （1）&lt;/p&gt;</span><br><span class="line">    9 | &lt;p&gt;或者：&lt;/p&gt;</span><br><span class="line">    10 | &lt;p&gt;<span class="variable">$f</span>’({ {x}&lt;em&gt;{0} })=\underset{x\to { {x}&lt;/em&gt;{0} }}{\mathop{\lim } },\frac{f(x)-f({ {x}&lt;em&gt;{0} })}{x-{ {x}&lt;/em&gt;{0} }}$           （2）&lt;/p&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<span id="more"></span>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul>
<li>Markdown文件中有标签与nunjucks模板引擎的标签冲突，比如</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">{{</span><br><span class="line">{{{</span><br><span class="line">}}}    </span><br><span class="line">}}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>这些标签都是模板引擎的，如果Markdown文件中有这些标签，那么在解析的时候就会把Markdown中的标签动态解析</li>
<li>处理方法就是<strong>避免出现这些标签</strong></li>
</ul>
<h3 id="解决方案1"><a href="#解决方案1" class="headerlink" title="解决方案1"></a>解决方案1</h3><ul>
<li>考虑过将在两个标签中增加一个空格来避免冲突，可以成功渲染，本地markdown也可以解析出公式，但hexo上的markdowm无法解析，故建议不要使用，本质上没有完全解决问题。</li>
</ul>
<h3 id="解决方案2"><a href="#解决方案2" class="headerlink" title="解决方案2"></a>解决方案2</h3><p>参考两个Issues</p>
<ul>
<li><a href="https://github.com/hexojs/hexo/issues/2679">hexo genereate faile Template render error: (unknown path) #2679</a></li>
<li><a href="https://github.com/hexojs/hexo/issues/2384">Template render error: (unknown path) #2384</a></li>
</ul>
<p>网上目前很多解决方案都是进行类似如下的替换，需要对所有公式进行替换，量比较大并且治标不治本，暂不采用</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">{% raw %}</span><br><span class="line">{{name}}</span><br><span class="line">{% endraw %}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="解决方案3"><a href="#解决方案3" class="headerlink" title="解决方案3"></a>解决方案3</h3><ul>
<li>直接修改<code>Nunjucks</code>源码</li>
</ul>
<p><code>node_modules/nunjucks/src/lexer.js</code></p>
<figure class="highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lib = <span class="built_in">require</span>(<span class="string">'./lib'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> whitespaceChars = <span class="string">" \n\t\r\xA0"</span>;</span><br><span class="line"><span class="keyword">var</span> delimChars = <span class="string">'()[]{}%*-+~/#,:|.&lt;&gt;=!'</span>;</span><br><span class="line"><span class="keyword">var</span> intChars = <span class="string">'0123456789'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">BLOCK_START</span> = <span class="string">'{%'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">BLOCK_END</span> = <span class="string">'%}'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_START</span> = <span class="string">'{$'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_END</span> = <span class="string">'$}'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">COMMENT_START</span> = <span class="string">'{#'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">COMMENT_END</span> = <span class="string">'#}'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_STRING</span> = <span class="string">'string'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_WHITESPACE</span> = <span class="string">'whitespace'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_DATA</span> = <span class="string">'data'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_BLOCK_START</span> = <span class="string">'block-start'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_BLOCK_END</span> = <span class="string">'block-end'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TOKEN_VARIABLE_START</span> = <span class="string">'variable-start'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>冲突部分：</p>
<figure class="highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_START</span> = <span class="string">'{{'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_END</span> = <span class="string">'}}'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>作如下替换：</p>
<figure class="highlight js"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_START</span> = <span class="string">'{$'</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">VARIABLE_END</span> = <span class="string">'$}'</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>找到定义部分的<code>VARIABLE_START</code>和<code>VARIABLE_END</code>，这次的<code>{{`和`}}</code>错误就是这个导致，上述代码已经将两个变量从<code>{{`改为`{$`，`}}</code>改为<code>$}</code><br>通过直接修改渲染标签，解析的时候就不会和markdown中的复杂公式冲突，并且对所文件都有效，为了防止之后重新<code>npm install</code>的时候还原，所以在这里记录一笔</p>
<h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><p>其他的hexo依赖插件目前还没有发现因为修改<code>Nunjucks</code>源码而出现的问题，例如<code>hexo-generator-searchdb</code>、<code>hexo-generator-sitemap</code>等，有些插件也是依赖于<code>Nunjucks</code>的，如果出现问题，同步修改插件的<code>xml</code>模板文件就可以解决。</p>
<h3 id="Update-2025-04-19"><a href="#Update-2025-04-19" class="headerlink" title="Update 2025.04.19"></a>Update 2025.04.19</h3><blockquote>
<p>果然记一笔是有用的，最近发现全局搜索出了问题，开始排查，果然是改<code>Nunjucks</code>源码引起的。</p>
</blockquote>
<ul>
<li><code>hexo-generator-searchdb</code>插件的模板文件中也有<code>{{`和`}}</code>，所以在搜索的时候会报错，解决方法是将插件中的<code>{{`和`}}</code>作相同的替换，<code>node_modules/hexo-generator-searchdb/templates/search.xml</code>：</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">search</span>&gt;</span></span><br><span class="line">  {%- for article in articles %}</span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>{$ article.title $}<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>{$ article.url $}<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">content</span>&gt;</span>&lt;![CDATA[{$ article.content | safe $}]]&gt;<span class="tag">&lt;/<span class="name">content</span>&gt;</span></span><br><span class="line">    {%- if article.categories %}</span><br><span class="line">      <span class="tag">&lt;<span class="name">categories</span>&gt;</span></span><br><span class="line">        {%- for category in article.categories %}</span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span>&gt;</span>{$ category $}<span class="tag">&lt;/<span class="name">category</span>&gt;</span></span><br><span class="line">        {%- endfor %}</span><br><span class="line">      <span class="tag">&lt;/<span class="name">categories</span>&gt;</span></span><br><span class="line">    {%- endif %}</span><br><span class="line">    {%- if article.tags %}</span><br><span class="line">      <span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">        {%- for tag in article.tags %}</span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>{$ tag $}<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        {%- endfor %}</span><br><span class="line">      <span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">    {%- endif %}</span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  {%- endfor %}</span><br><span class="line"><span class="tag">&lt;/<span class="name">search</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>hexo-generator-sitemap</code>插件的模板文件中也有<code>{{`和`}}</code>，<code>xml</code>文件中的<code>{{`和`}}</code>作相同的替换，<code>node_modules/hexo-generator-sitemap/sitemap.xml</code>：</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">"http://www.sitemaps.org/schemas/sitemap/0.9"</span>&gt;</span></span><br><span class="line">  {% for post in posts %}</span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>{$ post.permalink | uriencode $}<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    {% if post.updated %}</span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>{$ post.updated | formatDate $}<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    {% elif post.date %}</span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>{$ post.date | formatDate $}<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    {% endif %}</span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>monthly<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">priority</span>&gt;</span>0.6<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  {% endfor %}</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>{$ config.url | uriencode $}<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>{$ sNow | formatDate $}<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">priority</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  {% for tag in tags %}</span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>{$ tag.permalink | uriencode $}<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>{$ sNow | formatDate $}<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>weekly<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">priority</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  {% endfor %}</span><br><span class="line"></span><br><span class="line">  {% for cat in categories %}</span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>{$ cat.permalink | uriencode $}<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>{$ sNow | formatDate $}<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>weekly<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">priority</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  {% endfor %}</span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>NunjucksErrors</category>
      </categories>
      <tags>
        <tag>Debug</tag>
      </tags>
  </entry>
  <entry>
    <title>Python unzip split zip</title>
    <url>/2024/08/01/Python%20unzip%20split%20zip/</url>
    <content><![CDATA[<blockquote>
<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>开发中遇到 <code>.0z1, .z02, ..., .zip</code>格式的分卷压缩包需要自动解压，尝试了<code>zipfile</code>和<code>py7zr</code>都不行，后来看了文档说暂时不持支持分卷解压，网络上多数的实现方案是建临时文件然后往里面追加写入，试了不太行，最后采用调命令行执行<code>7z</code>的命令。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-直接上手"><a href="#books-直接上手" class="headerlink" title=":books: 直接上手"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 直接上手</h2><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unzip_split_zip</span>(<span class="params">part_zip_list: <span class="built_in">list</span></span>) -&gt; <span class="type">Union</span>[<span class="built_in">bool</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Unzip the split zip files</span></span><br><span class="line"><span class="string">    :param part_zip_list: List of paths to the split zip files</span></span><br><span class="line"><span class="string">    :return: unzip success or not and the unzip file path</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find the main zip file</span></span><br><span class="line">    main_zip_file = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> part_zip_list:</span><br><span class="line">        <span class="keyword">if</span> file.endswith(<span class="string">'.zip'</span>):</span><br><span class="line">            main_zip_file = file</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> main_zip_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    directory_path = os.path.dirname(main_zip_file)</span><br><span class="line">    pre_name = main_zip_file.rsplit(<span class="string">'.zip'</span>, <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    command = [<span class="string">'7z'</span>, <span class="string">'x'</span>, main_zip_file, <span class="string">f'-o<span class="subst">{directory_path}</span>'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># TODO Python暂无直接支持分卷解压的包，需要本地下载7Zip且添加到系统Path，这里调用命令行执行分卷解压</span></span><br><span class="line">        subprocess.run(command, check=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, pre_name + <span class="string">'.app'</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"An error occurred: <span class="subst">{e.stderr}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"An unexpected error occurred: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot线程池和异步任务</title>
    <url>/2024/04/20/SpringBoot%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<blockquote>
<p>通用的SpringBoot项目下线程池的配置和使用，异步任务的创建和使用等。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-线程池配置"><a href="#books-1-线程池配置" class="headerlink" title=":books: 1. 线程池配置"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1. 线程池配置</h2><h3 id="1-1-参数配置"><a href="#1-1-参数配置" class="headerlink" title="1.1. 参数配置"></a>1.1. 参数配置</h3><ul>
<li><p>resouces/appliccation.yml</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">async:</span></span><br><span class="line"><span class="attr">executor:</span></span><br><span class="line">    <span class="attr">thread:</span></span><br><span class="line">    <span class="attr">keepAliveSeconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">namePrefix:</span> <span class="string">async-service-</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="1-2-开启线程池"><a href="#1-2-开启线程池" class="headerlink" title="1.2. 开启线程池"></a>1.2. 开启线程池</h3><ul>
<li>从运行时拿Cpu核心数，提高可迁移性</li>
<li><code>baseServiceExecutor</code>用拒绝的策略，防止请求过载</li>
<li><code>downloadServiceExecutor</code>用等待的策略，保证所有下载线程都会被执行</li>
<li><p>若有多个线程池，最好定义一些Bean(name = “executorName”)的线程池名字，方便后续使用<code>@Qualifier("executorName")</code>指定线程池</p>
</li>
<li><p>config/ExecutorConfiguration.java</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.xxx.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.PropertySourcesPlaceholderConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "async.executor.thread")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecutorConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">cpuNum</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> corePoolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxPoolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> queueCapacity;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> keepAliveSeconds;</span><br><span class="line">    <span class="keyword">private</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "asyncBaseServiceExecutorConfigurer")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PropertySourcesPlaceholderConfigurer <span class="title function_">propertySourcesPlaceholderConfigurer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PropertySourcesPlaceholderConfigurer</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "asyncBaseServiceExecutor")</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">baseServiceExecutor</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(cpuNum + <span class="number">1</span>);</span><br><span class="line">        executor.setMaxPoolSize((cpuNum + <span class="number">1</span>) * <span class="number">2</span>);</span><br><span class="line">        executor.setQueueCapacity(cpuNum * <span class="number">20</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(keepAliveSeconds);</span><br><span class="line">        executor.setThreadNamePrefix(namePrefix + <span class="string">"base"</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "asyncDownloadServiceExecutor")</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">downloadServiceExecutor</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(cpuNum * <span class="number">2</span>);</span><br><span class="line">        executor.setMaxPoolSize(cpuNum * <span class="number">4</span>);</span><br><span class="line">        executor.setQueueCapacity(cpuNum * <span class="number">20</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(keepAliveSeconds);</span><br><span class="line">        executor.setThreadNamePrefix(namePrefix + <span class="string">"download"</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动类增加支持Async的注解</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>用到线程池的服务接口增加注解，并标记使用哪个线程池</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Async("asyncBaseServiceExecutor")</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>Method annotated with @Async should return 'void' or "Future-like" type</code>，异步调用不能有返回值或者要用带<code>Future</code>的返回，可以用<code>CompletableFuture&lt;T&gt;</code>的结构封装原来的返回类型<code>T</code></li>
</ul>
</li>
</ul>
<h2 id="satellite-2-接口中的异步任务改写"><a href="#satellite-2-接口中的异步任务改写" class="headerlink" title=":satellite: 2. 接口中的异步任务改写"></a><span class="github-emoji"><span>📡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 2. 接口中的异步任务改写</h2><h3 id="2-1-引入线程池和注入"><a href="#2-1-引入线程池和注入" class="headerlink" title="2.1. 引入线程池和注入"></a>2.1. 引入线程池和注入</h3><ul>
<li><p>controller/BaseController.java</p>
  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolTaskExecutor baseServiceExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BaseController</span><span class="params">(XXX xxx, <span class="meta">@Qualifier("asyncBaseServiceExecutor")</span> ThreadPoolTaskExecutor baseServiceExecutor)</span> {</span><br><span class="line">    <span class="built_in">this</span>.xxx = xxx;</span><br><span class="line">    <span class="built_in">this</span>.baseServiceExecutor = baseServiceExecutor;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="2-2-接口内多任务的异步编排"><a href="#2-2-接口内多任务的异步编排" class="headerlink" title="2.2. 接口内多任务的异步编排"></a>2.2. 接口内多任务的异步编排</h3><ul>
<li>接口请求成功马上返回结果，可以是查询的结果也可以是空，根据需求；如果需要返回的是多线程服务的查询，return的Result也要用Future结构封装</li>
<li>执行异步的下载任务，防止阻塞接口的响应</li>
<li><code>CompletableFuture</code>的<code>runasync()</code>和<code>supplyasync()</code>的区别<ul>
<li><code>runasync()</code>方法接收一个<code>Runnable</code>类型的参数，不会返回任何结果</li>
<li><code>supplyasync()</code>方法接收一个<code>Supplier</code>类型的参数，需要返回结果</li>
</ul>
</li>
<li><code>CompletableFuture</code>的<code>thenCompose()</code>和<code>thenApply()</code>的区别<ul>
<li><code>thenCompose()</code>用来连接两个<code>CompletableFuture</code>，是生成一个新的<code>CompletableFuture</code></li>
<li><code>thenApply()</code>转换的是泛型中的类型，是同一个<code>CompletableFuture</code></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping("/******")</span></span><br><span class="line"><span class="keyword">private</span> Result&lt;String&gt; <span class="title function_">listByTime</span><span class="params">(<span class="meta">@RequestParam(required = false)</span> String startTime,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(required = false)</span> String endTime)</span> {</span><br><span class="line">    log.info(<span class="string">"Select all log base by time"</span>);</span><br><span class="line">    <span class="comment">// If the endTime is null, set it to the current time</span></span><br><span class="line">    endTime = Optional.ofNullable(endTime)</span><br><span class="line">                .orElseGet(() -&gt; LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">finalEndTime</span> <span class="operator">=</span> endTime;</span><br><span class="line">    <span class="type">AtomicLong</span> <span class="variable">DownloadNums</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">startCostTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    CompletableFuture.runAsync(() -&gt; {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            List&lt;xxx&gt; logs = BaseService.listByTime(startTime, finalEndTime, pageNum, pageSize).get();</span><br><span class="line">            DownloadNums.getAndAdd(progressService.progressLogsAndInitiateDownloa(logs, startTime, finalEndTime, domainIdMap).get().get());</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            log.error(<span class="string">"Error initiating log download"</span>, e);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="type">long</span> <span class="variable">endCostTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            log.info(<span class="string">"Download finished, total {} files,time cost: {} ms"</span>, DownloadNums, endCostTime - startCostTime);</span><br><span class="line">        }</span><br><span class="line">    }, baseServiceExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">"Download is in progress in the background"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="mag-right-3-并行下载请求"><a href="#mag-right-3-并行下载请求" class="headerlink" title=":mag_right: 3. 并行下载请求"></a><span class="github-emoji"><span>🔎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 3. 并行下载请求</h2><ul>
<li>网络请求下载任务要关注一些异常的捕获，直接抛出将漏掉部分下载内容</li>
<li>为了统计下载任务总数，用了原子类来计数<code>AtomicLong</code>，和使用<code>CountDownLatch</code>统计预估下载总线程数量，再用<code>latch.countDown()</code>和<code>latch.wait()</code>等待所有线程结束统一返回</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.***.***.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.AbstractMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetObject</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolTaskExecutor downloadServiceExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setThreadPoolTaskExecutor</span><span class="params">(<span class="meta">@Qualifier("asyncDownloadServiceExecutor")</span> ThreadPoolTaskExecutor downloadServiceExecutor)</span> {</span><br><span class="line">        GetObject.downloadServiceExecutor = downloadServiceExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(GetObject.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicLong <span class="title function_">figDownload</span><span class="params">(Map&lt;Integer, Set&lt;AbstractMap.SimpleEntry&lt;String, String&gt;&gt;&gt; domainIdFileKeysResponse, String downloadSubName, Map&lt;Integer, String&gt; domainIdMap)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathName</span> <span class="operator">=</span> <span class="string">"D:\\download\\"</span> + downloadSubName + File.separator;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pathName);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">wasSuccessful</span> <span class="operator">=</span> file.mkdirs();</span><br><span class="line">            log.debug(<span class="string">"Create directory {} {}"</span>, pathName, wasSuccessful ? <span class="string">"succeed"</span> : <span class="string">"failed"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">AtomicLong</span> <span class="variable">totalDownloadedFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalTasks</span> <span class="operator">=</span> domainIdFileKeysResponse.values().stream().mapToInt(Set::size).sum();</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(totalTasks);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Integer, Set&lt;AbstractMap.SimpleEntry&lt;String, String&gt;&gt;&gt; entry : domainIdFileKeysResponse.entrySet()) {</span><br><span class="line">                <span class="type">Integer</span> <span class="variable">domainId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                <span class="type">String</span> <span class="variable">domainName</span> <span class="operator">=</span> domainIdMap.get(domainId);</span><br><span class="line">                <span class="type">File</span> <span class="variable">fileDomain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pathName + domainId + domainName + File.separator);</span><br><span class="line">                <span class="keyword">if</span> (!fileDomain.exists()) {</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">wasSuccessful</span> <span class="operator">=</span> fileDomain.mkdirs();</span><br><span class="line">                    log.debug(<span class="string">"Create directory {}{}{} {}"</span>, pathName, domainId, domainName, wasSuccessful ? <span class="string">"succeed"</span> : <span class="string">"failed"</span>);</span><br><span class="line">                }</span><br><span class="line">                Set&lt;AbstractMap.SimpleEntry&lt;String, String&gt;&gt; fileUrlResponses = entry.getValue();</span><br><span class="line">                <span class="keyword">for</span> (AbstractMap.SimpleEntry&lt;String, String&gt; fileUrlResponse : fileUrlResponses) {</span><br><span class="line">                    downloadServiceExecutor.execute(() -&gt; {</span><br><span class="line">                        <span class="type">String</span> <span class="variable">responseData</span> <span class="operator">=</span> fileUrlResponse.getValue();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">fileUrl</span> <span class="operator">=</span> fileUrlResponse.getKey();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">downloadPathPre</span> <span class="operator">=</span> pathName + domainId + domainName + File.separator;</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="comment">// download the picture</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">sha256Name</span> <span class="operator">=</span> ImageDownloader.downloadImgFromUrl(fileUrl, downloadPathPre);</span><br><span class="line">                                <span class="keyword">if</span> (sha256Name != <span class="literal">null</span>) {</span><br><span class="line">                                    JsonDownloader.saveStringAsJson(responseData, downloadPathPre + sha256Name.split(<span class="string">"\\."</span>)[<span class="number">0</span>] + <span class="string">".json"</span>);</span><br><span class="line">                                    totalDownloadedFiles.incrementAndGet();</span><br><span class="line">                                }</span><br><span class="line">                        }   <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                            log.error(<span class="string">"Error Message:{}, URL:{}"</span>, e.getMessage(), fileUrl);</span><br><span class="line">                        } <span class="keyword">catch</span> (NoSuchAlgorithmException e) {</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            latch.countDown();</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            latch.await();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            log.error(<span class="string">"Error occurred: "</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> totalDownloadedFiles;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>SprinBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>腾讯2024暑期实习笔试</title>
    <url>/2024/04/01/TencentTest20240331/</url>
    <content><![CDATA[<ol>
<li>打卡题目，无向图的邻接表，遍历判断</li>
<li>判断分段拼接链表后，是否整段升序</li>
<li>连通图，非连通的图增加一条边恰好连通的方案数</li>
<li>异或前缀和+动态规划</li>
<li>遍历+回溯判断矩阵构成字符串</li>
</ol>
<span id="more"></span>
<hr>
<h2 id="1-题目描述"><a href="#1-题目描述" class="headerlink" title="1. 题目描述"></a>1. 题目描述</h2><p>小红拿到了一个无向图，其中一些边被染成了红色。<br>小红定义一个点是“好点”，当且仅当这个点的所有邻边都是红边。<br>现在请你求出这个无向图“好点”的数量。<br>注：如果一个节点没有任何邻边，那么它也是好点。</p>
<h3 id="1-1-输入描述"><a href="#1-1-输入描述" class="headerlink" title="1.1 输入描述"></a>1.1 输入描述</h3><p>第一行输入两个正整数n,m，代表节点的数量和边的数量。<br>接下来的m行，每行输入两个正整数u,v和一个字符chr，代表节点u和节点v有一条边连接<br>如果 chr 为’R’，代表这条边被染红；’W’代表未被染色。</p>
<h3 id="1-2-输出描述"><a href="#1-2-输出描述" class="headerlink" title="1.2 输出描述"></a>1.2 输出描述</h3><p>$<br>1\leq n,m \leq 10^5<br>1\leq u,v \leq n<br>$</p>
<h3 id="1-3-输入样例"><a href="#1-3-输入样例" class="headerlink" title="1.3 输入样例"></a>1.3 输入样例</h3><h4 id="1-3-1-输入"><a href="#1-3-1-输入" class="headerlink" title="1.3.1 输入"></a>1.3.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4 4</span><br><span class="line">1 2 R</span><br><span class="line">2 3 W</span><br><span class="line">3 4 W</span><br><span class="line">1 4 R</span><br></pre></td></tr></tbody></table></figure>
<h4 id="1-3-2-输出"><a href="#1-3-2-输出" class="headerlink" title="1.3.2 输出"></a>1.3.2 输出</h4><p>一个整数，代表“好点”的数量。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">1</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：只有 1 号节点是好点。</p>
</blockquote>
<h3 id="1-4-解题思路"><a href="#1-4-解题思路" class="headerlink" title="1.4 解题思路"></a>1.4 解题思路</h3><ul>
<li>用一个无向图<code>UndirectedGraph</code>包含节点数量<code>V</code>和一个<code>Edge</code>泛型的<code>LinkedList</code>，遍历输入的边通过<code>addEdge(int src, int dest, boolean colored)</code>在无向图中同时分别存入起始点<code>src</code>和终点<code>dest</code>的边，并且标记是否<code>colored</code></li>
<li>通过<code>countGood()</code>遍历无向图的<code>LinkedList</code>，判断以当前节点为起点或终点的边是否有颜色，同时默认值是<code>true</code>（即无邻边），都无颜色或无邻边则返回<code>true</code>, 即题意的好点</li>
<li>Attention：<code>boolean colored = in.next().equals("R")?true:false;</code>，区分<code>==</code>和<code>.equals()</code></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意类名必须为 Main, 不要有任何 package xxx 信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)) {</span><br><span class="line">            <span class="comment">// 注意 hasNext 和 hasNextLine 的区别</span></span><br><span class="line">            <span class="comment">// 节点数量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="comment">// 边的数量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="comment">//  创建无向图</span></span><br><span class="line">            <span class="type">UndirectedGraph</span> <span class="variable">graph</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UndirectedGraph</span>(n);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">src</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">                <span class="type">int</span> <span class="variable">dest</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">                <span class="comment">// 注意这里要用 equals 方法，不能用 == 比较，因为 next 返回的是 String 对象，== 比较的是引用</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">colored</span> <span class="operator">=</span> in.next().equals(<span class="string">"R"</span>)?<span class="literal">true</span>:<span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// 添加边，注意节点编号从 1 开始，要减 1</span></span><br><span class="line">                graph.addEdge(src-<span class="number">1</span>, dest-<span class="number">1</span>, colored);</span><br><span class="line">            }</span><br><span class="line">            <span class="type">int</span> <span class="variable">goodCount</span> <span class="operator">=</span> graph.countGood();</span><br><span class="line">            System.out.print(goodCount);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Edge</span> {</span><br><span class="line">    <span class="type">int</span> dest;</span><br><span class="line">    <span class="type">boolean</span> colored;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Edge</span><span class="params">(<span class="type">int</span> dest, <span class="type">boolean</span> colored)</span> {</span><br><span class="line">        <span class="built_in">this</span>.dest = dest;</span><br><span class="line">        <span class="built_in">this</span>.colored = colored;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UndirectedGraph</span> {</span><br><span class="line">    <span class="type">int</span> V;</span><br><span class="line">    LinkedList&lt;Edge&gt;[] adjListArray;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UndirectedGraph</span><span class="params">(<span class="type">int</span> V)</span> {</span><br><span class="line">        <span class="built_in">this</span>.V = V;</span><br><span class="line">        <span class="built_in">this</span>.adjListArray = <span class="keyword">new</span> <span class="title class_">LinkedList</span>[V];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; V; i++) {</span><br><span class="line">            adjListArray[i] = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Edge&gt;();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addEdge</span><span class="params">(<span class="type">int</span> src, <span class="type">int</span> dest, <span class="type">boolean</span> colored)</span> {</span><br><span class="line">        <span class="type">Edge</span> <span class="variable">edge1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Edge</span>(dest, colored);</span><br><span class="line">        adjListArray[src].add(edge1);</span><br><span class="line"></span><br><span class="line">        <span class="type">Edge</span> <span class="variable">edge2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Edge</span>(src, colored);</span><br><span class="line">        adjListArray[dest].add(edge2);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">countGood</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> <span class="number">0</span>; v &lt; V; v++){</span><br><span class="line">            <span class="comment">// 没有边的节点也是好节点</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isGood</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(Edge edge: adjListArray[v]){</span><br><span class="line">                <span class="keyword">if</span>(!edge.colored){</span><br><span class="line">                    isGood = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span>(isGood) count++;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-题目描述"><a href="#2-题目描述" class="headerlink" title="2. 题目描述"></a>2. 题目描述</h2><blockquote>
<p>小红拿到了一个链表。她准备将这个链表断裂成两个链表，再拼接到一起，使得链表从头节点到尾部升序。你能帮小红判断能否达成目的吗？<br>给定的为一个链表数组，你需要对于数组中每个链表进行一次“是”或者“否”的答案回答，并返回布尔数组。<br>每个链表的长度不小于 2，且每个链表中不包含两个相等的元素。所有链表的长度之和保证不超过10^5</p>
</blockquote>
<h3 id="2-1-输入样例"><a href="#2-1-输入样例" class="headerlink" title="2.1 输入样例"></a>2.1 输入样例</h3><h4 id="2-1-1-输入"><a href="#2-1-1-输入" class="headerlink" title="2.1.1 输入"></a>2.1.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[{1,2,3},{2,3,1},{3,2,1}]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="2-1-2-输出"><a href="#2-1-2-输出" class="headerlink" title="2.1.2 输出"></a>2.1.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="literal">true</span>,<span class="literal">true</span>,<span class="literal">false</span>]  // 说明：第三个链表无论怎么操作都不满足条件。</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-解题思路"><a href="#2-2-解题思路" class="headerlink" title="2.2 解题思路"></a>2.2 解题思路</h3><ul>
<li>断裂成两端，重新拼接后从头到尾是升序。两种情况：本来就是一段单调增，不断开也升序；两段单调增区间，且不能有重叠区间例如[0, 4], [3, 6]，这样实际上有一段属于递减</li>
<li>用<code>ListNode findMaxNode(ListNode head)</code>找到最大节点<code>maxNode</code>，<code>ListNode rightStart = maxNode.next;</code>找到第二段起始节点，如果<code>maxNode</code>在末尾，则为第一种情况单段单调增，符合题意；判断从<code>rightStart</code>到结尾是否都是单调增，如果是单调增并且<code>end.val&lt;=head.val</code>，则符合题意</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * public class ListNode {</span></span><br><span class="line"><span class="comment"> *   int val;</span></span><br><span class="line"><span class="comment"> *   ListNode next = null;</span></span><br><span class="line"><span class="comment"> *   public ListNode(int val) {</span></span><br><span class="line"><span class="comment"> *     this.val = val;</span></span><br><span class="line"><span class="comment"> *   }</span></span><br><span class="line"><span class="comment"> * }</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lists ListNode类一维数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool布尔型一维数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] canSorted (ListNode[] lists) {</span><br><span class="line">        <span class="comment">// 最大节点左边是升序，最大节点右边是升序；最大节点左边的值0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> lists.length;</span><br><span class="line">        <span class="type">boolean</span>[] ans = <span class="keyword">new</span> <span class="title class_">boolean</span>[len];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) {</span><br><span class="line">            ans[i] = canConcat(lists[i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ListNode <span class="title function_">findMaxNode</span><span class="params">(ListNode head)</span> {</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">maxNode</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (current.val &gt; maxNode.val) {</span><br><span class="line">                maxNode = current;</span><br><span class="line">            }</span><br><span class="line">            current = current.next;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> maxNode;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ListNode <span class="title function_">findEndOfUp</span><span class="params">(ListNode start, ListNode end)</span> {</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="comment">// 不用判断最后一个，因为已经没有了下一个节点了，此时的current已经是end</span></span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">null</span> &amp;&amp; current.next != end) {</span><br><span class="line">            <span class="keyword">if</span> (current.val &gt; current.next.val)</span><br><span class="line">                <span class="keyword">return</span> current;</span><br><span class="line">            current = current.next;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isUpping</span><span class="params">(ListNode start, ListNode end)</span> {</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">while</span> (current != end &amp;&amp; current.next!= end) {</span><br><span class="line">            <span class="keyword">if</span> (current.val &gt; current.next.val) {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">            current = current.next;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">canConcat</span><span class="params">(ListNode head)</span>{</span><br><span class="line">        <span class="comment">//  找到最大节点，是第一个升序序列的最后一个节点</span></span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">maxNode</span> <span class="operator">=</span> findMaxNode(head);</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">rightStart</span> <span class="operator">=</span> maxNode.next;</span><br><span class="line">        <span class="comment">// 如果最大节点是最后一个节点即rightStart是null，那么整个链表是升序的</span></span><br><span class="line">        <span class="keyword">if</span>(rightStart == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">rightEnd</span> <span class="operator">=</span> findEndOfUp(rightStart, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 确保右段序列是升序到结尾的；以及右段的最后一个小于左段的最小值</span></span><br><span class="line">        <span class="comment">// return isUpping(head,leftEnd) &amp;&amp; isUpping(rightStart,null) &amp;&amp; (rightStart.val&lt;head.val);</span></span><br><span class="line">        <span class="comment">// return isUpping(rightStart,null) &amp;&amp; (rightStart.val&lt;head.val);3</span></span><br><span class="line">        <span class="keyword">return</span> isUpping(rightStart,<span class="literal">null</span>) &amp;&amp; (rightEnd.val&lt;head.val);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-题目描述"><a href="#3-题目描述" class="headerlink" title="3. 题目描述"></a>3. 题目描述</h2><p>小红拿到了一个有 n 个节点的无向图，这个图初始并不是连通图。<br>现在小红想知道，添加恰好一条边使得这个图连通，有多少种不同的加边方案？</p>
<h3 id="3-1-输入描述"><a href="#3-1-输入描述" class="headerlink" title="3.1 输入描述"></a>3.1 输入描述</h3><p>第一行输入两个正整数n，m，用空格隔开。<br>接下来的m行，每行输入两个正整数u，v，代表节点u和节点v之间有一条边连接。<br>$1\leq n,m \leq 10^5$<br>$1\leq u,v \leq n$<br>保证给出的图是不连通的。</p>
<h3 id="3-2-输出描述"><a href="#3-2-输出描述" class="headerlink" title="3.2 输出描述"></a>3.2 输出描述</h3><p>一个整数，代表加边的方案数。</p>
<h3 id="3-3-输入样例1"><a href="#3-3-输入样例1" class="headerlink" title="3.3 输入样例1"></a>3.3 输入样例1</h3><h4 id="3-3-1-输入"><a href="#3-3-1-输入" class="headerlink" title="3.3.1 输入"></a>3.3.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4 2</span><br><span class="line">1 2</span><br><span class="line">3 4</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-3-2-输出"><a href="#3-3-2-输出" class="headerlink" title="3.3.2 输出"></a>3.3.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：添加边 (1,3) 或者 (1,4) 或者 (2,3) 或者 (2,4) 都是可以的。</p>
</blockquote>
<h3 id="3-4-输入样例2"><a href="#3-4-输入样例2" class="headerlink" title="3.4 输入样例2"></a>3.4 输入样例2</h3><h4 id="3-4-1-输入"><a href="#3-4-1-输入" class="headerlink" title="3.4.1 输入"></a>3.4.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4 1</span><br><span class="line">1 3</span><br></pre></td></tr></tbody></table></figure>
<h4 id="3-4-2-输出"><a href="#3-4-2-输出" class="headerlink" title="3.4.2 输出"></a>3.4.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">0</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-5-解题思路"><a href="#3-5-解题思路" class="headerlink" title="3.5 解题思路"></a>3.5 解题思路</h3><ul>
<li>DFS深度优先搜索+连通图概念</li>
<li>先用<code>List&lt;List&lt;Integer&gt;&gt;</code>保存各邻边的节点信息</li>
<li>再用DFS从第一个结点开始搜索，遍历过的全用<code>boolean[] visited</code>标记，记录遍历过的节点数，直到DFS停止，记录当前连通块内含有的节点数；遍历下一个连通块</li>
<li><em>两个连通块，返回各块数量相乘；两个以上连通块，不能用增加一条边的方式连接，返回0</em></li>
</ul>
<blockquote>
<p>说明：无论添加哪条边，都不可能使得该图变成连通图。</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意类名必须为 Main, 不要有任何 package xxx 信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">static</span> List&lt;List&lt;Integer&gt;&gt; graph  = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 算有几个连通块：两个连通块，返回各块数量相乘；两个以上连通块，不能用增加一条边的方式连接，返回0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="comment">// 节点个数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="comment">// 边的个数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="comment">//  创建邻接表</span></span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; graph = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            <span class="comment">// 初始化邻接表</span></span><br><span class="line">            graph.add(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">src</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">dest</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            graph.get(src-<span class="number">1</span>).add(dest-<span class="number">1</span>);</span><br><span class="line">            graph.get(dest-<span class="number">1</span>).add(src-<span class="number">1</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 计算连通块中节点的数量  </span></span><br><span class="line">        List&lt;Integer&gt; connectedComponentSizes = calculateConnectedComponentSizes(graph);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 结果  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (connectedComponentSizes.size() == <span class="number">2</span>) {  </span><br><span class="line">            result=connectedComponentSizes.get(<span class="number">0</span>) * connectedComponentSizes.get(<span class="number">1</span>);  </span><br><span class="line">        }   </span><br><span class="line">        System.out.println(result); </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">calculateConnectedComponentSizes</span><span class="params">(List&lt;List&lt;Integer&gt;&gt; graph)</span> {</span><br><span class="line">        <span class="comment">// 记录各节点是否被访问过，默认为 false</span></span><br><span class="line">        <span class="type">boolean</span>[] visited = <span class="keyword">new</span> <span class="title class_">boolean</span>[graph.size()];  </span><br><span class="line">        List&lt;Integer&gt; connectedComponentSizes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; graph.size(); i++) {</span><br><span class="line">            <span class="comment">// 如果节点没有被访问过，进行深度优先搜索</span></span><br><span class="line">            <span class="keyword">if</span> (!visited[i]) {</span><br><span class="line">                <span class="comment">// 计算连通块中节点的数量，加入到结果中</span></span><br><span class="line">                connectedComponentSizes.add(dfs(i, visited, graph));</span><br><span class="line">            }  </span><br><span class="line">        }  </span><br><span class="line">        <span class="keyword">return</span> connectedComponentSizes;  </span><br><span class="line">    }  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> node, <span class="type">boolean</span>[] visited, List&lt;List&lt;Integer&gt;&gt; graph)</span> {</span><br><span class="line">        <span class="comment">// 标记当前节点已经被访问</span></span><br><span class="line">        visited[node] = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 当前连通块的节点数量为1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 遍历当前节点的边</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> neighbor : graph.get(node)) {</span><br><span class="line">            <span class="comment">// 如果邻接节点没有被访问过，递归访问</span></span><br><span class="line">            <span class="keyword">if</span> (!visited[neighbor]) {  </span><br><span class="line">                size += dfs(neighbor, visited, graph);  </span><br><span class="line">            }  </span><br><span class="line">        }  </span><br><span class="line">        <span class="keyword">return</span> size;  </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-题目描述"><a href="#4-题目描述" class="headerlink" title="4. 题目描述"></a>4. 题目描述</h2><p>小红拿到了一个数组，她准备将数组分割成 k 段，使得每段内部做按位异或后，再全部求和。小红希望最终这个和尽可能大，你能帮帮她吗？</p>
<h3 id="4-1-输入描述"><a href="#4-1-输入描述" class="headerlink" title="4.1 输入描述"></a>4.1 输入描述</h3><p>输入包含两行。<br>第一行两个正整数 $n, k , (1\leq k \leq n \leq 400)$，分别表示数组的长度和要分的段数。<br>第二行 n 个整数 $a_i (0 \leq a_i \leq 10^9)$，表示数组 a 的元素。</p>
<h3 id="4-2-输出描述"><a href="#4-2-输出描述" class="headerlink" title="4.2 输出描述"></a>4.2 输出描述</h3><p>输出一个正整数，表示最终的最大和。</p>
<h3 id="4-3-输入样例1"><a href="#4-3-输入样例1" class="headerlink" title="4.3 输入样例1"></a>4.3 输入样例1</h3><h4 id="4-3-1-输入"><a href="#4-3-1-输入" class="headerlink" title="4.3.1 输入"></a>4.3.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">6 2</span><br><span class="line">1 1 1 2 3 4</span><br></pre></td></tr></tbody></table></figure>
<h4 id="4-3-2-输出"><a href="#4-3-2-输出" class="headerlink" title="4.3.2 输出"></a>4.3.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">10</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明<br>小红将数组分为了：<br>[1, 4] 和 [5, 6] 这两个区间，得分分别为：$1 \oplus 1 \oplus 1 \oplus 2 = 3 $和 $3 \oplus 4 = 7$。总得分为 3+7=10。<br>可以证明不存在比 10 更优的分割方案。<br>注：\oplus 符号表示异或操作。</p>
</blockquote>
<h3 id="4-4-输入样例2"><a href="#4-4-输入样例2" class="headerlink" title="4.4 输入样例2"></a>4.4 输入样例2</h3><h4 id="4-4-1-输入"><a href="#4-4-1-输入" class="headerlink" title="4.4.1 输入"></a>4.4.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">5 3</span><br><span class="line">1 0 1 1 0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="4-4-2-输出"><a href="#4-4-2-输出" class="headerlink" title="4.4.2 输出"></a>4.4.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">3</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-5-输入样例3"><a href="#4-5-输入样例3" class="headerlink" title="4.5 输入样例3"></a>4.5 输入样例3</h3><h4 id="4-5-1-输入"><a href="#4-5-1-输入" class="headerlink" title="4.5.1 输入"></a>4.5.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">3 3</span><br><span class="line">1 1 2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="4-5-2-输出"><a href="#4-5-2-输出" class="headerlink" title="4.5.2 输出"></a>4.5.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-6-解题思路"><a href="#4-6-解题思路" class="headerlink" title="4.6 解题思路"></a>4.6 解题思路</h3><ul>
<li>动态规划，递推公式：<code>dp[i][j] = max(dp[l-1][j-1] + preXor[l][i]) 1&lt;=l&lt;=i</code></li>
<li>当i和j都已经确定的时候，遍历当前分段点，前<code>l</code>个点分<code>j-i</code>段+后续数组组成一段的最大值</li>
<li><code>preXor[i][j]</code>是从当前点<code>i</code>到点<code>j</code>一直进行异或运算</li>
<li>DP初始化：每次都从最小开始，<code>dp[i][j] = Integer.MIN_VALUE;</code></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="type">int</span>[] nums = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) </span><br><span class="line">            nums[i] = in.nextInt();</span><br><span class="line">        <span class="type">int</span>[][] dp = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>][k+<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span>[][] preXor = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// preXor[i][j]表示从i到j的异或结果</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n+<span class="number">1</span>; i++){</span><br><span class="line">            preXor[i][i] =nums[i-<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i+<span class="number">1</span>; j &lt; n+<span class="number">1</span>; j++){</span><br><span class="line">                preXor[i][j] = preXor[i][j-<span class="number">1</span>] ^ nums[j-<span class="number">1</span>];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// dp[i][j]表示前i个数分成j段的最大异或和</span></span><br><span class="line">        <span class="comment">// 递推公式：dp[i][j] = max(dp[l-1][j-1] + preXor[l][i]) 1&lt;=l&lt;=i</span></span><br><span class="line">        <span class="comment">//  l表示分段点，dp[l-1][j-1]表示前l-1个数分成j-1段的最大异或和</span></span><br><span class="line">        <span class="comment">//  preXor[l][i]表示从l到i的异或结果</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n+<span class="number">1</span>; i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; k+<span class="number">1</span>; j++){</span><br><span class="line">                dp[i][j] = Integer.MIN_VALUE;</span><br><span class="line">                <span class="comment">// 遍历所有可能的分段点</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">1</span>; l &lt; i+<span class="number">1</span>; l++){</span><br><span class="line">                    dp[i][j] = Math.max(dp[i][j], dp[l-<span class="number">1</span>][j-<span class="number">1</span>] + preXor[l][i]);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        System.out.println(dp[n][k]);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-题目描述"><a href="#5-题目描述" class="headerlink" title="5. 题目描述"></a>5. 题目描述</h2><p>小红拿到了一个字符矩阵，她可以从任意一个地方出发，希望走 6 步后恰好形成”tencent”字符串。小红想知道，共有多少种不同的行走方案？</p>
<blockquote>
<p>注：每一步可以选择上、下、左、右中任意一个方向进行行走。不可行走到矩阵外部。</p>
</blockquote>
<h3 id="5-1-输入描述"><a href="#5-1-输入描述" class="headerlink" title="5.1 输入描述"></a>5.1 输入描述</h3><p>第一行输入两个正整数n,m，代表矩阵的行数和列数。<br>接下来的n行，每行输入一个长度为m的、仅由小写字母组成的字符串，代表小红拿到的矩阵。<br>$ 1\leq n,m \leq 1000 $</p>
<h3 id="5-2-输出描述"><a href="#5-2-输出描述" class="headerlink" title="5.2 输出描述"></a>5.2 输出描述</h3><p>一个整数，代表最终合法的方案数。</p>
<h3 id="5-3-输入样例"><a href="#5-3-输入样例" class="headerlink" title="5.3 输入样例"></a>5.3 输入样例</h3><h4 id="5-3-1-输入"><a href="#5-3-1-输入" class="headerlink" title="5.3.1 输入"></a>5.3.1 输入</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">3 3</span><br><span class="line">ten</span><br><span class="line">nec</span><br><span class="line">ten</span><br></pre></td></tr></tbody></table></figure>
<h4 id="5-3-2-输出"><a href="#5-3-2-输出" class="headerlink" title="5.3.2 输出"></a>5.3.2 输出</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">4</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>说明：<br>第一个方案，从左上角出发，右右下左左上。<br>第二个方案，从左上角出发，右右下左左下。<br>第三个方案，从左下角出发，右右上左左下。<br>第四个方案，从左上角出发，右右上左左上。</p>
</blockquote>
<h3 id="5-4-解题思路"><a href="#5-4-解题思路" class="headerlink" title="5.4 解题思路"></a>5.4 解题思路</h3><ul>
<li>先存到二维数组：<code>map[i] = in.next().toCharArray();</code></li>
<li>静态变量<code>int[][] directions</code>用于定义上下左右移动</li>
<li>遍历二维数组，也就是从每个点开始，拼接当前字符，再对四个方向进行遍历回溯</li>
<li>达到长度判定是否等于<code>"tencent"</code>，是则加一不是则返回</li>
<li>attention：要设置临时变量用于恢复字符串，每个方向返回后都需要恢复</li>
<li>考虑剪枝：第一个字符是<code>t</code>等</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意类名必须为 Main, 不要有任何 package xxx 信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] directions = {{<span class="number">0</span>, <span class="number">1</span>}, {<span class="number">0</span>, -<span class="number">1</span>}, {<span class="number">1</span>, <span class="number">0</span>}, {-<span class="number">1</span>, <span class="number">0</span>}};</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="type">char</span>[][] map = <span class="keyword">new</span> <span class="title class_">char</span>[n][m];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            map[i] = in.next().toCharArray();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; m; j++){</span><br><span class="line">                backTrack(i, j, map, String.valueOf(map[i][j]));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        System.out.print(result);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">backTrack</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">char</span>[][] map, String str)</span>{</span><br><span class="line">        <span class="keyword">if</span> (str.length()==<span class="number">7</span>) {</span><br><span class="line">            <span class="keyword">if</span> (str.equals(<span class="string">"tencent"</span>)) {</span><br><span class="line">                result++;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span>[] direction : directions){</span><br><span class="line">            <span class="type">int</span> <span class="variable">newI</span> <span class="operator">=</span> i + direction[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">newJ</span> <span class="operator">=</span> j + direction[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(newI &gt;= <span class="number">0</span> &amp;&amp; newI &lt; map.length &amp;&amp; newJ &gt;= <span class="number">0</span> &amp;&amp; newJ &lt; map[<span class="number">0</span>].length){</span><br><span class="line">                <span class="comment">// 要暂存当前的 str, 递归返回后要恢复</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> str;</span><br><span class="line">                str += map[newI][newJ];</span><br><span class="line">                backTrack(newI, newJ, map, str);</span><br><span class="line">                str = temp;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>LinkedList</tag>
        <tag>UndirectedGraph</tag>
        <tag>BackTrack</tag>
      </tags>
  </entry>
  <entry>
    <title>Installation for TexLive under VsCode</title>
    <url>/2023/03/27/TexLive+VsCode/</url>
    <content><![CDATA[<blockquote>
<p>Okey, let’s go! I used to use <code>VsCode</code> + <code>TexLive</code>, which is more convenient, because <code>VsCode</code> has a built-in <code>LaTeX Workshop</code> extension, which can be used directly after installation. </p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-Forwards"><a href="#books-1-Forwards" class="headerlink" title=":books: 1.Forwards"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1.Forwards</h2><ul>
<li><p>$ LaTeX $ is widely used in <strong>academia</strong> for the communication and publication of scientific documents in many fields, including <strong>mathematics, computer science, engineering, physics, chemistry, economics, linguistics, quantitative psychology, philosophy, and political science</strong>. It also has a prominent role in the preparation and publication of books and articles that contain complex multilingual materials, such as Arabic and Greek. LaTeX uses the TeX typesetting program for formatting its output, and is itself written in the <strong>$TeX$ macro language</strong>.</p>
</li>
<li><p>$ LaTeX $ can be used as <strong>a standalone document preparation system</strong>, or as <strong>an intermediate format</strong>. In the latter role, for example, it is sometimes used as part of a pipeline for translating <code>DocBook</code> and <code>other XML-based formats</code> to <code>PDF</code>. The typesetting system offers programmable desktop publishing features and extensive facilities for automating most aspects of typesetting and desktop publishing, including <strong>numbering and cross-referencing of tables and figures, chapter and section headings, graphics, page layout, indexing and bibliographies</strong>.</p>
</li>
<li><p>Without further ado, let’s go directly to the picture!<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/tex_example.jpg" alt="Tex example"></p>
</li>
</ul>
<h2 id="pushpin-2-VsCode-installation-and-language-configuration"><a href="#pushpin-2-VsCode-installation-and-language-configuration" class="headerlink" title=":pushpin: 2.VsCode installation and language configuration"></a><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 2.VsCode installation and language configuration</h2><blockquote>
<p>By default, everyone can install vscode and be familiar with the basic operations, so I won’t repeat it here. If you don’t know how to install it, you can refer to the <a href="https://code.visualstudio.com/"> official website</a>, only list a few points here.</p>
</blockquote>
<ol>
<li>Pay attention to modifying the <strong>installation path</strong>, because more <strong>plug-ins</strong> may be installed later (not only $LaTeX$, but also other scenarios).</li>
<li>For convenience, it is recommended to create a desktop shortcut, and add the “Open with Code” action to the Windows Explorer file context menu, and add it to the <code>PATH</code>.</li>
<li>如果你需要改为中文环境<span class="github-emoji"><span>🇨🇳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1e8-1f1f3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，可以安装中文插件，可以在左边栏的拓展中搜索<a href="https://code.visualstudio.com/docs/getstarted/locales">Chinese (Simplified) Language Pack for Visual Studio Code</a>.</li>
</ol>
<h2 id="file-folder-3-TexLive-Download-and-Installation"><a href="#file-folder-3-TexLive-Download-and-Installation" class="headerlink" title=":file_folder: 3.TexLive Download and Installation"></a><span class="github-emoji"><span>📁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 3.TexLive Download and Installation</h2><blockquote>
<p><code>TexLive</code> is used here, if you want to use <code>MikTex</code> or others, you can refer to other articles.</p>
</blockquote>
<ul>
<li><p>Install TexLive via <a href="https://tug.org/texlive/acquire-iso.html">ISO image</a>, you can choose download from a nearby CTAN mirror or manually choose CTAN mirror.<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/ISO_image.jpg" alt="ISO image"></p>
</li>
<li><p><span class="github-emoji"><span>💿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> You can choose a <strong>suitable mirror</strong> to download according to your network status. If the download speed is too <em>slow</em>, you can try to choose a mirror station that is closer to download. It may take about ten minutes.</p>
<ul>
<li>This directory contains the ISO image for the official TeX Live release; md5 and sha512 checksums are provided, and the sha checksum is GPG-signed. The generic names (texliveYYYY.iso and texlive.iso) are symlinks to the dated release .iso.</li>
<li>If you have problems with installation or running TeX after installation, please check your environment variables: settings, including PATH, that end up referencing previously-installed TeX systems (TeX Live or otherwise), can cause trouble, especially on Windows.</li>
</ul>
</li>
<li><p><span class="github-emoji"><span>📋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Wait for the download to complete, open the ISO file, and open the batch file <code>install-tl-windows.bat</code> as an administrator.</p>
<ul>
<li>If you are using Windows 10 or 11, you can right-click the ISO file and select “Mount” to mount the ISO file as a virtual disk. Then you can open the batch file as an administrator.</li>
<li>If you are using Windows 7, you can use the <a href="https://www.7-zip.org/">7-Zip</a> software to open the ISO file, and then open the batch file as an administrator.<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/open_ISO.jpg" alt="Open ISO"></li>
</ul>
</li>
<li><p>Then it <em>freezes</em> for a while, which is normal, and the GUI for installation appears.</p>
<div align="center">
<img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/installer_gui.jpg" alt="installer gui" width="30%" height="30%" text-align:center="">
</div>
</li>
<li><p><span class="github-emoji"><span>🔧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f527.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Modify the installation path, usually <code>Disk:/texlive/year</code>, such as<code>D:/texlive/2023</code>, and then click <code>Install</code>. It may take a while, depending on your computer performance, so take a break with a cup of coffee.</p>
</li>
<li><p>There is an Advanced option. Generally speaking, after changing <code>TEXDIR</code>, the <code>TEXMFLOCAL</code> path will also be modified. If you are not familiar with other options, don’t to modify them (especially for novices).</p>
</li>
<li><p><span class="github-emoji"><span>✅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> After the installation is complete, click <code>Finish</code> to exit the installation interface.</p>
<div align="center">
<img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/close_gui.jpg" alt="close gui" width="50%" height="50%" text-align:center="">
</div>
</li>
<li><p>Check if the installation is successful. Use <code>xelatex -v</code> in <em>CMD</em>.<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/installation_success.jpg" alt="Installation successfully"></p>
</li>
</ul>
<h2 id="hammer-4-Extension-installation-and-environment-settings"><a href="#hammer-4-Extension-installation-and-environment-settings" class="headerlink" title=":hammer: 4. Extension installation and environment settings"></a><span class="github-emoji"><span>🔨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f528.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4. Extension installation and environment settings</h2><h3 id="nut-and-bolt-4-1-Install-LaTex-Workshop-extension-in-Vscode"><a href="#nut-and-bolt-4-1-Install-LaTex-Workshop-extension-in-Vscode" class="headerlink" title=":nut_and_bolt: 4.1 Install LaTex Workshop extension in Vscode."></a><span class="github-emoji"><span>🔩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f529.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4.1 Install <code>LaTex Workshop</code> extension in Vscode.</h3><ul>
<li>Open the Extensions sidebar in VS Code. <code>View → Extensions</code> or <code>Ctrl+Shift+X</code>.</li>
<li>Search for <code>LaTeX Workshop</code>.</li>
<li>Click Install. It will be installed into the <code>~/.vscode/extensions</code> directory.</li>
<li><p>Reload VS Code after installation.<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/install_latex_workshop.jpg" alt="Install LaTex Workshop"></p>
</li>
<li><p>If your <code>Tex Live</code> version is relatively old, additional manual configuration of environment variables may be required.</p>
</li>
</ul>
<h3 id="bookmark-tabs-4-2-Environment-settings"><a href="#bookmark-tabs-4-2-Environment-settings" class="headerlink" title=":bookmark_tabs: 4.2 Environment settings"></a><span class="github-emoji"><span>📑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4.2 Environment settings</h3><ul>
<li>There are two environment configuration schemes in Vscode, one is to use buttons and option settings directly, and the other is to use <code>json</code> to set.<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/workshop_setting_1.jpg" alt="workshop_setting"></li>
<li>Click <code>Open settings (JSON)</code> in the upper right corner to use the code settings.<em><a href="https://www.json.org/json-en.html">JSON</a> is a lightweight text data format with a certain structure. If you are not familiar with it, you can spend a few minutes to understand it.</em></li>
<li><strong>Add</strong> the following settings after other settings.</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.autoBuild.run"</span><span class="punctuation">:</span> <span class="string">"never"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.showContextMenu"</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.intellisense.package.enabled"</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.message.error.show"</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.message.warning.show"</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-pdf"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.recipes"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"XeLaTeX"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"xelatex"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"PDFLaTeX"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"pdflatex"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"BibTeX"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"bibtex"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"LaTeXmk"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex -&gt; bibtex -&gt; xelatex*2"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"xelatex"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex -&gt; bibtex -&gt; pdflatex*2"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"pdflatex"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.clean.fileTypes"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">"*.aux"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.bbl"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.blg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.idx"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.ind"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.lof"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.lot"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.out"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.toc"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.acn"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.acr"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.alg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.glg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.glo"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.gls"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.ist"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.fls"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.log"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"*.fdb_latexmk"</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.autoClean.run"</span><span class="punctuation">:</span> <span class="string">"onFailed"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.latex.recipe.default"</span><span class="punctuation">:</span> <span class="string">"lastUsed"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.internal.synctex.keybinding"</span><span class="punctuation">:</span> <span class="string">"double-click"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="black-nib-4-3-Detailed-introduction-of-environment-configuration-parameters"><a href="#black-nib-4-3-Detailed-introduction-of-environment-configuration-parameters" class="headerlink" title=":black_nib: 4.3 Detailed introduction of environment configuration parameters"></a><span class="github-emoji"><span>✒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2712.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4.3 Detailed introduction of environment configuration parameters</h3><blockquote>
<p>If you don’t want to read it, you can just skip it, it’s not that important.</p>
</blockquote>
<ol>
<li>Set when to automatically build <code>LaTeX</code> using the default (first) compilation chain.<ol>
<li><code>onSave</code> builds the project upon saving a tex file in vscode.</li>
<li><code>onFileChange</code> builds the project upon detecting a file change in any of the dependencies, even modified by other applications.</li>
</ol>
</li>
</ol>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"latex-workshop.latex.autoBuild.run"</span><span class="punctuation">:</span> <span class="string">"never"</span></span><br></pre></td></tr></tbody></table></figure>
<ol>
<li>Enable contextual LaTeX menu: Right click will have <strong>two more options</strong>, more convenient.<ol>
<li>Default: <code>false</code></li>
<li><code>true</code> enables the menu.</li>
<li><code>Build LaTex project.</code> <em>(Ctrl+Alt+B)</em></li>
<li><code>SyncTex from cursor.</code> <em>(Ctrl+Alt+J)</em></li>
</ol>
</li>
</ol>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"latex-workshop.showContextMenu"</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br></pre></td></tr></tbody></table></figure>
<ol>
<li><code>"latex-workshop.intellisense.package.enabled": true</code> enables the package name completion in the <code>\usepackage{}</code> command.</li>
<li><code>"latex-workshop.message.error.show": true</code> shows the error message in the status bar.</li>
<li><code>"latex-workshop.message.warning.show": true</code> shows the warning message in the status bar.</li>
<li><code>"latex-workshop.latex.tools":[...]</code> defines default settings for the compilation.</li>
<li><code>"latex-workshop.latex.recipes": [...]</code> defines default settings and compilation order for the recipe compilation chains:<ol>
<li>Recipe: XeLaTex</li>
<li>Recipe: PDFLaTex</li>
<li>Recipe: BibTeX</li>
<li>Recipe: LaTeXmk</li>
<li>Recipe: xelatex -&gt; bibtex -&gt; xelatex*2</li>
<li>Recipe: pdflatex -&gt; bibtex -&gt; pdflatex*2</li>
</ol>
</li>
<li>Difference between XeLaTex and PDFLaTex:<ol>
<li><strong>PDFLaTeX uses TeX standard fonts</strong>, so when generating PDF, all non-TeX standard fonts will be replaced, and the generated PDF files will embed all fonts by default; and compiled with XeLaTeX, if there are many pictures or other elements in the paper If no fonts are embedded, the generated PDF.</li>
<li><strong>The XeTeX corresponding to XeLaTeX has better support for fonts</strong>, allows users to use operating system fonts instead of TeX’s standard fonts, and has better support for non-Latin fonts.</li>
<li><strong>PDFLaTeX compiles faster</strong> than XeLaTeX.</li>
</ol>
</li>
<li><code>"latex-workshop.latex.clean.fileTypes"</code> It is to clear some unnecessary files in the result generated during the compilation process.</li>
<li><code>"latex-workshop.latex.autoClean.run"</code><ol>
<li><code>onFailed</code> cleans the project when compilation fails.</li>
<li><code>onBuilt</code> cleans the project when compilation is done, whether successful or failed.</li>
</ol>
</li>
<li><code>"latex-workshop.latex.recipe.default": "lastUsed"</code> sets the default compilation chain to the last used one. Get used to using the compiled chain you used last time, or you can change it to first to use the first compiled chain.</li>
<li><code>"latex-workshop.view.pdf.internal.synctex.keybinding": "double-click"</code> sets the default key binding for the SyncTex function. The default is double-click, and you can also set it to <code>ctrl+alt+j</code> or <code>ctrl+alt+click</code>.</li>
</ol>
<h2 id="notebook-5-SumatraPDF"><a href="#notebook-5-SumatraPDF" class="headerlink" title=":notebook: 5. SumatraPDF"></a><span class="github-emoji"><span>📓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 5. SumatraPDF</h2><blockquote>
<p>Vscode’s built-in PDF reading cannot fully satisfy large-scale use, and an external reader must be used if necessary. It is recommended to use the combination of <code>SumatraPDF</code> and $Tex$, mainly because it can be synchronized in two directions, and it is also relatively lightweight.</p>
</blockquote>
<ul>
<li><p><a href="https://www.sumatrapdfreader.org/download-free-pdf-viewer">Official download link</a></p>
</li>
<li><p>Add settings in <code>settings.json</code>. <em>Pay attention to modify the three paths below.</em></p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.viewer"</span><span class="punctuation">:</span> <span class="string">"external"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.ref.viewer"</span><span class="punctuation">:</span><span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.external.viewer.command"</span><span class="punctuation">:</span> <span class="string">"D:/SumatraPDF/SumatraPDF.exe"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.external.viewer.args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">"%PDF%"</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.external.synctex.command"</span><span class="punctuation">:</span> <span class="string">"D:/SumatraPDF/SumatraPDF.exe"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"latex-workshop.view.pdf.external.synctex.args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">"-forward-search"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"%TEX%"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"%LINE%"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"-reuse-instance"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"-inverse-search"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"code \"D:/VSCode/resources/app/out/cli.js\" -r -g \"%f:%l\""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">"%PDF%"</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>"latex-workshop.view.pdf.viewer": "external"</code> If you need to change the Tex PDF back to the internal reader, just change <code>external</code> to <code>tab</code>.</p>
</li>
</ul>
<!-- markdownlint-disable-file MD025 MD028 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Latex</tag>
        <tag>VSCode</tag>
      </tags>
  </entry>
  <entry>
    <title>Skills for TexLive under VsCode</title>
    <url>/2023/07/12/TexSkills/</url>
    <content><![CDATA[<blockquote>
<p>Record some $ LaTeX $ packages and installation and usage skills.</p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-Packages"><a href="#books-1-Packages" class="headerlink" title=":books: 1. Packages"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1. Packages</h2><h3 id="1-1-Packages-for-Code-minted"><a href="#1-1-Packages-for-Code-minted" class="headerlink" title="1.1. Packages for Code: minted"></a>1.1. Packages for Code: <code>minted</code></h3><ul>
<li>import package <code>minted</code> for code highlighting.</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>{minted}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Before using <code>minted</code>, you should have <code>python version&gt;2.7</code> and install <code>pygments</code> first.</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">python -V</span><br><span class="line"></span><br><span class="line">pip install pygments</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>It may be show error message</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">You must invoke LaTeX with the -shell-escape flag`. </span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>The reason is that the <code>minted</code> package needs to call the <code>pygments</code> package to highlight the code, and the <code>pygments</code> package needs to call the system command. The <code>-shell-escape</code> parameter is used to allow the <code>minted</code> package to call the system command.</li>
<li>It’s necessary to add <code>-shell-escape</code> parameter to the setting file, the following json file is a part of it.</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"latex-workshop.latex.tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"--shell-escape"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"--shell-escape"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"--shell-escape"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-pdf"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Then it may also show error message</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">You must have `pygmentize<span class="string">' installed to use this package.</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>This is because you installed <code>pygments</code> failed or the <code>pygments</code> package is not in the system path. In windows 10 or later versions, there is a inside python version in <code>Disk C</code>.</li>
<li><p>You will find <code>pygmentize.exe</code> in path: <code>C:\Users\username\AppData\Local\Programs\Python\Python37\Scripts</code>, add the path to the system path, then it will work.</p>
</li>
<li><p>Example for <code>minted</code> package</p>
</li>
</ul>
<figure class="highlight latex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{minted}[linenos=true,frame=lines,framesep=2mm]{python}<span class="string"></span></span><br><span class="line"><span class="string">def quick_sort(arr):</span></span><br><span class="line"><span class="string">    if len(arr) &lt; 2:</span></span><br><span class="line"><span class="string">        return arr</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        pivot = arr[0]</span></span><br><span class="line"><span class="string">        less = [i for i in arr[1:] if i &lt;= pivot]</span></span><br><span class="line"><span class="string">        greater = [i for i in arr[1:] if i &gt; pivot]</span></span><br><span class="line"><span class="string">        return quick_sort(less) + [pivot] + quick_sort(greater)</span></span><br><span class="line"><span class="string"></span><span class="keyword">\end</span>{minted}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tex/minted.jpg" alt="minted_file"></p>
<!-- markdownlint-disable-file MD025 MD028 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Latex</tag>
        <tag>VSCode</tag>
      </tags>
  </entry>
  <entry>
    <title>Tensorflow2.4保姆级安装教程</title>
    <url>/2021/01/30/Tensorflow2.4%E4%BF%9D%E5%A7%86%E7%BA%A7%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<ul>
<li>先装python还是先装anaconda?</li>
<li>Anaconda版本选择与下载</li>
<li>Anaconda安装</li>
<li>更换conda镜像源</li>
<li>Pycharm使用</li>
<li>Pycharm虚拟环境介绍</li>
<li>CUDA与cuDNN</li>
<li>TensorFlow</li>
</ul>
<span id="more"></span>
<hr>
<h2 id="版本介绍"><a href="#版本介绍" class="headerlink" title="版本介绍"></a>版本介绍</h2><blockquote>
<p>python 3.7.10<br>conda 4.5.11<br>CUDA 11.1<br>Cudatoolkit 11.1.0<br>cuDNN 11.1 v8.0.5<br>tensorflow_gpu-2.4.1<br>Pycharm Professional 2020.3.3</p>
</blockquote>
<hr>
<h2 id="写在最前面"><a href="#写在最前面" class="headerlink" title="写在最前面"></a>写在最前面</h2><blockquote>
<p>下面列举了一些常见问题，请务必注意</p>
</blockquote>
<ul>
<li>国外源速度慢导致连接断开（请参考下文<strong>更换pip源和conda源</strong>）</li>
<li>版本对应问题（请勿安装过高版本的Anaconda，会导致python版本过高，Tensorflow不支持，至本文发布为止最高支持到python3.8，Tensorflow_CPU的安装较为简单，故演示了GPU-2.4.1）</li>
</ul>
<blockquote>
<p>笔者在开始前已经有了python3.6.8，但实际上可以直接跳过，anaconda自带python<br><a href="https://www.python.org/downloads/">Python Download</a></p>
<p>鉴于目前网上教程采用的版本比较混乱，故此次保姆级教程采用了较新的版本并通过测试</p>
<p>保姆级教程：尽可能详细的列出具体步骤，但省略了一些作者认为比较简单的操作：如何打开命令行、命令行基本操作、如何使用Pycharm、软件的基本安装流程、环境变量的手动配置等。</p>
<p><strong>如果仍然无法解决您的问题</strong><br>建议1：转身立马退坑<br>建议2：<a href="https://www.google.com.hk/">点击这里</a></p>
</blockquote>
<hr>
<h2 id="1-前言：先装python还是先装anaconda"><a href="#1-前言：先装python还是先装anaconda" class="headerlink" title="1.前言：先装python还是先装anaconda"></a>1.前言：先装python还是先装anaconda</h2><blockquote>
<p><strong>装anaconda，就不需要单独装python了</strong></p>
<p>anaconda 是一个python的发行版，包括了python和很多常见的软件库,和一个包管理器conda，集成了很多关于python科学计算的第三方库，主要是安装方便，而python是一个编译器，如果不使用anaconda，那么安装起来会比较痛苦，各个库之间的依赖性就很难连接的很好。</p>
</blockquote>
<h2 id="2-Anaconda版本选择与下载"><a href="#2-Anaconda版本选择与下载" class="headerlink" title="2.Anaconda版本选择与下载"></a>2.Anaconda版本选择与下载</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><blockquote>
<p><strong>官网下载:</strong> 不推荐，不会开飞机的话速度慢并且容易断<br><a href="https://www.anaconda.com/products/individual">Anaconda官网</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Anaconda.png" alt="Anaconda官网"></p>
</blockquote>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><blockquote>
<p><strong>国内镜像源:</strong> 可以用清华源、中科大源……<br><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive">Anaconda清华源</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Anaconda_tsinghua.png" alt="Anaconda清华源"></p>
</blockquote>
<h3 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h3><p> <img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Anaconda_python.png" alt="请输入图片描述"></p>
<h2 id="3-Anaconda安装"><a href="#3-Anaconda安装" class="headerlink" title="3.Anaconda安装"></a>3.Anaconda安装</h2><blockquote>
<p><strong>比较容易</strong>，一路next和skip，包括自动添加到环境变量等操作，可以直接装到C盘可以避免一些后续问题，笔者这里选择装到了E://Anaconda3 <strong>等待安装完毕即可</strong><br>若没有勾选<code>Add Anaconda to the system Path environment variable</code>，需要手动添加环境变量，比较简单；此处勾选了所以忽略</p>
</blockquote>
<h3 id="验证是否安装完成-conda-info"><a href="#验证是否安装完成-conda-info" class="headerlink" title="验证是否安装完成 conda info"></a>验证是否安装完成 conda info</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Anaconda_complete.png" alt="验证是否安装完成 conda info"></p>
<h3 id="Anaconda-Navigator是否可用"><a href="#Anaconda-Navigator是否可用" class="headerlink" title="Anaconda Navigator是否可用"></a>Anaconda Navigator是否可用</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Anaconda_navigator.png" alt="Anaconda Navigator是否可用"></p>
<blockquote>
<p>至此，Python 3.7.0 + Anaconda3-5.3.1安装完成</p>
</blockquote>
<hr>
<h2 id="4-更换conda镜像源"><a href="#4-更换conda镜像源" class="headerlink" title="4.更换conda镜像源"></a>4.更换conda镜像源</h2><ul>
<li>可以在Anaconda Navigator中的channel直接更换</li>
<li><p>也可以在Anaconda Prompt中更换镜像源<br>  <code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code><br>  <code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</code><br>  <code>conda config --set show_channel_urls yes</code></p>
</li>
<li><p>查看是否已经更换好通道<br>  <code>conda config --show channels</code><br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Change_channel.png" alt="Change_channel"></p>
</li>
</ul>
<h2 id="5-Pycharm使用"><a href="#5-Pycharm使用" class="headerlink" title="5.Pycharm使用"></a>5.Pycharm使用</h2><blockquote>
<p>Jetbrains全家桶：US $649.00/Year，当然建议使用edu邮箱获取，申请教育版邮箱认证即可（可能需要不定时验证信息），建议安装<strong>Toolbox</strong>方便更新以及使用</p>
<p><a href="https://www.jetbrains.com">附上<strong>Jetbrains</strong>链接</a></p>
<p><em>针对浙工大学生邮箱：Jetbrains的验证邮件容易出现在e邮的<strong>拦截队列</strong>中，收不到confirm email可以在拦截队列中找到</em></p>
<p>如果比较困难，可以尝试装中文插件 File-&gt;Settings-&gt;Plugins-&gt;Chinese (Simplified) Language Pack EAP  当然<strong>不建议</strong>这样使用，<strong>汉化</strong>的翻译可能存在偏差</p>
</blockquote>
<h2 id="6-Pycharm虚拟环境介绍"><a href="#6-Pycharm虚拟环境介绍" class="headerlink" title="6. Pycharm虚拟环境介绍"></a>6. Pycharm虚拟环境介绍</h2><blockquote>
<p>Pycharm采用虚拟的环境，配置是可以采用为项目新建Python解释器或者使用原有的环境</p>
</blockquote>
<ol>
<li>Inherit global site-packages<br>继承本地的库，如果需要重复安装第三方库，可以勾上这个</li>
<li>Make available to all projects<br>可以使别的工程项目可以使用此工程的环境</li>
</ol>
<blockquote>
<p>区别：创建Virtualenv Environment 或者 Conda Environment<br>若要在服务器上远程运行，配置SSH interpreter，并且在Tools-&gt;Deploment-&gt;Configuration中配置主机即可，后续有机会再详细展开……</p>
</blockquote>
<h2 id="7-CUDA和cuDNN"><a href="#7-CUDA和cuDNN" class="headerlink" title="7. CUDA和cuDNN"></a>7. CUDA和cuDNN</h2><blockquote>
<p>检测目前安装了哪些环境<br>cmd: <code>conda info --envs</code></p>
<p>检查目前有哪些版本的python可以安装<br>cmd：<code>conda search --full-name python</code></p>
<p>检查目前有哪些版本的Tensorflow可以安装<br>cmd：<code>conda search --full -name tensorflow</code></p>
<p>查看依赖关系<br>cmd：<code>conda info tensorflow</code></p>
<p><strong>在这之前，检查Nvidia驱动支持的CUDA版本，此处安装的是Tensorflow2.4.1，需要CUDA11.0或及以上版本</strong></p>
</blockquote>
<ul>
<li><a href="https://tensorflow.google.cn/install/source_windows?hl=cn#gpu">查看Tensorflow和CUDA对应版本</a>（版本一定要对应）</li>
</ul>
<blockquote>
<p><code>nvidia-smi</code>命令行查看CUDA Version （当前显卡驱动最高支持的CUDA版本）</p>
</blockquote>
<ul>
<li><a href="https://developer.nvidia.com/cuda-toolkit-archive">Nvidia官网下载Cudatoolkit</a>（下载速度慢可以复制链接到迅雷下载）</li>
</ul>
<blockquote>
<p>一路安装下来即可，安装过程中已经自动添加了环境变量<br>cmd：<code>nvcc -V</code>返回CUDA版本信息，如果<strong>nvcc命令无法识别则表示安装失败</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/nvcc%20-V.png" alt="CUDA版本信息"></p>
<ul>
<li><a href="https://developer.nvidia.com/rdp/cudnn-archive">Nvidia官网下载cuDNN</a>（下载速度慢可以复制链接到迅雷下载）</li>
</ul>
<blockquote>
<p>只要把cuDNN文件复制到CUDA的对应文件夹里就可以，即所谓的插入式设计，cuDNN是CUDA的扩展计算库，不会对CUDA造成其他影响。<br>复制后，手动将CUDA相对路径下的/bin和/lib/x64添加到环境变量CUDA_PATH</p>
</blockquote>
<ul>
<li><strong>测试CUDA</strong></li>
</ul>
<blockquote>
<p>cmd：<code>cd /d C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1\extras\demo_suite</code></p>
</blockquote>
<ul>
<li><strong>测试<code>deviceQuery.exe</code></strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/CUDA_test0.png" alt="CUDA_deviceQuery"></p>
<ul>
<li><strong>测试<code>bandwidthTest.exe</code></strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/CUDA_test1.png" alt="CUDA_bandwidthTest"></p>
<blockquote>
<p>都返回Result = PASS<br>That’s all OK.</p>
</blockquote>
<h2 id="8-TensorFlow"><a href="#8-TensorFlow" class="headerlink" title="8. TensorFlow"></a>8. TensorFlow</h2><h3 id="8-1-创建环境"><a href="#8-1-创建环境" class="headerlink" title="8.1 创建环境"></a>8.1 创建环境</h3><pre><code>conda create --name tfenv python=3.7.0
</code></pre><blockquote>
<p>由于之前已经更换了清华源，由于网络问题造成的错误率大大降低，但仍然可能被中断<br>用<code>conda info --envs</code>检查一下是否装好了tfenv环境</p>
</blockquote>
<h3 id="8-2-激活环境"><a href="#8-2-激活环境" class="headerlink" title="8.2 激活环境"></a>8.2 激活环境</h3><pre><code>conda activate tfenv
</code></pre><blockquote>
<p>退出环境<code>conda deactivate</code></p>
</blockquote>
<h3 id="8-3-激活后安装Tensorflow"><a href="#8-3-激活后安装Tensorflow" class="headerlink" title="8.3 激活后安装Tensorflow"></a>8.3 激活后安装Tensorflow</h3><ul>
<li><p>更换tfenv环境的pip源 👉<a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/">更换pip清华源参考方法</a></p>
</li>
<li><p>pip config set global.index-url <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></p>
</li>
<li>pip install -U tensorflow-gpu -i <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></li>
</ul>
<blockquote>
<p>此处未指定版本，会选择最高的gpu版本安装，若要置顶版本，<code>tensorflow-gpu==2.x.x</code><br>虽然已经换源，但还是可能出现<code>These Packages Do Not Match The Hashes From The Requirements File.</code><br>解决方案：在pip时，添加”–upgrade”参数（<strong>实测有效</strong>）。<br>几分钟后👉<strong>安装成功</strong></p>
</blockquote>
<h3 id="8-4-激活后测试Tensorflow"><a href="#8-4-激活后测试Tensorflow" class="headerlink" title="8.4 激活后测试Tensorflow"></a>8.4 激活后测试Tensorflow</h3><ul>
<li><p>输出包含GPU信息的日志</p>
<p>  import tensorflow as tf<br>  tf.test.is_gpu_available()<br>  tf.test.gpu_device_name()</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Prompt_test.png" alt="Prompt_test"></p>
<h3 id="8-5-Pycharm测试Tensorflow"><a href="#8-5-Pycharm测试Tensorflow" class="headerlink" title="8.5 Pycharm测试Tensorflow"></a>8.5 Pycharm测试Tensorflow</h3><ul>
<li>添加安装有Tensorflow的环境作为工程的python解释器</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Pycharm_test0.png" alt="Anaconda官网.png"></p>
<pre><code>import tensorflow as tf
tf.compat.v1.disable_eager_execution()
greeting = tf.constant('Hello Tensorflow!')
sess = tf.compat.v1.Session()
result = sess.run(greeting)
print(result)
sess.close()
</code></pre><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Python/Pycharm_test1.png" alt="Pycharm中测试"></p>
<hr>
<blockquote>
<p>至此，所有安装和配置完成，<strong>版本对应</strong>问题非常重要，如果出现装错了版本请尝试<strong>彻底卸载</strong>后重装<br>为了更有针对性，本文采用了较新的版本，请务必在安装前选择<strong>合适的版本</strong><br>如果提示确实dll动态链接库，请尝试手动下载，貌似采用CUDA11.1可能会遇到这种情况，并且有部分人认为11.1中有未知错误并且不推荐使用，但在安装过程中并未发现，或许之后遇到了会继续补充</p>
</blockquote>
<hr>
<h2 id="Update-2021-08-10"><a href="#Update-2021-08-10" class="headerlink" title="Update 2021.08.10"></a>Update 2021.08.10</h2><ul>
<li>考虑到大多数模型还是使用<code>f1.x</code>构建的，并且与<code>2.x</code>在很大程度上有所区别，故决定增加<code>tensorflow1.8.0</code>环境。</li>
</ul>
<h3 id="注意事项（与上文相同，有空加图）"><a href="#注意事项（与上文相同，有空加图）" class="headerlink" title="注意事项（与上文相同，有空加图）"></a>注意事项（与上文相同，有空加图）</h3><ol>
<li>CUDA、cuDNN与Tensorflow版本号对应，<a href="https://tensorflow.google.cn/install/source_windows?hl=en#gpu">点击查看原文档对应关系</a></li>
<li>Python版本适用，不建议用过高版本</li>
<li>显卡驱动不适配（显卡驱动决定可支持的CUDA最高版本，已有2.x版本的固驱动基本不会出问题），<a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">点击查看原文档对应关系</a></li>
<li>两个版本的CUDA兼容性问题</li>
</ol>
<p><strong>多版本的CUDA兼容问题最麻烦（多次尝试后已解决）</strong></p>
<ul>
<li>CUDA安装<ul>
<li>若采用<strong>精简安装</strong>，先安装低版本的，在安装高版本的，会覆盖兼容，暂未发现问题</li>
<li>若现有高版本（如本文顺序现有tf2.4.1再加1.8.0），需使用<strong>自定义安装</strong>，驱动组件只需选择CUDA下的<code>Develpoment</code>、<code>Documentation</code>、<code>Visual Studio Intergration</code>、<code>Sanples</code>、<code>Runtime</code>共五个即可，<code>Nsight compute</code>以及<code>Driver components</code>和<code>other components</code>取消勾选，否则会导致两个版本冲突都无法使用</li>
<li>路径添加<ul>
<li>安装完成之后，默认<code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA</code>会出现<code>v9.0</code>文件夹，原来已经有<code>v11.1</code></li>
<li>此时已可用<code>nvcc -V</code>查看CUDA版本为最近安装的版本</li>
<li><a href="https://developer.nvidia.com/rdp/cudnn-archive">cuDNN组件下载替换</a></li>
</ul>
</li>
</ul>
</li>
<li><p>版本切换(环境变量)</p>
<ul>
<li>只需将PATH下需要使用的版本<code>bin</code>和<code>libnvvp</code>两个路径移动至其他版本之前即可,CUDA_PATH无需修改，<code>nvcc -V</code>可查看当前CUDA版本已更改</li>
<li><code>CUDA_PATH C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1</code></li>
<li><code>CUDA_PATH_V11.1 C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1</code></li>
<li><code>CUDA_PHTH_V9.0 C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9.0</code></li>
<li>PATH<ul>
<li><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1\bin</code></li>
<li><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1\libnvvp</code></li>
<li><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9.0\bin</code></li>
<li><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9.0\libnvvp</code></li>
</ul>
</li>
</ul>
</li>
<li><p>经过测试多版本tensorflow无冲突，版本自由切换正常，时间原因详细步骤不截图，此处记下以备之后迁移环境时参考用</p>
</li>
</ul>
<h3 id="Tensorflow-GPU版本信息"><a href="#Tensorflow-GPU版本信息" class="headerlink" title="Tensorflow-GPU版本信息"></a>Tensorflow-GPU版本信息</h3><ul>
<li>tensorflow_gpu-2.4.1<blockquote>
<p>python 3.7.10<br>CUDA 11.1<br>cuDNN 11.1 v8.0.5</p>
</blockquote>
</li>
<li>tensorflow_gpu-1.8.0<blockquote>
<p>python 3.6.13<br>CUDA 9.0<br>cuDNN 9.0 v7.6.5</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="Update-2021-12-26"><a href="#Update-2021-12-26" class="headerlink" title="Update 2021.12.26"></a>Update 2021.12.26</h2><ul>
<li>由于之后的研究影响，部分模型可能需要用到Pytorch，尽管个人倾向于使用前者建模，但在复现已有的模型时不可必要要看懂并且迁移Pytorch模型，故决定增加<code>Pytorch1.8.0</code>环境。</li>
</ul>
<h3 id="详细步骤（有空加图）"><a href="#详细步骤（有空加图）" class="headerlink" title="详细步骤（有空加图）"></a>详细步骤（有空加图）</h3><ol>
<li>Anaconda虚拟环境，<code>conda create -n torch1.8.0 python=3.7.0</code>等待创建完毕</li>
<li>pip安装或conda安装torch</li>
<li>同样也需要注意CUDA版本对应，由于之前已有CUDA11.1，故找了个与之适配的torch版本使用</li>
</ol>
<ul>
<li>本文使用conda安装，有空详细展开并且加上pip安装流程<ul>
<li><a href="https://pytorch.org/get-started/previous-versions/">查找历史版本</a></li>
<li>使用conda命令等待安装完毕即可，若下载受限请参照上文修改镜像源</li>
</ul>
</li>
<li>一般速度较快，若长时间无反应请考虑是否被墙（换源）或者无对应版本（参照文档）</li>
<li>本文使用<code>conda install pytorch==1.8.0 torchvision==0.9.0 torchaudio==0.8.0 cudatoolkit=11.1 -c pytorch -c conda-forge</code></li>
</ul>
<h3 id="Pytorch-GPU版本信息"><a href="#Pytorch-GPU版本信息" class="headerlink" title="Pytorch-GPU版本信息"></a>Pytorch-GPU版本信息</h3><ul>
<li>pytorch 1.8.0<blockquote>
<p>torchvision 0.9.0<br>torchaudio 0.8.0<br>python 3.7.0<br>CUDA 11.1<br>cuDNN 11.1 v8.0.5</p>
</blockquote>
</li>
</ul>
<hr>
<!-- markdownlint-disable-file MD036 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Tutorial</tag>
        <tag>Tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>VS2019代码提示延迟很高，部分快捷键无法使用的问题</title>
    <url>/2021/02/26/Visual%20Studio%E5%87%BA%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%8F%90%E7%A4%BA%E5%BB%B6%E8%BF%9F%EF%BC%8C%E9%83%A8%E5%88%86%E5%BF%AB%E6%8D%B7%E9%94%AE%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ul>
<li>Visual Studio 与Nvidia CUDA NSightVSE冲突</li>
</ul>
<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><ul>
<li>Tab、Ctrl’+C 、 Ctrl’+K 等快捷键失效，智能代码提示不能正常显示，有时不会出现，有时要等四五秒，非常不正常</li>
</ul>
<blockquote>
<p>Setting中检查设置无误，尝试过重启、重置个人配置、重装等均无效<br>很长一段时间没有使用过vs，之前装了比较新的Nvidia CUDA，同时附带的有NSightVSE，也就是设计vs的拓展，问题出在这里</p>
</blockquote>
<span id="more"></span>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><blockquote>
<p>卸载NSightVSE或者其他Nvidia和vs相关的拓展，重启vs后生效<br>正常情况搜索NsightVSE会出现四个，保留下列三个即可，版本仅供参考，可能其他版本不会出现如上问题。<br>Nvidia CUDA Nsight NVTX 11.1<br>Nvidia Nsight Compute 2020.2.0<br>Nvidia Nsight Systems 2020.3.4</p>
</blockquote>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Debug</tag>
        <tag>Nvidia CUDA</tag>
        <tag>Visual Studio</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo_begin</title>
    <url>/2021/01/31/hexo_begin/</url>
    <content><![CDATA[<h2 id="机制介绍"><a href="#机制介绍" class="headerlink" title="机制介绍"></a>机制介绍</h2><p><code>hexo d</code>上传部署到Github的其实是hexo编译后的文件静态文件，用于生成网页，不包含源文件，也就是上传<code>.deploy_git</code>中的文件，其他文件，包括<code>source</code>里面的和一些配置、主题文件都不会上传到GitHub，考虑到可能会在不同主机发布，因此将<code>hexo d</code>操作不会上传的文件主动<code>git</code>到另一个分支。</p>
<span id="more"></span>
<hr>
<h2 id="新建备份分支"><a href="#新建备份分支" class="headerlink" title="新建备份分支"></a>新建备份分支</h2><ol>
<li><p>首先在Github上新建一个<code>hexo_backup</code>分支并且设置为默认分支，以便在每次同步的时候不用指定分支，比较方便，用于备份源文件。</p>
</li>
<li><p>在本地<code>blog_local</code>目录下<code>git clone git@github.com:boom1999/boom1999.github.io.git</code>,此时由于默认分支为hexo_backup，所以只是clone了hexo_backup。在clone下的目录里将<code>.git</code>以外的文件全部删除，将源文件（包括<code>.gitignore</code>）全部复制过来。（<code>.deploy_git</code>不需要，这是生成的静态文件，也就是会push到master分支中的文件）。如果没有<code>.gitignore</code>，忽略push这部分文件，请手动添加：</p>
<pre><code> .DS_Store
 Thumbs.db
 db.json
 *.log
 node_modules/
 public/
 .deploy*/
</code></pre></li>
<li><p>将源文件push到hexo_backup分支,上传后GitHub上的hexo_backup分支备份完成</p>
<pre><code> git add .
 git commit –m "your commit"
 git push 
</code></pre></li>
</ol>
<hr>
<h2 id="更换环境操作"><a href="#更换环境操作" class="headerlink" title="更换环境操作"></a>更换环境操作</h2><ul>
<li>创建一个新的<code>blog_local</code>文件夹</li>
<li>安装<code>git</code>和<code>nodejs</code></li>
<li><p>设置git全局邮箱和用户名</p>
<pre><code>  git config --global user.name "yourgithubname"
  git config --global user.email "yourgithubemail"
</code></pre></li>
<li><p>设置<code>ssh key</code></p>
<pre><code>  ssh-keygen -t rsa -C "youremail"
  #生成后公钥添加到GitHub仓库中
  #验证是否成功
  ssh -T git@github.com
</code></pre></li>
<li><p>安装hexo（不需要hexo init，因为整体框架会被clone下来）</p>
<pre><code>  npm install hexo-cli -g
  #或者局部安装
  npm install hexo
</code></pre></li>
<li><p><code>clone</code>到本地操作</p>
<pre><code>  git clone git@github.com:boom1999/boom1999.github.io.git
</code></pre></li>
<li><p>进入本地文件</p>
<pre><code>  cd boom1999.github.io
  npm install
</code></pre></li>
<li><p>安装名为<code>hexo-deployer-git</code>的部署器插件，通过该插件就能实现一键部署</p>
<pre><code>  npm install hexo-deployer-git --save
</code></pre></li>
<li><p>添加新文件<code>source/_posts</code>，生成，部署</p>
<pre><code>  hexo g
  hexo d
</code></pre></li>
</ul>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li><p>每次写完不要忘了备份源文件</p>
<pre><code>  git add .
  git commit –m "your commit"
  git push 
</code></pre></li>
<li>如果是在已经目前使用的机器，如在其他机器上更新过，每次<strong>使用前</strong>只要远端同步一下就行<code>git pull</code></li>
</ul>
<hr>
<ul>
<li><code>2021/01/30测试通过</code></li>
<li>下一步准备部署到自己的服务器，GitHub作备份用</li>
</ul>
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>debug Gitalk 403</title>
    <url>/2022/01/02/debug%20Gitalk%20403/</url>
    <content><![CDATA[<ul>
<li>留言系统使用Gitalk，最近发现无法使用GitHub账号登陆，出现403</li>
<li>Error: Request failed with status code 403</li>
</ul>
<h3 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h3><blockquote>
<p>网络请求403，拿不到token，导致登陆不上<br>Request URL：<a href="https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token">https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Missing required request header. Must specify one of: origin,x-requested-with</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<span id="more"></span>
<h3 id="cors-anywhere"><a href="#cors-anywhere" class="headerlink" title="cors-anywhere"></a>cors-anywhere</h3><blockquote>
<p>开源框架解决跨域问题的反向代理</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">CORS Anywhere is a NodeJS proxy which adds CORS headers to the proxied request.</span><br><span class="line"></span><br><span class="line">The url to proxy is literally taken from the path, validated and proxied. The protocol part of the proxied URI is optional, and defaults to "http". If port 443 is specified, the protocol defaults to "https".</span><br><span class="line"></span><br><span class="line">This package does not put any restrictions on the http methods or headers, except for cookies. Requesting user credentials is disallowed. The app can be configured to require a header for proxying a request, for example to avoid a direct visit from the browser.</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h3 id="more"><a href="#more" class="headerlink" title="more"></a>more</h3><blockquote>
<p>看上去像是被滥用，然后从2021.1.31后用户必须手动获得这个网站的访问权限后才能使用，这也就是为什么最近登陆不上了</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Public demo server (cors-anywhere.herokuapp.com) will be very limited by January 2021, 31st</span><br><span class="line">The demo server of CORS Anywhere (cors-anywhere.herokuapp.com) is meant to be a demo of this project. But abuse has become so common that the platform where the demo is hosted (Heroku) has asked me to shut down the server, despite efforts to counter the abuse (rate limits in #45 and #164, and blocking other forms of requests). Downtime becomes increasingly frequent (e.g. recently #300, #299, #295, #294, #287) due to abuse and its popularity.</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h3 id="Gitalk-Document"><a href="#Gitalk-Document" class="headerlink" title="Gitalk Document"></a>Gitalk Document</h3><blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&gt;const gitalk = new Gitalk({</span><br><span class="line"> clientID: 'GitHub Application Client ID',</span><br><span class="line"> clientSecret: 'GitHub Application Client Secret',</span><br><span class="line"> repo: 'GitHub repo',      // The repository of store comments,</span><br><span class="line"> owner: 'GitHub repo owner',</span><br><span class="line"> admin: ['GitHub repo owner and collaborators, only these guys can initialize github issues'],</span><br><span class="line"> id: location.pathname,      // Ensure uniqueness and length less than 50</span><br><span class="line"> distractionFreeMode: false  // Facebook-like distraction free mode</span><br><span class="line">&gt;})</span><br><span class="line"></span><br><span class="line">&gt;gitalk.render('gitalk-container')</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><blockquote>
<p>在gitalk相应js文件中添加</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">proxy: '&lt;%- theme.gitalk.proxy %&gt;'</span><br></pre></td></tr></tbody></table></figure>
<p>在配置文件中添加</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">proxy: https://netnr-proxy.cloudno.de/https://github.com/login/oauth/access_token</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>重新部署</p>
</blockquote>
<p>暂时采用了Issue中找到的可替代的cors，表示感谢.</p>
<hr>
<h3 id="Update-2022-01-02"><a href="#Update-2022-01-02" class="headerlink" title="Update 2022.01.02"></a>Update 2022.01.02</h3><ul>
<li>很久没更新blog了，趁这次有时间索性把积攒下来的问题一起解决<span class="github-emoji"><span>👋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
<li>这次还是Gitalk的问题，<del>虽然可以使用其他评论插件，</del> 但还是更加喜欢Gitalk的UI</li>
<li>上文已经解决了<code>403</code>的问题，是采用了一个Issue里的方法，使用了热心网友的代</li>
<li>但是发现实际上只用了三四个月左右就由于使用人数过多，所有访问都进了这个代理，后来应该是网友取消了，不得而知，出现了好几个月的<code>Error:Net error</code></li>
<li>继续找问题会发现又有网友提出了上面这个方法（<strong>好家伙搁这儿转圈圈呢</strong>）</li>
<li>很机智的把<code>_config.yml</code>里的代理清了，发现有希望，不再是直接<code>error</code>了，有登录验证界面，但变成<code>405</code>了好家伙。</li>
<li>好在有个Taiwan的网友Kalin Lai<a href="https://github.com/gitalk/gitalk/issues/437">发现了问题</a>，是gitalk.ejs中的代理没删干净，手动狗头。</li>
<li>删干净后重新出现了<code>403</code>，继续找文档，loading···</li>
<li>最后终于找到了，忙活一个小时成功解决，吃饭去了</li>
</ul>
<blockquote>
<p>针对403的问题，Gitalk开发团队已经做了修复，解决方法如下：更新版本到 1.7.2 或者修改配置增加<code>proxy: https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token</code><br>当然也可以重新配置个人代理，有机会试一下，这里插个眼</p>
</blockquote>
<h3 id="Update-2022-01-07"><a href="#Update-2022-01-07" class="headerlink" title="Update 2022.01.07"></a>Update 2022.01.07</h3><ul>
<li>来更新了，试了用Cloudflare创建代理</li>
<li>有免费的版本，每天十万条，每十分钟一千条记录</li>
<li>但是发现代理后整个网站速度受到影响比较大，故放弃使用，选择用Gitalk团队的官方代理，结束。</li>
</ul>
]]></content>
      <categories>
        <category>Gitalk</category>
      </categories>
      <tags>
        <tag>debug</tag>
      </tags>
  </entry>
  <entry>
    <title>UAV Track Planning Algorithms</title>
    <url>/2022/11/24/UAV%20Track%20Planning%20Algorithms/</url>
    <content><![CDATA[<p><strong>摘要</strong>：无人机(Unmanned Aerial Vehicle, UAV)是指能够在脱离人员的主动干预下，依据自身对周围环境进行感知、理解并进行自主飞行控制的飞行器。无人机因其具备低成本、适用场景多、无人员伤亡等优点，已成为世界各国为适应未来战场需要而重点研究的内容。随着航空技术的发展，越来越多的无人机替代飞行员执行高危险和高强度的军事侦察打击、民用巡检搜救等任务，无人机的航迹规划问题日益受到重视。航迹规划问题起源于机器人的运动规划，航迹规划就算综合考虑环境和目标任务规划最优的飞行路径，本质为多约束条件下的最优化问题，核心思想就是建立目标函数模型，有效处理各项约束，而无人机飞行涉及的约束条件众多，目前大多数学者首先通过求解全局最优路径，在对局部约束进行航迹动态优化。实际环境瞬息万变，复杂的电磁干扰等问题随时都会影响无人机的飞行，无人机航迹规划需要智能、实时性高、可靠性强的优秀算法作为支撑。</p>
<p><strong>关键词</strong>：无人机、航迹规划</p>
<span id="more"></span>
<h2 id="1-绪论"><a href="#1-绪论" class="headerlink" title="1  绪论"></a>1  绪论</h2><p>无人机(Unmanned Aerial Vehicle, UAV)是指能够在脱离人员的主动干预下，依据自身对周围环境进行感知、理解并进行自主飞行控制的飞行器。无人机因其具备低成本、适用场景多、无人员伤亡等优点，已成为世界各国为适应未来战场需要而重点研究的内容。</p>
<p>随着航空技术的发展，越来越多的无人机替代飞行员执行高危险和高强度的军事侦察打击、民用巡检搜救等任务，无人机的航迹规划问题日益受到重视。航迹规划问题起源于机器人的运动规划，航迹规划就算综合考虑环境和目标任务规划最优的飞行路径，本质为多约束条件下的最优化问题[1]，核心思想就是建立目标函数模型，有效处理各项约束，而无人机飞行涉及的约束条件众多，目前大多数学者首先通过求解全局最优路径，在对局部约束进行航迹动态优化[2]。实际环境瞬息万变，复杂的电磁干扰等问题随时都会影响无人机的飞行，无人机航迹规划需要智能、实时性高、可靠性强的优秀算法作为支撑。</p>
<p>现实空间是三维的，国内外针对无人机航迹规划的研究，主要集中在现实三维空间，三维航迹规划问题应用范围广，实用价值高。在不考虑高度的情况下，将三维空间中的物体投影到二维平面，可以将三维航迹规划问题降维到二维，从而可以用栅格法规划空间以简化问题求解，但在实际应用过程中，复杂的地形等在高度上都会极大的影响无人机的飞行路径，因此若无特定说明，下文所指的无人机航迹规划均指三维空间下的无人机航迹规划。</p>
<p>针对无人机航迹规划问题，主要可以分为传统航迹规划算法和现代智能航迹规划算法[3]以及新出现的机器学习算法。传统航迹规划算法主要有人工势场法(Artificial Potential Field, APF)、迪杰斯特拉算法(Dijkstra Algorithm)、模拟退火法(Simulated Annealing Algorithm, SAA)和$A\ast$算法(A Star Algorithm)等，现代智能航迹规划算法主要有遗传算法(Genetic Algorithm, GA)、蚁群优化(Ant Colony Optimization, ACO)算法和粒子群优化(Particle Swarm Optimization, PSO)算法等。</p>
<h2 id="2-问题描述"><a href="#2-问题描述" class="headerlink" title="2  问题描述"></a>2  问题描述</h2><p>无人机航迹规划问题是指规划无人机在综合考虑环境、时间消耗、安全性、障碍物等因素条件下，完成指定飞行任务，其中主要的因素是飞行航迹短、消耗时间少。无人机航迹规划问题可以从空间规划、约束条件和算法规划等几个方面进行研究。</p>
<p>空间规划是指如何将实际环境优化建模，降低求解难度，如对不同类型的障碍物进行近似的优化计算，在特定环境下将三维空间投影至二维空间减少约束条件等。在无人机航迹规划的约束条件中，既有来自无人机本身的内在约束条件，即无人机性能，涉及到最小转弯半径、最大俯仰角、最大飞行时长和飞行高度等限制无人机自身飞行动作的因素，同时也包括来在环境的约束条件，如复杂地形、电磁场干扰、无人机集群干扰碰撞、军事威胁、障碍物干扰等约束条件。无人机航迹规划的核心问题是规划算法，规划算法可以追溯到机器人的运动规划。在特定的环境和无人机种类乃至不同的任务要求下，对规划算法的要求也不尽相同。现实环境时刻都在发生变化，新的环境干扰因素在不断增加，现有的规划算法迟早会有难以满足飞行任务的时候，需要对现有算法进行改进或者在此基础上进行创新，更具实际的规划问题采用适合规划算法，才能够使无人机高效而安全地完成飞行任务。</p>
<h2 id="3-发展现状"><a href="#3-发展现状" class="headerlink" title="3  发展现状"></a>3  发展现状</h2><h3 id="3-1-传统经典算法"><a href="#3-1-传统经典算法" class="headerlink" title="3.1  传统经典算法"></a>3.1  传统经典算法</h3><p>传统航迹规划算法主要有人工势场法、Dijkstra算法、模拟退火法和$A\ast$算法等。</p>
<h3 id="3-1-1-人工势场法"><a href="#3-1-1-人工势场法" class="headerlink" title="3.1.1  人工势场法"></a>3.1.1  人工势场法</h3><p>人工势场法是一种模拟电势场分布的方法，将空间假设为人工势场，势场由引力场和斥力场组成，目标点对物体表现为引力，威胁源对物体表现为斥力，物体的移动是由引力和斥力的合力来控制。传统人工势场法定义如下。</p>
<p>航迹点X的引力势函数和斥力势函数分别为：</p>
<p>​<script type="math/tex">{U_{att}}\left( X \right) = {1 \over 2}{K_{att}}{\rho ^2}\left( {X,{X_G}} \right) \tag{3.1.1}</script></p>
<script type="math/tex; mode=display">{U_{rep}}\left( X \right) = \left\{
\begin{array}{lrl}
   {{1 \over 2}{K_{rep}}{{\left[ {{1 \over {\rho \left( {X,{X_O}} \right)}} - {1 \over {{\rho _O}}}} \right]}^2}} & & {\rho \left( {X,{X_O}} \right) \le {\rho _O}} \\
   0 & & {\rho \left( {X,{X_O}} \right) > {\rho _O}}
\end{array}
\right. \tag{3.1.2}</script><p>其中${K<em>{att}}$和${K</em>{rep}}$分别为引力和斥力增益系数且均为正常数；$\rho \left( {X,{X_G}} \right)$为航迹点$X$与目标点${X_G}$之间的距离；$\rho \left( {X,{X_O}} \right)$为航迹点$X$与威胁源${X_O}$之间的距离；${\rho _O}$为威胁源影响的最大距离，超过${\rho _O}$表示该威胁源不能对飞行器产生影响。</p>
<p>无人机在航迹点 收到的引力和斥力分别为相应势函数的负梯度：</p>
<script type="math/tex; mode=display">{F_{att}} =  - \nabla {U_{att}}\left( X \right) =  - {K_{att}}\rho \left( {X,{X_G}} \right) \tag{3.1.3}</script><script type="math/tex; mode=display">{F_{rep}} = \left\{
\begin{array}{lrl}
   {{K_{rep}}\left[ {{1 \over {\rho \left( {X,{X_O}} \right)}} - {1 \over {{\rho _O}}}} \right]{1 \over {{\rho ^2}\left( {X,{X_O}} \right)}}} & & {\rho \left( {X,{X_O}} \right) \le {\rho _O}} \\ 
   0 & & {\rho \left( {X,{X_O}} \right) > {\rho _O}} \\ 
\end{array}
\right. \tag{3.1.4}</script><p>总势场力为目标点对航迹点$X$产生的引力和所有威胁源产生的斥力的矢量和：</p>
<script type="math/tex; mode=display">{F_{total}} = {F_{att}} + \sum {{F_{rep}}} \tag{3.1.5}</script><p>人工势场法有着算法简明、实时性好、规划速度快的优点，适用于局部的实时航迹规划应用。但其缺点是当环境比较复杂时，由于人工势场会依赖局部势场，会使问题陷入局部最优解，使算法出现停滞，会在危险源附近反复抖动：当无人机离目标点较远时，合力方向更趋近于目标点，容易使得无人机进入威胁源区域；当目标点附近有危险源时，斥力非常大而引力较小，这样会使无人机远离目标点从而无法到达。</p>
<p>针对上述缺陷，众多学者结合无人机航迹规划特点对人工势场法进行了改进，提出了许多优秀的算法。Kathib在缩小威胁搜索空间的基础上对航迹点预规划寻找起始点和目标点之间的路径，实现了全局规划，弥补了人工势场容易陷入局部最优的缺陷；并改进了人工势场中的引力算法，有效解决了人工势场法容易陷入局部最优的问题，提高了算法的效率和适应性[4]。Chen Xia等人[5]在斥力势函数中加入无人机与目标点的距离，减小斥力，改善障碍物在目标附近时目标不可达的问题。设置引导点为无人机提供方向随机的势场力，解决局部极小值和震荡问题。王强等人[6]在人工势场法搜索陷入威胁区时，构造惩罚势函数替代斥力势函数，并使用模拟退火算法取代虚拟力引导的方法搜索逃离位置，效避免了局部极小值和抖动现象。姚远等人[7]使用相对速度斥力势场和斥力增益模糊控制器实现人工势场法的动态避障，避免了局部极小值。</p>
<h3 id="3-1-2-Dijkstra算法"><a href="#3-1-2-Dijkstra算法" class="headerlink" title="3.1.2  Dijkstra算法"></a>3.1.2  Dijkstra算法</h3><p>在图论中，求解最短路径常用Dijkstra算法来实现，基于贪心算法、广度优先搜索和动态规划来实现。在无人机航迹规划问题中，使用Dijkstra算法构建带有权值的图，其顶点代表航迹点，边代表所有可行航迹，求解得到这些航迹中的最优航迹。使用Dijkstra算法进行航迹规划实现比较简单，但算法的时空复杂度均为$O\left( {{n^2}} \right)$，与空间中的点数平方成正比，即在高维空间中的搜索时间更长，对内存的要求也更高，因此在二维和三维航迹规划中有着较大的性能差异，常用于二维空间的航迹规划[8,9]。因此使用Dijkstra 算法进行航迹规划的关键问题为如何在大范围空间内合理选取航迹点，尽可能减低时空复杂度。采用Voronoi图的方式[8]，选取各个威胁源连线的中垂线的交点为航迹点，能够最大化避免威胁，但代价是航迹较长，并且受限于无人机实际的转弯角，不一定可行。</p>
<h3 id="3-1-3-模拟退火法"><a href="#3-1-3-模拟退火法" class="headerlink" title="3.1.3  模拟退火法"></a>3.1.3  模拟退火法</h3><p>模拟退火法是一种启发式随即搜索算法，基于蒙特卡洛迭代，实际上是模拟固体物质的退火过程：在某一初始温度下，伴随温度控制参数按照降温函数不断下降，结合概率特性在解空间中寻找目标函数的全局最优解，也就是能有机会跳出局部最优解得到全局最优解。其优点是算法求得的解与初始状态无关，具有渐进收敛性，局部搜索能力强，但其缺点也比较明显，解的质量非常依赖与参数，全局搜索能力较差。在航迹规划中，模拟退火法的每一个解都代表一条无人机航迹，目标函数则是代价函数，但常常因为没有考虑无人机本身的性能约束，导致得到的航迹可行性不高。当然，如果允许适当增加运算量，模拟退火算法也可与易陷入局部最优解的算法相结合帮助其跳出局部最优找到全局最优解，如遗传模拟退火算法[10]，在交叉和变异过程中使用Metropolis准则判断是否接新解。</p>
<h3 id="3-1-4-A-ast-算法"><a href="#3-1-4-A-ast-算法" class="headerlink" title="3.1.4  $A\ast$算法"></a>3.1.4  $A\ast$算法</h3><p>在无人机航迹规划中，$A\ast$算法将搜索空间表示为网格的形式，网格的顶点作为航迹点，通过搜索邻域内代价函数最小的航迹点，逐步搜索至目标点，然后通过回溯得到最优航迹。采用OPEN表和CLOSE表分别存储待扩展航迹点和已扩展航迹点，其中代价函数为：</p>
<script type="math/tex; mode=display">f\left( x \right) = g\left( x \right) + h\left( x \right) \tag{3.1.6}</script><p>其中$g\left( x \right)$为起始点到当前航迹点的实际代价，$h\left( x \right)$为启发函数，代表当前航迹点到目标点的估算代价，常用欧氏距离、曼哈顿距离等，而$A\ast$算法的核心就是启发函数，选取合适的启发函数，平衡计算时间和最优解的选取，能有效提高航迹规划性能，若$h\left( x \right)$始终等于实际代价，此时$A\ast$算法严格遵守最优路径搜索，搜索效率也最高。</p>
<p>$A\ast$作为直接搜索算法，搜索性能好、准确度高；但随着搜索空间的增大，航迹点不断增多，计算时间呈指数上升，规划时间大幅增加，不适用于实时规划。在航迹规划问题中，如何提高$A\ast$算法的计算速度，是研究的重点内容，出现众多基于$A\ast$算法的改进方法运用于无人机航迹规划。使用2.5维网格模型描述三维规划空间[11]，简化三维空间的坐标表示，改进后的效率要远大于三维网格划分方式。同样也可将三维航迹规划分解为二维规划和高度规划[12]，使用动态时间规整(Dynamic Time Warping, DTW)距离作为$A\ast$算法的启发函数进行二维规划，再由二维航迹结合高程数字地图，利用粒子沉降法赋予每个航迹点高度信息，生成三维航迹，能够在不改变搜索空间的条件下，大大减少搜索的航迹点数量，缩短规划时间。但航迹规划问题的复杂性，虽然学者们通过各种改进方法提高了$A\ast$算法的搜索效率，仍没有找到值恒等于从当前节点到目标点真实代价的启发函数，实现$A\ast$算法的高效最优搜索。</p>
<h2 id="3-2-现代智能算法"><a href="#3-2-现代智能算法" class="headerlink" title="3.2  现代智能算法"></a>3.2  现代智能算法</h2><p>受到自然界的生物规律启发，出现的许多智能算法也被广泛应用于无人机航迹规划问题。现代智能航迹规划算法主要有、遗传算法、蚁群优化算法和粒子群优化算法等。</p>
<h3 id="3-2-1-蚁群优化算法"><a href="#3-2-1-蚁群优化算法" class="headerlink" title="3.2.1  蚁群优化算法"></a>3.2.1  蚁群优化算法</h3><p>蚂蚁在觅食过程中会释放信息素来标记自己的路径，随着时间的推移，信息素回越来越多，同样也会存在着挥发使其减少，其他蚂蚁利用剩余的信息素来寻找食物，这就是蚁群算法的生物原理。蚁群算法正是使用这种原理，采取正反馈机制使搜索过程不断逼近最优解。</p>
<p>下面是关于蚁群算法的相关定义，其中$T$时刻蚂蚁$n$从节点$a$转移到节点$b$的概率可以表示为</p>
<script type="math/tex; mode=display">P_{ab}^n\left( t \right) = \left\{
\begin{array}{lrl}
   {{{\left( {{\tau _{ab}}} \right)}^\alpha }{{\left( {{\eta _{ab}}} \right)}^\beta }} \over {\sum\limits_{b \in S_a^n} {{{\left( {{\tau _{ab}}} \right)}^\alpha }{{\left( {{\eta _{ab}}} \right)}^\beta }}} & & {b \in S_a^n}  \\
   0 &  & {Otherwise} 
\end{array}
\right. \tag{3.2.1}</script><p>其中${{\tau _{ab}}}$为节点$b$上的信息素浓度；${{\eta _{ab}}}$为节点$a$与节点$b$之间的启发函数，可以说距离开销或者其他组合如高度、安全度等；$\alpha $、$\beta $为${{\tau _{ab}}}$和${{\eta _{ab}}}$的相对重要性权重；$S_a^n$为节点$a$的所有邻居节点的集合。</p>
<p>针对信息素随着时间会挥发的现象，采用局部更新和全局更新的方式更新信息素的浓度。</p>
<p>局部更新是指当蚂蚁完成一个航迹点的选择后，降低次点对其他蚂蚁的吸引程度，以避免陷入局部最优解，更新公式为</p>
<script type="math/tex; mode=display">{\tau _{ab}}\left( {t + 1} \right) = \left( {1 - \xi } \right){\tau _{ab}}\left( t \right) \tag{3.2.2}</script><p>式中$\xi $为局部信息素挥发因子，用于减少此航迹点的吸引程度。</p>
<p>全局更新是指经过$m$时刻后，对蚂蚁完成一段航迹上所有的航迹点进行信息素挥发，更新公式为</p>
<script type="math/tex; mode=display">{\tau _{ab}}\left( {t + m} \right) = \left( {1 - \rho } \right){\tau _{ab}}\left( t \right) + \rho \Delta {\tau _{ab}} \tag{3.2.3}</script><script type="math/tex; mode=display">\Delta {\tau _{ab}} = Q/J \tag{3.2.4}</script><p>式中$\rho $为全局信息素挥发因子；$J$为此条航迹的性能指标，$Q$为性能指标对于信息素更新的贡献比例。</p>
<p>蚁群优化算法只要对模型稍加修改就能应用于不同的规划场景，具有较强的鲁棒性，同样也是基于种群的算法，具有良好的并行性。但其初始信息素匮乏，初始的前进方向具有盲目性，搜索时间较长，并且容易出现停滞状况，在局部最优解停留而无求得全局最优解。基于无人机航迹规划在不同环境下的特点，学者通常从以上缺陷入手对蚁群优化算法进行改进。陈侠等人[13]采用几何优化算法消除了传统蚁群算法搜索随机性导致最后结果并非最优解问题，采用指标函数和自适应参数分别解决了航迹不平滑和容易陷入局部最优问题。使用差分进化算法对信息素浓度的更新进行修改，合理分配信息素以免某一路径上的信息素浓度过高而导致陷入在局部最优解[14]，此种改进在不影响蚁群算法优点的同时又能够加快算法收敛，但会导致航迹长度明显增加。同样也是基于信息素浓度过大或过小会产生影响，在信息素调整规则中引入航迹评价指标，并且将起始点和目标点之间的连线这一最短航迹信息反馈到系统中作为搜索的指导信号[15]，有效降低了算法寻找航迹的盲目性，加快了搜索效率。</p>
<h3 id="3-2-2-遗传算法"><a href="#3-2-2-遗传算法" class="headerlink" title="3.2.2  遗传算法"></a>3.2.2  遗传算法</h3><p>“适者生存”的原则让生物在自然界的选择下逐渐向更适合生存的方向进化和变异，遗传算法也是基于这种原理诞生的启发式搜索算法。其思想借鉴生物的进化，根据染色体对应个体适应度越高越容易被选择的原则，从整个种群中选择一个父方和一个母方，对父方和母方抽取染色体交叉产生的后代染色体进行变异，然后按照之前步骤选择新的父方和母方并对新产生的子代染色体进行变异，直到产生新的种群。在无人机航迹规划问题中，遗传算法的每条染色体代表无人机的一条航迹，基因的编码方式也就是航迹节点的编码方式。基于概率的遗传算法有着优秀的性能，有着较强的鲁棒性，是一种高效、并行且全局的搜索方法，适用于三维的全局航迹规划，但收敛速度慢，算法效率低，容易过早收敛。</p>
<p>针对以上问题，部分学者对遗传算法进行了算法的改进。针对遗传算法初始种群的单一性问题，引入按照概率划分的小生存环境协同进化策略[16]并对种群进行动态调整，采用精英机制保留各代最优个体进行更新，有效提高了遗传算法的稳定性和精度。病毒遗传算法[17]采用定长实值和变长实值两种编码方式分别为染色体和病毒个体编码，通过采用反转录和转导这两种病毒感染操作实现两个种群间模块的信息交换，使进化信息在种群内迅速、定向地传播，消除了寻优过程的盲目性，改善了遗传算法早熟和局部收敛慢的问题，提高了收敛速度。</p>
<h3 id="3-2-3-粒子群优化算法"><a href="#3-2-3-粒子群优化算法" class="headerlink" title="3.2.3  粒子群优化算法"></a>3.2.3  粒子群优化算法</h3><p>将无人机航迹规划比作鸟群在森林中搜索食物，目标点就是要找到食物最多的地方，所有的鸟都不知道食物具体在哪个位置，只能感受到食物大概在哪个方向。每只鸟沿着自己判定的方向进行搜索，并在搜索的过程中记录自己曾经找到过食物且量最多的位置，同时所有的鸟都共享自己每一次发现食物的位置以及食物的量，这样鸟群就知道当前在哪个位置食物的量最多。在搜索的过程中每只鸟都会根据自己记忆中食物量最多的位置和当前鸟群记录的食物量最多的位置调整自己接下来搜索的方向。经过一段时间后鸟群就可以确定森林中食物最多的地方也就是找到了全局的最优解。</p>
<p>粒子群优化算法就是模拟鸟群飞行捕食行为，把每个粒子看作优化问题的一个可行解，每个粒子通过跟踪本身找到的局部最优解和种群中其他例子找到的全局最优解来确定下一步搜索区域。</p>
<p>粒子群算法的速度和位置更新方式分别为</p>
<script type="math/tex; mode=display">{v_{ij}}\left( {k + 1} \right) = w{v_{ij}}\left( k \right) + {c_1}{r_1}\left( {{p_{ij}}\left( k \right) - {x_{ij}}\left( k \right)} \right) + {c_2}{r_2}\left( {{g_{ij}}\left( k \right) - {x_{ij}}\left( k \right)} \right) \tag{3.2.5}</script><script type="math/tex; mode=display">{x_{ij}}\left( {k + 1} \right) = {x_{ij}}\left( k \right) + {v_{ij}}\left( k \right) \tag{3.2.6}</script><p>式中下标$i$、$j$、$k$分别代表第$i$个粒子、第$j$维空间、第$k$代粒子；$w$为惯性权重，描述了粒子对之前速度的“继承”；${c_1}$、${c_2}$为学习因子，提现粒子向全局最优粒子学习的特性；${r_1}$、${r_1}$为$\left( {0,1} \right)$的随机数。</p>
<p>粒子群优化算法与其他智能算法相比，最显著的特点就是没有“优胜劣汰”的机制，所有粒子在迭代过程中都会作为种群的成员保留。粒子群算法的优点就是具有较强的鲁棒性，对种群的大小敏感度不高，参数少，收敛速度快，但缺点也很明显，后起收敛速度慢，容易陷入局部最优解，通常学者对粒子群算法的改进集中在提高种群多样性来避免局部最优问题。在基本PSO算法中引入病毒种群[18]可以增强主群体粒子的多样性，提高局部搜索能力，解决基本PSO算法容易陷入局部最优、收敛速度慢的问题。</p>
<h2 id="3-3-机器学习算法"><a href="#3-3-机器学习算法" class="headerlink" title="3.3  机器学习算法"></a>3.3  机器学习算法</h2><p>随着人工智能技术的发展，在无人机航迹规划与跟踪领域都出现了一系列基于机器学习的模型。基于深度强化学习理论出现了大量的协同航迹规划方法，但有部分存在求解时间过长，不适用于在线应用的问题，而无人机飞行的实时性也是一个重要问题。基于数据驱动的非参数模型具有较强的非线性建模能力，在对不确定性目标的跟踪中有着较好的预测性能。</p>
<h3 id="3-3-1-基于Q学习的无人机航迹规划算法"><a href="#3-3-1-基于Q学习的无人机航迹规划算法" class="headerlink" title="3.3.1  基于Q学习的无人机航迹规划算法"></a>3.3.1  基于Q学习的无人机航迹规划算法</h3><p>Q学习（Q-learning）算法是一种与模型无关的强化学习算法，以马尔科夫决策过程（Markov Decision Processes, MDPs）为理论基础。标准的马尔可夫模型决策过程可用一个五元组$\left\langle {S,A,P,R,\gamma } \right\rangle $来表示，其中：$S$代表离散有界的状态空间，$A$代表离散的动作空间，$P$为状态转移概率函数，$R$为回报函数，$\gamma $是折扣因子，用于确定延迟回报和立即回报的相对比例，越大表示延迟回报的重要程度越高。协同航迹规划问题就是基于马尔可夫模型，采取动作能够获得收益，当前环境根据飞行器的动作反馈相应的回报，算法的主要思想就是选取能够获得长期积累值${V^\pi }\left( {{s_t},{a_t}} \right) = E\left[ {\sum\limits<em>{i = 0}^\infty  {{\gamma ^i}r\left( {{s_{i + t}},{a</em>{i + t}}} \right)} } \right]$数学期望最大值，其中策略$\pi $只和状态有关而与事件无关，${s<em>t}$是$t$时刻的环境状态，$a</em>{t}$是$t$时刻选择的动作。</p>
<p>根据贝尔曼Bellman方程，得到最优策略指标：${V^ * }\left( x \right) = \mathop {\max }\limits<em>{a \in A} \left[ {R\left( {s,a} \right) + \gamma \sum\limits</em>{{S^{'}} \in S} {{P_{s,a}}\left( {s^{‘}} \right)V\left( {s^{‘}} \right)} } \right]$，其中$R\left( {s,a} \right)$是$r\left( {{s_t},{a_t}} \right)$的数学期望${P_{s,a}}\left( {s^{‘}} \right)$是状态$s$下选取动作$a$后转移到下一状态$s^{‘}$的概率，而有些环境中状态之间的转移概率$P$较难获得，而Q学习不需要获取转移概率$P$，因而可用来解决具有马尔可夫性质的问题。</p>
<p>Q学习是一种基于数值迭代的动态规划算法，与环境无关。定义Q函数作为评估函数：$Q\left( {s,a} \right) = R\left( {s,a} \right) + \gamma {V^ \ast }$，即从状态$s$开始选择第一个动作$a$执行后获得的最大累积回报的折算值，也就是立即回报值$R\left( {s,a} \right)$加上遵循最优策略的折算值，此时最优策略可以写成${\pi ^ {\ast} }\left( s \right) = \arg \mathop {\max }\limits_A Q\left( {{s_{t}},a} \right)$，也就是说如果agent用Q函数替代${V^\pi }$就可以不考虑转移概率$P$，而只考虑当前状态$s$的所有可供选择状态$a$，从中选出使$Q\left( {{s_{t}},a} \right)$最大的动作，即agent对当前状态的部分Q值做出多次反应，就能够选出动作序列使得全局最优。</p>
<p>Q学习通过对环境的不断探索，积累历史经验，agent通过不断试错来强化自身，最终可以达到自主选择最优动作的目标，即不论出于何种状态，都可给出到达目标状态的最优选择路径，该算法中环境和动作相互影响，动作的选择影响环境状态，环境也可以通过强化回报函数来反馈动作的优劣性，影响动作的选择。</p>
<h3 id="3-3-2-基于循环神经网络的无人机航迹跟踪算法"><a href="#3-3-2-基于循环神经网络的无人机航迹跟踪算法" class="headerlink" title="3.3.2  基于循环神经网络的无人机航迹跟踪算法"></a>3.3.2  基于循环神经网络的无人机航迹跟踪算法</h3><p>传统的神经网络中，输入和输出彼此独立，循环神经网络（Recurrent Neural Network, RNN）可以有效处理序列数据，适合处理与时序相关的问题，无人机目标跟踪问题也是其位置随着时间动态变化的问题，可以简化为坐标、速度、加速对随时间动态变化，采用循环神经网络对其下一时刻的各参量进行预测，结合传统的目标跟踪模型，能够有效提高跟踪准确率。</p>
<p>在训练模型时将目标的绝对坐标输入，将期望输出目标的绝对坐标作为标签实现预测，但这样的方法应用到实际场景中难以到达较高的预测精度，因为模拟场景的坐标集为有限集，而实际场景的坐标集为无限集，无法训练所有实际场景中的坐标。将基于循环神经网络的算法用于传统的基于KF滤波算法的运动模型预测，利用循环神经网络对$k$时刻和$k-1$时刻的平均速度和 时刻瞬时速度进行计算，获取目标的绝对坐标，可以有效避免该问题。</p>
<p>记目标运动轨迹长度为$N$，令$ L_{1:N}^i = \left{ {{c_{r,k}},k = 1:N} \right} $</p>
<p>由于期望输出的目标$k-1$时刻和$k$时刻之间平均速度${\bar v_{r,k|k - 1}}$与坐标数据没有时序关联，使用下式对坐标数据进行差分处理，将输入坐标转化为平均速度：</p>
<script type="math/tex; mode=display">{\bar v_{r,k|k - 1}} = {c_{r,k}} - {c_{r,k - 1}} \tag{3.3.1}</script><p>由于目标的瞬时速度与期望输出的平均速度存在时序联系，将瞬时速度作为输入增加一维信息以提高预测精度，此时预测平均速度的LSTM第$j$个输入向量为：</p>
<script type="math/tex; mode=display">{\bar I_{L,j}} = \left\{ {{{\bar v}_{r,k|k - 1}},{v_{r,k}},k = j:{W_L} + j - 1} \right\} \tag{3.3.2}</script><p>对应标签为${\bar v_{r,{W_L} + j|{W_L} + j - 1}}$</p>
<p>相似的，使用滑动窗口从速度集$V_{1:N}^i$提取长度为${W_V}$的速度数据，得预测瞬时速度的LSTM模型第$j$个输入分量为：</p>
<script type="math/tex; mode=display">{I_{V,j}} = \left\{ {{v_{r,k}},k = j:{W_V} + j - 1} \right\} \tag{3.3.3}</script><p>对应标签为${v_{r,{W_V} + j|{W_V} + j - 1}}$。考虑到$k$时刻以前的几个时刻的瞬时速度存在与期望输出的$k$时刻瞬时预测速度存在时序关联性，无需额外处理直接使用LSTM建立映射关系。</p>
<p>经过LSTM模型的训练，对目标的平均速度和瞬时速度进行预测，将得到的预测值输入传统的KF滤波模型得到最终的最终估计和速度估计，重复每个坐标点的步骤最终得到对目标的连续跟踪。</p>
<h2 id="4-未来展望"><a href="#4-未来展望" class="headerlink" title="4  未来展望"></a>4  未来展望</h2><p>在无人机航迹规划研究领域，主要的研究包括新算法的提出，已有算法的改进，多算法融合以及大规模多无人机协同等方面。经过多年的发展，对现有算法的改进已经较为成熟，新出现的算法多集中于受生物规律启发的智能算法已经人工智能领域算法的应用。</p>
<h3 id="4-1-多无人机协同航迹规划"><a href="#4-1-多无人机协同航迹规划" class="headerlink" title="4.1  多无人机协同航迹规划"></a>4.1  多无人机协同航迹规划</h3><p>多架无人机之间协同进行的航迹规划不同于单无人机体系，约束条件大为增加，群体之间的时空协同性尤为关键。除了单无人机体系需要考虑的威胁源、环境障碍，多无人机体系还增加了机群碰撞处理、多机协同通信等棘手问题。相较于单无人机，多无人机协同执行飞行任务效率更高，能更好地处理突发事件，多无人机集群在其中部分无人机无法继续执行任务需要返航时时，仍然能够继续完成任务。尽管多无人机协同航迹规划将问题带到了一个新的高度，但多机协同能够带来众多优势，此必将是未来发展的大趋势。</p>
<h3 id="4-2-多算法融合"><a href="#4-2-多算法融合" class="headerlink" title="4.2  多算法融合"></a>4.2  多算法融合</h3><p>各种经典算法和智能算法都有其优势和不足，多算法融合能够将现有算法进行融合使用，有效弥补所融合算法的缺陷。例如使用遗传算法和稀疏$A\ast$算法融合的方法在线规划航迹，改进的遗传算法用于全局规划，稀疏$A\ast$算法用于应对突发情况，，结合两者的优势，能够很好的做到系统任务的兼容。又例如使用$A\ast$算法弥补模拟退火算法耗时太长的问题，进一步结合改善求解质量。多算法融合的目的就是为了将多种算法相结合，取长补短弥补不足，往往比提出新算法来的更便捷且有效，从而更好地规划无人机航迹。</p>
<h2 id="bell-参考文献"><a href="#bell-参考文献" class="headerlink" title=":bell:参考文献"></a><span class="github-emoji"><span>🔔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f514.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>参考文献</h2><p>[1] 路晶, 史宇, 张书畅, 邓劲礼. 无人机航迹规划算法综述[J]. 航空计算技术, 2022, 52(04): 131-134.</p>
<p>[2] 韩攀, 陈谋, 陈哨东等. 基于改进蚁群算法的无人机航迹规划[J]. 吉林大学学报: 信息科学版, 2013, 31(1): 66-72.</p>
<p>[3] 胡中华, 赵敏, 姚敏等. 无人机航迹规划技术研究及发展趋势[J]. 航空电子技术, 2009, 40(2): 24-29.</p>
<p>[4] Kathib O. Real-time Obstacle Avoidance for Manipulators and Mobile Robots[M]. New York: Springer New York, 1986.</p>
<p>[5] CHEN X, ZHANG J. The Three-Dimension Path Planning of UAV Based on Improved Artificial Potential Field in Dynamic Environment[C] International Conference on Intelligent Human-Machine Systems and Cybernetics. Tlemcen, Algeria: IEEE, 2013: 144-147.</p>
<p>[6] 王强, 张安, 吴忠杰. 改进人工势场法与模拟退火算法的无人机航路规划[J]. 火力与指挥控制, 2014(8): 70-73.</p>
<p>[7] 姚远, 周兴社, 张凯龙等. 基于稀疏A∗搜索和改进人工势场的无人机动态航迹规划[J]. 控制理论与应用, 2010, 27(7): 953-959.</p>
<p>[8] DONG S, ZHU X, LONG G. Cooperative Planning Method For Swarm UAVs Based on Hierarchical Strategy[C] International Conference on System Science, Engineering Design and Manufacturing Informatization. Pacific Grove, CA, USA: IEEE, 2012: 304-307.</p>
<p>[9] MAINI P, SUJIT P B. Path Planning for a UAV with Kinematic Constraints in the Presence of Polygonal Obstacles[C] International Conference on Unmanned Aircraft Systems. Arlington, VA, USA: IEEE, 2016: 62-67.</p>
<p>[10]邱福生, 杨建平, 邵绪威. 基于遗传模拟退火算法的无人机航迹规划[J]. 沈阳航空航天大学学报, 2014, 31(1): 16-19.</p>
<p>[11]占伟伟, 王伟, 陈能成等. 一种利用改进A∗算法的无人机航迹规划[J]. 武汉大学学报: 信息科学版, 2015, 40(3): 315-320.</p>
<p>[12]杨润洲, 丁勇, 张承果. 基于DTW 的改进A∗算法在航迹规划中的应用[J]. 电光与控制, 2016, 23(6): 5-10.</p>
<p>[13]陈侠，艾宇迪，梁红利． 基于改进蚁群算法的无人机三维航迹规划研究［Ｊ］． 战术导弹技术， 2019(2): 59-66. </p>
<p>[14]DUAN H, YU Y, ZHANG X, et al. Three-Dimension Path Planning for UCAV Using Hybrid Meta-Heuristic ACO-DE Algorithm[J]. Simulation Modelling Practice &amp; Theory, 2010, 18(8): 1104-1115.</p>
<p>[15]TAO J, WANG Y, YANG H, et al. Three-Dimensional Path Planning of Unmanned Aerial Vehicle under Complicated Environment[C] Control and Decision Conference. Big Sky, MT, USA: IEEE, 2016: 6377-6382.</p>
<p>[16]鱼佳欣, 李刚, 李东涛等. 改进量子遗传算法在无人机航迹规划中的应用[J]. 计算机仿真, 2015, 32(5): 106-109.</p>
<p>[17]俞琪, 刘新, 周成平等. 基于病毒遗传算法的快速航迹规划方法[J]. 宇航学报, 2011, 32(4): 756-761.</p>
<p>[18]吴天爱, 吴云玉, 别晓峰. 采用病毒粒子群优化算法的飞行器航迹规划[J]. 电光与控制, 2014, 21(8): 102-105.</p>
]]></content>
      <categories>
        <category>Literature review</category>
      </categories>
      <tags>
        <tag>UAV</tag>
        <tag>Track Planning</tag>
      </tags>
  </entry>
  <entry>
    <title>西藏自由行（青藏线-拉萨-山南-林芝）</title>
    <url>/2025/04/17/TibetRound1/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>西藏自由行（青藏线—&gt;拉萨—&gt;山南—&gt;林芝），历时10天，于2025年3月中旬自南京出发，途径甘肃兰州，青海西宁，青藏线，西藏拉萨、山南、林芝。</p>
<span id="more"></span>
<hr>
<h2 id="1-Tibet-自由行简要行程"><a href="#1-Tibet-自由行简要行程" class="headerlink" title="1. $ Tibet $ 自由行简要行程"></a>1. $ Tibet $ 自由行简要行程</h2><p>南京—&gt;兰州—&gt;西宁—&gt;青藏线—&gt;拉萨—&gt;山南羊卓雍措—&gt;林芝巴宜区—&gt;色季拉山口、鲁朗、巴松措、新措、雅鲁藏布大峡谷—&gt;重庆—&gt;南京</p>
<h2 id="2-详细行程"><a href="#2-详细行程" class="headerlink" title="2. 详细行程"></a>2. 详细行程</h2><ul>
<li><strong>Day 1</strong>：南京禄口机场出发，下午抵达兰州中川机场，整备行李餐食，乘动车前往西宁站，西宁站青藏线始发。</li>
<li><strong>Day 2</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>青藏线至拉萨，途经格尔木、昆仑山口、可可西里、沱沱河、唐古拉山口、那曲、当雄、羊八井等地，日落后抵达拉萨站。</li>
<li><strong>Day 3</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>药王山观景台，千佛摩崖石刻，甘珠尔塔，西藏博物馆，扎基寺，布达拉宫广场，天上邮局，八廓街</li>
<li><strong>Day 4</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>布达拉宫，拉鲁湿地国家级自然保护区</li>
<li><strong>Day 5</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>大昭寺；拉萨出发走G4218雅叶高速、349国道，经山南市贡嘎县岗堆镇普努村，过加若拉山口到羊卓雍措，走县道306线过东拉乡到日托寺，经扎玉扎寺到达喀庆拉山、鲁日拉山，约160公里，3.5-4小时车程；返程走县道305线，经张达乡、江雄村、朗杰学乡到贡嘎县，走349国道和雅叶高速返回拉萨，约170公里，3.5-4小时车程。</li>
<li><strong>Day 6</strong>：<span class="github-emoji"><span>☁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>拉萨城际铁路到林芝<span class="github-emoji"><span>☔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>；走G4218雅叶高速、318国道，<span class="github-emoji"><span>❄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2744.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>翻越色季拉山口到鲁朗镇，扎西岗村，约75公里，1.5小时车程；走318国道，雅叶高速暴雨<span class="github-emoji"><span>☔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，工布江达县巴松措，结巴村，暴雪<span class="github-emoji"><span>❄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2744.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，约200公里，4小时车程。</li>
<li><strong>Day 7</strong>：<span class="github-emoji"><span>☁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>结巴村驱车前往新措，约27公里，2小时车程，新措徒步往返7公里，约2小时；<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>新措返回结巴村遗忘码头；巴松措驱车前往雅鲁藏布大峡谷左岸<span class="github-emoji"><span>☔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，米林市派镇索松村<span class="github-emoji"><span>❄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2744.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，约220公里，4小时车程。</li>
<li><strong>Day 8</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>索松村至达林村徒步，单程约10公里，往返约4小时，返回林芝市区。</li>
<li><strong>Day 9-10</strong>：<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>乘机场大巴至林芝机场，经重庆转机返回南京。</li>
</ul>
<h2 id="3-全程纪实"><a href="#3-全程纪实" class="headerlink" title="3. 全程纪实"></a>3. 全程纪实</h2><ul>
<li>本文相关坐标，若非特别说明，均为国测局GCJ-02坐标系，其他部分为WGS-84坐标系。</li>
</ul>
<h3 id="3-1-南京—-gt-兰州—-gt-西宁—-gt-青藏线—-gt-拉萨"><a href="#3-1-南京—-gt-兰州—-gt-西宁—-gt-青藏线—-gt-拉萨" class="headerlink" title="3.1 南京—>兰州—>西宁—>青藏线—>拉萨"></a>3.1 南京—&gt;兰州—&gt;西宁—&gt;青藏线—&gt;拉萨</h3><blockquote>
<p>从烟雨江南一路向西北进发，从丘陵到平原一望无际，再到黄土沟壑纵横，抵达兰州中川机场T2，恰好赶上T2航站楼最后几天运营，即将启用T3航站楼。不得不说中川机场的设计，拿完行李出门就是城轨的入口。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/01兰州机场.JPG" alt="中川机场T2"></p>
<blockquote>
<p>机场出发拼车到兰州站，一路黄土，第一次见到黄河，吃碗正宗的兰州牛肉面，整备行李，出发！</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/02兰州牛肉面.JPG" alt="兰州牛肉面"></p>
<blockquote>
<p>Y971次列车，天路格桑花西宁站欢迎您。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/03西宁站站台.JPG" alt="西宁站站台"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/04Y971.JPG" alt="Y971"></p>
<blockquote>
<p>后半夜过<strong>察尔汗盐湖</strong>，灯火通明，卡车和路灯，睡梦中醒来感觉穿越到几十年前；<br>凌晨05:48抵达格尔木站，换美国进口内燃机车头，全车供氧，随车医生上车，下车擦车窗，四周已结冰。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/05格尔木站站台.JPG" alt="格尔木站站台"></p>
<blockquote>
<p>七点半左右蓝调时刻，雪国列车经过昆仑山口，窗外一片雪白，窗外<strong>玉珠峰</strong><code>(Yuzhu Peak, 35°39'8.53"N, 94°15'3.1"E, 6178m)</code>，昆仑山东段最高峰。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/06玉珠峰.JPG" alt="玉珠峰"></p>
<blockquote>
<p>即将进入昆仑山隧道</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/07昆仑山口.JPG" alt="昆仑山口"></p>
<blockquote>
<p>7:52昆仑山口日出<span class="github-emoji"><span>🌅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f305.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，照亮天际线。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/08雪山日出.JPG" alt="雪山日出"></p>
<blockquote>
<p>九点左右，可可西里无人区，青海、西藏、新疆交界的生命禁区，“守护可可西里，保护三江之源”。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/09可可西里.JPG" alt="可可西里"></p>
<blockquote>
<p>十一点左右，沱沱河，<strong>格拉丹东雪山</strong>冰川融雪滋养九州大地，汇入江海。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/10沱沱河.JPG" alt="沱沱河"></p>
<blockquote>
<p>随机刷新的藏野驴、藏牦牛</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/11野生动物.JPG" alt="野生动物"></p>
<blockquote>
<p>十二点多，翻越<strong>唐古拉山口</strong>，远处为<strong>唐古拉山龙匣宰陇巴</strong><code>(33°07'47.11"N, 92°01'51.72"E, 5940m)</code> <em>WGS-84</em>，科考队常于此钻探冰川破译“无字天书”，不久后经过青藏铁路海拔最高点5072米。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/12龙匣宰陇巴.JPG" alt="龙匣宰陇巴"></p>
<blockquote>
<p>下午两点，来到那曲市安多县境内，<strong>错那湖</strong>近在咫尺，铁路沿湖而过，海拔最高的淡水湖，冬春之交冰推。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/13错那湖.JPG" alt="错那湖"></p>
<blockquote>
<p>无人值守的底吾玛站。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/14底吾玛.JPG" alt="底吾玛"></p>
<blockquote>
<p>下午四点，那曲站ནག་ཆུ། ，在海拔四千五百米下车呼吸新鲜空气，兴奋掩盖了刺骨寒风。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/15那曲.JPG" alt="那曲"></p>
<blockquote>
<p>下午五点半，那曲县境内，列车右侧为念青唐古拉山脉中段，<strong>桑丹康桑峰</strong><code>(Samdain Kangsang, 30°50'12.98"N, 91°29'21.48"E, 6590m)</code>，主峰的辨识度极高。二十五位仙境居士之一，山神“夜叉岗布桑布”是法力无边的佛法保护神。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/16桑丹康桑.JPG" alt="桑丹康桑"></p>
<blockquote>
<p>列车驶过当雄，念青唐古拉山脉连绵不绝，藏语意为“灵应草原神”。临近七点，列车右侧是<strong>念青唐古拉峰</strong><code>(Nyainqêntanglha Feng, 30°22'57.47"N, 90°34'31.58"E, 7162m)</code>和<strong>念青唐古拉东南峰</strong><code>(Nyanchen Tanglha Southeast, 30°22'5.34"N, 90°36'2.92"E, 7046m)</code>，北麓是纳木错。强烈的第四纪冰川作用形成了陡峭的山岭，尤其西北坡山势笔直，陡峭异常，主峰顶部形似鹰嘴，多断岩峭壁。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/17念青唐古拉.JPG" alt="念青唐古拉"></p>
<blockquote>
<p>晚上八点半，列车驶过拉萨河，已可看见远处亮灯的布达拉宫，准点驶入拉萨站，历时21小时14分的青藏线结束。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/18拉萨站站台.JPG" alt="拉萨站站台"></p>
<h3 id="3-2-拉萨"><a href="#3-2-拉萨" class="headerlink" title="3.2 拉萨"></a>3.2 拉萨</h3><blockquote>
<p><strong>Day 3</strong>上午先到了药王山观景台，出发前还特意检查了钱包里的50元纸币，结果钱包没随身带。<br>走下观景台，左转绕一圈来到<strong>千佛摩崖石刻</strong>，信徒众多，几乎没有什么游客，跟着藏民们去<strong>甘珠尔塔</strong>。<br>继续向药王山高处走去，石壁上都是壁画，原计划去<strong>鲁普岩寺</strong>点酥油灯，逐渐发现和藏民的转经路线走反了，不能顺路到达，于是乎没去，<em>应当在观景台下山后右转</em>。</p>
<p>西藏博物馆，当天免费预约，在一楼的“离太阳最近的人—西藏民俗文化”展厅，主要是藏区各地的民俗文化，服饰、生产生活器具、节庆活动等，跟着讲解员的游客比较多，通风差，待久了感觉胸闷不适，赶紧到大厅缓一缓。二楼有解放西藏展厅，历朝历代的农奴制度、地方治理等内容较为详细。顶楼有观景露台，可以看到拉萨市区全景。</p>
<p>中午在<strong>光明岗琼甜茶馆</strong>喝1元一杯的甜茶，吃藏面搭配炸土豆，藏面比较硬，不一定所有人都吃得来。</p>
<p>回酒店休息后乘公交车前往<strong>扎基寺</strong>，免费参观，财神庙，香火旺盛。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/19扎基寺.JPG" alt="扎基寺"></p>
<blockquote>
<p>从扎基寺出来，想到早上漏掉了纸币的合影，于是继续坐公交到布达拉宫广场的<strong>前站酸奶坊</strong>，吃牦牛冰淇淋酸奶然后再去补卡。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/20五十元纸币.JPG" alt="五十元纸币"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/21布宫广场.JPG" alt="布宫广场"></p>
<blockquote>
<p>一路步行穿过八廓街，瞎逛回酒店，途径<strong>大昭寺</strong>，朝拜的信徒络绎不绝，十岁左右的两姐弟衣衫褴褛，绕着大昭寺磕长头。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/22大昭寺.JPG" alt="大昭寺"></p>
<blockquote>
<p><strong>Day 4</strong> 一大早出发布达拉宫！</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/23布宫脚下.JPG" alt="布宫脚下"></p>
<blockquote>
<p>下午原计划去大昭寺，但同行的搭子高反比较严重去医院输液打乱了行程，调整到了<strong>Day 5</strong> 一大早。<br>于是即兴前往<strong>拉鲁湿地国家级自然保护区</strong>，拍下这两张布达拉宫远景。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/24拉鲁湿地布宫.JPG" alt="拉鲁湿地布宫"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/25望远镜布宫.JPG" alt="望远镜布宫"></p>
<h3 id="3-3-山南羊卓雍措"><a href="#3-3-山南羊卓雍措" class="headerlink" title="3.3 山南羊卓雍措"></a>3.3 山南羊卓雍措</h3><blockquote>
<p>进藏第五天，自驾<strong>羊卓雍措</strong>。羊湖由亿年前冰川泥石流阻塞河道而形成，是藏南最大的封闭性内陆湖泊，西藏三大圣湖之一，湖面海拔4441米，面积638平方公里，湖水呈现出蓝色、绿色。<br>从普努村开始翻越<strong>加若拉山</strong>，随着盘山公路海拔急剧上升，山口狂风大作，山口经幡飘扬<code>(29°8'27.53"N, 90°49'18.83"E, 4700m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/26加若拉山口.JPG" alt="加若拉山口"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/27加若拉经幡.JPG" alt="加若拉经幡"></p>
<blockquote>
<p>翻越加若拉山口后就能看到远处的羊湖，下山左转来到羊湖岸边<code>(29°7'28.16"N, 90°44'3.48"E, 4443m)</code>，戴墨镜的白色藏獒（雪獒）被迫营业。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/28雪獒.JPG" alt="雪獒"></p>
<blockquote>
<p>湖水分层，一层层波浪起伏。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/29羊卓雍措湖岸.JPG" alt="羊卓雍措湖岸"></p>
<blockquote>
<p>远处是<strong>觉姆</strong><code>(29°16'34.10"N, 90°20'4.45"E, 6080m)</code>和<strong>觉波</strong><code>(29°15'2.41"N, 90°20'30.08"E, 6070m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/30羊湖湖岸人像.JPG" alt="羊湖湖岸人像"></p>
<blockquote>
<p>公厕每人两元，不过没有进去体验。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/31羊湖公厕.JPG" alt="羊湖公厕"></p>
<blockquote>
<p>沿县道306线过东拉乡贡嘎村，一路碎石颠簸，尘土飞扬，路况非常差，牛羊成群，小学生皮肤黝黑。<br>在东拉村附的近岔路口右拐小路，到达<strong>日托寺</strong>，门票20元，世界上最孤独的寺庙。<br>此时远处已有云雾缭绕，但无遮挡的地方，阳光还是非常强烈。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/32日托寺.JPG" alt="日托寺"></p>
<blockquote>
<p>离开日托寺继续向前，一样还是碎石，尘土，坑洼，约半小时后在主路左转进入扎余村，在扎玉扎寺继续左转，沿盘山公路而上约半小时，于下午五点半到达<strong>喀庆拉山</strong><code>(29°3'29.26"N, 90°54'18.90"E, 5200m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/33喀庆拉山.JPG" alt="喀庆拉山"></p>
<blockquote>
<p>春寒料峭，十级狂风。<strong>库拉岗日峰</strong><code>(Kula Kangri, 28°13'38.35"N, 90°36'54.94"E, 7538m)</code>，山南最高峰，库拉岗日是四大神山之一，绝佳视角被云雾遮挡。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/34喀庆拉山人像1.JPG" alt="喀庆拉山人像1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/35喀庆拉山人像2.JPG" alt="喀庆拉山人像2"></p>
<blockquote>
<p>山顶狂风不宜久留，返程下山，右侧岔路可到<strong>鲁日拉山</strong>。继续沿盘山公路而下，往朗杰学乡方向返回拉萨。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/36鲁日拉山.JPG" alt="鲁日拉山"></p>
<h3 id="3-4-林芝"><a href="#3-4-林芝" class="headerlink" title="3.4 林芝"></a>3.4 林芝</h3><h4 id="3-4-1-鲁朗"><a href="#3-4-1-鲁朗" class="headerlink" title="3.4.1 鲁朗"></a>3.4.1 鲁朗</h4><blockquote>
<p>一大早摸黑出发，从拉萨站乘坐拉萨城际铁路到林芝站，拉林铁路沿着<strong>雅鲁藏布江</strong>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/37拉林铁路旁的雅江.JPG" alt="拉林铁路旁的雅江"></p>
<blockquote>
<p>走318国道翻越<strong>色季拉山口</strong><code>(29°36'38.20"N, 94°39'5.87"E, 4556m)</code>，云雾大，未能见到远处的纳迦巴瓦，下起了小雪，路面湿滑，大车比较多，爬坡行驶缓慢。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/38色季拉山口.JPG" alt="318国道色季拉山口"></p>
<blockquote>
<p>路旁刷新几只野猴，在吃游客投喂的食物，本不该打扰它们的。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/39野猴.JPG" alt="318国道野猴"></p>
<blockquote>
<p>翻越山口后下山就是鲁朗，在扎西岗村稍作停留，农场和雪山让人心旷神怡，远处山峰后面是被云雾遮挡的<strong>支巴岗日</strong><code>(29°49'26.65"N, 94°52'17.40"E, 6846m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/40鲁朗.JPG" alt="鲁朗"></p>
<h4 id="3-4-2-巴松措、新措"><a href="#3-4-2-巴松措、新措" class="headerlink" title="3.4.2 巴松措、新措"></a>3.4.2 巴松措、新措</h4><blockquote>
<p>从鲁朗返程已接近五点，雅叶高速上暴雨，到工布江达县雨停了，天也黑了。<br>临近巴松措，又开始下雨，逐渐转为下雪，越往山里雪越大，晚上九点多到达民宿入住，民宿院子里的经幡。<br>放了半小时的热水仍然是冰凉的，洗了个冷水澡，好在民宿都有取暖器，没感冒也没高反。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/41巴松措经幡.JPG" alt="巴松措经幡"></p>
<blockquote>
<p>一晚上的狂风暴雪，经幡在第二天早上塌了，暴雪压断线路，断网断电，驱车前往<strong>新措</strong>。<br>本就是坑坑洼洼的非铺装路面，泥地积雪打滑，好几处上坡冲了好几次才上去，中午返程时路上居然都干了，太阳辐射强导致融雪也非常快。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/42出发新措.JPG" alt="出发新措"></p>
<blockquote>
<p>新措收取清洁费10元，加上巴松措门票淡季60，自认为这当中的大部分应当给新措才对。<br>冬春独有的雪景，和夏季的草甸牧场截然不同。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/43新措起点.JPG" alt="新措起点"></p>
<blockquote>
<p>徒步强度相对较小，往返7公里，一个多小时可以完成，但积雪比较厚，白天仍然飘着小雪，需要登山靴和冲锋衣。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/44新措人像1.JPG" alt="新措人像1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/45新措人像2.JPG" alt="新措人像2"></p>
<blockquote>
<p>牦牛成群，近距离靠近不会有危险，原始森林里的牦牛会主动往密林深处避开人群。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/46牦牛.JPG" alt="牦牛"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/47一群牦牛.JPG" alt="一群牦牛"></p>
<blockquote>
<p>新措岸边，远处雪山被遮挡，雪后的湖水清澈见底，夏季应该呈蓝绿色。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/48新措岸边.JPG" alt="新措岸边"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/49新措人像3.JPG" alt="新措人像3"></p>
<blockquote>
<p>密林深处积雪到小腿。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/50积雪.JPG" alt="积雪"></p>
<blockquote>
<p>直接躺下。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/51新措人像4.JPG" alt="新措人像4"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/52新措人像5.JPG" alt="新措人像5"></p>
<blockquote>
<p>徒步结束，驱车返回，<strong>巴松措遗忘码头</strong><code>(30°0'35.24"N, 93°58'19.45"E)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/53巴松措1.JPG" alt="巴松措1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/54巴松措2.JPG" alt="巴松措2"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/55巴松措人像.JPG" alt="巴松措人像"></p>
<blockquote>
<p>从遗忘码头离开时已经是下午两点多，结巴村仍然处于断电断网状态，只能开出巴松措景区找吃的，吃完后赶往雅江峡谷。<br>雨夜到达<strong>索松村</strong>，门票150元，途中被川牌大众急转弯强行加塞，遂截停讨要说法。<br>索松村雪夜觅食，找了一家藏餐，咖喱鸡饭，牛肉包子，奶茶，只有奶茶还挺好。<br>边上的酒吧震天响，真的很难想象世外桃源会这样。</p>
</blockquote>
<h4 id="3-4-3-雅鲁藏布大峡谷"><a href="#3-4-3-雅鲁藏布大峡谷" class="headerlink" title="3.4.3 雅鲁藏布大峡谷"></a>3.4.3 雅鲁藏布大峡谷</h4><blockquote>
<p>早晨依然在下雨下雪，九点多的时候开太阳了<span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，立即收拾装备往峡谷岸边走，桃花<code>(29°34'21.65"N, 94°53'35.16")</code>和远处的<strong>多雄拉雪山</strong><code>(29°25'20.21"N, 94°54'2.05"E, 5780m)</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/56桃花和多雄拉.JPG" alt="桃花和多雄拉"></p>
<blockquote>
<p>继续沿着雅鲁藏布江的河岸往前走，来到自认为在索松村能到达的最佳观景地点<code>(29°34'30.61"N, 94°53'38.54"E)</code>，位于桃花林的尽头，工作人员正在加急装护栏。<br>前方是雅鲁藏布江和<strong>南迦巴瓦</strong><code>(Namcha Barwa, 29°38'2.76"N, 95°3'34.38"E, 7782m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/57雅江和纳迦巴瓦.JPG" alt="雅江和纳迦巴瓦"></p>
<blockquote>
<p>背后是雅江和多雄拉。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/58雅江和多雄拉.JPG" alt="雅江和多雄拉"></p>
<blockquote>
<p>原计划是开车进达林村，但同行的搭子又闹了幺蛾子，得亏体力还行，收拾好行李寄存在前台，带上轻装背包独自徒步进<strong>达林村</strong>，预估来回四小时。紧贴峡谷向前，可以看到纳迦巴瓦近在眼前，全景非常震撼。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/59纳迦巴瓦全景.JPG" alt="纳迦巴瓦全景"></p>
<blockquote>
<p>拐弯处可见近景的冰川。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/60纳迦巴瓦近景.JPG" alt="纳迦巴瓦近景"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/61南迦巴瓦人像.JPG" alt="南迦巴瓦人像"></p>
<blockquote>
<p>临近达林村，背后是南迦巴瓦峰和很具有辨识度的<strong>乃彭峰</strong><code>(Napung Peak, 29°37'1.2"N, 95°3'15.7"E, 7043m)</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/62达林村人像.JPG" alt="达林村人像"></p>
<blockquote>
<p>达林村相较于峡谷更外侧的村落要原始的多，秃鹫正在进食。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/63秃鹫1.JPG" alt="秃鹫1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/64秃鹫2.JPG" alt="秃鹫2"></p>
<blockquote>
<p>终于在达林村，有幸见到了<strong>加拉白垒</strong><code>(Gyala Peri, 29°48'51.62"N, 94°58'11.14"E, 7294m)</code>，念青唐古拉山脉的最高峰，在两侧山林的映衬下更加洁白，蓝天白云下的冰淇淋，隔着雅鲁藏布江与喜马拉雅山脉的纳迦巴瓦对峙。“加拉”取自加拉村，“白垒”意为高峰。<br>传说作为哥哥的纳迦巴瓦觊觎日益雄伟的加拉白垒，砍去弟弟的头颅，化作多雄拉雪山。<br>抛开传说，这两座雪山更像是在镇守着雅鲁藏布江。<br>加拉白垒峰的左侧紧贴着是<strong>白拉日</strong><code>(29°49'4.12"N, 95°57'42.80"E, 7100m)</code>；侧峰是<strong>森塘布</strong><code>(Sendapu, 29°50'23.1"N, 94°56'36.31"E, 6812m)</code>，尚未登峰。</p>
</blockquote>
<ul>
<li><strong>力古冬果冰川</strong>冰舌附近海拔2664米，距离加拉白垒峰直线距离6.2公里，落差达到四千六百米，比降达到86%，国内极大落差第一位。十余年前曾有十余人队伍穿越雅鲁藏布大峡谷左岸加拉白垒线，曾在力古冬果冰川<code>(29°47.072'N, 95°00.121'E, 3677M)</code>附近扎营。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/65加拉白垒.JPG" alt="加拉白垒"></p>
<ul>
<li>下午三点左右，准备从达林村返回索松村，再驾车回市区，同行搭子继续犯幺蛾子，被告知开着车先出村了。</li>
<li><strong>高原、峡谷、村落、牦牛、秃鹫</strong>，无法理解是何等的心智不成熟可以做出这种事，只能抱着试一试的心态联系民宿老板，回到索松村预计四点半，请求帮忙联系出村的司机，但被告知下午很少有出村的，大多都是上午出村。</li>
<li>遂做好最坏的打算，一边继续往峡谷外走，一边开始退当晚在林芝的酒店，准备改签第二天的机票。</li>
<li>幸运会眷顾有心之人，在Mammut猛犸象的守护下没有被秃鹫和野牦牛袭击，圣洁的Gyala Peri也保佑我很幸运地遇到了从达林村去派镇办事的村民小哥，将我带回了索松村，也顺便请他带我拿上行李回到派镇客运中心，很热情地帮我联系了派镇的线路车司机，一路和小哥聊着藏区和沿海城市的差异，也邀请他有机会来杭州。</li>
<li>搭上了从派镇回林芝市区的最后一班车，沿着雅江和尼洋河驶出峡谷，天黑前顺利回到了市区，筋疲力尽，吃了石锅鸡作为在西藏的最后一顿。</li>
<li>引用高中时一位数学老师的话“<strong>我简直是无法理解，难以想象</strong>”来形容这天的经历，既有见到纳迦巴瓦和加拉白垒的幸运，也有同行搭子的愚蠢，更有来不及看日照金山的遗憾，这遗憾和愚蠢的教训就当是下次进藏最好的经验吧。</li>
</ul>
<h4 id="3-4-4-飞机视角雪山"><a href="#3-4-4-飞机视角雪山" class="headerlink" title="3.4.4 飞机视角雪山"></a>3.4.4 飞机视角雪山</h4><blockquote>
<p>米林机场非常小，起飞和降落窗口基本都在上午，午后降落容易出现大雾，峡谷降落难度极大；军民两用，起飞滑行时还看到了翼龙。</p>
<p>起飞从峡谷迅速爬升飞至鲁朗上空，五千米遥望<strong>南迦巴瓦</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/66高空纳迦巴瓦.JPG" alt="高空纳迦巴瓦"></p>
<blockquote>
<p>六千五百米遥望<strong>南迦巴瓦、加拉白垒同框</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/67高空纳迦巴瓦和加拉白垒.JPG" alt="高空纳迦巴瓦和加拉白垒"></p>
<blockquote>
<p>继续爬升到八千米，来到加拉白垒西北侧，冰川右侧是<strong>支巴岗日</strong><code>(29°49'26.65"N, 94°52'17.40"E, 6846m)</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/68支巴岗日.JPG" alt="支巴岗日"></p>
<blockquote>
<p>近九千米可以看到完整的<strong>加拉白垒北坡冰川</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/69加拉白垒北坡冰川.JPG" alt="加拉白垒北坡冰川"></p>
<blockquote>
<p>稍后可见<strong>雅鲁藏布大峡谷，完整的南迦巴瓦北坡和加拉白垒峰</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/70雅江峡谷和南迦巴瓦加拉白垒北坡.JPG" alt="雅江峡谷和南迦巴瓦加拉白垒北坡"></p>
<blockquote>
<p>四川省甘孜州巴塘县甲英镇上空，前方是凶险的金沙江；<br>远处是梅里雪山，<strong>卡瓦格博</strong><code>(Kawagarbo, 28°26'18.31"N, 98°40'56.06"E, 6740m)</code>，上世纪九十年代数次登峰失败，“卡瓦”意为雪，“格博”意为白色，藏族神山，2001年登山禁令；<br>右侧是<strong>他念他翁山脉</strong>，最高峰<strong>大米勇</strong><code>(Damiyong, 29°10'53.65"N, 98°27'36.22"E, 6324m)</code>，属横断山脉，是唐古拉山的南延，山体险峻挺拔，风化破碎严重，犹如一堵高墙分割澜沧江和怒江，<strong>藏东南秘境徒步线路</strong>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/71梅里雪山卡瓦格博和金沙江.JPG" alt="梅里雪山卡瓦格博和金沙江"></p>
<blockquote>
<p>四川省甘孜州康定市上空，飞机正下方是<strong>大渡河</strong>和<strong>夹金山</strong><code>(Jiajin Shan, 30°35'15.22"N, 102°10'6.82"E, 5734m)</code>，“长征万里险，最忆夹金山”，35年6月强渡大渡河飞夺泸定桥后，最艰难的正是这长征路上的第一座大雪山。<br>远处最高峰是<strong>木雅贡嘎</strong><code>(Minya Konka, 29°35'45.76"N, 101°52'44"E, 7508.9m)</code>，贡嘎山脉主峰，海拔7556米，是横断山脉的最高峰，号称“蜀山之王”。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/72贡嘎和大渡河.JPG" alt="贡嘎和大渡河"></p>
<blockquote>
<p>四川省成都市温江区上空，远处是<strong>贡嘎山脉</strong>傲立在成都平原尽头，左侧云雾之中是<strong>峨眉山</strong><code>(Emei Shan, 29°30'37.26"N, 103°19'54.73"E, 3099m)</code>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/73贡嘎远景.JPG" alt="贡嘎远景"></p>
<h3 id="3-5-番外：重庆"><a href="#3-5-番外：重庆" class="headerlink" title="3.5 番外：重庆"></a>3.5 番外：重庆</h3><blockquote>
<p>落地重庆江北，已经提前在<em>中转旅客服务通</em>填写了信息，航站楼内<em>重庆飞</em>柜台兑换住宿票据，等几分钟后就接到司机电话，一辆面包车满满当当六七人拉到航站楼附近的酒店，住宿条件勉强过得去，双人间，若要单人住宿可补差价。</p>
<p>在魁星楼附近的社区吃了火锅，微辣还<strong>辣辣辣辣辣辣</strong>，吃完后孃孃才说他们自己一般吃微微辣<span class="github-emoji"><span>😩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f629.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/74火锅1.JPG" alt="火锅1"></p>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/75火锅2.JPG" alt="火锅2"></p>
<blockquote>
<p>为了补上次在重庆没看到的朝天门夜景，特地去了南滨路钟楼广场。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/76东水门长江大桥夜景.JPG" alt="东水门长江大桥夜景"></p>
<blockquote>
<p>路过了晚上的龙门浩老街，看到了亮灯的东水门长江大桥。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/tibet/77朝天门夜景.JPG" alt="朝天门夜景"></p>
<h2 id="4-交通、线路强度、住宿、餐饮"><a href="#4-交通、线路强度、住宿、餐饮" class="headerlink" title="4. 交通、线路强度、住宿、餐饮"></a>4. 交通、线路强度、住宿、餐饮</h2><h3 id="4-1-交通"><a href="#4-1-交通" class="headerlink" title="4.1 交通"></a>4.1 交通</h3><ul>
<li>进藏/出藏大交通：南京直飞兰州，由动车<strong>D165</strong>转西宁（<strong>兰州站21:06-西宁站22:44</strong>），青藏线<strong>Y971</strong>次列车进藏（<strong>西宁站23:15-拉萨站20:29</strong>）；由林芝经重庆转机返回南京。<ul>
<li><em>为什么没选网红<strong>Z164/Z165</strong>次列车？</em><ul>
<li>时间：Z164/Z165由上海18:33始发，21:13过南京，Day+2的01:38抵达格尔木，15:30抵达拉萨，前半程将近一天半的时间都在青藏高原外，风景一般；昆仑山、可可西里、沱沱河等前半段在夜里（此行为3月中旬，夏季7/8月可选此次列车），<strong>青藏线西宁发车越晚，风景越多，Y971最优</strong>；</li>
<li>车票：网红班次车票紧张，大部分从上海出发，兰州甚至西宁上车几乎没票。</li>
</ul>
</li>
<li>为什么经兰州转？<ul>
<li>空铁联运时间可行，当日可赶上<strong>Y971</strong>；中川机场是西北枢纽，航班选择更多；<strong>兰州牛肉面</strong>。</li>
</ul>
</li>
<li>为什么由林芝米林机场返程？<ul>
<li>米林机场航班全在上/中午起飞，后续行程连贯；高原山谷起飞，航线途径鲁朗镇，<strong>近距离欣赏纳迦巴瓦和加拉白垒</strong>；自由行在林芝结束，返回贡嘎机场反而更远；</li>
<li>重庆转机停留5-48h机场提供住宿，<strong>重庆火锅</strong>。</li>
</ul>
</li>
</ul>
</li>
<li>拉萨市区交通：<ul>
<li>公交车：市区公交可到达大部分景点（哲蚌寺等山上和偏远的景点除外），票价1元，可刷联合交通卡。</li>
<li>网约车：基本10-15元/程，3-4人划算。</li>
</ul>
</li>
<li>山南羊湖/林芝交通：<ul>
<li>羊湖一日游<strong>租车自驾</strong>，走羊湖东侧日托寺方向，往返总共7-8小时车程（前文有具体线路）。<ul>
<li>需要注意的主要是天黑前离开普努村至芝龙村段的加若拉山，盘山公路；县道306线<strong>大多是搓衣板路</strong>，需SUV；返程从朗杰学乡走，理论上经过<em>甲日山沟-甲日普-朗杰林-沃拉</em>的线路更快，但是处于养护施工封路状态，出发前请确认。</li>
</ul>
</li>
<li><em>为什么没报团羊湖一日游/纳木错?</em><ul>
<li>羊湖一日游报团价格100-150元/人，包车票、首道门票和团餐，早出晚归，观景时间段路线单一，都是远景，卡若拉冰川个人感觉没必要，（淡季旺季价格应该会变）。</li>
<li>纳木错在念青唐古拉山脉北侧，青藏线已从南侧经过，可远观念青唐古拉山主峰；青藏线紧贴<strong>错那湖</strong>，有机会见<strong>冰推</strong>；从拉萨至纳木错来回两天才比较稳妥。</li>
</ul>
</li>
<li>去鲁朗的行程需要走318国道翻越色季拉山口，巴松措的行程主要是新措徒步，从结巴村到新措驿站约三十公里，包车往返预计500元，雅江峡谷的行程若不开车需要民宿老板接送费用另算，要不然就得坐景区观光车90元，这几个地方都比较远并且不在一个方向。林芝客运中心每天有几趟面包车营运（称之为线路车），但<strong>公共交通时间不可控</strong>，遂选择租车。租车成本和时间不可控产生的多住几天的费用，必须二选一。</li>
</ul>
</li>
<li>林芝机场交通<ul>
<li>米林机场大巴单程25元/人，约40分钟车程，上午由巴宜区民航基地发车；</li>
<li>前一夜适合住在<strong>民航基地</strong>附近，住食相对方便；机场附近住宿条件较差。</li>
</ul>
</li>
</ul>
<h3 id="4-2-线路强度"><a href="#4-2-线路强度" class="headerlink" title="4.2 线路强度"></a>4.2 线路强度</h3><ul>
<li>进藏前减少摄氧需求大的健身，适当增加耐氧训练；</li>
<li>青藏线格尔木站之后开始弥散式供氧，有紧急供养口，车内一般不会高反，不建议持续吸氧，产生依赖将导致下车后的反应更大；备可乐和电解质粉，充足的路餐及时进食，可能产生中耳不适和肚胀气，多进行吞咽动作；车内温度可能较高，及时增减衣物；停车时可下车适应低压低氧环境；</li>
<li>布达拉宫放在了Day 4也就是在拉萨的第二个白天，第一天安排爬升少一些的西藏博物馆等地，但事实是博物馆内通风较差，空气流通不畅，每逛一个场馆就觉得胸闷，出博物馆后自行缓解；</li>
<li>羊湖自驾/林芝自驾，路程长、路况复杂，不建议新手开，要有足够的安全常识；看季节备防滑链和雪胎；这次行程的所有自驾路线都建议开SUV，最好有涡轮增压；</li>
<li>天气变化快，风大雨大雪大，备冲锋衣和登山靴，速干打底避免出汗后着凉感冒；</li>
<li>洗澡/洗头，主要就是做好保温保湿，做好保暖措施，保湿乳液，头发吹干，基本没问题；进藏后第一天就洗澡洗头了，后续也每天洗，在林芝甚至洗了冷水澡，没出现高反，做好防护比较重要。</li>
<li>拉萨市区天气无所谓，山南和林芝需要一直关注天气改行程。</li>
</ul>
<h3 id="4-3-住宿"><a href="#4-3-住宿" class="headerlink" title="4.3 住宿"></a>4.3 住宿</h3><blockquote>
<p>住宿看个人需求见仁见智，总体来说拉萨市区住宿还可以，林芝几处村落的民宿条件较差，若介意可携带一次性洗漱用品，我是本着能睡就行的理念，该省省该花花。</p>
</blockquote>
<ul>
<li>拉萨市区推荐在<strong>北京东路</strong>，离布达拉宫、大昭寺、八廓街都很近，<strong>步行可达</strong>（但恰逢道路施工封路，打车和公交部分需要绕路，据说这条路经常修，旺季应该就修完了<span class="github-emoji"><span>👊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>）；</li>
<li>巴松措住宿可选结巴村、错高村和新措驿站；以<strong>结巴村</strong>为主，餐饮和住宿选择性较多，近巴松措景区；错高村住宿较少，可继续向里至杂拉村，原始村落；新措驿站是新措仅有的一家住宿，视行程安排可选；</li>
<li>雅江峡谷住宿左岸可选吞白村、索松村、达林村，右岸可选观光景区住宿和直白村；吞白村较靠外，除非索松村满房或价格差过大，不建议选；大部分住宿在<strong>索松村</strong>，价格就图一乐，和条件没有关联，波动较大；达林村有松赞酒店，贵但条件和视角确实好；右岸需另外付费乘坐景区观光车进入，直白村距纳迦巴瓦最近，但商业化开发较少，可能需要村民带进去。</li>
<li>林芝市区选择较多，第二天要去机场就住在民航基地附近方便，若住机场附近条件差且价格贵。</li>
</ul>
<h3 id="4-4-餐饮"><a href="#4-4-餐饮" class="headerlink" title="4.4 餐饮"></a>4.4 餐饮</h3><ul>
<li>藏餐：近似尼泊尔餐和印度菜，牛羊肉、青稞面食、奶制品为主，<strong>吉祥圣雪</strong>可以一试，店主情绪价值拉满</li>
<li>甜茶：口感近似香飘飘，入口舒服，推荐<strong>光明岗琼甜茶馆</strong>，1元/杯，倒茶收纸币，藏面较硬，味道不错，份量小，可以搭配炸土豆</li>
<li>青稞酒/拉萨啤酒/青稞啤酒：无特殊，没喝出来独特之处</li>
<li>酸奶：牦牛酸奶，确实酸，推荐<strong>前站牦牛酸奶坊</strong></li>
<li>阿刁奶茶：上层奶香更浓郁，其他近似茶颜</li>
<li>藏香猪：更香更弹，口感和普通肉猪差挺多</li>
<li>石锅鸡：本地鸡和一堆菌类混合，特色鸡煲，可以一试</li>
</ul>
<h2 id="5-后记"><a href="#5-后记" class="headerlink" title="5 后记"></a>5 后记</h2><blockquote>
<p>整个行程筹划了近半个月，从往返的交通到路线顺序，对比各种攻略，不断调整，力求有更好的体验。在拉萨的几天晚上都还在担心山南和林芝的天气，半夜调整后几天的行程顺序，把雨雪天可以去的新措提到了前面，把雅江峡谷放在了晴天，最终算是意料之中。</p>
<p><strong>敬畏自然</strong>是离开城市必须要遵守的法则，钢铁骨骼在无人区都是脆弱的，心智不成熟的人只会践踏亘古的威严，亿万年的雪山不由得你放肆。</p>
<p>进藏$ Tibet Round 2 $计划在五年内吧，<strong>日喀则地区</strong>和<strong>珠峰大本营</strong>，<strong>阿里地区</strong>和<strong>冈仁波齐</strong>；在此之前去<strong>雨崩</strong>，<strong>木雅贡嘎</strong>，藏东南的<strong>他念他翁</strong>重装徒步。</p>
<p>进藏$ Tibet Round 3 $计划在十年内吧，<strong>墨脱徒步</strong>和<strong>雅鲁藏布大峡谷左岸穿越</strong>。</p>
</blockquote>
<hr>
<blockquote>
<p>最后修改于2025/04/19</p>
</blockquote>
<!-- markdownlint-disable-file MD025 MD028 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Tibet</tag>
      </tags>
  </entry>
  <entry>
    <title>application yml配置</title>
    <url>/2024/04/12/application%20yml%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<blockquote>
<p><code>SpringBoot</code>常用配置文件<code>application.properties</code>或<code>application.yml</code>进行全局配置，<code>start.spring.io</code>的默认是用<code>properties</code>，只要改成<code>yml</code>文件即可，个人认为语法更舒适，在这篇记录一些常用的设置以及常用的一些包的参数，以便后续开发过程中及时翻阅，持续更新。</p>
</blockquote>
<span id="more"></span>
<h2 id="books-1-application配置文件"><a href="#books-1-application配置文件" class="headerlink" title=":books: 1. application配置文件"></a><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 1. application配置文件</h2><h3 id="1-1-全局配置文件"><a href="#1-1-全局配置文件" class="headerlink" title="1.1. 全局配置文件"></a>1.1. 全局配置文件</h3><blockquote>
<p>启动类下的全局配置，修改<code>SpringBoot</code>在底层的默认值</p>
</blockquote>
<ul>
<li><code>application.properties</code></li>
<li><code>application.yml</code></li>
</ul>
<h3 id="1-2-Proterties和YML以及XML区别"><a href="#1-2-Proterties和YML以及XML区别" class="headerlink" title="1.2. Proterties和YML以及XML区别"></a>1.2. Proterties和YML以及XML区别</h3><ul>
<li><p><code>Properties</code></p>
  <figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>YAML</code></p>
  <figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>XML</code></p>
  <figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="satellite-2-YAML语法"><a href="#satellite-2-YAML语法" class="headerlink" title=":satellite: 2. YAML语法"></a><span class="github-emoji"><span>📡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 2. YAML语法</h2><h3 id="2-1-基本语法"><a href="#2-1-基本语法" class="headerlink" title="2.1. 基本语法"></a>2.1. 基本语法</h3><ul>
<li>KV键值对，空格缩进（一般2格），左对齐的为同一层级</li>
<li>属性和值大小写敏感，值不能空着</li>
</ul>
<h3 id="2-2-字面量"><a href="#2-2-字面量" class="headerlink" title="2.2. 字面量"></a>2.2. 字面量</h3><ul>
<li>字符串，默认不需要使用引号<ul>
<li>单引号，不会转义特殊字符例如’aaa \n bbb’不会输出换行</li>
<li>双引号，会转义特殊字符例如”aaa \n bbb”会输出换行</li>
</ul>
</li>
<li>布尔，<code>True</code>或<code>true</code>，<code>Flase</code>或<code>false</code></li>
<li>整数，<code>123</code>或<code>0b1010_0111_0100_1010_1110</code></li>
<li>浮点数，<code>0.123</code>或者科学计数<code>6.85e+5</code></li>
<li><code>NULL</code>，可用<code>~</code>表示<code>null</code></li>
<li>日期，2024-07-12`，日期使用ISO 8601格式，yyyy-MM-dd</li>
<li>时间，<code>2024-07-12T14:31:00+08:00</code>，时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</li>
</ul>
<h3 id="2-3-对象"><a href="#2-3-对象" class="headerlink" title="2.3. 对象"></a>2.3. 对象</h3><ul>
<li><p>普通的缩进表示层级联系</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.111</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>行内写法</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">redis:</span> {<span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.111</span>,<span class="attr">port:</span> <span class="number">6379</span>,<span class="attr">password:</span> <span class="number">123456</span>}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="2-4-数组"><a href="#2-4-数组" class="headerlink" title="2.4. 数组"></a>2.4. 数组</h3><ul>
<li><p>普通写法，用<code>-</code>表示</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">persons:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lisi</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wangwu</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>行内写法，用<code>[]</code></p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">persons:</span> [<span class="string">zhangsan</span>,<span class="string">lisi</span>,<span class="string">wangwu</span>]</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="2-5-锚点"><a href="#2-5-锚点" class="headerlink" title="2.5. 锚点"></a>2.5. 锚点</h3><ul>
<li><p>用<code>&amp;</code>建立锚点，用<code>&lt;&lt;</code>合并数据，用<code>*</code>引用锚点内容</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line">  <span class="attr">host:</span>  <span class="number">192.168</span><span class="number">.1</span><span class="number">.129</span></span><br><span class="line">  <span class="attr">port:</span>  <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">dev_db</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prod:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">prod_db</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 相当于</span></span><br><span class="line"><span class="comment"># defaults: </span></span><br><span class="line"><span class="comment">#   host:  192.168.1.111</span></span><br><span class="line"><span class="comment">#   port:  6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dev:</span></span><br><span class="line"><span class="comment">#   database: dev_db</span></span><br><span class="line"><span class="comment">#   host:  192.168.1.111</span></span><br><span class="line"><span class="comment">#   port:  6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># prod:</span></span><br><span class="line"><span class="comment">#   database: prod_db</span></span><br><span class="line"><span class="comment">#   host:  192.168.1.111</span></span><br><span class="line"><span class="comment">#   port:  6379</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>直接在键后设置锚点，加空格后紧跟值，锚点名自定义，引用同样用<code>*</code></p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">defaults:</span> </span><br><span class="line">  <span class="attr">host:</span>  <span class="string">&amp;host</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.129</span></span><br><span class="line">  <span class="attr">port:</span>  <span class="string">&amp;port</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">dev_db</span></span><br><span class="line">  <span class="attr">host:</span>  <span class="meta">*host</span></span><br><span class="line">  <span class="attr">port:</span>  <span class="meta">*port</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prod:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">prod_db</span></span><br><span class="line">  <span class="attr">host:</span>  <span class="meta">*host</span></span><br><span class="line">  <span class="attr">port:</span>  <span class="meta">*port</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="mag-right-3-配置文件注入"><a href="#mag-right-3-配置文件注入" class="headerlink" title=":mag_right: 3. 配置文件注入"></a><span class="github-emoji"><span>🔎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 3. 配置文件注入</h2><ul>
<li>一般用注解<code>@ConfigurationProperties(prefix = "async.executor.thread")</code>，加上<code>@Data</code>注解或自己写<code>getter</code>和<code>setter</code>方法<ul>
<li>配合<code>@Component</code>定义组件，来定义配置数据的结构Properties</li>
<li>再配合<code>@Configuration</code>使用，用于定义配置类，再在配置类中注入配置文件的结构Properties，当然也可合并成一步</li>
</ul>
</li>
<li>只有容器中的组件，才能提供<code>@ConfigurationProperties</code>功能</li>
<li><p><code>prefix = "xxx.xxx"</code>是映射该路径下的配置文件，这里定义好<code>getter</code>和<code>setter</code>方法就能直接调用<code>setKeepAliveSeconds(int keepAliveSeconds)</code>等方法</p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">async:</span></span><br><span class="line"><span class="attr">executor:</span></span><br><span class="line">    <span class="attr">thread:</span></span><br><span class="line">    <span class="attr">keepAliveSeconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">namePrefix:</span> <span class="string">async-service-</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>可能需要<code>@ComponentScan(basePackages = {"com.***", "com.***"})</code>，扫描组件所在的<code>module</code></p>
</li>
<li><p>可选导入配置文件冲处理器，这样会有提示</p>
  <figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>可选用@Value配置</p>
<ul>
<li><p>若要在某个业务逻辑中要用到配置的值，可以用<code>@Value</code>，若已经整体设计了配置类的组件，则建议用<code>@ConfigurationProperties</code>批量注入</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Value("${thread.keepAliveSeconds}")</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> keepAliveSeconds;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>不支持松散绑定(Relaxed bindiing)，批量注入支持，<code>firstName</code>和<code>first-name</code>和<code>first_name</code></p>
</li>
<li>支持SPEL，批量注入不支持</li>
<li>不持支map、对象等复杂类型以及JSR303校验</li>
</ul>
</li>
</ul>
<h2 id="zzz-4-多环境支持"><a href="#zzz-4-多环境支持" class="headerlink" title=":zzz: 4. 多环境支持"></a><span class="github-emoji"><span>💤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 4. 多环境支持</h2><ul>
<li><code>application-{profile}.properties/yml</code>在测试环境和生成环境用不同的配置，包括一些<code>id</code>和<code>key</code>等重要的信息切换，例如<code>application-dev.yml</code>和<code>application-prod.yml</code>，再用<code>${xxx.xxx.driver-class-name}</code>在主配置文件中引入不同环境的配置参数</li>
<li><code>properties</code>优先级大于同级别的<code>yml</code>，要么删掉要么确保内有相同内容被指定</li>
<li><p>指定测试或生产环境，可以在<code>application.yml</code>中指定，或者打包jar时配置启动参数<code>Program arguments</code>为<code>--spring.profiles.active=dev</code>或者配置虚拟机参数<code>VM options</code>为<code>-Dspring.profiles.active=dev</code></p>
  <figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">"dev"</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>加载顺序</p>
  <figure class="highlight md"><table><tbody><tr><td class="code"><pre><span class="line">–file:./config/（根目录下的config文件夹）</span><br><span class="line"></span><br><span class="line">–file:./（根目录下）</span><br><span class="line"></span><br><span class="line">–classpath:/config/（resources/config）</span><br><span class="line"></span><br><span class="line">–classpath:/（resources）</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动类开启<code>@EnableAutoConfiguration</code>（<code>@SpringBootApplication</code>已经引入，不用重复）</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>SprinBoot</tag>
        <tag>application</tag>
      </tags>
  </entry>
  <entry>
    <title>基于Webhook的同步部署</title>
    <url>/2024/04/01/%E5%88%A9%E7%94%A8Webhook%E5%B0%86Hexo%E5%8D%9A%E5%AE%A2%E5%90%8C%E6%AD%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<blockquote>
<p>寄人篱下不是长久之计，下文展开介绍利用Webhook将Hexo博客部署到自己的服务器上，同时github-peges作为镜像站使用，接上一篇，默认分支hexo_backup作为源文件备份，master作主页</p>
</blockquote>
<span id="more"></span>
<ul>
<li>前提条件：已有github.io仓库，hexo博客已经上线测试可以使用，已有<code>nginx</code>、<code>git</code>、<code>node</code>等基础，可参考上一篇笔记</li>
<li>省略了一些次要步骤，域名解析、备案等</li>
</ul>
<hr>
<h2 id="服务器Webhook部分-2021-02-01"><a href="#服务器Webhook部分-2021-02-01" class="headerlink" title="服务器Webhook部分: 2021-02-01"></a>服务器Webhook部分: 2021-02-01</h2><ul>
<li>利用宝塔平台的Webhook插件</li>
</ul>
<blockquote>
<p>名称随意，实例脚本如下<br>gitPath=”/www/wwwroot/YourWebsiteLocation/“<br>gitHttp=”<a href="https://github.com/YourGithubName/xxxxxxxx.github.io.git">https://github.com/YourGithubName/xxxxxxxx.github.io.git</a>“<br>若失败，可考虑加上<code>sudo</code>使用管理员权限</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo ""</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输出当前时间</span></span><br><span class="line">date --date='0 days ago' "+%Y-%m-%d %H:%M:%S"</span><br><span class="line">echo "Start"</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">git项目路径</span></span><br><span class="line">gitPath=" "</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">git 网址</span></span><br><span class="line">gitHttp=" "</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">延迟高可以加https://ghproxy.com/代理</span></span><br><span class="line"></span><br><span class="line">echo "Web站点路径：$gitPath"</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">判断项目路径是否存在</span></span><br><span class="line">if [ -d "$gitPath" ]; then</span><br><span class="line">    cd $gitPath</span><br><span class="line">    #判断是否存在git目录</span><br><span class="line">    if [ ! -d ".git" ]; then</span><br><span class="line">            echo "在该目录下克隆 git"</span><br><span class="line">            sudo git clone $gitHttp gittemp</span><br><span class="line">            sudo mv gittemp/.git .</span><br><span class="line">            sudo rm -rf gittemp</span><br><span class="line">    fi</span><br><span class="line">    echo"拉取最新的项目文件"</span><br><span class="line">    sudo git reset --hard origin/master</span><br><span class="line">    sudo git pull origin master</span><br><span class="line">    echo"设置目录权限"</span><br><span class="line">    sudo chown -R www:www $gitPath</span><br><span class="line">    date --date='0 days ago' "+%Y-%m-%d %H:%M:%S"</span><br><span class="line">    echo "End"</span><br><span class="line">    exit</span><br><span class="line">else</span><br><span class="line">    echo "该项目路径不存在"</span><br><span class="line">    echo "End"</span><br><span class="line">    exit</span><br><span class="line">fi</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Hexo_synchronization/Webhook01.png" alt="宝塔Webhook"></p>
<h2 id="Github设置Webhook"><a href="#Github设置Webhook" class="headerlink" title="Github设置Webhook"></a>Github设置Webhook</h2><ul>
<li><p>查看密钥<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Hexo_synchronization/Webhook02.png" alt="宝塔Webhook查看密钥"></p>
</li>
<li><p>切换到Github项目的Settings-Webhooks</p>
</li>
<li><p>Add Webhook</p>
</li>
</ul>
<blockquote>
<p><strong>Payload URL:</strong> <code>http://服务器ip:8888?hook?access_key=xxxxx</code><br><strong>Content type:</strong> <code>application/json</code><br><strong>Secret:</strong> <code>Key</code><br><strong>Which events would you like to trigger this webhook?</strong><br>choose：Just the push event.<br>√<strong>Active</strong></p>
</blockquote>
<ul>
<li>测试，本地更改sources后<code>hexo g</code>+<code>hexo d</code></li>
<li>第一次红了是因为将Github中Webhook的Content type设置成了<code>application/x-www-form-urlencoded</code>，改成<code>application/json</code>通过<br><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/Hexo_synchronization/Webhook03.png" alt="Webhook测试"></li>
</ul>
<hr>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li>服务器需要开放8888端口，如果使用其他端口同样需要打开</li>
<li>两者都是表单数据发送时的编码类型<br> application/x-www-form-urlencoded —&gt; key=value&amp;key=value</li>
<li>一般情况下都会正常同步，如果长时间未update，可能是DNS的问题，可以考虑选择一个连接速度较快的GitHub的ip添加到/etc/hosts并且刷新</li>
</ol>
<hr>
<h2 id="Update-20240401"><a href="#Update-20240401" class="headerlink" title="Update: 20240401"></a>Update: 20240401</h2><blockquote>
<p><a href="https://mirror.ghproxy.com/">原有的代理喜提GFW，改用备用站点</a></p>
</blockquote>
<p>相应的，WebHook部分适当修改</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo ""</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输出当前时间</span></span><br><span class="line">date --date='0 days ago' "+%Y-%m-%d %H:%M:%S"</span><br><span class="line">echo "Start"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">git项目路径</span></span><br><span class="line">gitPath=" "</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">git 网址</span></span><br><span class="line">gitSSH="https://mirror.ghproxy.com/https://github.com/username/repo"</span><br><span class="line"> </span><br><span class="line">echo "Web站点路径：$gitPath"</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">判断项目路径是否存在</span></span><br><span class="line">if [ -d "$gitPath" ]; then</span><br><span class="line">    cd $gitPath</span><br><span class="line">    #判断是否存在git目录</span><br><span class="line"> if [ ! -d ".git" ]; then  </span><br><span class="line">        echo "Cloning the git repository into the directory"  </span><br><span class="line">        sudo git clone $gitSSH .  </span><br><span class="line">    fi</span><br><span class="line">    echo "拉取最新的项目文件"</span><br><span class="line">    sudo git reset -- hard origin/master</span><br><span class="line">    sudo git pull origin master</span><br><span class="line">    </span><br><span class="line">    echo "设置目录权限"</span><br><span class="line">    sudo chown -R www:www $gitPath</span><br><span class="line"> date --date='0 days ago' "+%Y-%m-%d %H:%M:%S"</span><br><span class="line">    echo "End"</span><br><span class="line">    exit</span><br><span class="line">else</span><br><span class="line">    echo "该项目路径不存在"</span><br><span class="line">    echo "End"</span><br><span class="line">    exit</span><br><span class="line">fi</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Webhook</tag>
      </tags>
  </entry>
  <entry>
    <title>基于卷积神经网络的图片验证码识别</title>
    <url>/2021/08/16/%E5%9F%BA%E4%BA%8E%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>基于卷积神经网络训练模型识别图片验证码，0~9数字和26个字母大写和小写组合识别</li>
<li>PIL模块生成验证码训练集和测试集，添加干扰点和干扰线来模拟实际复杂环境，os保存以及读取，通过去噪以及灰度化处理提高识别率，通过卷积神经网络池化后全连接层处理，识别成功率达到约96%<br><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f565.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<h2 id="生成训练集和测试集"><a href="#生成训练集和测试集" class="headerlink" title="生成训练集和测试集"></a>生成训练集和测试集</h2><h3 id="设置数字和字母"><a href="#设置数字和字母" class="headerlink" title="设置数字和字母"></a>设置数字和字母</h3><ul>
<li><code>random_num</code>随机产生数字，<code>random_upper</code>随机产生大写字母，<code>random_lower</code>随机产生小写字母</li>
<li><code>random.choice()</code>随机选择三种情况</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getRandomChar</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    chr(i) return the Unicode of i</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    random_num = <span class="built_in">str</span>(random.randint(<span class="number">0</span>, <span class="number">9</span>))  <span class="comment"># 0~9</span></span><br><span class="line">    random_upper = <span class="built_in">chr</span>(random.randint(<span class="number">65</span>, <span class="number">90</span>))  <span class="comment"># A~Z</span></span><br><span class="line">    random_lower = <span class="built_in">chr</span>(random.randint(<span class="number">97</span>, <span class="number">122</span>))  <span class="comment"># a~z</span></span><br><span class="line">    random_char = random.choice([random_num, random_upper, random_lower])</span><br><span class="line">    <span class="keyword">return</span> random_char</span><br></pre></td></tr></tbody></table></figure>
<h3 id="设置随机颜色"><a href="#设置随机颜色" class="headerlink" title="设置随机颜色"></a>设置随机颜色</h3><ul>
<li><code>is_light</code>是颜色深浅的标签</li>
<li>总的来说RGB值&gt;127的颜色较深，True代表浅色，False代表深色</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getRandomColor</span>(<span class="params">is_light=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Generate colors, default light color</span></span><br><span class="line"><span class="string">    :param is_light: Distinguish between light and dark colors</span></span><br><span class="line"><span class="string">    :return: r, g, b</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    r = random.randint(<span class="number">0</span>, <span class="number">127</span>) + <span class="built_in">int</span>(is_light) * <span class="number">128</span></span><br><span class="line">    g = random.randint(<span class="number">0</span>, <span class="number">127</span>) + <span class="built_in">int</span>(is_light) * <span class="number">128</span></span><br><span class="line">    b = random.randint(<span class="number">0</span>, <span class="number">127</span>) + <span class="built_in">int</span>(is_light) * <span class="number">128</span></span><br><span class="line">    <span class="keyword">return</span> r, g, b</span><br></pre></td></tr></tbody></table></figure>
<h3 id="设置干扰"><a href="#设置干扰" class="headerlink" title="设置干扰"></a>设置干扰</h3><ul>
<li>设置干扰线，随机产生起点和终点的坐标，<code>is_light</code>设置为<code>True</code>，干扰线浅色</li>
<li>设置干扰点，随机产生干扰点的坐标，<code>is_light</code>设置为<code>True</code>，干扰点浅色</li>
<li><code>numLine</code>和<code>nunmPoint</code>自由设置，干扰线和干扰点数量越大，后期识别成功率越低</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">drawLine</span>(<span class="params">draw</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Draw interference lines, numLine feels free</span></span><br><span class="line"><span class="string">    x1,x2,y1,y2: The begin point and the end point of the line</span></span><br><span class="line"><span class="string">    :param draw:</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    numLine = <span class="number">5</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(numLine):</span><br><span class="line">        x1 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        x2 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        y1 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">        y2 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">        draw.line((x1, y1, x2, y2), fill=getRandomColor(is_light=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">drawPoint</span>(<span class="params">draw</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Draw interference points, numPoint feels free</span></span><br><span class="line"><span class="string">    :param draw:</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    numPoint = <span class="number">50</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(numPoint):</span><br><span class="line">        x = random.randint(<span class="number">0</span>, width)</span><br><span class="line">        y = random.randint(<span class="number">0</span>, height)</span><br><span class="line">        draw.point((x, y), fill=getRandomColor(is_light=<span class="literal">True</span>))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="保存验证码"><a href="#保存验证码" class="headerlink" title="保存验证码"></a>保存验证码</h3><ul>
<li>使用<code>PIL</code>的<code>Image</code>、<code>ImageDraw</code>、<code>ImageFont</code>的模块（由于<code>PIL</code>不再适配高版本Python，安装需要用<code>pip install pillow</code>）</li>
<li>保存验证码<code>label.png</code>，直接打上标签，不用之手手动打标签</li>
<li>背景采用浅色，<code>numOfNum=4</code>验证码长度为4</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">createImg</span>(<span class="params">folder</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Use drawPoint(), drawLine(), getRandomColor(), getRandomChar() to generate an Img by random</span></span><br><span class="line"><span class="string">    :param folder: train or test folder</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Generate background color by random</span></span><br><span class="line">    bg_color = getRandomColor(is_light=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># Generate a Img</span></span><br><span class="line">    img = Image.new(mode=<span class="string">"RGB"</span>, size=(width, height), color=bg_color)</span><br><span class="line">    <span class="comment"># Get picture brush</span></span><br><span class="line">    draw = ImageDraw.Draw(img)</span><br><span class="line">    <span class="comment"># Set the font</span></span><br><span class="line">    font = ImageFont.truetype(font=<span class="string">"C:/Users/lingz/AppData/Local/Microsoft/Windows/Fonts/Monaco.ttf"</span>, size=<span class="number">16</span>)</span><br><span class="line">    <span class="comment"># Set the Img name</span></span><br><span class="line">    file_name = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate number or char, set the numOfNum to change the number of it</span></span><br><span class="line">    numOfNum = <span class="number">4</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(numOfNum):</span><br><span class="line">        random_txt = getRandomChar()</span><br><span class="line">        <span class="comment"># Default: the bk_color is light, the txt_color is dark</span></span><br><span class="line">        txt_color = getRandomColor(is_light=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Avoid the text color == the background color, re-generate txt_color</span></span><br><span class="line">        <span class="keyword">while</span> txt_color == bg_color:</span><br><span class="line">            txt_color = getRandomColor(is_light=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># Fill the txt, the first para is the coordinates of the upper left corner</span></span><br><span class="line">        <span class="comment"># If numOfNum = 4, then (15,0),(30,0),(45,0),(60,0), four nums of chars</span></span><br><span class="line">        draw.text((<span class="number">15</span> + <span class="number">15</span> * i, <span class="number">0</span>), text=random_txt, fill=txt_color, font=font)</span><br><span class="line">        file_name += random_txt</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Draw interference lines and points</span></span><br><span class="line">    drawLine(draw)</span><br><span class="line">    drawPoint(draw)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save the Img</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"./{}/{}.png"</span>.<span class="built_in">format</span>(folder, file_name), <span class="string">"wb"</span>) <span class="keyword">as</span> train:</span><br><span class="line">        img.save(train, <span class="built_in">format</span>=<span class="string">"png"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://www.lingzhicheng.cn/usr/file/picture/CodeIdVerify/DataSet.png" alt="Fig.1 产生数据集"></p>
<center><font size="2">Fig.1 产生数据集</font></center>

<h3 id="自动删除文件"><a href="#自动删除文件" class="headerlink" title="自动删除文件"></a>自动删除文件</h3><ul>
<li>用于每次生成数据时自动清空原有数据</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">creat_del_file</span>(<span class="params">path_data</span>):</span><br><span class="line">    os.path.exists(path_data) <span class="keyword">or</span> os.makedirs(path_data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(path_data):</span><br><span class="line">        file_data = path_data + <span class="string">"\\"</span> + i</span><br><span class="line">        os.remove(file_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Original %s set is deleted."</span> % path_data)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="卷积神经网络训练和识别"><a href="#卷积神经网络训练和识别" class="headerlink" title="卷积神经网络训练和识别"></a>卷积神经网络训练和识别</h2><h3 id="编码准备工作"><a href="#编码准备工作" class="headerlink" title="编码准备工作"></a>编码准备工作</h3><ul>
<li><code>model_dir</code>存放训练后的模型</li>
<li><code>char_set</code>和<code>alphabet</code>存放字符集用于数据读取</li>
<li><code>char_to_int</code>用于获取字典中的下标，用于之后的<code>one_hot</code>编码</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">model_dir = <span class="string">r'model.h5'</span></span><br><span class="line">char_set = [<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>] + [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>,</span><br><span class="line">                                                                 <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</span><br><span class="line">                                                                 <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>] + [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>,</span><br><span class="line">                                                                                        <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>,</span><br><span class="line">                                                                                        <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, <span class="string">'R'</span>,</span><br><span class="line">                                                                                        <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>,</span><br><span class="line">                                                                                        <span class="string">'Y'</span>, <span class="string">'Z'</span>]</span><br><span class="line">alphabet = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>,</span><br><span class="line">            <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>,</span><br><span class="line">            <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>] + [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>,</span><br><span class="line">                                   <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>,</span><br><span class="line">                                   <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, <span class="string">'R'</span>,</span><br><span class="line">                                   <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>,</span><br><span class="line">                                   <span class="string">'Y'</span>, <span class="string">'Z'</span>]</span><br><span class="line">char_to_int = <span class="built_in">dict</span>((c, i) <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(char_set))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="读取图片处理数据"><a href="#读取图片处理数据" class="headerlink" title="读取图片处理数据"></a>读取图片处理数据</h3><ul>
<li><code>x_data</code>数据，<code>y_data</code>标签</li>
<li>循环导入验证码，经过<code>deNoising()</code>降噪和灰度化处理，转化成np后存入<code>x_data</code>，并且使用按照<code>.</code>切割以获取验证码的标签值存入<code>y_data</code></li>
<li><code>unicode_to_int</code>和<code>unicode_to_int_index</code>来暂存unicode和字典下标的转化，np中读取到的数据是<code>unicode</code>，若要使用<code>one_hot</code>编码处理最好转化成<code>np.int</code>，所以先判断每个字符集是否在<code>alphabet_list</code>中，若在则先暂存，用<code>np.int</code>的<code>0</code>全部替换，再用<code>y_data = y_data.astype(np.int)</code>转换类型，最后在进行一次遍历，从暂存列表中取出<code>index</code>和<code>value</code>完成转换</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generateTrainData</span>(<span class="params">filePath</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Generate data set, 0~9, a~z, A~Z turn to 0~61</span></span><br><span class="line"><span class="string">    :param filePath: The Img in this folder need to be processed</span></span><br><span class="line"><span class="string">    :return: x_data is data, shape=(num, 20, 80)</span></span><br><span class="line"><span class="string">             y_data is label, shape=(num, 4)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># os.listdir(filePath) return list of files and folders</span></span><br><span class="line">    <span class="comment"># If the path has Chinese characters, it will be garbled, deal with unicode()</span></span><br><span class="line">    train_file_name_list = os.listdir(filePath)</span><br><span class="line">    x_data = []</span><br><span class="line">    y_data = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process each Img</span></span><br><span class="line">    <span class="keyword">for</span> selected_train_file_name <span class="keyword">in</span> train_file_name_list:</span><br><span class="line">        <span class="keyword">if</span> selected_train_file_name.endswith(<span class="string">'.png'</span>):</span><br><span class="line">            <span class="comment"># Get Img object, os.path.join(PathA, PathB) return PathA\PathB</span></span><br><span class="line">            captcha_image = Image.<span class="built_in">open</span>(os.path.join(filePath, selected_train_file_name))</span><br><span class="line">            <span class="comment"># deNoising</span></span><br><span class="line">            captcha_image = deNoising(captcha_image)</span><br><span class="line"></span><br><span class="line">            captcha_image_np = np.array(captcha_image)</span><br><span class="line"></span><br><span class="line">            img_np = np.array(captcha_image_np)</span><br><span class="line">            x_data.append(img_np)</span><br><span class="line">            <span class="comment"># split('.')[0] to get label from label.png</span></span><br><span class="line">            y_data.append(np.array(<span class="built_in">list</span>(selected_train_file_name.split(<span class="string">'.'</span>)[<span class="number">0</span>])))</span><br><span class="line"></span><br><span class="line">    x_data = np.array(x_data).astype(np.<span class="built_in">float</span>)</span><br><span class="line">    y_data = np.array(y_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Temporarily store letters into array</span></span><br><span class="line">    unicode_to_int = [<span class="string">'x'</span>]</span><br><span class="line">    unicode_to_int_index = [<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index_0, alphabet_list <span class="keyword">in</span> <span class="built_in">enumerate</span>(y_data):</span><br><span class="line">        <span class="keyword">for</span> index_1, value <span class="keyword">in</span> <span class="built_in">enumerate</span>(alphabet_list):</span><br><span class="line">            <span class="keyword">if</span> (alphabet_list[index_1]) <span class="keyword">in</span> alphabet:</span><br><span class="line">                unicode_to_int.append(alphabet_list[index_1])</span><br><span class="line">                alphabet_list[index_1] = <span class="number">0</span></span><br><span class="line">                unicode_to_int_index.append(index_0)</span><br><span class="line">                unicode_to_int_index.append(index_1)</span><br><span class="line">    y_data = y_data.astype(np.<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">del</span> (unicode_to_int[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">del</span> (unicode_to_int_index[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(unicode_to_int)):</span><br><span class="line">        y_data[unicode_to_int_index[<span class="number">2</span> * i]][unicode_to_int_index[<span class="number">2</span> * i + <span class="number">1</span>]] = char_to_int.get(unicode_to_int[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x_data, y_data</span><br></pre></td></tr></tbody></table></figure>
<h3 id="去噪和灰度化处理"><a href="#去噪和灰度化处理" class="headerlink" title="去噪和灰度化处理"></a>去噪和灰度化处理</h3><ul>
<li>阈值<code>threshold</code>设置为128用来区分RGB深浅，和之前的浅色背景、浅色干扰、深色验证码相对应</li>
<li>若大于阈值，直接变成白色<code>(255,255,255)</code>，其他变成黑色<code>(0，0，0)</code></li>
<li><code>convert('L')</code>直接转化为二值图像，每个像素点八个bit</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">deNoising</span>(<span class="params">image</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    image.getpixel((x,y)):get RGB,return (*,*,*)</span></span><br><span class="line"><span class="string">    :param image: RGB Img</span></span><br><span class="line"><span class="string">    :return: Grayscale Img</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Set threshold to filter</span></span><br><span class="line">    threshold = <span class="number">128</span></span><br><span class="line">    <span class="comment"># Change to Grayscale</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(image.width):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(image.height):</span><br><span class="line">            r, g, b = image.getpixel((i, j))</span><br><span class="line">            <span class="comment"># For each pixel, if rgb&gt;threshold,equals to light color==&gt;bk_pixel,then set white(255,255,255)</span></span><br><span class="line">            <span class="keyword">if</span> r &gt; threshold <span class="keyword">or</span> g &gt; threshold <span class="keyword">or</span> b &gt; threshold:</span><br><span class="line">                r = <span class="number">255</span></span><br><span class="line">                g = <span class="number">255</span></span><br><span class="line">                b = <span class="number">255</span></span><br><span class="line">                image.putpixel((i, j), (r, g, b))</span><br><span class="line">            <span class="comment"># else,equals to dark color==&gt;txt_pixel,set black(0,0,0)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                r = <span class="number">0</span></span><br><span class="line">                g = <span class="number">0</span></span><br><span class="line">                b = <span class="number">0</span></span><br><span class="line">                image.putpixel((i, j), (r, g, b))</span><br><span class="line">    <span class="comment"># Turn to grayscale Img</span></span><br><span class="line">    image = image.convert(<span class="string">'L'</span>)</span><br><span class="line">    <span class="keyword">return</span> image</span><br></pre></td></tr></tbody></table></figure>
<h3 id="卷积模型"><a href="#卷积模型" class="headerlink" title="卷积模型"></a>卷积模型</h3><ul>
<li>使用Tensorflow2版本会简单许多</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">tf.summary.trace_on(graph=<span class="literal">True</span>, profiler=<span class="literal">True</span>)</span><br><span class="line">model = Sequential([</span><br><span class="line">    layers.Conv2D(<span class="number">32</span>, kernel_size=[<span class="number">3</span>, <span class="number">3</span>], padding=<span class="string">"same"</span>, activation=tf.nn.relu),</span><br><span class="line">    layers.MaxPool2D(pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>, padding=<span class="string">'same'</span>),</span><br><span class="line">    layers.Dropout(<span class="number">0.5</span>),</span><br><span class="line">    layers.Conv2D(<span class="number">64</span>, kernel_size=[<span class="number">3</span>, <span class="number">3</span>], padding=<span class="string">"same"</span>, activation=tf.nn.relu),</span><br><span class="line">    layers.MaxPool2D(pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>, padding=<span class="string">'same'</span>),</span><br><span class="line">    layers.Dropout(<span class="number">0.3</span>),</span><br><span class="line">    layers.Conv2D(<span class="number">64</span>, kernel_size=[<span class="number">3</span>, <span class="number">3</span>], padding=<span class="string">"same"</span>, activation=tf.nn.relu),</span><br><span class="line">    layers.MaxPool2D(pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>, padding=<span class="string">'same'</span>),</span><br><span class="line">    layers.Dropout(<span class="number">0.25</span>),</span><br><span class="line"></span><br><span class="line">    layers.Flatten(),</span><br><span class="line"></span><br><span class="line">    layers.Dense(<span class="number">2480</span>),</span><br><span class="line">    layers.Dense(<span class="number">248</span>),  <span class="comment"># 4*62</span></span><br><span class="line">    layers.Reshape([<span class="number">4</span>, <span class="number">62</span>])</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">model.build(input_shape=[<span class="literal">None</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">1</span>])</span><br><span class="line">model.summary()</span><br><span class="line">optimizer = optimizers.Adam(lr=<span class="number">0.43</span> * <span class="number">1e-3</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="训练数据"><a href="#训练数据" class="headerlink" title="训练数据"></a>训练数据</h3><ul>
<li>同时使用Tensorboard可视化数据，要注意tf1和tf2的tensorboard使用不一样，需要手动将数据写入日志保存</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">IdentifyTrain</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Save model.h5</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Repeat training</span></span><br><span class="line">    training_time = <span class="number">40</span></span><br><span class="line">    loss = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(training_time):</span><br><span class="line">        <span class="keyword">for</span> step, (x, y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_db):</span><br><span class="line">            <span class="keyword">if</span> x.shape == (<span class="number">64</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">                    logits = IdentifyImg.model(x)</span><br><span class="line">                    y_one_hot = tf.one_hot(y, depth=<span class="number">62</span>)</span><br><span class="line">                    loss_ce = tf.losses.MSE(y_one_hot, logits)</span><br><span class="line">                    loss_ce = tf.reduce_mean(loss_ce)</span><br><span class="line">                    <span class="keyword">if</span> loss_ce &lt; loss:</span><br><span class="line">                        IdentifyImg.model.save(<span class="string">'model.h5'</span>)</span><br><span class="line">                        loss = loss_ce</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">"Save new model.h5 successfully! acc："</span>, <span class="built_in">float</span>(<span class="number">1</span> - loss_ce))</span><br><span class="line">                grads = tape.gradient(loss_ce, IdentifyImg.model.trainable_variables)</span><br><span class="line">                IdentifyImg.optimizer.apply_gradients(<span class="built_in">zip</span>(grads, IdentifyImg.model.trainable_variables))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(epoch, step)</span><br><span class="line">        <span class="keyword">with</span> IdentifyImg.summary_writer.as_default():</span><br><span class="line">            tf.summary.scalar(<span class="string">'train_loss'</span>, loss, step=epoch)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Finally model acc: "</span>, <span class="built_in">float</span>(<span class="number">1</span> - loss))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate train set</span></span><br><span class="line">(x_train, y_train) = IdentifyImg.generateTrainData(train_data_dir)</span><br><span class="line"><span class="built_in">print</span>(x_train.shape, y_train.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># load_dataset</span></span><br><span class="line">batch_size = <span class="number">64</span></span><br><span class="line">train_db = tf.data.Dataset.from_tensor_slices((x_train, y_train))</span><br><span class="line">train_db = train_db.<span class="built_in">map</span>(IdentifyImg.preprocess).batch(batch_size)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h3><ul>
<li>调用训练时存下的模型，判断是否四个验证码都相同，返回正确率，通过调整学习率<code>optimizer</code>以及卷积模型，正确识别率达到96%以上。</li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">IdentifyTest</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    correct_rate is over 93% now</span></span><br><span class="line"><span class="string">    :return: correct_rate = correct_quantity/total_number</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    correct_quantity = <span class="number">0</span></span><br><span class="line">    total_number = x_test.shape[<span class="number">0</span>]</span><br><span class="line">    IdentifyImg.model = tf.keras.models.load_model(<span class="string">'model.h5'</span>, <span class="built_in">compile</span>=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">for</span> step, (x, y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_db):</span><br><span class="line">        <span class="keyword">if</span> x.shape == (<span class="number">1</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">1</span>):</span><br><span class="line">            logits = IdentifyImg.model(x)</span><br><span class="line">            logits = tf.nn.softmax(logits)</span><br><span class="line">            pred = tf.cast(tf.argmax(logits, axis=<span class="number">2</span>), dtype=tf.int32)</span><br><span class="line">            true_flag = <span class="built_in">int</span>(tf.reduce_sum(tf.cast(tf.equal(pred, y), dtype=tf.int32))) == <span class="number">4</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'Pre：'</span>, np.array(IdentifyImg.char_set)[pred[<span class="number">0</span>].numpy()], <span class="string">'Real：'</span>,</span><br><span class="line">                  np.array(IdentifyImg.char_set)[y[<span class="number">0</span>].numpy()], <span class="string">'Same：'</span>, true_flag)</span><br><span class="line">            <span class="keyword">if</span> true_flag:</span><br><span class="line">                correct_quantity += <span class="number">1</span></span><br><span class="line">    correct_rate = correct_quantity / total_number</span><br><span class="line">    <span class="keyword">return</span> correct_rate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate test set</span></span><br><span class="line">(x_test, y_test) = IdentifyImg.generateTrainData(test_data_dir)</span><br><span class="line"><span class="built_in">print</span>(x_test.shape, y_test.shape)</span><br><span class="line"><span class="comment"># (num of Img, 20:width, 80:height) (num of Img, 4)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># load_dataset</span></span><br><span class="line">test_db = tf.data.Dataset.from_tensor_slices((x_test, y_test))</span><br><span class="line">test_db = test_db.<span class="built_in">map</span>(IdentifyImg.preprocess).batch(<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight md"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── <span class="strong">__pycache__</span></span><br><span class="line">├── logs</span><br><span class="line">├── test</span><br><span class="line">│&nbsp;&nbsp; └── xxx.png </span><br><span class="line">├── train</span><br><span class="line">│&nbsp;&nbsp; └── xxx.png </span><br><span class="line">├── GenerateImg.py</span><br><span class="line">├── IdentifyImg.py</span><br><span class="line">├── IdentifyTest.py</span><br><span class="line">├── IdentifyTrain.py</span><br><span class="line">└── model.h5</span><br><span class="line"></span><br><span class="line">4 directories, 6 files</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Download-Source-File"><a href="#Download-Source-File" class="headerlink" title="Download Source File"></a><a href="https://www.lingzhicheng.cn/usr/file/CodeIdVerify.zip">Download Source File</a></h3><!-- markdownlint-disable-file MD025 MD033 -->
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Tensorflow</tag>
        <tag>CNN</tag>
      </tags>
  </entry>
  <entry>
    <title>数学基础知识</title>
    <url>/2021/08/25/mathBasic/</url>
    <content><![CDATA[<ul>
<li>数学基础知识，稍微做一个整理<span id="more"></span>
</li>
</ul>
<h3 id="高等数学"><a href="#高等数学" class="headerlink" title="高等数学"></a>高等数学</h3><h4 id="1-导数的定义"><a href="#1-导数的定义" class="headerlink" title="1.导数的定义"></a>1.导数的定义</h4><p>导数和微分的概念</p>
<p>$f’({{x}_{0}})=\underset{\Delta x\to 0}{\mathop{\lim }}\,\frac{f({{x}_{0}}+\Delta x)-f({{x}_{0}})}{\Delta x}$    （1）</p>
<p>或者：</p>
<p>$f’({{x}_{0}})=\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{f(x)-f({{x}_{0}})}{x-{{x}_{0}}}$           （2）</p>
<h4 id="2-左右导数导数的几何意义和物理意义"><a href="#2-左右导数导数的几何意义和物理意义" class="headerlink" title="2.左右导数导数的几何意义和物理意义"></a>2.左右导数导数的几何意义和物理意义</h4><p>函数$f(x)$在$x_0$处的左、右导数分别定义为：</p>
<p>左导数：${{f'}_{-}}({{x}_{0}})=\underset{\Delta x\to {{0}^{-}}}{\mathop{\lim }}\,\frac{f({{x}_{0}}+\Delta x)-f({{x}_{0}})}{\Delta x}=\underset{x\to x_{0}^{-}}{\mathop{\lim }}\,\frac{f(x)-f({{x}_{0}})}{x-{{x}_{0}}},(x={{x}_{0}}+\Delta x)$</p>
<p>右导数：${{f'}_{+}}({{x}_{0}})=\underset{\Delta x\to {{0}^{+}}}{\mathop{\lim }}\,\frac{f({{x}_{0}}+\Delta x)-f({{x}_{0}})}{\Delta x}=\underset{x\to x_{0}^{+}}{\mathop{\lim }}\,\frac{f(x)-f({{x}_{0}})}{x-{{x}_{0}}}$</p>
<h4 id="3-函数的可导性与连续性之间的关系"><a href="#3-函数的可导性与连续性之间的关系" class="headerlink" title="3.函数的可导性与连续性之间的关系"></a>3.函数的可导性与连续性之间的关系</h4><p><strong>Th1:</strong> 函数$f(x)$在$x_0$处可微$\Leftrightarrow f(x)$在$x_0$处可导</p>
<p><strong>Th2:</strong> 若函数在点$x_0$处可导，则$y=f(x)$在点$x_0$处连续，反之则不成立(即函数连续不一定可导)</p>
<p><strong>Th3:</strong> ${f}’({{x}_{0}})$存在$\Leftrightarrow {{f'}_{-}}({{x}_{0}})={{f'}_{+}}({{x}_{0}})$</p>
<h4 id="4-平面曲线的切线和法线"><a href="#4-平面曲线的切线和法线" class="headerlink" title="4.平面曲线的切线和法线"></a>4.平面曲线的切线和法线</h4><p>切线方程 : $y-{{y}_{0}}=f’({{x}_{0}})(x-{{x}_{0}})$<br>法线方程：$y-{{y}_{0}}=-\frac{1}{f’({{x}_{0}})}(x-{{x}_{0}}),f’({{x}_{0}})\ne 0$</p>
<h4 id="5-四则运算法则"><a href="#5-四则运算法则" class="headerlink" title="5.四则运算法则"></a>5.四则运算法则</h4><p>设函数$ u=u(x)，v=v(x) $在点$ x $可导则<br>(1) $ (u \pm v)’={u}’\pm {v’} $，$ d(u\pm v)=du\pm dv $<br>(2) $ (uv)’=uv’+vu’ $，$ d(uv)=udv+vdu $<br>(3) $ {(\frac{u}{v})}’=\frac{v{u}’-u{v}’}{{v^2}}(v\ne 0) $，$ d(\frac{u}{v})=\frac{vdu-udv}{{v}^{2}} $</p>
<h4 id="6-基本导数与微分表"><a href="#6-基本导数与微分表" class="headerlink" title="6.基本导数与微分表"></a>6.基本导数与微分表</h4><p>(1) $y=c$（常数），       ${y}’=0$，，        $dy=0$</p>
<p>(2) $y={{x}^{\alpha }}$($\alpha $为实数)，       ${y}’=\alpha {{x}^{\alpha -1}}$，       $dy=\alpha {{x}^{\alpha -1}}dx$</p>
<p>(3) $y={{a}^{x}}$，       ${y}’={{a}^{x}}\ln a$，       $dy={{a}^{x}}\ln adx$</p>
<p>  特例:   ${({e}^{x})’}={{e}^{x}}$，       $ d({e}^{x})={{e}^{x}}dx $</p>
<p>(4) $y={{\log }_{a}}x$，       ${y}’=\frac{1}{x\ln a}$，$dy=\frac{1}{x\ln a}dx$</p>
<p>  特例:$y=\ln x$，       $(\ln x{)}’=\frac{1}{x}$，       $d(\ln x)=\frac{1}{x}dx$</p>
<p>(5) $y=\sin x$</p>
<p>${y}’=\cos x$，       $d(\sin x)=\cos xdx$</p>
<p>(6) $y=\cos x$</p>
<p>${y}’=-\sin x$，       $d(\cos x)=-\sin xdx$</p>
<p>(7) $y=\tan x$  </p>
<p>${y}’=\frac{1}{{{\cos }^{2}}x}={{\sec }^{2}}x$，       $d(\tan x)={{\sec }^{2}}xdx$</p>
<p>(8) $y=\cot x$ ${y}’=-\frac{1}{{{\sin }^{2}}x}=-{{\csc }^{2}}x$，       $d(\cot x)=-{{\csc }^{2}}xdx$</p>
<p>(9) $y=\sec x$，       ${y}’=\sec x\tan x$</p>
<p> $d(\sec x)=\sec x\tan xdx$</p>
<p>(10) $y=\csc x$，       ${y}’=-\csc x\cot x$</p>
<p>$d(\csc x)=-\csc x\cot xdx$</p>
<p>(11) $y=\arcsin x$  </p>
<p>${y}’=\frac{1}{\sqrt{1-{{x}^{2}}}}$</p>
<p>$d(\arcsin x)=\frac{1}{\sqrt{1-{{x}^{2}}}}dx$</p>
<p>(12) $y=\arccos x$</p>
<p>${y}’=-\frac{1}{\sqrt{1-{{x}^{2}}}}$     $d(\arccos x)=-\frac{1}{\sqrt{1-{{x}^{2}}}}dx$</p>
<p>(13) $y=\arctan x$</p>
<p>${y}’=\frac{1}{1+{{x}^{2}}}$     $d(\arctan x)=\frac{1}{1+{{x}^{2}}}dx$</p>
<p>(14) $y=\operatorname{arc}\cot x$</p>
<p>${y}’=-\frac{1}{1+{{x}^{2}}}$</p>
<p>$d(\operatorname{arc}\cot x)=-\frac{1}{1+{{x}^{2}}}dx$</p>
<p>(15) $y=shx$</p>
<p>${y}’=chx$       $d(shx)=chxdx$</p>
<p>(16) $y=chx$</p>
<p>${y}’=shx$       $d(chx)=shxdx$</p>
<h4 id="7-复合函数，反函数，隐函数以及参数方程所确定的函数的微分"><a href="#7-复合函数，反函数，隐函数以及参数方程所确定的函数的微分" class="headerlink" title="7.复合函数，反函数，隐函数以及参数方程所确定的函数的微分"></a>7.复合函数，反函数，隐函数以及参数方程所确定的函数的微分</h4><p>(1) 反函数的运算法则: 设$y=f(x)$在点$x$的某邻域内单调连续，在点$x$处可导且${f}’(x)\ne 0$，则其反函数在点$x$所对应的$y$处可导，并且有$\frac{dy}{dx}=\frac{1}{\frac{dx}{dy}}$</p>
<p>(2) 复合函数的运算法则：若$\mu =\varphi (x)$在点$x$可导，而$y=f(\mu )$在对应点$\mu $($\mu =\varphi (x)$)可导，则复合函数$y=f(\varphi (x))$在点$x$可导，且${y’}={f’}(\mu )\cdot {\varphi }’(x)$</p>
<p>(3) 隐函数导数$\frac{dy}{dx}$的求法一般有三种方法：</p>
<ul>
<li>1)方程两边对$x$求导，要记住$y$是$x$的函数，则$y$的函数是$x$的复合函数。例如$\frac{1}{y}$，${{y}^{2}}$，$ln y$，${{{e}}^{y}}$等均是$x$的复合函数，对$x$求导应按复合函数连锁法则做</li>
<li>2)公式法：由$F(x,y)=0$知 $\frac{dy}{dx}=-\frac{{F'_{x}}(x,y)}{{F'_{y}}(x,y)}$，其中，${F’_x}(x,y)$，<br>${F’_y}(x,y)$分别表示$F(x,y)$对$x$和$y$的偏导数</li>
<li>3)利用微分形式不变性</li>
</ul>
<h4 id="8-常用高阶导数公式"><a href="#8-常用高阶导数公式" class="headerlink" title="8.常用高阶导数公式"></a>8.常用高阶导数公式</h4><blockquote>
<p>常用几个低次公式要熟记于心</p>
</blockquote>
<p>（1）$({{a}^{x}}){{\,}^{(n)}}={{a}^{x}}{{\ln }^{n}}a\quad (a&gt;{0})\quad  ({{{e}}^{x}}){{\,}^{(n)}}={e}{{\,}^{x}}$<br>（2）$(\sin kx{)}{{\,}^{(n)}}={{k}^{n}}\sin (kx+n\cdot \frac{\pi }{{2}})$<br>（3）$(\cos kx{)}{{\,}^{(n)}}={{k}^{n}}\cos (kx+n\cdot \frac{\pi }{{2}})$<br>（4）$({{x}^{m}}){{\,}^{(n)}}=m(m-1)\cdots (m-n+1){{x}^{m-n}}$<br>（5）$(\ln x){{\,}^{(n)}}={{(-{1})}^{(n-{1})}}\frac{(n-{1})!}{{{x}^{n}}}$<br>（6）莱布尼兹公式：<br>若$u(x),v(x)$均$n$阶可导，则${{(uv)}^{(n)}}=\sum\limits_{i={0}}^{n}{{c}_{n}^{i}{u}^{i}{v^{n-i}}}$，其中${{u}^{({0})}}=u$，${{v}^{({0})}}=v$</p>
<h4 id="9-微分中值定理，泰勒公式"><a href="#9-微分中值定理，泰勒公式" class="headerlink" title="9.微分中值定理，泰勒公式"></a>9.微分中值定理，泰勒公式</h4><p><strong>Th1:</strong> 费马引理</p>
<p>若函数$f(x)$满足条件：<br>(1)函数$f(x)$在${{x}_{0}}$的某邻域内有定义，并且在此邻域内恒有<br>$f(x)\le f({{x}_{0}})$或$f(x)\ge f({{x}_{0}})$<br>(2) $f(x)$在${{x}_{0}}$处可导<br>则有 ${f}’({{x}_{0}})=0$</p>
<p><strong>Th2:</strong> 罗尔定理</p>
<p>设函数$f(x)$满足条件：<br>(1)在闭区间$[a,b]$上连续<br>(2)在$(a,b)$内可导<br>(3)$f(a)=f(b)$<br>则在$(a,b)$内一存在个$\xi $，使  ${f}’(\xi )=0$</p>
<p><strong>Th3:</strong> 拉格朗日中值定理</p>
<p>设函数$f(x)$满足条件：<br>(1)在$[a,b]$上连续<br>(2)在$(a,b)$内可导<br>则在$(a,b)$内一存在个$\xi $，使  $\frac{f(b)-f(a)}{b-a}={f}’(\xi )$</p>
<p><strong>Th4:</strong> 柯西中值定理</p>
<p>设函数$f(x)$，$g(x)$满足条件：<br>(1) 在$[a,b]$上连续<br>(2) 在$(a,b)$内可导且${f}’(x)$，${g}’(x)$均存在，且${g}’(x)\ne 0$<br>则在$(a,b)$内存在一个$\xi $，使${\frac{f(b)-f(a)}{g(b)-g(a)}}={\frac{{f}'(\xi )}{{g}'(\xi )}}$</p>
<h4 id="10-洛必达法则"><a href="#10-洛必达法则" class="headerlink" title="10.洛必达法则"></a>10.洛必达法则</h4><p><strong>法则Ⅰ ($\frac{0}{0}$型)</strong></p>
<p>设函数$f\left( x \right),g\left( x \right)$满足条件：</p>
<p>$\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,f\left( x \right)=0,\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,g\left( x \right)=0$<br>$f\left( x \right),g\left( x \right)$在${{x}_{0}}$的邻域内可导，(在${{x}_{0}}$处可除外)且${g}’\left( x \right)\ne 0$<br>$\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}$存在(或$\infty $)

则:
${\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{f\left( x \right)}{g\left( x \right)}=\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}}$</p>
<p><strong>法则Ⅰ’ ($\frac{0}{0}$型)</strong></p>
<p>设函数$f\left( x \right),g\left( x \right)$满足条件：</p>
<p>$\underset{x\to \infty }{\mathop{\lim }}\,f\left( x \right)=0,\underset{x\to \infty }{\mathop{\lim }}\,g\left( x \right)=0$<br>存在一个$X&gt;0$,当$\left| x \right|&gt;X$时，$f\left( x \right),g\left( x \right)$可导，且${g}’\left( x \right)\ne 0$<br>$\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}$存在(或$\infty $)

则:${\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{f\left( x \right)}{g\left( x \right)}=\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}}$</p>
<p><strong>法则Ⅱ ($\frac{\infty }{\infty }$型)</strong></p>
<p>设函数$f\left( x \right),g\left( x \right)$满足条件：</p>
<p>$\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,f\left( x \right)=\infty ,\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,g\left( x \right)=\infty $<br>$f\left( x \right),g\left( x \right)$在${{x}_{0}}$ 的邻域内可导(在${{x}_{0}}$处可除外)且${g}’\left( x \right)\ne 0$<br>$\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}$存在(或$\infty $)

则:
${\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{f\left( x \right)}{g\left( x \right)}}={\underset{x\to {{x}_{0}}}{\mathop{\lim }}\,\frac{{f}'\left( x \right)}{{g}'\left( x \right)}}$</p>
<p><strong>同理法则Ⅱ’ ($\frac{\infty }{\infty }$型)仿法则Ⅰ’ 可写出</strong></p>
<h4 id="11-泰勒公式"><a href="#11-泰勒公式" class="headerlink" title="11.泰勒公式"></a>11.泰勒公式</h4><p>设函数$f(x)$在点${{x}_{0}}$处的某邻域内具有$n+1$阶导数，则对该邻域内异于${{x}_{0}}$的任意点$x$，在${{x}_{0}}$与$x$之间至少存在一个$\xi$，使得:</p>
<p>$f(x)=f({{x}_{0}})+{f}’({{x}_{0}})(x-{{x}_{0}})+\frac{1}{2!}{f}’’({{x}_{0}}){{(x-{{x}_{0}})}^{2}}+\cdots +\frac{{{f}^{(n)}}({{x}_{0}})}{n!}{{(x-{{x}_{0}})}^{n}}+{{R}_{n}}(x)$</p>
<p> 其中 ${{R}_{n}}(x)=\frac{{{f}^{(n+1)}}(\xi )}{(n+1)!}{{(x-{{x}_{0}})}^{n+1}}$ 称为 $f(x)$ 在点 ${{x}_{0}}$ 处的 $n$ 阶泰勒余项。</p>
<p>令${{x}_{0}}=0$，则$n$阶泰勒公式 <strong>(麦克劳林公式):</strong></p>
<p>$f(x)=f(0)+{f}’(0)x+\frac{1}{2!}{f}’’(0){{x}^{2}}+\cdots +\frac{{{f}^{(n)}}(0)}{n!}{{x}^{n}}+{{R}_{n}}(x)$</p>
<p>其中 ${{R}_{n}}(x)=\frac{{{f}^{(n+1)}}(\xi )}{(n+1)!}{{x}^{n+1}}$，$\xi $在0与$x$之间</p>
<p><strong>常用五种函数在${{x}_{0}}=0$处的泰勒公式</strong></p>
<p>(1) ${{{e}}^{x}}=1+x+\frac{1}{2!}{{x}^{2}}+\cdots +\frac{1}{n!}{{x}^{n}}+o({{x}^{n}})$</p>
<p>(2) $\sin x=x-\frac{1}{3!}{{x}^{3}}+\cdots +\frac{{{x}^{n}}}{n!}\sin \frac{n\pi }{2}+o({{x}^{n}})$</p>
<p>(3) $\cos x=1-\frac{1}{2!}{{x}^{2}}+\cdots +\frac{{{x}^{n}}}{n!}\cos \frac{n\pi }{2}+o({{x}^{n}})$</p>
<p>(4) $\ln (1+x)=x-\frac{1}{2}{{x}^{2}}+\frac{1}{3}{{x}^{3}}-\cdots +{{(-1)}^{n-1}}\frac{{{x}^{n}}}{n}+o({{x}^{n}})$</p>
<p>(5) ${{(1+x)}^{m}}=1+mx+\frac{m(m-1)}{2!}{{x}^{2}}+\cdots $ $+\frac{m(m-1)\cdots (m-n+1)}{n!}{{x}^{n}}+o({{x}^{n}})$</p>
<h4 id="12-函数单调性的判断"><a href="#12-函数单调性的判断" class="headerlink" title="12.函数单调性的判断"></a>12.函数单调性的判断</h4><p><strong>Th1:</strong>  设函数$f(x)$在$(a,b)$区间内可导，如果对$\forall x\in (a,b)$，都有$f’(x)&gt;0$（或$f’(x)&lt;0$），则函数$f(x)$在$(a,b)$内是单调增加的（或单调减少）</p>
<p><strong>Th2:</strong> （取极值的必要条件）设函数$f(x)$在${{x}_{0}}$处可导，且在${{x}_{0}}$处取极值，则$f’({{x}_{0}})=0$。</p>
<p><strong>Th3:</strong> （取极值的第一充分条件）设函数$f(x)$在${{x}_{0}}$的某一邻域内可微，且$f’({{x}_{0}})=0$（或$f(x)$在${{x}_{0}}$处连续，但$f’({{x}_{0}})$不存在。）</p>
<blockquote>
<p>(1)若当$x$经过${{x}_{0}}$时，$f’(x)$由“+”变“-”，则$f({{x}_{0}})$为极大值<br>(2)若当$x$经过${{x}_{0}}$时，$f’(x)$由“-”变“+”，则$f({{x}_{0}})$为极小值<br>(3)若$f’(x)$经过$x={{x}_{0}}$的两侧不变号，则$f({{x}_{0}})$不是极值</p>
</blockquote>
<p><strong>Th4:</strong> （取极值的第二充分条件）设$f(x)$在点${{x}_{0}}$处有$f’’(x)\ne 0$，且$f’({{x}_{0}})=0$，则：</p>
<blockquote>
<p>当$f’’({{x}_{0}})&lt;0$时，$f({{x}_{0}})$为极大值<br>当$f’’({{x}_{0}})&gt;0$时，$f({{x}_{0}})$为极小值<br>如果$f’’({{x}_{0}})=0$，失效</p>
</blockquote>
<h4 id="13-渐近线的求法"><a href="#13-渐近线的求法" class="headerlink" title="13.渐近线的求法"></a>13.渐近线的求法</h4><p>(1)水平渐近线   若$\underset{x\to +\infty }{\mathop{\lim }}\,f(x)=b$，或$\underset{x\to -\infty }{\mathop{\lim }}\,f(x)=b$，则</p>
<p>$y=b$称为函数$y=f(x)$的水平渐近线。</p>
<p>(2)铅直渐近线   若$\underset{x\to x<em>{0}^{-}}{\mathop{\lim }}\,f(x)=\infty $，或$\underset{x\to x</em>{0}^{+}}{\mathop{\lim }}\,f(x)=\infty $，则</p>
<p>$x={{x}_{0}}$称为$y=f(x)$的铅直渐近线。</p>
<p>(3)斜渐近线   若$a=\underset{x\to \infty }{\mathop{\lim }}\,\frac{f(x)}{x},\quad b=\underset{x\to \infty }{\mathop{\lim }}\,[f(x)-ax]$，则<br>$y=ax+b$称为$y=f(x)$的斜渐近线。</p>
<h4 id="14-函数凹凸性的判断"><a href="#14-函数凹凸性的判断" class="headerlink" title="14.函数凹凸性的判断"></a>14.函数凹凸性的判断</h4><p><strong>Th1:</strong> （凹凸性的判别定理）若在I上$f{‘’}(x)&lt;0$（或$f''(x)&gt;0$），则$f(x)$在I上是凸的（或凹的）（凹凸是相对于正方向而言的）</p>
<p><strong>Th2:</strong> （拐点的判别定理1）若在${{x}_{0}}$处$f’’(x)=0$，（或$f’’(x)$不存在），当$x$变动经过${{x}_{0}}$时，$f’’(x)$变号，则$({{x}_{0}},f({{x}_{0}}))$为拐点</p>
<p><strong>Th3:</strong> （拐点的判别理2）设$f(x)$在${{x}_{0}}$点的某邻域内有三阶导数，且$f’’(x)=0$，$f’’’(x)\ne 0$，则$({{x}_{0}},f({{x}_{0}}))$为拐点</p>
<blockquote>
<p><del>有空更新线性代数和概率论部分，但公式比较复杂，涉及矩阵和行列式等，Hexo渲染不方便，大概率鸽了</del><br><a href="https://www.lingzhicheng.cn/usr/file/mathBasic.md">完整Markdown下载</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Mathematics</tag>
      </tags>
  </entry>
  <entry>
    <title>毕业总结</title>
    <url>/2022/06/22/%E6%AF%95%E4%B8%9A%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>古运河畔到屏峰山下，这里是<code>Heisenberg</code>的本科毕业总结<span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
<li>感谢所有曾经帮助过我的大朋友和小朋友们，毕业快乐，此去一别，江湖再见<span class="github-emoji"><span>👋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<hr>
<h3 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h3><blockquote>
<p>这四年，入学的懵懂无知和忐忑不安已然消失，剩下的是毕业的解脱和释然。平时总觉得无所谓，之后还有机会见面，真正驶离校门后，这些都成了约定。待在精弘<span class="github-emoji"><span>🍅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f345.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>的三年多，在这里结识了大多数朋友；两次特殊的实习经历，提前体验了国企和事业编；拿着奖学金和实习工资换了平板、手机和电脑，去自己想去的地方；接下来几年的学习和生活也有了方向，去南京弥补之前没能走出去的遗憾。</p>
</blockquote>
<pre><code>有一些内容难免带着情绪，有可能视情况限制访问，有些名字进行适当处理
文笔不好，流水账形式的记录，没有啥先后排序
</code></pre><h3 id="那四年遇到的人"><a href="#那四年遇到的人" class="headerlink" title="那四年遇到的人"></a>那四年遇到的人</h3><p>总的来说，能遇到可爱的各位，还是很幸运的。</p>
<h5 id="在精弘的办公室和会长团"><a href="#在精弘的办公室和会长团" class="headerlink" title="在精弘的办公室和会长团"></a>在精弘的办公室和会长团</h5><ul>
<li>最早认识的大家，是金库的大老板<code>文靖(QWJ)</code>和二老板<code>凯(ZK)</code>，是小浣熊<code>lcq</code>和<code>wcf</code>，是<code>楷淇(ZKQ)</code>和<code>恺斌(BKB)</code>，是<code>波波</code>、<code>林童</code>、<code>晓洁(WXJ)</code>和<code>老杰(WYJ)</code>。</li>
<li>也在这里遇到了<code>粥粥</code>还有<code>bq姐</code>。</li>
<li><code>朱哥</code>、<code>浩男</code>、<code>CC</code>、<code>小戎</code>、<code>小凯</code>还有许多在黑夜和烈日下用热诚迎接挑战的朋友们。</li>
<li><span class="github-emoji"><span>🌲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f332.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><code>涵莹</code>、未来的局长<code>ly</code>、跳动着的<code>力哥</code>、同为局长的<code>朱哥</code>和敢于追梦的编剧<code>十九</code>。</li>
<li>群有一辅导员如有一宝的<span class="github-emoji"><span>🐼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><code>Panda</code>、托付以重任的尽职尽责的<code>翀</code>、勤勤恳恳的海鲜大亨<code>欧</code>、还有一直催我买房买车买飞机的<code>睿敏</code>和<code>00</code>，热爱健身的高冷的<code>小骆</code>。</li>
<li>还有很多小朋友，似乎有的都还不曾见面，就已道别。</li>
<li>愿我们在漫漫长路上，不畏黑夜寒冬，在顶峰相见<span class="github-emoji"><span>😎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
</ul>
<h5 id="在精弘的产品开发部"><a href="#在精弘的产品开发部" class="headerlink" title="在精弘的产品开发部"></a>在精弘的产品开发部</h5><ul>
<li>‘黑恶势力’<code>zdl</code>、上班社死警告的<code>小诺姐</code>、全能的<code>yy</code>、甜甜的<code>往往不</code>和<code>小花仙</code>、人间清醒的<code>Congb19</code>、帅气多金的<code>hxy</code>、IOS大佬<code>hyh</code>、骨瘦如柴的<code>xyy</code>、方方的全栈<code>zw</code>还有润教师岗的<code>X叔</code>。</li>
<li><code>佐大师</code>的美味烧烤、小浣熊<code>lcq</code>、气质型男<code>leo</code>、素有工大hcl称号的<code>hcl</code>、<code>hhr</code>和<code>wcf</code>在的地方总会gay起来、手感极佳的<code>cl</code>、同学院的本校考研的硬件大佬<code>wyb</code>、健行大佬NPL之星<code>zyl</code>和量子计算<code>yx</code>、群友氛围大师<code>fyl</code>、手冲咖啡大师<code>zky</code>、每次发言都很精辟的<code>章远</code>，还有不说都不知道比我们小一届的<code>小农(NJS)</code>。</li>
<li>还有一些沉默的群友，由于各种原因离开的群友。</li>
</ul>
<h5 id="在通信1803和信息学院"><a href="#在通信1803和信息学院" class="headerlink" title="在通信1803和信息学院"></a>在通信1803和信息学院</h5><ul>
<li>‘虹桥恶霸’<code>竹an纸(lch)</code>、永嘉矿主儿子<code>___雨、落。(XJ)</code>、开派对的<code>钟小红(ZZH)</code>还有<code>璋哥(PJZ)</code>和<code>刘某(LPY)</code></li>
<li>辅导员<code>超哥</code>、助班<code>熊姐</code>、勤勤恳恳的<code>脖子(LYB)</code>、和保研失之交臂的<code>豪宇(SHY)</code>、高冷男神<code>高航(SGH)</code>、志同道合的<code>来子哥(DJL)</code>、不拘一格的凌乱的经常借螺丝刀的<code>SHX</code>、打牌横行霸道的<code>张'China'(ZZH)</code>。</li>
<li>军训带了半个年级训练，在班里和学院里认识的人很多，但可以说其实很多都不太熟悉。</li>
</ul>
<h3 id="始于戊戌年初秋，终于壬寅年盛夏"><a href="#始于戊戌年初秋，终于壬寅年盛夏" class="headerlink" title="始于戊戌年初秋，终于壬寅年盛夏"></a>始于戊戌年初秋，终于壬寅年盛夏</h3><ul>
<li>入学前的那个<strong>暑假</strong>，机缘巧合初识开发部的各位，<code>琮哥</code>和<code>朱大佬</code>晚间授课，在江边吹着风，怂恿着<code>小花仙学姐</code>在群里唱歌。</li>
<li>迎着朝霞，奔赴<strong>潮王路</strong>，午后下了<strong>暴雨</strong>。</li>
<li>冒着大雨穿着拖鞋赶去了开发部的<strong>宣讲会</strong>，第一次和群友线下见面。</li>
<li>居然去竞选班长了，幸好有这么多人和我竞争，要不然就当上了<span class="github-emoji"><span>😅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li><code>X叔</code>大老远跑来学校给开发部上课。</li>
<li>一言不合就和当时的室友北门<strong>新凯旋</strong>，羊骨汤是真的好喝。</li>
<li>专业确认，一志愿通信工程，二志愿软件工程，三空白。</li>
<li>在金库老板们的带领下第一次去海底捞，排练年会的<strong>滑稽脸</strong>节目，去屏峰和另一群小伙伴轰趴。</li>
<li>每天早起吃一碗精弘食堂的拌面，去操场早打卡的路上偷蚂蚁森林，然后去图书馆预习高数，最喜欢<strong>朝晖图书馆</strong>三楼向阳靠窗的位置。</li>
<li>在那个阴雨绵绵夏日，搬离了尚5的419寝室，来到了东2的506。</li>
<li>和<code>文靖(QWJ)</code>与<code>凯(ZK)</code>还有<code>晓洁(WXJ)</code>去丽水社会实践，热、蚊子和风景。</li>
<li>军训和大多数人不同，是段特殊的经历。</li>
<li>裘姐高考结束了，怎么会有人拿农夫山泉当清汤锅底。</li>
<li>计划着进<code>潘老师(PQ)</code>的医学影像处理项目组，后来受到疫情的影响加上学生工作的事情，慢慢就鸽掉了这边，还是有点愧疚的<span class="github-emoji"><span>😥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f625.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>接过<strong>精弘</strong>的接力棒，去金华和义乌社会实践，第一次带这么多小朋友，激动又局促，慢慢改掉了社恐，扛起毅行的大旗。各个方面精弘都处于瓶颈期，需要再次出现精弘之光，我们无法改变大形势和指导老师，但在低谷期我们要的是有原则有底线，有主见有骨气，在这里就是一家人。挥一挥手<span class="github-emoji"><span>🙌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f64c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，现在也是时候和精弘说再见了。</li>
<li>开发部的<strong>良渚春游</strong>、欢送学长学姐的酒局<span class="github-emoji"><span>🍻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f37b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>也有幸在易班的组织下，在成都和上海结识了一些来自天南海北的朋友，尽管很多模式并不适用，互相交流还是受益匪浅。</li>
<li>大三考试结束，临时起意，和室友说走就走去了嘉兴南湖。</li>
<li>抱着试试的心态投了一些<strong>暑期实习</strong>，最后去了<strong>杭州CMCC</strong>的技术岗。这里要感谢<code>娟姐(YJ)</code>的推荐，过去发现同行的都是研究生<span class="github-emoji"><span>😧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f627.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。免费食堂很好吃，虽然没有明确的培养计划，不像互联网大厂那么完善的实习生体系，但却多了几分人性化，在这里赚到了第一桶金，感谢<code>冯辰凯</code>以及相处一个多月的前辈们像小朋友一样照顾我，更加清楚地认识到这个行业。</li>
<li><strong>保研</strong>是一场恶战，目睹了边缘人大起大落，身边也有好几个朋友因电设国赛延期错失机会，恭喜且羡慕那些多年的朋友能够冲到顶尖名校。刚开始还是挺开心的不用复习考研，看着他们早出晚归很折磨，但慢慢地感觉到特别是在身边好多人考研结束后，反倒是有一种心理落差。很幸运能够找到喜欢的方向，不错的导师，航空报国吾辈义不容辞。谢谢在焦虑的路上一起吐槽、分享和鼓励的<code>涵莹</code>，很庆幸能遇到你<span class="github-emoji"><span>✌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>保研结束去了长沙，没有任何规划，坡子街派出所隔壁的深夜网吧，无拘无束的旅行才是我想要的。</li>
<li>在<strong>某事业单位</strong>实习五个月，<code>沈主任(SXQ)</code>、<code>饶主任(RX)</code>，<code>陈老师(CLH)</code>，<code>彭老师(PYH)</code>，<code>瞿老师(QT)</code>，<code>葛老师(GX)</code>都像对待孩子一样对待我们，会请我们喝奶茶，带我们出去吃饭去看展，也曾熬夜加班，周末改需求，在<strong>193路公交车</strong>上看着日落和晚霞。</li>
<li><p>其实从前一年起，身边开始有陆续毕业<strong>奔赴各地</strong>升学或是工作。这里尤其要感谢<code>粥粥</code>人生态度和为人处世影响了很多，要记得多运动减肥，<code>bq</code>带着担起重任，有空记得多约恰饭，<code>zdl</code>虽然一直在调侃但确实是大学期间最佩服的人，那天操场遇到一起走了很多圈聊了很多，<code>yy</code>吃苦耐劳的好部长cbd忠实粉丝，<code>小花仙</code>在我迷茫的时候指引了很多，<code>Congb19</code>编程启蒙导师，以及很多···虽然有的不怎么联系了，无论在何处，顺利与否，每次看见大家分享的生活都有种特殊的亲切。</p>
</li>
<li><p>毕设选了<code>陈老师(CJY)</code>和<code>施老师(SZX)</code>的一个NLP项目，很有意思但实话实说我没有全身心投入去做，因为懒没有去实验室，借着Colab和1050整天风扇嗡嗡。原始数据缺失，从头开始做，尽管最后勉勉强强完成了，但还有很多需要改进的地方，催着我发论文和专利，思忖再三还是决定不发，感觉完整性不够创新性不足，数据验证不充分，很感谢两位老师的倾心指导。</p>
</li>
</ul>
<h3 id="毕业前最后几天"><a href="#毕业前最后几天" class="headerlink" title="毕业前最后几天"></a>毕业前最后几天</h3><ul>
<li>去夜爬了<strong>宝石山</strong>看西湖夜景，最后一次去<strong>莫干山校区</strong>看了夏季风，和<strong>精弘后花园</strong>、<strong>新媒体永不下班</strong>还有<strong>老年棋牌室</strong>的朋友们约饭约拍照<span class="github-emoji"><span>📷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>坐上了<strong>三号线</strong>后通段，前往浙江工业大学屏峰校区的乘客请在此站下车。</li>
<li>独自一人夜爬<strong>北高峰</strong>看日出<span class="github-emoji"><span>🌅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f305.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>收到了小朋友们送的花花<span class="github-emoji"><span>🌸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f338.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，还是挺高兴和激动的<span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>。</li>
<li>毕业典礼那天，去吃了养贤的<strong>千其农家面</strong>，阿姨问我是不是毕业了，有些感动，那天的面特别多。一直在这吃了三年，中午下课，图书馆学习回来又或是周末，每次过来阿姨都知道我要吃肥牛拌川。</li>
<li>下午一起拍了很多很多毕业照<span class="github-emoji"><span>😙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f619.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li>
<li>最后一晚去养贤314，出门时碰到一个许久未见的小朋友<code>WHW</code>，还是那么熟悉和亲切，他祝我毕业快乐，我和他说以后也要加油。反应过来最后匆匆忙忙，很多人都还来不及道别，那么就在这里说一声后会有期吧，大家都要好好的。</li>
<li>会记得从朝晖的三楼到屏峰的四楼，伴随着图书馆闭馆铃声的响起，收拾书包结束一天的学习。</li>
<li>会记得从尚12到机械楼B108再到养贤314和德10C108的每一次相聚。</li>
<li>会记得古运河畔的烈日与午潮山的刺骨寒风。</li>
</ul>
<h3 id="毕业旅行"><a href="#毕业旅行" class="headerlink" title="毕业旅行"></a>毕业旅行</h3><p><a href="https://www.lingzhicheng.cn/">有些待办需要先解决，还在计划中，预计七月底八月初</a></p>
<h3 id="以后怎么走"><a href="#以后怎么走" class="headerlink" title="以后怎么走"></a>以后怎么走</h3><ul>
<li>目前顺利从工大毕业啦，还有很多新东西要学，旧知识也要抓紧重新拾起，希望导师和师兄师姐多带带。</li>
<li>还有很多地方想去，云南、西安、重庆、三亚···吃的和风土人情，有兴趣一起可以联系我。</li>
<li>终极目标是DJI算法岗，长路漫漫，哪怕在深圳和上海也可以；或者有幸参与某机型<span class="github-emoji"><span>✈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2708.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>的预研，喜欢鹰击长空的气概；还在考虑要不要转博，从最开始的<span class="github-emoji"><span>🐶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f436.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>都不读，到现在其实有些动摇了。</li>
</ul>
<h3 id="ZJUT再见"><a href="#ZJUT再见" class="headerlink" title="ZJUT再见"></a>ZJUT再见</h3><ul>
<li>那么就写到这里吧，每一年都很精彩，今年也会，明年也会。</li>
<li>我很理性，但爱憎分明，正直而坦白，走自己的路，说想说的话，留住更多美好的东西</li>
<li>鹏北海，风朝阳。又携书剑路茫茫。</li>
<li>纵有千古，横有八荒；前途似海，来日方长。</li>
</ul>
<blockquote>
<p>最后修改于2022/06/27</p>
</blockquote>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
  </entry>
  <entry>
    <title>正则表达式整理（持续更新）</title>
    <url>/2021/02/17/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%95%B4%E7%90%86/</url>
    <content><![CDATA[<blockquote>
<p>偶尔会用到正则匹配，下面做一个常用的正则表达式整理以便往后查询</p>
</blockquote>
<span id="more"></span>
<h2 id="最常用的匹配"><a href="#最常用的匹配" class="headerlink" title="最常用的匹配"></a>最常用的匹配</h2><div class="table-container">
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>\d</code></strong></td>
<td>表示任意数字，就是阿拉伯数字<code>0~9</code>这些。</td>
</tr>
<tr>
<td><code>\D</code></td>
<td>大写的表示与小写的相反，表示不是数字。</td>
</tr>
<tr>
<td><code>\w</code></td>
<td>代表字母，数字，下划线。<code>a-z</code>、<code>A-Z</code>、<code>0~9</code>、<code>_</code>。</td>
</tr>
<tr>
<td><code>\W</code></td>
<td>大写的表示与小写的相反，不是字母、不是数字也不是下划线。</td>
</tr>
<tr>
<td><strong><code>\n</code></strong></td>
<td>代表一个回换行。</td>
</tr>
<tr>
<td><code>\r</code></td>
<td>代表一个回车。</td>
</tr>
<tr>
<td><code>\f</code></td>
<td>代表换页。</td>
</tr>
<tr>
<td><code>\t</code></td>
<td>代表一个<code>Tab</code>。</td>
</tr>
<tr>
<td><code>\s</code></td>
<td>代表所有的空白符，也就是上面四个：<code>\n</code>、<code>\r</code>、<code>\f</code>、<code>\t</code>。</td>
</tr>
<tr>
<td><code>\S</code></td>
<td>大写的表示与小写的相反，代表所有不是空白的字符。</td>
</tr>
<tr>
<td><code>\A</code></td>
<td>代表字符串的开始。</td>
</tr>
<tr>
<td><code>\Z</code></td>
<td>代表字符串的结束。</td>
</tr>
<tr>
<td><strong><code>^</code></strong></td>
<td>匹配字符串开始的位置。</td>
</tr>
<tr>
<td><strong><code>$</code></strong></td>
<td>匹配字符串结束的位置。</td>
</tr>
<tr>
<td><strong><code>.</code></strong></td>
<td>代表所有的单个字符，除了换行<code>\n</code>,回车<code>\r</code>。</td>
</tr>
<tr>
<td><code>[...]</code></td>
<td>代表在<code>[]</code>范围内的字符，比如<code>[a-z]</code>就代表<code>a-z</code>的字母。</td>
</tr>
<tr>
<td><code>[^...]</code></td>
<td>与上一个相反，代表不在<code>[]</code>范围内的字符。</td>
</tr>
<tr>
<td><code>{n}</code></td>
<td>匹配在<code>{n}</code>前面的东西，比如<code>o{2}</code>不能匹配<code>Bob</code>中的<code>o</code>，但是能匹配<code>food</code>中的两个<code>o</code>。</td>
</tr>
<tr>
<td><code>{n,m}</code></td>
<td>匹配在<code>{n,m}</code>前面的东西，比如<code>o{1,3}</code>将匹配<code>fooooood</code>中的前三个<code>o</code>。</td>
</tr>
<tr>
<td><code>{n, }</code></td>
<td>匹配在<code>{n,}</code>前面的东西，比如<code>o{2,}</code>不能匹配<code>Bob</code>中的<code>o</code>，但是能匹配<code>foooood</code>中的所有<code>o</code>。</td>
</tr>
<tr>
<td><code>*</code></td>
<td>和<code>{0,}</code>一样，匹配<code>*</code>前面的0次或多次。比如<code>zo*</code>能匹配<code>z</code>、<code>zo</code>以及<code>zoo</code>。</td>
</tr>
<tr>
<td><code>+</code></td>
<td>和<code>{1,}</code>一样，匹配+前面1次或多次。比如<code>zo+</code>能匹配<code>zo</code>以及<code>zoo</code>但不能匹配<code>z</code></td>
</tr>
<tr>
<td><code>?</code></td>
<td>和<code>{0,1}</code>一样，匹配<code>?</code>前面0次或1次</td>
</tr>
<tr>
<td><code>()</code></td>
<td>匹配括号里的内容</td>
</tr>
</tbody>
</table>
</div>
<h2 id="re-match"><a href="#re-match" class="headerlink" title="re.match"></a>re.match</h2><blockquote>
<p>传入两个参数，第一个是匹配的规则，第二个是需要被过滤的内容</p>
</blockquote>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'you have 100 bananas.'</span></span><br><span class="line">res = re.match(<span class="string">'^yo.*(\d+)\s.*s$'</span>,content)</span><br><span class="line"><span class="built_in">print</span>(res.group(<span class="number">1</span>))</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>re.match</tag>
      </tags>
  </entry>
  <entry>
    <title>调频无线话筒</title>
    <url>/2021/03/10/%E8%B0%83%E9%A2%91%E6%97%A0%E7%BA%BF%E8%AF%9D%E7%AD%92/</url>
    <content><![CDATA[<p>较为详细的实验总结，需要的可以借鉴参考</p>
<span id="more"></span>
<ul>
<li><p><strong>浙江工业大学信息工程学院通信电子线路课程设计</strong></p>
</li>
<li><p>设计制作：熟悉和掌握通信电子线路的一般设计步骤与方法、电路制作和调试一般步骤和方法</p>
</li>
<li>CAD设计：掌握电子电路的制图工具，进一步了解和掌握电子线路设计中原理图和PCB图的设计方法和技能</li>
</ul>
<hr>
<h2 id="一、实验目的"><a href="#一、实验目的" class="headerlink" title="一、实验目的"></a>一、实验目的</h2><blockquote>
<p>掌握调频发射机整机电路的设计与调试方法，以及高频电路的调试中常见故障的分析与 排除；学会如何将高频单元电路组合起来实现满足工程实际要求的整机电路的设计与调试技术</p>
</blockquote>
<h2 id="二、参考设计"><a href="#二、参考设计" class="headerlink" title="二、参考设计"></a>二、参考设计</h2><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/System.png" alt="系统框图"></p>
<center><font size="2">图1 小功率调频无线话筒的系统框图</font></center>

<blockquote>
<p>对于小功率的调频无线话筒，设计时在保证技术指标的前提下，应力求电路简单、性能 稳定可靠。单元电路级数尽可能少，以减小级间的相互感应、干扰和自激，工作在调频广播频段（87MHz~108MHz）。高频功放在发射功 率较小时可工作于甲类状态</p>
</blockquote>
<h3 id="高频部分等效电路"><a href="#高频部分等效电路" class="headerlink" title="高频部分等效电路"></a>高频部分等效电路</h3><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/equal.png" alt="等效电路"></p>
<center><font size="2">图2 高频部分等效电路</font></center>

<h2 id="三、仪器与工具"><a href="#三、仪器与工具" class="headerlink" title="三、仪器与工具"></a>三、仪器与工具</h2><blockquote>
<p>1.直流稳压电源<br>2.数字万用表<br>3、示波器（≥100MHz）<br>4、调频收音机（87~108MHz）<br>5、烙铁、镊子、斜口钳等</p>
</blockquote>
<h2 id="四、技术指标"><a href="#四、技术指标" class="headerlink" title="四、技术指标"></a>四、技术指标</h2><h3 id="4-1发射功率"><a href="#4-1发射功率" class="headerlink" title="4.1发射功率"></a>4.1发射功率</h3><blockquote>
<p>发射机输送到天线上的功率，当天线长度L与发射频率波长可以和$\lambda$比拟时，天线才能有效地将信号发送出去</p>
</blockquote>
<h3 id="4-2工作频率或波段"><a href="#4-2工作频率或波段" class="headerlink" title="4.2工作频率或波段"></a>4.2工作频率或波段</h3><blockquote>
<p>发射机的工作频率之其载波频率，根据调制方式，在国家有关部门所规定的范围内选取，广播通信常用波段可查阅有关书籍，对于调频发射机，工作频率一般在超短波范围内（30MHz ~ 300MHz）。调频广播段规定为87MHz ~ 108MHz</p>
</blockquote>
<h3 id="4-3总效率"><a href="#4-3总效率" class="headerlink" title="4.3总效率"></a>4.3总效率</h3><blockquote>
<p>发射机发射的总功率$P<em>{A}$与其消耗的总功率$P</em>{C}^{‘}$之比称为发射机的总效率$\eta_{A}$</p>
</blockquote>
<h3 id="4-4输出阻抗"><a href="#4-4输出阻抗" class="headerlink" title="4.4输出阻抗"></a>4.4输出阻抗</h3><blockquote>
<p>一般要求50Ω</p>
</blockquote>
<h3 id="4-5残波辐射"><a href="#4-5残波辐射" class="headerlink" title="4.5残波辐射"></a>4.5残波辐射</h3><blockquote>
<p>功率与有效输出功率之比</p>
</blockquote>
<h3 id="4-6信杂比"><a href="#4-6信杂比" class="headerlink" title="4.6信杂比"></a>4.6信杂比</h3><blockquote>
<p>在规定频偏的情况下经理想解调后有用信号功率与载波功率之比</p>
</blockquote>
<h3 id="4-7失真度"><a href="#4-7失真度" class="headerlink" title="4.7失真度"></a>4.7失真度</h3><blockquote>
<p>在规定频偏的情况下经理想解调后单音频信号的失真度</p>
</blockquote>
<h3 id="4-8频率响应"><a href="#4-8频率响应" class="headerlink" title="4.8频率响应"></a>4.8频率响应</h3><blockquote>
<p>在规定频偏的情况下经理想解调后输出音频的幅频响应</p>
</blockquote>
<h2 id="五、系统原理分析"><a href="#五、系统原理分析" class="headerlink" title="五、系统原理分析"></a>五、系统原理分析</h2><h3 id="5-1音频放大"><a href="#5-1音频放大" class="headerlink" title="5.1音频放大"></a>5.1音频放大</h3><blockquote>
<p>低频放大，由三极管实现功能</p>
<p>微型麦克风将采集的语言信号转换成电压信号输入电路，R15微麦克风偏置电阻，用来确定麦克风的静态工作点。C16电容用来稳定放大器，同时起到低通滤波的作用。R16、R17、R18、R19、R20为三极管9013的偏置电阻。C17为旁路电容，三极管静态工作时，不起任何作用。当输入交流信号时，R19被C17短路，C14、C15接地起到滤波作用。C18为隔离电容</p>
<p>理论上该部分能对输入的语音信号放大10倍左右，被放大后的语音信号就是调频系统的基带信号</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/Audio_amplification_module.png" alt="音频放大"></p>
<center><font size="2">图3 音频放大模块</font></center>

<h3 id="5-2高频振荡与频率调制"><a href="#5-2高频振荡与频率调制" class="headerlink" title="5.2高频振荡与频率调制"></a>5.2高频振荡与频率调制</h3><blockquote>
<p>调频系统中，用一个频率高的信号作为载波。载波的频率将被基带信号所控制，携带基带信号的全部信息</p>
<p>采用电容三端式振荡器，加了变容二极管Cx1和反馈网络，外接电源后只要有一个微小的开关扰动就能自激振荡，最终输出频率为几十兆的正弦波。通过调节可调电感L1，可逐渐改变正弦波的频率直至达到期望值</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/High_frequency_oscillation_and_frequency_modulation_module.png" alt="高频振荡与频率调制"></p>
<center><font size="2">图4 高频振荡与频率调制模块</font></center>

<h3 id="5-3缓冲隔离与高频功放"><a href="#5-3缓冲隔离与高频功放" class="headerlink" title="5.3缓冲隔离与高频功放"></a>5.3缓冲隔离与高频功放</h3><blockquote>
<p>缓冲高频振荡部分输出的信号，同时隔离前后级电路</p>
<p>采用射极跟随器，三极管T2 9018的静态工作点由偏置电阻R7、R8、R9确定。此处同样设置了一个简单的模拟滤波电路，由C12、C13、L4构成，C9为隔离电容</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/Buffer_isolation_module.png" alt="缓冲隔离"></p>
<center><font size="2">图5 缓冲隔离模块</font></center>

<blockquote>
<p>高频振荡电路输出的调制信号幅值一般较小，而话筒天线传输出去的信号是在无线信道中传播的，必然存在一定程度上的幅值衰减，所以必须在震荡电路之后添加一个高频功率放大器。</p>
<p>高频功放由三极管T3 9018，电阻R10、R11、R12作为偏置电阻确定静态工作点。C10和可调电感L3组成LC回路，谐振在载频上，输出波形的峰峰值$V_{pp}$可由L3调节</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/High-frequency_amplifier_module.png" alt="高频功放"></p>
<center><font size="2">图6 高频功放模块</font></center>

<h2 id="六、-操作步骤与数据记录"><a href="#六、-操作步骤与数据记录" class="headerlink" title="六、 操作步骤与数据记录"></a>六、 操作步骤与数据记录</h2><blockquote>
<p>熟悉参考电路原理图，理解各个电路部分的功能，明确整理设计思路；<br>根据原理图，对预配置的实际元器件进行合理布局；<br>利用现有的实际元器件，在万用板上进行电路安装；<br>检查各个元器件的安装，然后进行焊接；<br>利用万用表，依次检查麦克风的输出电压，各个三极管的静态工作点；<br>利用示波器，观察JP2处的输出波形，注意其频率值，轻弹麦克风发生波形变化；<br>麦克风正极加Vpp=50mV，f=1KHz的正弦波，示波器测JP2左侧波形放大倍数；<br>在上述步骤均正常的情况下，高频示波器ns档位测试稳定波形，观察JP3处的波形，调节L1和L3使幅值和频率满足要求；<br>利用调频收音机，实际调试整个无线话筒的功能，测试工作频段，可使用的实测距离等；<br>完成实验，记录数据，验收。</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>三极管/电极</th>
<th>基极b/V</th>
<th>发射极e/V</th>
<th>集电极c/V</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1 9018</td>
<td>2.918</td>
<td>2.190</td>
<td>6.901</td>
</tr>
<tr>
<td>T2 9018</td>
<td>5.356</td>
<td>4.818</td>
<td>9.030</td>
</tr>
<tr>
<td>T3 9018</td>
<td>2.872</td>
<td>2.102</td>
<td>9.006</td>
</tr>
<tr>
<td>T4 9018</td>
<td>2.533</td>
<td>1.879</td>
<td>5.663</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>高频振荡实际频率89.5MHz，发射距离约45m；<br>麦克风两端电压7.4V<br>R5和R6之间的电压值为V=4.094V，接近4V，达到预期值<br>麦克风正极加Vpp=50mV，f=1KHz的正弦波，放大倍数约为11倍<br>天线输出信号的峰峰值Vpp=1.70V，达到预期值</p>
</blockquote>
<h3 id="❗建议"><a href="#❗建议" class="headerlink" title="❗建议"></a>❗建议</h3><p>80~100MHz内强信号广播较多，如若性能不佳，可尝试改变L1将频率调整至80MHz以下或100MHz以上，干扰较小</p>
<h3 id="附录👇"><a href="#附录👇" class="headerlink" title="附录👇"></a><em>附录👇</em></h3><h4 id="附1：SCH"><a href="#附1：SCH" class="headerlink" title="附1：SCH"></a><em>附1：SCH</em></h4><blockquote>
<p>SCH图👇</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/SCH_new.png" alt="修改之后的SCH图"></p>
<center><font size="2">图7 SCH</font></center>

<h4 id="附2：PCB"><a href="#附2：PCB" class="headerlink" title="附2：PCB"></a><em>附2：PCB</em></h4><blockquote>
<p>经过优化的PCB图👇</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/PCB_new.png" alt="经过优化的PCB图"></p>
<center><font size="2">图8 PCB</font></center>

<blockquote>
<p>较为紧凑，封装与实物所用略有不同，稍有出入。实物上C9在焊接时两引脚掰开，中间空了一格走地线，PCB图中有所不同</p>
</blockquote>
<h4 id="附3：实物图正面"><a href="#附3：实物图正面" class="headerlink" title="附3：实物图正面"></a><em>附3：实物图正面</em></h4><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/Real_positive.jpg" alt="Real_positive"></p>
<center><font size="2">实物图正面</font></center>

<h4 id="附4：实物图反面"><a href="#附4：实物图反面" class="headerlink" title="附4：实物图反面"></a><em>附4：实物图反面</em></h4><p><img src="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM/Real_opposite.jpg" alt="Real_opposite"></p>
<center><font size="2">实物图反面</font></center>

<h4 id="附5：源文件下载"><a href="#附5：源文件下载" class="headerlink" title="附5：源文件下载"></a><em>附5：源文件下载</em></h4><!-- markdownlint-disable-file MD025 MD033 MD028-->
<p><a href="https://cdn.jsdelivr.net/gh/boom1999/boom1999.github.io@hexo_backup/images/PCB/2021FM.zip">Altium Designer工程源文件</a></p>
]]></content>
      <categories>
        <category>Communication</category>
      </categories>
      <tags>
        <tag>Modulation</tag>
        <tag>High-frequency circuits</tag>
        <tag>PCB</tag>
      </tags>
  </entry>
  <entry>
    <title>抓取道客巴巴内容</title>
    <url>/2021/10/20/%E6%8A%93%E5%8F%96%E9%81%93%E5%AE%A2%E5%B7%B4%E5%B7%B4%E5%86%85%E5%AE%B9/</url>
    <content><![CDATA[<p><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>一般需要登陆账号付费购买，并且会员还不便宜，淘宝单次购买比较划算</li>
<li>这里直接从控制台抓取道客巴巴文档，存为png格式图片，可以根据自己的需求转化为PDF<br><span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>🕤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f564.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<blockquote>
<p>直接打开浏览器控制台，输入以下脚本：</p>
</blockquote>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">downloadPages</span>(<span class="params"><span class="keyword">from</span>, to</span>) {</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="keyword">from</span>; i &lt;= to; i++) {</span><br><span class="line">        <span class="keyword">const</span> pageCanvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'page_'</span> + i);</span><br><span class="line">        <span class="keyword">if</span> (pageCanvas === <span class="literal">null</span>) { <span class="keyword">break</span>; }</span><br><span class="line">        <span class="keyword">const</span> pageNo = <span class="built_in">parseInt</span>(<span class="title class_">String</span>(i));</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"==pageNo==&gt;&gt;"</span>, pageNo);</span><br><span class="line">            (<span class="function">(<span class="params">num</span>) =&gt;</span> {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"开始打印第"</span> + num + <span class="string">"页"</span>);</span><br><span class="line">                pageCanvas.<span class="title function_">toBlob</span>(</span><br><span class="line">                    <span class="function"><span class="params">blob</span> =&gt;</span> {</span><br><span class="line">                        <span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">'a'</span>);</span><br><span class="line">                        anchor.<span class="property">download</span> = <span class="string">'page_'</span> + num + <span class="string">'.png'</span>;</span><br><span class="line">                        anchor.<span class="property">href</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">                        anchor.<span class="title function_">click</span>();</span><br><span class="line">                        <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(anchor.<span class="property">href</span>);</span><br><span class="line">                    }</span><br><span class="line">                );</span><br><span class="line">            })(pageNo);</span><br><span class="line">        }, <span class="number">500</span> * pageNo);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>downloadPages(page_from, page_to);</code> 例如打印第3~5页即输入<code>downloadPages(3, 5);</code></p>
<ul>
<li>图片会由浏览器直接下载，可能会提示是否允许连续下载多个文件，同意即可</li>
<li>需要注意：<span class="github-emoji"><span>❗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>要提前浏览全部文档，等待浏览器加载成功，否则将保存为纯黑无内容的图片</li>
</ul>
]]></content>
      <categories>
        <category>Summary</category>
      </categories>
      <tags>
        <tag>Tutorial</tag>
      </tags>
  </entry>
</search>

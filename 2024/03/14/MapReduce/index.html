<!DOCTYPE html>


<html lang="en">


<head>
  <meta name="google-site-verification" content="QbUVAi0K2ZB_P4A6jbbi-GVB4BXs3n6GqgIEGHlySnk" />
  <meta charset="utf-8" />
   
  <meta name="keywords" content="Torch, Summary, UAV, Git" />
   
  <meta name="description" content="No fear of words,no fear of years" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    MapReduce in Distributed Systems |  Haisenberg
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

<link rel="alternate" href="/atom.xml" title="Haisenberg" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-MapReduce"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  MapReduce in Distributed Systems
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2024/03/14/MapReduce/" class="article-date">
  <time datetime="2024-03-14T00:00:00.000Z" itemprop="datePublished">2024-03-14</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Summary/">Summary</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">6.5k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading timeâ‰ˆ</span>
            <span class="post-count">29 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p><span class="github-emoji"><span>ğŸ“Œ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<ul>
<li>MIT 6.824 Distributed Systems Lab-1-Golang<br><span class="github-emoji"><span>ğŸ’¨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ•¥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f565.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ˜´</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span id="more"></span>
</li>
</ul>
<h1 id="MIT-6-824-Distributed-Systems"><a href="#MIT-6-824-Distributed-Systems" class="headerlink" title="MIT 6.824 Distributed Systems"></a>MIT 6.824 Distributed Systems</h1><h1 id="Lecture-01-Introduction"><a href="#Lecture-01-Introduction" class="headerlink" title="Lecture 01 - Introduction"></a>Lecture 01 - Introduction</h1><h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/schedule.html">MIT 6.5840 Schedule: Spring 2024</a></li>
<li><a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/schedule.html">MIT 6.824 Schedule: Spring 2020</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=cQP8WApzIQQ&amp;list=PLrw6a1wE39_tb2fErI4-WkMbsvGQk9_UB">Youtube 2020</a></li>
<li>BiliBili Translated:<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1x7411M7Sf/?spm_id_from=333.999.0.0&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc">https://www.bilibili.com/video/BV1x7411M7Sf/?spm_id_from=333.999.0.0&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1R7411t71W/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc">https://www.bilibili.com/video/BV1R7411t71W/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=2c248c46a7ba66244aa5b9fb5b07d4fc</a></li>
</ul>
</li>
</ul>
<h2 id="MapReduce-åŸºæœ¬å·¥ä½œæ–¹å¼"><a href="#MapReduce-åŸºæœ¬å·¥ä½œæ–¹å¼" class="headerlink" title="MapReduce åŸºæœ¬å·¥ä½œæ–¹å¼"></a>MapReduce åŸºæœ¬å·¥ä½œæ–¹å¼</h2><p><img src="https://www.lingzhicheng.cn/usr/file/picture/MIT/MapReduce.PNG" alt="Read MapReduce(2024) png"></p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">Read MapReduce(2024)</a></p>
<p><strong>Mapï¼š</strong> æ¥å—ä¸€ä¸ªé”®å€¼å¯¹(key-value pair)ï¼Œäº§ç”Ÿä¸€ç»„ä¸­é—´é”®å€¼å¯¹ã€‚MapReduce ä¼šå°† Map å‡½æ•°äº§ç”Ÿçš„ä¸­é—´é”®å€¼å¯¹ä¼ é€’ç»™ä¸€ä¸ª Reduce å‡½æ•°ã€‚</p>
<p><strong>Reduceï¼š</strong> æ¥å—ä¸€ä¸ªé”®ä»¥åŠç›¸å…³çš„ä¸€ç»„å€¼ï¼Œå°†è¿™ç»„å€¼è¿›è¡Œåˆå¹¶äº§ç”Ÿä¸€ç»„è§„æ¨¡æ›´å°çš„å€¼(é€šå¸¸åªæœ‰ä¸€ä¸ªæˆ–é›¶ä¸ªå€¼)ã€‚</p>
<p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼ŒReduce å‡½æ•°ä½¿ç”¨ Iterator è¯»å–ä¸­é—´ç»“æœï¼Œä¸ºäº†é˜²æ­¢å€¼è¿‡å¤šï¼Œè€Œæ— æ³•å…¨éƒ¨æ”¾åˆ°å†…å­˜ä¸­ã€‚</p>
<p><strong>Types:</strong></p>
<p><code>map    (k1,v1)       -&gt; list(k2,v2)</code></p>
<p><code>reduce (k2,list(v2)) -&gt; list(v2)</code></p>
<p>è¯é¢‘ç»Ÿè®¡ä¼ªä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>(String key, String value):</span><br><span class="line">    <span class="comment">// key: document name</span></span><br><span class="line">    <span class="comment">// value: document contents</span></span><br><span class="line">    <span class="keyword">for</span> each word w in value:</span><br><span class="line">        <span class="built_in">EmitIntermediate</span>(w, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">reduce</span>(String key, Iterator values):</span><br><span class="line">    <span class="comment">// key: a word</span></span><br><span class="line">    <span class="comment">// values: a list of counts</span></span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> each v in values:</span><br><span class="line">        result += <span class="built_in">ParseInt</span>(v);</span><br><span class="line">    <span class="built_in">Emit</span>(<span class="built_in">AsString</span>(result));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><ol>
<li>ç”¨æˆ·ç¨‹åºå°†è¾“å…¥æ–‡ä»¶åˆ‡åˆ†ä¸º M ä¸ª 16ï½64MB ä¹‹é—´çš„ splitï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»ºç¨‹åºå‰¯æœ¬ã€‚</li>
<li>ç¨‹åºå‰¯æœ¬åˆ†ä¸º 1 ä¸ª Master å’Œå¤šä¸ª Workerã€‚Master é€‰å–ç©ºé—²çš„ Workerï¼Œå¹¶ä¸ºå…¶åˆ†é… Map ä»»åŠ¡æˆ– Reduce ä»»åŠ¡ã€‚Master å­˜å‚¨ä»»åŠ¡çš„çŠ¶æ€(ç©ºé—²ï¼Œå·¥ä½œä¸­ï¼Œå®Œæˆ)å’Œ worker æœºå™¨(éç©ºé—²ä»»åŠ¡çš„æœºå™¨)çš„æ ‡è¯†ã€‚</li>
<li>Mapper è¯»å–å¯¹åº”çš„ split å¹¶<strong>è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ map å‡½æ•°</strong>è§£æä¸ºé”®å€¼å¯¹ï¼Œå°†è¾“å‡ºçš„ä¸­é—´ç»“æœé”®å€¼å¯¹å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚</li>
<li>Mapper å°†ç¼“å­˜çš„é”®å€¼å¯¹é€šè¿‡ Partition å‡½æ•°(é€šå¸¸ä¸º hash(key) mod R)åˆ’åˆ†ä¸º R ä¸ªéƒ¨åˆ†ï¼Œå¹¶å‘¨æœŸæ€§åœ°å†™å…¥æœ¬åœ°ç£ç›˜ï¼ŒåŒæ—¶å°†æœ¬åœ°ç£ç›˜ä¸Šä¸­é—´ç»“æœçš„ä½ç½®ä¿¡æ¯å‘é€ç»™ Masterã€‚</li>
<li>Master å°†æ”¶åˆ°çš„ä¸­é—´ç»“æœçš„ä½ç½®ä¿¡æ¯å‘é€ç»™ Reducerï¼ŒReducer é€šè¿‡ RPC è¯»å–å­˜å‚¨åœ¨ Mapper æœ¬åœ°ç£ç›˜ä¸Šçš„ä¸­é—´ç»“æœã€‚åœ¨è¯»å–å®Œæ¯•åï¼Œ<u>Reducer ä¼šæ ¹æ® key å¯¹ä¸­é—´ç»“æœè¿›è¡Œæ’åº</u>ã€‚</li>
<li>å¯¹æ¯ä¸€ä¸ª key å’Œå…¶å¯¹åº”çš„ä¸€ç»„å€¼ï¼Œ<strong>è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ Reduce å‡½æ•°</strong>è¿›è¡Œå¤„ç†ï¼Œè¾“å‡ºç»“æœå­˜å‚¨åœ¨å¯¹åº”çš„ Reduce Partition æ–‡ä»¶ä¸­ã€‚</li>
<li>å½“æ‰€æœ‰çš„ Map ä»»åŠ¡å’Œ Reduce ä»»åŠ¡å®Œæˆåï¼ŒMaster é€šçŸ¥ç”¨æˆ·ç¨‹åºã€‚</li>
</ol>
<h3 id="å®¹é”™æœºåˆ¶"><a href="#å®¹é”™æœºåˆ¶" class="headerlink" title="å®¹é”™æœºåˆ¶"></a>å®¹é”™æœºåˆ¶</h3><ul>
<li>worker å¤±æ•ˆ</li>
</ul>
<p>Master ä¼š<strong>å‘¨æœŸæ€§åœ° ping</strong> æ¯ä¸€ä¸ª Workerï¼Œå¦‚æœæŸä¸ª Worker åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰å“åº”ï¼ŒMaster å°±ä¼šè®¤ä¸ºè¿™ä¸ª Worker å·²ç»ä¸å¯ç”¨ï¼Œå¯¹å…¶ä¸Šåˆ†é…çš„ä»»åŠ¡<strong>é‡æ–°åˆ†é…</strong>ç»™å…¶ä»– Workerã€‚</p>
<ul>
<li>master å¤±æ•ˆ</li>
</ul>
<p>Master ä¼šå‘¨æœŸæ€§åœ°å°†é›†ç¾¤çš„å½“å‰çŠ¶æ€ä½œä¸º <strong>checkpoint</strong> å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚Master å‘ç”Ÿæ•…éšœåï¼Œé‡æ–°å¯åŠ¨ Master å³å¯åˆ©ç”¨å­˜å‚¨åœ¨ç£ç›˜ä¸­çš„æœ€è¿‘çš„ checkpoint è¿›è¡Œ<strong>æ¢å¤</strong>ã€‚</p>
<h3 id="æ•°æ®å­˜å‚¨æœºåˆ¶"><a href="#æ•°æ®å­˜å‚¨æœºåˆ¶" class="headerlink" title="æ•°æ®å­˜å‚¨æœºåˆ¶"></a>æ•°æ®å­˜å‚¨æœºåˆ¶</h3><p>ç”±äºç½‘ç»œå¸¦å®½æ˜¯ä¸€ç§ç›¸å½“åŒ®ä¹çš„è®¡ç®—èµ„æºï¼ŒMapReduce å°†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ï¼Œç”± GFS è¿›è¡Œç®¡ç†ã€‚GFS æŠŠæ¯ä¸€ä»½æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šä¸ª 64MB çš„ blockï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ª block ä¼šåœ¨ä¸åŒçš„æœºå™¨ä¸Šä¿å­˜ä¸‰ä»½å‰¯æœ¬ã€‚Master åœ¨è°ƒåº¦ Map ä»»åŠ¡æ—¶ä¼šè€ƒè™‘è¾“å…¥æ•°æ®çš„ä½ç½®ä¿¡æ¯ï¼Œé‡‡å–<strong>å°±è¿‘åŸåˆ™</strong>ï¼Œå³å°½é‡å°† Map ä»»åŠ¡<strong>è°ƒåº¦åˆ°åŒ…å«ç›¸å…³è¾“å…¥æ•°æ®å‰¯æœ¬çš„æœºå™¨ä¸Šæ‰§è¡Œ</strong>ã€‚å› è€Œå¤§éƒ¨åˆ†è¾“å…¥æ•°æ®å¯ä»¥ä»æœ¬åœ°è¯»å–ï¼Œæ¶ˆè€—éå¸¸å°‘çš„ç½‘ç»œå¸¦å®½ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡æœºåˆ¶"><a href="#è´Ÿè½½å‡è¡¡æœºåˆ¶" class="headerlink" title="è´Ÿè½½å‡è¡¡æœºåˆ¶"></a>è´Ÿè½½å‡è¡¡æœºåˆ¶</h3><p>Master å°† Map ä»»åŠ¡å’Œ Reduce ä»»åŠ¡åˆ’åˆ†ä¸º M å’Œ R ä¸ªç‰‡æ®µï¼Œ<strong>M å’Œ R çš„æ•°é‡åº”è¿œå¤§äºé›†ç¾¤ä¸­ Worker çš„æ•°é‡</strong>ã€‚æ¯ä¸ª Worker æ‰§è¡Œå¤§é‡ä¸åŒçš„ä»»åŠ¡æœ‰åŠ©äºæé«˜é›†ç¾¤çš„åŠ¨æ€è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œå¹¶ä¸”åŠ å¿«æ•…éšœæ¢å¤çš„é€Ÿåº¦ã€‚</p>
<h3 id="å¤‡ä»½ä»»åŠ¡æœºåˆ¶"><a href="#å¤‡ä»½ä»»åŠ¡æœºåˆ¶" class="headerlink" title="å¤‡ä»½ä»»åŠ¡æœºåˆ¶"></a>å¤‡ä»½ä»»åŠ¡æœºåˆ¶</h3><p>å¦‚æœé›†ç¾¤ä¸­æŸä¸ª Worker èŠ±äº†å¾ˆé•¿æ—¶é—´æ‰å®Œæˆæœ€åå‡ ä¸ª Map ä»»åŠ¡æˆ– Reduce ä»»åŠ¡ï¼Œå¯¼è‡´ MapReduce æ€»æ‰§è¡Œæ—¶é—´å»¶é•¿ï¼Œè¿™æ ·çš„ Worker è¢«ç§°ä¸ºè½åè€…(Straggler)ã€‚MapReduce æä¾›äº†å¤‡ä»½ä»»åŠ¡æœºåˆ¶æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚å½“ MapReduce å¿«è¦å®Œæˆæ—¶ï¼Œ<strong>Master ä¸ºå‰©ä¸‹çš„æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å¯åŠ¨å¤‡ä»½ä»»åŠ¡ï¼Œå°†å…¶åˆ†é…ç»™å…¶ä»–çš„ç©ºé—² Worker æ¥æ‰§è¡Œ</strong>ï¼Œå¹¶åœ¨å…¶ä¸­ä¸€ä¸ª Worker å®Œæˆåå°†è¯¥ä»»åŠ¡è§†ä½œå·²å®Œæˆã€‚é€šè¿‡å¤‡ä»½ä»»åŠ¡æœºåˆ¶ï¼Œå¤§å¤§å‡å°‘äº† MapReduce çš„æ‰§è¡Œæ—¶é—´ã€‚</p>
<h2 id="Lab1-MapReduce"><a href="#Lab1-MapReduce" class="headerlink" title="Lab1: MapReduce"></a>Lab1: MapReduce</h2><p>Lab source: <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-mr.html">https://pdos.csail.mit.edu/6.824/labs/lab-mr.html</a></p>
<ul>
<li><p>System <code>(hostnamectl)</code></p>
<ul>
<li>Static hostname: ubuntu</li>
<li>Icon name: computer-vm</li>
<li>Chassis: vm</li>
<li>Virtualization: vmware</li>
<li>Operating System: Ubuntu 18.04.6 LTS</li>
<li>Kernel: Linux 5.4.0-144-generic</li>
<li>Architecture: x86-64</li>
</ul>
</li>
<li><p>Goland version <code>(go version)</code></p>
<ul>
<li>go version go1.19.5 linux/amd64</li>
</ul>
</li>
<li><p>GCC <code>(gcc -version)</code></p>
<ul>
<li>gcc (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0</li>
</ul>
</li>
</ul>
<h3 id="Remote-debug"><a href="#Remote-debug" class="headerlink" title="Remote debug"></a>Remote debug</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/go-delve/delve/cmd/dlv@latest</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Sequential-and-Settings"><a href="#Sequential-and-Settings" class="headerlink" title="Sequential and Settings"></a>Sequential and Settings</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/6.5840</span><br><span class="line">$ <span class="built_in">cd</span> src/main</span><br><span class="line">$ go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">$ <span class="built_in">rm</span> mr-out*</span><br><span class="line">$ go run mrsequential.go wc.so pg*.txt</span><br><span class="line">$ more mr-out-0</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<p>è¿è¡Œ <code>go build -buildmode=plugin ../mrapps/wc.go</code> å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ªæ’ä»¶æ–‡ä»¶ï¼Œå³æ„å»º MR APP çš„åŠ¨æ€é“¾æ¥åº“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æ–‡ä»¶å°†å…·æœ‰ <code>.so</code> æ‰©å±•åï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡æ–‡ä»¶ï¼ˆshared objectï¼‰ï¼Œç”¨äºåŠ¨æ€åŠ è½½åˆ°å…¶ä»–ç¨‹åºä¸­ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æ–‡ä»¶åå°†ä¸æºæ–‡ä»¶çš„åŒ…åç›¸åŒï¼Œåªæ˜¯æ‰©å±•åä¸º <code>.so</code>ï¼Œä¾‹å¦‚ <code>wc.so</code>ã€‚å½“ç„¶ï¼Œåœ¨ windows ä¸‹æ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œå³ä½¿åŒæ­¥äº†åŒç«¯ä»£ç ï¼Œå¦‚æœåœ¨ win ä¸‹ç”Ÿæˆå°†ç”¨ <code>.dll</code> è¡¨ç¤ºåŠ¨æ€é“¾æ¥åº“ã€‚</p>
<p>æ–‡ä»¶ <code>wc.go</code> ä»¥åŠ <code>mrapps</code> ç›®å½•ä¸‹çš„å…¶å®ƒå‡ ä¸ªæ–‡ä»¶ï¼Œéƒ½å®šä¹‰äº†åä¸º <code>map, reduce</code> çš„å‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åœ¨ <code>mrsequential.go</code> ä¸­åŠ è½½å¹¶è°ƒç”¨ã€‚ç»™ <code>mrsequential</code> ç»‘å®šä¸åŒçš„ <code>*.so</code> æ–‡ä»¶ï¼Œä¹Ÿå°±ä¼šåŠ è½½ä¸åŒçš„ <code>map, reduce</code> å‡½æ•°ã€‚å¦‚æ­¤å®ç°æŸç§ç¨‹åº¦ä¸Šçš„<strong>åŠ¨æ€ç»‘å®šã€‚</strong></p>
<h4 id="å¯èƒ½ä¼šæŠ¥é”™"><a href="#å¯èƒ½ä¼šæŠ¥é”™" class="headerlink" title="å¯èƒ½ä¼šæŠ¥é”™"></a>å¯èƒ½ä¼šæŠ¥é”™</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># runtime/cgo</span></span><br><span class="line">cgo: C compiler <span class="string">"gcc"</span> not found: <span class="built_in">exec</span>: <span class="string">"gcc"</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span></span><br></pre></td></tr></tbody></table></figure>
<p>It seems like the error message youâ€™re encountering is related to the absence of the C compiler â€œgccâ€ in your systemâ€™s PATH variable.</p>
<p>To resolve this issue, you will need to ensure that the GNU Compiler Collection (GCC) is installed on your system and that its location is included in the PATH environment variable.</p>
<p>Here are the general steps to address this issue:</p>
<ol>
<li><strong>Install GCC:</strong><br>If you donâ€™t have GCC installed, you can typically install it using your systemâ€™s package manager. For example, on a Debian-based system, you can use:</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update  </span><br><span class="line">sudo apt-get install build-essential</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li><strong>Add GCC to PATH:</strong><br>Once installed, you should ensure that the directory containing the GCC executable is included in your PATH environment variable. This can typically be achieved by adding a line to your shell configuration file (e.g., <strong>`**</strong>.bashrc<strong>**`</strong>, <strong>`**</strong>.zshrc<strong>**`</strong>, etc.):</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/path/to/gcc/directory</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li><strong>Verify Installation:</strong><br>After making these changes, open a new terminal or run <strong>source</strong>on the configuration file to apply the changes. You can then verify that GCC is accessible by running <strong>gcc â€”version</strong>.</li>
</ol>
<h4 id="é…ç½®ä¼˜åŒ–"><a href="#é…ç½®ä¼˜åŒ–" class="headerlink" title="é…ç½®ä¼˜åŒ–"></a>é…ç½®ä¼˜åŒ–</h4><ul>
<li>åŸå§‹å‘½ä»¤</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/6.5840</span><br><span class="line">$ <span class="built_in">cd</span> src/main</span><br><span class="line">$ go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">$ <span class="built_in">rm</span> mr-out*</span><br><span class="line">$ go run mrsequential.go wc.so pg*.txt</span><br><span class="line">$ more mr-out-0</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>.vscode/launch.json</code></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œçš„â€argsâ€è²Œä¼¼ä¸æ”¯æŒé€šé…ç¬¦ <code>*</code>ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æŠŠæ‰€æœ‰æ–‡ä»¶å…¨éƒ¨åŠ è¿›å»ï¼Œ<u>æˆ–è®¸å¯èƒ½æœ‰å…¶ä»–åŠæ³•ã€‚</u></p>
</blockquote>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">,</span> <span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    _<span class="comment">// Use IntelliSense to learn about possible attributes._</span></span><br><span class="line">    _<span class="comment">// Hover to view descriptions of existing attributes._</span></span><br><span class="line">    _<span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387_</span></span><br><span class="line">    <span class="attr">"version"</span><span class="punctuation">:</span> <span class="string">"0.2.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"configurations"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrcoordinator.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrcoordinator.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"cwd"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrworker.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrworker.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"cwd"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"preLaunchTask"</span><span class="punctuation">:</span> <span class="string">"build wc &amp;&amp; temp dir"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Run mrsequential.go with wc.so"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"request"</span><span class="punctuation">:</span> <span class="string">"launch"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"mode"</span><span class="punctuation">:</span> <span class="string">"auto"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"program"</span><span class="punctuation">:</span> <span class="string">"${workspaceFolder}/src/main/mrsequential.go"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"env"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"wc.so"</span><span class="punctuation">,</span> <span class="string">"pg-being_ernest.txt"</span><span class="punctuation">,</span> <span class="string">"pg-dorian_gray.txt"</span><span class="punctuation">,</span> <span class="string">"pg-frankenstein.txt"</span><span class="punctuation">,</span> <span class="string">"pg-grimm.txt"</span><span class="punctuation">,</span> <span class="string">"pg-huckleberry_finn.txt"</span><span class="punctuation">,</span> <span class="string">"pg-metamorphosis.txt"</span><span class="punctuation">,</span> <span class="string">"pg-sherlock_holmes.txt"</span><span class="punctuation">,</span> <span class="string">"pg-tom_sawyer.txt"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"preLaunchTask"</span><span class="punctuation">:</span> <span class="string">"build wc"</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>.vscode/tasks.json</code></li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"version"</span><span class="punctuation">:</span> <span class="string">"2.0.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"tasks"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build wc"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"shell"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bash"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"${workspaceFolder}/src/main/build-wc.sh"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"problemMatcher"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"group"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"kind"</span><span class="punctuation">:</span> <span class="string">"build"</span><span class="punctuation">,</span>  </span><br><span class="line">              <span class="attr">"isDefault"</span><span class="punctuation">:</span> <span class="keyword">true</span>  </span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">"presentation"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"reveal"</span><span class="punctuation">:</span> <span class="string">"silent"</span>  </span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build temp dir"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"shell"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bash"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"${workspaceFolder}/src/main/build-temp-dir.sh"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"problemMatcher"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"group"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"kind"</span><span class="punctuation">:</span> <span class="string">"build"</span><span class="punctuation">,</span>  </span><br><span class="line">              <span class="attr">"isDefault"</span><span class="punctuation">:</span> <span class="keyword">true</span>  </span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">"presentation"</span><span class="punctuation">:</span> <span class="punctuation">{</span>  </span><br><span class="line">              <span class="attr">"reveal"</span><span class="punctuation">:</span> <span class="string">"silent"</span>  </span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"label"</span><span class="punctuation">:</span> <span class="string">"build wc &amp;&amp; temp dir"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"dependsOn"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"build wc"</span><span class="punctuation">,</span> <span class="string">"build temp dir"</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>6.8540/src/main/build-wc.sh</code></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šå¦‚æœå‡ºç° <code>cannot load plugin wc.so</code>ï¼Œéœ€è¦åŠ ä¸Š <code>-gcflags="all=-N -l"</code>ï¼Œä»¥ç¦ç”¨ä¼˜åŒ–å’Œå†…è”ï¼Œä½†è¿™ä¸ä¸€å®šæ˜¯å¿…è¦çš„ï¼Œå¦‚æœç›´æ¥åœ¨ Terminal è¿›è¡ŒåŠ¨æ€åº“çš„ç”Ÿæˆï¼Œåˆ™ä¸éœ€è¦ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Building wc plugin..."</span></span><br><span class="line"><span class="built_in">cd</span> src/main</span><br><span class="line">go build -buildmode=plugin -gcflags=<span class="string">"all=-N -l"</span> ../mrapps/wc.go</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"wc plugin built"</span></span><br><span class="line"><span class="built_in">rm</span> -f mr-*</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deleted old mr-* files"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Our-tasks"><a href="#Our-tasks" class="headerlink" title="Our tasks"></a>Our tasks</h2><blockquote>
<p>Your job is to implement a distributed MapReduce, consisting of two programs, the coordinator and the worker. There will be just one coordinator process, and one or more worker processes executing in parallel. In a real system the workers would run on a bunch of different machines, but for this lab youâ€™ll run them all on a single machine. The workers will talk to the coordinator via RPC. Each worker process will, in a loop, ask the coordinator for a task, read the taskâ€™s input from one or more files, execute the task, write the taskâ€™s output to one or more files, and again ask the coordinator for a new task. The coordinator should notice if a worker hasnâ€™t completed its task in a reasonable amount of time (for this lab, use ten seconds), and give the same task to a different worker.</p>
</blockquote>
<ul>
<li>ä¸»ä½“ï¼šå®Œæˆä¸€ä¸ªåˆ†å¸ƒå¼çš„ MapReduceï¼Œç”±ä¸€ä¸ª coordinator è¿›ç¨‹ï¼ˆåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç”¨ master ç§°å‘¼ï¼‰å’Œå¤šä¸ªå¹¶è¡Œçš„ worker è¿›ç¨‹ç»„æˆã€‚ç°å®ä¸­çœŸå®çš„åˆ†å¸ƒå¼ç³»ç»Ÿé€šå¸¸è¿è¡Œåœ¨ä¸€å †ä¸åŒçš„è®¾å¤‡ä¸Šï¼Œä½†åœ¨è¿™é‡Œåªç”¨ä¸€å°è®¡ç®—æœºï¼Œworker é€šè¿‡ RPC å’Œ coordinator é€šä¿¡ã€‚æ¯ä¸€ä¸ª worker è¿›ç¨‹å°†å¾ªç¯åœ°å‘ coordinator è¯·æ±‚ taskï¼Œä» task çš„è¾“å…¥ä¸­è¯»å–ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œç¨‹åºç„¶å¾ˆå°†ç»“æœè¾“å‡ºåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œç„¶åå†æ¬¡è¯·æ±‚æ–°çš„ taskã€‚å¦‚æœä¸€ä¸ª worker é•¿æ—¶é—´æ²¡æœ‰å®Œæˆ taskï¼ˆè¿™é‡Œè®¾ç½®ä¸º 10sï¼‰ï¼Œcoordinator å°†é€šçŸ¥å¦ä¸€ä¸ª worker æ¥æ‰§è¡Œè¿™ä¸ª taskã€‚</li>
<li>æ³¨æ„ï¼š<code>main/mrcoordinator.go</code> å’Œ <code>main/mrworker.go</code> æ˜¯ test çš„å…¥å£ï¼Œä¸è¦æ±‚æ”¹ã€‚éœ€è¦å®Œæˆçš„åœ¨ <code>mr/coordinator.go</code>ã€<code>mr/worker.go</code> å’Œ <code>mr/rpc.go</code>ã€‚</li>
<li><p>å¤§è‡´çš„æµ‹è¯•æ­¥éª¤ï¼š</p>
<ul>
<li><p>æ„å»ºä¸­é—´ä»¶ç”¨äº word-countï¼Œè¿™é‡Œå’Œä¸Šé¢ç±»ä¼¼ï¼Œåç»­å¯ä»¥é™„å¸¦åœ¨å¯åŠ¨ mrworker çš„ä»»åŠ¡ä¸­ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -buildmode=plugin ../mrapps/wc.go</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>å¯åŠ¨mrcoordinatorï¼Œè¾“å…¥æ˜¯æ‰€æœ‰txtæ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ä»£è¡¨ä¸€ä¸ªsplitï¼ŒåŒæ ·çš„è¿™é‡Œä¹Ÿè¦æ³¨æ„é€šé…ç¬¦ã€‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> mr-out*</span><br><span class="line">go run mrcoordinator.go pg-*.txt</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>å¯åŠ¨å¤šä¸ªmrworker</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run mrworker.go wc.so</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>æŒ‰é¡ºåºæ’åºåçš„è¯é¢‘ç»Ÿè®¡åº”å½“å’Œåºåˆ—åŒ–å•æœºçš„ç»“æœä¿æŒä¸€è‡´ï¼Œç”¨main/test-mr.shè¿›è¡Œæµ‹è¯•ï¼Œå°†æµ‹è¯•è¾“å‡ºæ˜¯å¦ä¿æŒæ­£ç¡®ï¼Œæ˜¯å¦å…·æœ‰ä¿®å¤å´©æºƒworkerçš„èƒ½åŠ›</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> mr-out-* | <span class="built_in">sort</span> | more</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç»“æœå°†ç”Ÿæˆå¤šä¸ªmr-out-Xæ–‡ä»¶</p>
</li>
<li>å¯èƒ½ä¼šå‡ºç°RPCçš„æŠ¥é”™rpc.Register: method â€œDoneâ€ has 1 input parameters; needs exactly threeï¼ŒDone()æ²¡æœ‰é€šè¿‡RPCï¼Œå…ˆå¿½ç•¥</li>
</ul>
</li>
</ul>
<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><ul>
<li>map é˜¶æ®µåº”å½“å°†ä¸­é—´æ€çš„ keys åˆ’åˆ†åˆ° <code>nReduce</code> ä¸ªæ¡¶è¿›è¡Œ reduce ä»»åŠ¡ï¼Œè¿™ä¸ªæ•°é‡å°±æ˜¯ reduce ä»»åŠ¡çš„æ•°é‡ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä» <code>main/mrcoordinator.go</code> ä¼ å…¥åˆ° <code>mr/coordinator.go</code> çš„ <code>MakeCoordinator()</code> å‡½æ•°çš„ã€‚ä¸ºäº†å‡å°‘ä»»åŠ¡çš„æ¶ˆè€—ï¼Œæ¯ä¸€ä¸ª mapper åº”å½“åˆ›å»º <code>nReduce</code> ä¸ªä¸­é—´æ–‡ä»¶ã€‚</li>
<li>worker åº”å½“å°†ç¬¬ X ä¸ª reduce ä»»åŠ¡çš„è¾“å‡ºæ”¾åˆ° <code>mr-out-X</code>ã€‚</li>
<li><code>mr-out-X</code> çš„è¾“å‡ºæ ¼å¼ï¼Œæ¯ä¸€è¡ŒåŒ…æ‹¬ä¸€ä¸ª Reduce å‡½æ•°çš„è¾“å‡ºï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼è¡¨ç¤ºï¼Œç”¨ <code>"%v %v"</code> è¿›è¡Œæ ¼å¼åŒ–ï¼Œå‚ç…§ <code>main/mrsequential.go</code>ã€‚æ ¼å¼é”™è¯¯å¯èƒ½å¯¼è‡´æµ‹è¯•ä¸é€šè¿‡ã€‚</li>
<li>worker åº”å½“å°† Map çš„è¾“å‡ºæ–‡ä»¶æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œä»¥ä¾¿å®ƒä½œä¸º Reduce ä»»åŠ¡çš„è¾“å…¥ã€‚</li>
<li>å½“ MapReduce ä»»åŠ¡å®Œå…¨ç»“æŸæ—¶ï¼Œ<code>mr/coordinator.go</code> çš„ <code>Done()</code> æ–¹æ³•åº”å½“è¿”å› <code>true</code>ï¼Œæ­¤æ—¶ <code>main/mrcoordinator.go</code> å°†é€€å‡ºã€‚</li>
<li>worker ä¹Ÿåº”å½“é€€å‡ºã€‚ä¸€ä¸ªç®€å•çš„å®ç°æ–¹æ³•å¯ä»¥æ˜¯ä½¿ç”¨ <code>call()</code> çš„è¿”å›å€¼ï¼Œå¦‚æœ worker è”ç³»ä¸ä¸Š coordinatorï¼Œåˆ™è¯´æ˜ä»»åŠ¡å·²ç»å®Œæˆï¼Œcoordinator å·²ç»é€€å‡ºï¼Œæ­¤æ—¶ worker ä¹Ÿå¯ä»¥é€€å‡ºã€‚</li>
</ul>
<h3 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h3><ul>
<li>ç›¸å…³ Golang çš„çŸ¥è¯† <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/guidance.html">https://pdos.csail.mit.edu/6.824/labs/guidance.html</a></li>
<li>ä¸€ä¸ªå…¥æ‰‹çš„æ–¹æ³•å°±æ˜¯ï¼Œè®¾è®¡ <code>mr/worker.go</code> çš„ <code>Worker()</code> å‡½æ•°ï¼Œé€šè¿‡ RPC å‘ coordinator è¯·æ±‚ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åè®¾è®¡ coordinator çš„å“åº”ï¼ˆå°šæœªè¿›è¡Œ map ä»»åŠ¡çš„æ–‡ä»¶åï¼‰ï¼Œå†è®¾è®¡ worker å¦‚ä½•è¯»å–è¿™äº›æ–‡ä»¶ï¼Œè°ƒç”¨ Map å‡½æ•°ï¼ˆç±»ä¼¼äº <code>mrsequential.go</code>ï¼‰ã€‚</li>
<li>Map å’Œ Reduce å‡½æ•°æ˜¯é€šè¿‡ go çš„ plugin è¿›è¡ŒåŠ¨æ€åŠ è½½çš„ï¼Œåç¼€æ˜¯ <code>.so</code> çš„æ–‡ä»¶ã€‚</li>
<li>å¦‚æœä¿®æ”¹äº† <code>mr/</code> ç›®å½•ä¸‹çš„ä»»ä½•ä¸œè¥¿ï¼Œæœ€å¥½éƒ½é‡æ–°åŠ è½½ä¸€ä¸‹ pluginï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„æ”¾åˆ° tasks é‡Œé¢ä½œä¸ºå¯åŠ¨å‰çš„ä»»åŠ¡ã€‚</li>
<li>å½“å‰çš„ lab æ˜¯åŸºäºä¸€å°æœºå™¨è¿›è¡Œæ–‡ä»¶æ“ä½œçš„ï¼Œå¦‚æœæ˜¯å¤šå°æœºå™¨åˆ™éœ€è¦å…¨å±€çš„æ–‡ä»¶ç³»ç»Ÿä¾‹å¦‚ GFSï¼Œåœ¨æ­¤å¹¶æœªè€ƒè™‘ã€‚</li>
<li>ä¸­é—´æ–‡ä»¶çš„å‘½åï¼Œå¯ä»¥æ˜¯ <code>mr-X-Y</code>ï¼Œå…¶ä¸­ X æ˜¯ Map ä»»åŠ¡çš„ç¼–å·ï¼ŒY æ˜¯ reduce ä»»åŠ¡çš„ç¼–å·ã€‚</li>
<li><p>map ä»»åŠ¡å­˜å‚¨çš„ä¸­é—´æ€é”®å€¼å¯¹æ ¼å¼åº”å½“å¯ä»¥ç›´æ¥è¢« reduce ä»»åŠ¡è¯»å–ï¼Œä¸€ä¸ªå¯è¡Œçš„åŠæ³•æ˜¯ä½¿ç”¨ go çš„ <code>encoding/json</code> åŒ…ï¼š</p>
  <figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// write</span></span><br><span class="line">enc := json.NewEncoder(file)</span><br><span class="line"><span class="keyword">for</span> _, kv := ... {</span><br><span class="line">err := enc.Encode(&amp;kv)</span><br><span class="line"></span><br><span class="line"><span class="comment">// read</span></span><br><span class="line">dec := json.NewDecoder(file)</span><br><span class="line"><span class="keyword">for</span> {</span><br><span class="line">    <span class="keyword">var</span> kv KeyValue</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    }</span><br><span class="line">    kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>mapéƒ¨åˆ†å¯ä»¥ç”¨<code>worker.go</code>é‡Œçš„<code>ihash(key)</code>å‡½æ•°é€šè¿‡ç»™å®šçš„keyæ¥é€‰æ‹©reduceä»»åŠ¡ã€‚</p>
</li>
<li><p>å¯ä»¥å‚è€ƒéƒ¨åˆ†<code>mrsequential.go</code>ä¸­çš„ä»£ç ï¼Œæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p>
</li>
<li><p>coordinatoræ˜¯ä¸€ä¸ªRPCæœåŠ¡ï¼Œå¯èƒ½ä¼šæœ‰å¹¶å‘çš„é—®é¢˜ï¼Œåº”å½“ç»™ä¸€äº›æ•°æ®åŠ é”ã€‚</p>
</li>
<li><p>ä½¿ç”¨<code>go run-race</code>æ¥å¼•å…¥goçš„ç«æ€æ£€æµ‹å™¨ï¼Œ<code>test-mr.sh</code>å¼€å¤´æœ‰ä¸€æ®µå¦‚ä½•ä½¿ç”¨çš„è¯´æ˜ï¼Œæµ‹è¯•ä¸ä¼šä½¿ç”¨ç«æ€æ£€æµ‹å™¨ã€‚ä¸è¿‡ï¼Œå¦‚æœä»£ç å­˜åœ¨ç«æ€ï¼Œæµ‹è¯•æ—¶ä¼šå¤±è´¥ã€‚</p>
</li>
<li><p>workersæœ‰æ—¶å€™éœ€è¦ç­‰å¾…ï¼Œä¾‹å¦‚reduceséœ€è¦å†æœ€åä¸€ä¸ªmapå®Œæˆå†å·¥ä½œã€‚ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯workerså‘¨æœŸæ€§åœ°å‘coordinatorè¯·æ±‚workï¼Œä½¿ç”¨<code>time.Sleep()</code>ï¼›å¦ä¸€ä¸ªæ–¹æ³•æ˜¯å†relevant RPC handlerä¸­ä½¿ç”¨<code>time.Sleep()</code>æˆ–è€…<code>sync.Cond</code>è¿›è¡Œç­‰å¾…ã€‚æ¯ä¸ªRPCéƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹ï¼Œä¸ä¼šå½±å“å…¶ä»–RPCã€‚</p>
</li>
<li><p>coordinatoræ— æ³•åŒºåˆ†å®•æœºã€å¡ä½ä»¥åŠè¿è¡Œéå¸¸ç¼“æ…¢çš„workersã€‚æœ€å¥½æ˜¯è®©coordinatorç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼ˆåœ¨è¿™é‡Œæ˜¯10sï¼‰ï¼Œè¶…æ—¶åˆ™åˆ¤å®šä¸ºæ­»äº¡ï¼ˆå½“ç„¶æœ‰å¯èƒ½æ²¡æœ‰ï¼‰ï¼Œç„¶åæŠŠè¿™ä¸ªä»»åŠ¡åˆ†å‘ç»™å…¶ä»–workerã€‚</p>
</li>
<li><p>å¦‚æœè¦å®ŒæˆSection3.6ä¸­çš„Backupä»»åŠ¡ï¼Œå°†æµ‹è¯•ä»£ç å®Œæˆï¼šworkeræ²¡æœ‰å´©æºƒçš„æ—¶å€™ä¸ä¼šå»å®Œæˆå…¶ä»–ä»»åŠ¡ï¼Œå¤‡ä»½ä»»åŠ¡ä»…åœ¨10såæ‰è¿›è¡Œã€‚</p>
</li>
<li><p>å¯ä»¥ä½¿ç”¨<code>mrapps/crash.go</code>ä½œä¸ºpluginè¿›è¡Œå´©æºƒæ¢å¤ã€‚</p>
</li>
<li><p>MapReduceè®ºæ–‡ä¸­æåˆ°ï¼Œä¸ºäº†ç¡®ä¿å‘ç”Ÿå´©æºƒçš„æ—¶å€™æ²¡æœ‰äººæ³¨æ„åˆ°è¿™éƒ¨åˆ†æ–‡ä»¶ï¼Œå¯ä»¥é‡‡ç”¨ä¸´æ—¶æ–‡ä»¶ä»¥åŠå®Œå…¨å†™å…¥åå†è¿›è¡Œé‡å‘½åçš„æ–¹æ³•ã€‚å¯ä»¥ç”¨<code>ioutil.TempFile</code>æˆ–è€…<code>os.CreateTemp</code>è¿›è¡Œä¸´æ—¶æ–‡ä»¶çš„åˆ›å»ºï¼Œç”¨<code>os.Rename</code>è¿›è¡Œé‡å‘½å</p>
</li>
<li><p><code>test-mr.sh</code>åœ¨å­ç›®å½• <code>mr-tmp</code>ä¸­è¿è¡Œå…¶æ‰€æœ‰è¿›ç¨‹ï¼Œå› æ­¤å¦‚æœå‡ºç°é—®é¢˜å¯ä»¥çœ‹é‚£é‡Œã€‚ å¯ä»¥ä¸´æ—¶ä¿®æ”¹<code>test-mr.sh</code> ä»¥åœ¨æµ‹è¯•å¤±è´¥åé€€å‡ºï¼Œè¿™æ ·è„šæœ¬å°±ä¸ä¼šç»§ç»­æµ‹è¯•ï¼ˆå¹¶è¦†ç›–è¾“å‡ºæ–‡ä»¶ï¼‰ã€‚</p>
</li>
<li><p><code>test-mr-many.sh</code>æ˜¯è¿ç»­è¿è¡Œå¾ˆå¤šæ¬¡<code>test-mr.sh</code>ï¼Œä»¥ä¾¿æ‰¾åˆ°æ¦‚ç‡æ€§çš„é”™è¯¯ã€‚ä¸èƒ½å¹¶è¡Œå¤šä¸ª<code>test-mr.sh</code>å®ä¾‹ï¼Œå› ä¸ºcoordinatorç”¨äº†åŒä¸€ä¸ªsockerä¼šå¯¼è‡´å†²çªã€‚</p>
</li>
<li><p>GO RPCä»…å‘é€ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ç»“æ„ä½“å­—æ®µï¼Œå­ç»“æ„å¿…é¡»ç”±å¤§å†™çš„å­—æ®µåç§°ã€‚</p>
</li>
<li><p>è°ƒç”¨RPCçš„<code>call()</code>æ–¹æ³•æ—¶ï¼Œè¿”å›ç»“æ„åº”å½“åŒ…å«æ‰€æœ‰é»˜è®¤å€¼ã€‚RPC è°ƒç”¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼šåœ¨è°ƒç”¨ä¹‹å‰ä¸è®¾ç½®ä»»ä½•å›å¤å­—æ®µã€‚ å¦‚æœæ‚¨ä¼ é€’å…·æœ‰éé»˜è®¤å­—æ®µçš„å›å¤ç»“æ„ï¼ŒRPC ç³»ç»Ÿå¯èƒ½ä¼šé»˜é»˜åœ°è¿”å›ä¸æ­£ç¡®çš„å€¼ã€‚</p>
  <figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reply := SomeType{}</span><br><span class="line">call(..., &amp;reply)</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="Challenges"><a href="#Challenges" class="headerlink" title="Challenges"></a>Challenges</h3><ul>
<li>Implement your own MapReduce application (see examples in mrapps/*), e.g., Distributed Grep (Section 2.3 of the MapReduce paper).å®ç°è®ºæ–‡ä¸­ 2.3 èŠ‚çš„ MapReduce åº”ç”¨ã€‚</li>
<li>Get your MapReduce coordinator and workers to run on separate machines, as they would in practice. You will need to set up your RPCs to communicate over TCP/IP instead of Unix sockets (see the commented out line in Coordinator.server()), and read/write files using a shared file system. For example, you can ssh into multiple <a target="_blank" rel="noopener" href="http://kb.mit.edu/confluence/display/istcontrib/Getting+Started+with+Athena">Athena cluster</a> machines at MIT, which use <a target="_blank" rel="noopener" href="http://kb.mit.edu/confluence/display/istcontrib/AFS+at+MIT+-+An+Introduction">AFS</a> to share files; or you could rent a couple AWS instances and use <a target="_blank" rel="noopener" href="https://aws.amazon.com/s3/">S3</a> for storage.æŠŠ coordinator å’Œ workers éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œæ”¹ç”¨ TCP/IP å–ä»£ sockets é€šä¿¡ï¼Œå¹¶ä¸”ä½¿ç”¨ SFS å…±äº«æ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<h3 id="æ­£å¼å¼€å§‹-Coding"><a href="#æ­£å¼å¼€å§‹-Coding" class="headerlink" title="æ­£å¼å¼€å§‹ Coding"></a>æ­£å¼å¼€å§‹ Coding</h3><h4 id="worker-è¯·æ±‚ä»»åŠ¡ï¼Œcoordinator-åˆ†é…ä»»åŠ¡ï¼Œworker-æ”¶åˆ°åæ‰“å°"><a href="#worker-è¯·æ±‚ä»»åŠ¡ï¼Œcoordinator-åˆ†é…ä»»åŠ¡ï¼Œworker-æ”¶åˆ°åæ‰“å°" class="headerlink" title="worker è¯·æ±‚ä»»åŠ¡ï¼Œcoordinator åˆ†é…ä»»åŠ¡ï¼Œworker æ”¶åˆ°åæ‰“å°"></a>worker è¯·æ±‚ä»»åŠ¡ï¼Œcoordinator åˆ†é…ä»»åŠ¡ï¼Œworker æ”¶åˆ°åæ‰“å°</h4><blockquote>
<p>æš‚æ—¶åªå…³æ³¨ coordinator å’Œ worker çš„äº¤äº’é€»è¾‘</p>
</blockquote>
<ul>
<li><p><code>wc.go</code> çš„é€»è¾‘</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å…¥æ˜¯æ–‡ä»¶åå’Œå†…å®¹ï¼Œè¾“å‡ºæ˜¯ç»“æ„ä½“åˆ‡ç‰‡å­˜æ”¾kva</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(filename <span class="type">string</span>, contents <span class="type">string</span>)</span></span> []mr.KeyValue {</span><br><span class="line">    <span class="comment">// function to detect word separators.</span></span><br><span class="line">    <span class="comment">// åŒ¿åå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªruneï¼Œè¿”å›ä¸€ä¸ªboolï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯å­—æ¯ï¼Œä¸æ˜¯å­—æ¯åˆ™æ˜¯true</span></span><br><span class="line">    ff := <span class="function"><span class="keyword">func</span><span class="params">(r <span class="type">rune</span>)</span></span> <span class="type">bool</span> { <span class="keyword">return</span> !unicode.IsLetter(r) }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// split contents into an array of words.</span></span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸æ˜¯å­—æ¯çš„ç‚¹å¯¹contentsè¿›è¡Œæ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯ç©ºæ ¼å’Œå…¶ä»–ï¼Œå°†å¾—åˆ°å•è¯çš„slice</span></span><br><span class="line">    words := strings.FieldsFunc(contents, ff)</span><br><span class="line"></span><br><span class="line">    kva := []mr.KeyValue{}</span><br><span class="line">    <span class="comment">// éå†wordsåˆ‡ç‰‡ï¼Œå•è¯æ˜¯keyï¼Œvalueæ˜¯"1"ï¼›é‡å¤çš„keyåœ¨è¿™æ—¶ä¸ä¼šåˆå¹¶</span></span><br><span class="line">    <span class="keyword">for</span> _, w := <span class="keyword">range</span> words {</span><br><span class="line">        kv := mr.KeyValue{w, <span class="string">"1"</span>}</span><br><span class="line">        kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> kva</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reduce</span><span class="params">(key <span class="type">string</span>, values []<span class="type">string</span>)</span></span> <span class="type">string</span> {</span><br><span class="line">    <span class="comment">// return the number of occurrences of this word.</span></span><br><span class="line">    <span class="comment">// valuesåˆ‡ç‰‡çš„é•¿åº¦å°±æ˜¯ä¸ªæ•°ç›¸åŠ ï¼Œå®ç°äº†mapä¸­åŒkeyç›¸åŠ çš„æ•ˆæœ</span></span><br><span class="line">    <span class="keyword">return</span> strconv.Itoa(<span class="built_in">len</span>(values))</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>mrsequential.go</code>çš„é€»è¾‘</p>
<ul>
<li>åˆ¤å®šè¾“å…¥çš„å‚æ•°<code>os.Args</code></li>
<li>ç”¨<code>loadPlugin(os.Args[1])</code>è¯»å–<code>mapf</code>å’Œ<code>reducef</code>ä¸¤ä¸ªä»¥åŠ¨æ€é“¾æ¥åŠ è½½çš„å‡½æ•°ï¼ˆç”¨1æ˜¯å› ä¸º0æ˜¯æ–‡ä»¶è·¯å¾„ <strong>/home/boom/go/src/6.5840/src/main/__debug_bin710355273</strong> <code>wc.so pg-being_ernest.txt pg-dorian_gray.txt pg-frankenstein.txt pg-grimm.txt pg-huckleberry_finn.txt pg-metamorphosis.txt pg-sherlock_holmes.txt pg-tom_sawyer.txt</code>ï¼Œ1æ‰æ˜¯<code>wc.so</code>ï¼‰<ul>
<li><code>p, err := plugin.Open(filename)</code>åŠ è½½æ’ä»¶</li>
<li><code>xf, err := p.Lookup("Map")å’Œp.Lookup("Reduce")</code>æ£€ç´¢ç¬¦å·ï¼ˆè¿™é‡Œçš„ç¬¦å·æ˜¯å‡½æ•°ï¼‰</li>
<li><code>f :=  xf.(func())</code>è°ƒç”¨å‡½æ•°</li>
</ul>
</li>
<li><p>åœ¨workerä¸­KeyValueçš„ç»“æ„ä½“ï¼Œç”¨è¿™ä¸ªç»“æ„ä½“å®šä¹‰æœªåˆå§‹åŒ–çš„åˆ‡ç‰‡<code>type ByKey []mr.KeyValue</code>ç”¨äº<code>intermediate := []mr.KeyValue{}</code>çš„æ’åº</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// struct is in 6.5840/mr</span></span><br><span class="line"><span class="keyword">type</span> KeyValue <span class="keyword">struct</span> {</span><br><span class="line">    Key   <span class="type">string</span></span><br><span class="line">    Value <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="keyword">type</span> ByKey []mr.KeyValue</span><br><span class="line"></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Len() <span class="type">int</span>           { <span class="keyword">return</span> <span class="built_in">len</span>(a) }</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Swap(i, j <span class="type">int</span>)      { a[i], a[j] = a[j], a[i] }</span><br><span class="line"><span class="comment">// å®ç°äº†sortæ¥å£çš„ä¸‰ä¸ªæ–¹æ³•ä»¥å®Œæˆæ’åºï¼ŒæŒ‰ç…§é”®çš„å­—æ¯é¡ºåºæ’åºa-z</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> { <span class="keyword">return</span> a[i].Key &lt; a[j].Key }</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è¯»å–åç»­å„ä¸ªå‚æ•°ï¼Œopenã€readã€closeå„ä¸ªfileï¼Œä¾æ¬¡æŠŠfilenameå’Œcontentè¿›è¡Œmapï¼Œå†å­˜å…¥åˆ‡ç‰‡</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, filename := <span class="keyword">range</span> os.Args[<span class="number">2</span>:] {</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    file, err := os.Open(filename)</span><br><span class="line">    content, err := ioutil.ReadAll(file) <span class="comment">// åœ¨go1.16ä¹‹åç”¨io.ReadAll()</span></span><br><span class="line">    file.Close()</span><br><span class="line">    kva := mapf(filename, <span class="type">string</span>(content)) <span class="comment">// è°ƒç”¨mapfè·å–å½“å‰æ–‡æ¡£çš„æ‰€æœ‰åˆ†è¯kvçš„åˆ‡ç‰‡</span></span><br><span class="line">    intermediate = <span class="built_in">append</span>(intermediate, kva...) <span class="comment">// è¿½åŠ åˆ°ä¸­é—´æ€çš„åˆ‡ç‰‡ä¸­æš‚å­˜</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>æ’åºåˆ‡ç‰‡ï¼Œåˆ›å»ºæ–‡ä»¶</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sort.Sort(ByKey(intermediate))</span><br><span class="line"></span><br><span class="line">oname := <span class="string">"mr-out-0"</span></span><br><span class="line">ofile, _ := os.Create(oname)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>reduceï¼Œç„¶åå…³é—­æ–‡ä»¶</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) {</span><br><span class="line">        j := i + <span class="number">1</span></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°æ‰€æœ‰ç›¸åŒkeyçš„ä¸‹æ ‡èŒƒå›´[i,j)</span></span><br><span class="line">        <span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key {</span><br><span class="line">            j++</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// æš‚å­˜è¿™äº›åŒkeyçš„æ‰€æœ‰value</span></span><br><span class="line">        values := []<span class="type">string</span>{}</span><br><span class="line">        <span class="keyword">for</span> k := i; k &lt; j; k++ {</span><br><span class="line">            values = <span class="built_in">append</span>(values, intermediate[k].Value)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è¿›è¡Œreduce</span></span><br><span class="line">        output := reducef(intermediate[i].Key, values)</span><br><span class="line">        <span class="comment">// å†™å…¥ä¸Šé¢åˆ›å»ºçš„ofileæ–‡ä»¶ï¼Œæ³¨æ„è¦æŒ‰ç…§è¿™ä¸ªæ ¼å¼</span></span><br><span class="line">        <span class="comment">// this is the correct format for each line of Reduce output.</span></span><br><span class="line">        fmt.Fprintf(ofile, <span class="string">"%v %v\n"</span>, intermediate[i].Key, output)</span><br><span class="line">        <span class="comment">// æ›´æ–°iï¼Œæ‰¾ä¸‹ä¸€ç»„key</span></span><br><span class="line">        i = j</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ofile.Close()</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h4><ul>
<li><p>å•ä¸ªç»ˆç«¯å¯åŠ¨<code>main/mrcoordinator.go</code></p>
<ul>
<li><code>m := mr.MakeCoordinator(os.Args[1:], 10)</code>å¸¦Argsè¯»å…¥ï¼Œè¿™é‡Œçš„Argsæ˜¯æ‰€æœ‰çš„txtæ–‡æ¡£ï¼›å’Œ<code>nReduce=10</code>ï¼ˆå¯¹äº<code>map</code>ä»»åŠ¡çš„æ•°é‡ï¼Œ<strong>æ–‡ä»¶ä¸ªæ•°</strong>å°±æ˜¯<code>map</code>ä¸ªæ•°ï¼Œ<strong>æ–‡ä»¶åºå·</strong>å°±æ˜¯<code>map</code>åºå·ï¼‰<ul>
<li>ç”±<code>mr.MakeCoordinatorï¼ˆï¼‰</code>åˆå§‹åŒ–<code>Coordinator</code></li>
<li><code>c.server()</code>å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ç›‘å¬æ¥è‡ª<code>mr/worker.go</code>çš„RPCè¯·æ±‚</li>
<li><code>go c.loopRemoveTimeoutTasks()</code>å¯åŠ¨å¦ä¸€ä¸ªçº¿ç¨‹å¾ªç¯ç§»é™¤è¿‡æœŸçš„ä»»åŠ¡</li>
</ul>
</li>
<li>å‘¨æœŸæ€§è°ƒç”¨<code>Done()</code>è¯¢é—®æ˜¯å¦ç»“æŸï¼Œå¦‚æœè¿”å›<code>false</code>åˆ™åœ¨å»¶è¿Ÿ1såç»“æŸè¿›ç¨‹</li>
<li>æŠŠæ‰€æœ‰<code>files</code>æ”¾å…¥<code>c.unIssueMapTasks</code>é˜Ÿåˆ—</li>
</ul>
</li>
<li><p>å¤šä¸ªç»ˆç«¯å¯åŠ¨<code>main/mrworker.go</code></p>
<ul>
<li>åŠ è½½ä¸€ä¸ªå¯åŠ¨å‚æ•°<code>wc.so</code>åŠ¨æ€æ’ä»¶ï¼Œ<code>mapf, reducef := loadPlugin(os.Args[1])</code></li>
<li><code>mr.Worker(mapf, reducef)</code></li>
<li><p><code>Worker</code>ç»“æ„ï¼šä¸¤ä¸ªå‡½æ•°ï¼Œä»»åŠ¡å±æ€§ã€æ˜¯å¦å…¨éƒ¨ç»“æŸã€Id</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AWorker <span class="keyword">struct</span> {</span><br><span class="line">    mapf    <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue</span><br><span class="line">    reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// false for map, true for reduce</span></span><br><span class="line">    mapOrReduce <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// false for not done, true for done and must exit</span></span><br><span class="line">    allDone <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">    workerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>åˆ¤å®š<code>allDone</code>ï¼Œè¿›è¡Œ<code>worker.process()</code></p>
</li>
<li>åˆ¤å®š<code>mapOrReduce</code>ï¼Œé€‰æ‹©<code>map</code>ä»»åŠ¡æˆ–è€…<code>reduce</code>ä»»åŠ¡<ul>
<li>å¦‚æœæ˜¯<code>map</code>ä»»åŠ¡<ul>
<li>è¯·æ±‚ä»»åŠ¡<code>reply := worker.askMapTask()</code></li>
<li>å¤„ç†<code>reply</code>ï¼Œå¦‚æœä¸º<code>nil</code>è¡¨ç¤º<code>map</code>ä»»åŠ¡å·²ç»å¤„ç†å®Œæˆï¼Œåˆ‡æ¢åˆ°<code>reduce</code>ä»»åŠ¡<code>worker.mapOrReduce = true</code>ï¼›å¦‚æœä¸ä¸º<code>nil</code>ï¼Œè‹¥<code>reply.FileId==-1</code>è¯´æ˜ä»»åŠ¡åˆ†é…å®Œäº†ä½†æ˜¯è¿˜æ²¡å¤„ç†å®Œï¼Œæ²¡æœ‰<code>map</code>ä»»åŠ¡å¯ä»¥ç»™å½“å‰<code>worker</code>å¤„ç†ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œéšæœºç­‰å¾…ä¸€å°æ®µæ—¶é—´åå†è¿”å›ï¼Œé‡æ–°<code>process</code>è¯·æ±‚ï¼Œå¦åˆ™å°±æ­£å¸¸å¤„ç†<code>worker.executeMap(reply)</code></li>
</ul>
</li>
<li>å¦‚æœæ˜¯<code>reduce</code>ä»»åŠ¡<ul>
<li>è¯·æ±‚ä»»åŠ¡<code>reply := worker.askReduceTask()</code></li>
<li>å¤„ç†<code>reply</code>ï¼Œå¦‚æœä¸º<code>nil</code>åˆ™è¡¨ç¤ºå…¨éƒ¨ç»“æŸï¼Œ <code>worker.allDone = true</code>åè¿”å›ï¼Œworkerè¿›ç¨‹ä¼šé€€å‡ºï¼›å¦‚æœä¸ä¸º<code>nil</code>ï¼Œè‹¥<code>reply.RIndex==-1</code>è¯´æ˜reduceä»»åŠ¡å·²åˆ†é…å®Œä½†æ²¡å¤„ç†å®Œï¼Œå¦åˆ™å°±æ­£å¸¸å¤„ç†<code>worker.executeReduce(reply)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ä»»åŠ¡çš„è¯·æ±‚å’Œå¤„ç†æœºåˆ¶"><a href="#ä»»åŠ¡çš„è¯·æ±‚å’Œå¤„ç†æœºåˆ¶" class="headerlink" title="ä»»åŠ¡çš„è¯·æ±‚å’Œå¤„ç†æœºåˆ¶"></a>ä»»åŠ¡çš„è¯·æ±‚å’Œå¤„ç†æœºåˆ¶</h4><ul>
<li><code>reply := worker.askMapTask()</code></li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> askMapTask() *MapTaskReply {</span><br><span class="line">    <span class="comment">// declare an argument structure and reply structure.</span></span><br><span class="line">    args := MapTaskArgs{WorkerId: worker.workerId}</span><br><span class="line">    reply := MapTaskReply{}</span><br><span class="line"></span><br><span class="line">    worker.logPrintf(<span class="string">"Asking map task...\n"</span>)</span><br><span class="line">    ok := call(<span class="string">"Coordinator.GiveMapTask"</span>, &amp;args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok {</span><br><span class="line">        worker.logPrintf(<span class="string">"askMapTask failed\n"</span>)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    worker.workerId = reply.WorkerId</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> reply.FileId == <span class="number">-1</span> {</span><br><span class="line">        <span class="keyword">if</span> reply.AllDone {</span><br><span class="line">            worker.logPrintf(<span class="string">"All map tasks are done\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            worker.logPrintf(<span class="string">"No map task available\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> &amp;reply</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Got map task %v on file %v\n"</span>, reply.FileId, reply.FileName)</span><br><span class="line">    <span class="keyword">return</span> &amp;reply</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li>è¯·æ±‚ä¸»ä½“çš„ç»“æ„ï¼š<code>worker *AWorker</code></li>
<li><p>è¯·æ±‚å‚æ•°<code>args</code>ç»“æ„ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskArgs <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// give -1 if no task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿”å›å‚æ•°<code>reply</code>ç»“æ„ï¼š</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskReply <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// worker pass the file name to the os to read</span></span><br><span class="line">    FileName <span class="type">string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// marks a unique file id for map task, give -1 if no more file</span></span><br><span class="line">    FileId <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for reduce task</span></span><br><span class="line">    NReduce <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign the worker id to the task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign where this kind of tasks are all done</span></span><br><span class="line">    <span class="comment">// if not or FileId is -1, the worker should wait</span></span><br><span class="line">    AllDone <span class="type">bool</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ä»»åŠ¡åˆ†å‘ï¼š<code>func (c *Coordinator) GiveMapTask(args *MapTaskArgs, reply *MapTaskReply) error{}</code></p>
<ul>
<li>åˆ†å‘ä»»åŠ¡WorkerIdä¸ºå½“å‰Coordinatorçš„<code>c.curWorkerId</code>ï¼Œæ­¤å<code>curWorkerId++</code>ï¼Œå¦‚æœWorkerIdå­˜åœ¨åˆ™ä¸æ”¹å˜ã€‚</li>
<li>é€šè¿‡<code>c.issuedMapMutex.Lock()</code>è·å–Mapä»»åŠ¡çš„äº’æ–¥é”<code>issuedMapMutex  sync.Mutex</code></li>
<li>åˆ¤å®š<code>Coordinator</code>çš„<code>c.mapDone</code>å­—æ®µï¼Œmapä»»åŠ¡ç»“æŸåˆ™ç›´æ¥é‡Šæ”¾é”ã€<code>reply.FileId == -1</code>ï¼Œ<code>reply.AllDone</code>è®¾ä¸ºtrueï¼Œç„¶åè¿”å›nil</li>
<li>åˆ¤å®šæ²¡æœ‰åˆ†é…çš„mapä»»åŠ¡é˜Ÿåˆ—å’Œå¤„ç†ä¸­çš„mapä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦éƒ½ä¸ºç©ºï¼Œä¸ºç©ºåˆ™å’Œä¸Šä¸€æ¡ä¸€æ ·ï¼Œé™„åŠ è®¾ç½®<code>c.mapDone</code>ä¸º<code>true</code>ï¼Œä»¥åŠæŒ‰ç…§<code>c.nReduce</code>æ”¾å…¥reduceçš„æœªåˆ†é…é˜Ÿåˆ—</li>
<li>ä»æœªåˆ†é…mapä»»åŠ¡é˜Ÿåˆ—ä¸­<code>PopBack()</code>æ‹¿åˆ°fileIdï¼ˆæŒ‰ç…§æ–‡ä»¶æ•°é‡æ’åˆ—<code>0-len(files)-1</code>)ï¼Œä»¥æ­¤ä¹Ÿå¯ä»¥æ‹¿åˆ°æ–‡ä»¶åå¹¶å†™å…¥replyï¼Œå¹¶ä¸”ç»™<code>MapTaskState</code>è®¾ç½®å¼€å§‹æ—¶é—´ï¼Œä¸ºåç»­è¶…æ—¶åšå‡†å¤‡ã€‚</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskState <span class="keyword">struct</span> {</span><br><span class="line">    beginSecond <span class="type">int64</span></span><br><span class="line">    workerId    <span class="type">int</span></span><br><span class="line">    fileId      <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ‹¿å‡ºçš„fileIdæ”¾å…¥å·²åˆ†é…æ­£åœ¨å¤„ç†çš„mapä»»åŠ¡é˜Ÿåˆ—MapSetï¼ˆå®é™…ä¸Šæ˜¯ä½¿ç”¨mapç»“æ„ï¼Œå¹¶ä¸”ç»Ÿè®¡äº†countï¼‰</li>
<li>å¤„ç†ç›¸åº”çš„è¿”å›å€¼</li>
</ul>
</li>
</ul>
</li>
<li><p><code>worker.executeMap(reply)</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> executeMap(reply *MapTaskReply) {</span><br><span class="line">    <span class="comment">// execute map task</span></span><br><span class="line">    intermediate := makeIntermediateFromFile(reply.FileName, worker.mapf)</span><br><span class="line">    <span class="comment">// write intermediate to files</span></span><br><span class="line">    worker.writeToFiles(reply.FileId, reply.NReduce, intermediate)</span><br><span class="line">    worker.joinMapTask(reply.FileId)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li><code>intermediate := makeIntermediateFromFile(reply.FileName, worker.mapf)</code>ä¸»è¦ç”¨<code>mapf</code>æ‰“å¼€æ–‡ä»¶ç„¶åæ–‡æ¡£ï¼Œç”Ÿæˆé”®å€¼å¯¹ï¼Œè¿”å›ä¸€ä¸ªä¸­é—´æ€çš„<code>[]KeyValue</code>åˆ‡ç‰‡</li>
<li><code>worker.writeToFiles(reply.FileId, reply.NReduce, intermediate)</code>å†™å…¥åˆ°ä¸­é—´æ–‡ä»¶ï¼Œæ±‚hashåå–<code>mod nReduce</code>å¾—åˆ°åˆ†ç»™å“ªä¸€ä¸ªreduceä»»åŠ¡ï¼Œå› ä¸ºreduceä»»åŠ¡æ•°é‡æ˜¯çŸ¥é“çš„</li>
<li>ç”¨<code>encoding/json</code>åŒ…å­˜å‚¨ä¸­é—´æ€æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥è¢«reduceä»»åŠ¡è¯»å–</li>
<li>è¯·æ±‚<code>call("Coordinator.JoinMapTask", &amp;args, &amp;reply)</code><ul>
<li>æ‹¿åˆ°å·²åˆ†é…mapä»»åŠ¡é˜Ÿåˆ—çš„é”</li>
<li>æ£€æŸ¥æ˜¯å¦å› ä¸ºè¶…æ—¶è€Œå¯¼è‡´å½“å‰FileIdçš„ä»»åŠ¡å·²ç»ä»å·²åˆ†é…mapä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤<ul>
<li>å·²ç»è¢«ç§»é™¤ï¼Œè§£é”ã€æ‰“å°ä¿¡æ¯</li>
<li>æœªè¢«ç§»é™¤ï¼Œç§»é™¤ã€è§£é”ï¼Œæ‰“å°ä¿¡æ¯</li>
<li>æœªè¢«ç§»é™¤ä¸”è¶…æ—¶ï¼Œæ”¾å…¥æœªåˆ†é…é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>reply := worker.askReduceTask()</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> askReduceTask() *ReduceTaskReply {</span><br><span class="line">    <span class="comment">// declare an argument structure and reply structure.</span></span><br><span class="line">    args := ReduceTaskArgs{WorkerId: worker.workerId}</span><br><span class="line">    reply := ReduceTaskReply{}</span><br><span class="line"></span><br><span class="line">    ok := call(<span class="string">"Coordinator.GiveReduceTask"</span>, &amp;args, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> !ok {</span><br><span class="line">        worker.logPrintf(<span class="string">"askReduceTask failed\n"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    worker.workerId = reply.WorkerId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> reply.RIndex == <span class="number">-1</span> {</span><br><span class="line">        <span class="keyword">if</span> reply.AllDone {</span><br><span class="line">            worker.logPrintf(<span class="string">"All reduce tasks are done, need to terminate this worker\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            worker.logPrintf(<span class="string">"No reduce task available\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> &amp;reply</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Got reduce task %v\n"</span>, reply.RIndex)</span><br><span class="line">    <span class="keyword">return</span> &amp;reply</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li>è¯·æ±‚ä¸»ä½“çš„ç»“æ„ï¼š<code>worker *AWorker</code></li>
<li><p>è¯·æ±‚å‚æ•°<code>args</code>ç»“æ„ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReduceTaskArgs <span class="keyword">struct</span> {</span><br><span class="line">    <span class="comment">// give -1 if no task</span></span><br><span class="line">    WorkerId <span class="type">int</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è¿”å›å‚æ•°<code>reply</code>ç»“æ„ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReduceTaskReply <span class="keyword">struct</span> {</span><br><span class="line">    RIndex    <span class="type">int</span></span><br><span class="line">    NReduce   <span class="type">int</span></span><br><span class="line">    FileCount <span class="type">int</span></span><br><span class="line">    WorkerId  <span class="type">int</span></span><br><span class="line">    AllDone   <span class="type">bool</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>ä»»åŠ¡åˆ†å‘<code>func (c *Coordinator) GiveReduceTask(args *ReduceTaskArgs, reply *ReduceTaskReply) error {}</code></p>
<ul>
<li>åˆ†å‘ä»»åŠ¡WorkerIdä¸ºå½“å‰Coordinatorçš„<code>c.curWorkerId</code>ï¼Œæ­¤å<code>curWorkerId++</code>ï¼Œå¦‚æœWorkerIdå­˜åœ¨åˆ™ä¸æ”¹å˜ï¼Œè¿™é‡Œç”¨çš„æ˜¯Mapä»»åŠ¡çš„åŒä¸€å¥—ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå‡ºç°mapå’Œreduceçš„WorkerIdç›¸åŒã€‚</li>
<li>é€šè¿‡<code>c.issuedReduceMutex.Lock()</code>è·å–Reduceä»»åŠ¡çš„äº’æ–¥é”<code>issuedReducepMutex  sync.Mutex</code></li>
<li>åˆ¤å®š<code>Coordinator</code>çš„<code>c.allDone</code>å­—æ®µï¼ŒReduceä»»åŠ¡ç»“æŸåˆ™ç›´æ¥é‡Šæ”¾é”ã€<code>reply.AllDone</code>è®¾ä¸ºtrueï¼Œ<code>reply.RIndex</code>è®¾ä¸º-1ï¼Œç„¶åè¿”å›nil</li>
<li>åˆ¤å®šæ²¡æœ‰åˆ†é…çš„Reduceä»»åŠ¡é˜Ÿåˆ—å’Œå¤„ç†ä¸­çš„Reduceä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦éƒ½ä¸ºç©ºï¼Œä¸ºç©ºåˆ™å’Œä¸Šä¸€æ¡ä¸€æ ·ï¼Œé™„åŠ è®¾ç½®<code>c.AllDone</code>ä¸º<code>true</code>ï¼Œå…ˆæ¯”è¾ƒè¯·æ±‚Mapï¼Œè¿™é‡Œå¤šè®¾ç½®ä¸€ä¸ªå‚æ•°<code>c.AllDone</code></li>
<li>ä»æœªåˆ†é…Redduceä»»åŠ¡é˜Ÿåˆ—ä¸­<code>PopBack()</code>æ‹¿åˆ°rIndexï¼ˆæŒ‰ç…§NReduceæ•°é‡æ’åˆ—<code>0-NReduce-1</code>)å¹¶å†™å…¥replyï¼Œå¹¶ä¸”ç»™<code>ReduceTaskState</code>è®¾ç½®å¼€å§‹æ—¶é—´ï¼Œä¸ºåç»­è¶…æ—¶åšå‡†å¤‡ã€‚</li>
</ul>
</li>
<li><p><code>worker.executeReduce(reply)</code></p>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(worker *AWorker)</span></span> executeReduce(reply *ReduceTaskReply) {</span><br><span class="line">    outName := fmt.Sprintf(<span class="string">"mr-out-%v"</span>, reply.RIndex)</span><br><span class="line">    intermediate := <span class="built_in">make</span>([]KeyValue, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reply.FileCount; i++ {</span><br><span class="line">        intermediate = <span class="built_in">append</span>(intermediate, readIntermediateFiles(i, reply.RIndex)...)</span><br><span class="line">    }</span><br><span class="line">    worker.logPrintf(<span class="string">"Total intermediate size: %v\n"</span>, <span class="built_in">len</span>(intermediate))</span><br><span class="line">    tempfile, err := os.CreateTemp(<span class="string">"."</span>, <span class="string">"mrtemp"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        worker.logPrintf(<span class="string">"cannot create tempfile for %v\n"</span>, outName)</span><br><span class="line">    }</span><br><span class="line">    reduceKVSlice(intermediate, worker.reducef, tempfile)</span><br><span class="line">    tempfile.Close()</span><br><span class="line">    err = os.Rename(tempfile.Name(), outName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        worker.logPrintf(<span class="string">"cannot rename tempfile for %v\n"</span>, outName)</span><br><span class="line">    }</span><br><span class="line">    worker.joinReduceTask(reply.RIndex)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><ul>
<li><code>outName := fmt.Sprintf("mr-out-%v", reply.RIndex)</code>ï¼Œå½“å‰<code>Reduce</code>ä»»åŠ¡çš„è¾“å‡º</li>
<li><p>ä»å½“å‰RIndexæ‰€å±çš„å„ä¸ªä¸­é—´æ€æ–‡ä»¶è¯»å–ï¼Œæ±‡åˆåˆ°intermediate</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intermediate := <span class="built_in">make</span>([]KeyValue, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reply.FileCount; i++ {</span><br><span class="line">    worker.logPrintf(<span class="string">"Reading intermediate files on cluster %v\n"</span>, i)</span><br><span class="line">    intermediate = <span class="built_in">append</span>(intermediate, readIntermediateFiles(i, reply.RIndex)...)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><ul>
<li>é€šè¿‡<code>reduceKVSlice</code>æ’åºä»¥åŠåˆå¹¶ï¼Œç„¶åé‡å‘½åã€è¾“å‡º</li>
<li>è¯·æ±‚<code>call("Coordinator.JoinMapTask", &amp;args, &amp;reply)</code><ul>
<li>æ‹¿åˆ°å·²åˆ†é…mapä»»åŠ¡é˜Ÿåˆ—çš„é”</li>
<li>æ£€æŸ¥æ˜¯å¦å› ä¸ºè¶…æ—¶è€Œå¯¼è‡´å½“å‰FileIdçš„ä»»åŠ¡å·²ç»ä»å·²åˆ†é…mapä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤<ul>
<li>å·²ç»è¢«ç§»é™¤ï¼Œè§£é”ã€æ‰“å°ä¿¡æ¯</li>
<li>æœªè¢«ç§»é™¤ï¼Œç§»é™¤ã€è§£é”ï¼Œæ‰“å°ä¿¡æ¯</li>
<li>æœªè¢«ç§»é™¤ä¸”è¶…æ—¶ï¼Œæ”¾å…¥æœªåˆ†é…é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ä»»åŠ¡åˆ†é…æœºåˆ¶"><a href="#ä»»åŠ¡åˆ†é…æœºåˆ¶" class="headerlink" title="ä»»åŠ¡åˆ†é…æœºåˆ¶"></a>ä»»åŠ¡åˆ†é…æœºåˆ¶</h4><blockquote>
<p>ä½¿ç”¨<strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼Œ<code>coordinator</code> ç»´æŠ¤äº†ä¸¤ç»„ä¸¤ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæœªåˆ†é…ã€å·²åˆ†é…ï¼ˆæ­£åœ¨è¿è¡Œï¼‰ï¼Œå½“ <code>worker</code> è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œç»™ <code>worker</code> åˆ†é…ä¸€ä¸ªæœªåˆ†é…çš„ä»»åŠ¡ï¼Œå¹¶æŠŠè¿™ä¸ªä»»åŠ¡æ ‡è®°ä¸ºå·²åˆ†é…</p>
</blockquote>
<p>æœªåˆ†é…ä»»åŠ¡ä½¿ç”¨æœ‰é”çš„åŒå‘é˜Ÿåˆ—ï¼Œå·²åˆ†é…ä»»åŠ¡ä½¿ç”¨æ— é”çš„ Mapï¼Œæ“ä½œæ—¶åŠ é”ï¼Œæœ‰å¾…ä¼˜åŒ–</p>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash test-mr.sh &gt; test-mr.out</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*** Starting wc test.</span><br><span class="line">--- wc test: PASS</span><br><span class="line">*** Starting indexer test.</span><br><span class="line">--- indexer test: PASS</span><br><span class="line">*** Starting map parallelism test.</span><br><span class="line">--- map parallelism test: PASS</span><br><span class="line">*** Starting reduce parallelism test.</span><br><span class="line">--- reduce parallelism test: PASS</span><br><span class="line">*** Starting job count test.</span><br><span class="line">--- job count test: PASS</span><br><span class="line">*** Starting early exit test.</span><br><span class="line">--- early exit test: PASS</span><br><span class="line">*** Starting crash test.</span><br><span class="line">--- crash test: PASS</span><br><span class="line">*** PASSED ALL TESTS</span><br></pre></td></tr></tbody></table></figure>
<!-- markdownlint-disable-file MD025 MD033 -->
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyrightï¼š </strong>
          
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        share
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://www.lingzhicheng.cn/2024/03/14/MapReduce/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Distributed-Systems/" rel="tag">Distributed Systems</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LinkedList/" rel="tag">LinkedList</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/04/01/%E5%88%A9%E7%94%A8Webhook%E5%B0%86Hexo%E5%8D%9A%E5%AE%A2%E5%90%8C%E6%AD%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="article-nav-link">
        <strong class="article-nav-caption">Prev post</strong>
        <div class="article-nav-title">
          
            åŸºäºWebhookçš„åŒæ­¥éƒ¨ç½²
          
        </div>
      </a>
    
    
      <a href="/2023/07/12/TexSkills/" class="article-nav-link">
        <strong class="article-nav-caption">Next post</strong>
        <div class="article-nav-title">Skills for TexLive under VsCode</div>
      </a>
    
  </nav>

  
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">


<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'a1a50124b0c46fa4fab9',
    clientSecret: '4a29dee6f998a9272f57ba07f987ea9eed9da5ec',
    repo: 'blog-comments',
    owner: 'boom1999',
    admin: ['boom1999'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: true,  // Facebook-like distraction free mode
    pagerDirection: 'last',
    proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
  })

  gitalk.render('gitalk-container')
</script>

     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2025
        <span class="division">|</span> Zhicheng Ling
      </li>
    </ul>
    <ul>
      <li>
        
          
          
          Power <a href="https://hexo.io" target="_blank">Hexo</a>
          <span class="division">|</span>
          Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
          
          <span class="division">|</span>
        
          
          <span>
  <span><i class="ri-eye-fill"></i> <span id="busuanzi_value_page_pv"></span></span>
</span>
          
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/haisen-side.svg" alt="Haisenberg"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">Categories</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">Tags</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.gallery.lingzhicheng.cn">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">Friends</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/me">Me</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->

<!-- Graphiz -->

  <script src='https://cdnjs.cloudflare.com/ajax/libs/viz.js/1.7.1/viz.js'></script>
  <script>
    String.prototype.replaceAll = function(search, replacement) {
      var target = this;
      return target.split(search).join(replacement);
    };

    let vizObjects = document.querySelectorAll('.graphviz')

    for (let item of vizObjects) {
      let svg = undefined
      try {
        svg = Viz(item.textContent.replaceAll('â€“', '--'), 'svg')
      } catch(e) {
        svg = `<pre class="error">${e}</pre>`
      }
      item.outerHTML = svg
    }
  </script>


    
  </div>
  <script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";
  fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));
  webpushr('setup',{'key':'BL_sZtV4DqDKkZ48a4va762P0m5ke869W_4yODxaGYAZ59daIX84-6sOrZmGOxsw6bxpwPk5yKCMxalOZl3rqTA' });</script>
<script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BL_sZtV4DqDKkZ48a4va762P0m5ke869W_4yODxaGYAZ59daIX84-6sOrZmGOxsw6bxpwPk5yKCMxalOZl3rqTA' });</script></body>

</html>